<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-码农/Java面试指北/技术面试题篇/数据库&缓存/RedisSentinel：如何实现自动化地故障转移？" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Redis Sentinel：如何实现自动化地故障转移？ | Coisini</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/数据库&amp;缓存/RedisSentinel：如何实现自动化地故障转移？/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Redis Sentinel：如何实现自动化地故障转移？ | Coisini"><meta data-rh="true" name="description" content="普通的主从复制方案下，一旦 master 宕机，我们需要从 slave 中手动选择一个新的 master，同时需要修改应用方的主节点地址，还需要命令所有从节点去复制新的主节点，整个过程需要人工干预。人工干预大大增加了问题的处理时间以及出错的可能性。"><meta data-rh="true" property="og:description" content="普通的主从复制方案下，一旦 master 宕机，我们需要从 slave 中手动选择一个新的 master，同时需要修改应用方的主节点地址，还需要命令所有从节点去复制新的主节点，整个过程需要人工干预。人工干预大大增加了问题的处理时间以及出错的可能性。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/数据库&amp;缓存/RedisSentinel：如何实现自动化地故障转移？/"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/数据库&amp;缓存/RedisSentinel：如何实现自动化地故障转移？/" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/数据库&amp;缓存/RedisSentinel：如何实现自动化地故障转移？/" hreflang="x-default"><meta name="google-site-verification" content="1FUPX6Qo4y3ecU623ShEurhgnjhSTjK49rRMhEDlzFA">
<link rel="stylesheet" href="/katex/katex.min.css">
<script src="/js/matomo.js" async defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.79037026.css">
<script src="/assets/js/runtime~main.468f2b27.js" defer="defer"></script>
<script src="/assets/js/main.4763ab3e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Coisini</b></a></div><div class="navbar__items navbar__items--right"><a href="https://minddiy.top" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Redis Sentinel：如何实现自动化地故障转移？</h1></header>
<p>普通的主从复制方案下，一旦 master 宕机，我们需要从 slave 中手动选择一个新的 master，同时需要修改应用方的主节点地址，还需要命令所有从节点去复制新的主节点，整个过程需要人工干预。人工干预大大增加了问题的处理时间以及出错的可能性。</p>
<p>我们可以借助 Redis 官方的 Sentinel（哨  兵）方案来帮助我们解决这个痛点，实现自动化地故障切换。</p>
<p>建议带着下面这些重要的问题（面试常问）阅读：</p>
<ol>
<li>什么是 Sentinel？ 有什么用？</li>
<li>Sentinel 如何检测节点是否下线？主观下线与客观下线的区别?</li>
<li>Sentinel 是如何实现故障转移的？</li>
<li>为什么建议部署多个 sentinel 节点（哨兵集群）？</li>
<li>Sentinel 如何选择出新的 master（选举机制）?</li>
<li>如何从 Sentinel 集群中选择出 Leader ？</li>
<li>Sentinel 可以防止脑裂吗？</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-sentinel">什么是 Sentinel？<a href="#什么是-sentinel" class="hash-link" aria-label="Direct link to 什么是 Sentinel？" title="Direct link to 什么是 Sentinel？">​</a></h2>
<p><strong>Sentinel（哨兵）</strong> 只是 Redis 的一种运行模式 ，不提供读写服务，默认运行在 26379 端口上，依赖于 Redis 工作。Redis Sentinel 的稳定版本是在 Redis 2.8 之后发布的。</p>
<p>Redis 在 Sentinel 这种特殊的运行模式下，使用专门的命令表，也就是说普通模式运行下的 Redis 命令将无法使用。</p>
<p>通过下面的命令就可以让 Redis 以 Sentinel 的方式运行:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">redis-sentinel /path/to/sentinel.conf</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">或者</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">redis-server /path/to/sentinel.conf --sentinel</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Redis 源码中的<code>sentinel.conf</code>是用来配置 Sentinel 的，一个常见的最小配置如下所示：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 指定要监视的 master</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 127.0.0.1 6379 为 master 地址</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 2 表示当有 2 个 sentinel 认为 master 失效时，master 才算真正失效</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel monitor mymaster 127.0.0.1 6379 2</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// master 节点宕机多长时间才会被 sentinel 认为是失效</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel down-after-milliseconds mymaster 60000</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel failover-timeout mymaster 180000</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel parallel-syncs mymaster 1</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel monitor resque 192.168.1.3 6380 4</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel down-after-milliseconds resque 10000</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel failover-timeout resque 180000</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 在发生主备切换时最多可以有 5 个 slave 同时对新的 master 进行同步</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sentinel parallel-syncs resque 5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Redis Sentinel 实现 Redis 集群高可用，只是在主从复制实现集群的基础下，多了一个 Sentinel 角色来帮助我们监控 Redis 节点的运行状态并自动实现故障转移。</p>
<p>当 master 节点出现故障的时候， Sentinel 会帮助我们实现故障转移，自动根据一定的规则选出一个 slave 升级为 master，确保整个 Redis 系统的可用性。整个过程完全自动，不需要人工介入。</p>
<p><img decoding="async" loading="lazy" alt="1663979593266-3d66a28e-c0db-4a96-8400-d7c6ffae0a9f.png" src="/assets/images/1663979593266-3d66a28e-c0db-4a96-8400-d7c6ffae0a9f-801279-9e75028f5a59f332bdc8d822313ca379.png" width="747" height="733" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sentinel-有什么作用">Sentinel 有什么作用？<a href="#sentinel-有什么作用" class="hash-link" aria-label="Direct link to Sentinel 有什么作用？" title="Direct link to Sentinel 有什么作用？">​</a></h2>
<p>根据 <a href="https://redis.io/topics/sentinel" target="_blank" rel="noopener noreferrer">Redis Sentinel 官方文档</a>的介绍，sentinel 节点主要可以提供 4 个功能：</p>
<ul>
<li><strong>监控</strong>：监控所有 redis 节点（包括 sentinel 节点自身）的状态是否正常。</li>
<li><strong>故障转移</strong>：如果一个 master 出现故障，Sentinel 会帮助我们实现故障转移，自动将某一台 slave 升级为 master，确保整个 Redis 系统的可用性。</li>
<li><strong>通知</strong> ：通知 slave 新的 master 连接信息，让它们执行 replicaof 成为新的 master 的 slave。</li>
<li><strong>配置提供</strong> ：客户端连接 sentinel 请求 master 的地址，如果发生故障转移，sentinel 会通知新的 master 链接信息给客户端。</li>
</ul>
<p>Redis Sentinel 本身设计的就是一个分布式系统，建议多个 sentinel 节点协作运行。这样做的好处是：</p>
<ul>
<li><strong>容错性增强:</strong> 多个 sentinel 节点通过投票机制来判断 master 节点是否真正失效，避免了因网络波动等因素导致的误判。</li>
<li><strong>高可用性:</strong> 即使某个 Sentinel 节点失效，其他节点仍然可以继续监控和执行故障转移，确保系统的可用性。</li>
</ul>
<p><strong>如果想要实现高可用，建议将哨兵 Sentinel 配置成单数且大于等于 3 台。</strong></p>
<p>一个最简易的 Redis Sentinel 集群如下所示（官方文档中的一个例子），其中：</p>
<ul>
<li>M1 表示 master，R2、R3 表示 slave；</li>
<li>S1、S2、S3 都是 sentinel；</li>
<li>quorum 表示判定 master 失效最少需要的仲裁节点数。这里的值为 2 ，也就是说当有 2 个 sentinel 认为 master 失效时，master 才算真正失效。</li>
</ul>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">       +----+</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">       | M1 |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">       | S1 |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">       +----+</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">          |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+----+    |    +----+</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">| R2 |----+----| R3 |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">| S2 |         | S3 |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+----+         +----+</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Configuration: quorum = 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果 M1 出现问题，只要 S1、S2、S3 其中的两个投票赞同的话，就会开始故障转移工作，从 R2 或者 R3 中重新选出一个作为 master。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sentinel-如何检测节点是否下线">Sentinel 如何检测节点是否下线？<a href="#sentinel-如何检测节点是否下线" class="hash-link" aria-label="Direct link to Sentinel 如何检测节点是否下线？" title="Direct link to Sentinel 如何检测节点是否下线？">​</a></h2>
<blockquote>
<p>相关的问题：</p>
<ul>
<li>主观下线与客观下线的区别?</li>
<li>Sentinel 是如何实现故障转移的？</li>
<li>为什么建议部署多个 sentinel 节点（哨兵集群）？</li>
</ul>
</blockquote>
<p>Redis Sentinel 中有两个下线（Down）的概念：</p>
<ul>
<li><strong>主观下线(SDOWN)</strong> ：sentinel 节点认为某个 Redis 节点已经下线了（主观下线），但还不是很确定，需要其他 sentinel 节点的投票。</li>
<li><strong>客观下线(ODOWN)</strong> ：法定数量（通常为过半）的 sentinel 节点认定某个 Redis 节点已经下线（客观下线），那它就算是真的下线了。</li>
</ul>
<p>也就是说，<strong>主观下线</strong> 当前的 sentinel 自己认为节点宕机，客观下线是 sentinel 整体达成一致认为节点宕机。</p>
<p>每个 sentinel 节点以每秒钟一次的频率向整个集群中的 master、slave 以及其他 sentinel 节点发送一个 PING 命令。</p>
<p><img decoding="async" loading="lazy" alt="1663979614062-f3219a07-0815-4b0d-9b63-750219d9e59c.png" src="/assets/images/1663979614062-f3219a07-0815-4b0d-9b63-750219d9e59c-808133-7eda56eced5ec490b9dedde75f449f1d.png" width="796" height="412" class="img_ev3q"></p>
<p>如果对应的节点超过规定的时间（down-after-millseconds）没有进行有效回复的话，就会被其认定为是 <strong>主观下线(SDOWN)</strong> 。注意！这里的有效回复不一定是 PONG，可以是-LOADING 或者 -MASTERDOWN 。</p>
<p><img decoding="async" loading="lazy" alt="1663979628031-1ccb8eb9-5da0-46d5-a16a-01f6724c2ee1.png" src="/assets/images/1663979628031-1ccb8eb9-5da0-46d5-a16a-01f6724c2ee1-395653-d58081c0dde47324ad7bc66997956534.png" width="796" height="472" class="img_ev3q"></p>
<p>如果被认定为主观下线的是 slave 的话， sentinel 不会做什么事情，因为 slave 下线对 Redis 集群的影响不大，Redis 集群对外正常提供服务。但如果是 master 被认定为主观下线就不一样了，sentinel 整体还要对其进行进一步核实，确保 master 是真的下线了。</p>
<p>所有 sentinel 节点要以每秒一次的频率确认 master 的确下线了，当法定数量（通常为过半）的 sentinel 节点认定 master 已经下线， master 才被判定为 <strong>客观下线(ODOWN)</strong> 。这样做的目的是为了防止误判，毕竟故障转移的开销还是比较大的，这也是为什么 Redis 官方推荐部署多个 sentinel 节点（哨兵集群）。</p>
<p><img decoding="async" loading="lazy" alt="1663979639394-8eb65a8f-5905-473d-90d8-47cba7c58ae5.png" src="/assets/images/1663979639394-8eb65a8f-5905-473d-90d8-47cba7c58ae5-631238-1e813a2f7166ad6969c60e65168df968.png" width="796" height="472" class="img_ev3q"></p>
<p>随后， sentinel 中会有一个 Leader 的角色来负责故障转移，也就是自动地从 slave 中选出一个新的 master 并执行完相关的一些工作(比如通知 slave 新的 master 连接信息，让它们执行 replicaof 成为新的 master 的 slave)。</p>
<p>如果没有足够数量的 sentinel 节点认定 master 已经下线的话，当 master 能对 sentinel 的 PING 命令进行有效回复之后，master 也就不再被认定为主观下线，回归正常。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sentinel-如何选择出新的-master">Sentinel 如何选择出新的 master?<a href="#sentinel-如何选择出新的-master" class="hash-link" aria-label="Direct link to Sentinel 如何选择出新的 master?" title="Direct link to Sentinel 如何选择出新的 master?">​</a></h2>
<p>slave 必须是在线状态才能参加新的 master 的选举，筛选出所有在线的 slave 之后，通过下面 3 个维度进行最后的筛选（优先级依次降低）：</p>
<ol>
<li><strong>slave 优先级</strong> ：可以通过修改 <code>slave-priority</code>（<code>redis.conf</code>中配置，Redis5.0 后该配置属性名称被修改为 <code>replica-priority</code>） 配置的值来手动设置 slave 的优先级。<code>slave-priority</code>默认值为 100，其值越小得分越高，越有机会成为 master。比如说假设有三个优先级分别为 10,100,25 的 slave ，哨兵将选择优先级为 10 的。不过，0 是一个特殊的优先级值 ，如果一个 slave 的 <code>slave-priority</code>值为 0，代表其没有参加 master 选举的资格。如果没有优先级最高的，再判断复制进度。</li>
<li><strong>复制进度</strong> ：Sentinel 总是希望选择出数据最完整（与旧 master 数据最接近）也就是复制进度最快的 slave 被提升为新的 master，复制进度越快得分也就越高。</li>
<li><strong>runid(运行 id)</strong> ：通常经过前面两轮筛选已经成功选出来了新的 master，万一真有多个 slave 的优先级和复制进度一样的话，那就 runid 小的成为新的 master，每个 redis 节点启动时都有一个 40 字节随机字符串作为运行 id。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何从-sentinel-集群中选择出-leader-">如何从 Sentinel 集群中选择出 Leader ？<a href="#如何从-sentinel-集群中选择出-leader-" class="hash-link" aria-label="Direct link to 如何从 Sentinel 集群中选择出 Leader ？" title="Direct link to 如何从 Sentinel 集群中选择出 Leader ？">​</a></h2>
<p>我们前面说了，当 sentinel 集群确认有 master 客观下线了，就会开始故障转移流程，故障转移流程的第一步就是在 sentinel 集群选择一个 leader，让 leader 来负责完成故障转移。</p>
<p><strong>如何选择出 Leader 角色呢？</strong></p>
<p>这就需要用到分布式领域的 <strong>共识算法</strong> 了。简单来说，共识算法就是让分布式系统中的节点就一个问题达成共识。在 sentinel 选举 leader 这个场景下，这些 sentinel 要达成的共识就是谁才是 leader 。</p>
<p>大部分共识算法都是基于 Paxos 算法改进而来，在 sentinel 选举 leader 这个场景下使用的是 <a href="https://javaguide.cn/distributed-system/theorem&amp;algorithm&amp;protocol/raft-algorithm.html" target="_blank" rel="noopener noreferrer"><strong>Raft 算法</strong></a>。这是一个比 Paxos 算法更易理解和实现的共识算法—Raft 算法。更具体点来说，Raft 是 Multi-Paxos 的一个变种，其简化了 Multi-Paxos 的思想，变得更容易被理解以及工程实现。</p>
<p>对于学有余力并且想要深入了解 Raft 算法实践以及 sentinel 选举 leader 的详细过程的同学，推荐阅读下面这两篇文章：</p>
<ul>
<li><a href="https://javaguide.cn/distributed-system/protocol/raft-algorithm.html" target="_blank" rel="noopener noreferrer">Raft 算法详解</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1021467" target="_blank" rel="noopener noreferrer">Raft 协议实战之 Redis Sentinel 的选举 Leader 源码解析</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sentinel-可以防止脑裂吗">Sentinel 可以防止脑裂吗？<a href="#sentinel-可以防止脑裂吗" class="hash-link" aria-label="Direct link to Sentinel 可以防止脑裂吗？" title="Direct link to Sentinel 可以防止脑裂吗？">​</a></h2>
<p>还是上面的例子，如果 M1 和 R2、R3 之间的网络被隔离，也就是发生了脑裂，M1 和 R2 、 R3 隔离在了两个不同的网络分区中。这意味着，R2 或者 R3 其中一个会被选为 master，这里假设为 R2。</p>
<p>但是！这样会出现问题了！！</p>
<p>如果客户端 C1 是和 M1 在一个网络分区的话，从网络被隔离到网络分区恢复这段时间，C1 写入 M1 的数据都会丢失，并且，C1 读取的可能也是过时的数据。这是因为当网络分区恢复之后，M1 将会成为 slave 节点。</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">         +----+</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">         | M1 |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">         | S1 | &lt;- C1 (writes will be lost)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">         +----+</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            /</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            /</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+------+    |    +----+</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">| [M2] |----+----| R3 |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">| S2   |         | S3 |</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+------+         +----+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>想要解决这个问题的话也不难，对 Redis 主从复制进行配置即可。</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">min-replicas-to-write 1</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">min-replicas-max-lag 10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面对这两个配置进行解释：</p>
<ul>
<li><strong>min-replicas-to-write 1</strong>：用于配置写 master 至少写入的 slave 数量，设置为 0 表示关闭该功能。3 个节点的情况下，可以配置为 1 ，表示 master 必须写入至少 1 个 slave ，否则就停止接受新的写入命令请求。</li>
<li><strong>min-replicas-max-lag 10</strong> ：用于配置 master 多长时间（秒）无法得到从节点的响应，就认为这个节点失联。我们这里配置的是 10 秒，也就是说 master 10 秒都得不到一个从节点的响应，就会认为这个从节点失联，停止接受新的写入命令请求。</li>
</ul>
<p>不过，这样配置会降低 Redis 服务的整体可用性，如果 2 个 slave 都挂掉，master 将会停止接受新的写入命令请求。</p>
<p><a href="https://juejin.cn/post/6844903663362637832" target="_blank" rel="noopener noreferrer"><br>
</a></p>
<blockquote>
<p>更新: 2024-04-19 23:46:56<br>
原文: <a href="https://www.yuque.com/snailclimb/mf2z3k/ft4h1g" target="_blank" rel="noopener noreferrer">https://www.yuque.com/snailclimb/mf2z3k/ft4h1g</a></p>
</blockquote></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是-sentinel" class="table-of-contents__link toc-highlight">什么是 Sentinel？</a></li><li><a href="#sentinel-有什么作用" class="table-of-contents__link toc-highlight">Sentinel 有什么作用？</a></li><li><a href="#sentinel-如何检测节点是否下线" class="table-of-contents__link toc-highlight">Sentinel 如何检测节点是否下线？</a></li><li><a href="#sentinel-如何选择出新的-master" class="table-of-contents__link toc-highlight">Sentinel 如何选择出新的 master?</a></li><li><a href="#如何从-sentinel-集群中选择出-leader-" class="table-of-contents__link toc-highlight">如何从 Sentinel 集群中选择出 Leader ？</a></li><li><a href="#sentinel-可以防止脑裂吗" class="table-of-contents__link toc-highlight">Sentinel 可以防止脑裂吗？</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>