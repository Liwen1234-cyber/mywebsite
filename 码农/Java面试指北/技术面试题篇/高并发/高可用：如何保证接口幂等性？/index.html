<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-码农/Java面试指北/技术面试题篇/高并发/高可用：如何保证接口幂等性？" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">高可用：如何保证接口幂等性？ | Coisini</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/高并发/高可用：如何保证接口幂等性？/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="高可用：如何保证接口幂等性？ | Coisini"><meta data-rh="true" name="description" content="接口幂等性是面试中常见的问题，也是日常开发过程中经常需要解决的问题。"><meta data-rh="true" property="og:description" content="接口幂等性是面试中常见的问题，也是日常开发过程中经常需要解决的问题。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/高并发/高可用：如何保证接口幂等性？/"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/高并发/高可用：如何保证接口幂等性？/" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/Java面试指北/技术面试题篇/高并发/高可用：如何保证接口幂等性？/" hreflang="x-default"><meta name="google-site-verification" content="1FUPX6Qo4y3ecU623ShEurhgnjhSTjK49rRMhEDlzFA">
<link rel="stylesheet" href="/katex/katex.min.css">
<script src="/js/matomo.js" async defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.79037026.css">
<script src="/assets/js/runtime~main.468f2b27.js" defer="defer"></script>
<script src="/assets/js/main.4763ab3e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Coisini</b></a></div><div class="navbar__items navbar__items--right"><a href="https://minddiy.top" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>高可用：如何保证接口幂等性？</h1></header>
<p>接口幂等性是面试中常见的问题，也是日常开发过程中经常需要解决的问题。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是幂等idempotency">什么是幂等(idempotency)？<a href="#什么是幂等idempotency" class="hash-link" aria-label="Direct link to 什么是幂等(idempotency)？" title="Direct link to 什么是幂等(idempotency)？">​</a></h2>
<p>幂等(idempotency)本身是一个数学概念，常见于抽象代数中，表示一个函数或者操作的结果不受其输入或者执行次数的影响。例如， f(n) = 1^n ，无论 n 为多少，f(n)的值永远为 1。</p>
<p>在软件开发领域，幂等是对请求操作结果的一个描述，这个描述就是不论执行多少次相同的请求，产生的效果和返回的结果都和发出单个请求是一样的。</p>
<p>针对数据操作来说就是：</p>
<ul>
<li><code>insert</code>操作要保证不插入重复的数据；</li>
<li><code>update</code>操作要保证多次相同请求数据依然正确。</li>
</ul>
<p>接口幂等性问题通常是由于网络波动、用户重复操作、超时重试、消息重复消费、响应速度慢等原因导致的。</p>
<p><strong>不保证幂等会有什么后果？</strong></p>
<p>没有保证幂等会导致产生严重的生产级别的 Bug，比较典型的就是涉及到钱的业务场景。就比如在没有保证幂等性的情况下，我作为用户在付款的时候，我同时点击了多次付款按钮，后端处理了多次相同的扣款请求，结果导致我的账户被扣了多次钱。这就是属于非常非常非常严重的 Bug 了！只要业务涉及到钱就一定要格外注意！！！</p>
<p>综上，保证接口的幂等性至关重要。</p>
<p>另外，保证幂等性这个 <strong>操作并不是说前端做了就可以的，后端同样也要做。</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何保证接口幂等性">如何保证接口幂等性？<a href="#如何保证接口幂等性" class="hash-link" aria-label="Direct link to 如何保证接口幂等性？" title="Direct link to 如何保证接口幂等性？">​</a></h2>
<p>前端保证幂等性的话比较简单，一般通过当用户提交请求后将按钮致灰来做到。</p>
<p>后端保证幂等性就稍微麻烦一点，方法也是有很多种，比如悲观锁、唯一索引、去重表、乐观锁 、分布式锁、Token 机制等等。</p>
<p>悲观锁和分布式锁的核心思想都是通过加锁来保证同一时刻只有一个请求能被执行。但仅仅这样是不够的，还需要配合根据业务逻辑进行幂等性判断，例如，注册场景检测指定的电话/邮箱/用户名是否已经被注册、订单支付场景检测订单的状态。</p>
<p>实际项目中，一般采用分布式锁这种方案比较多。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="悲观锁">悲观锁<a href="#悲观锁" class="hash-link" aria-label="Direct link to 悲观锁" title="Direct link to 悲观锁">​</a></h3>
<p>在 Java 中，可以使用 <code>ReetrantLock</code> 类、<code>synchronized</code> 关键字这类 JDK 自带的悲观锁来保证同一时刻只有一个线程能够进行修改。不过，JDK 自带的锁属于是本地锁，分布式环境下无法使用。</p>
<p><img decoding="async" loading="lazy" alt="jvm-local-lock.png" src="/assets/images/1683293937940-70d8e372-269b-409b-859d-2c977da04e81-760039-eb85b800889516086eaed067dda39bf8.png" width="909" height="367" class="img_ev3q"></p>
<p>除了利用 JDK 提供的悲观锁之外，数据库自身也带了排他锁（X 锁）。排他锁又称写锁/独占锁，事务在修改记录的时候获取排他锁，不允许多个事务同时获取。如果一个记录已经被加了排他锁，那其他事务不能再对这条事务加任何类型的锁（锁不兼容）。</p>
<p>在 MySQL 里使用排他锁：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">UPDATE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>排他锁只能在支持事务的存储引擎（如 InnoDB）中使用，且只能在事务中使用。另外，排他锁只能在有索引的字段上使用，否则会锁住整个表，影响并发性能。</p>
<p>高并发的场景下，激烈的锁竞争会造成线程阻塞，大量阻塞线程会导致系统的上下文切换，增加系统的性能开销。并且，悲观锁还可能会存在死锁问题，影响代码的正常运行。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="乐观锁">乐观锁<a href="#乐观锁" class="hash-link" aria-label="Direct link to 乐观锁" title="Direct link to 乐观锁">​</a></h3>
<p>乐观锁一般会使用版本号机制或 CAS 算法实现。</p>
<p>拿版本号机制来说，通过在表中增加一个版本号字段，每次更新数据时，检查当前的版本号否和数据库中的一致。如果一致，则更新成功，并且版本号加一。如果不一致，则更新失败，表示数据已经被其他请求修改过。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:hsl(230, 4%, 64%)"># 更新数据，修改 price 并将 version 加一，并且检查 version 是否为 1（假设 version 的初始值为 1）</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">update</span><span class="token plain"> goods </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">set</span><span class="token plain"> price </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> price </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">100</span><span class="token plain"> version </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> version </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">where</span><span class="token plain"> id </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">and</span><span class="token plain"> version </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># 由于 version 已经变为 2 ，因此，下面的 sql 执行无效</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">update</span><span class="token plain"> goods </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">set</span><span class="token plain"> price </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> price </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">100</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> version </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> version </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">where</span><span class="token plain"> id </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">and</span><span class="token plain"> version </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>高并发的场景下，乐观锁相比悲观锁来说，不存在锁竞争造成线程阻塞，也不会有死锁的问题，在性能上往往会更胜一筹。但是，如果冲突频繁发生（写占比非常多的情况），会频繁失败和重试（悲观锁的开销是固定的），这样同样会非常影响性能，导致 CPU 飙升。不过，这种方法只适用于更新数据的场景。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="唯一索引">唯一索引<a href="#唯一索引" class="hash-link" aria-label="Direct link to 唯一索引" title="Direct link to 唯一索引">​</a></h3>
<p>通过在表中加上唯一索引，保证数据的唯一性。如果有重复的数据插入，会抛出异常，程序可以捕获异常并处理。不过，这种方法只适用于插入数据的场景。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">create</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">table</span><span class="token plain"> t_order</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">id </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">int</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">KEY</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">AUTO_INCREMENT</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;主键&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token identifier">code</span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">varchar</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">200</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">not</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">null</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;流水号&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token identifier">customer_id</span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">int</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;会员id&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token identifier">amount</span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">decimal</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">10</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">unsigned</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">not</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">null</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;总金额&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(230, 4%, 64%)">-- 省略其他订单字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(230, 4%, 64%)">-- 省略其他索引</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># 订单流水号唯一</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">UNIQUE</span><span class="token plain"> unq_code</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token identifier">code</span><span class="token identifier punctuation" style="color:hsl(119, 34%, 47%)">`</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;订单表&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不要依靠唯一索引来保证接口幂等，但建议使用唯一索引作为兜底，避免产生脏数据。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="去重表">去重表<a href="#去重表" class="hash-link" aria-label="Direct link to 去重表" title="Direct link to 去重表">​</a></h3>
<p>去重表本质上也是一种唯一索引方案。去重表是一张专门用于记录请求信息的表，其中某个字段需要建立唯一索引，用于标识请求的唯一性当客户端发出请求时，服务端会将这次请求的一些信息（如订单号、交易流水号等）插入到去重表中，如果插入成功，说明这是第一次请求，可以执行后续的业务逻辑；如果插入失败，说明这是重复请求，可以直接返回或者忽略。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">TABLE</span><span class="token plain"> deduplication_table </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    id </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">int</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">KEY</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">AUTO_INCREMENT</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;主键&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    processed_code </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">varchar</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">200</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">not</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">null</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;已处理的订单流水号&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(230, 4%, 64%)">-- 省略其他字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">UNIQUE</span><span class="token plain"> unq_processed_code</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">processed_code</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">COMMENT</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;去重表&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分布式锁">分布式锁<a href="#分布式锁" class="hash-link" aria-label="Direct link to 分布式锁" title="Direct link to 分布式锁">​</a></h3>
<p>分布式系统下，不同的服务/客户端通常运行在独立的 JVM 进程上，需要使用<strong>分布式锁</strong>。</p>
<p><img decoding="async" loading="lazy" alt="distributed-lock.png" src="/assets/images/1683293938045-3e827624-ab0a-45b6-b307-f9dd81efdb2c-654891-0cf483bdd480b8bdc8f2c2b054464f83.png" width="938" height="674" class="img_ev3q"></p>
<p>基于 MySQL 也可以实现分布式锁，但一般我们不会采用这种方式。</p>
<p>通常情况下，我们一般会选择基于 Redis 或者 ZooKeeper 实现分布式锁，Redis 用的要更多一点。</p>
<p>我们上面提到的关系型数据的乐观锁、唯一索引和排他锁也算是分布式锁的实现方式，只是一般不会采用这种方式实现分布式锁，问题太多比如性能太差、不具备锁失效机制。</p>
<p>关于分布式锁的详细介绍以及如何基于 Redis 和 ZooKeeper 实现分布式锁，我写过专门的文章介绍，推荐看看：</p>
<ul>
<li><a href="https://javaguide.cn/distributed-system/distributed-lock.html" target="_blank" rel="noopener noreferrer">分布式锁介绍</a></li>
<li><a href="https://javaguide.cn/distributed-system/distributed-lock-implementations.html" target="_blank" rel="noopener noreferrer">分布式锁常见实现方案总结</a></li>
</ul>
<p>需要注意的是，这里的分布式锁是根据唯一标识（比如订单号）生成的。如果能够获取到对应的锁，说明请求还没有被处理。</p>
<p>Redisson 的 <code>RLock</code>实现幂等的伪代码如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 唯一标识</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">String uniqueId = &quot;order123&quot;;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 1. 根据唯一标识生成分布式锁对象</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">RLock lock = redisson.getLock(&quot;lock:&quot; + uniqueId);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">try {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 2. 尝试获取锁(Watch Dog 自动续期机制) </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if (lock.tryLock()) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 3. 如果成功获取到锁，说明请求还没有被处理，执行业务逻辑</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 请求已经被处理，直接返回</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">} finally {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 4. 释放锁</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    lock.unlock();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="token-机制">Token 机制<a href="#token-机制" class="hash-link" aria-label="Direct link to Token 机制" title="Direct link to Token 机制">​</a></h3>
<p>Token 机制的核心思想是为每一次操作生成一个唯一性的凭证 token。这个 token 需要由服务端生成的，因为服务端可以对 token 进行签名和加密，防止篡改和泄露。如果由客户端生成 token，可能会存在安全隐患，比如客户端伪造或重复 token，导致服务端无法识别和校验。</p>
<p>这样的话，就需要两次请求才能完成一次业务操作：</p>
<ol>
<li>请求获取 服务器端 token，token 需要设置有效时间（可以设置短一点），服务端将该 token 保存起来（通常保存在缓存中）。</li>
<li>执行真正的请求，将上一步获取到的 token 放到 header 或者作为请求参数。服务端验证 token 的有效性，如果有效（一般是通过删除 token 的方式来验证，删除成功则有效），执行业务逻辑，并删除 token，防止重复提交；如果无效，拒绝请求，返回提示信息。</li>
</ol>
<p>得物技术的<a href="https://mp.weixin.qq.com/s/yvKASWcRLfOok-NFPrIRsw" target="_blank" rel="noopener noreferrer">分布式系统设计中的并发访问解决方案</a>这篇文章把这个过程图解的挺清晰的。</p>
<p><img decoding="async" loading="lazy" alt="idempotent-token.png" src="/assets/images/1704870891315-6e485843-3e16-4dac-a093-5c4f48875a21-091058-1fb61645082acd5e44fd04ed1c10c765.png" width="1080" height="846" class="img_ev3q"></p>
<p>先执行业务逻辑再删除 token 还是先删除 token 再执行业务逻辑呢？两者似乎都有风险：</p>
<ul>
<li>先执行业务逻辑的话，客户端可能会在该 token 还存在的时候又携带 token 发起请求，由于 token 还存在，第二次请求也会验证通过。</li>
<li>先删除 token 的话，如果业务逻辑执行超时或者出现网络波动，客户端需要重试请求，那 token 就用不成了。</li>
</ul>
<p>一般还是建议先删除 token，如果出现执行异常就重新获取 token 再请求，只有极少一部分请求才会遇到这种问题。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="#参考" class="hash-link" aria-label="Direct link to 参考" title="Direct link to 参考">​</a></h2>
<ul>
<li>高并发下如何保证接口的幂等性？：<a href="https://mp.weixin.qq.com/s/7P2KbWjjX5YPZCInoox-xQ" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/7P2KbWjjX5YPZCInoox-xQ</a></li>
<li>解决幂等问题，只需要记住这个口诀！：<a href="https://mp.weixin.qq.com/s/EatpiCzNlTw1viO_flQIpg" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/EatpiCzNlTw1viO_flQIpg</a></li>
</ul>
<blockquote>
<p>更新: 2024-06-28 16:34:07<br>
原文: <a href="https://www.yuque.com/snailclimb/mf2z3k/mlnfrc6kk95kmli6" target="_blank" rel="noopener noreferrer">https://www.yuque.com/snailclimb/mf2z3k/mlnfrc6kk95kmli6</a></p>
</blockquote></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是幂等idempotency" class="table-of-contents__link toc-highlight">什么是幂等(idempotency)？</a></li><li><a href="#如何保证接口幂等性" class="table-of-contents__link toc-highlight">如何保证接口幂等性？</a><ul><li><a href="#悲观锁" class="table-of-contents__link toc-highlight">悲观锁</a></li><li><a href="#乐观锁" class="table-of-contents__link toc-highlight">乐观锁</a></li><li><a href="#唯一索引" class="table-of-contents__link toc-highlight">唯一索引</a></li><li><a href="#去重表" class="table-of-contents__link toc-highlight">去重表</a></li><li><a href="#分布式锁" class="table-of-contents__link toc-highlight">分布式锁</a></li><li><a href="#token-机制" class="table-of-contents__link toc-highlight">Token 机制</a></li></ul></li><li><a href="#参考" class="table-of-contents__link toc-highlight">参考</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>