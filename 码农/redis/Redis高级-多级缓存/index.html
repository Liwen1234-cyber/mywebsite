<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-码农/redis/Redis高级-多级缓存" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">多级缓存 | Coisini</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.minddiy.top/码农/redis/Redis高级-多级缓存/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="多级缓存 | Coisini"><meta data-rh="true" name="description" content="笔记原件来自黑马B站视频配套笔记，经过自己加工修改添加等"><meta data-rh="true" property="og:description" content="笔记原件来自黑马B站视频配套笔记，经过自己加工修改添加等"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doc.minddiy.top/码农/redis/Redis高级-多级缓存/"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/redis/Redis高级-多级缓存/" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/redis/Redis高级-多级缓存/" hreflang="x-default"><meta name="google-site-verification" content="1FUPX6Qo4y3ecU623ShEurhgnjhSTjK49rRMhEDlzFA">
<link rel="stylesheet" href="/katex/katex.min.css">
<script src="/js/matomo.js" async defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.79037026.css">
<script src="/assets/js/runtime~main.468f2b27.js" defer="defer"></script>
<script src="/assets/js/main.4763ab3e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Coisini</b></a></div><div class="navbar__items navbar__items--right"><a href="https://minddiy.top" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>多级缓存</h1></header>
<blockquote>
<p>笔记原件来自黑马B站视频配套笔记，经过自己加工修改添加等</p>
</blockquote>
<h1>1.什么是多级缓存</h1>
<p>传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，如图：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821075259137" src="/assets/images/image-20210821075259137-cbd78d2af08c68436df615f7d0a71b43.png" width="1153" height="418" class="img_ev3q"></p>
<p>存在下面的问题：</p>
<p>•请求要经过Tomcat处理，<strong>Tomcat的性能成为整个系统的瓶颈</strong>（之前实战篇学的Redis缓存就是这种情况）</p>
<p>•Redis缓存失效时，会对数据库产生冲击</p>
<p>多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：</p>
<ul>
<li>浏览器访问静态资源时，优先读取浏览器本地缓存</li>
<li>访问非静态资源（ajax查询数据）时，访问服务端</li>
<li>请求到达Nginx后，优先读取Nginx本地缓存</li>
<li>如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）</li>
<li>如果Redis查询未命中，则查询Tomcat</li>
<li>请求进入Tomcat后，优先查询JVM进程缓存</li>
<li>如果JVM进程缓存未命中，则查询数据库</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20210821075558137" src="/assets/images/image-20210821075558137-bb7b1e8083f7fe375d7dd94efc9bb124.png" width="1432" height="495" class="img_ev3q"></p>
<p>在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个<strong>反向代理服务器</strong>，而是一个编写<strong>业务的Web服务器了</strong>。</p>
<p>因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821080511581" src="/assets/images/image-20210821080511581-2b31490c5a48fb2ce2ff47b512c2acdf.png" width="1547" height="555" class="img_ev3q"></p>
<p>另外，我们的Tomcat服务将来也会部署为集群模式：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821080954947" src="/assets/images/image-20210821080954947-d1ed2ce2a8d31d194a14d804c9cc7ecf.png" width="1550" height="496" class="img_ev3q"></p>
<p>可见，多级缓存的关键有两个：</p>
<ul>
<li>
<p>一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询</p>
</li>
<li>
<p>另一个就是在Tomcat中实现JVM进程缓存</p>
</li>
</ul>
<p>其中Nginx编程则会用到OpenResty框架结合Lua这样的语言。</p>
<p>这也是今天课程的难点和重点。</p>
<h1>2.JVM进程缓存</h1>
<p>为了演示多级缓存的案例，我们先准备一个商品查询的业务。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21导入案例">2.1.导入案例<a href="#21导入案例" class="hash-link" aria-label="Direct link to 2.1.导入案例" title="Direct link to 2.1.导入案例">​</a></h2>
<p>参考课前资料的：《案例导入说明.md》</p>
<p><img decoding="async" loading="lazy" alt="image-20210821081418456" src="data:image/png;base64,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" width="150" height="191" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22初识caffeine">2.2.初识Caffeine<a href="#22初识caffeine" class="hash-link" aria-label="Direct link to 2.2.初识Caffeine" title="Direct link to 2.2.初识Caffeine">​</a></h2>
<p>缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类：</p>
<ul>
<li>分布式缓存，例如Redis：
<ul>
<li>优点：存储容量更大、可靠性更好、可以在集群间共享</li>
<li>缺点：访问缓存有网络开销</li>
<li>场景：缓存<strong>数据量较大</strong>、可靠性要求较高、需要在集群间共享</li>
</ul>
</li>
<li>进程本地缓存，例如HashMap、GuavaCache：
<ul>
<li>优点：读取本地内存，没有网络开销，速度更快</li>
<li>缺点：存储容量有限、可靠性较低、无法共享</li>
<li>场景：性能要求较高，缓存<strong>数据量较小</strong></li>
</ul>
</li>
</ul>
<p>我们今天会利用Caffeine框架来实现JVM进程缓存。</p>
<p><strong>Caffeine</strong>是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前Spring内部的缓存使用的就是Caffeine。GitHub地址：<a href="https://github.com/ben-manes/caffeine" target="_blank" rel="noopener noreferrer">https://github.com/ben-manes/caffeine</a></p>
<p>Caffeine的性能非常好，下图是官方给出的性能对比：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821081826399" src="/assets/images/image-20210821081826399-686049b3ff2aa41063e7aa4aed59bf22.png" width="876" height="434" class="img_ev3q"></p>
<p>可以看到Caffeine的性能遥遥领先！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="221caffeine基本api">2.2.1.Caffeine基本API<a href="#221caffeine基本api" class="hash-link" aria-label="Direct link to 2.2.1.Caffeine基本API" title="Direct link to 2.2.1.Caffeine基本API">​</a></h3>
<p>引入依赖：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">dependency</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">groupId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain">com.github.ben-manes.caffeine</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">groupId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">artifactId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain">caffeine</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">artifactId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">dependency</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>缓存使用的基本API：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">void testBasicOps() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 构建cache对象</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Cache&lt;String, String&gt; cache = Caffeine.newBuilder().initialCapacity(100).build();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 存数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cache.put(&quot;gf&quot;, &quot;迪丽热巴&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 取数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    String gf = cache.getIfPresent(&quot;gf&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;gf = &quot; + gf);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 取数据，包含两个参数：</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 参数一：缓存的key</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 参数二：Lambda表达式，表达式参数就是缓存的key，方法体是查询数据库的逻辑</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 优先根据key查询JVM缓存，如果未命中，则执行参数二的Lambda表达式</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    String defaultGF = cache.get(&quot;defaultGF&quot;, key -&gt; {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 根据key去数据库查询数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return &quot;柳岩&quot;;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    });</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;defaultGF = &quot; + defaultGF);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Caffeine.newBuilder().[参数].build();	构建缓存对象，可以设置参数如初始大小，驱逐策略等</li>
<li>cache.getIfPresent(key);     如果存在缓存就获取，否则返回null</li>
<li>cache.get(key, function);     如果存在缓存就返回缓存，否则执行function操作（一般是查询数据库操作）<strong>并存入缓存</strong></li>
</ul>
<p>其它API：</p>
<ul>
<li>cache.put(key, object)	将object放入缓存</li>
<li>cache.invalidate(key)     删除指定key的缓存</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="222caffeine三种缓存驱逐策略">2.2.2.Caffeine三种缓存驱逐策略<a href="#222caffeine三种缓存驱逐策略" class="hash-link" aria-label="Direct link to 2.2.2.Caffeine三种缓存驱逐策略" title="Direct link to 2.2.2.Caffeine三种缓存驱逐策略">​</a></h3>
<p>Caffeine既然是缓存的一种，肯定需要有缓存的清除策略，不然的话内存总会有耗尽的时候。</p>
<p>Caffeine提供了三种<strong>缓存驱逐  策略</strong>：</p>
<ul>
<li>
<p><strong>基于容量</strong>：设置缓存的数量上限</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 创建缓存对象</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Cache&lt;String, String&gt; cache = Caffeine.newBuilder()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    .maximumSize(1) // 设置缓存大小上限为 1</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    .build();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>基于时间</strong>：设置缓存的有效时间</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">// 创建缓存对象</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Cache&lt;String, String&gt; cache = Caffeine.newBuilder()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 设置缓存有效期为 10 秒，从最后一次写入开始计时 </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    .expireAfterWrite(Duration.ofSeconds(10)) </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    .build();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>基于引用</strong>：设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。</p>
</li>
</ul>
<blockquote>
<p><strong>注意</strong>：在默认情况下，当一个缓存元素过期的时候，Caffeine<strong>不会自动立即</strong>将其清理和驱逐。而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">/*</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> 基于大小设置驱逐策略：</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> */</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">void testEvictByNum() throws InterruptedException {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 创建缓存对象</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Cache&lt;String, String&gt; cache = Caffeine.newBuilder()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 设置缓存大小上限为 1</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            .maximumSize(1)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 存数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cache.put(&quot;gf1&quot;, &quot;柳岩&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cache.put(&quot;gf2&quot;, &quot;范冰冰&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cache.put(&quot;gf3&quot;, &quot;迪丽热巴&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 延迟10ms，给清理线程一点时间</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Thread.sleep(10L);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 获取数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;gf1: &quot; + cache.getIfPresent(&quot;gf1&quot;));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;gf2: &quot; + cache.getIfPresent(&quot;gf2&quot;));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;gf3: &quot; + cache.getIfPresent(&quot;gf3&quot;));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>若不sleep，则三个gf都可以得到，要sleep给他一点时间清除缓存</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">/*</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> 基于时间设置驱逐策略：</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> */</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">void testEvictByTime() throws InterruptedException {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 创建缓存对象</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Cache&lt;String, String&gt; cache = Caffeine.newBuilder()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            .expireAfterWrite(Duration.ofSeconds(1)) // 设置缓存有效期为 10 秒</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 存数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cache.put(&quot;gf&quot;, &quot;柳岩&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 获取数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;gf: &quot; + cache.getIfPresent(&quot;gf&quot;));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 休眠一会儿</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Thread.sleep(1200L);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;gf: &quot; + cache.getIfPresent(&quot;gf&quot;));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>和大小驱逐同理，要sleep一会</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="23实现jvm进程缓存">2.3.实现JVM进程缓存<a href="#23实现jvm进程缓存" class="hash-link" aria-label="Direct link to 2.3.实现JVM进程缓存" title="Direct link to 2.3.实现JVM进程缓存">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="231需求">2.3.1.需求<a href="#231需求" class="hash-link" aria-label="Direct link to 2.3.1.需求" title="Direct link to 2.3.1.需求">​</a></h3>
<p>利用Caffeine实现下列需求：</p>
<ul>
<li>给根据id查询商品的业务添加缓存，缓存未命中时查询数据库</li>
<li>给根据id查询商品库存的业务添加缓存，缓存未命中时查询数据库</li>
<li>缓存初始大小为100</li>
<li>缓存上限为10000</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="232实现">2.3.2.实现<a href="#232实现" class="hash-link" aria-label="Direct link to 2.3.2.实现" title="Direct link to 2.3.2.实现">​</a></h3>
<p>首先，我们需要定义两个Caffeine的缓存对象，分别保存商品、库存的缓存数据。</p>
<p>在item-service的<code>com.heima.item.config</code>包下  定义<code>CaffeineConfig</code>类：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">package com.heima.item.config;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.github.benmanes.caffeine.cache.Cache;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.github.benmanes.caffeine.cache.Caffeine;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.pojo.Item;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.pojo.ItemStock;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class CaffeineConfig {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public Cache&lt;Long, Item&gt; itemCache(){</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return Caffeine.newBuilder()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .initialCapacity(100)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .maximumSize(10_000) //_只是分隔符，可以不要</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public Cache&lt;Long, ItemStock&gt; stockCache(){</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return Caffeine.newBuilder()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .initialCapacity(100)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .maximumSize(10_000)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，修改item-service中的<code>com.heima.item.web</code>包下的ItemController类，添加缓存逻辑：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@RequestMapping(&quot;item&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class ItemController {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private IItemService itemService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private IItemStockService stockService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Cache&lt;Long, Item&gt; itemCache;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Cache&lt;Long, ItemStock&gt; stockCache;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // ...其它略</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @GetMapping(&quot;/{id}&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public Item findById(@PathVariable(&quot;id&quot;) Long id) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return itemCache.get(id, key -&gt; itemService.query()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .ne(&quot;status&quot;, 3).eq(&quot;id&quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .one()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        );</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @GetMapping(&quot;/stock/{id}&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public ItemStock findStockById(@PathVariable(&quot;id&quot;) Long id) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return stockCache.get(id, key -&gt; stockService.getById(key));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>3.Lua语法入门</h1>
<p>Nginx编程需要用到Lua语言，因此我们必须先入门Lua的基本语法。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="31初识lua">3.1.初识Lua<a href="#31初识lua" class="hash-link" aria-label="Direct link to 3.1.初识Lua" title="Direct link to 3.1.初识Lua">​</a></h2>
<p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网：<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">https://www.lua.org/</a></p>
<p><img decoding="async" loading="lazy" alt="image-20210821091437975" src="/assets/images/image-20210821091437975-ceea13823bec8bdc14790bc4d4c9a0eb.png" width="1123" height="387" class="img_ev3q"></p>
<p>Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。</p>
<p>Nginx本身也是C语言开发，因此也允许基于Lua做拓展。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="31helloworld">3.1.HelloWorld<a href="#31helloworld" class="hash-link" aria-label="Direct link to 3.1.HelloWorld" title="Direct link to 3.1.HelloWorld">​</a></h2>
<p>CentOS7默认已经安装了Lua语言环境，所以可以直接运行Lua代码。</p>
<p>1）在Linux虚拟机的任意目录下，新建一个hello.lua文件</p>
<p><img decoding="async" loading="lazy" alt="image-20210821091621308" src="data:image/png;base64,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" width="683" height="98" class="img_ev3q"></p>
<p>2）添加下面的内容</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">print(&quot;Hello World!&quot;)  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3）运行</p>
<p><img decoding="async" loading="lazy" alt="image-20210821091638140" src="data:image/png;base64,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" width="678" height="100" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="32变量和循环">3.2.变量和循环<a href="#32变量和循环" class="hash-link" aria-label="Direct link to 3.2.变量和循环" title="Direct link to 3.2.变量和循环">​</a></h2>
<p>学习任何语言必然离不开变量，而变量的声明必须先知道数据的类型。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="321lua的数据类型">3.2.1.Lua的数据类型<a href="#321lua的数据类型" class="hash-link" aria-label="Direct link to 3.2.1.Lua的数据类型" title="Direct link to 3.2.1.Lua的数据类型">​</a></h3>
<p>Lua中支持的常见数据类型包括：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821091835406" src="/assets/images/image-20210821091835406-255b84cf0d3a12885beee634e19d7de3.png" width="1509" height="471" class="img_ev3q"></p>
<p>另外，Lua提供了type()函数来判断一个变量的数据类型：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821091904332" src="data:image/png;base64,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" width="596" height="166" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="322声明变量">3.2.2.声明变量<a href="#322声明变量" class="hash-link" aria-label="Direct link to 3.2.2.声明变量" title="Direct link to 3.2.2.声明变量">​</a></h3>
<p>Lua声明变量的时候无需指定数据类型，而是用local来声明变量为局部变量：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 声明字符串，可以用单引号或双引号，</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local str = &#x27;hello&#x27;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 字符串拼接可以使用 ..</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local str2 = &#x27;hello&#x27; .. &#x27;world&#x27;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 声明数字</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local num = 21</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 声明布尔类型</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local flag = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lua中的table类型既可以作为数组，又可以作为Java中的map来使用。数组就是特殊的table，key是数组角标而已：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 声明数组 ，key为角标的 table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local arr = {&#x27;java&#x27;, &#x27;python&#x27;, &#x27;lua&#x27;}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 声明table，类似java的map</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local map =  {name=&#x27;Jack&#x27;, age=21}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lua中的数组角标是从1开始，访问的时候与Java中类似：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 访问数组，lua数组的角标从1开始</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">print(arr[1])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lua中的table可以用key来访问：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 访问table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">print(map[&#x27;name&#x27;])</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">print(map.name)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="323循环">3.2.3.循环<a href="#323循环" class="hash-link" aria-label="Direct link to 3.2.3.循环" title="Direct link to 3.2.3.循环">​</a></h3>
<p>对于table，我们可以利用for循环来遍历。不过数组和普通table遍历略有差异。</p>
<p>遍历数组：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 声明数组 key为索引的 table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local arr = {&#x27;java&#x27;, &#x27;python&#x27;, &#x27;lua&#x27;}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 遍历数组</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">for index,value in ipairs(arr) do</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    print(index, value) </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>遍历普通table</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 声明map，也就是table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local map = {name=&#x27;Jack&#x27;, age=21}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 遍历table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">for key,value in pairs(map) do</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   print(key, value) </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="33条件控制函数">3.3.条件控制、函数<a href="#33条件控制函数" class="hash-link" aria-label="Direct link to 3.3.条件控制、函数" title="Direct link to 3.3.条件控制、函数">​</a></h2>
<p>Lua中的条件控制和函数声明与Java类似。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="331函数">3.3.1.函数<a href="#331函数" class="hash-link" aria-label="Direct link to 3.3.1.函数" title="Direct link to 3.3.1.函数">​</a></h3>
<p>定义函数的语法：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">function 函数名( argument1, argument2..., argumentn)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 函数体</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return 返回值</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>例如，定义一个函数，用来打印数组：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">function printArr(arr)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    for index, value in ipairs(arr) do</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        print(value)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="332条件控 制">3.3.2.条件控制<a href="#332条件控制" class="hash-link" aria-label="Direct link to 3.3.2.条件控制" title="Direct link to 3.3.2.条件控制">​</a></h3>
<p>类似Java的条件控制，例如if、else语法：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">if(布尔表达式)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   --[ 布尔表达式为 true 时执行该语句块 --]</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">else</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   --[ 布尔表达式为 false 时执行该语句块 --]</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>与java不同，布尔表达式中的逻辑运算是基于英文单词：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821092657918" src="/assets/images/image-20210821092657918-e06b5c9323146ef0ed73838e6b9d96a3.png" width="1481" height="317" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="333案例">3.3.3.案例<a href="#333案例" class="hash-link" aria-label="Direct link to 3.3.3.案例" title="Direct link to 3.3.3.案例">​</a></h3>
<p>需求：自定义一个函数，可以打印table，当参数为nil时，打印错误信息</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">function printArr(arr)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not arr then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        print(&#x27;数组不能为空！&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    for index, value in ipairs(arr) do</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        print(value)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>4.实现多级缓存</h1>
<p>多级缓存的实现离不开Nginx编程，而Nginx编程又离不开OpenResty。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="41安装openresty">4.1.安装OpenResty<a href="#41安装openresty" class="hash-link" aria-label="Direct link to 4.1.安装OpenResty" title="Direct link to 4.1.安装OpenResty">​</a></h2>
<p>OpenResty® 是一个基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：</p>
<ul>
<li>具备Nginx的完整功能</li>
<li>基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块</li>
<li>允许使用Lua<strong>自定义业务逻辑</strong>、<strong>自定义库</strong></li>
</ul>
<p>官方网站： <a href="https://openresty.org/cn/" target="_blank" rel="noopener noreferrer">https://openresty.org/cn/</a></p>
<p><img decoding="async" loading="lazy" alt="image-20210821092902946" src="/assets/images/image-20210821092902946-754b6796c547a90125fd1c983c7115d8.png" width="835" height="138" class="img_ev3q"></p>
<p>安装Lua可以参考课前资料提供的《安装OpenResty.md》：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821092941139" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJwAAADACAYAAADx9ArBAAAXx0lEQVR4nO2dvY8TRx/Hv+td+944iEIUkQiK5LFRQi4vUprIl3/AprmKls5Xnpt0lHQ0vvLc0VLRcG5TBBeJQiR0EAkbgQQSiMDxctyb1759Ct/szY5ndtfr3fWMPV/Jsr27M/v28e9lXtaG4zgOtLRSUmbcB6A1XdLAaaUqDZxWqtLAaaUqDZxWqrLiqESU6OoEWE0ZhjHU8mEUCTgCEg2U6LPfMi15xIOJXmYYhnsPyfIoABph2+FYyOh30Tq2rJbcYgFiwTIMg7uMV1akUBaOhUr0XYOnpsKCxgInKuenQOD8ADs6OhICF+R2teQR6zrJuwi4TEacawZB5wscCxP7ooFj4aPLk89a8ioItEwm4wshry6ehMAFQXZ0dOR5hQWPfNcav1jLFgRaJpNBJpOB4zjucpG1E0HHBY4HCw+0Xq/HBc/P1dLvWuNVUKxGQ0W/TNN0oSPl6M9sNktrADjWEvGsGYGNvFgARdBp4OSSCDQWNtM0B2Aj7zR4xPqReunPRL4WjnWlLGiff/55ktdDS1K9evXKhY6IWDbamISycIDYshHQut0uer1eAqeipYK63e6Al6Lhot0rKw9wfs0fBLhut+u+tKZTtm0PWDLyIsyIYrlAl8pzpd1uF7ZtJ3xaWrKK3Hte7MdCx4qbNLDA8WDrdDrJn5mWlCL3XpRs0Pz4Jg2iRIG8aHeqLdz0yrZtN2slkNGc0FaOhS5UlsomDDqGm251u11PU0mv1xuwbKKmL2E7nF+mmqaF63a7ODw8HDi2YeVXJmq7oKh9MZvNYn5+HpYVy3BD6WTbNkzThGmawh4ngH9d3SsiylB5iUNaFs62bezt7XHXRQEobuh4P0rS+L2zs4NTp05hcXHRt7NbRZH7b1mWp+Ff1MhPu9WBKxHUd0pDl6SOjo6EsAH+HcRRRqxGHc1KXyvW+u/v7+P169cT17NC2mFZ2ETQ0RL+9PySB7KzpOQ4DrrdrhuUihRpxGkC0AHwxLr0j7HX62F7extHR0eR65ZNLGw8CyeSBzheJzvPrZL3JGXbtnuTeENgiPyWJ2np2D5nNsal+yNt28a7d+8mxtLRDIhgE8VxXJdK3oNiuaRELFxYjcu9sheYdqmkU5vEb4eHh9je3p4I6HjuVBS/seK6VHZDEXhJimeaZXWvbKzb6/UGxpAZhoFOpzMR0PklCUSicwwVw4mSiCQlOuA0rVkY6HjtlcQ6s+PJJgW6oCFooWM4nkTxXBoXLM74LMmYjhdy8AYuklen08Hbt2+VhY4HG1kepFANRMNSHKfitmhx7oe92Gz3jt+gRhLTqZi9jsKDC9ywAKX564wTuiQsHc+tAhiwbOwcgU6no2T2OgorA80iw7zSVFqx2yiWjk2oePMC2M+Hh4d4+/atUpZuFE6U6nORyb2GTaiCoCMxneqJRFgpBRwgh3tlxYOOrtsPOrKNbdtTAZ3UwI07KRjW0rEWjgYqjKUj0KnkXoeV1MAB0azWsHVFrY/Iz8KFhY5sb9u2cjHdMJIeOD+llYmGgY5tl+JBxn73y14n1dIpAVyaVitsGTrWEmVm9HS5YWK6SbZ0SgAHyAudqPGXiAcWqUv0KAU6e3337t1EQacMcEC6nfdh5df2RMMl+syzbmyPhMrdYKyUAg4YfwMwvZyGix1BwXOjLFhk+TTFdFIDF2dSkGSjcVAPDKmHBxNZL7JwdJPJJMR0UgMHjL+hNwi6oO4cGir6GESJhKjvFYDyo0wABYAD5HCjdEMvKzZx4PU0sPWHTSTYz6q7VyWAA8YPHSsWPBYqOnHwi+WAaD0SKo4yARQCDhg/dDyrxfucyWTw/v37geU8i8cCxS4XZbKdTgdv3rxRztIpBRwgVz8q+UxgoB9/8OTJE9i2PVAPD1jRel4sx3b4f/jwQSlLp+SzCAzD8M0GReuGvTG8MmQZ7SoJbKZpIpvNotvtYnd3F3/88Qfy+TwWFxfd8qIYkH0X9WSwZfb39zE7O4vZ2dmhzm1cUhI4wB8gPyCHhdGvDB1XWZblwkbc3O7uLv755x/u/FpeuxzPqhGraZomLMsaeGWzWezt7SGXy7kuWWYpCxwQP3RAOOtIWzkCW6/XQzab9cxnsCxrYAQw++LFZ7wmEtqK0i/SBUaeYCS7lAYOiM9VBq3jQUdboWw26+m0N03TnTDMy1j9LBwPRl62SqAzDAO9Xg+WZUWKcdOU8sAB8cd0w0BHLBy9jABIYBNZOFFW6veis1lSxnH6TyrI5XIauLQUp3sNKkOL3HxiXWgXyz4vjc1A2WWiF7uedxyqNI9MDHBAutDRgyzp2IlYOBY2ej1558HDLgta59eHK6OkBi6Ke4gbOpEymYybIJDvxHLRTybwOxb6XbQ+6LthGMpYN0By4ID4kwK/MgC/y0pUFwsd2TaTyXisDm0No+w/qIzscRst6YED4oUuThgBMXR+ZcLsa1KlBHBAetBFWUcsWtgyYWBUJSYbVvK3FFKKGtOJloeNn8LWx9YtamsbZT+qSxkLRxRk6UTrZC7DW0fgnDRLpxxwAB+6Xq+H/f195cDirctkMlhYWAAQLZSQWVK71GHcXpiHJMbtQqPUF0bsVMNJcq9KWLgwwT8ZORGmTSpOixa3pXMcB5ZlDXTET4qlUwI4P9HNEMOMCRs3dFHKTAJ0UrtUWnG7sFEz0aTqGmWdClIGuCCpCl3cQMou5Vyqn1uhhwINo3G7SnY53W43ae5VOeAAfkt9r9dz/wwuyo0Yd3MKO85uYWFhIqGT2qX6uRxW7A2Lsq9h1yXV88EONwo6NpVcrBIWLkyziGmayOVynu3itHRxNn8EbU/mKtBS0ZrxpARwQLjBkDMzMwPrVXSvonWTAJ3ULpVVWq3+43avce9HJikFHKAmDEmOTFFNyrhUWiLXQmZJxT3OLO0slZ6ZJZKq7lVJ4IDBC97tdrG/vw8gGKphb1Ta3WBss4ionIrQSe1So6b8cbuctHskeFZ6UtyrshYO8N4gy7IwOzvr6WmQ2bX6rRO5VL9MXRUpAVzQHAByI7LZLHd9FFBEGvcoExXdKC2pXSqruEdYyJC9xrkfFaQUcED8N2LcZWSJU9OSEi6VlcitkGA7LhfGi6Ns20an03G3jzuuM03THUgaFEqoKCWBAwahYyfRjBrIk64yOi7c2dnBn3/+Cdu2Q9UXBUbDMPD999/jiy++8CyblGYR6YELOzyHnUQz6s3gja178uQJDg8PuduK6vCrX6THjx/j3LlzHrc5CRkqoABwQSI3gjeJZhQrZxjGQNZ7cHDgewy85aJ9+f0ger1epP2oICWAC9MsAkA4iSZuC0T02Wefuc/1/e+//zxlZmZm8OmnnwIA3r175w4OBYBcLoezZ88CALa3twdADup7Vc2N0lICOKKoo1+jxEBhbuw333yD06dPw3EcbG1t4dmzZ+54tp9//hmffPIJAODBgwd4+vSpW25xcRE//fQTDMPAvXv38OLFC9/9RDk2WTU1zSJJTlYxDAOXLl3C2bNnYZomvvvuOxc2ehs2JgtzbJPSpUWklIUjEv3C6b+QFCnsOsMw3Ac2h7Empmnihx9+wMuXL3H+/HnfYxctH9ZqqWjplASOJ3oSDRBP/+bMzIz7oGa/Mvv7+8jlcpibm8NXX30FANjb28Pc3JxnO/opmfQy0zTdrDiK61dJUgMXdmQF/U6vH7U/krV4Iu3s7ODly5dYWlpCJpPB7u4u7t+/j19++cWz3fnz5/Htt9966vrxxx/R6/Xw77//4tmzZ4EuVDWLxkpq4IBgOMh60zQxMzMz0HYW1dLxmkX8oHv+/DkWFhZw4cIF3Lt3j1vm2bNnmJubw//+9z/PMTx9+hTPnz8X1j1Jkh44IBx0QL+5gac4hw/5HUu73caLFy+ws7Pj+X8t2jo9evQIc3Nz+PLLLwEAr169QqvVGrCmullkzBrlQsfhXkVl2O61Dx8+uN95PR+O4+DBgweYn58HANy/f3/o41bZvSoDHDAaOFHb6QCxpdva2oJlWeh0OgPr9/b28Ndff8EwDHz8+NGzH9u28ffffwPoD40POoZJGhunFHCA/0Wm/8lPpGF6HbLZrOveeOvfv3/v2z315s2bgeWkLl6f7CR10oukHHAA/wZ0u11PF1EccZvjOJ7J1byJ1km1n5H+3KAyUcfTjUtKAgekE9OxN/zrr7/G27dvcXBwwG0yGeZ4RMeQzWZx4cKFoY9bFUkNXNAvl74BlmVhfn7eYxlGtXKmaXqWnz59Gr/++its2w7tmum/rwyzPRmASRqDWakOndTAAcMlAywgRFHAEy3PZrOev6scZl9xlVEZOiU678NYulHWi8ok2eEfpswkdt4rARyQDFSkXJpA+tU37DoVoVMGOCAYjlEsTxQrE6W+qGUmBTqlgAujoJs2iiWMsr+49hN3mXFJSeBGsXR+66PWm5Z7VQkskZQELoxGifniXpdWIqGCpAYu6ew0qXgwjTKqQic1cMB4mkRGkQygyizpgQPCQZWUi4w7bpt296oEcMDov/RRsleZEwnVpAxwgI7pJiF7VQo4QD3otKXzSjnggPEmEjJbOhWkJHBA8pZMW7pkpCxwgHrudZRjiavMuCU1cGEuqKzQ+ZWZZksnNXCAutBFbSNTDaBhJTVwZFJMXNAl0eEfdV2clpM3TVFWSQucYRh4/fq1O+0vDuhGLS8jdL1eDzs7O8pYRmnnNFiWBdu2cf/+fZw7dw6nTp0KXTbMFLyoGuWpmaM+cZPd/uPHj9je3saZM2fcR4vJLimBM4z+g2ROnTqF3d1dPH78GN1uV9mJI0nIMAxYloXFxUUsLCwI/4VHNkkLnGVZOHPmDABgYWHB/W8EDd1JPJrL5bC4uIgzZ87Asixt4UaRaZqYm5tzf8VB8zunTYbRf0JnLpdDNpsN/H9VWSQtcED/6ZDkggJqPi0oKRFrptoQJamBA9S7oFr+UsMOa02MNHBaqUoDp5WqNHBaqUoDx6i9vgxjtTHuw5hYaeAY5dduorZVHgq6xqqB5fW2d2F7HcvGKjS6Xk0xcA2sHje5eF8FVJsA6mXOOgJQv6w2hMNrioEDgCJqrZO/Lfd/baLilithw9kEyjR0LawvU3AWqmiijjIN7PI62tzjmB5NOXCM2utYDm25SthwHKzcNlCuA0ABa3cpQFs1FFHBJg3t3TXkkz0D6SV9T0NyKmHDKVHfG1gtVLG06WCjFGL7xiqMch2VTQebMHA94aOdFE2thWussvFZGXUA9TIvrmPcYmMVxvVLaDkMnI1VX5eqY74ptnClDQfOxvGXxiqMMrDpbIA1bo1VA2VswmHMHm3sShtOv1wDQLGGlnadQk0tcCdqYPXYNQ540vY6rteLqLVKzOJlFKpNYY0Fo8pfoWGcXpfqqgGgcuxKPVlkG+tXq2hWrmGNISS/dncwiz1OEioVJvNt1VAEUNnUSQOggQNKJWxsHMNxE7hKt8ehhhY/g/CosWrAuArcdDawsXETuErFfFeBm2ysN8XSwNHKX8QS/b15C3d8Gs5I4lGuA5VrxHrlsXbXQatWBEAv1wI0cH0dt78ZRhlbtRblKom1Wgbdc0VAu73iwHFa6LN10nOxvN523e7Kbcra6TR1moGjuraO3Z7jOLjrCdjyx4251/CwcNJfWjp2wX032cLDJlAv38YKpw6yreM4A5nuNGqKs9R+T8FG8IbutqPXozXFFk5rHNLAaaUqDZxWqtLAaaUqDZxWqtLAaaUqDdxUq90fpZxig3R6wNFjxagW+XGrvb7MGffm7VnQik8pAHf8KypvMfMHNrFULUgyzt87FLxVA6qFuKHTE2+AFIBrr19FtVnBpnOXGebTn4hSaVZRkOwu5NeuoYImbvn13GtFUsLANXCj2kSx9tvg4EYAQAm/1YpA/bY7f7Oxejwuze1Q9+n4Zrdhx7MdxydetznCXFHf/fXPl556SA65v3/vEPbl9fbJuTK7ES1317HndLxt4HmyYc3qnahXIrKSBa79CFso4spl8QCd/OUrKGILj+ir26yiQHWoO60ainVmcnJjFUbhFq64brqFGqoosDeqXsZV3KSm+tVRDrCojdUy6qjgGm2SA/fXwCoz2mTlUX9df+RIf5phZfOkg7+0UuEMgWrgdj1gWBN9Tq0ais0qCoaBwsNr4vOkJv2Q49tEFT4DlxNRssC1HiLc+TTxsEV/r2CTHh2bX8NNjyVsY/16HZVN2k3nsXazhiJ7A4s13HQ3GrSofXknu/SHHdHzG0Lsr/0IWwCWLlIjRdYCxsKVfkOtyLjuxm3UUcGK38AS+pzya7hWOb5m7miUElYqALYenfwYynUUay3PQNDSBhlalZ6SBa5wCeHOp4hLBfrrJRSYLfIXlwBiCdt3cKvJmWFVqKLJwrt0McQAyJOkYbMC1MuMOwqzv/xlXCnyhqr7KY/LV4po3rpzvH0fbHEI4nNOzDUrXKKuPOfHMC4lC1z+IpYCgu/2nVtoYglRrgXtHujXKMPOShtit+u/v+Oxc5SLCwNe/vIVykrewa2mfwiiuhJOGvqmvVm9IQjUBUlF8yFa7Ja360DxCi7n4Q4F33qURBZZwkbfzJ00YQyzv/wa7joOnM0K0KziRlCGkr+MK8dutX3nFprkHOOU8Pj7g0fTVOLNIv04oY7yQNbUD7LrnhiLaDDg9c4b6MdizWrB267VXsdyHE0spd9QKwL168RChdhfex2rAw13TKgA3k3PY+1aBc1bN3DjVpNJFo6z3pHPifzwrzJD5fuZc5pKYcRv39VcXl9GgXk4dGXT8UwodlWsYfPSdRhG2bMt7Srza3fRwjIKZePkohVraN2NYxh3PyG4VaiisHoRzkYpeH/5Naw8NHByikXUWnSS0becRrkAowoUa62ToeilFVTK/cx403P4BVyKKagvbfQfSVEuGCCzZiubLdS2ChDMok1EhnP8LPqjoyMcHR2h1+uh2+26r8PDQxweHuLg4AAHBwfY29vD3t4ednd3sbKyEvsBNVYNlLembcJwG+vLBVSXBmf4y6jbt29jYWEB8/PzmJ+fx+zsLGZnZzEzM4OZmRlYluW+TNNEJpNx/0fCtXDDPppeP8o+Rh0nC7Wb8sMGjMZKKJcqerCLVjxq3KiiWdnEXUVM+ig8BCYN7D+eGIaBTCajgYtBpCuqvBVuhr8sohmgYQvDhNDCiSgmO0rqv51KGw6m5Q+O8mt34ayN+yiGF83AsNaOSw1bgAedKn8mphW/yP33g0wE3QA1PBfKgmaaJkzTTOBUtFQQuf8i8PxcrAc4dkMRbORdazpFM8CDDhhkiUjoF3mwaQunBQxaOBF0PHFdqihJoGGzrCl+LMmUizToshYuKK4DmIZfUfzGg82yLPz+++84ODhweyM6nQ46nQ5s2/b0VpAeDHqEhdb4Rd9jAg/dS5DNZpHL5ZDL5dxeBNKrIIKO51p9G37ZDXnulBxMr9fD0dGRCxDZ3jRNdLtdt5uMdJuRbTVwcoh3jwlI5B7T0JF/585mswPdVix0pH5WXL/Is3C0dSMWK5vNcmGzLMsFjkCpgZNPPOBYL8ZCR2Cj+0oJeGHa4izeAYism2VZcBzHAw8pJ4KNBk67VLnkFzbxoCPgsdD5JQ8seFyXyrNu7ChXens/y0a7XQ2cXBLda56lY60d7VaHsXKBLjWTycBxnAHoiOiYLSxsGjg5JGrc94OOgMeDLUzTyIBLBQDHcYTQsQfLJhM0bMT9kndStwZODtFgsE0bLHQseOR7UONvoEslG5KDIGIhoSvNZDIei8ZLEmjQNHByKKgZjNe7RIMW1ADMky9w9MHQ8PFMMOtC/VypBk4OiYBjG/xpqESg8ergiZs00NknDZvowIg1I3FekGXTwMkhtr3MDzqexRP1MrD10/K1cCSWA+DGceyBsa6T1/zBxm0aODnE82T0ZxYknusMG7sR+Q7A5ImAxyYUQaBpyOQWDxY/8HjeLsidAgFzGtiCxN3yoKJdsQg0DZ2c4rlBEXhBVs0PNiDEJBq/CkQNwiKrpoGTUzzDwr4HARYGNmCIWVvsdz9rpkFTU2HBE60LtQ8nAg1B7pJXpYZObvGAEWWcw0LmqTMKcKxEVWjI1JQIpCiADdQRB3BaWmGl5/pppar/Aw3Cu4e5HQhBAAAAAElFTkSuQmCC" width="156" height="192" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="42openresty快速入门">4.2.OpenResty快速入门<a href="#42openresty快速入门" class="hash-link" aria-label="Direct link to 4.2.OpenResty快速入门" title="Direct link to 4.2.OpenResty快速入门">​</a></h2>
<p>我们希望达到的多级缓存架构如图：</p>
<p><img decoding="async" loading="lazy" alt="yeVDlwtfMx" src="/assets/images/yeVDlwtfMx-3799f0c9051952a2e388fd027ccf5b4b.png" width="1568" height="521" class="img_ev3q"></p>
<p>其中：</p>
<ul>
<li>
<p>windows上的nginx用来做反向代理服务，将前端的查询商品的ajax请求代理到OpenResty集群</p>
</li>
<li>
<p>OpenResty集群用来编写多级缓存业务</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="421反向代理流程">4.2.1.反向代理流程<a href="#421反向代理流程" class="hash-link" aria-label="Direct link to 4.2.1.反向代理流程" title="Direct link to 4.2.1.反向代理流程">​</a></h3>
<p>现在，商品详情页使用的是假的商品数据。不过在浏览器中，可以看到页面有发起ajax请求查询真实商品数据。</p>
<p>这个请求如下：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821093144700" src="/assets/images/image-20210821093144700-4e75d2e8f26ffb1be0da015a84f37fd1.png" width="564" height="147" class="img_ev3q"></p>
<p>请求地址是localhost，端口是80，就被windows上安装的Nginx服务给接收到了。然后代理给了OpenResty集群：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821094447709" src="/assets/images/image-20210821094447709-70a12787f6223c3237371687a311c12b.png" width="668" height="389" class="img_ev3q"></p>
<p>我们需要在OpenResty中编写业务，查询商品数据并返回到浏览器。</p>
<p>但是这次，我们先在OpenResty接收请求，返回假的商品数据。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="422openresty监听请求">4.2.2.OpenResty监听请求<a href="#422openresty监听请求" class="hash-link" aria-label="Direct link to 4.2.2.OpenResty监听请求" title="Direct link to 4.2.2.OpenResty监听请求">​</a></h3>
<p>OpenResty的很多功能都依赖于其目录下的Lua库，需要在nginx.conf中指定依赖库的目录，并导入依赖：</p>
<p>1）添加对OpenResty的Lua模块的加载</p>
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，在其中的http下面，添加下面代码：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#lua 模块</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">lua_package_path &quot;/usr/local/openresty/lualib/?.lua;;&quot;;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#c模块     </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">lua_package_cpath &quot;/usr/local/openresty/lualib/?.so;;&quot;;  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）监听/api/item路径</p>
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，在nginx.conf的server下面，添加对/api/item这个路径的监听：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">location  /api/item {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    # 默认的响应类型</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    default_type application/json;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    # 响应结果由lua/item.lua文件来决定</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    content_by_lua_file lua/item.lua;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个监听，就类似于SpringMVC中的<code>@GetMapping(&quot;/api/item&quot;)</code>做路径映射。</p>
<p>而<code>content_by_lua_file lua/item.lua</code>则相当于调用item.lua这个文件，执行其中的业务，把结果返回给用户。相当于java中调用service。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="423编写itemlua">4.2.3.编写item.lua<a href="#423编写itemlua" class="hash-link" aria-label="Direct link to 4.2.3.编写item.lua" title="Direct link to 4.2.3.编写item.lua">​</a></h3>
<p>1）在<code>/usr/loca/openresty/nginx</code>目录创建文件夹：lua</p>
<p><img decoding="async" loading="lazy" alt="image-20210821100755080" src="/assets/images/image-20210821100755080-365d2a05f297d51a0c602ec86f7a3b1a.png" width="696" height="132" class="img_ev3q"></p>
<p>2）在<code>/usr/loca/openresty/nginx/lua</code>文件夹下，新建文件：item.lua</p>
<p><img decoding="async" loading="lazy" alt="image-20210821100801756" src="/assets/images/image-20210821100801756-4b876f8da162d2de1154863a1b126125.png" width="615" height="130" class="img_ev3q"></p>
<p>3）编写item.lua，返回假数据</p>
<p>item.lua中，利用ngx.say()函数返回数据到Response中</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ngx.say(&#x27;{&quot;id&quot;:10001,&quot;name&quot;:&quot;SALSA AIR&quot;,&quot;title&quot;:&quot;RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4&quot;,&quot;price&quot;:17900,&quot;image&quot;:&quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&quot;,&quot;category&quot;:&quot;拉杆箱&quot;,&quot;brand&quot;:&quot;RIMOWA&quot;,&quot;spec&quot;:&quot;&quot;,&quot;status&quot;:1,&quot;createTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;updateTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;stock&quot;:2999,&quot;sold&quot;:31290}&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4）重新加载配置</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">nginx -s reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>刷新商品页面：<a href="http://localhost/item.html?id=1001%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%95%88%E6%9E%9C%EF%BC%9A" target="_blank" rel="noopener noreferrer">http://localhost/item.html?id=1001，即可看到效果：</a></p>
<p><img decoding="async" loading="lazy" alt="image-20210821101217089" src="/assets/images/image-20210821101217089-8ff761ab5e0a2548ea3ff8ba38b3ae02.png" width="1240" height="666" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="43请求参数处理">4.3.请求参数处理<a href="#43请求参数处理" class="hash-link" aria-label="Direct link to 4.3.请求参数处理" title="Direct link to 4.3.请求参数处理">​</a></h2>
<p>上一节中，我们在OpenResty接收前端请求，但是返回的是假数据。</p>
<p>要返回真实数据，必须根据前端传递来的商品id，查询商品信息才可以。</p>
<p>那么如何获取前端传递的商品参数呢？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="431获取参数的api">4.3.1.获取参数的API<a href="#431获取参数的api" class="hash-link" aria-label="Direct link to 4.3.1.获取参数的API" title="Direct link to 4.3.1.获取参数的API">​</a></h3>
<p>OpenResty中提供了一些API用来获取不同类型的前端请求参数：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821101433528" src="/assets/images/image-20210821101433528-08eee74ce5ed02edd583c50155612f3e.png" width="1504" height="629" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="432获取参数并返回">4.3.2.获取参数并返回<a href="#432获取参数并返回" class="hash-link" aria-label="Direct link to 4.3.2.获取参数并返回" title="Direct link to 4.3.2.获取参数并返回">​</a></h3>
<p>在前端发起的ajax请求如图：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821101721649" src="/assets/images/image-20210821101721649-a27d0bf09685445dcddc59f57a9d61ff.png" width="1042" height="282" class="img_ev3q"></p>
<p>可以看到商品id是以路径占位符方式传递的，因此可以利用正则表达式匹配的方式来获取ID</p>
<p>1）获取商品id</p>
<p>修改<code>/usr/loca/openresty/nginx/nginx.conf</code>文件中监听/api/item的代码，利用正则表达式获取ID：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">location ~ /api/item/(\d+) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    # 默认的响应类型</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    default_type application/json;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    # 响应结果由lua/item.lua文件来决定</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    content_by_lua_file lua/item.lua;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）拼接ID并返回</p>
<p>修改<code>/usr/loca/openresty/nginx/lua/item.lua</code>文件，获取id并拼接到结果中返回：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 获取商品id</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local id = ngx.var[1]</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 拼接并返回</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ngx.say(&#x27;{&quot;id&quot;:&#x27; .. id .. &#x27;,&quot;name&quot;:&quot;SALSA AIR&quot;,&quot;title&quot;:&quot;RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4&quot;,&quot;price&quot;:17900,&quot;image&quot;:&quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&quot;,&quot;category&quot;:&quot;拉杆箱&quot;,&quot;brand&quot;:&quot;RIMOWA&quot;,&quot;spec&quot;:&quot;&quot;,&quot;status&quot;:1,&quot;createTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;updateTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;stock&quot;:2999,&quot;sold&quot;:31290}&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3）重新加  载并测试</p>
<p>运行命令以重新加载OpenResty配置：</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">nginx -s reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>刷新页面可以看到结果中已经带上了ID：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821102235467" src="/assets/images/image-20210821102235467-d8b19640d6ce16d64d30e8a862ce6a58.png" width="458" height="276" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="44查询tomcat">4.4.查询Tomcat<a href="#44查询tomcat" class="hash-link" aria-label="Direct link to 4.4.查询Tomcat" title="Direct link to 4.4.查询Tomcat">​</a></h2>
<p>拿到商品ID后，本应去缓存中查询商品信息，不过目前我们还未建立nginx、redis缓存。因此，这里我们先根据商品id去tomcat查询商品信息。我们实现如图部分：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821102610167" src="/assets/images/image-20210821102610167-8f3be4f49208d346e7515a206d7c5ddf.png" width="1518" height="496" class="img_ev3q"></p>
<p>需要注意的是，我们的OpenResty是在虚拟机，Tomcat是在Windows电脑上。两者IP一定不要搞错了。</p>
<p><img decoding="async" loading="lazy" alt="image-20210821102959829" src="/assets/images/image-20210821102959829-dd35b405a0f8ed3be7aeef1a3f5e9794.png" width="895" height="544" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="441发送http请求的api">4.4.1.发送http请求的API<a href="#441发送http请求的api" class="hash-link" aria-label="Direct link to 4.4.1.发送http请求的API" title="Direct link to 4.4.1.发送http请求的API">​</a></h3>
<p>nginx提供了内部API用以发送http请求：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local resp = ngx.location.capture(&quot;/path&quot;,{</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    method = ngx.HTTP_GET,   -- 请求方式</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    args = {a=1,b=2},  -- get方式传参数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">})</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>返回的响应内容包括：</p>
<ul>
<li>resp.status：响应状态码</li>
<li>resp.header：响应头，是一个table</li>
<li>resp.body：响应体，就是响应数据</li>
</ul>
<p>注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。</p>
<p>但是我们希望这个请求发送到Tomcat服务器，所以还需要编写一个server来对这个路径做反向代理：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> location /path {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">     # 这里是windows电脑的ip和Java服务端口，需要确保windows防火墙处于关闭状态</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">     proxy_pass http://192.168.111.1:8081; </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>原理如图：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821104149061" src="/assets/images/image-20210821104149061-3002d8b92456aa6ce73c0dcaad857822.png" width="865" height="404" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="442封装http工具">4.4.2.封装http工具<a href="#442封装http工具" class="hash-link" aria-label="Direct link to 4.4.2.封装http工具" title="Direct link to 4.4.2.封装http工具">​</a></h3>
<p>下面，我们封装一个发送Http请求的工具，基于ngx.location.capture来实现查询tomcat。</p>
<p>1）添加反向代理，到windows的Java服务</p>
<p>因为item-service中的接口都是/item开头，所以我们监听/item路径，代理到windows上的tomcat服务。</p>
<p>修改 <code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，添加一个location：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">location /item {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    proxy_pass http://192.168.111.1:8081;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以后，只要我们调用<code>ngx.location.capture(&quot;/item&quot;)</code>，就一定能发送请求到windows的tomcat服务。</p>
<p>2）封装工具类</p>
<p>之前我们说过，OpenResty启动时会加载以下两个目录中的工具文件：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821104857413" src="/assets/images/image-20210821104857413-9ce79b4587665bb20d15c2ba3e8854c6.png" width="745" height="149" class="img_ev3q"></p>
<p>所以，自定义的http工具也需要放到这个目录下。</p>
<p>在<code>/usr/local/openresty/lualib</code>目录下，新建一个common.lua文件：</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">vi /usr/local/openresty/lualib/common.lua</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>内容如下:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 封装函数，发送http请求，并解析响应</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local function read_http(path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local resp = ngx.location.capture(path,{</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        method = ngx.HTTP_GET,</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        args = params,</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    })</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not resp then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- 记录错误信息，返回404</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;http请求查询失败, path: &quot;, path , &quot;, args: &quot;, args)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.exit(404)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return resp.body</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 将方法导出</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local _M = {  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    read_http = read_http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">return _M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个工具将read_http函数封装到_M这个table类型的变量中，并且返回，这类似于导出。</p>
<p>使用的时候，可以利用<code>require(&#x27;common&#x27;)</code>来导入该函数库，这里的common是函数库的文件名。</p>
<p>3）实现商品查询</p>
<p>最后，我们修改<code>/usr/local/openresty/lua/item.lua</code>文件，利用刚刚封装的函数库实现对tomcat的查询：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 引入自定义common工具模块，返回值是common中返回的 _M</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local common = require(&quot;common&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 从 common中获取read_http这个函数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_http = common.read_http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 获取路径参数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local id = ngx.var[1]</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 根据id查询商品</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local itemJSON = read_http(&quot;/item/&quot;.. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 根据id查询商品库存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local itemStockJSON = read_http(&quot;/item/stock/&quot;.. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ngx.say(itemJSON)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里查询到的结果是json字符串，并且包含商品、库存两个json字符串，页面最终需要的是把两个json拼接为一个json：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821110441222" src="/assets/images/image-20210821110441222-f1354561ec0846e4207c91069a7f056a.png" width="891" height="577" class="img_ev3q"></p>
<p>这就需要我们先把JSON变为lua的table，完成数据整合后，再转为JSON。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="443cjson工具类">4.4.3.CJSON工具类<a href="#443cjson工具类" class="hash-link" aria-label="Direct link to 4.4.3.CJSON工具类" title="Direct link to 4.4.3.CJSON工具类">​</a></h3>
<p>OpenResty提供了一个cjson的模块用来处理JSON的序列化和反序列化。</p>
<p>官方地址： <a href="https://github.com/openresty/lua-cjson/" target="_blank" rel="noopener noreferrer">https://github.com/openresty/lua-cjson/</a></p>
<p>安装OpenResty时已安装了一些lua库，CJSON就在里面</p>
<p>1）引入cjson模块：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local cjson = require &quot;cjson&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）序列化：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local obj = {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    name = &#x27;jack&#x27;,</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    age = 21</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 把 table 序列化为 json</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local json = cjson.encode(obj)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3）反序列化：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local json = &#x27;{&quot;name&quot;: &quot;jack&quot;, &quot;age&quot;: 21}&#x27;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 反序列化 json为 table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local obj = cjson.decode(json);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">print(obj.name)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="444实现tomcat查询">4.4.4.实现Tomcat查询<a href="#444实现tomcat查询" class="hash-link" aria-label="Direct link to 4.4.4.实现Tomcat查询" title="Direct link to 4.4.4.实现Tomcat查询">​</a></h3>
<p>下面，我们修改之前的item.lua中的业务，添加json处理功能：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入common函数库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local common = require(&#x27;common&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_http = common.read_http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入cjson库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local cjson = require(&#x27;cjson&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 获取路径参数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local id = ngx.var[1]</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 根据id查询商品</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local itemJSON = read_http(&quot;/item/&quot;.. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 根据id查询商品库存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local itemStockJSON = read_http(&quot;/item/stock/&quot;.. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- JSON转化为lua的table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local item = cjson.decode(itemJSON)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local stock = cjson.decode(itemStockJSON)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 组合数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">item.stock = stock.stock</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">item.sold = stock.sold</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 把item序列化为json 返回结果</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ngx.say(cjson.encode(item))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="445基于id负载均衡">4.4.5.基于ID负载均衡<a href="#445基于id负载均衡" class="hash-link" aria-label="Direct link to 4.4.5.基于ID负载均衡" title="Direct link to 4.4.5.基于ID负载均衡">​</a></h3>
<p>刚才的代码中，我们的tomcat是单机部署。而实际开发中，tomcat一定是集群模式：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821111023255" src="/assets/images/image-20210821111023255-a285a54a32eafdc14d0c5add07eca665.png" width="1531" height="501" class="img_ev3q"></p>
<p>因此，OpenResty需要对tomcat集群做负载均衡。</p>
<p>而默认的负载均衡规则是轮询模式，当我们查询/item/10001时：</p>
<ul>
<li>第一次会访问8081端口的tomcat服务，在该服务内部就形成了JVM进程缓存</li>
<li>第二次会访问8082端口的tomcat服务，该服务内部没有JVM缓存（因为JVM缓存无法共享），会查询数据库</li>
<li>...</li>
</ul>
<p>你看，因为轮询的原因，第一次查询8081形成的JVM缓存并未生效，直到下一次再次访问到8081时才可以生效，缓存命中率太低了。</p>
<p>怎么办？</p>
<p>如果能让同一个商品，每次查询时都访问同一个tomcat服务，那么JVM缓存就一定能生效了。</p>
<p>也就是说，我们需要根据商品id做负载均衡，而不是轮询。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1原理">1）原理<a href="#1原理" class="hash-link" aria-label="Direct link to 1）原理" title="Direct link to 1）原理">​</a></h4>
<p>nginx提供了基于请求路径做负载均衡的算法：</p>
<p>nginx根据请求路径做hash运算，把得到的数值对tomcat服务的数量取余，余数是几，就访问第几个服务，实现负载均衡。</p>
<p>例如：</p>
<ul>
<li>我们的请求路径是 /item/10001</li>
<li>tomcat总数为2台（8081、8082）</li>
<li>对请求路径/item/1001做hash运算求余的结果为1</li>
<li>则访问第一个tomcat服务，也就是8081</li>
</ul>
<p>只要id不变，每次hash运算结果也不会变，那就可以保证同一个商品，一直访问同一个tomcat服务，确保JVM缓存生效。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2实现">2）实现<a href="#2实现" class="hash-link" aria-label="Direct link to 2）实现" title="Direct link to 2）实现">​</a></h4>
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，实现基于ID做负载均衡。</p>
<p>首先，定义tomcat集群，并设置基于路径做负载均衡：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">upstream tomcat-cluster {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    hash $request_uri;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    server 192.168.111.1:8081;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    server 192.168.111.1:8082;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，修改对tomcat服务的反向代理，目标指向tomcat集群：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">location /item {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    proxy_pass http://tomcat-cluster;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重新加载OpenResty</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">nginx -s reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3测试">3）测试<a href="#3测试" class="hash-link" aria-label="Direct link to 3）测试" title="Direct link to 3）测试">​</a></h4>
<p>启动两台tomcat服务：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821112420464" src="/assets/images/image-20210821112420464-f5f9743848e95744bb9dc7cca52caf9a.png" width="1419" height="902" class="img_ev3q"></p>
<p>同时启动：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821112444482" src="/assets/images/image-20210821112444482-48ccb1d5036f87f296fc768bdcc02f32.png" width="467" height="165" class="img_ev3q"></p>
<p>清空日志后，再次访问页面，可以看到不同id的商品，访问到了不同的tomcat服务：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821112559965" src="/assets/images/image-20210821112559965-5408c13f93e5943d037c9d7bc44c7a0d.png" width="1554" height="346" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20210821112637430" src="/assets/images/image-20210821112637430-78aa140210ad96481899a81b8a0b90e9.png" width="1462" height="351" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="45redis缓存预热">4.5.Redis缓存预热<a href="#45redis缓存预热" class="hash-link" aria-label="Direct link to 4.5.Redis缓存预热" title="Direct link to 4.5.Redis缓存预热">​</a></h2>
<p>Redis缓存会面临冷启动问题：</p>
<p><strong>冷启动</strong>：服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询时添加缓存，可能会给数据库带来较大压力。</p>
<p><strong>缓存预热</strong>：在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。</p>
<p>我们数据量较少，并且没有数据统计相关功能，目前可以在启动时将所有数据都放入缓存中。</p>
<p>1）利用Docker安装Redis</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">docker run --name redis -p 6379:6379 -d redis redis-server --appendonly yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）在item-service服务中引入Redis依赖</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">dependency</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">groupId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">groupId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">artifactId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain">spring-boot-starter-data-redis</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">artifactId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">dependency</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3）配置Redis地址</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token key atrule" style="color:hsl(35, 99%, 36%)">spring</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token key atrule" style="color:hsl(35, 99%, 36%)">redis</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token key atrule" style="color:hsl(35, 99%, 36%)">host</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> 192.168.111.100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4）编写初始化类</p>
<p>缓存预热需要在项目启动时完成，并且必须是拿到RedisTemplate之后。</p>
<p>这里我们利用InitializingBean接口来实现，因为InitializingBean可以在对象被Spring创建并且成员变量全部注入后执行。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">package com.heima.item.config;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.fasterxml.jackson.core.JsonProcessingException;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.fasterxml.jackson.databind.ObjectMapper;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.pojo.Item;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.pojo.ItemStock;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.service.IItemService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.service.IItemStockService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.beans.factory.InitializingBean;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.data.redis.core.StringRedisTemplate;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class RedisHandler implements InitializingBean {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private StringRedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private IItemService itemService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private IItemStockService stockService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private static final ObjectMapper MAPPER = new ObjectMapper();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public void afterPropertiesSet() throws Exception {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 初始化缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 1.查询商品信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        List&lt;Item&gt; itemList = itemService.list();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 2.放入缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (Item item : itemList) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.1.item序列化为JSON</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            String json = MAPPER.writeValueAsString(item);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.2.存入redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            redisTemplate.opsForValue().set(&quot;item:id:&quot; + item.getId(), json);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 3.查询商品库存信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        List&lt;ItemStock&gt; stockList = stockService.list();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 4.放入缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (ItemStock stock : stockList) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.1.item序列化为JSON</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            String json = MAPPER.writeValueAsString(stock);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.2.存入redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            redisTemplate.opsForValue().set(&quot;item:stock:id:&quot; + stock.getId(), json);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="46查询redis缓存">4.6.查询Redis缓存<a href="#46查询redis缓存" class="hash-link" aria-label="Direct link to 4.6.查询Redis缓存" title="Direct link to 4.6.查询Redis缓存">​</a></h2>
<p>现在，Redis缓存已经准备就绪，我们可以再OpenResty中实现查询Redis的逻辑了。如下图红框所示：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821113340111" src="/assets/images/image-20210821113340111-bd0dcc70423e348176b90e12a9871bdf.png" width="1576" height="562" class="img_ev3q"></p>
<p>当请求进入OpenResty之后：</p>
<ul>
<li>优先查询Redis缓存</li>
<li>如果Redis缓存未命中，再查询Tomcat</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="461封装redis工具">4.6.1.封装Redis工具<a href="#461封装redis工具" class="hash-link" aria-label="Direct link to 4.6.1.封装Redis工具" title="Direct link to 4.6.1.封装Redis工具">​</a></h3>
<p>OpenResty提供了操作Redis的模块，我们只要引入该模块就能直接使用。但是为了方便，我们将Redis操作封装到之前的common.lua工具库中。</p>
<p>修改<code>/usr/local/openresty/lualib/common.lua</code>文件：</p>
<p>1）引入Redis模块，并初始化Redis对象</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local redis = require(&#x27;resty.redis&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 初始化redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local red = redis:new()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">red:set_timeouts(1000, 1000, 1000)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）封装函数，用来释放Redis连接，其实是放入连接池</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 关闭redis连接的工具方法，其实是放入连接池</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local function close_redis(red)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local pool_max_idle_time = 10000 -- 连接的空闲时间，单位是毫秒</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local pool_size = 100 --连接池大小</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local ok, err = red:set_keepalive(pool_max_idle_time, pool_size)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not ok then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;放入redis连接池失败: &quot;, err)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3）封装函数，根据key查询Redis数据</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local function read_redis(ip, port, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 获取一个连接</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local ok, err = red:connect(ip, port)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not ok then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;连接redis失败 : &quot;, err)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return nil</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local resp, err = red:get(key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询失败处理</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not resp then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;查询Redis失败: &quot;, err, &quot;, key = &quot; , key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    --得到的数据为空处理</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if resp == ngx.null then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        resp = nil</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;查询Redis数据为空, key = &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    close_redis(red)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return resp</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4）导出</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 将方法导出</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local _M = {  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    read_http = read_http,</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    read_redis = read_redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">return _M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="附录完整的commonlua">附录：完整的common.lua<a href="#附录完整的commonlua" class="hash-link" aria-label="Direct link to 附录：完整的common.lua" title="Direct link to 附录：完整的common.lua">​</a></h4>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local redis = require(&#x27;resty.redis&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 初始化redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local red = redis:new()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">red:set_timeouts(1000, 1000, 1000)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 关闭redis连接的工具方法，其实是放入连接池</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local function close_redis(red)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local pool_max_idle_time = 10000 -- 连接的空闲时间，单位是毫秒</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local pool_size = 100 --连接池大小</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local ok, err = red:set_keepalive(pool_max_idle_time, pool_size)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not ok then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;放入redis连接池失败: &quot;, err)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local function read_redis(ip, port, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 获取一个连接</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local ok, err = red:connect(ip, port)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not ok then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;连接redis失败 : &quot;, err)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return nil</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local resp, err = red:get(key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询失败处理</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not resp then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;查询Redis失败: &quot;, err, &quot;, key = &quot; , key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    --得到的数据为空处理</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if resp == ngx.null then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        resp = nil</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;查询Redis数据为空, key = &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    close_redis(red)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return resp</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 封装函数，发送http请求，并解析响应</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local function read_http(path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local resp = ngx.location.capture(path,{</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        method = ngx.HTTP_GET,</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        args = params,</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    })</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not resp then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- 记录错误信息，返回404</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;http查询失败, path: &quot;, path , &quot;, args: &quot;, args)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.exit(404)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return resp.body</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 将方法导出</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local _M = {  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    read_http = read_http,</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    read_redis = read_redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">return _M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="462实现redis查询">4.6.2.实现Redis查询<a href="#462实现redis查询" class="hash-link" aria-label="Direct link to 4.6.2.实现Redis查询" title="Direct link to 4.6.2.实现Redis查询">​</a></h3>
<p>接下来，我们就可以去修改item.lua文件，实现对Redis的查询了。</p>
<p>查询逻辑是：</p>
<ul>
<li>根 据id查询Redis</li>
<li>如果查询失败则继续查询Tomcat</li>
<li>将查询结果返回</li>
</ul>
<p>1）修改<code>/usr/local/openresty/lua/item.lua</code>文件，添加一个查询函数：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入common函数库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local common = require(&#x27;common&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_http = common.read_http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_redis = common.read_redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 封装查询函数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">function read_data(key, path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询本地缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local val = read_redis(&quot;127.0.0.1&quot;, 6379, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 判断查询结果</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not val then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;redis查询失败，尝试查询http， key: &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- redis查询失败，去查询http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        val = read_http(path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 返回数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return val</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）而后修改商品查询、库存查询的业务：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821114528954" src="/assets/images/image-20210821114528954-1d349634846552d0eb8bfc6bc649ad76.png" width="1029" height="267" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="附录完整的itemlua代码">附录：完整的item.lua代码<a href="#附录完整的itemlua代码" class="hash-link" aria-label="Direct link to 附录：完整的item.lua代码" title="Direct link to 附录：完整的item.lua代码">​</a></h4>
<p>实现查询redis和tomcat的完整item.lua代码，若要查询nginx本地缓存，  下面还需要加代码</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入common函数库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local common = require(&#x27;common&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_http = common.read_http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_redis = common.read_redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入cjson库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local cjson = require(&#x27;cjson&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 封装查询函数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">function read_data(key, path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询Redis缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local val = read_redis(&quot;127.0.0.1&quot;, 6379, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 判断查询结果</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not val then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;redis查询失败，尝试查询http， key: &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- redis查询失败，去查询http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        val = read_http(path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 返回数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return val</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 获取路径参数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local id = ngx.var[1]</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 查询商品信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local itemJSON = read_data(&quot;item:id:&quot; .. id,  &quot;/item/&quot; .. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 查询库存信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local stockJSON = read_data(&quot;item:stock:id:&quot; .. id, &quot;/item/stock/&quot; .. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- JSON转化为lua的table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local item = cjson.decode(itemJSON)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local stock = cjson.decode(stockJSON)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 组合数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">item.stock = stock.stock</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">item.sold = stock.sold</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 把item序列化为json 返回结果</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ngx.say(cjson.encode(item))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="47nginx本地缓存">4.7.Nginx本地缓存<a href="#47nginx本地缓存" class="hash-link" aria-label="Direct link to 4.7.Nginx本地缓存" title="Direct link to 4.7.Nginx本地缓存">​</a></h2>
<p>现在，整个多级缓存中只差最后一环，也就是nginx的本地缓存了。如图：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821114742950" src="/assets/images/image-20210821114742950-50adabf014ae869010c9f02075d96d7d.png" width="1549" height="501" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="471本地缓存api">4.7.1.本地缓存API<a href="#471本地缓存api" class="hash-link" aria-label="Direct link to 4.7.1.本地缓存API" title="Direct link to 4.7.1.本地缓存API">​</a></h3>
<p>OpenResty为Nginx提供了<strong>shard dict</strong>的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。</p>
<p>1）开启共享字典，在nginx.conf的http下添加配置：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> # 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> lua_shared_dict item_cache 150m; </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）操作共享字典：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 获取本地缓存对象</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local item_cache = ngx.shared.item_cache</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 存储, 指定key、value、过期时间，单位s，默认为0代表永不过期</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">item_cache:set(&#x27;key&#x27;, &#x27;value&#x27;, 1000)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 读取</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local val = item_cache:get(&#x27;key&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="472实现本地缓存查询">4.7.2.实现本地缓存查询<a href="#472实现本地缓存查询" class="hash-link" aria-label="Direct link to 4.7.2.实现本地缓存查询" title="Direct link to 4.7.2.实现本地缓存查询">​</a></h3>
<p>1）修改<code>/usr/local/openresty/lua/item.lua</code>文件，修改read_data查询函数，添加本地缓存逻辑：</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入共享词典，本地缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local item_cache = ngx.shared.item_cache</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 封装查询函数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">function read_data(key, expire, path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询本地缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local val = item_cache:get(key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not val then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;本地缓存查询失败，尝试查询Redis  ， key: &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- 查询redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        val = read_redis(&quot;127.0.0.1&quot;, 6379, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- 判断查询结果</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        if not val then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            ngx.log(ngx.ERR, &quot;redis查询失败，尝试查询http， key: &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            -- redis查询失败，去查询http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            val = read_http(path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询成功，把数据写入本地缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    item_cache:set(key, val, expire)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 返回数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return val</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）修改item.lua中查询商品和库存的业务，实现最新的read_data函数：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821115108528" src="/assets/images/image-20210821115108528-ae394c6cd7c835b31375bd0be0c739a1.png" width="1098" height="188" class="img_ev3q"></p>
<p>其实就是多了缓存时间参数，过期后nginx缓存会自动删除，下次访问即可更新缓存。</p>
<p>这里给商品基本信息设置超时时间为30分钟，库存为1分钟。</p>
<p>因为库存更新频率较高，如果缓存时间过长，可能与数据库差异较大。</p>
<p>如果是秒杀商品，就不要加库存的缓存了</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="附录完整的itemlua文件">附录：完整的item.lua文件<a href="#附录完整的itemlua文件" class="hash-link" aria-label="Direct link to 附录：完整的item.lua文件" title="Direct link to 附录：完整的item.lua文件">​</a></h4>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入common函数库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local common = require(&#x27;common&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_http = common.read_http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local read_redis = common.read_redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入cjson库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local cjson = require(&#x27;cjson&#x27;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 导入共享词典，本地缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local item_cache = ngx.shared.item_cache</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 封装查询函数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">function read_data(key, expire, path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询本地缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local val = item_cache:get(key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if not val then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        ngx.log(ngx.ERR, &quot;Nginx本地缓存查询失败，尝试查询Redis， key: &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- 查询redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        val = read_redis(&quot;127.0.0.1&quot;, 6379, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        -- 判断查询结果</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        if not val then</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            ngx.log(ngx.ERR, &quot;Redis查询失败，尝试查询http， key: &quot;, key)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            -- Redis查询失败，去查询http</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            val = read_http(path, params)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 查询成功，把数据写入本地缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    item_cache:set(key, val, expire)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    -- 返回数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return val</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">end</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 获取路径参数</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local id = ngx.var[1]</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 查询商品信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local itemJSON = read_data(&quot;item:id:&quot; .. id, 1800,  &quot;/item/&quot; .. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 查询库存信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local stockJSON = read_data(&quot;item:stock:id:&quot; .. id, 60, &quot;/item/stock/&quot; .. id, nil)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- JSON转化为lua的table</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local item = cjson.decode(itemJSON)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local stock = cjson.decode(stockJSON)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 组合数据</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">item.stock = stock.stock</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">item.sold = stock.sold</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-- 把item序列化为json 返回结果</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ngx.say(cjson.encode(item))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>5.缓存同步</h1>
<p>大多数情况下，浏览器查询到的都是缓存数据，如果缓存数据与数据库数据存在较大差异，可能会产生比较严重的后果。</p>
<p>所以我们必须保证数据库数据、缓存数据的一致性，这就是缓存与数据库的同步。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="51数据同步策略">5.1.数据同步策略<a href="#51数据同步策略" class="hash-link" aria-label="Direct link to 5.1.数据同步策略" title="Direct link to 5.1.数据同步策略">​</a></h2>
<p>缓存数据同步的常见方式有三种：</p>
<p><strong>设置有效期</strong>：给缓存设置有效期，到期后自动删除。再次查询时更新</p>
<ul>
<li>优势：简单、方便</li>
<li>缺点：时效性差，缓存过期之前可能不一致</li>
<li>场景：更新频率较低，时效性要求低的业务</li>
</ul>
<p><strong>同步双写</strong>：在修改数据库的同时，直接修改缓存</p>
<ul>
<li>优势：时效性强，缓存与数据库强一致</li>
<li>缺点：有代码侵入，耦合度高；</li>
<li>场景：对一致性、时效性要求较高的缓存数据</li>
</ul>
<p>**异步通知：**修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据</p>
<ul>
<li>优势：低耦合，可以同时通知多个缓存服务</li>
<li>缺点：时效性一般，可能存在中间不 一致状态</li>
<li>场景：时效性要求一般，有多个服务需要同步</li>
</ul>
<p>而异步实现又可以基于MQ或者Canal来实现：</p>
<p>1）基于MQ的异步通知：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821115552327" src="/assets/images/image-20210821115552327-e38929cc3fab0146dadbd00c89f7b51c.png" width="1484" height="657" class="img_ev3q"></p>
<p>解读：</p>
<ul>
<li>商品服务完成对数据的修改后，只需要发送一条消息到MQ中。</li>
<li>缓存服务监听MQ消息，然后完成对缓存的更新</li>
</ul>
<p>依然有少量的代码侵入。</p>
<p>2）基于Canal的通知</p>
<p><img decoding="async" loading="lazy" alt="image-20210821115719363" src="/assets/images/image-20210821115719363-77324fc74dbbcb7d25a43cd123167f1a.png" width="1461" height="635" class="img_ev3q"></p>
<p>解读：</p>
<ul>
<li>商品服务完成商品修改后，业务直接结束，没有任何代码侵入</li>
<li>Canal监听MySQL变化，当发现变化后，立即通知缓存服务</li>
<li>缓存服务接收到canal通知，更新缓存</li>
</ul>
<p>代码零侵入</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="52安装canal">5.2.安装Canal<a href="#52安装canal" class="hash-link" aria-label="Direct link to 5.2.安装Canal" title="Direct link to 5.2.安装Canal">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="521认识canal">5.2.1.认识Canal<a href="#521认识canal" class="hash-link" aria-label="Direct link to 5.2.1.认识Canal" title="Direct link to 5.2.1.认识Canal">​</a></h3>
<p><strong>Canal [kə&#x27;næl]</strong>，译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&amp;消费。GitHub的地址：<a href="https://github.com/alibaba/canal" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/canal</a></p>
<p>Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821115914748" src="/assets/images/image-20210821115914748-d6f8c5ecf71d830acbe1a66c19612dd9.png" width="536" height="356" class="img_ev3q"></p>
<ul>
<li>1）MySQL master 将数据变更写入二进制日志( binary log），其中记录的数据叫做binary log events</li>
<li>2）MySQL slave 将 master 的 binary log events拷贝到它的中继日志(relay log)</li>
<li>3）MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li>
</ul>
<p>而Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。</p>
<p><img decoding="async" loading="lazy" alt="image-20210821115948395" src="/assets/images/image-20210821115948395-9ea0dfb64e94133a40b6940cb4816c72.png" width="835" height="400" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="522安装canal">5.2.2.安装Canal<a href="#522安装canal" class="hash-link" aria-label="Direct link to 5.2.2.安装Canal" title="Direct link to 5.2.2.安装Canal">​</a></h3>
<p>安装和配置Canal参考课前资料文档：</p>
<p><img decoding="async" loading="lazy" alt="image-20210821120017324" src="data:image/png;base64,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" width="148" height="173" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="53监听canal">5.3.监听Canal<a href="#53监听canal" class="hash-link" aria-label="Direct link to 5.3.监听Canal" title="Direct link to 5.3.监听Canal">​</a></h2>
<p>Canal提供了各种语言的客户端，当Canal监听到binlog变化时，会通知Canal的客户端。</p>
<p><img decoding="async" loading="lazy" alt="image-20210821120049024" src="/assets/images/image-20210821120049024-925282c232ec55bc0f536a140aab039d.png" width="1502" height="596" class="img_ev3q"></p>
<p>我们可以利用Canal提供的Java客户端，监听Canal通知消息。当收到变化的消息时，完成对缓存的更新。</p>
<p>不过这里我们会使用GitHub上的第三方开源的canal-starter客户端。地址：<a href="https://github.com/NormanGyllenhaal/canal-client" target="_blank" rel="noopener noreferrer">https://github.com/NormanGyllenhaal/canal-client</a></p>
<p>与SpringBoot完美整合，自动装配，比官方客户端要简单好用很多。</p>
<blockquote>
<p>注意：canal只能监听MySQL，然后同步JVM本地缓存和Redis缓存，无法同步Nginx缓存，Nginx缓存目前只教了过期时间，所以Nginx缓存尽量只缓存静态数据等信息，或者把过期时间设置短一些</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="531引入依赖">5.3.1.引入依赖：<a href="#531引入依赖" class="hash-link" aria-label="Direct link to 5.3.1.引入依赖：" title="Direct link to 5.3.1.引入依赖：">​</a></h3>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">dependency</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">groupId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain">top.javatool</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">groupId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">artifactId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain">canal-spring-boot-starter</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">artifactId</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;</span><span class="token tag" style="color:hsl(5, 74%, 59%)">version</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain">1.2.1-RELEASE</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">version</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&lt;/</span><span class="token tag" style="color:hsl(5, 74%, 59%)">dependency</span><span class="token tag punctuation" style="color:hsl(119, 34%, 47%)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="532编写配置">5.3.2.编写配置：<a href="#532编写配置" class="hash-link" aria-label="Direct link to 5.3.2.编写配置：" title="Direct link to 5.3.2.编写配置：">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token key atrule" style="color:hsl(35, 99%, 36%)">canal</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token key atrule" style="color:hsl(35, 99%, 36%)">destination</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> heima </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># canal的集群名字，要与安装canal时设置的名称一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token key atrule" style="color:hsl(35, 99%, 36%)">server</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> 192.168.111.100</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">11111</span><span class="token plain"> </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># canal服务地址</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="533修改item实体类">5.3.3.修改Item实体类<a href="#533修改item实体类" class="hash-link" aria-label="Direct link to 5.3.3.修改Item实体类" title="Direct link to 5.3.3.修改Item实体类">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20231018164746555" src="/assets/images/image-20231018164746555-e7e4fbf185af4f0491fa0c68b791f20b.png" width="2082" height="909" class="img_ev3q"></p>
<p>通过@Id、@Column、等注解完成Item与数据库表字段的 映射：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">package com.heima.item.pojo;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.baomidou.mybatisplus.annotation.IdType;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.baomidou.mybatisplus.annotation.TableField;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.baomidou.mybatisplus.annotation.TableId;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.baomidou.mybatisplus.annotation.TableName;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.data.annotation.Id;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.data.annotation.Transient;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import javax.persistence.Column;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.Date;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@TableName(&quot;tb_item&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class Item {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @TableId(type = IdType.AUTO)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Id</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Long id;//商品id</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Column(name = &quot;name&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private String name;//商品名称</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private String title;//商品标题</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Long price;//价格（分）</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private String image;//商品图片</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private String category;//分类名称</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private String brand;//品牌名称</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private String spec;//规格</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Integer status;//商品状态 1-正常，2-下架</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Date createTime;//创建时间</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Date updateTime;//更新时间</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @TableField(exist = false)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Transient</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Integer stock;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @TableField(exist = false)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Transient</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Integer sold;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="534编写监听器">5.3.4.编写监听器<a href="#534编写监听器" class="hash-link" aria-label="Direct link to 5.3.4.编写 监听器" title="Direct link to 5.3.4.编写监听器">​</a></h3>
<p>通过实现<code>EntryHandler&lt;T&gt;</code>接口编写监听器，监听Canal消息。注意两点：</p>
<ul>
<li>实现类通过<code>@CanalTable(&quot;tb_item&quot;)</code>指定监听的表信息</li>
<li>EntryHandler的泛型是与表对应的实体类</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">package com.heima.item.canal;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.github.benmanes.caffeine.cache.Cache;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.config.RedisHandler;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.pojo.Item;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import top.javatool.canal.client.annotation.CanalTable;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import top.javatool.canal.client.handler.EntryHandler;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@CanalTable(&quot;tb_item&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class ItemHandler implements EntryHandler&lt;Item&gt; {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private RedisHandler redisHandler;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Cache&lt;Long, Item&gt; itemCache;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public void insert(Item item) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 写数据到JVM进程缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        itemCache.put(item.getId(), item);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 写数据到redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        redisHandler.saveItem(item);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public void update(Item before, Item after) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 写数据到JVM进程缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        itemCache.put(after.getId(), after);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 写数据到redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        redisHandler.saveItem(after);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public void delete(Item item) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 删除数据到JVM进程缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        itemCache.invalidate(item.getId());</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 删除数据到redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        redisHandler.deleteItemById(item.getId());</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在这里对Redis的操作都封装到了RedisHandler这个对象中，是我们之前做缓存预热时编写的一个类，内容如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">package com.heima.item.config;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.fasterxml.jackson.core.JsonProcessingException;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.fasterxml.jackson.databind.ObjectMapper;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.pojo.Item;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.pojo.ItemStock;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.service.IItemService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.item.service.IItemStockService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.beans.factory.InitializingBean;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.data.redis.core.StringRedisTemplate;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class RedisHandler implements InitializingBean {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private StringRedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private IItemService itemService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private IItemStockService stockService;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private static final ObjectMapper MAPPER = new ObjectMapper();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public void afterPropertiesSet() throws Exception {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 初始化缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 1.查询商品信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        List&lt;Item&gt; itemList = itemService.list();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 2.放入缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (Item item : itemList) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.1.item序列化为JSON</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            String json = MAPPER.writeValueAsString(item);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.2.存入redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            redisTemplate.opsForValue().set(&quot;item:id:&quot; + item.getId(), json);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 3.查询商品库存信息</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        List&lt;ItemStock&gt; stockList = stockService.list();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 4.放入缓存</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (ItemStock stock : stockList) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.1.item序列化为JSON</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            String json = MAPPER.writeValueAsString(stock);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 2.2.存入redis</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            redisTemplate.opsForValue().set(&quot;item:stock:id:&quot; + stock.getId(), json);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public void saveItem(Item item) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            String json = MAPPER.writeValueAsString(item);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            redisTemplate.opsForValue().set(&quot;item:id:&quot; + item.getId(), json);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        } catch (JsonProcessingException e) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    public void deleteItemById(Long id) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        redisTemplate.delete(&quot;item:id:&quot; + id);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="54多级缓存总结">5.4.多级缓存总结<a href="#54多级缓存总结" class="hash-link" aria-label="Direct link to 5.4.多级缓存总结" title="Direct link to 5.4.多级缓存总结">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20231018172156983" src="/assets/images/image-20231018172156983-fe14df8c835cef1d554ef8bdf55431d8.png" width="2202" height="1045" class="img_ev3q"></p>
<blockquote>
<p><strong>多级缓存</strong>和前面实战篇学的<strong>Redis缓存</strong>中Redis操作的区别：</p>
<ol>
<li>为什么要使用多级缓存？
<ul>
<li>因为前面讲的Redis缓存为Nginx请求Tomcat后，先查询Redis缓存，若缓存未命中才查询MySQL数据库，但是这有一个问题：就是<strong>Tomcat的并发度没有Redis高，所以Tomcat成为了Redis的瓶颈</strong>，所以我们可以将Redis放在Tomcat的前面，由Nginx先查询Redis再查询Tomcat；</li>
<li>另外：Tomcat也可以添加本地JVM缓存，若JVM缓存未命中才再去查询MySQL数据库，并将数据写入JVM缓存</li>
</ul>
</li>
<li>缓存同步策略的区别？
<ul>
<li>①前面Redis缓存的同步策略是：采用<strong>主动操作为主，过期策略为辅</strong>；主动操作表现为数据发生变化则删除Redis中的数据，并且是先改后删，由客户端访问数据时发现Redis没有缓存才将数据缓存到Redis；
②前面的Redis缓存还需要解决 <strong>缓存穿透</strong>、<strong>缓存雪崩</strong>、<strong>缓存击穿</strong> 等问题；缓存穿透可以使用返回空值和使用布隆过滤器解决；缓存击穿可以使用互斥锁和逻辑过期解决。</li>
<li>多级缓存的缓存同步策略可以是设置有效期、同步双写(即Redis缓存的策略)、异步通知三种方法，而异步通知又可以使用MQ或者Canal监听MySQL的变化，这里采用的方法是使用canal来监听MySQL，然后更改JVM缓存和Redis缓存；
注意：canal只能监听MySQL，然后同步JVM本地缓存和Redis缓存，无法同步Nginx缓存，Nginx缓存目前只教了过期时间，所以Nginx缓存尽量只缓存静态数据等信息，或者把过期时间设置短一些
至于缓存穿透、缓存雪崩、缓存击穿等问题没有讲是否需要实现，我认为是需要的</li>
</ul>
</li>
</ol>
</blockquote></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#21导入案例" class="table-of-contents__link toc-highlight">2.1.导入案例</a></li><li><a href="#22初识caffeine" class="table-of-contents__link toc-highlight">2.2.初识Caffeine</a><ul><li><a href="#221caffeine基本api" class="table-of-contents__link toc-highlight">2.2.1.Caffeine基本API</a></li><li><a href="#222caffeine三种缓存驱逐策略" class="table-of-contents__link toc-highlight">2.2.2.Caffeine三种缓存驱逐策略</a></li></ul></li><li><a href="#23实现jvm进程缓存" class="table-of-contents__link toc-highlight">2.3.实现JVM进程缓存</a><ul><li><a href="#231需求" class="table-of-contents__link toc-highlight">2.3.1.需求</a></li><li><a href="#232实现" class="table-of-contents__link toc-highlight">2.3.2.实现</a></li></ul></li><li><a href="#31初识lua" class="table-of-contents__link toc-highlight">3.1.初识Lua</a></li><li><a href="#31helloworld" class="table-of-contents__link toc-highlight">3.1.HelloWorld</a></li><li><a href="#32变量和循环" class="table-of-contents__link toc-highlight">3.2.变量和循环</a><ul><li><a href="#321lua的数据类型" class="table-of-contents__link toc-highlight">3.2.1.Lua的数据类型</a></li><li><a href="#322声明变量" class="table-of-contents__link toc-highlight">3.2.2.声明变量</a></li><li><a href="#323循环" class="table-of-contents__link toc-highlight">3.2.3.循环</a></li></ul></li><li><a href="#33条件控制函数" class="table-of-contents__link toc-highlight">3.3.条件控制、函数</a><ul><li><a href="#331函数" class="table-of-contents__link toc-highlight">3.3.1.函数</a></li><li><a href="#332条件控制" class="table-of-contents__link toc-highlight">3.3.2.条件控制</a></li><li><a href="#333案例" class="table-of-contents__link toc-highlight">3.3.3.案例</a></li></ul></li><li><a href="#41安装openresty" class="table-of-contents__link toc-highlight">4.1.安装OpenResty</a></li><li><a href="#42openresty快速入门" class="table-of-contents__link toc-highlight">4.2.OpenResty快速入门</a><ul><li><a href="#421反向代理流程" class="table-of-contents__link toc-highlight">4.2.1.反向代理流程</a></li><li><a href="#422openresty监听请求" class="table-of-contents__link toc-highlight">4.2.2.OpenResty监听请求</a></li><li><a href="#423编写itemlua" class="table-of-contents__link toc-highlight">4.2.3.编写item.lua</a></li></ul></li><li><a href="#43请求参数处理" class="table-of-contents__link toc-highlight">4.3.请求参数处理</a><ul><li><a href="#431获取参数的api" class="table-of-contents__link toc-highlight">4.3.1.获取参数的API</a></li><li><a href="#432获取参数并返回" class="table-of-contents__link toc-highlight">4.3.2.获取参数并返回</a></li></ul></li><li><a href="#44查询tomcat" class="table-of-contents__link toc-highlight">4.4.查询Tomcat</a><ul><li><a href="#441发送http请求的api" class="table-of-contents__link toc-highlight">4.4.1.发送http请求的API</a></li><li><a href="#442封装http工具" class="table-of-contents__link toc-highlight">4.4.2.封装http工具</a></li><li><a href="#443cjson工具类" class="table-of-contents__link toc-highlight">4.4.3.CJSON工具类</a></li><li><a href="#444实现tomcat查询" class="table-of-contents__link toc-highlight">4.4.4.实现Tomcat查询</a></li><li><a href="#445基于id负载均衡" class="table-of-contents__link toc-highlight">4.4.5.基于ID负载均衡</a></li></ul></li><li><a href="#45redis缓存预热" class="table-of-contents__link toc-highlight">4.5.Redis缓存预热</a></li><li><a href="#46查询redis缓存" class="table-of-contents__link toc-highlight">4.6.查询Redis缓存</a><ul><li><a href="#461封装redis工具" class="table-of-contents__link toc-highlight">4.6.1.封装Redis工具</a></li><li><a href="#462实现redis查询" class="table-of-contents__link toc-highlight">4.6.2.实现Redis查询</a></li></ul></li><li><a href="#47nginx本地缓存" class="table-of-contents__link toc-highlight">4.7.Nginx本地缓存</a><ul><li><a href="#471本地缓存api" class="table-of-contents__link toc-highlight">4.7.1.本地缓存API</a></li><li><a href="#472实现本地缓存查询" class="table-of-contents__link toc-highlight">4.7.2.实现本地缓存查询</a></li></ul></li><li><a href="#51数据同步策略" class="table-of-contents__link toc-highlight">5.1.数据同步策略</a></li><li><a href="#52安装canal" class="table-of-contents__link toc-highlight">5.2.安装Canal</a><ul><li><a href="#521认识canal" class="table-of-contents__link toc-highlight">5.2.1.认识Canal</a></li><li><a href="#522安装canal" class="table-of-contents__link toc-highlight">5.2.2.安装Canal</a></li></ul></li><li><a href="#53监听canal" class="table-of-contents__link toc-highlight">5.3.监听Canal</a><ul><li><a href="#531引入依赖" class="table-of-contents__link toc-highlight">5.3.1.引入依赖：</a></li><li><a href="#532编写配置" class="table-of-contents__link toc-highlight">5.3.2.编写配置：</a></li><li><a href="#533修改item实体类" class="table-of-contents__link toc-highlight">5.3.3.修改Item实体类</a></li><li><a href="#534编写监听器" class="table-of-contents__link toc-highlight">5.3.4.编写监听器</a></li></ul></li><li><a href="#54多级缓存总结" class="table-of-contents__link toc-highlight">5.4.多级缓存总结</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>