<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-码农/redis/Redis高级-最佳实践" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Redis高级篇之最佳实践 | Coisini</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.minddiy.top/码农/redis/Redis高级-最佳实践/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Redis高级篇之最佳实践 | Coisini"><meta data-rh="true" name="description" content="笔记原件来自黑马B站视频配套笔记，经过自己加工修改添加等"><meta data-rh="true" property="og:description" content="笔记原件来自黑马B站视频配套笔记，经过自己加工修改添加等"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doc.minddiy.top/码农/redis/Redis高级-最佳实践/"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/redis/Redis高级-最佳实践/" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.minddiy.top/码农/redis/Redis高级-最佳实践/" hreflang="x-default"><meta name="google-site-verification" content="1FUPX6Qo4y3ecU623ShEurhgnjhSTjK49rRMhEDlzFA">
<link rel="stylesheet" href="/katex/katex.min.css">
<script src="/js/matomo.js" async defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.79037026.css">
<script src="/assets/js/runtime~main.468f2b27.js" defer="defer"></script>
<script src="/assets/js/main.4763ab3e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Coisini</b></a></div><div class="navbar__items navbar__items--right"><a href="https://minddiy.top" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Redis高级篇之最佳实践</h1></header>
<blockquote>
<p>笔记原件来自黑马B站视频配套笔记，经过自己加工修改添加等</p>
</blockquote>
<p><strong>今日内容</strong></p>
<blockquote>
<ul>
<li>Redis键值设计</li>
<li>批处理优化</li>
<li>服务端优化</li>
<li>集群最佳实践</li>
</ul>
</blockquote>
<h1>1、Redis键值设计</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="11优雅的key结构">1.1、优雅的key结构<a href="#11优雅的key结构" class="hash-link" aria-label="Direct link to 1.1、优雅的key结构" title="Direct link to 1.1、优雅的key结构">​</a></h2>
<p>Redis的Key虽然可以自定义，但最好遵循下面的几个最佳实践约定：</p>
<ul>
<li>遵循基本格式：[业务名称]:[数据名]:[id]</li>
<li>长度不超过44字节</li>
<li>不包含特殊字符</li>
</ul>
<p>例如：我们的登录业务，保存用户信息，其key可以设计成如下格式：</p>
<p><img decoding="async" loading="lazy" alt="image-20220521120213631" src="data:image/png;base64,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" width="360" height="143" class="img_ev3q"></p>
<p>这样设计的好处：</p>
<ul>
<li>可读性强</li>
<li>避免key冲突</li>
<li>方便管理</li>
<li>更节省内存： key是string类型，底层编码包含int、embstr和raw三种。
embstr在小于44字节使用，采用连续内存空间，内存占用更小。当字节数大于44字节时，会转为raw模式存储，在raw模式下，内存空间不是连续的，而是采用一个指针指向了另外一段内存空间，在这段空间里存储SDS内容，这样空间不连续，访问的时候性能也就会收到影响，还有可能产生内存碎片
（具体看《Redis原理篇》 String数据类类型）</li>
</ul>
<blockquote>
<p>这里的底层编码指的是key-value中二者，二者都是属于一个对象，key属于String类型</p>
</blockquote>
<p>使用object encoding key 查看key的底层编码</p>
<p><img decoding="async" loading="lazy" alt="image-20220521122320482" src="/assets/images/image-20220521122320482-b667c6c4f1286bf1a7f2e946e1151a64.png" width="805" height="565" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="12拒绝bigkey">1.2、拒绝BigKey<a href="#12拒绝bigkey" class="hash-link" aria-label="Direct link to 1.2、拒绝BigKey" title="Direct link to 1.2、拒绝BigKey">​</a></h2>
<p>BigKey通常以Key的大小和Key中成员的数量来综合判定，例如：</p>
<ul>
<li>Key本身的数据量过大：一个String类型的Key，它的值为5 MB</li>
<li>Key中的成员数过多：一个ZSET类型的Key，它的成员数量为10,000个</li>
<li>Key中成员的数据量过大：一个Hash类型的Key，它的成员数量虽然只有1,000个但这些成员的Value（值）总大小为100 MB</li>
</ul>
<p>那么如何判断元素的大小呢？redis也给我们提供了命令</p>
<p><img decoding="async" loading="lazy" alt="image-20220521124650117" src="/assets/images/image-20220521124650117-36792596611b73946258c3277e8550bb.png" width="1283" height="441" class="img_ev3q"></p>
<blockquote>
<p>判断元素的大小：</p>
<ul>
<li>memory usage key ：查看key使用的字节数（CPU消耗较高，不推荐使用）</li>
<li>STRLEN/LLEN key ： 查看集合类型key的长度</li>
</ul>
</blockquote>
<p><strong>推荐值：</strong></p>
<ul>
<li>单个key的value小于10KB</li>
<li>对于集合类型的key，建议元素数量小于1000</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="121bigkey的危害">1.2.1、BigKey的危害<a href="#121bigkey的危害" class="hash-link" aria-label="Direct link to 1.2.1、BigKey的危害" title="Direct link to 1.2.1、BigKey的危害">​</a></h3>
<ul>
<li>网络阻塞
<ul>
<li>对BigKey执行读请求时，少量的QPS就可能导致带宽使用率被占满，导致Redis实例，乃至所在物理机变慢</li>
</ul>
</li>
<li>数据倾斜
<ul>
<li>BigKey所在的Redis实例内存使用率远超其他实例，无法使数据分片的内存资源达到均衡</li>
</ul>
</li>
<li>Redis主线程阻塞
<ul>
<li>对元素较多的hash、list、zset等做运算会耗时较旧，使主线程被阻塞</li>
<li>当进行RDB的bgsave和AOF的bgrewrite时，会fork子进程，fork子进程会复制父进程的页表等数据结构，页表太大会造成主线程阻塞</li>
</ul>
</li>
<li>CPU压力
<ul>
<li>对BigKey的数据序列化和反序列化会导致CPU的使用率飙升，影响Redis实例和本机其它应用</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="122如何发现bigkey">1.2.2、如何发现BigKey<a href="#122如何发现bigkey" class="hash-link" aria-label="Direct link to 1.2.2、如何发现BigKey" title="Direct link to 1.2.2、如何发现BigKey">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="redis-cli---bigkeys">①redis-cli --bigkeys<a href="#redis-cli---bigkeys" class="hash-link" aria-label="Direct link to ①redis-cli --bigkeys" title="Direct link to ①redis-cli --bigkeys">​</a></h4>
<p>利用redis-cli提供的--bigkeys参数，可以遍历分析所有key，并返回Key的整体统计信息与每个数据的Top1的big key</p>
<p>命令：<code>redis-cli -a 密码 --bigkeys</code></p>
<p><img decoding="async" loading="lazy" alt="image-20220521133359507" src="/assets/images/image-20220521133359507-1fc00efba3dffed9ecd0b597d87852cd.png" width="1089" height="561" class="img_ev3q"></p>
<p>缺点：<strong>只能</strong>扫描到各个数据类型中<strong>TOP1</strong>的数据信息</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="scan扫描推荐">②scan扫描（推荐）<a href="#scan扫描推荐" class="hash-link" aria-label="Direct link to ②scan扫描（推荐）" title="Direct link to ②scan扫描（推荐）">​</a></h4>
<p>自己编程，利用scan扫描Redis中的所有key，利用strlen、hlen等命令判断key的长度（此处不建议使用MEMORY USAGE）</p>
<p><img decoding="async" loading="lazy" alt="image-20220521133703245" src="data:image/png;base64,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" width="395" height="202" class="img_ev3q"></p>
<p>scan 命令调用完后每次会返回2个元素，第一个是下一次迭代的光标，第一次光标会设置为0，当最后一次scan 返回的光标等于0时，表示整个scan遍历结束了，第二个返回的是List，一个匹配的key的数组</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.jedis.util.JedisConnectionFactory;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.junit.jupiter.api.AfterEach;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.junit.jupiter.api.BeforeEach;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.junit.jupiter.api.Test;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import redis.clients.jedis.Jedis;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import redis.clients.jedis.ScanResult;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class JedisTest {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Jedis jedis;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @BeforeEach</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void setUp() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 1.建立连接</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // jedis = new Jedis(&quot;192.168.150.101&quot;, 6379);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis = JedisConnectionFactory.getJedis();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 2.设置密码</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis.auth(&quot;123321&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 3.选择库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis.select(0);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    final static int STR_MAX_LEN = 10 * 1024;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    final static int HASH_MAX_LEN = 500;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testScan() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        int maxLen = 0;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        long len = 0;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        String cursor = &quot;0&quot;;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        do {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 扫描并获取一部分key</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            ScanResult&lt;String&gt; result = jedis.scan(cursor);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 记录cursor</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            cursor = result.getCursor();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            List&lt;String&gt; list = result.getResult();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            if (list == null || list.isEmpty()) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 遍历</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            for (String key : list) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                // 判断key的类型</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                String type = jedis.type(key);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                switch (type) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                    case &quot;string&quot;:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        len = jedis.strlen(key);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        maxLen = STR_MAX_LEN;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                    case &quot;hash&quot;:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        len = jedis.hlen(key);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        maxLen = HASH_MAX_LEN;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                    case &quot;list&quot;:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        len = jedis.llen(key);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        maxLen = HASH_MAX_LEN;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                    case &quot;set&quot;:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        len = jedis.scard(key);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        maxLen = HASH_MAX_LEN;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                    case &quot;zset&quot;:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        len = jedis.zcard(key);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        maxLen = HASH_MAX_LEN;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                    default:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                if (len &gt;= maxLen) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                    System.out.printf(&quot;Found big key : %s, type: %s, length or size: %d %n&quot;, key, type, len);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        } while (!cursor.equals(&quot;0&quot;));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @AfterEach</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void tearDown() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        if (jedis != null) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            jedis.close();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="第三方工具">③第三方工具<a href="#第三方工具" class="hash-link" aria-label="Direct link to ③第三方工具" title="Direct link to ③第三方工具">​</a></h4>
<ul>
<li>利用第三方工具，如 Redis-Rdb-Tools 分析RDB快照文件，全面分析内存使用情况</li>
<li><a href="https://github.com/sripathikrishnan/redis-rdb-tools" target="_blank" rel="noopener noreferrer">https://github.com/sripathikrishnan/redis-rdb-tools</a></li>
<li>缺点：只能离线分析，具有数据延迟性</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="网络监控推荐但贵">④网络监控（推荐，但贵）<a href="#网络监控推荐但贵" class="hash-link" aria-label="Direct link to ④网络监控（推荐，但贵）" title="Direct link to ④网络监控（推荐，但贵）">​</a></h4>
<ul>
<li>自定义工具，监控进出Redis的网络数据，超出预警值时主动告警</li>
<li>一般阿里云搭建的云服务器就有相关监控页面</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20220521140415785" src="/assets/images/image-20220521140415785-a90770c9006b43d1781ab4235ec5847c.png" width="1188" height="270" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="123如何删除bigkey">1.2.3、如何删除BigKey<a href="#123如何删除bigkey" class="hash-link" aria-label="Direct link to 1.2.3、如何删除BigKey" title="Direct link to 1.2.3 、如何删除BigKey">​</a></h3>
<p>BigKey内存占用较多，即便是删除这样的key也需要耗费很长时间，导致Redis主线程阻塞，引发一系列问题。</p>
<ul>
<li>redis 3.0 及以下版本
<ul>
<li>如果是集合类型，则遍历BigKey的元素，先逐个删除子元素，最后删除BigKey</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20220521140621204" src="/assets/images/image-20220521140621204-16aa4927298917fd5d9ddbf0b280871f.png" width="1102" height="375" class="img_ev3q"></p>
<ul>
<li>Redis 4.0以后
<ul>
<li>Redis在4.0后提供了异步删除的命令：<strong>unlink</strong></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="13恰当的数据类型">1.3、恰当的数据类型<a href="#13恰当的数据类型" class="hash-link" aria-label="Direct link to 1.3、恰当的数据类型" title="Direct link to 1.3、恰当的数据类型">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="例1比如存储一个user对象我们有三种存储方式">例1：比如存储一个User对象，我们有三种存储方式：<a href="#例1比如存储一个user对象我们有三种存储方式" class="hash-link" aria-label="Direct link to 例1：比如存储一个User对象，我们有三种存储方式：" title="Direct link to 例1：比如存储一个User对象，我们有三种存储方式：">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方式一json字符串">①方式一：json字符串<a href="#方式一json字符串" class="hash-link" aria-label="Direct link to ①方式一：json字符串" title="Direct link to ①方式一：json字符串">​</a></h4>







<table><thead><tr><th style="text-align:center">user:1</th><th style="text-align:center">{&quot;name&quot;: &quot;Jack&quot;, &quot;age&quot;: 21}</th></tr></thead></table>
<p>优点：实现简单粗暴</p>
<p>缺点：数据耦合，不够灵活</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方式二字段打散">②方式二：  字段打散<a href="#方式二字段打散" class="hash-link" aria-label="Direct link to ②方式二：字段打散" title="Direct link to ②方式二：字段打散">​</a></h4>













<table><thead><tr><th style="text-align:center">user:1:name</th><th style="text-align:center">Jack</th></tr></thead><tbody><tr><td style="text-align:center">user:1:age</td><td style="text-align:center">21</td></tr></tbody></table>
<p>优点：可以灵活访问对象任意字段</p>
<p>缺点：占用空间大、没办法做统一控制</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方式三hash推荐">③方式三：hash（推荐）<a href="#方式三hash推荐" class="hash-link" aria-label="Direct link to ③方式三：hash（推荐）" title="Direct link to ③方式三：hash（推荐）">​</a></h4>
<table>
	<tbody><tr>
		<td rowspan="2">user:1</td>
        <td>name</td>
        <td>jack</td>
	</tr>
	<tr>
		<td>age</td>
		<td>21</td>
	</tr></tbody></table>
<p>优点：底层使用ziplist，空间占用小，可以灵活访问对象的任意字段</p>
<p>缺点：代码相对复杂</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="例2假如有hash类型的key其中有100万对field和valuefield是自增id这个key存在什么问题如何优化">例2：假如有hash类型的key，其中有100万对field和value，field是自增id，这个key存在什么问题？如何优化？<a href="#例2假如有hash类型的key其中有100万对field和valuefield是自增id这个key存在什么问题如何优化" class="hash-link" aria-label="Direct link to 例2：假如有hash类型的key，其中有100万对field和value，field是自增id，这个key存在什么问题？如何优化？" title="Direct link to 例2：假如有hash类型的key，其中有100万对field和value，field是自增id，这个key存在什么问题？如何优化？">​</a></h3>
<table>
	<tbody><tr style="color:red">
		<td>key</td>
        <td>field</td>
        <td>value</td>
	</tr>
	<tr>
		<td rowspan="3">someKey</td>
		<td>id:0</td>
        <td>value0</td>
	</tr>
    <tr>
		<td>.....</td>
        <td>.....</td>
	</tr>
    <tr>
        <td>id:999999</td>
        <td>value999999</td>
    </tr></tbody></table>
<p>存在的问题：</p>
<ul>
<li>hash的entry数量超过500时，会使用<strong>哈希表</strong>而不是<strong>ZipList</strong>，内存占用较多
<ul>
<li><img decoding="async" loading="lazy" alt="image-20220521142943350" src="/assets/images/image-20220521142943350-34d833b823ace0b9b41661d0c2b4a816.png" width="573" height="216" class="img_ev3q"></li>
</ul>
</li>
<li>可以通过<strong>hash-max-ziplist-entries</strong>配置entry上限。但是如果entry过多就会导致BigKey问题
<ul>
<li>config set/get hash-max-ziplist-entries (默认是512)</li>
<li>前面说过集合类型的长度最好不要超过1000，因此不推荐该参数设置的过大</li>
</ul>
</li>
</ul>
<blockquote>
<p>可以使用命令	info memory 查看redis实例使用的内存数量</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方案一调节hash-max-ziplist-entries大小">方案一：调节hash-max-ziplist-entries大小<a href="#方案一调节hash-max-ziplist-entries大小" class="hash-link" aria-label="Direct link to 方案一：调节hash-max-ziplist-entries大小" title="Direct link to 方案一：调节hash-max-ziplist-entries大小">​</a></h4>
<p>调大hash-max-ziplist-entries参数的值，但最好不要超过1000</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方案二拆分为string">方案二：拆分为String<a href="#方案二拆分为string" class="hash-link" aria-label="Direct link to 方案二：拆分为String" title="Direct link to 方案二：拆分为String">​</a></h4>
<p>拆分为string类型</p>
<table>
	<tbody><tr style="color:red">
		<td>key</td>
        <td>value</td>
	</tr>
	<tr>
		<td>id:0</td>
        <td>value0</td>
	</tr>
    <tr>
		<td>.....</td>
        <td>.....</td>
	</tr>
    <tr>
        <td>id:999999</td>
        <td>value999999</td>
    </tr></tbody></table>
<p>存在的问题：</p>
<ul>
<li>string结构底层没有太多内存优化，<strong>内存占用较多</strong>，可以发现比原来hash的内存占用还要高</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20220521143458010" src="/assets/images/image-20220521143458010-189d6d6733764194883c072bb7ccf4fe.png" width="644" height="250" class="img_ev3q"></p>
<ul>
<li>想要批量获取这些数据比较麻烦</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方案三hash分片推荐">方案三：Hash分片（推荐）<a href="#方案三hash分片推荐" class="hash-link" aria-label="Direct link to 方案三：Hash分片（推荐）" title="Direct link to 方案三：Hash分片（推荐）">​</a></h4>
<p>拆分为小的hash，将 id / 100 作为key， 将id % 100 作为field，这样每100个元素为一个Hash</p>
<table>
	<tbody><tr style="color:red">
		<td>key</td>
        <td>field</td>
        <td>value</td>
	</tr>
	<tr>
        <td rowspan="3">key:0</td>
		<td>id:00</td>
        <td>value0</td>
	</tr>
    <tr>
		<td>.....</td>
        <td>.....</td>
	</tr>
    <tr>
        <td>id:99</td>
        <td>value99</td>
    </tr>
    <tr>
        <td rowspan="3">key:1</td>
		<td>id:00</td>
        <td>value100</td>
	</tr>
    <tr>
		<td>.....</td>
        <td>.....</td>
	</tr>
    <tr>
        <td>id:99</td>
        <td>value199</td>
    </tr>
    <tr>
    	<td colspan="3">....</td>
    </tr>
    <tr>
        <td rowspan="3">key:9999</td>
		<td>id:00</td>
        <td>value999900</td>
	</tr>
    <tr>
		<td>.....</td>
        <td>.....</td>
	</tr>
    <tr>
        <td>id:99</td>
        <td>value999999</td>
    </tr></tbody></table>
![image-20220521144339377](./images/image-20220521144339377.png)
<p>数据导入测试案例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">package com.heima.test;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import com.heima.jedis.util.JedisConnectionFactory;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.junit.jupiter.api.AfterEach;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.junit.jupiter.api.BeforeEach;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import org.junit.jupiter.api.Test;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import redis.clients.jedis.Jedis;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import redis.clients.jedis.Pipeline;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import redis.clients.jedis.ScanResult;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class JedisTest {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private Jedis jedis;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @BeforeEach</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void setUp() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 1.建立连接</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // jedis = new Jedis(&quot;192.168.150.101&quot;, 6379);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis = JedisConnectionFactory.getJedis();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 2.设置密码</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis.auth(&quot;123321&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 3.选择库</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis.select(0);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testSetBigKey() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (int i = 1; i &lt;= 650; i++) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            map.put(&quot;hello_&quot; + i, &quot;world!&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis.hmset(&quot;m2&quot;, map);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testBigHash() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (int i = 1; i &lt;= 100000; i++) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            map.put(&quot;key_&quot; + i, &quot;value_&quot; + i);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedis.hmset(&quot;test:big:hash&quot;, map);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testBigString() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (int i = 1; i &lt;= 100000; i++) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            jedis.set(&quot;test:str:key_&quot; + i, &quot;value_&quot; + i);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testSmallHash() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        int hashSize = 100;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;(hashSize);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (int i = 1; i &lt;= 100000; i++) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            int k = (i - 1) / hashSize;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            int v = i % hashSize;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            map.put(&quot;key_&quot; + v, &quot;value_&quot; + v);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            if (v == 0) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                jedis.hmset(&quot;test:small:hash_&quot; + k, map);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @AfterEach</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void tearDown() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        if (jedis != null) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            jedis.close();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="14总结">1.4、总结<a href="#14总结" class="hash-link" aria-label="Direct link to 1.4、总结" title="Direct link to 1.4、总结">​</a></h2>
<ul>
<li>Key的最佳实践
<ul>
<li>固定格式：[业务名]:[数据名]:[id]</li>
<li>足够简短：不超过44字节</li>
<li>不包含特殊字符</li>
</ul>
</li>
<li>Value的最佳实践：
<ul>
<li>合理的拆分数据，拒绝BigKey</li>
<li>选择合适数据结构</li>
<li>单个key的value小于10K，Hash结构的entry数量不要超过1000</li>
<li>设置合理的超时时间</li>
</ul>
</li>
</ul>
<h1>2、批处理优化</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21pipeline">2.1、Pipeline<a href="#21pipeline" class="hash-link" aria-label="Direct link to 2.1、Pipeline" title="Direct link to 2.1、Pipeline">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="211我们的客户端与redis服务器是这样交互的">2.1.1、我们的客户端与redis服务器是这样交互的<a href="#211我们的客户端与redis服务器是这样交互的" class="hash-link" aria-label="Direct link to 2.1.1、我们的客户端与redis服务器是这样交互的" title="Direct link to 2.1.1、我们的客户端与redis服务器是这样交互的">​</a></h3>
<p>单个命令的执行流程</p>
<p><img decoding="async" loading="lazy" alt="image-20220521151459880" src="/assets/images/image-20220521151459880-c2dd76ba3cfa01ded6c9b349902b9e54.png" width="980" height="369" class="img_ev3q"></p>
<p>N条命令的执行流程</p>
<p><img decoding="async" loading="lazy" alt="image-20220521151524621" src="/assets/images/image-20220521151524621-397f29d3f0a0b6398b01983614a01731.png" width="970" height="361" class="img_ev3q"></p>
<p>redis处理指令是很快的，<strong>主要花费的时候在于网络  传输</strong>。于是乎很容易想到将多条指令批量的传输给redis</p>
<p><img decoding="async" loading="lazy" alt="image-20220521151902080" src="/assets/images/image-20220521151902080-7c5a321533c88c9d497e4d6188be19cf.png" width="977" height="365" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="212mset">2.1.2、MSet<a href="#212mset" class="hash-link" aria-label="Direct link to 2.1.2、MSet" title="Direct link to 2.1.2、MSet">​</a></h3>
<p>Redis提供了很多Mxxx这样的命令，可以实现批量插入数据，例如：</p>
<ul>
<li>mset</li>
<li>hmset</li>
</ul>
<p>利用mset批量插入10万条数据</p>
<blockquote>
<p>注意：MSet也要分批，因为不要在一次批处理中传输太多命令，否则单次命令占用带宽过多，会导致网络阻塞</p>
<p>并且MSet只适用于String数据类型</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">void testMxx() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    String[] arr = new String[2000];</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    int j;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    long b = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    for (int i = 1; i &lt;= 100000; i++) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        j = (i % 1000) &lt;&lt; 1;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        arr[j] = &quot;test:key_&quot; + i;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        arr[j + 1] = &quot;value_&quot; + i;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        if (j == 0) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            jedis.mset(arr);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    long e = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;time: &quot; + (e - b));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="213pipeline">2.1.3、Pipeline<a href="#213pipeline" class="hash-link" aria-label="Direct link to 2.1.3、Pipeline" title="Direct link to 2.1.3、Pipeline">​</a></h3>
<p>MSET虽然可以批处理，但是却只能操作部分数据类型，因此如果有对复杂数据类型的批处理需要，建议使用Pipeline</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">void testPipeline() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    // 创建管道</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Pipeline pipeline = jedis.pipelined();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    long b = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    for (int i = 1; i &lt;= 100000; i++) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 放入命令到管道</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        pipeline.set(&quot;test:key_&quot; + i, &quot;value_&quot; + i);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        if (i % 1000 == 0) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            // 每放入1000条命令，批量执行</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            pipeline.sync();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    long e = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    System.out.println(&quot;time: &quot; + (e - b));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h3>
<p>批量处理的方案：
①原生的M操作
②Pipeline批处理</p>
<p>注意事项：
①批处理时不建议一次携带太多命令
②Pipeline的多个命令之间<strong>不具备原子性</strong>，而M操作具有原子性</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22集群下的批处理">2.2、集群下的批处理<a href="#22集群下的批处理" class="hash-link" aria-label="Direct link to 2.2、集群下的批处理" title="Direct link to 2.2、集群下的批处理">​</a></h2>
<p>如MSET或Pipeline这样的批处理需要在一次请求中携带多条命令，而此时如果Redis是一个集群， 那<strong>批处理命令的多个key必须落在一个<code>插槽</code>中</strong>，否则就会导致执行失败。大家可以想一想这样的要求其实很难实现，因为我们在批处理时，可能一次要插入很多条数据，这些数据很有可能不会都落在相同的节点上，这就会导致报错了</p>
<p>这个时候，我们可以找到4种解决方案</p>
<p><img decoding="async" loading="lazy" alt="1653126446641" src="/assets/images/1653126446641-c2a2c09ab51d399b39d6787c7e00ccf7.png" width="1470" height="596" class="img_ev3q"></p>
<ul>
<li>**第一种方案：**串行执行，所以这种方式没有什么意义，当然，执行起来就很简单了，缺点就是耗时过久。</li>
<li>**第二种方案：**串行slot，简单来说，就是执行前，客户端先计算一下对应的key的slot，一样slot的key就放到一个组里边，不同的，就放到不同的组里边，然后对每个组执行pipeline的批处理，他就能串行执行各个组的命令，这种做法比第一种方法耗时要少，但是缺点呢，相对来说复杂一点，所以这种方案还需要优化一下</li>
<li>**第三种方案：**并行slot，相较于第二种方案，在分组完成后串行执行，第三种方案，就变成了并行执行各个命令，所以他的耗时就非常短，但是实现呢，也更加复杂。</li>
<li>**第四种方案：**hash_tag，redis计算key的slot的时候，其实是根据key的有效部分来计算的，通过这种方式就能一次处理所有的key，这种方式耗时最短，实现也简单，但是如果通过操作key的有效部分，那么就会导致所有的key都落在一个节点上，产生数据倾斜的问题，所以我们推荐使用第三种方式。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-jedis串行化执行代码实践">2.2.1 Jedis串行化执行代码实践<a href="#221-jedis串行化执行代码实践" class="hash-link" aria-label="Direct link to 2.2.1 Jedis串行化执行代码实  践" title="Direct link to 2.2.1 Jedis串行化执行代码实践">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public class JedisClusterTest {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    private JedisCluster jedisCluster;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @BeforeEach</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void setUp() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        // 配置连接池</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        JedisPoolConfig poolConfig = new JedisPoolConfig();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        poolConfig.setMaxTotal(8);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        poolConfig.setMaxIdle(8);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        poolConfig.setMinIdle(0);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        poolConfig.setMaxWaitMillis(1000);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        HashSet&lt;HostAndPort&gt; nodes = new HashSet&lt;&gt;();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        nodes.add(new HostAndPort(&quot;192.168.150.101&quot;, 7001));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        nodes.add(new HostAndPort(&quot;192.168.150.101&quot;, 7002));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        nodes.add(new HostAndPort(&quot;192.168.150.101&quot;, 7003));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        nodes.add(new HostAndPort(&quot;192.168.150.101&quot;, 8001));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        nodes.add(new HostAndPort(&quot;192.168.150.101&quot;, 8002));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        nodes.add(new HostAndPort(&quot;192.168.150.101&quot;, 8003));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedisCluster = new JedisCluster(nodes, poolConfig);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testMSet() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        jedisCluster.mset(&quot;name&quot;, &quot;Jack&quot;, &quot;age&quot;, &quot;21&quot;, &quot;sex&quot;, &quot;male&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testMSet2() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;(3);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        map.put(&quot;name&quot;, &quot;Jack&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        map.put(&quot;age&quot;, &quot;21&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        map.put(&quot;sex&quot;, &quot;Male&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        //对Map数据进行分组。根据相同的slot放在一个分组</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        //key就是slot，value就是一个组</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        Map&lt;Integer, List&lt;Map.Entry&lt;String, String&gt;&gt;&gt; result = map.entrySet()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .stream()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                .collect(Collectors.groupingBy(</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        entry -&gt; ClusterSlotHashUtil.calculateSlot(entry.getKey()))</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                );</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        //串行的去执行mset的逻辑</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        for (List&lt;Map.Entry&lt;String, String&gt;&gt; list : result.values()) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            String[] arr = new String[list.size() * 2];</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            int j = 0;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            for (int i = 0; i &lt; list.size(); i++) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                j = i&lt;&lt;2;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                Map.Entry&lt;String, String&gt; e = list.get(0);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                arr[j] = e.getKey();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                arr[j + 1] = e.getValue();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            jedisCluster.mset(arr);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    @AfterEach</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void tearDown() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        if (jedisCluster != null) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            jedisCluster.close();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-spring集群环境下批处理代码推荐">2.2.2 Spring集群环境下批处理代码（推荐）<a href="#222-spring集群环境下批处理代码推荐" class="hash-link" aria-label="Direct link to 2.2.2 Spring集群环境下批处理代码（推荐）" title="Direct link to 2.2.2 Spring集群环境下批处理代码（推荐）">​</a></h3>
<blockquote>
<p>Spring已经帮我们集成了 <strong>并行Slot</strong> 的处理方式，可以直接使用，推荐使用Spring的框架来处理集群批处理任务</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   @Test</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    void testMSetInCluster() {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;(3);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        map.put(&quot;name&quot;, &quot;Rose&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        map.put(&quot;age&quot;, &quot;21&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        map.put(&quot;sex&quot;, &quot;Female&quot;);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        stringRedisTemplate.opsForValue().multiSet(map);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        List&lt;String&gt; strings = stringRedisTemplate.opsForValue().multiGet(Arrays.asList(&quot;name&quot;, &quot;age&quot;, &quot;sex&quot;));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        strings.forEach(System.out::println);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原理分析</strong></p>
<p>在RedisAdvancedClusterAsyncCommandsImpl 类中</p>
<p>首先根据slotHash算出来一个partitioned的map，map中的key就是slot，而他的value就是对应的对应相同slot的key对应的数据</p>
<p>通过 RedisFuture<string> mset = super.mset(op)；进行异步的消息发送</string></p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">public RedisFuture&lt;String&gt; mset(Map&lt;K, V&gt; map) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Map&lt;Integer, List&lt;K&gt;&gt; partitioned = SlotHash.partition(codec, map.keySet());</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    if (partitioned.size() &lt; 2) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        return super.mset(map);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    Map&lt;Integer, RedisFuture&lt;String&gt;&gt; executions = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    for (Map.Entry&lt;Integer, List&lt;K&gt;&gt; entry : partitioned.entrySet()) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        Map&lt;K, V&gt; op = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        entry.getValue().forEach(k -&gt; op.put(k, map.get(k)));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        RedisFuture&lt;String&gt; mset = super.mset(op);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        executions.put(entry.getKey(), mset);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    return MultiNodeExecution.firstOfAsync(executions);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="23redis事务">2.3、Redis事务<a href="#23redis事务" class="hash-link" aria-label="Direct link to 2.3、Redis事务" title="Direct link to 2.3、Redis事务">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="231-redis事务的含义和与mysql事务的对比">2.3.1 Redis事务的含义和与MySQL事务的对比<a href="#231-redis事务的含义和与mysql事务的对比" class="hash-link" aria-label="Direct link to 2.3.1 Redis事务的含义和与MySQL事务的对比" title="Direct link to 2.3.1 Redis事务的含义和与MySQL事务的对比">​</a></h3>
<p><strong>数据库事务</strong>：在 一次跟数据库的连接会话当中，所有执行的SQL，要么一起成功，要么一起失败</p>
<p><strong>原子性</strong>：一个事务中的所有操作要么全部成功，要么全部失败回滚，不能只执行其中的一部分操作</p>
<p><strong>Redis事务</strong>：可以一次执行多个命令，本质是<strong>一组命令的集合</strong>。一个事务中的所有命令都会序列化，按顺序地串行化执行而<strong>不会被其它命令插入，不许加塞</strong>，即一个队列中，一次性、顺序性、排他性的执行一系列命令</p>
<p>Redis事务与MySQL事务的<strong>区别</strong>：</p>
<p><img decoding="async" loading="lazy" alt="image-20231027222704537" src="/assets/images/image-20231027222704537-88adce82b0d5529d4068f03e54a5d89c.png" width="1423" height="263" class="img_ev3q"></p>
<blockquote>
<ol>
<li>单独的隔离操作：Redis的事务只是能够<strong>保证一组命令能够连续独占的执行</strong>，因为Redis是单线程架构，所以执行完事务内的所有命令前不能去执行其它请求</li>
<li>没有隔离级别的概念：<strong>事务提交前任何命令都不会被实际执行</strong>，所以不会存在并发安全问题</li>
<li>不保证原子性：若开始执行事务内的所有命令，若其中有命令执行失败，<strong>不提供回滚机制</strong></li>
<li>排他性：Redis会<strong>保证一个事务内的命令依次执行，而不会被其它命令插入</strong></li>
</ol>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="232-redis事务的使用和细节">2.3.2 Redis事务的使用和细节<a href="#232-redis事务的使用和细节" class="hash-link" aria-label="Direct link to 2.3.2 Redis事务的使用和细节" title="Direct link to 2.3.2 Redis事务的使用和细节">​</a></h3>
<p>Redis事务相关的命令：</p>
<ol>
<li>MULTI：标志着一个事务的开始</li>
<li>EXEC：执行事务内的所有命令</li>
<li>DISCARD：取消事务，放弃执行事务内的所有命令</li>
<li>WATCH key [key ...]：监视一个或多个key，如果在事务执行之前这个（或这些）key被其他命令所改动，那么事务将被打断。</li>
<li>UNWATCH：取消WATCH命令对所有key的监控</li>
</ol>
<p>Redis事务的使用：</p>
<ul>
<li>
<p>正常执行：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">MULTI</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">EXEC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>放弃执行：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">MULTI</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">DISCARD</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>全体连坐（语法编译错误，该组命令全部被舍弃）：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">MULTi</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">set k3 	#故意写错语法</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">EXEC</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"># 虽然只有一条语句语法错误，可是所有的命令都不被执行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>冤头债主（语法没错，编译时没检查出错误，对的命令执行，不对的不执行）</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">MULTI</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">set email &quot;spongehah@163.com&quot;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">INCR email  	#对字符串做自增操作，编译不会出错，但运行会出错</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">EXEC</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"># 语法没错，编译时没检查出错误，对的命令执行，不对的不执行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="233-redis开启watch监控乐观锁的使用">2.3.3 Redis开启Watch监控（乐观锁的使用）<a href="#233-redis开启watch监控乐观锁的使用" class="hash-link" aria-label="Direct link to 2.3.3 Redis开启Watch监控（乐观锁的使用）" title="Direct link to 2.3.3 Redis开启Watch监控（乐观锁的使用）">​</a></h3>
<p>Redis Watch机制采用<strong>乐观锁</strong>，watch key时<strong>不会上锁</strong>，但<strong>提交时的版本必须大于当前版本才能执行</strong></p>
<p>当一个会话监听了某个key，然后使用MULTI开启事务后，要对该key进行操作，但是还未使用EXEC进行执行，此时<strong>另一个会话</strong>若是<strong>修改了这个被监控的key</strong>，那么前一个会话执行EXEC时<strong>所有命令将会不被执行</strong></p>
<p><img decoding="async" loading="lazy" alt="image-20231027224800985" src="/assets/images/image-20231027224800985-eaf358f2acd6fffe076c7f0714253d68.png" width="1412" height="687" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="234-pipeline与原生批处理命令redis事务的对比">2.3.4 Pipeline与原生批处理命令、Redis事务的对比<a href="#234-pipeline  与原生批处理命令redis事务的对比" class="hash-link" aria-label="Direct link to 2.3.4 Pipeline与原生批处理命令、Redis事务的对比" title="Direct link to 2.3.4 Pipeline与原生批处理命令、Redis事务的对比">​</a></h3>
<ul>
<li>pipeline与原生批处理命令对比：
<ul>
<li><strong>原生批量命令是原子性</strong>（例如：mset,mget),<strong>pipeline是非原子性</strong></li>
<li>原生批量命令一次<strong>只能执行一种命令</strong>，pipeline支持批量执行<strong>不同命令</strong></li>
<li>原生批命令是<strong>服务端实现</strong>，而pipeline需要<strong>服务端与客户端共同完成</strong></li>
</ul>
</li>
<li>pipeline与事务对比：
<ul>
<li>事务具有排他性，管道不具有排他性</li>
<li>管道一次性将多条命令发送到服务器，事务是一条一条的发，只有在接收到exec命令后才会执行，<strong>管道</strong>不执行事务时<strong>会被其它命令插入、加塞</strong>，而<strong>Redis事务</strong>中的所有命令<strong>开始执行后不会被插入、加塞</strong></li>
</ul>
</li>
</ul>
<h1>3、服务器端优化-持久化配置</h1>
<p><strong>持久化配置：</strong></p>
<p>Redis的持久化虽然可以保证数据安全，但也会带来很多额外的开销，因此持久化请遵循下列建议：</p>
<ul>
<li>用来做<strong>缓存</strong>的Redis实例尽量<strong>不要开启</strong>持久化功能</li>
<li>建议<strong>关闭RDB</strong>持久化功能，<strong>使用AOF</strong>持久化</li>
<li>利用<strong>脚本定期在slave节点做RDB</strong>，实现数据备份</li>
<li>设置合理的rewrite阈值，<strong>避免频繁的bgrewrite</strong></li>
<li>配置no-appendfsync-on-rewrite = yes，<strong>禁止在rewrite期间做aof</strong>，避免因AOF引起的阻塞</li>
</ul>
<p><strong>部署有关建议：</strong></p>
<ul>
<li>Redis实例的物理机要预留足够内存，应对fork和rewrite</li>
<li>单个Redis实例内存上限不 要太大，例如4G或8G。可以加快fork的速度、减少主从同步、数据迁移压力</li>
<li>不要与CPU密集型应用部署在一起</li>
<li>不要与高硬盘负载应用一起部署。例如：数据库、消息队列</li>
</ul>
<h1>4、服务器端优化-慢查询优化</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="41-什么是慢查询">4.1 什么是慢查询<a href="#41-什么是慢查询" class="hash-link" aria-label="Direct link to 4.1 什么是慢查询" title="Direct link to 4.1 什么是慢查询">​</a></h2>
<p>并不是很慢的查询才是慢查询，而是：在Redis执行时耗时超过某个阈值的命令，称为慢查询。</p>
<p>慢查询的危害：由于Redis是单线程的，所以当客户端发出指令后，他们都会进入到redis底层的queue来执行，如果此时有一些慢查询的数据，就会导致大量请求阻塞，从而引起报错，所以我们需要解决慢查询问题。</p>
<p><img decoding="async" loading="lazy" alt="1653129590210" src="/assets/images/1653129590210-91e4b93c9837b249bbae956d77395d2c.png" width="1252" height="430" class="img_ev3q"></p>
<ul>
<li>
<p><strong>慢查询的阈值</strong>可以通过配置指定：</p>
<ul>
<li><strong>slowlog-log-slower-than</strong>：慢查询阈值，单位是微秒。<strong>默认是10000，建议1000</strong></li>
</ul>
</li>
<li>
<p>慢查询会被放入<strong>慢查询日志</strong>中，日志的<strong>长度</strong>有上限，可以通过配置指定：</p>
<ul>
<li><strong>slowlog-max-len</strong>：慢查询日志（本质是一个队列）的长度。<strong>默认是128，建议1000</strong></li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="1653130457771" src="/assets/images/1653130457771-b49534631ec8a7a7b1eb99031097d902.png" width="863" height="216" class="img_ev3q"></p>
<p>修改这两个配置可以使用：config set命令：</p>
<p><img decoding="async" loading="lazy" alt="1653130475979" src="/assets/images/1653130475979-7148433c05858fa39146d3273ab53cd8.png" width="934" height="189" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="42-如何查看慢查询">4.2 如何查看慢查询<a href="#42-如何查看慢查询" class="hash-link" aria-label="Direct link to 4.2 如何查看慢查询" title="Direct link to 4.2 如何查看慢查询">​</a></h2>
<p>知道了以上内容之后，那么咱们如何去查看慢查询日志列表呢：</p>
<ul>
<li><strong>slowlog len</strong>：查询慢查询日志长度</li>
<li><strong>slowlog get [n]</strong>：读取n条慢查询日志</li>
<li><strong>slowlog reset</strong>：清空慢查询列表</li>
</ul>
<p><img decoding="async" loading="lazy" alt="1653130858066" src="/assets/images/1653130858066-61f7eb3f1eb6cfd63cf3e2ab620c9d65.png" width="938" height="287" class="img_ev3q"></p>
<h1>5、服务器端优化-命令及安全配置</h1>
<p>安全可以说是服务器端一个非常重要的话题，如果安全出现了问题，那么一旦这个漏洞被一些坏人知道了之后，并且进行攻击，那么这就会给咱们的系统带来很多的损失，所以我们这节课就来解决这个问题。</p>
<p>Redis会绑定在0.0.0.0:6379，这样将会将Redis服务暴露到公网上，而Redis如果没有做身份认证，会出现严重的安全漏洞.
漏洞重现方式：<a href="https://cloud.tencent.com/developer/article/1039000" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1039000</a></p>
<p>为什么会出现不需要密码也能够登录呢，主要是Redis考虑到每次登录都比较麻烦，所以Redis就有一种ssh免秘钥登录的方式，生成一对公钥和私钥，私钥放在本地，公钥放在redis端，当我们登录时服务器，再登录时候，他会去解析公钥和私钥，如果没有问题，则不需要利用redis的登录也能访问，这种做法本身也很常见，但是这里有一个前提，前提就是公钥必须保存在服务器上，才行，但是Redis的漏洞在于在不登录的情况下， 也能把秘钥送到Linux服务器，从而产生漏洞</p>
<p>漏洞出现的核心的原因有以下几点：</p>
<ul>
<li>Redis未设置密码</li>
<li>利用了Redis的config set命令动态修改Redis配置</li>
<li>使用了Root账号权限启动Redis</li>
</ul>
<p>所以：如何解决呢？我们可以采用如下几种方案</p>
<p>为了避免这样的漏洞，这里给出一些<strong>建议</strong>：</p>
<ul>
<li>Redis一定要设置密码</li>
<li>禁止线上使用下面命令：keys、flushall、flushdb、config set等命令。可以利用rename-command禁用。</li>
<li>bind：限制网卡，禁止外网网卡访问</li>
<li>开启防火墙</li>
<li>不要使用Root账户启动Redis</li>
<li>尽量不是有默认的端口</li>
</ul>
<h1>6、服务器端优化-Redis内存划分和内存配置</h1>
<p>当Redis内存不足时，可能导致Key频繁被删除、响应时间变长、QPS不稳定等问题。当内存使用率达到90%以上时就需要我们警惕，并快速定位到内存占用的原因。</p>
<p><strong>有关碎片问题分析</strong></p>
<p>Redis底层分配并不是这个key有多大，他就会分配多大，而是有他自己的分配策略，比如8,16,20等等，假定当前key只需要10个字节，此时分配8肯定不够，那么他就会分配16个字节，多出来的6个字节就不能被使用，这就是我们常说的 碎片问题</p>
<p><strong>进程内存问题分析：</strong></p>
<p>这片内存，通常我们都可以忽略不计</p>
<p><strong>缓冲区内存问题分析：</strong></p>
<p>一般包括客户端缓冲区、AOF缓冲区、复制缓冲区等。客户端缓冲区又包括输入缓冲区和输出缓冲区两种。这部分内存占用波动较大，所以这片内存也是我们需要重点分析的内存问题。</p>





















<table><thead><tr><th><strong>内存占用</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>数据内存</td><td>是Redis最主要的部分，存储Redis的键值信息。主要问题 是<strong>BigKey</strong>问题、内存碎片问题</td></tr><tr><td>进程内存</td><td>Redis主进程本身运⾏肯定需要占⽤内存，如代码、常量池等等；这部分内存⼤约⼏兆，在⼤多数⽣产环境中与Redis数据占⽤的内存相⽐可以忽略。</td></tr><tr><td>缓冲区内存</td><td>一般包括**<code>客户端缓冲区</code>、AOF缓冲区、复制缓冲区**等。客户端缓冲区又包括输入缓冲区和输出缓冲区两种。这部分内存占用波动较大，不当使用BigKey，可能导致内存溢出。</td></tr></tbody></table>
<blockquote>
<p>综上所述：当内存使用率过高时，应当考虑 <strong>数据内存</strong> 和 <strong>缓冲区内存</strong> 两部分</p>
</blockquote>
<p>于是我们就需要通过一些命令，可以查看到Redis目前的内存分配状态：</p>
<ul>
<li><strong>info memory</strong>：查看内存分配的情况</li>
</ul>
<p><img decoding="async" loading="lazy" alt="1653132073570" src="/assets/images/1653132073570-13e8d1750463f4a910b2dc55d69adbda.png" width="566" height="555" class="img_ev3q"></p>
<ul>
<li><strong>memory xxx</strong>：查看key的主要占用情况
<ul>
<li>memory usage key：查看某个key的内存占用情况</li>
<li>memory stats：查看统一的内存占用情况</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="1653132098823" src="/assets/images/1653132098823-1b1dc24d2888ea48fedaa330015583fd.png" width="536" height="559" class="img_ev3q"></p>
<p>接下来我们看到了这些配置，最关键的缓存区内存如何定位和解决呢？</p>
<p>内存缓冲区常见的有三种：</p>
<ul>
<li><strong>复制缓冲区</strong>：主从复制的repl_backlog_buf，如果太小可能导致频繁的全量复制，影响性能。通过<strong>repl-backlog-size</strong>来设置，<strong>默认1mb</strong></li>
<li><strong>AOF缓冲区</strong>：AOF刷盘之前的缓存区域，AOF执行rewrite的缓冲区。无法设置容量上限</li>
<li><strong>客户端缓冲区</strong>：分为输入缓冲区和输出缓冲区，输入缓冲区最大1G且不能设置。输出缓冲区可以设置</li>
</ul>
<p>以上复制缓冲区和AOF缓冲区 不会有问题，<strong>最关键就是客户端缓冲区</strong>的问题</p>
<p>客户端缓冲区：指的就是我们发送命令时，客户端用来缓存命令的一个缓冲区，也就是我们向redis输入数据的输入端缓冲区和redis向客户端返回数据的响应缓存区，输入缓冲区最大1G且不能设置，所以这一块我们根本不用担心，如果超过了这个空间，redis会直接断开，因为本来此时此刻就代表着redis处理不过来了，我们需要担心的就是输出端缓冲区</p>
<p><img decoding="async" loading="lazy" alt="1653132410073" src="/assets/images/1653132410073-b2cd8089e7a2fc1143b099954efbcbcc.png" width="944" height="273" class="img_ev3q"></p>
<p>我们在使用redis过程中，处理大量的big value，那么会导致我们的输出结果过多，如果输出缓存区过大，会导致redis直接断开，而默认配置的情况下， 其实他是没有大小的，这就比较坑了，内存可能一下子被占满，会直接导致咱们的redis断开，所以解决方案有两个</p>
<p>1、设置一个大小</p>
<p>2、增加我们带宽的大小，避免我们出现大量数据从而直接超过了redis的承受能力</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-redis内存碎片问题">6.1 Redis内存碎片问题<a href="#61-redis内存碎片问题" class="hash-link" aria-label="Direct link to 6.1 Redis内存碎片问题" title="Direct link to 6.1 Redis内存碎片问题">​</a></h3>
<ol>
<li>
<p>Redis为什么会有内存碎片？</p>
<ul>
<li>Redis 存储数据的时候向操作系统申请的内存空间可能会大于数据实际需要的存储空间。比如SDS分配时使用jmalloc分配2的幂次方</li>
<li>频繁修改 Redis 中的数据也会产生内存碎片。</li>
<li>（操作系统分配的内存少于128K时使用brk()函数，回收  后会放入内存池）</li>
</ul>
</li>
<li>
<p>如何查看 Redis 内存碎片的信息？</p>
<ul>
<li>info memory</li>
</ul>
</li>
<li>
<p>如何清理 Redis 内存碎片？</p>
<ul>
<li>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">config set activedefrag yes</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"># 内存碎片占用空间达到 500mb 的时候开始清理</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">config set active-defrag-ignore-bytes 500mb</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"># 内存碎片率大于 1.5 的时候开始清理</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">config set active-defrag-threshold-lower 50</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"># 内存碎片清理所占用 CPU 时间的比例不低于 20%</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">config set active-defrag-cycle-min 20</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"># 内存碎片清理所占用 CPU 时间的比例不高于 50%</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">config set active-defrag-cycle-max 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
</ol>
<h1>7、服务器端集群优化-集群还是主从</h1>
<p>集群虽然具备高可用特性，能实现自动故障恢复，但是如果使用不当，也会存在一些问题：</p>
<ul>
<li>集群完整性问题</li>
<li>集群带宽问题</li>
<li>数据倾斜问题</li>
<li>客户端性能问题</li>
<li>命令的集群兼容性问题</li>
<li>lua和事务问题</li>
</ul>
<p><strong>问题1、在Redis的默认配置中，如果发现任意一个插槽不可用，则整个集群都会停止对外服务：</strong></p>
<p>大家可以设想一下，如果有几个slot不能使用，那么此时整个集群都不能用了，我们在开发中，其实最重要的是可用性，所以需要把如下配置修改成no，即有slot不能使用时，我们的redis集群还是可以对外提供服务</p>
<p><img decoding="async" loading="lazy" alt="1653132740637" src="/assets/images/1653132740637-e4bc7e88760c39b2365dce6ec216ba10.png" width="1293" height="448" class="img_ev3q"></p>
<p><strong>问题2、集群带宽问题</strong></p>
<p>集群节点之间会不断的互相Ping来确定集群中其它节点的状态。每次Ping携带的信息至少包括：</p>
<ul>
<li>插槽信息</li>
<li>集群状态信息</li>
</ul>
<p>集群中节点越多，集群状态信息数据量也越大，10个节点的相关信息可能达到1kb，此时每次集群互通需要的带宽会非常高，这样会导致集群中大量的带宽都会被ping信息所占用，这是一个非常可怕的问题，所以我们需要去解决这样的问题</p>
<p><strong>解决途径：</strong></p>
<ul>
<li>避免大集群，集群节点数不要太多，最好少于1000，如果业务庞大，则建立多个集群。</li>
<li>避免在单个物理机中运行太多Redis实例</li>
<li>配置合适的cluster-node-timeout值</li>
</ul>
<p><strong>问题3、命令的集群兼容性问题</strong></p>
<p>有关这个问题咱们已经探讨过了，当我们使用批处理的命令时，redis要求我们的key必须落在相同的slot上，然后大量的key同时操作时，是无法完成的，所以客户端必须要对这样的数据进行处理，这些方案我们之前已经探讨过了，所以不再这个地方赘述了。</p>
<p><strong>问题4、lua和事务的问题</strong></p>
<p>lua和事务都是要保证原子性问题，如果你的key不在一个节点，那么是无法保证lua的执行和事务的特性的，所以在集群模式是没有办法执行lua和事务的</p>
<p><strong>那我们到底是集群还是主从</strong></p>
<p>单体Redis（主从Redis）已经能达到万级别的QPS，并且也具备很强的高可用特性。如果主从能满足业务需求的情况下，所以如果不是在万不得已的情况下，尽量不搭建Redis集群</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#11优雅的key结构" class="table-of-contents__link toc-highlight">1.1、优雅的key结构</a></li><li><a href="#12拒绝bigkey" class="table-of-contents__link toc-highlight">1.2、拒绝BigKey</a><ul><li><a href="#121bigkey的危害" class="table-of-contents__link toc-highlight">1.2.1  、BigKey的危害</a></li><li><a href="#122如何发现bigkey" class="table-of-contents__link toc-highlight">1.2.2、如何发现BigKey</a></li><li><a href="#123如何删除bigkey" class="table-of-contents__link toc-highlight">1.2.3、如何删除BigKey</a></li></ul></li><li><a href="#13恰当的数据类型" class="table-of-contents__link toc-highlight">1.3、恰当的数据类型</a><ul><li><a href="#例1比如存储一个user对象我们有三种存储方式" class="table-of-contents__link toc-highlight">例1：比如存储一个User对象，我们有三种存储方式：</a></li><li><a href="#例2假如有hash类型的key其中有100万对field和valuefield是自增id这个key存在什么问题如何优化" class="table-of-contents__link toc-highlight">例2：假如有hash类型的key，其中有100万对field和value，field是自增id，这个key存在什么问题？如何优化？</a></li></ul></li><li><a href="#14总结" class="table-of-contents__link toc-highlight">1.4、总结</a></li><li><a href="#21pipeline" class="table-of-contents__link toc-highlight">2.1、Pipeline</a><ul><li><a href="#211我们的客户端与redis服务器是这样交互的" class="table-of-contents__link toc-highlight">2.1.1、我们的客户端与redis服务器是这样交互的</a></li><li><a href="#212mset" class="table-of-contents__link toc-highlight">2.1.2、MSet</a></li><li><a href="#213pipeline" class="table-of-contents__link toc-highlight">2.1.3、Pipeline</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></li><li><a href="#22集群下的批处理" class="table-of-contents__link toc-highlight">2.2、集群下的批处理</a><ul><li><a href="#221-jedis串行化执行代码实践" class="table-of-contents__link toc-highlight">2.2.1 Jedis串行化执行代码实践</a></li><li><a href="#222-spring集群环境下批处理代码推荐" class="table-of-contents__link toc-highlight">2.2.2 Spring集群环境下批处理代码（推荐）</a></li></ul></li><li><a href="#23redis事务" class="table-of-contents__link toc-highlight">2.3、Redis事务</a><ul><li><a href="#231-redis事务的含义和与mysql事务的对比" class="table-of-contents__link toc-highlight">2.3.1 Redis事务的含义和与MySQL事务的对比</a></li><li><a href="#232-redis事务的使用和细节" class="table-of-contents__link toc-highlight">2.3.2 Redis事务的使用和细节</a></li><li><a href="#233-redis开启watch监控乐观锁的使用" class="table-of-contents__link toc-highlight">2.3.3 Redis开启Watch监控（乐观锁的使用）</a></li><li><a href="#234-pipeline与原生批处理命令redis事务的对比" class="table-of-contents__link toc-highlight">2.3.4 Pipeline与原生批处理命令、Redis事务的对比</a></li></ul></li><li><a href="#41-什么是慢查询" class="table-of-contents__link toc-highlight">4.1 什么是慢查询</a></li><li><a href="#42-如何查看慢查询" class="table-of-contents__link toc-highlight">4.2 如何查看慢查询</a><ul><li><a href="#61-redis内存碎片问题" class="table-of-contents__link toc-highlight">6.1 Redis内存碎片问题</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>