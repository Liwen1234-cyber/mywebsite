"use strict";(self.webpackChunkmybase=self.webpackChunkmybase||[]).push([[15952],{52088:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"\u7801\u519c/JavaNote/Frame","title":"Maven","description":"\u57fa\u672c\u4ecb\u7ecd","source":"@site/docs/\u7801\u519c/JavaNote/Frame.md","sourceDirName":"\u7801\u519c/JavaNote","slug":"/\u7801\u519c/JavaNote/Frame","permalink":"/\u7801\u519c/JavaNote/Frame","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{}}');var l=s(74848),i=s(28453);const c={},d="Maven",t={},a=[{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd",level:2},{value:"Mvn\u4ecb\u7ecd",id:"mvn\u4ecb\u7ecd",level:3},{value:"\u57fa\u7840\u6982\u5ff5",id:"\u57fa\u7840\u6982\u5ff5",level:3},{value:"\u73af\u5883\u642d\u5efa",id:"\u73af\u5883\u642d\u5efa",level:2},{value:"\u73af\u5883\u914d\u7f6e",id:"\u73af\u5883\u914d\u7f6e",level:3},{value:"\u4ed3\u5e93\u914d\u7f6e",id:"\u4ed3\u5e93\u914d\u7f6e",level:3},{value:"\u9879\u76ee\u642d\u5efa",id:"\u9879\u76ee\u642d\u5efa",level:2},{value:"\u624b\u52a8\u642d\u5efa",id:"\u624b\u52a8\u642d\u5efa",level:3},{value:"IDEA\u642d\u5efa",id:"idea\u642d\u5efa",level:3},{value:"\u4e0d\u7528\u539f\u578b",id:"\u4e0d\u7528\u539f\u578b",level:4},{value:"\u4f7f\u7528\u539f\u578b",id:"\u4f7f\u7528\u539f\u578b",level:4},{value:"\u4f9d\u8d56\u7ba1\u7406",id:"\u4f9d\u8d56\u7ba1\u7406",level:2},{value:"\u4f9d\u8d56\u914d\u7f6e",id:"\u4f9d\u8d56\u914d\u7f6e",level:3},{value:"\u4f9d\u8d56\u4f20\u9012",id:"\u4f9d\u8d56\u4f20\u9012",level:3},{value:"\u4f9d\u8d56\u8303\u56f4",id:"\u4f9d\u8d56\u8303\u56f4",level:3},{value:"\u751f\u547d\u5468\u671f",id:"\u751f\u547d\u5468\u671f",level:2},{value:"\u76f8\u5173\u4e8b\u4ef6",id:"\u76f8\u5173\u4e8b\u4ef6",level:3},{value:"\u6267\u884c\u4e8b\u4ef6",id:"\u6267\u884c\u4e8b\u4ef6",level:3},{value:"\u6a21\u5757\u5f00\u53d1",id:"\u6a21\u5757\u5f00\u53d1",level:2},{value:"\u62c6\u5206",id:"\u62c6\u5206",level:3},{value:"\u805a\u5408",id:"\u805a\u5408",level:3},{value:"\u7ee7\u627f",id:"\u7ee7\u627f",level:3},{value:"\u5c5e\u6027",id:"\u5c5e\u6027",level:3},{value:"\u5de5\u7a0b\u7248\u672c",id:"\u5de5\u7a0b\u7248\u672c",level:3},{value:"\u8d44\u6e90\u914d\u7f6e",id:"\u8d44\u6e90\u914d\u7f6e",level:3},{value:"\u591a\u73af\u5883\u914d\u7f6e",id:"\u591a\u73af\u5883\u914d\u7f6e",level:3},{value:"\u8df3\u8fc7\u6d4b\u8bd5",id:"\u8df3\u8fc7\u6d4b\u8bd5",level:2},{value:"\u79c1\u670d",id:"\u79c1\u670d",level:2},{value:"Nexus",id:"nexus",level:3},{value:"\u8d44\u6e90\u64cd\u4f5c",id:"\u8d44\u6e90\u64cd\u4f5c",level:3},{value:"IDEA\u64cd\u4f5c",id:"idea\u64cd\u4f5c",level:3},{value:"\u4e0a\u4f20\u4e0b\u8f7d",id:"\u4e0a\u4f20\u4e0b\u8f7d",level:4},{value:"\u8bbf\u95ee\u79c1\u670d",id:"\u8bbf\u95ee\u79c1\u670d",level:4},{value:"\u672c\u5730\u8bbf\u95ee",id:"\u672c\u5730\u8bbf\u95ee",level:5},{value:"\u5de5\u7a0b\u8bbf\u95ee",id:"\u5de5\u7a0b\u8bbf\u95ee",level:5},{value:"\u65e5\u5fd7",id:"\u65e5\u5fd7",level:2},{value:"Log4j",id:"log4j",level:3},{value:"\u914d\u7f6e\u6587\u4ef6",id:"\u914d\u7f6e\u6587\u4ef6",level:3},{value:"\u65e5\u5fd7\u5e94\u7528",id:"\u65e5\u5fd7\u5e94\u7528",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-1",level:2},{value:"\u7ebf\u7a0b\u6a21\u578b",id:"\u7ebf\u7a0b\u6a21\u578b",level:2},{value:"\u963b\u585e\u6a21\u578b",id:"\u963b\u585e\u6a21\u578b",level:3},{value:"Reactor",id:"reactor",level:3},{value:"\u8bbe\u8ba1\u601d\u60f3",id:"\u8bbe\u8ba1\u601d\u60f3",level:4},{value:"\u5355R\u5355\u7ebf\u7a0b",id:"\u5355r\u5355\u7ebf\u7a0b",level:4},{value:"\u5355R\u591a\u7ebf\u7a0b",id:"\u5355r\u591a\u7ebf\u7a0b",level:4},{value:"\u4e3b\u4ece\u6a21\u578b",id:"\u4e3b\u4ece\u6a21\u578b",level:4},{value:"Proactor",id:"proactor",level:3},{value:"Netty",id:"netty-1",level:3},{value:"\u57fa\u672c\u5b9e\u73b0",id:"\u57fa\u672c\u5b9e\u73b0",level:2},{value:"\u7ec4\u4ef6\u4ecb\u7ecd",id:"\u7ec4\u4ef6\u4ecb\u7ecd",level:2},{value:"EventLoop",id:"eventloop",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-2",level:4},{value:"\u4efb\u52a1\u4f20\u9012",id:"\u4efb\u52a1\u4f20\u9012",level:4},{value:"Channel",id:"channel",level:3},{value:"\u8fde\u63a5\u64cd\u4f5c",id:"\u8fde\u63a5\u64cd\u4f5c",level:4},{value:"\u5173\u95ed\u64cd\u4f5c",id:"\u5173\u95ed\u64cd\u4f5c",level:4},{value:"Future",id:"future",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-3",level:4},{value:"\u6269\u5c55\u5b50\u7c7b",id:"\u6269\u5c55\u5b50\u7c7b",level:4},{value:"Pipeline",id:"pipeline",level:3},{value:"ByteBuf",id:"bytebuf",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-4",level:4},{value:"\u521b\u5efa\u65b9\u6cd5",id:"\u521b\u5efa\u65b9\u6cd5",level:4},{value:"\u8bfb\u5199\u64cd\u4f5c",id:"\u8bfb\u5199\u64cd\u4f5c",level:4},{value:"\u5185\u5b58\u91ca\u653e",id:"\u5185\u5b58\u91ca\u653e",level:4},{value:"\u62f7\u8d1d\u64cd\u4f5c",id:"\u62f7\u8d1d\u64cd\u4f5c",level:4},{value:"\u7c98\u5305\u534a\u5305",id:"\u7c98\u5305\u534a\u5305",level:2},{value:"\u73b0\u8c61\u6f14\u793a",id:"\u73b0\u8c61\u6f14\u793a",level:3},{value:"\u89e3\u51b3\u65b9\u6848",id:"\u89e3\u51b3\u65b9\u6848",level:3},{value:"\u77ed\u8fde\u63a5",id:"\u77ed\u8fde\u63a5",level:4},{value:"\u56fa\u5b9a\u957f\u5ea6",id:"\u56fa\u5b9a\u957f\u5ea6",level:4},{value:"\u5206\u9694\u7b26",id:"\u5206\u9694\u7b26",level:4},{value:"\u9884\u8bbe\u957f\u5ea6",id:"\u9884\u8bbe\u957f\u5ea6",level:4},{value:"\u534f\u8bae\u8bbe\u8ba1",id:"\u534f\u8bae\u8bbe\u8ba1",level:3},{value:"HTTP",id:"http",level:4},{value:"\u81ea\u5b9a\u4e49",id:"\u81ea\u5b9a\u4e49",level:4},{value:"Sharable",id:"sharable",level:4},{value:"\u573a\u666f\u4f18\u5316",id:"\u573a\u666f\u4f18\u5316",level:2},{value:"\u7a7a\u95f2\u68c0\u6d4b",id:"\u7a7a\u95f2\u68c0\u6d4b",level:3},{value:"\u8fde\u63a5\u5047\u6b7b",id:"\u8fde\u63a5\u5047\u6b7b",level:4},{value:"\u5fc3\u8df3\u673a\u5236",id:"\u5fc3\u8df3\u673a\u5236",level:4},{value:"\u5e8f\u5217\u5316",id:"\u5e8f\u5217\u5316",level:3},{value:"\u666e\u901a\u65b9\u5f0f",id:"\u666e\u901a\u65b9\u5f0f",level:4},{value:"ProtoBuf",id:"protobuf",level:4},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-5",level:5},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0",level:5},{value:"\u957f\u8fde\u63a5",id:"\u957f\u8fde\u63a5",level:3},{value:"\u53c2\u6570\u8c03\u4f18",id:"\u53c2\u6570\u8c03\u4f18",level:3},{value:"CONNECT",id:"connect",level:4},{value:"SO_BACKLOG",id:"so_backlog",level:4},{value:"\u5176\u4ed6\u53c2\u6570",id:"\u5176\u4ed6\u53c2\u6570",level:4},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-6",level:2},{value:"\u6d88\u606f\u961f\u5217",id:"\u6d88\u606f\u961f\u5217",level:3},{value:"\u5e94\u7528\u573a\u666f",id:"\u5e94\u7528\u573a\u666f",level:4},{value:"\u6280\u672f\u9009\u578b",id:"\u6280\u672f\u9009\u578b",level:4},{value:"\u5b89\u88c5\u6d4b\u8bd5",id:"\u5b89\u88c5\u6d4b\u8bd5",level:3},{value:"\u76f8\u5173\u6982\u5ff5",id:"\u76f8\u5173\u6982\u5ff5",level:3},{value:"\u6d88\u606f\u64cd\u4f5c",id:"\u6d88\u606f\u64cd\u4f5c",level:2},{value:"\u57fa\u672c\u6837\u4f8b",id:"\u57fa\u672c\u6837\u4f8b",level:3},{value:"\u8ba2\u9605\u53d1\u5e03",id:"\u8ba2\u9605\u53d1\u5e03",level:4},{value:"\u53d1\u9001\u6d88\u606f",id:"\u53d1\u9001\u6d88\u606f",level:4},{value:"\u540c\u6b65\u53d1\u9001",id:"\u540c\u6b65\u53d1\u9001",level:5},{value:"\u5f02\u6b65\u53d1\u9001",id:"\u5f02\u6b65\u53d1\u9001",level:5},{value:"\u5355\u5411\u53d1\u9001",id:"\u5355\u5411\u53d1\u9001",level:5},{value:"\u6d88\u8d39\u6d88\u606f",id:"\u6d88\u8d39\u6d88\u606f",level:4},{value:"\u987a\u5e8f\u6d88\u606f",id:"\u987a\u5e8f\u6d88\u606f",level:3},{value:"\u539f\u7406\u89e3\u6790",id:"\u539f\u7406\u89e3\u6790",level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-1",level:4},{value:"\u5ef6\u65f6\u6d88\u606f",id:"\u5ef6\u65f6\u6d88\u606f",level:3},{value:"\u539f\u7406\u89e3\u6790",id:"\u539f\u7406\u89e3\u6790-1",level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-2",level:4},{value:"\u6279\u91cf\u6d88\u606f",id:"\u6279\u91cf\u6d88\u606f",level:3},{value:"\u8fc7\u6ee4\u6d88\u606f",id:"\u8fc7\u6ee4\u6d88\u606f",level:3},{value:"\u57fa\u672c\u8bed\u6cd5",id:"\u57fa\u672c\u8bed\u6cd5",level:4},{value:"\u539f\u7406\u89e3\u6790",id:"\u539f\u7406\u89e3\u6790-2",level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-3",level:4},{value:"\u4e8b\u52a1\u6d88\u606f",id:"\u4e8b\u52a1\u6d88\u606f",level:3},{value:"\u5de5\u4f5c\u6d41\u7a0b",id:"\u5de5\u4f5c\u6d41\u7a0b",level:4},{value:"\u4e24\u9636\u6bb5",id:"\u4e24\u9636\u6bb5",level:4},{value:"\u4e00\u9636\u6bb5",id:"\u4e00\u9636\u6bb5",level:5},{value:"\u4e8c\u9636\u6bb5",id:"\u4e8c\u9636\u6bb5",level:5},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528",level:4},{value:"\u4f7f\u7528\u65b9\u5f0f",id:"\u4f7f\u7528\u65b9\u5f0f",level:5},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-4",level:5},{value:"\u7cfb\u7edf\u7279\u6027",id:"\u7cfb\u7edf\u7279\u6027",level:2},{value:"\u5de5\u4f5c\u6d41\u7a0b",id:"\u5de5\u4f5c\u6d41\u7a0b-1",level:3},{value:"\u6a21\u5757\u4ecb\u7ecd",id:"\u6a21\u5757\u4ecb\u7ecd",level:4},{value:"\u603b\u4f53\u6d41\u7a0b",id:"\u603b\u4f53\u6d41\u7a0b",level:4},{value:"\u751f\u4ea7\u6d88\u8d39",id:"\u751f\u4ea7\u6d88\u8d39",level:4},{value:"\u5b58\u50a8\u673a\u5236",id:"\u5b58\u50a8\u673a\u5236",level:3},{value:"\u5b58\u50a8\u7ed3\u6784",id:"\u5b58\u50a8\u7ed3\u6784",level:4},{value:"\u5185\u5b58\u6620\u5c04",id:"\u5185\u5b58\u6620\u5c04",level:4},{value:"\u9875\u9762\u7f13\u5b58",id:"\u9875\u9762\u7f13\u5b58",level:4},{value:"\u5237\u76d8\u673a\u5236",id:"\u5237\u76d8\u673a\u5236",level:4},{value:"\u96c6\u7fa4\u8bbe\u8ba1",id:"\u96c6\u7fa4\u8bbe\u8ba1",level:3},{value:"\u96c6\u7fa4\u6a21\u5f0f",id:"\u96c6\u7fa4\u6a21\u5f0f",level:4},{value:"\u96c6\u7fa4\u67b6\u6784",id:"\u96c6\u7fa4\u67b6\u6784",level:4},{value:"\u9ad8\u53ef\u7528\u6027",id:"\u9ad8\u53ef\u7528\u6027",level:4},{value:"\u4e3b\u4ece\u590d\u5236",id:"\u4e3b\u4ece\u590d\u5236",level:4},{value:"\u8d1f\u8f7d\u5747\u8861",id:"\u8d1f\u8f7d\u5747\u8861",level:3},{value:"\u751f\u4ea7\u7aef",id:"\u751f\u4ea7\u7aef",level:4},{value:"\u6d88\u8d39\u7aef",id:"\u6d88\u8d39\u7aef",level:4},{value:"\u539f\u7406\u89e3\u6790",id:"\u539f\u7406\u89e3\u6790-3",level:4},{value:"\u6d88\u606f\u67e5\u8be2",id:"\u6d88\u606f\u67e5\u8be2",level:3},{value:"\u67e5\u8be2\u65b9\u5f0f",id:"\u67e5\u8be2\u65b9\u5f0f",level:4},{value:"\u7d22\u5f15\u673a\u5236",id:"\u7d22\u5f15\u673a\u5236",level:4},{value:"\u6d88\u606f\u91cd\u8bd5",id:"\u6d88\u606f\u91cd\u8bd5",level:3},{value:"\u6d88\u606f\u91cd\u6295",id:"\u6d88\u606f\u91cd\u6295",level:4},{value:"\u6d88\u606f\u91cd\u8bd5",id:"\u6d88\u606f\u91cd\u8bd5-1",level:4},{value:"\u91cd\u8bd5\u64cd\u4f5c",id:"\u91cd\u8bd5\u64cd\u4f5c",level:4},{value:"\u6b7b\u4fe1\u961f\u5217",id:"\u6b7b\u4fe1\u961f\u5217",level:3},{value:"\u9ad8\u53ef\u9760\u6027",id:"\u9ad8\u53ef\u9760\u6027",level:3},{value:"\u5e42\u7b49\u6d88\u8d39",id:"\u5e42\u7b49\u6d88\u8d39",level:3},{value:"\u6d41\u91cf\u63a7\u5236",id:"\u6d41\u91cf\u63a7\u5236",level:3},{value:"\u539f\u7406\u89e3\u6790",id:"\u539f\u7406\u89e3\u6790-4",level:2},{value:"Namesrv",id:"namesrv",level:3},{value:"\u670d\u52a1\u542f\u52a8",id:"\u670d\u52a1\u542f\u52a8",level:4},{value:"\u542f\u52a8\u65b9\u6cd5",id:"\u542f\u52a8\u65b9\u6cd5",level:5},{value:"\u63a7\u5236\u5668\u7c7b",id:"\u63a7\u5236\u5668\u7c7b",level:5},{value:"\u7f51\u7edc\u901a\u4fe1",id:"\u7f51\u7edc\u901a\u4fe1",level:4},{value:"\u901a\u4fe1\u539f\u7406",id:"\u901a\u4fe1\u539f\u7406",level:5},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027",level:5},{value:"\u542f\u52a8\u65b9\u6cd5",id:"\u542f\u52a8\u65b9\u6cd5-1",level:5},{value:"\u8bf7\u6c42\u65b9\u6cd5",id:"\u8bf7\u6c42\u65b9\u6cd5",level:5},{value:"\u5904\u7406\u5668\u7c7b",id:"\u5904\u7406\u5668\u7c7b",level:4},{value:"\u534f\u8bae\u8bbe\u8ba1",id:"\u534f\u8bae\u8bbe\u8ba1-1",level:5},{value:"\u5904\u7406\u65b9\u6cd5",id:"\u5904\u7406\u65b9\u6cd5",level:5},{value:"\u8def\u7531\u4fe1\u606f",id:"\u8def\u7531\u4fe1\u606f",level:4},{value:"\u4fe1\u606f\u7ba1\u7406",id:"\u4fe1\u606f\u7ba1\u7406",level:5},{value:"\u8def\u7531\u6ce8\u518c",id:"\u8def\u7531\u6ce8\u518c",level:5},{value:"Broker",id:"broker",level:3},{value:"MappedFile",id:"mappedfile",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-1",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5",level:5},{value:"MapQueue",id:"mapqueue",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-2",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-1",level:5},{value:"CommitLog",id:"commitlog",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-3",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-2",level:5},{value:"\u670d\u52a1\u7ebf\u7a0b",id:"\u670d\u52a1\u7ebf\u7a0b",level:5},{value:"ConsQueue",id:"consqueue",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-4",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-3",level:5},{value:"IndexFile",id:"indexfile",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-5",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-4",level:5},{value:"IndexServ",id:"indexserv",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-6",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-5",level:5},{value:"HAService",id:"haservice",level:4},{value:"HAService",id:"haservice-1",level:5},{value:"Service",id:"service",level:6},{value:"Accept",id:"accept",level:6},{value:"Group",id:"group",level:6},{value:"HAClient",id:"haclient",level:5},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-7",level:6},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-6",level:6},{value:"HAConn",id:"haconn",level:5},{value:"Connection",id:"connection",level:6},{value:"ReadSocket",id:"readsocket",level:6},{value:"WriteSocket",id:"writesocket",level:6},{value:"MesStore",id:"messtore",level:4},{value:"\u751f\u547d\u5468\u671f",id:"\u751f\u547d\u5468\u671f-1",level:5},{value:"\u670d\u52a1\u7ebf\u7a0b",id:"\u670d\u52a1\u7ebf\u7a0b-1",level:5},{value:"\u6784\u5efa\u670d\u52a1",id:"\u6784\u5efa\u670d\u52a1",level:5},{value:"\u5237\u76d8\u670d\u52a1",id:"\u5237\u76d8\u670d\u52a1",level:5},{value:"\u6e05\u7406\u670d\u52a1",id:"\u6e05\u7406\u670d\u52a1",level:5},{value:"\u83b7\u53d6\u6d88\u606f",id:"\u83b7\u53d6\u6d88\u606f",level:5},{value:"Broker",id:"broker-1",level:4},{value:"Producer",id:"producer",level:3},{value:"\u751f\u4ea7\u8005\u7c7b",id:"\u751f\u4ea7\u8005\u7c7b",level:4},{value:"\u751f\u4ea7\u8005\u7c7b",id:"\u751f\u4ea7\u8005\u7c7b-1",level:5},{value:"\u5b9e\u73b0\u8005\u7c7b",id:"\u5b9e\u73b0\u8005\u7c7b",level:5},{value:"\u5b9e\u73b0\u65b9\u6cd5",id:"\u5b9e\u73b0\u65b9\u6cd5",level:5},{value:"\u8def\u7531\u4fe1\u606f",id:"\u8def\u7531\u4fe1\u606f-1",level:4},{value:"\u516c\u5171\u914d\u7f6e",id:"\u516c\u5171\u914d\u7f6e",level:4},{value:"\u5ba2\u6237\u7aef\u7c7b",id:"\u5ba2\u6237\u7aef\u7c7b",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-8",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-7",level:5},{value:"\u7f51\u7edc\u901a\u4fe1",id:"\u7f51\u7edc\u901a\u4fe1-1",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-9",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-8",level:5},{value:"\u5ef6\u8fdf\u6d88\u606f",id:"\u5ef6\u8fdf\u6d88\u606f",level:4},{value:"\u6d88\u606f\u5904\u7406",id:"\u6d88\u606f\u5904\u7406",level:5},{value:"\u8c03\u5ea6\u670d\u52a1",id:"\u8c03\u5ea6\u670d\u52a1",level:5},{value:"\u8c03\u5ea6\u4efb\u52a1",id:"\u8c03\u5ea6\u4efb\u52a1",level:5},{value:"\u4e8b\u52a1\u6d88\u606f",id:"\u4e8b\u52a1\u6d88\u606f-1",level:4},{value:"\u751f\u4ea7\u8005\u7c7b",id:"\u751f\u4ea7\u8005\u7c7b-2",level:5},{value:"\u63a5\u53d7\u6d88\u606f",id:"\u63a5\u53d7\u6d88\u606f",level:5},{value:"\u56de\u67e5\u5904\u7406",id:"\u56de\u67e5\u5904\u7406",level:5},{value:"\u4e8b\u52a1\u63d0\u4ea4",id:"\u4e8b\u52a1\u63d0\u4ea4",level:5},{value:"Consumer",id:"consumer",level:3},{value:"\u6d88\u8d39\u8005\u7c7b",id:"\u6d88\u8d39\u8005\u7c7b",level:4},{value:"\u9ed8\u8ba4\u6d88\u8d39",id:"\u9ed8\u8ba4\u6d88\u8d39",level:5},{value:"\u9ed8\u8ba4\u5b9e\u73b0",id:"\u9ed8\u8ba4\u5b9e\u73b0",level:5},{value:"\u8d1f\u8f7d\u5747\u8861",id:"\u8d1f\u8f7d\u5747\u8861-1",level:4},{value:"\u5b9e\u73b0\u65b9\u5f0f",id:"\u5b9e\u73b0\u65b9\u5f0f",level:5},{value:"\u961f\u5217\u5206\u914d",id:"\u961f\u5217\u5206\u914d",level:5},{value:"\u62c9\u53d6\u670d\u52a1",id:"\u62c9\u53d6\u670d\u52a1",level:4},{value:"\u5b9e\u73b0\u65b9\u5f0f",id:"\u5b9e\u73b0\u65b9\u5f0f-1",level:5},{value:"\u5c01\u88c5\u5bf9\u8c61",id:"\u5c01\u88c5\u5bf9\u8c61",level:5},{value:"\u62c9\u53d6\u5904\u7406",id:"\u62c9\u53d6\u5904\u7406",level:4},{value:"\u5904\u7406\u5668",id:"\u5904\u7406\u5668",level:5},{value:"\u957f\u8f6e\u8be2",id:"\u957f\u8f6e\u8be2",level:5},{value:"\u7ed3\u679c\u7c7b",id:"\u7ed3\u679c\u7c7b",level:5},{value:"\u961f\u5217\u5feb\u7167",id:"\u961f\u5217\u5feb\u7167",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-10",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-9",level:5},{value:"\u5e76\u53d1\u6d88\u8d39",id:"\u5e76\u53d1\u6d88\u8d39",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-11",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-10",level:5},{value:"\u6d88\u8d39\u8bf7\u6c42",id:"\u6d88\u8d39\u8bf7\u6c42",level:5},{value:"\u987a\u5e8f\u6d88\u8d39",id:"\u987a\u5e8f\u6d88\u8d39",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-12",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-11",level:5},{value:"\u6d88\u8d39\u8bf7\u6c42",id:"\u6d88\u8d39\u8bf7\u6c42-1",level:5},{value:"\u751f\u4ea7\u6d88\u8d39",id:"\u751f\u4ea7\u6d88\u8d39-1",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-7",level:2},{value:"\u6846\u67b6\u7279\u5f81",id:"\u6846\u67b6\u7279\u5f81",level:3},{value:"\u5e94\u7528\u573a\u666f",id:"\u5e94\u7528\u573a\u666f-1",level:3},{value:"\u57fa\u672c\u64cd\u4f5c",id:"\u57fa\u672c\u64cd\u4f5c",level:2},{value:"\u5b89\u88c5\u642d\u5efa",id:"\u5b89\u88c5\u642d\u5efa",level:3},{value:"\u64cd\u4f5c\u547d\u4ee4",id:"\u64cd\u4f5c\u547d\u4ee4",level:3},{value:"\u670d\u52a1\u7aef",id:"\u670d\u52a1\u7aef",level:4},{value:"\u5ba2\u6237\u7aef",id:"\u5ba2\u6237\u7aef",level:4},{value:"\u6570\u636e\u7ed3\u6784",id:"\u6570\u636e\u7ed3\u6784",level:3},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-5",level:3},{value:"\u96c6\u7fa4\u4ecb\u7ecd",id:"\u96c6\u7fa4\u4ecb\u7ecd",level:2},{value:"\u76f8\u5173\u6982\u5ff5",id:"\u76f8\u5173\u6982\u5ff5-1",level:3},{value:"\u521d\u6b21\u9009\u4e3e",id:"\u521d\u6b21\u9009\u4e3e",level:3},{value:"\u518d\u6b21\u9009\u4e3e",id:"\u518d\u6b21\u9009\u4e3e",level:3},{value:"\u6570\u636e\u5199\u5165",id:"\u6570\u636e\u5199\u5165",level:3},{value:"\u5e95\u5c42\u534f\u8bae",id:"\u5e95\u5c42\u534f\u8bae",level:2},{value:"Paxos",id:"paxos",level:3},{value:"ZAB",id:"zab",level:3},{value:"\u7b97\u6cd5\u4ecb\u7ecd",id:"\u7b97\u6cd5\u4ecb\u7ecd",level:4},{value:"\u6d88\u606f\u5e7f\u64ad",id:"\u6d88\u606f\u5e7f\u64ad",level:4},{value:"\u5d29\u6e83\u6062\u590d",id:"\u5d29\u6e83\u6062\u590d",level:4},{value:"\u5f02\u5e38\u5904\u7406",id:"\u5f02\u5e38\u5904\u7406",level:4},{value:"CAP",id:"cap",level:3},{value:"\u76d1\u542c\u673a\u5236",id:"\u76d1\u542c\u673a\u5236",level:2},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406",level:3},{value:"\u76d1\u542c\u6848\u4f8b",id:"\u76d1\u542c\u6848\u4f8b",level:3},{value:"\u6574\u4f53\u67b6\u6784",id:"\u6574\u4f53\u67b6\u6784",level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-6",level:4},{value:"\u5206\u5e03\u5f0f\u9501",id:"\u5206\u5e03\u5f0f\u9501",level:2},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-1",level:3},{value:"Curator",id:"curator",level:3},{value:"\u6e90\u7801\u89e3\u6790",id:"\u6e90\u7801\u89e3\u6790",level:2},{value:"\u670d\u52a1\u7aef",id:"\u670d\u52a1\u7aef-1",level:3},{value:"\u9009\u4e3e\u673a\u5236",id:"\u9009\u4e3e\u673a\u5236",level:3},{value:"\u73af\u5883\u51c6\u5907",id:"\u73af\u5883\u51c6\u5907",level:4},{value:"\u9009\u4e3e\u6e90\u7801",id:"\u9009\u4e3e\u6e90\u7801",level:4},{value:"\u72b6\u6001\u540c\u6b65",id:"\u72b6\u6001\u540c\u6b65",level:4},{value:"\u4e3b\u4ece\u5de5\u4f5c",id:"\u4e3b\u4ece\u5de5\u4f5c",level:4},{value:"\u5ba2\u6237\u7aef",id:"\u5ba2\u6237\u7aef-1",level:3}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",h6:"h6",header:"header",hr:"hr",img:"img",li:"li",localrepository:"localrepository",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"maven",children:"Maven"})}),"\n",(0,l.jsx)(n.h2,{id:"\u57fa\u672c\u4ecb\u7ecd",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.h3,{id:"mvn\u4ecb\u7ecd",children:"Mvn\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"Maven\uff1a\u672c\u8d28\u662f\u4e00\u4e2a\u9879\u76ee\u7ba1\u7406\u5de5\u5177\uff0c\u5c06\u9879\u76ee\u5f00\u53d1\u548c\u7ba1\u7406\u8fc7\u7a0b\u62bd\u8c61\u6210\u4e00\u4e2a\u9879\u76ee\u5bf9\u8c61\u6a21\u578b\uff08POM\uff09"}),"\n",(0,l.jsx)(n.p,{children:"POM\uff1aProject Object Model \u9879\u76ee\u5bf9\u8c61\u6a21\u578b\u3002Maven \u662f\u7528 Java \u8bed\u8a00\u7f16\u5199\u7684\uff0c\u7ba1\u7406\u7684\u4e1c\u897f\u4ee5\u9762\u5411\u5bf9\u8c61\u7684\u5f62\u5f0f\u8fdb\u884c\u8bbe\u8ba1\uff0c\u6700\u7ec8\u628a\u4e00\u4e2a\u9879\u76ee\u770b\u6210\u4e00\u4e2a\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u53eb\u505a POM"}),"\n",(0,l.jsx)(n.p,{children:"pom.xml\uff1aMaven \u9700\u8981\u4e00\u4e2a  pom.xml \u6587\u4ef6\uff0cMaven \u901a\u8fc7\u52a0\u8f7d\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u77e5\u9053\u9879\u76ee\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u8fd9\u4e2a\u6587\u4ef6\u4ee3\u8868\u5c31\u4e00\u4e2a\u9879\u76ee\u3002\u5982\u679c\u505a 8 \u4e2a\u9879\u76ee\uff0c\u5bf9\u5e94\u7684\u662f 8 \u4e2a pom.xml \u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"\u4f9d\u8d56\u7ba1\u7406\uff1aMaven \u5bf9\u9879\u76ee\u6240\u6709\u4f9d\u8d56\u8d44\u6e90\u7684\u4e00\u79cd\u7ba1\u7406\uff0c\u5b83\u548c\u9879\u76ee\u4e4b\u95f4\u662f\u4e00\u79cd\u53cc\u5411\u5173\u7cfb\uff0c\u5373\u505a\u9879\u76ee\u65f6\u53ef\u4ee5\u7ba1\u7406\u6240\u9700\u8981\u7684\u5176\u4ed6\u8d44\u6e90\uff0c\u5f53\u5176\u4ed6\u9879\u76ee\u9700\u8981\u4f9d\u8d56\u6211\u4eec\u9879\u76ee\u65f6\uff0cMaven \u4e5f\u4f1a\u628a\u6211\u4eec\u7684\u9879\u76ee\u5f53\u4f5c\u4e00\u79cd\u8d44\u6e90\u53bb\u8fdb\u884c\u7ba1\u7406\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u7ba1\u7406\u8d44\u6e90\u7684\u5b58\u50a8\u4f4d\u7f6e\uff1a\u672c\u5730\u4ed3\u5e93\uff0c\u79c1\u670d\uff0c\u4e2d\u592e\u4ed3\u5e93"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(43943).A+"",width:"1017",height:"459"})}),"\n",(0,l.jsx)(n.p,{children:"\u57fa\u672c\u4f5c\u7528\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9879\u76ee\u6784\u5efa\uff1a\u63d0\u4f9b\u6807\u51c6\u7684\uff0c\u8de8\u5e73\u53f0\u7684\u81ea\u52a8\u5316\u6784\u5efa\u9879\u76ee\u7684\u65b9\u5f0f"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4f9d\u8d56\u7ba1\u7406\uff1a\u65b9\u4fbf\u5feb\u6377\u7684\u7ba1\u7406\u9879\u76ee\u4f9d\u8d56\u7684\u8d44\u6e90\uff08jar \u5305\uff09\uff0c\u907f\u514d\u8d44\u6e90\u95f4\u7684\u7248\u672c\u51b2\u7a81\u7b49\u95ee\u9898"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7edf\u4e00\u5f00\u53d1\u7ed3\u6784\uff1a\u63d0\u4f9b\u6807\u51c6\u7684\uff0c\u7edf\u4e00\u7684\u9879\u76ee\u5f00\u53d1\u7ed3\u6784"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(60345).A+"",width:"258",height:"238"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5404\u76ee\u5f55\u5b58\u653e\u8d44\u6e90\u7c7b\u578b\u8bf4\u660e\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"src/main/java\uff1a\u9879\u76ee java \u6e90\u7801"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"src/main/resources\uff1a\u9879\u76ee\u7684\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\uff08\u6bd4\u5982 mybatis \u914d\u7f6e\uff0cxml \u6620\u5c04\u914d\u7f6e\uff0c\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6\u7b49\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"src/main/webapp\uff1aweb \u8d44\u6e90\uff08\u6bd4\u5982 html\u3001css\u3001js \u7b49\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"src/test/java\uff1a\u6d4b\u8bd5\u4ee3\u7801"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"src/test/resources\uff1a\u6d4b\u8bd5\u76f8\u5173\u914d\u7f6e\u6587\u4ef6"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"src/pom.xml\uff1a\u9879\u76ee pom \u6587\u4ef6"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,l.jsx)(n.a,{href:"https://www.bilibili.com/video/BV1Ah411S7ZE",children:"https://www.bilibili.com/video/BV1Ah411S7ZE"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u7840\u6982\u5ff5",children:"\u57fa\u7840\u6982\u5ff5"}),"\n",(0,l.jsx)(n.p,{children:"\u4ed3\u5e93\uff1a\u7528\u4e8e\u5b58\u50a8\u8d44\u6e90\uff0c\u4e3b\u8981\u662f\u5404\u79cd jar \u5305\u3002\u6709\u672c\u5730\u4ed3\u5e93\uff0c\u79c1\u670d\uff0c\u4e2d\u592e\u4ed3\u5e93\uff0c\u79c1\u670d\u548c\u4e2d\u592e\u4ed3\u5e93\u90fd\u662f\u8fdc\u7a0b\u4ed3\u5e93"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e2d\u592e\u4ed3\u5e93\uff1aMaven \u56e2\u961f\u81ea\u8eab\u7ef4\u62a4\u7684\u4ed3\u5e93\uff0c\u5c5e\u4e8e\u5f00\u6e90\u7684"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u79c1\u670d\uff1a\u5404\u516c\u53f8/\u90e8\u95e8\u7b49\u5c0f\u8303\u56f4\u5185\u5b58\u50a8\u8d44\u6e90\u7684\u4ed3\u5e93\uff0c\u79c1\u670d\u4e5f\u53ef\u4ee5\u4ece\u4e2d\u592e\u4ed3\u5e93\u83b7\u53d6\u8d44\u6e90\uff0c\u4f5c\u7528\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4fdd\u5b58\u5177\u6709\u7248\u6743\u7684\u8d44\u6e90\uff0c\u5305\u542b\u8d2d\u4e70\u6216\u81ea\u4e3b\u7814\u53d1\u7684 jar"}),"\n",(0,l.jsx)(n.li,{children:"\u4e00\u5b9a\u8303\u56f4\u5185\u5171\u4eab\u8d44\u6e90\uff0c\u80fd\u505a\u5230\u4ec5\u5bf9\u5185\u4e0d\u5bf9\u5916\u5f00\u653e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u672c\u5730\u4ed3\u5e93\uff1a\u5f00\u53d1\u8005\u81ea\u5df1\u7535\u8111\u4e0a\u5b58\u50a8\u8d44\u6e90\u7684\u4ed3\u5e93\uff0c\u4e5f\u53ef\u4ece\u8fdc\u7a0b\u4ed3\u5e93\u83b7\u53d6\u8d44\u6e90"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5750\u6807\uff1aMaven \u4e2d\u7684\u5750\u6807\u7528\u4e8e\u63cf\u8ff0\u4ed3\u5e93\u4e2d\u8d44\u6e90\u7684\u4f4d\u7f6e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u4f7f\u7528\u552f\u4e00\u6807\u8bc6\uff0c\u552f\u4e00\u6027\u5b9a\u4e49\u8d44\u6e90\u4f4d\u7f6e\uff0c\u901a\u8fc7\u8be5\u6807\u8bc6\u53ef\u4ee5\u5c06\u8d44\u6e90\u7684\u8bc6\u522b\u4e0e\u4e0b\u8f7d\u5de5\u4f5c\u4ea4\u7531\u673a\u5668\u5b8c\u6210"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"https://mvnrepository.com"}),"\uff1a\u67e5\u8be2 maven \u67d0\u4e00\u4e2a\u8d44\u6e90\u7684\u5750\u6807\uff0c\u8f93\u5165\u8d44\u6e90\u540d\u79f0\u8fdb\u884c\u68c0\u7d22"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4f9d\u8d56\u8bbe\u7f6e\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"groupId\uff1a\u5b9a\u4e49\u5f53\u524d\u8d44\u6e90\u96b6\u5c5e\u7ec4\u7ec7\u540d\u79f0\uff08\u901a\u5e38\u662f\u57df\u540d\u53cd\u5199\uff0c\u5982\uff1aorg.mybatis\uff09"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"artifactId\uff1a\u5b9a\u4e49\u5f53\u524d\u8d44\u6e90\u7684\u540d\u79f0\uff08\u901a\u5e38\u662f\u9879\u76ee\u6216\u6a21\u5757\u540d\u79f0\uff0c\u5982\uff1acrm\u3001sms\uff09"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"version\uff1a\u5b9a\u4e49\u5f53\u524d\u8d44\u6e90\u7684\u7248\u672c\u53f7"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"packaging\uff1a\u5b9a\u4e49\u8d44\u6e90\u7684\u6253\u5305\u65b9\u5f0f\uff0c\u53d6\u503c\u4e00\u822c\u6709\u5982\u4e0b\u4e09\u79cd"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"jar\uff1a\u8be5\u8d44\u6e90\u6253\u6210 jar \u5305\uff0c\u9ed8\u8ba4\u662f jar"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"war\uff1a\u8be5\u8d44\u6e90\u6253\u6210 war \u5305"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"pom\uff1a\u8be5\u8d44\u6e90\u662f\u4e00\u4e2a\u7236\u8d44\u6e90\uff08\u8868\u660e\u4f7f\u7528 Maven \u5206\u6a21\u5757\u7ba1\u7406\uff09\uff0c\u6253\u5305\u65f6\u53ea\u751f\u6210\u4e00\u4e2a pom.xml \u4e0d\u751f\u6210 jar \u6216\u5176\u4ed6\u5305\u7ed3\u6784"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u73af\u5883\u642d\u5efa",children:"\u73af\u5883\u642d\u5efa"}),"\n",(0,l.jsx)(n.h3,{id:"\u73af\u5883\u914d\u7f6e",children:"\u73af\u5883\u914d\u7f6e"}),"\n",(0,l.jsxs)(n.p,{children:["Maven \u7684\u5b98\u7f51\uff1a",(0,l.jsx)(n.a,{href:"http://maven.apache.org/",children:"http://maven.apache.org/"})]}),"\n",(0,l.jsx)(n.p,{children:"\u4e0b\u8f7d\u5b89\u88c5\uff1aMaven \u662f\u4e00\u4e2a\u7eff\u8272\u8f6f\u4ef6\uff0c\u89e3\u538b\u5373\u5b89\u88c5"}),"\n",(0,l.jsx)(n.p,{children:"\u76ee\u5f55\u7ed3\u6784\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"bin\uff1a\u53ef\u6267\u884c\u7a0b\u5e8f\u76ee\u5f55"}),"\n",(0,l.jsx)(n.li,{children:"boot\uff1aMaven \u81ea\u8eab\u7684\u542f\u52a8\u52a0\u8f7d\u5668"}),"\n",(0,l.jsx)(n.li,{children:"conf\uff1aMaven \u914d\u7f6e\u6587\u4ef6\u7684\u5b58\u653e\u76ee\u5f55"}),"\n",(0,l.jsx)(n.li,{children:"lib\uff1aMaven\u8fd0\u884c\u6240\u9700\u5e93\u7684\u5b58\u653e\u76ee\u5f55"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e MAVEN_HOME\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(18955).A+"",width:"1898",height:"1010"})}),"\n",(0,l.jsxs)(n.p,{children:["Path \u4e0b\u914d\u7f6e\uff1a",(0,l.jsx)(n.code,{children:"%MAVEN_HOME%\\bin"})]}),"\n",(0,l.jsxs)(n.p,{children:["\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u597d\u4e4b\u540e\u9700\u8981\u6d4b\u8bd5\u73af\u5883\u914d\u7f6e\u7ed3\u679c\uff0c\u5728 DOS \u547d\u4ee4\u7a97\u53e3\u4e0b\u8f93\u5165\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u8f93\u51fa\uff1a",(0,l.jsx)(n.code,{children:"mvn -v"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u4ed3\u5e93\u914d\u7f6e",children:"\u4ed3\u5e93\u914d\u7f6e"}),"\n",(0,l.jsxs)(n.p,{children:["\u9ed8\u8ba4\u60c5\u51b5 Maven \u672c\u5730\u4ed3\u5e93\u5728\u7cfb\u7edf\u7528\u6237\u76ee\u5f55\u4e0b\u7684 ",(0,l.jsx)(n.code,{children:".m2/repository"}),"\uff0c\u4fee\u6539 Maven \u7684\u914d\u7f6e\u6587\u4ef6 ",(0,l.jsx)(n.code,{children:"conf/settings.xml"})," \u6765\u4fee\u6539\u4ed3\u5e93\u4f4d\u7f6e"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u4fee\u6539\u672c\u5730\u4ed3\u5e93\u4f4d\u7f6e\uff1a\u627e\u5230 ",(0,l.jsx)(n.localrepository,{children:" \u6807\u7b7e\uff0c\u4fee\u6539\u9ed8\u8ba4\u503c"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!-- localRepository\n| The path to the local repository maven will use to store artifacts.\n| Default: ${user.home}/.m2/repository\n<localRepository>/path/to/local/repo</localRepository>\n--\x3e\n<localRepository>E:\\Workspace\\Java\\Project\\.m2\\repository</localRepository>\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a\u5728\u4ed3\u5e93\u7684\u540c\u7ea7\u76ee\u5f55\u5373 ",(0,l.jsx)(n.code,{children:".m2"})," \u4e5f\u5e94\u8be5\u5305\u542b\u4e00\u4e2a ",(0,l.jsx)(n.code,{children:"settings.xml"})," \u914d\u7f6e\u6587\u4ef6\uff0c\u5c40\u90e8\u7528\u6237\u914d\u7f6e\u4f18\u5148\u4e0e\u5168\u5c40\u914d\u7f6e"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5168\u5c40 setting \u5b9a\u4e49\u4e86 Maven \u7684\u516c\u5171\u914d\u7f6e"}),"\n",(0,l.jsx)(n.li,{children:"\u7528\u6237 setting \u5b9a\u4e49\u4e86\u5f53\u524d\u7528\u6237\u7684\u914d\u7f6e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u4fee\u6539\u8fdc\u7a0b\u4ed3\u5e93\uff1a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u627e\u5230 ",(0,l.jsx)(n.code,{children:"<mirrors>"})," \u6807\u7b7e\uff0c\u5728\u8fd9\u7ec4\u6807\u7b7e\u4e0b\u6dfb\u52a0\u56fd\u5185\u955c\u50cf"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<mirror>\n    <id>nexus-aliyun</id>\n    <mirrorOf>central</mirrorOf>  \x3c!--\u5fc5\u987b\u662fcentral--\x3e\n    <name>Nexus aliyun</name>\n    <url>http://maven.aliyun.com/nexus/content/groups/public</url>\n</mirror>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u4fee\u6539\u9ed8\u8ba4 JDK\uff1a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u627e\u5230 ",(0,l.jsx)(n.code,{children:"<profiles>"})," \u6807\u7b7e\uff0c\u6dfb\u52a0\u914d\u7f6e"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<profile> \n    <id>jdk-10</id> \n    <activation> \n        <activeByDefault>true</activeByDefault> \n        <jdk>10</jdk> \n    </activation>\n    <properties>\n        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n        <maven.compiler.source>10</maven.compiler.source> \n        <maven.compiler.target>10</maven.compiler.target>  \n    </properties>  \n</profile>\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u9879\u76ee\u642d\u5efa",children:"\u9879\u76ee\u642d\u5efa"}),"\n",(0,l.jsx)(n.h3,{id:"\u624b\u52a8\u642d\u5efa",children:"\u624b\u52a8\u642d\u5efa"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5728 E \u76d8\u4e0b\u521b\u5efa\u76ee\u5f55 mvnproject \u8fdb\u5165\u8be5\u76ee\u5f55\uff0c\u4f5c\u4e3a\u6211\u4eec\u7684\u64cd\u4f5c\u76ee\u5f55"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u521b\u5efa\u6211\u4eec\u7684 Maven \u9879\u76ee\uff0c\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55 ",(0,l.jsx)(n.code,{children:"project-java"})," \u4f5c\u4e3a\u6211\u4eec\u7684\u9879\u76ee\u6587\u4ef6\u5939\uff0c\u5e76\u8fdb\u5165\u5230\u8be5\u76ee\u5f55"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u521b\u5efa Java \u4ee3\u7801\uff08\u6e90\u4ee3\u7801\uff09\u6240\u5728\u76ee\u5f55\uff0c\u5373\u521b\u5efa ",(0,l.jsx)(n.code,{children:"src/main/java"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\u6240\u5728\u76ee\u5f55\uff0c\u5373\u521b\u5efa ",(0,l.jsx)(n.code,{children:"src/main/resources"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u521b\u5efa\u6d4b\u8bd5\u6e90\u4ee3\u7801\u6240\u5728\u76ee\u5f55\uff0c\u5373\u521b\u5efa ",(0,l.jsx)(n.code,{children:"src/test/java"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u521b\u5efa\u6d4b\u8bd5\u5b58\u653e\u914d\u7f6e\u6587\u4ef6\u5b58\u653e\u76ee\u5f55\uff0c\u5373 ",(0,l.jsx)(n.code,{children:"src/test/resources"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5728 ",(0,l.jsx)(n.code,{children:"src/main/java"})," \u4e2d\u521b\u5efa\u4e00\u4e2a\u5305\uff08\u6ce8\u610f\u5728 Windos \u6587\u4ef6\u5939\u4e0b\u5c31\u662f\u521b\u5efa\u76ee\u5f55\uff09",(0,l.jsx)(n.code,{children:"demo"}),"\uff0c\u5728\u8be5\u76ee\u5f55\u4e0b\u521b\u5efa ",(0,l.jsx)(n.code,{children:"Demo.java"})," \u6587\u4ef6\uff0c\u4f5c\u4e3a\u6f14\u793a\u6240\u9700 Java \u7a0b\u5e8f\uff0c\u5185\u5bb9\u5982\u4e0b"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package demo;\npublic class Demo{\n\tpublic String say(String name){\n\t\tSystem.out.println("hello "+name);\n\t\treturn "hello "+name;\n\t}\n}\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5728 ",(0,l.jsx)(n.code,{children:"src/test/java"})," \u4e2d\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u5305\uff08\u76ee\u5f55\uff09",(0,l.jsx)(n.code,{children:"demo"}),"\uff0c\u5728\u8be5\u5305\u4e0b\u521b\u5efa\u6d4b\u8bd5\u7a0b\u5e8f ",(0,l.jsx)(n.code,{children:"DemoTest.java"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package demo;\nimport org.junit.*;\npublic class DemoTest{\n\t@Test\n\tpublic void testSay(){\n\t\tDemo d = new Demo();\n\t\tString ret = d.say("maven");\n\t\tAssert.assertEquals("hello maven",ret);\n\t}\n}\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["\u5728 ",(0,l.jsx)(n.code,{children:"project-java/src"})," \u4e0b\u521b\u5efa ",(0,l.jsx)(n.code,{children:"pom.xml"})," \u6587\u4ef6\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a"]})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<project\n    xmlns="http://maven.apache.org/POM/4.0.0"\n    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 \t\n                        http://maven.apache.org/maven-v4_0_0.xsd">\n    \n    \x3c!--\u6307\u5b9apom\u7684\u6a21\u578b\u7248\u672c--\x3e\n    <modelVersion>4.0.0</modelVersion>\n    \x3c!--\u6253\u5305\u65b9\u5f0f\uff0cweb\u5de5\u7a0b\u6253\u5305\u4e3awar\uff0cjava\u5de5\u7a0b\u6253\u5305\u4e3ajar --\x3e\n    <packaging>jar</packaging>\n    \n    \x3c!--\u7ec4\u7ec7id--\x3e\n    <groupId>demo</groupId>\n\t\x3c!--\u9879\u76eeid--\x3e\n    <artifactId>project-java</artifactId>\n    \x3c!--\u7248\u672c\u53f7:release,snapshot--\x3e\n    <version>1.0</version>\n    \n    \x3c!--\u8bbe\u7f6e\u5f53\u524d\u5de5\u7a0b\u7684\u6240\u6709\u4f9d\u8d56--\x3e\n    <dependencies>\n        \x3c!--\u5177\u4f53\u7684\u4f9d\u8d56--\x3e\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <version>4.12</version>\n        </dependency>\n    </dependencies>\n</project>\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u642d\u5efa\u5b8c\u6210 Maven \u7684\u9879\u76ee\u7ed3\u6784\uff0c\u901a\u8fc7 Maven \u6765\u6784\u5efa\u9879\u76ee\u3002Maven \u7684\u6784\u5efa\u547d\u4ee4\u4ee5 ",(0,l.jsx)(n.code,{children:"mvn"})," \u5f00\u5934\uff0c\u540e\u9762\u6dfb\u52a0\u529f\u80fd\u53c2\u6570\uff0c\u53ef\u4ee5\u4e00\u6b21\u6027\u6267\u884c\u591a\u4e2a\u547d\u4ee4\uff0c\u7528\u7a7a\u683c\u5206\u79bb"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mvn compile"}),"\uff1a\u7f16\u8bd1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mvn clean"}),"\uff1a\u6e05\u7406"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mvn test"}),"\uff1a\u6d4b\u8bd5"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mvn package"}),"\uff1a\u6253\u5305"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mvn install"}),"\uff1a\u5b89\u88c5\u5230\u672c\u5730\u4ed3\u5e93"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u6267\u884c\u67d0\u4e00\u6761\u547d\u4ee4\uff0c\u5219\u4f1a\u628a\u524d\u9762\u6240\u6709\u7684\u90fd\u6267\u884c\u4e00\u904d"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"idea\u642d\u5efa",children:"IDEA\u642d\u5efa"}),"\n",(0,l.jsx)(n.h4,{id:"\u4e0d\u7528\u539f\u578b",children:"\u4e0d\u7528\u539f\u578b"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5728 IDEA \u4e2d\u914d\u7f6e Maven\uff0c\u9009\u62e9 maven3.6.1 \u9632\u6b62\u4f9d\u8d56\u95ee\u9898\n",(0,l.jsx)(n.img,{src:s(42335).A+"",width:"1534",height:"948"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa Maven\uff0cNew Module \u2192 Maven \u2192 \u4e0d\u9009\u4e2d Create from archetype"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u586b\u5199\u9879\u76ee\u7684\u5750\u6807"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"GroupId\uff1ademo"}),"\n",(0,l.jsx)(n.li,{children:"ArtifactId\uff1aproject-java"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u67e5\u770b\u5404\u76ee\u5f55\u989c\u8272\u6807\u8bb0\u662f\u5426\u6b63\u786e"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(5543).A+"",width:"1165",height:"649"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"IDEA \u53f3\u4fa7\u4fa7\u680f\u6709 Maven Project\uff0c\u6253\u5f00\u540e\u6709 Lifecycle \u751f\u547d\u5468\u671f"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(40404).A+"",width:"984",height:"668"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49 Maven \u547d\u4ee4\uff1aRun \u2192 Edit Configurations \u2192 \u5de6\u4e0a\u89d2 +  \u2192 Maven"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(28836).A+"",width:"1000",height:"611"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4f7f\u7528\u539f\u578b",children:"\u4f7f\u7528\u539f\u578b"}),"\n",(0,l.jsx)(n.p,{children:"\u666e\u901a\u5de5\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa Maven \u9879\u76ee\u7684\u65f6\u5019\u9009\u62e9\u4f7f\u7528\u539f\u578b\u9aa8\u67b6"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(18307).A+"",width:"1246",height:"827"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa\u5b8c\u6210\u540e\u53d1\u73b0\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u7f3a\u5c11\u4e00\u4e9b\u76ee\u5f55\uff0c\u9700\u8981\u624b\u52a8\u53bb\u8865\u5168\u76ee\u5f55\uff0c\u5e76\u4e14\u8981\u5bf9\u8865\u5168\u7684\u76ee\u5f55\u8fdb\u884c\u6807\u8bb0"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Web \u5de5\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9009\u62e9 Web \u5bf9\u5e94\u7684\u539f\u578b\u9aa8\u67b6\uff08\u9009\u62e9 Maven \u5f00\u5934\u7684\u662f\u7b80\u5316\u7684\uff09"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(75787).A+"",width:"1243",height:"828"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u901a\u8fc7\u539f\u578b\u521b\u5efa Web \u9879\u76ee\u5f97\u5230\u7684\u76ee\u5f55\u7ed3\u6784\u662f\u4e0d\u5168\u7684\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u81ea\u884c\u8865\u5168\uff0c\u540c\u65f6\u8981\u6807\u8bb0\u6b63\u786e"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Web \u5de5\u7a0b\u521b\u5efa\u4e4b\u540e\u9700\u8981\u542f\u52a8\u8fd0\u884c\uff0c\u4f7f\u7528 tomcat \u63d2\u4ef6\u6765\u8fd0\u884c\u9879\u76ee\uff0c\u5728 ",(0,l.jsx)(n.code,{children:"pom.xml"})," \u4e2d\u6dfb\u52a0\u63d2\u4ef6\u7684\u5750\u6807\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" \t\t\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" \n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 \n                             http://maven.apache.org/maven-v4_0_0.xsd">\n\n  <modelVersion>4.0.0</modelVersion>\n  <packaging>war</packaging>\n\n  <name>web01</name>\n  <groupId>demo</groupId>\n  <artifactId>web01</artifactId>\n  <version>1.0-SNAPSHOT</version>\n\n  <dependencies>\n  </dependencies>\n\n  \x3c!--\u6784\u5efa--\x3e\n  <build>\n    \x3c!--\u8bbe\u7f6e\u63d2\u4ef6--\x3e\n    <plugins>\n      \x3c!--\u5177\u4f53\u7684\u63d2\u4ef6\u914d\u7f6e--\x3e\n      <plugin>\n        \x3c!--https://mvnrepository.com/  \u641c\u7d22--\x3e\n        <groupId>org.apache.tomcat.maven</groupId>\n        <artifactId>tomcat7-maven-plugin</artifactId>\n        <version>2.1</version>\n        <configuration>\n            <port>80</port> \x3c!--80\u7aef\u53e3\u9ed8\u8ba4\u4e0d\u663e\u793a--\x3e\n            <path>/</path>\n        </configuration>\n      </plugin>\n    </plugins>\n  </build>\n</project>\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u63d2\u4ef6\u914d\u7f6e\u4ee5\u540e\uff0c\u5728 IDEA \u53f3\u4fa7 ",(0,l.jsx)(n.code,{children:"maven-project"})," \u64cd\u4f5c\u9762\u677f\u770b\u5230\u8be5\u63d2\u4ef6\uff0c\u5e76\u4e14\u53ef\u4ee5\u5229\u7528\u8be5\u63d2\u4ef6\u542f\u52a8\u9879\u76ee\uff0cweb01 \u2192 Plugins \u2192 tomcat7 \u2192 tomcat7:run"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u4f9d\u8d56\u7ba1\u7406",children:"\u4f9d\u8d56\u7ba1\u7406"}),"\n",(0,l.jsx)(n.h3,{id:"\u4f9d\u8d56\u914d\u7f6e",children:"\u4f9d\u8d56\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u4f9d\u8d56\u662f\u6307\u5728\u5f53\u524d\u9879\u76ee\u4e2d\u8fd0\u884c\u6240\u9700\u7684 jar\uff0c\u4f9d\u8d56\u914d\u7f6e\u7684\u683c\u5f0f\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!--\u8bbe\u7f6e\u5f53\u524d\u9879\u76ee\u6240\u4f9d\u8d56\u7684\u6240\u6709jar--\x3e\n<dependencies>\n    \x3c!--\u8bbe\u7f6e\u5177\u4f53\u7684\u4f9d\u8d56--\x3e\n    <dependency>\n        \x3c!--\u4f9d\u8d56\u6240\u5c5e\u7fa4\u7ec4id--\x3e\n        <groupId>junit</groupId>\n        \x3c!--\u4f9d\u8d56\u6240\u5c5e\u9879\u76eeid--\x3e\n        <artifactId>junit</artifactId>\n        \x3c!--\u4f9d\u8d56\u7248\u672c\u53f7--\x3e\n        <version>4.12</version>\n    </dependency>\n</dependencies>\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u4f9d\u8d56\u4f20\u9012",children:"\u4f9d\u8d56\u4f20\u9012"}),"\n",(0,l.jsx)(n.p,{children:"\u4f9d\u8d56\u5177\u6709\u4f20\u9012\u6027\uff0c\u5206\u4e24\u79cd\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u76f4\u63a5\u4f9d\u8d56\uff1a\u5728\u5f53\u524d\u9879\u76ee\u4e2d\u901a\u8fc7\u4f9d\u8d56\u914d\u7f6e\u5efa\u7acb\u7684\u4f9d\u8d56\u5173\u7cfb"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u95f4\u63a5\u4f9d\u8d56\uff1a\u88ab\u4f9d\u8d56\u7684\u8d44\u6e90\u5982\u679c\u4f9d\u8d56\u5176\u4ed6\u8d44\u6e90\uff0c\u5219\u8868\u660e\u5f53\u524d\u9879\u76ee\u95f4\u63a5\u4f9d\u8d56\u5176\u4ed6\u8d44\u6e90"}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u76f4\u63a5\u4f9d\u8d56\u548c\u95f4\u63a5\u4f9d\u8d56\u5176\u5b9e\u4e5f\u662f\u4e00\u4e2a\u76f8\u5bf9\u5173\u7cfb"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4f9d\u8d56\u4f20\u9012\u7684\u51b2\u7a81\u95ee\u9898\uff1a\u5728\u4f9d\u8d56\u4f20\u9012\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u4e86\u51b2\u7a81\uff0c\u6709\u4e09\u79cd\u4f18\u5148\u6cd5\u5219"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8def\u5f84\u4f18\u5148\uff1a\u5f53\u4f9d\u8d56\u4e2d\u51fa\u73b0\u76f8\u540c\u8d44\u6e90\u65f6\uff0c\u5c42\u7ea7\u8d8a\u6df1\uff0c\u4f18\u5148\u7ea7\u8d8a\u4f4e\uff0c\u53cd\u4e4b\u5219\u8d8a\u9ad8"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u58f0\u660e\u4f18\u5148\uff1a\u5f53\u8d44\u6e90\u5728\u76f8\u540c\u5c42\u7ea7\u88ab\u4f9d\u8d56\u65f6\uff0c\u914d\u7f6e\u987a\u5e8f\u9760\u524d\u7684\u8986\u76d6\u9760\u540e\u7684"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7279\u6b8a\u4f18\u5148\uff1a\u5f53\u540c\u7ea7\u914d\u7f6e\u4e86\u76f8\u540c\u8d44\u6e90\u7684\u4e0d\u540c\u7248\u672c\u65f6\uff0c\u540e\u914d\u7f6e\u7684\u8986\u76d6\u5148\u914d\u7f6e\u7684"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u53ef\u9009\u4f9d\u8d56"}),"\uff1a\u5bf9\u5916\u9690\u85cf\u5f53\u524d\u6240\u4f9d\u8d56\u7684\u8d44\u6e90\uff0c\u4e0d\u900f\u660e"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>    \n    <groupId>junit</groupId>    \n    <artifactId>junit</artifactId>    \n    <version>4.11</version>    \n    <optional>true</optional> \n    \x3c!--\u9ed8\u8ba4\u662ffalse\uff0ctrue\u4ee5\u540e\u5c31\u53d8\u5f97\u4e0d\u900f\u660e--\x3e\n</dependency>\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6392\u9664\u4f9d\u8d56"}),"\uff1a\u4e3b\u52a8\u65ad\u5f00\u4f9d\u8d56\u7684\u8d44\u6e90\uff0c\u88ab\u6392\u9664\u7684\u8d44\u6e90\u65e0\u9700\u6307\u5b9a\u7248\u672c"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>    \n    <groupId>junit</groupId>    \n    <artifactId>junit</artifactId>    \n    <version>4.12</version>    \n    <exclusions>        \n        <exclusion>            \n            <groupId>org.hamcrest</groupId>  \x3c!--\u6392\u9664\u8fd9\u4e2a\u8d44\u6e90--\x3e            \n            <artifactId>hamcrest-core</artifactId>        \n        </exclusion>    \n    </exclusions>\n</dependency>\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u4f9d\u8d56\u8303\u56f4",children:"\u4f9d\u8d56\u8303\u56f4"}),"\n",(0,l.jsxs)(n.p,{children:["\u4f9d\u8d56\u7684 jar \u9ed8\u8ba4\u60c5\u51b5\u53ef\u4ee5\u5728\u4efb\u4f55\u5730\u65b9\u53ef\u7528\uff0c\u53ef\u4ee5\u901a\u8fc7 ",(0,l.jsx)(n.code,{children:"scope"})," \u6807\u7b7e\u8bbe\u5b9a\u5176\u4f5c\u7528\u8303\u56f4\uff0c\u6709\u4e09\u79cd\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e3b\u7a0b\u5e8f\u8303\u56f4\u6709\u6548\uff08src/main \u76ee\u5f55\u8303\u56f4\u5185\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d4b\u8bd5\u7a0b\u5e8f\u8303\u56f4\u5185\u6709\u6548\uff08src/test \u76ee\u5f55\u8303\u56f4\u5185\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u662f\u5426\u53c2\u4e0e\u6253\u5305\uff08package \u6307\u4ee4\u8303\u56f4\u5185\uff09"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"scope"})," \u6807\u7b7e\u7684\u53d6\u503c\u6709\u56db\u79cd\uff1a",(0,l.jsx)(n.code,{children:"compile,test,provided,runtime"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(41679).A+"",width:"965",height:"330"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u4f9d\u8d56\u8303\u56f4\u7684\u4f20\u9012\u6027\uff1a"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(9250).A+"",width:"1182",height:"476"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u751f\u547d\u5468\u671f",children:"\u751f\u547d\u5468\u671f"}),"\n",(0,l.jsx)(n.h3,{id:"\u76f8\u5173\u4e8b\u4ef6",children:"\u76f8\u5173\u4e8b\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"Maven \u7684\u6784\u5efa\u751f\u547d\u5468\u671f\u63cf\u8ff0\u7684\u662f\u4e00\u6b21\u6784\u5efa\u8fc7\u7a0b\u7ecf\u5386\u4e86\u591a\u5c11\u4e2a\u4e8b\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"\u6700\u5e38\u7528\u7684\u4e00\u5957\u6d41\u7a0b\uff1acompile \u2192 test-compile \u2192 test \u2192 package \u2192 install"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"clean\uff1a\u6e05\u7406\u5de5\u4f5c"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"pre-clean\uff1a\u6267\u884c\u4e00\u4e9b\u5728 clean \u4e4b\u524d\u7684\u5de5\u4f5c"}),"\n",(0,l.jsx)(n.li,{children:"clean\uff1a\u79fb\u9664\u4e0a\u4e00\u6b21\u6784\u5efa\u4ea7\u751f\u7684\u6240\u6709\u6587\u4ef6"}),"\n",(0,l.jsx)(n.li,{children:"post-clean\uff1a\u6267\u884c\u4e00\u4e9b\u5728 clean \u4e4b\u540e\u7acb\u523b\u5b8c\u6210\u7684\u5de5\u4f5c"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["default\uff1a\u6838\u5fc3\u5de5\u4f5c\uff0c\u4f8b\u5982\u7f16\u8bd1\uff0c\u6d4b\u8bd5\uff0c\u6253\u5305\uff0c\u90e8\u7f72\u7b49\uff0c\u6bcf\u4e2a\u4e8b\u4ef6\u5728\u6267\u884c\u4e4b\u524d\u90fd\u4f1a",(0,l.jsx)(n.strong,{children:"\u5c06\u4e4b\u524d\u7684\u6240\u6709\u4e8b\u4ef6\u4f9d\u6b21\u6267\u884c\u4e00\u904d"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(14988).A+"",width:"963",height:"619"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"site\uff1a\u4ea7\u751f\u62a5\u544a\uff0c\u53d1\u5e03\u7ad9\u70b9\u7b49"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"pre-site\uff1a\u6267\u884c\u4e00\u4e9b\u5728\u751f\u6210\u7ad9\u70b9\u6587\u6863\u4e4b\u524d\u7684\u5de5\u4f5c"}),"\n",(0,l.jsx)(n.li,{children:"site\uff1a\u751f\u6210\u9879\u76ee\u7684\u7ad9\u70b9\u6587\u6863"}),"\n",(0,l.jsx)(n.li,{children:"post-site\uff1a\u6267\u884c\u4e00\u4e9b\u5728\u751f\u6210\u7ad9\u70b9\u6587\u6863\u4e4b\u540e\u5b8c\u6210\u7684\u5de5\u4f5c\uff0c\u5e76\u4e3a\u90e8\u7f72\u505a\u51c6\u5907"}),"\n",(0,l.jsx)(n.li,{children:"site-deploy\uff1a\u5c06\u751f\u6210\u7684\u7ad9\u70b9\u6587\u6863\u90e8\u7f72\u5230\u7279\u5b9a\u7684\u670d\u52a1\u5668\u4e0a"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6267\u884c\u4e8b\u4ef6",children:"\u6267\u884c\u4e8b\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"Maven \u7684\u63d2\u4ef6\u7528\u6765\u6267\u884c\u751f\u547d\u5468\u671f\u4e2d\u7684\u76f8\u5173\u4e8b\u4ef6"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u63d2\u4ef6\u4e0e\u751f\u547d\u5468\u671f\u5185\u7684\u9636\u6bb5\u7ed1\u5b9a\uff0c\u5728\u6267\u884c\u5230\u5bf9\u5e94\u751f\u547d\u5468\u671f\u65f6\u6267\u884c\u5bf9\u5e94\u7684\u63d2\u4ef6"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Maven \u9ed8\u8ba4\u5728\u5404\u4e2a\u751f\u547d\u5468\u671f\u4e0a\u90fd\u7ed1\u5b9a\u4e86\u9884\u5148\u8bbe\u5b9a\u7684\u63d2\u4ef6\u6765\u5b8c\u6210\u76f8\u5e94\u529f\u80fd"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u63d2\u4ef6\u8fd8\u53ef\u4ee5\u5b8c\u6210\u4e00\u4e9b\u81ea\u5b9a\u4e49\u529f\u80fd"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<build>    \n    <plugins>        \n        <plugin>           \n            <groupId>org.apache.maven.plugins</groupId>           \n            <artifactId>maven-source-plugin</artifactId>           \n            <version>2.2.1</version>           \n            \x3c!--\u6267\u884c--\x3e          \n            <excutions>               \n                \x3c!--\u5177\u4f53\u6267\u884c\u4f4d\u7f6e--\x3e              \n                <excution>                   \n                    <goals>                      \n                        \x3c!--\u5bf9\u6e90\u7801\u8fdb\u884c\u6253\u5305\uff0c\u6253\u5305\u653e\u5728target\u76ee\u5f55--\x3e                    \t\n                        <goal>jar</goal>                      \n                        \x3c!--\u5bf9\u6d4b\u8bd5\u4ee3\u7801\u8fdb\u884c\u6253\u5305--\x3e                       \n                        <goal>test-jar</goal>                 \n                    </goals>                  \n                    \x3c!--\u6267\u884c\u7684\u751f\u547d\u5468\u671f--\x3e                 \n                    <phase>generate-test-resources</phase>                 \n                </excution>         \n            </excutions>       \n        </plugin>   \n    </plugins>\n</build>\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u6a21\u5757\u5f00\u53d1",children:"\u6a21\u5757\u5f00\u53d1"}),"\n",(0,l.jsx)(n.h3,{id:"\u62c6\u5206",children:"\u62c6\u5206"}),"\n",(0,l.jsx)(n.p,{children:"\u5de5\u7a0b\u6a21\u5757\u4e0e\u6a21\u5757\u5212\u5206\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(33103).A+"",width:"895",height:"406"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ssm_pojo \u62c6\u5206"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u65b0\u5efa\u6a21\u5757\uff0c\u62f7\u8d1d\u539f\u59cb\u9879\u76ee\u4e2d\u5bf9\u5e94\u7684\u76f8\u5173\u5185\u5bb9\u5230 ssm_pojo \u6a21\u5757\u4e2d"}),"\n",(0,l.jsx)(n.li,{children:"\u5b9e\u4f53\u7c7b\uff08User\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u914d\u7f6e\u6587\u4ef6\uff08\u65e0\uff09"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ssm_dao \u62c6\u5206"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u65b0\u5efa\u6a21\u5757"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u62f7\u8d1d\u539f\u59cb\u9879\u76ee\u4e2d\u5bf9\u5e94\u7684\u76f8\u5173\u5185\u5bb9\u5230 ssm_dao \u6a21\u5757\u4e2d"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u5c42\u63a5\u53e3\uff08UserDao\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u6587\u4ef6\uff1a\u4fdd\u7559\u4e0e\u6570\u636e\u5c42\u76f8\u5173\u914d\u7f6e\u6587\u4ef6(3 \u4e2a\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u5206\u9875\u63d2\u4ef6\u5728\u914d\u7f6e\u4e2d\u4e0e SqlSessionFactoryBean \u7ed1\u5b9a\uff0c\u9700\u8981\u4fdd\u7559"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"pom.xml\uff1a\u5f15\u5165\u6570\u636e\u5c42\u76f8\u5173\u5750\u6807\u5373\u53ef\uff0c\u5220\u9664 SpringMVC \u76f8\u5173\u5750\u6807"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Spring"}),"\n",(0,l.jsx)(n.li,{children:"MyBatis"}),"\n",(0,l.jsx)(n.li,{children:"Spring \u6574\u5408 MyBatis"}),"\n",(0,l.jsx)(n.li,{children:"MySQL"}),"\n",(0,l.jsx)(n.li,{children:"druid"}),"\n",(0,l.jsx)(n.li,{children:"pagehelper"}),"\n",(0,l.jsx)(n.li,{children:"\u76f4\u63a5\u4f9d\u8d56 ssm_pojo\uff08\u5bf9 ssm_pojo \u6a21\u5757\u6267\u884c install \u6307\u4ee4\uff0c\u5c06\u5176\u5b89\u88c5\u5230\u672c\u5730\u4ed3\u5e93\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependencies>    \x3c!--\u5bfc\u5165\u8d44\u6e90\u6587\u4ef6pojo--\x3e    \n    <dependency>       \n        <groupId>demo</groupId>        \n        <artifactId>ssm_pojo</artifactId>      \n        <version>1.0-SNAPSHOT</version>\n    </dependency>  \n    \x3c!--spring\u73af\u5883--\x3e   \n    \x3c!--mybatis\u73af\u5883--\x3e  \n    \x3c!--mysql\u73af\u5883--\x3e  \n    \x3c!--spring\u6574\u5408jdbc--\x3e   \n    \x3c!--spring\u6574\u5408mybatis--\x3e  \n    \x3c!--druid\u8fde\u63a5\u6c60--\x3e  \n    \x3c!--\u5206\u9875\u63d2\u4ef6\u5750\u6807--\x3e   \n</dependencies>\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ssm_service \u62c6\u5206"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u65b0\u5efa\u6a21\u5757"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u62f7\u8d1d\u539f\u59cb\u9879\u76ee\u4e2d\u5bf9\u5e94\u7684\u76f8\u5173\u5185\u5bb9\u5230 ssm_service \u6a21\u5757\u4e2d"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e1a\u52a1\u5c42\u63a5\u53e3\u4e0e\u5b9e\u73b0\u7c7b\uff08UserService\u3001UserServiceImpl\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u6587\u4ef6\uff1a\u4fdd\u7559\u4e0e\u6570\u636e\u5c42\u76f8\u5173\u914d\u7f6e\u6587\u4ef6(1 \u4e2a\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"pom.xml\uff1a\u5f15\u5165\u6570\u636e\u5c42\u76f8\u5173\u5750\u6807\u5373\u53ef\uff0c\u5220\u9664 SpringMVC \u76f8\u5173\u5750\u6807"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"spring"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"junit"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"spring \u6574\u5408 junit"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u76f4\u63a5\u4f9d\u8d56 ssm_dao\uff08\u5bf9 ssm_dao \u6a21\u5757\u6267\u884c install \u6307\u4ee4\uff0c\u5c06\u5176\u5b89\u88c5\u5230\u672c\u5730\u4ed3\u5e93\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u95f4\u63a5\u4f9d\u8d56 ssm_pojo\uff08\u7531 ssm_dao \u6a21\u5757\u8d1f\u8d23\u4f9d\u8d56\u5173\u7cfb\u7684\u5efa\u7acb\uff09"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4fee\u6539 service \u6a21\u5757 Spring \u6838\u5fc3\u914d\u7f6e\u6587\u4ef6\u540d\uff0c\u6dfb\u52a0\u6a21\u5757\u540d\u79f0\uff0c\u683c\u5f0f\uff1aapplicationContext-service.xml"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4fee\u6539 dao \u6a21\u5757 Spring \u6838\u5fc3\u914d\u7f6e\u6587\u4ef6\u540d\uff0c\u6dfb\u52a0\u6a21\u5757\u540d\u79f0\uff0c\u683c\u5f0f\uff1aapplicationContext-dao.xml"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4fee\u6539\u5355\u5143\u6d4b\u8bd5\u5f15\u5165\u7684\u914d\u7f6e\u6587\u4ef6\u540d\u79f0\uff0c\u7531\u5355\u4e2a\u6587\u4ef6\u4fee\u6539\u4e3a\u591a\u4e2a\u6587\u4ef6"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ssm_control \u62c6\u5206"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u65b0\u5efa\u6a21\u5757\uff08\u4f7f\u7528 webapp \u6a21\u677f\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u62f7\u8d1d\u539f\u59cb\u9879\u76ee\u4e2d\u5bf9\u5e94\u7684\u76f8\u5173\u5185\u5bb9\u5230 ssm_controller \u6a21\u5757\u4e2d"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u73b0\u5c42\u63a7\u5236\u5668\u7c7b\u4e0e\u76f8\u5173\u8bbe\u7f6e\u7c7b\uff08UserController\u3001\u5f02\u5e38\u76f8\u5173\u2026\u2026\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u6587\u4ef6\uff1a\u4fdd\u7559\u4e0e\u8868\u73b0\u5c42\u76f8\u5173\u914d\u7f6e\u6587\u4ef6(1 \u4e2a\uff09\u3001\u670d\u52a1\u5668\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\uff081 \u4e2a\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"pom.xml\uff1a\u5f15\u5165\u6570\u636e\u5c42\u76f8\u5173\u5750\u6807\u5373\u53ef\uff0c\u5220\u9664 SpringMVC \u76f8\u5173\u5750\u6807"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"spring"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"springmvc"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"jackson"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"servlet"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"tomcat \u670d\u52a1\u5668\u63d2\u4ef6"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u76f4\u63a5\u4f9d\u8d56 ssm_service\uff08\u5bf9 ssm_service \u6a21\u5757\u6267\u884c install \u6307\u4ee4\uff0c\u5c06\u5176\u5b89\u88c5\u5230\u672c\u5730\u4ed3\u5e93\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u95f4\u63a5\u4f9d\u8d56 ssm_dao\u3001ssm_pojo"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependencies>   \n    \x3c!--\u5bfc\u5165\u8d44\u6e90\u6587\u4ef6service--\x3e    \n    <dependency>      \n        <groupId>demo</groupId>         \n        <artifactId>ssm_service</artifactId>   \n        <version>1.0-SNAPSHOT</version>     \n    </dependency>  \n    \x3c!--springmvc\u73af\u5883--\x3e  \n    \x3c!--jackson\u76f8\u5173\u5750\u68073\u4e2a--\x3e \n    \x3c!--servlet\u73af\u5883--\x3e \n</dependencies> \n<build>   \n    \x3c!--\u8bbe\u7f6e\u63d2\u4ef6--\x3e    \n    <plugins>    \n        \x3c!--\u5177\u4f53\u7684\u63d2\u4ef6\u914d\u7f6e--\x3e  \n        <plugin>\n        </plugin> \n    </plugins> \n</build>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4fee\u6539 web.xml \u914d\u7f6e\u6587\u4ef6\u4e2d\u52a0\u8f7d Spring \u73af\u5883\u7684\u914d\u7f6e\u6587\u4ef6\u540d\u79f0\uff0c\u4f7f\u7528*\u901a\u914d\uff0c\u52a0\u8f7d\u6240\u6709 applicationContext- \u5f00\u59cb\u7684\u914d\u7f6e\u6587\u4ef6\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!--\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6--\x3e\n<context-param>   \n    <param-name>contextConfigLocation</param-name>  \n    <param-value>classpath*:applicationContext-*.xml</param-value>\n</context-param>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"spring-mvc"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:'<mvc:annotation-driven/><context:component-scan base-package="controller"/>\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u805a\u5408",children:"\u805a\u5408"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u805a\u5408\u7528\u4e8e\u5feb\u901f\u6784\u5efa Maven \u5de5\u7a0b\uff0c\u4e00\u6b21\u6027\u6784\u5efa\u591a\u4e2a\u9879\u76ee/\u6a21\u5757"}),"\n",(0,l.jsx)(n.p,{children:"\u5236\u4f5c\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa\u4e00\u4e2a\u7a7a\u6a21\u5757\uff0c\u6253\u5305\u7c7b\u578b\u5b9a\u4e49\u4e3a pom"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<packaging>pom</packaging>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u4e49\u5f53\u524d\u6a21\u5757\u8fdb\u884c\u6784\u5efa\u64cd\u4f5c\u65f6\u5173\u8054\u7684\u5176\u4ed6\u6a21\u5757\u540d\u79f0"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?><project xmlns="............">   \n    <modelVersion>4.0.0</modelVersion>   \n    <groupId>demo</groupId>  \n    <artifactId>ssm</artifactId> \n    <version>1.0-SNAPSHOT</version>\n    \x3c!--\u5b9a\u4e49\u8be5\u5de5\u7a0b\u7528\u4e8e\u6784\u5efa\u7ba1\u7406--\x3e  \n    <packaging>pom</packaging>   \n    \x3c!--\u7ba1\u7406\u7684\u5de5\u7a0b\u5217\u8868--\x3e   \n    <modules>       \n        \x3c!--\u5177\u4f53\u7684\u5de5\u7a0b\u540d\u79f0--\x3e     \n        <module>../ssm_pojo</module>   \n        <module>../ssm_dao</module>  \n        <module>../ssm_service</module>\n        <module>../ssm_controller</module>   \n    </modules></project>\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\u4e8b\u9879\uff1a\u53c2\u4e0e\u805a\u5408\u64cd\u4f5c\u7684\u6a21\u5757\u6700\u7ec8\u6267\u884c\u987a\u5e8f\u4e0e\u6a21\u5757\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u6709\u5173\uff0c\u4e0e\u914d\u7f6e\u987a\u5e8f\u65e0\u5173"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u7ee7\u627f",children:"\u7ee7\u627f"}),"\n",(0,l.jsx)(n.p,{children:"Maven \u4e2d\u7684\u7ee7\u627f\u4e0e Java \u4e2d\u7684\u7ee7\u627f\u76f8\u4f3c\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5728\u5b50\u5de5\u7a0b\u4e2d\u6cbf\u7528\u7236\u5de5\u7a0b\u4e2d\u7684\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"dependencyManagement \u91cc\u53ea\u662f\u58f0\u660e\u4f9d\u8d56\uff0c\u5e76\u4e0d\u5b9e\u73b0\u5f15\u5165\uff0c\u6240\u4ee5\u5b50\u5de5\u7a0b\u9700\u8981\u663e\u5f0f\u58f0\u660e\u9700\u8981\u7528\u7684\u4f9d\u8d56"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u5b50\u5de5\u7a0b\u4e2d\u672a\u58f0\u660e\u4f9d\u8d56\uff0c\u5219\u4e0d\u4f1a\u4ece\u7236\u9879\u76ee\u7ee7\u627f\u4e0b\u6765"}),"\n",(0,l.jsx)(n.li,{children:"\u5728\u5b50\u5de5\u7a0b\u4e2d\u58f0\u660e\u8be5\u4f9d\u8d56\u9879\uff0c\u5e76\u4e14\u4e0d\u6307\u5b9a\u5177\u4f53\u7248\u672c\uff0c\u624d\u4f1a\u4ece\u7236\u9879\u76ee\u4e2d\u7ee7\u627f\u8be5\u9879\uff0cversion \u548c scope \u90fd\u7ee7\u627f\u53d6\u81ea\u7236\u5de5\u7a0b pom \u6587\u4ef6"}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u5b50\u5de5\u7a0b\u4e2d\u6307\u5b9a\u4e86\u7248\u672c\u53f7\uff0c\u90a3\u4e48\u4f7f\u7528\u5b50\u5de5\u7a0b\u4e2d\u6307\u5b9a\u7684 jar \u7248\u672c"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5236\u4f5c\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5728\u5b50\u5de5\u7a0b\u4e2d\u58f0\u660e\u5176\u7236\u5de5\u7a0b\u5750\u6807\u4e0e\u5bf9\u5e94\u7684\u4f4d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!--\u5b9a\u4e49\u8be5\u5de5\u7a0b\u7684\u7236\u5de5\u7a0b--\x3e\n<parent>   \n    <groupId>com.seazean</groupId>  \n    <artifactId>ssm</artifactId>   \n    <version>1.0-SNAPSHOT</version>  \n    \x3c!--\u586b\u5199\u7236\u5de5\u7a0b\u7684pom\u6587\u4ef6--\x3e   \n    <relativePath>../ssm/pom.xml</relativePath>\n</parent>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ee7\u627f\u4f9d\u8d56\u7684\u5b9a\u4e49\uff1a\u5728\u7236\u5de5\u7a0b\u4e2d\u5b9a\u4e49\u4f9d\u8d56\u7ba1\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!--\u58f0\u660e\u6b64\u5904\u8fdb\u884c\u4f9d\u8d56\u7ba1\u7406\uff0c\u7248\u672c\u9501\u5b9a--\x3e\n<dependencyManagement>   \n    \x3c!--\u5177\u4f53\u7684\u4f9d\u8d56--\x3e    \n    <dependencies>      \n        \x3c!--spring\u73af\u5883--\x3e   \n        <dependency>       \n            <groupId>org.springframework</groupId>   \n            <artifactId>spring-context</artifactId>  \n            <version>5.1.9.RELEASE</version>      \n        </dependency>     \n        \x3c!--\u7b49\u7b49\u6240\u6709--\x3e  \n    </dependencies>\n</dependencyManagement>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u7ee7\u627f\u4f9d\u8d56\u7684\u4f7f\u7528\uff1a\u5728\u5b50\u5de5\u7a0b\u4e2d\u5b9a\u4e49\u4f9d\u8d56\u5173\u7cfb\uff0c",(0,l.jsx)(n.strong,{children:"\u65e0\u9700\u58f0\u660e\u4f9d\u8d56\u7248\u672c"}),"\uff0c\u7248\u672c\u53c2\u7167\u7236\u5de5\u7a0b\u4e2d\u4f9d\u8d56\u7684\u7248\u672c"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependencies> \n    \x3c!--spring\u73af\u5883--\x3e  \n    <dependency>    \n        <groupId>org.springframework</groupId>    \n        <artifactId>spring-context</artifactId>  \n    </dependency>\n</dependencies>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ee7\u627f\u7684\u8d44\u6e90\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"groupId\uff1a\u9879\u76ee\u7ec4ID\uff0c\u9879\u76ee\u5750\u6807\u7684\u6838\u5fc3\u5143\u7d20\nversion\uff1a\u9879\u76ee\u7248\u672c\uff0c\u9879\u76ee\u5750\u6807\u7684\u6838\u5fc3\u56e0\u7d20\ndescription\uff1a\u9879\u76ee\u7684\u63cf\u8ff0\u4fe1\u606f\norganization\uff1a\u9879\u76ee\u7684\u7ec4\u7ec7\u4fe1\u606f\ninceptionYear\uff1a\u9879\u76ee\u7684\u521b\u59cb\u5e74\u4efd\nurl\uff1a\u9879\u76ee\u7684URL\u5730\u5740\ndevelopers\uff1a\u9879\u76ee\u7684\u5f00\u53d1\u8005\u4fe1\u606f\ncontributors\uff1a\u9879\u76ee\u7684\u8d21\u732e\u8005\u4fe1\u606f\ndistributionManagement\uff1a\u9879\u76ee\u7684\u90e8\u7f72\u914d\u7f6e\nissueManagement\uff1a\u9879\u76ee\u7684\u7f3a\u9677\u8ddf\u8e2a\u7cfb\u7edf\u4fe1\u606f\nciManagement\uff1a\u9879\u76ee\u7684\u6301\u7eed\u96c6\u6210\u7cfb\u7edf\u4fe1\u606f\nscm\uff1a\u9879\u76ee\u7684\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u4fe1\u606f\nmalilingLists\uff1a\u9879\u76ee\u7684\u90ae\u4ef6\u5217\u8868\u4fe1\u606f\nproperties\uff1a\u81ea\u5b9a\u4e49\u7684Maven\u5c5e\u6027\ndependencies\uff1a\u9879\u76ee\u7684\u4f9d\u8d56\u914d\u7f6e\ndependencyManagement\uff1a\u9879\u76ee\u7684\u4f9d\u8d56\u7ba1\u7406\u914d\u7f6e\nrepositories\uff1a\u9879\u76ee\u7684\u4ed3\u5e93\u914d\u7f6e\nbuild\uff1a\u5305\u62ec\u9879\u76ee\u7684\u6e90\u7801\u76ee\u5f55\u914d\u7f6e\u3001\u8f93\u51fa\u76ee\u5f55\u914d\u7f6e\u3001\u63d2\u4ef6\u914d\u7f6e\u3001\u63d2\u4ef6\u7ba1\u7406\u914d\u7f6e\u7b49\nreporting\uff1a\u5305\u62ec\u9879\u76ee\u7684\u62a5\u544a\u8f93\u51fa\u76ee\u5f55\u914d\u7f6e\u3001\u62a5\u544a\u63d2\u4ef6\u914d\u7f6e\u7b49\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ee7\u627f\u4e0e\u805a\u5408\uff1a"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u805a\u5408\u7528\u4e8e\u5feb\u901f\u6784\u5efa\u9879\u76ee"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ee7\u627f\u7528\u4e8e\u5feb\u901f\u914d\u7f6e"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u76f8\u540c\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u805a\u5408\u4e0e\u7ee7\u627f\u7684 pom.xml \u6587\u4ef6\u6253\u5305\u65b9\u5f0f\u5747\u4e3a pom\uff0c\u53ef\u4ee5\u5c06\u4e24\u79cd\u5173\u7cfb\u5236\u4f5c\u5230\u540c\u4e00\u4e2a pom \u6587\u4ef6\u4e2d"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u805a\u5408\u4e0e\u7ee7\u627f\u5747\u5c5e\u4e8e\u8bbe\u8ba1\u578b\u6a21\u5757\uff0c\u5e76\u65e0\u5b9e\u9645\u7684\u6a21\u5757\u5185\u5bb9"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4e0d\u540c\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u805a\u5408\u662f\u5728\u5f53\u524d\u6a21\u5757\u4e2d\u914d\u7f6e\u5173\u7cfb\uff0c\u805a\u5408\u53ef\u4ee5\u611f\u77e5\u5230\u53c2\u4e0e\u805a\u5408\u7684\u6a21\u5757\u6709\u54ea\u4e9b"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ee7\u627f\u662f\u5728\u5b50\u6a21\u5757\u4e2d\u914d\u7f6e\u5173\u7cfb\uff0c\u7236\u6a21\u5757\u65e0\u6cd5\u611f\u77e5\u54ea\u4e9b\u5b50\u6a21\u5757\u7ee7\u627f\u4e86\u81ea\u5df1"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5c5e\u6027",children:"\u5c5e\u6027"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7248\u672c\u7edf\u4e00\u7684\u91cd\u8981\u6027\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(33135).A+"",width:"697",height:"383"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5c5e\u6027\u7c7b\u522b\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u81ea\u5b9a\u4e49\u5c5e\u6027"}),"\n",(0,l.jsx)(n.li,{children:"\u5185\u7f6e\u5c5e\u6027"}),"\n",(0,l.jsx)(n.li,{children:"setting \u5c5e\u6027"}),"\n",(0,l.jsx)(n.li,{children:"Java \u7cfb\u7edf\u5c5e\u6027"}),"\n",(0,l.jsx)(n.li,{children:"\u73af\u5883\u53d8\u91cf\u5c5e\u6027"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u7b49\u540c\u4e8e\u5b9a\u4e49\u53d8\u91cf\uff0c\u65b9\u4fbf\u7edf\u4e00\u7ef4\u62a4"}),"\n",(0,l.jsx)(n.p,{children:"\u5b9a\u4e49\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!--\u5b9a\u4e49\u81ea\u5b9a\u4e49\u5c5e\u6027\uff0c\u653e\u5728dependencyManagement\u4e0a\u65b9--\x3e\n<properties>    \n    <spring.version>5.1.9.RELEASE</spring.version>    \n    <junit.version>4.12</junit.version>\n</properties>\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u805a\u5408\u4e0e\u7ee7\u627f\u7684 pom.xml \u6587\u4ef6\u6253\u5305\u65b9\u5f0f\u5747\u4e3a pom\uff0c\u53ef\u4ee5\u5c06\u4e24\u79cd\u5173\u7cfb\u5236\u4f5c\u5230\u540c\u4e00\u4e2a pom \u6587\u4ef6\u4e2d"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u805a\u5408\u4e0e\u7ee7\u627f\u5747\u5c5e\u4e8e\u8bbe\u8ba1\u578b\u6a21\u5757\uff0c\u5e76\u65e0\u5b9e\u9645\u7684\u6a21\u5757\u5185\u5bb9"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u8c03\u7528\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>    \n    <groupId>org.springframework</groupId>    \n    <artifactId>spring-context</artifactId>    \n    <version>${spring.version}</version>\n</dependency>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5185\u7f6e\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u4f7f\u7528 Maven \u5185\u7f6e\u5c5e\u6027\uff0c\u5feb\u901f\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u8c03\u7528\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"${project.basedir} or ${project.basedir}  \x3c!--../ssm\u6839\u76ee\u5f55--\x3e${version} or ${project.version}\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"vresion \u662f 1.0-SNAPSHOT"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<groupId>demo</groupId>\n<artifactId>ssm</artifactId>\n<version>1.0-SNAPSHOT</version>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"setting \u5c5e\u6027"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4f7f\u7528 Maven \u914d\u7f6e\u6587\u4ef6 setting.xml \u4e2d\u7684\u6807\u7b7e\u5c5e\u6027\uff0c\u7528\u4e8e\u52a8\u6001\u914d\u7f6e"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u8c03\u7528\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"${settings.localRepository} \n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Java \u7cfb\u7edf\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u8bfb\u53d6 Java \u7cfb\u7edf\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"\u8c03\u7528\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"${user.home}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u7cfb\u7edf\u5c5e\u6027\u67e5\u8be2\u65b9\u5f0f cmd \u547d\u4ee4\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"mvn help:system \n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u73af\u5883\u53d8\u91cf\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u4f7f\u7528 Maven \u914d\u7f6e\u6587\u4ef6 setting.xml \u4e2d\u7684\u6807\u7b7e\u5c5e\u6027\uff0c\u7528\u4e8e\u52a8\u6001\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u8c03\u7528\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"${env.JAVA_HOME} \n"})}),"\n",(0,l.jsx)(n.p,{children:"\u73af\u5883\u53d8\u91cf\u5c5e\u6027\u67e5\u8be2\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"mvn help:system \n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5de5\u7a0b\u7248\u672c",children:"\u5de5\u7a0b\u7248\u672c"}),"\n",(0,l.jsx)(n.p,{children:"SNAPSHOT\uff08\u5feb\u7167\u7248\u672c\uff09"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9879\u76ee\u5f00\u53d1\u8fc7\u7a0b\u4e2d\uff0c\u4e3a\u65b9\u4fbf\u56e2\u961f\u6210\u5458\u5408\u4f5c\uff0c\u89e3\u51b3\u6a21\u5757\u95f4\u76f8\u4e92\u4f9d\u8d56\u548c\u65f6\u65f6\u66f4\u65b0\u7684\u95ee\u9898\uff0c\u5f00\u53d1\u8005\u5bf9\u6bcf\u4e2a\u6a21\u5757\u8fdb\u884c\u6784\u5efa\u7684\u65f6\u5019\uff0c\u8f93\u51fa\u7684\u4e34\u65f6\u6027\u7248\u672c\u53eb\u5feb\u7167\u7248\u672c\uff08\u6d4b\u8bd5\u9636\u6bb5\u7248\u672c\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5feb\u7167\u7248\u672c\u4f1a\u968f\u7740\u5f00\u53d1\u7684\u8fdb\u5c55\u4e0d\u65ad\u66f4\u65b0"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"RELEASE\uff08\u53d1\u5e03\u7248\u672c\uff09"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u9879\u76ee\u5f00\u53d1\u5230\u8fdb\u5165\u9636\u6bb5\u91cc\u7a0b\u7891\u540e\uff0c\u5411\u56e2\u961f\u5916\u90e8\u53d1\u5e03\u8f83\u4e3a\u7a33\u5b9a\u7684\u7248\u672c\uff0c\u8fd9\u79cd\u7248\u672c\u6240\u5bf9\u5e94\u7684\u6784\u4ef6\u6587\u4ef6\u662f\u7a33\u5b9a\u7684\uff0c\u5373\u4fbf\u8fdb\u884c\u529f\u80fd\u7684\u540e\u7eed\u5f00\u53d1\uff0c\u4e5f\u4e0d\u4f1a\u6539\u53d8\u5f53\u524d\u53d1\u5e03\u7248\u672c\u5185\u5bb9\uff0c\u8fd9\u79cd\u7248\u672c\u79f0\u4e3a\u53d1\u5e03\u7248\u672c"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u7ea6\u5b9a\u89c4\u8303\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"<\u4e3b\u7248\u672c>.<\u6b21\u7248\u672c>.<\u589e\u91cf\u7248\u672c>.<\u91cc\u7a0b\u7891\u7248\u672c>"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e3b\u7248\u672c\uff1a\u8868\u793a\u9879\u76ee\u91cd\u5927\u67b6\u6784\u7684\u53d8\u66f4\uff0c\u5982\uff1aSpring5 \u76f8\u8f83\u4e8e Spring4 \u7684\u8fed\u4ee3"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6b21\u7248\u672c\uff1a\u8868\u793a\u6709\u8f83\u5927\u7684\u529f\u80fd\u589e\u52a0\u548c\u53d8\u5316\uff0c\u6216\u8005\u5168\u9762\u7cfb\u7edf\u5730\u4fee\u590d\u6f0f\u6d1e"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u589e\u91cf\u7248\u672c\uff1a\u8868\u793a\u6709\u91cd\u5927\u6f0f\u6d1e\u7684\u4fee\u590d"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u91cc\u7a0b\u7891\u7248\u672c\uff1a\u8868\u660e\u4e00\u4e2a\u7248\u672c\u7684\u91cc\u7a0b\u7891\uff08\u7248\u672c\u5185\u90e8\uff09\u3002\u8fd9\u6837\u7684\u7248\u672c\u540c\u4e0b\u4e00\u4e2a\u6b63\u5f0f\u7248\u672c\u76f8\u6bd4\uff0c\u76f8\u5bf9\u6765\u8bf4\u4e0d\u662f\u5f88\u7a33\u5b9a\uff0c\u6709\u5f85\u66f4\u591a\u7684\u6d4b\u8bd5"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u8d44\u6e90\u914d\u7f6e",children:"\u8d44\u6e90\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u5728\u4efb\u610f\u914d\u7f6e\u6587\u4ef6\u4e2d\u52a0\u8f7d pom \u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u5c5e\u6027"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7236\u6587\u4ef6 pom.xml"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<properties>    \n    <jdbc.url>jdbc:mysql://192.168.0.137:3306/ssm_db?useSSL=false</jdbc.url></properties>\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5f00\u542f\u914d\u7f6e\u6587\u4ef6\u52a0\u8f7d pom \u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!--\u914d\u7f6e\u8d44\u6e90\u6587\u4ef6\u5bf9\u5e94\u7684\u4fe1\u606f--\x3e\n<resources>  \n    <resource>   \n        \x3c!--\u8bbe\u5b9a\u914d\u7f6e\u6587\u4ef6\u5bf9\u5e94\u7684\u4f4d\u7f6e\u76ee\u5f55\uff0c\u652f\u6301\u4f7f\u7528\u5c5e\u6027\u52a8\u6001\u8bbe\u5b9a\u8def\u5f84--\x3e     \n        <directory>${project.basedir}/src/main/resources</directory> \n        \x3c!--\u5f00\u542f\u5bf9\u914d\u7f6e\u6587\u4ef6\u7684\u8d44\u6e90\u52a0\u8f7d\u8fc7\u6ee4--\x3e  \n        <filtering>true</filtering>   \n    </resource>\n</resources>\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"properties \u6587\u4ef6\u4e2d\u8c03\u7528\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-properties",children:"jdbc.driver=com.mysql.jdbc.Driverjdbc.url=${jdbc.url}\njdbc.username=rootjdbc.password=123456\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u591a\u73af\u5883\u914d\u7f6e",children:"\u591a\u73af\u5883\u914d\u7f6e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u73af\u5883\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\x3c!--\u521b\u5efa\u591a\u73af\u5883--\x3e\n<profiles>   \n    \x3c!--\u5b9a\u4e49\u5177\u4f53\u7684\u73af\u5883\uff1a\u751f\u4ea7\u73af\u5883--\x3e  \n    <profile>     \n        \x3c!--\u5b9a\u4e49\u73af\u5883\u5bf9\u5e94\u7684\u552f\u4e00\u540d\u79f0--\x3e        \n        <id>pro_env</id>    \n        \x3c!--\u5b9a\u4e49\u73af\u5883\u4e2d\u4e13\u7528\u7684\u5c5e\u6027\u503c--\x3e    \n        <properties>           \n            <jdbc.url>jdbc:mysql://127.1.1.1:3306/ssm_db</jdbc.url>     \n        </properties>     \n        \x3c!--\u8bbe\u7f6e\u9ed8\u8ba4\u542f\u52a8--\x3e    \n        <activation>      \n            <activeByDefault>true</activeByDefault> \n        </activation>\n    </profile>   \n    \x3c!--\u5b9a\u4e49\u5177\u4f53\u7684\u73af\u5883\uff1a\u5f00\u53d1\u73af\u5883--\x3e   \n    <profile>     \n        <id>dev_env</id>\n        \u2026\u2026  \n    </profile>\n</profiles>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u52a0\u8f7d\u6307\u5b9a\u73af\u5883"}),"\n",(0,l.jsx)(n.p,{children:"\u4f5c\u7528\uff1a\u52a0\u8f7d\u6307\u5b9a\u73af\u5883\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u8c03\u7528\u683c\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"mvn \u6307\u4ee4 \u2013P \u73af\u5883\u5b9a\u4e49id\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u8303\u4f8b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"mvn install \u2013P pro_env\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u8df3\u8fc7\u6d4b\u8bd5",children:"\u8df3\u8fc7\u6d4b\u8bd5"}),"\n",(0,l.jsx)(n.p,{children:"\u547d\u4ee4\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"mvn \u6307\u4ee4 \u2013D skipTests\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\u4e8b\u9879\uff1a\u6267\u884c\u7684\u6307\u4ee4\u751f\u547d\u5468\u671f\u5fc5\u987b\u5305\u542b\u6d4b\u8bd5\u73af\u8282"}),"\n",(0,l.jsx)(n.p,{children:"IEDA \u754c\u9762\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(51091).A+"",width:"407",height:"341"})}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u8df3\u8fc7\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<plugin>  \n    \x3c!--<groupId>org.apache.maven</groupId>--\x3e  \n    <artifactId>maven-surefire-plugin</artifactId> \n    <version>2.22.1</version> \n    <configuration>     \n        <skipTests>true</skipTests>\x3c!--\u8bbe\u7f6e\u8df3\u8fc7\u6d4b\u8bd5--\x3e \n        <includes> \x3c!--\u5305\u542b\u6307\u5b9a\u7684\u6d4b\u8bd5\u7528\u4f8b--\x3e      \n            <include>**/User*Test.java</include>    \n        </includes>    \n        <excludes>\x3c!--\u6392\u9664\u6307\u5b9a\u7684\u6d4b\u8bd5\u7528\u4f8b--\x3e      \n            <exclude>**/User*TestCase.java</exclude>   \n        </excludes>   \n    </configuration>\n</plugin>\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u79c1\u670d",children:"\u79c1\u670d"}),"\n",(0,l.jsx)(n.h3,{id:"nexus",children:"Nexus"}),"\n",(0,l.jsx)(n.p,{children:"Nexus \u662f Sonatype \u516c\u53f8\u7684\u4e00\u6b3e Maven \u79c1\u670d\u4ea7\u54c1"}),"\n",(0,l.jsxs)(n.p,{children:["\u4e0b\u8f7d\u5730\u5740\uff1a",(0,l.jsx)(n.a,{href:"https://help.sonatype.com/repomanager3/download",children:"https://help.sonatype.com/repomanager3/download"})]}),"\n",(0,l.jsx)(n.p,{children:"\u542f\u52a8\u670d\u52a1\u5668\uff08\u547d\u4ee4\u884c\u542f\u52a8\uff09\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"nexus.exe /run nexus\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u8bbf\u95ee\u670d\u52a1\u5668\uff08\u9ed8\u8ba4\u7aef\u53e3\uff1a8081\uff09\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"http://localhost:8081\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u4fee\u6539\u57fa\u7840\u914d\u7f6e\u4fe1\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5b89\u88c5\u8def\u5f84\u4e0b etc \u76ee\u5f55\u4e2d nexus-default.properties \u6587\u4ef6\u4fdd\u5b58\u6709 nexus \u57fa\u7840\u914d\u7f6e\u4fe1\u606f\uff0c\u4f8b\u5982\u9ed8\u8ba4\u8bbf\u95ee\u7aef\u53e3"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4fee\u6539\u670d\u52a1\u5668\u8fd0\u884c\u914d\u7f6e\u4fe1\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5b89\u88c5\u8def\u5f84\u4e0b bin \u76ee\u5f55\u4e2d nexus.vmoptions \u6587\u4ef6\u4fdd\u5b58\u6709 nexus \u670d\u52a1\u5668\u542f\u52a8\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u4f8b\u5982\u9ed8\u8ba4\u5360\u7528\u5185\u5b58\u7a7a\u95f4"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u8d44\u6e90\u64cd\u4f5c",children:"\u8d44\u6e90\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(82534).A+"",width:"756",height:"345"})}),"\n",(0,l.jsx)(n.p,{children:"\u4ed3\u5e93\u5206\u7c7b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5bbf\u4e3b\u4ed3\u5e93 hosted"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u4fdd\u5b58\u65e0\u6cd5\u4ece\u4e2d\u592e\u4ed3\u5e93\u83b7\u53d6\u7684\u8d44\u6e90\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u81ea\u4e3b\u7814\u53d1"}),"\n",(0,l.jsx)(n.li,{children:"\u7b2c\u4e09\u65b9\u975e\u5f00\u6e90\u9879\u76ee"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4ee3\u7406\u4ed3\u5e93 proxy"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4ee3\u7406\u8fdc\u7a0b\u4ed3\u5e93\uff0c\u901a\u8fc7 nexus \u8bbf\u95ee\u5176\u4ed6\u516c\u5171\u4ed3\u5e93\uff0c\u4f8b\u5982\u4e2d\u592e\u4ed3\u5e93"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4ed3\u5e93\u7ec4 group"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5c06\u82e5\u5e72\u4e2a\u4ed3\u5e93\u7ec4\u6210\u4e00\u4e2a\u7fa4\u7ec4\uff0c\u7b80\u5316\u914d\u7f6e"}),"\n",(0,l.jsx)(n.li,{children:"\u4ed3\u5e93\u7ec4\u4e0d\u80fd\u4fdd\u5b58\u8d44\u6e90\uff0c\u5c5e\u4e8e\u8bbe\u8ba1\u578b\u4ed3\u5e93"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u8d44\u6e90\u4e0a\u4f20\uff0c\u4e0a\u4f20\u8d44\u6e90\u65f6\u63d0\u4f9b\u5bf9\u5e94\u7684\u4fe1\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4fdd\u5b58\u7684\u4f4d\u7f6e\uff08\u5bbf\u4e3b\u4ed3\u5e93\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8d44\u6e90\u6587\u4ef6"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5bf9\u5e94\u5750\u6807"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"idea\u64cd\u4f5c",children:"IDEA\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h4,{id:"\u4e0a\u4f20\u4e0b\u8f7d",children:"\u4e0a\u4f20\u4e0b\u8f7d"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(43448).A+"",width:"775",height:"347"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u8bbf\u95ee\u79c1\u670d",children:"\u8bbf\u95ee\u79c1\u670d"}),"\n",(0,l.jsx)(n.h5,{id:"\u672c\u5730\u8bbf\u95ee",children:"\u672c\u5730\u8bbf\u95ee"}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u672c\u5730\u4ed3\u5e93\u8bbf\u95ee\u79c1\u670d\u7684\u6743\u9650\uff08setting.xml\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<servers>  \n    <server>     \n        <id>heima-release</id>      \n        <username>admin</username> \n        <password>admin</password>   \n    </server>  \n    <server>   \n        <id>heima-snapshots</id>  \n        <username>admin</username>   \n        <password>admin</password>  \n    </server>\n</servers>\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u672c\u5730\u4ed3\u5e93\u8d44\u6e90\u6765\u6e90\uff08setting.xml\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<mirrors> \n    <mirror>  \n        <id>nexus-heima</id>  \n        <mirrorOf>*</mirrorOf>    \n        <url>http://localhost:8081/repository/maven-public/</url> \n    </mirror>\n</mirrors>\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5de5\u7a0b\u8bbf\u95ee",children:"\u5de5\u7a0b\u8bbf\u95ee"}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u5f53\u524d\u9879\u76ee\u8bbf\u95ee\u79c1\u670d\u4e0a\u4f20\u8d44\u6e90\u7684\u4fdd\u5b58\u4f4d\u7f6e\uff08pom.xml\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<distributionManagement> \n    <repository>    \n        <id>heima-release</id>      \n        <url>http://localhost:8081/repository/heima-release/</url> \n    </repository>\n    <snapshotRepository>   \n        <id>heima-snapshots</id> \n        <url>http://localhost:8081/repository/heima-snapshots/</url> \n    </snapshotRepository>\n</distributionManagement>\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u53d1\u5e03\u8d44\u6e90\u5230\u79c1\u670d\u547d\u4ee4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"mvn deploy\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u65e5\u5fd7",children:"\u65e5\u5fd7"}),"\n",(0,l.jsx)(n.h3,{id:"log4j",children:"Log4j"}),"\n",(0,l.jsx)(n.p,{children:"\u7a0b\u5e8f\u4e2d\u7684\u65e5\u5fd7\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u7a0b\u5e8f\u5728\u8fd0\u884c\u65f6\u5019\u7684\u8be6\u60c5\uff0c\u5e76\u53ef\u4ee5\u8fdb\u884c\u6c38\u4e45\u5b58\u50a8\u3002"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{}),(0,l.jsx)(n.th,{children:"\u8f93\u51fa\u8bed\u53e5"}),(0,l.jsx)(n.th,{children:"\u65e5\u5fd7\u6280\u672f"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u53d6\u6d88\u65e5\u5fd7"}),(0,l.jsx)(n.td,{children:"\u9700\u8981\u4fee\u6539\u4ee3\u7801\uff0c\u7075\u6d3b\u6027\u6bd4\u8f83\u5dee"}),(0,l.jsx)(n.td,{children:"\u4e0d\u9700\u8981\u4fee\u6539\u4ee3\u7801\uff0c\u7075\u6d3b\u6027\u6bd4\u8f83\u597d"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u8f93\u51fa\u4f4d\u7f6e"}),(0,l.jsx)(n.td,{children:"\u53ea\u80fd\u662f\u63a7\u5236\u53f0"}),(0,l.jsx)(n.td,{children:"\u53ef\u4ee5\u5c06\u65e5\u5fd7\u4fe1\u606f\u5199\u5165\u5230\u6587\u4ef6\u6216\u8005\u6570\u636e\u5e93\u4e2d"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u591a\u7ebf\u7a0b"}),(0,l.jsx)(n.td,{children:"\u548c\u4e1a\u52a1\u4ee3\u7801\u5904\u4e8e\u4e00\u4e2a\u7ebf\u7a0b\u4e2d"}),(0,l.jsx)(n.td,{children:"\u591a\u7ebf\u7a0b\u65b9\u5f0f\u8bb0\u5f55\u65e5\u5fd7\uff0c\u4e0d\u5f71\u54cd\u4e1a\u52a1\u4ee3\u7801\u7684\u6027\u80fd"})]})]})]}),"\n",(0,l.jsx)(n.p,{children:"Log4j \u662f Apache \u7684\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee\u3002\u4f7f\u7528 Log4j\uff0c\u901a\u8fc7\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u7075\u6d3b\u5730\u8fdb\u884c\u914d\u7f6e\uff0c\u800c\u4e0d\u9700\u8981\u4fee\u6539\u5e94\u7528\u7684\u4ee3\u7801\u3002\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u65e5\u5fd7\u4fe1\u606f\u8f93\u9001\u7684\u76ee\u7684\u5730\u662f\u63a7\u5236\u53f0\u3001\u6587\u4ef6\u7b49\u4f4d\u7f6e\uff0c\u4e5f\u53ef\u4ee5\u63a7\u5236\u6bcf\u4e00\u6761\u65e5\u5fd7\u7684\u8f93\u51fa\u683c\u5f0f\u3002"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(78676).A+"",width:"916",height:"418"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u914d\u7f6e\u6587\u4ef6",children:"\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u6587\u4ef6\u7684\u4e09\u4e2a\u6838\u5fc3\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u6839 Logger"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u683c\u5f0f\uff1alog4j.rootLogger=\u65e5\u5fd7\u7ea7\u522b\uff0cappenderName1\uff0cappenderName2\uff0c\u2026"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u65e5\u5fd7\u7ea7\u522b\uff1a\u5e38\u89c1\u7684\u4e94\u4e2a\u7ea7\u522b\uff1a",(0,l.jsx)(n.strong,{children:"DEBUG < INFO < WARN < ERROR < FATAL"}),"\uff08\u53ef\u4ee5\u81ea\u5b9a\u4e49\uff09\nLog4j \u89c4\u5219\uff1a\u53ea\u8f93\u51fa\u7ea7\u522b\u4e0d\u4f4e\u4e8e\u8bbe\u5b9a\u7ea7\u522b\u7684\u65e5\u5fd7\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"appenderName1\uff1a\u6307\u5b9a\u65e5\u5fd7\u4fe1\u606f\u8981\u8f93\u51fa\u5730\u5740\u3002\u53ef\u4ee5\u540c\u65f6\u6307\u5b9a\u591a\u4e2a\u8f93\u51fa\u76ee\u7684\u5730\uff0c\u7528\u9017\u53f7\u9694\u5f00\uff1a"}),"\n",(0,l.jsx)(n.p,{children:"\u4f8b\u5982\uff1alog4j.rootLogger\uff1dINFO\uff0cca\uff0cfa"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Appenders\uff08\u8f93\u51fa\u6e90\uff09\uff1a\u65e5\u5fd7\u8981\u8f93\u51fa\u7684\u5730\u65b9\uff0c\u5982\u63a7\u5236\u53f0\uff08Console\uff09\u3001\u6587\u4ef6\uff08Files\uff09\u7b49"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Appenders \u53d6\u503c\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"org.apache.log4j.ConsoleAppender\uff08\u63a7\u5236\u53f0\uff09"}),"\n",(0,l.jsx)(n.li,{children:"org.apache.log4j.FileAppender\uff08\u6587\u4ef6\uff09"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ConsoleAppender \u5e38\u7528\u53c2\u6570"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ImmediateFlush=true"}),"\uff1a\u8868\u793a\u6240\u6709\u6d88\u606f\u90fd\u4f1a\u88ab\u7acb\u5373\u8f93\u51fa\uff0c\u8bbe\u4e3a false \u5219\u4e0d\u8f93\u51fa\uff0c\u9ed8\u8ba4\u503c\u662f true"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Target=System.err"}),"\uff1a\u9ed8\u8ba4\u503c\u662f System.out"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"FileAppender\u5e38\u7528\u7684\u9009\u9879"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ImmediateFlush=true"}),"\uff1a\u8868\u793a\u6240\u6709\u6d88\u606f\u90fd\u4f1a\u88ab\u7acb\u5373\u8f93\u51fa\u3002\u8bbe\u4e3a false \u5219\u4e0d\u8f93\u51fa\uff0c\u9ed8\u8ba4\u503c\u662f true"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Append=false"}),"\uff1atrue \u8868\u793a\u5c06\u6d88\u606f\u6dfb\u52a0\u5230\u6307\u5b9a\u6587\u4ef6\u4e2d\uff0c\u539f\u6765\u7684\u6d88\u606f\u4e0d\u8986\u76d6\u3002\u9ed8\u8ba4\u503c\u662f true"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"File=E:/logs/logging.log4j"}),"\uff1a\u6307\u5b9a\u6d88\u606f\u8f93\u51fa\u5230 logging.log4j \u6587\u4ef6\u4e2d"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Layouts (\u5e03\u5c40)\uff1a\u65e5\u5fd7\u8f93\u51fa\u7684\u683c\u5f0f\uff0c\u5e38\u7528\u7684\u5e03\u5c40\u7ba1\u7406\u5668\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"org.apache.log4j.PatternLayout\uff08\u53ef\u4ee5\u7075\u6d3b\u5730\u6307\u5b9a\u5e03\u5c40\u6a21\u5f0f\uff09"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"org.apache.log4j.SimpleLayout\uff08\u5305\u542b\u65e5\u5fd7\u4fe1\u606f\u7684\u7ea7\u522b\u548c\u4fe1\u606f\u5b57\u7b26\u4e32\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"org.apache.log4j.TTCCLayout\uff08\u5305\u542b\u65e5\u5fd7\u4ea7\u751f\u7684\u65f6\u95f4\u3001\u7ebf\u7a0b\u3001\u7c7b\u522b\u7b49\u4fe1\u606f\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["PatternLayout \u5e38\u7528\u7684\u9009\u9879\n",(0,l.jsx)(n.img,{src:s(69062).A+"",width:"826",height:"653"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u65e5\u5fd7\u5e94\u7528",children:"\u65e5\u5fd7\u5e94\u7528"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"log4j \u7684\u914d\u7f6e\u6587\u4ef6,\u540d\u5b57\u4e3a log4j.properties, \u653e\u5728 src \u6839\u76ee\u5f55\u4e0b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-properties",children:"log4j.rootLogger=I\n\n### direct log messages to my ###\nlog4j.appender.my=org.apache.log4j.ConsoleAppender\nlog4j.appender.my.ImmediateFlush = true\nlog4j.appender.my.Target=System.out\nlog4j.appender.my.layout=org.apache.log4j.PatternLayout\nlog4j.appender.my.layout.ConversionPattern=%d %t %5p %c{1}:%L - %m%n\n\n# fileAppender\u6f14\u793a\nlog4j.appender.fileAppender=org.apache.log4j.FileAppender\nlog4j.appender.fileAppender.ImmediateFlush = true\nlog4j.appender.fileAppender.Append=true\nlog4j.appender.fileAppender.File=E:/log4j-log.log\nlog4j.appender.fileAppender.layout=org.apache.log4j.PatternLayout\nlog4j.appender.fileAppender.layout.ConversionPattern=%d %5p %c{1}:%L - %m%n\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d4b\u8bd5\u7c7b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u6d4b\u8bd5\u7c7b\npublic class Log4JTest01 {    \n    //\u4f7f\u7528log4j\u7684api\u6765\u83b7\u53d6\u65e5\u5fd7\u7684\u5bf9\u8c61   \n    //\u5f0a\u7aef\uff1a\u5982\u679c\u4ee5\u540e\u6211\u4eec\u66f4\u6362\u65e5\u5fd7\u7684\u5b9e\u73b0\u7c7b\uff0c\u90a3\u4e48\u4e0b\u9762\u7684\u4ee3\u7801\u5c31\u9700\u8981\u8ddf\u7740\u6539   \n    //\u4e0d\u63a8\u8350\u4f7f\u7528   \n    //private static final Logger LOGGER = Logger.getLogger(Log4JTest01.class);    \n    //\u4f7f\u7528slf4j\u91cc\u9762\u7684api\u6765\u83b7\u53d6\u65e5\u5fd7\u7684\u5bf9\u8c61 \n    //\u597d\u5904\uff1a\u5982\u679c\u4ee5\u540e\u6211\u4eec\u66f4\u6362\u65e5\u5fd7\u7684\u5b9e\u73b0\u7c7b\uff0c\u90a3\u4e48\u4e0b\u9762\u7684\u4ee3\u7801\u4e0d\u9700\u8981\u8ddf\u7740\u4fee\u6539   \n    //\u63a8\u8350\u4f7f\u7528    \n    private static final Logger LOGGER = LoggerFactory.getLogger(Log4JTest01.class);  \n    public static void main(String[] args) {        \n        //1.\u5bfc\u5165jar\u5305        \n        //2.\u7f16\u5199\u914d\u7f6e\u6587\u4ef6        \n        //3.\u5728\u4ee3\u7801\u4e2d\u83b7\u53d6\u65e5\u5fd7\u7684\u5bf9\u8c61        \n        //4.\u6309\u7167\u65e5\u5fd7\u7ea7\u522b\u8bbe\u7f6e\u65e5\u5fd7\u4fe1\u606f        \n        LOGGER.debug("debug\u7ea7\u522b\u7684\u65e5\u5fd7");        \n        LOGGER.info("info\u7ea7\u522b\u7684\u65e5\u5fd7");        \n        LOGGER.warn("warn\u7ea7\u522b\u7684\u65e5\u5fd7");        \n        LOGGER.error("error\u7ea7\u522b\u7684\u65e5\u5fd7");    \n    }\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h1,{id:"netty",children:"Netty"}),"\n",(0,l.jsx)(n.h2,{id:"\u57fa\u672c\u4ecb\u7ecd-1",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"Netty \u662f\u4e00\u4e2a\u5f02\u6b65\u4e8b\u4ef6\u9a71\u52a8\u7684\u7f51\u7edc\u5e94\u7528\u7a0b\u5e8f\u6846\u67b6\uff0c\u7528\u4e8e\u5feb\u901f\u5f00\u53d1\u53ef\u7ef4\u62a4\u3001\u9ad8\u6027\u80fd\u7684\u7f51\u7edc\u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef"}),"\n",(0,l.jsxs)(n.p,{children:["Netty \u5b98\u7f51\uff1a",(0,l.jsx)(n.a,{href:"https://netty.io/",children:"https://netty.io/"})]}),"\n",(0,l.jsx)(n.p,{children:"Netty \u7684\u5bf9 JDK \u81ea\u5e26\u7684 NIO \u7684 API \u8fdb\u884c\u5c01\u88c5\uff0c\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\uff0c\u4e3b\u8981\u7279\u70b9\u6709\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8bbe\u8ba1\u4f18\u96c5\uff0c\u9002\u7528\u4e8e\u5404\u79cd\u4f20\u8f93\u7c7b\u578b\u7684\u7edf\u4e00 API\uff0c \u963b\u585e\u548c\u975e\u963b\u585e Socket \u57fa\u4e8e\u7075\u6d3b\u4e14\u53ef\u6269\u5c55\u7684\u4e8b\u4ef6\u6a21\u578b"}),"\n",(0,l.jsx)(n.li,{children:"\u4f7f\u7528\u65b9\u4fbf\uff0c\u8be6\u7ec6\u8bb0\u5f55\u7684 Javadoc\u3001\u7528\u6237\u6307\u5357\u548c\u793a\u4f8b\uff0c\u6ca1\u6709\u5176\u4ed6\u4f9d\u8d56\u9879"}),"\n",(0,l.jsx)(n.li,{children:"\u9ad8\u6027\u80fd\uff0c\u541e\u5410\u91cf\u66f4\u9ad8\uff0c\u5ef6\u8fdf\u66f4\u4f4e\uff0c\u51cf\u5c11\u8d44\u6e90\u6d88\u8017\uff0c\u6700\u5c0f\u5316\u4e0d\u5fc5\u8981\u7684\u5185\u5b58\u590d\u5236"}),"\n",(0,l.jsx)(n.li,{children:"\u5b89\u5168\uff0c\u5b8c\u6574\u7684 SSL/TLS \u548c StartTLS \u652f\u6301"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Netty \u7684\u529f\u80fd\u7279\u6027\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4f20\u8f93\u670d\u52a1\uff1a\u652f\u6301 BIO \u548c NIO"}),"\n",(0,l.jsx)(n.li,{children:"\u5bb9\u5668\u96c6\u6210\uff1a\u652f\u6301 OSGI\u3001JBossMC\u3001Spring\u3001Guice \u5bb9\u5668"}),"\n",(0,l.jsx)(n.li,{children:"\u534f\u8bae\u652f\u6301\uff1aHTTP\u3001Protobuf\u3001\u4e8c\u8fdb\u5236\u3001\u6587\u672c\u3001WebSocket \u7b49\u4e00\u7cfb\u5217\u534f\u8bae\u90fd\u652f\u6301\uff0c\u4e5f\u652f\u6301\u901a\u8fc7\u5b9e\u884c\u7f16\u7801\u89e3\u7801\u903b\u8f91\u6765\u5b9e\u73b0\u81ea\u5b9a\u4e49\u534f\u8bae"}),"\n",(0,l.jsx)(n.li,{children:"Core \u6838\u5fc3\uff1a\u53ef\u6269\u5c55\u4e8b\u4ef6\u6a21\u578b\u3001\u901a\u7528\u901a\u4fe1 API\u3001\u652f\u6301\u96f6\u62f7\u8d1d\u7684 ByteBuf \u7f13\u51b2\u5bf9\u8c61"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(27261).A+"",width:"1147",height:"662"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u7ebf\u7a0b\u6a21\u578b",children:"\u7ebf\u7a0b\u6a21\u578b"}),"\n",(0,l.jsx)(n.h3,{id:"\u963b\u585e\u6a21\u578b",children:"\u963b\u585e\u6a21\u578b"}),"\n",(0,l.jsx)(n.p,{children:"\u4f20\u7edf\u963b\u585e\u578b I/O \u6a21\u5f0f\uff0c\u6bcf\u4e2a\u8fde\u63a5\u90fd\u9700\u8981\u72ec\u7acb\u7684\u7ebf\u7a0b\u5b8c\u6210\u6570\u636e\u7684\u8f93\u5165\uff0c\u4e1a\u52a1\u5904\u7406\uff0c\u6570\u636e\u8fd4\u56de"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(17451).A+"",width:"788",height:"725"})}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u578b\u7f3a\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5f53\u5e76\u53d1\u6570\u8f83\u5927\u65f6\uff0c\u9700\u8981\u521b\u5efa\u5927\u91cf\u7ebf\u7a0b\u6765\u5904\u7406\u8fde\u63a5\uff0c\u7cfb\u7edf\u8d44\u6e90\u5360\u7528\u8f83\u5927"}),"\n",(0,l.jsx)(n.li,{children:"\u8fde\u63a5\u5efa\u7acb\u540e\uff0c\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u6682\u65f6\u6ca1\u6709\u6570\u636e\u53ef\u8bfb\uff0c\u5219\u7ebf\u7a0b\u5c31\u963b\u585e\u5728 read \u64cd\u4f5c\u4e0a\uff0c\u9020\u6210\u7ebf\u7a0b\u8d44\u6e90\u6d6a\u8d39"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,l.jsx)(n.a,{href:"https://www.jianshu.com/p/2965fca6bb8f",children:"https://www.jianshu.com/p/2965fca6bb8f"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"reactor",children:"Reactor"}),"\n",(0,l.jsx)(n.h4,{id:"\u8bbe\u8ba1\u601d\u60f3",children:"\u8bbe\u8ba1\u601d\u60f3"}),"\n",(0,l.jsxs)(n.p,{children:["Reactor \u6a21\u5f0f\uff0c\u901a\u8fc7\u4e00\u4e2a\u6216\u591a\u4e2a\u8f93\u5165\u540c\u65f6\u4f20\u9012\u7ed9\u670d\u52a1\u5904\u7406\u5668\u7684",(0,l.jsx)(n.strong,{children:"\u4e8b\u4ef6\u9a71\u52a8\u5904\u7406\u6a21\u5f0f"}),"\u3002 \u670d\u52a1\u7aef\u7a0b\u5e8f\u5904\u7406\u4f20\u5165\u7684\u591a\u8def\u8bf7\u6c42\uff0c\u5e76\u5c06\u5b83\u4eec\u540c\u6b65\u5206\u6d3e\u7ed9\u5bf9\u5e94\u7684\u5904\u7406\u7ebf\u7a0b\uff0cReactor \u6a21\u5f0f\u4e5f\u53eb Dispatcher \u6a21\u5f0f\uff0c\u5373 I/O \u591a\u8def\u590d\u7528\u7edf\u4e00\u76d1\u542c\u4e8b\u4ef6\uff0c\u6536\u5230\u4e8b\u4ef6\u540e\u5206\u53d1\uff08Dispatch \u7ed9\u67d0\u7ebf\u7a0b\uff09"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"I/O \u590d\u7528\u7ed3\u5408\u7ebf\u7a0b\u6c60"}),"\uff0c\u5c31\u662f Reactor \u6a21\u5f0f\u57fa\u672c\u8bbe\u8ba1\u601d\u60f3\uff1a"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(68323).A+"",width:"1084",height:"691"})}),"\n",(0,l.jsx)(n.p,{children:"Reactor \u6a21\u5f0f\u5173\u952e\u7ec4\u6210\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Reactor\uff1a\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u4e2d\u8fd0\u884c\uff0c\u8d1f\u8d23",(0,l.jsx)(n.strong,{children:"\u76d1\u542c\u548c\u5206\u53d1\u4e8b\u4ef6"}),"\uff0c\u5206\u53d1\u7ed9\u9002\u5f53\u7684\u5904\u7406\u7a0b\u5e8f\u6765\u5bf9 I/O \u4e8b\u4ef6\u505a\u51fa\u53cd\u5e94"]}),"\n",(0,l.jsxs)(n.li,{children:["Handler\uff1a\u5904\u7406\u7a0b\u5e8f\u6267\u884c I/O \u8981\u5b8c\u6210\u7684\u5b9e\u9645\u4e8b\u4ef6\uff0cReactor \u901a\u8fc7\u8c03\u5ea6\u9002\u5f53\u7684\u5904\u7406\u7a0b\u5e8f\u6765\u54cd\u5e94 I/O \u4e8b\u4ef6\uff0c\u5904\u7406\u7a0b\u5e8f\u6267\u884c",(0,l.jsx)(n.strong,{children:"\u975e\u963b\u585e\u64cd\u4f5c"})]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Reactor \u6a21\u5f0f\u5177\u6709\u5982\u4e0b\u7684\u4f18\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u54cd\u5e94\u5feb\uff0c\u4e0d\u5fc5\u4e3a\u5355\u4e2a\u540c\u6b65\u65f6\u95f4\u6240\u963b\u585e\uff0c\u867d\u7136 Reactor \u672c\u8eab\u4f9d\u7136\u662f\u540c\u6b65\u7684"}),"\n",(0,l.jsx)(n.li,{children:"\u7f16\u7a0b\u76f8\u5bf9\u7b80\u5355\uff0c\u53ef\u4ee5\u6700\u5927\u7a0b\u5ea6\u7684\u907f\u514d\u590d\u6742\u7684\u591a\u7ebf\u7a0b\u53ca\u540c\u6b65\u95ee\u9898\uff0c\u5e76\u4e14\u907f\u514d\u4e86\u591a\u7ebf\u7a0b/\u8fdb\u7a0b\u7684\u5207\u6362\u5f00\u9500"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u6269\u5c55\u6027\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u901a\u8fc7\u589e\u52a0 Reactor \u5b9e\u4f8b\u4e2a\u6570\u6765\u5145\u5206\u5229\u7528 CPU \u8d44\u6e90"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u590d\u7528\u6027\uff0cReactor \u6a21\u578b\u672c\u8eab\u4e0e\u5177\u4f53\u4e8b\u4ef6\u5904\u7406\u903b\u8f91\u65e0\u5173\uff0c\u5177\u6709\u5f88\u9ad8\u7684\u590d\u7528\u6027"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6839\u636e Reactor \u7684\u6570\u91cf\u548c\u5904\u7406\u8d44\u6e90\u6c60\u7ebf\u7a0b\u7684\u6570\u91cf\u4e0d\u540c\uff0c\u6709\u4e09\u79cd\u5178\u578b\u7684\u5b9e\u73b0\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5355 Reactor \u5355\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.li,{children:"\u5355 Reactor \u591a\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.li,{children:"\u4e3b\u4ece Reactor \u591a\u7ebf\u7a0b"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5355r\u5355\u7ebf\u7a0b",children:"\u5355R\u5355\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:"Reactor \u5bf9\u8c61\u901a\u8fc7 select \u76d1\u63a7\u5ba2\u6237\u7aef\u8bf7\u6c42\u4e8b\u4ef6\uff0c\u6536\u5230\u4e8b\u4ef6\u540e\u901a\u8fc7 dispatch \u8fdb\u884c\u5206\u53d1\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u662f\u5efa\u7acb\u8fde\u63a5\u8bf7\u6c42\u4e8b\u4ef6\uff0c\u5219\u7531 Acceptor \u901a\u8fc7 accept \u5904\u7406\u8fde\u63a5\u8bf7\u6c42\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a Handler \u5bf9\u8c61\u5904\u7406\u8fde\u63a5\u5b8c\u6210\u540e\u7684\u540e\u7eed\u4e1a\u52a1\u5904\u7406"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u4e0d\u662f\u5efa\u7acb\u8fde\u63a5\u4e8b\u4ef6\uff0c\u5219 Reactor \u4f1a\u5206\u53d1\u7ed9\u8fde\u63a5\u5bf9\u5e94\u7684 Handler \u6765\u54cd\u5e94\uff0cHandler \u4f1a\u5b8c\u6210 read\u3001\u4e1a\u52a1\u5904\u7406\u3001send \u7684\u5b8c\u6574\u6d41\u7a0b"}),"\n",(0,l.jsxs)(n.p,{children:["\u8bf4\u660e\uff1a",(0,l.jsx)(n.strong,{children:"Handler \u548c Acceptor \u5c5e\u4e8e\u540c\u4e00\u4e2a\u7ebf\u7a0b"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(2509).A+"",width:"955",height:"630"})}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u578b\u4f18\u70b9\uff1a\u6a21\u578b\u7b80\u5355\uff0c\u6ca1\u6709\u591a\u7ebf\u7a0b\u3001\u8fdb\u7a0b\u901a\u4fe1\u3001\u7ade\u4e89\u7684\u95ee\u9898\uff0c\u5168\u90e8\u90fd\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u5b8c\u6210"}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u578b\u7f3a\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6027\u80fd\u95ee\u9898\uff1a\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u65e0\u6cd5\u53d1\u6325\u591a\u6838 CPU \u7684\u6027\u80fd\uff0cHandler \u5728\u5904\u7406\u67d0\u4e2a\u8fde\u63a5\u4e0a\u7684\u4e1a\u52a1\u65f6\uff0c\u6574\u4e2a\u8fdb\u7a0b\u65e0\u6cd5\u5904\u7406\u5176\u4ed6\u8fde\u63a5\u4e8b\u4ef6\uff0c\u5f88\u5bb9\u6613\u5bfc\u81f4\u6027\u80fd\u74f6\u9888"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u9760\u6027\u95ee\u9898\uff1a\u7ebf\u7a0b\u610f\u5916\u8dd1\u98de\uff0c\u6216\u8005\u8fdb\u5165\u6b7b\u5faa\u73af\uff0c\u4f1a\u5bfc\u81f4\u6574\u4e2a\u7cfb\u7edf\u901a\u4fe1\u6a21\u5757\u4e0d\u53ef\u7528\uff0c\u4e0d\u80fd\u63a5\u6536\u548c\u5904\u7406\u5916\u90e8\u6d88\u606f\uff0c\u9020\u6210\u8282\u70b9\u6545\u969c"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528\u573a\u666f\uff1a\u5ba2\u6237\u7aef\u7684\u6570\u91cf\u6709\u9650\uff0c\u4e1a\u52a1\u5904\u7406\u975e\u5e38\u5feb\u901f\uff0c\u6bd4\u5982 Redis\uff0c\u4e1a\u52a1\u5904\u7406\u7684\u65f6\u95f4\u590d\u6742\u5ea6 O(1)"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5355r\u591a\u7ebf\u7a0b",children:"\u5355R\u591a\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:"\u6267\u884c\u6d41\u7a0b\u901a\u540c\u5355 Reactor \u5355\u7ebf\u7a0b\uff0c\u4e0d\u540c\u7684\u662f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Handler \u53ea\u8d1f\u8d23\u54cd\u5e94\u4e8b\u4ef6\uff0c\u4e0d\u505a\u5177\u4f53\u4e1a\u52a1\u5904\u7406\uff0c\u901a\u8fc7 read \u8bfb\u53d6\u6570\u636e\u540e\uff0c\u4f1a\u5206\u53d1\u7ed9\u540e\u9762\u7684 Worker \u7ebf\u7a0b\u6c60\u8fdb\u884c\u4e1a\u52a1\u5904\u7406"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Worker \u7ebf\u7a0b\u6c60\u4f1a\u5206\u914d\u72ec\u7acb\u7684\u7ebf\u7a0b\u5b8c\u6210\u771f\u6b63\u7684\u4e1a\u52a1\u5904\u7406\uff0c\u5c06\u54cd\u5e94\u7ed3\u679c\u53d1\u7ed9 Handler \u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u7531 Handler \u6536\u5230\u54cd\u5e94\u7ed3\u679c\u540e\u901a\u8fc7 send \u5c06\u54cd\u5e94\u7ed3\u679c\u8fd4\u56de\u7ed9 Client"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(64073).A+"",width:"904",height:"869"})}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u578b\u4f18\u70b9\uff1a\u53ef\u4ee5\u5145\u5206\u5229\u7528\u591a\u6838 CPU \u7684\u5904\u7406\u80fd\u529b"}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u578b\u7f3a\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u591a\u7ebf\u7a0b\u6570\u636e\u5171\u4eab\u548c\u8bbf\u95ee\u6bd4\u8f83\u590d\u6742"}),"\n",(0,l.jsx)(n.li,{children:"Reactor \u627f\u62c5\u6240\u6709\u4e8b\u4ef6\u7684\u76d1\u542c\u548c\u54cd\u5e94\uff0c\u5728\u5355\u7ebf\u7a0b\u4e2d\u8fd0\u884c\uff0c\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b\u5bb9\u6613\u6210\u4e3a\u6027\u80fd\u74f6\u9888"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4e3b\u4ece\u6a21\u578b",children:"\u4e3b\u4ece\u6a21\u578b"}),"\n",(0,l.jsx)(n.p,{children:"\u91c7\u7528\u591a\u4e2a Reactor \uff0c\u6267\u884c\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Reactor \u4e3b\u7ebf\u7a0b MainReactor \u901a\u8fc7 select ",(0,l.jsx)(n.strong,{children:"\u76d1\u63a7\u5efa\u7acb\u8fde\u63a5\u4e8b\u4ef6"}),"\uff0c\u6536\u5230\u4e8b\u4ef6\u540e\u901a\u8fc7 Acceptor \u63a5\u6536\uff0c\u5904\u7406\u5efa\u7acb\u8fde\u63a5\u4e8b\u4ef6\uff0c\u5904\u7406\u5b8c\u6210\u540e MainReactor \u4f1a\u5c06\u8fde\u63a5\u5206\u914d\u7ed9 Reactor \u5b50\u7ebf\u7a0b\u7684 SubReactor\uff08\u6709\u591a\u4e2a\uff09\u5904\u7406"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"SubReactor \u5c06\u8fde\u63a5\u52a0\u5165\u8fde\u63a5\u961f\u5217\u8fdb\u884c\u76d1\u542c\u5176\u4ed6\u4e8b\u4ef6\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a Handler \u7528\u4e8e\u5904\u7406\u8be5\u8fde\u63a5\u7684\u4e8b\u4ef6\uff0c\u5f53\u6709\u65b0\u7684\u4e8b\u4ef6\u53d1\u751f\u65f6\uff0cSubReactor \u4f1a\u8c03\u7528\u8fde\u63a5\u5bf9\u5e94\u7684 Handler \u8fdb\u884c\u54cd\u5e94"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Handler \u901a\u8fc7 read \u8bfb\u53d6\u6570\u636e\u540e\uff0c\u4f1a\u5206\u53d1\u7ed9 Worker \u7ebf\u7a0b\u6c60\u8fdb\u884c\u4e1a\u52a1\u5904\u7406"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Worker \u7ebf\u7a0b\u6c60\u4f1a\u5206\u914d\u72ec\u7acb\u7684\u7ebf\u7a0b\u5b8c\u6210\u771f\u6b63\u7684\u4e1a\u52a1\u5904\u7406\uff0c\u5c06\u54cd\u5e94\u7ed3\u679c\u53d1\u7ed9 Handler \u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u7531 Handler \u6536\u5230\u54cd\u5e94\u7ed3\u679c\u540e\u901a\u8fc7 send \u5c06\u54cd\u5e94\u7ed3\u679c\u8fd4\u56de\u7ed9 Client"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(55228).A+"",width:"935",height:"970"})}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u578b\u4f18\u70b9"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u7236\u7ebf\u7a0b\u4e0e\u5b50\u7ebf\u7a0b"}),"\u7684\u6570\u636e\u4ea4\u4e92\u7b80\u5355\u804c\u8d23\u660e\u786e\uff0c\u7236\u7ebf\u7a0b\u53ea\u9700\u8981\u63a5\u6536\u65b0\u8fde\u63a5\uff0c\u5b50\u7ebf\u7a0b\u5b8c\u6210\u540e\u7eed\u7684\u4e1a\u52a1\u5904\u7406"]}),"\n",(0,l.jsx)(n.li,{children:"\u7236\u7ebf\u7a0b\u4e0e\u5b50\u7ebf\u7a0b\u7684\u6570\u636e\u4ea4\u4e92\u7b80\u5355\uff0cReactor \u4e3b\u7ebf\u7a0b\u53ea\u9700\u8981\u628a\u65b0\u8fde\u63a5\u4f20\u7ed9\u5b50\u7ebf\u7a0b\uff0c\u5b50\u7ebf\u7a0b\u65e0\u9700\u8fd4\u56de\u6570\u636e"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528\u573a\u666f\uff1aNginx \u4e3b\u4ece Reactor \u591a\u8fdb\u7a0b\u6a21\u578b\uff0cMemcached \u4e3b\u4ece\u591a\u7ebf\u7a0b\uff0cNetty \u4e3b\u4ece\u591a\u7ebf\u7a0b\u6a21\u578b\u7684\u652f\u6301"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"proactor",children:"Proactor"}),"\n",(0,l.jsxs)(n.p,{children:["Reactor \u6a21\u5f0f\u4e2d\uff0cReactor \u7b49\u5f85\u67d0\u4e2a\u4e8b\u4ef6\u7684\u64cd\u4f5c\u72b6\u6001\u53d1\u751f\u53d8\u5316\uff08\u6587\u4ef6\u63cf\u8ff0\u7b26\u53ef\u8bfb\u5199\uff0csocket \u53ef\u8bfb\u5199\uff09\uff0c\u7136\u540e\u628a\u4e8b\u4ef6\u4f20\u9012\u7ed9\u4e8b\u5148\u6ce8\u518c\u7684 Handler \u6765\u505a\u5b9e\u9645\u7684\u8bfb\u5199\u64cd\u4f5c\uff0c\u5176\u4e2d\u7684\u8bfb\u5199\u64cd\u4f5c\u90fd\u9700\u8981\u5e94\u7528\u7a0b\u5e8f\u540c\u6b65\u64cd\u4f5c\uff0c\u6240\u4ee5 ",(0,l.jsx)(n.strong,{children:"Reactor \u662f\u975e\u963b\u585e\u540c\u6b65\u7f51\u7edc\u6a21\u578b\uff08NIO\uff09"})]}),"\n",(0,l.jsx)(n.p,{children:"\u628a I/O \u64cd\u4f5c\u6539\u4e3a\u5f02\u6b65\uff0c\u4ea4\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u6765\u5b8c\u6210\u5c31\u80fd\u8fdb\u4e00\u6b65\u63d0\u5347\u6027\u80fd\uff0c\u8fd9\u5c31\u662f\u5f02\u6b65\u7f51\u7edc\u6a21\u578b Proactor\uff08AIO\uff09\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(24465).A+"",width:"1116",height:"626"})}),"\n",(0,l.jsx)(n.p,{children:"\u5de5\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"ProactorInitiator \u521b\u5efa Proactor \u548c Handler \u5bf9\u8c61\uff0c\u5e76\u5c06 Proactor \u548c Handler \u901a\u8fc7 Asynchronous Operation Processor\uff08AsyOptProcessor\uff09\u6ce8\u518c\u5230\u5185\u6838"}),"\n",(0,l.jsx)(n.li,{children:"AsyOptProcessor \u5904\u7406\u6ce8\u518c\u8bf7\u6c42\uff0c\u5e76\u5904\u7406 I/O \u64cd\u4f5c\uff0c\u5b8c\u6210I/O\u540e\u901a\u77e5 Proactor"}),"\n",(0,l.jsx)(n.li,{children:"Proactor \u6839\u636e\u4e0d\u540c\u7684\u4e8b\u4ef6\u7c7b\u578b\u56de\u8c03\u4e0d\u540c\u7684 Handler \u8fdb\u884c\u4e1a\u52a1\u5904\u7406\uff0c\u6700\u540e\u7531 Handler \u5b8c\u6210\u4e1a\u52a1\u5904\u7406"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5bf9\u6bd4\uff1aReactor \u5728\u4e8b\u4ef6\u53d1\u751f\u65f6\u5c31\u901a\u77e5\u4e8b\u5148\u6ce8\u518c\u7684\u5904\u7406\u5668\uff08\u8bfb\u5199\u5728\u5e94\u7528\u7a0b\u5e8f\u7ebf\u7a0b\u4e2d\u5904\u7406\u5b8c\u6210\uff09\uff1bProactor \u662f\u5728\u4e8b\u4ef6\u53d1\u751f\u65f6\u57fa\u4e8e\u5f02\u6b65 I/O \u5b8c\u6210\u8bfb\u5199\u64cd\u4f5c\uff08\u5185\u6838\u5b8c\u6210\uff09\uff0cI/O \u5b8c\u6210\u540e\u624d\u56de\u8c03\u5e94\u7528\u7a0b\u5e8f\u7684\u5904\u7406\u5668\u8fdb\u884c\u4e1a\u52a1\u5904\u7406"}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u5f0f\u4f18\u70b9\uff1a\u5f02\u6b65 I/O \u66f4\u52a0\u5145\u5206\u53d1\u6325 DMA\uff08Direct Memory Access \u76f4\u63a5\u5185\u5b58\u5b58\u53d6\uff09\u7684\u4f18\u52bf"}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u5f0f\u7f3a\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7f16\u7a0b\u590d\u6742\u6027\uff0c\u7531\u4e8e\u5f02\u6b65\u64cd\u4f5c\u6d41\u7a0b\u7684\u4e8b\u4ef6\u7684\u521d\u59cb\u5316\u548c\u4e8b\u4ef6\u5b8c\u6210\u5728\u65f6\u95f4\u548c\u7a7a\u95f4\u4e0a\u90fd\u662f\u76f8\u4e92\u5206\u79bb\u7684\uff0c\u56e0\u6b64\u5f00\u53d1\u5f02\u6b65\u5e94\u7528\u7a0b\u5e8f\u66f4\u52a0\u590d\u6742\uff0c\u5e94\u7528\u7a0b\u5e8f\u8fd8\u53ef\u80fd\u56e0\u4e3a\u53cd\u5411\u7684\u6d41\u63a7\u800c\u53d8\u5f97\u66f4\u52a0\u96be\u4ee5\u8c03\u8bd5"}),"\n",(0,l.jsx)(n.li,{children:"\u5185\u5b58\u4f7f\u7528\uff0c\u7f13\u51b2\u533a\u5728\u8bfb\u6216\u5199\u64cd\u4f5c\u7684\u65f6\u95f4\u6bb5\u5185\u5fc5\u987b\u4fdd\u6301\u4f4f\uff0c\u53ef\u80fd\u9020\u6210\u6301\u7eed\u7684\u4e0d\u786e\u5b9a\u6027\uff0c\u5e76\u4e14\u6bcf\u4e2a\u5e76\u53d1\u64cd\u4f5c\u90fd\u8981\u6c42\u6709\u72ec\u7acb\u7684\u7f13\u5b58\uff0cReactor \u6a21\u5f0f\u5728 socket \u51c6\u5907\u597d\u8bfb\u6216\u5199\u4e4b\u524d\u662f\u4e0d\u8981\u6c42\u5f00\u8f9f\u7f13\u5b58\u7684"}),"\n",(0,l.jsx)(n.li,{children:"\u64cd\u4f5c\u7cfb\u7edf\u652f\u6301\uff0cWindows \u4e0b\u901a\u8fc7 IOCP \u5b9e\u73b0\u4e86\u771f\u6b63\u7684\u5f02\u6b65 I/O\uff0c\u800c\u5728 Linux \u7cfb\u7edf\u4e0b\uff0cLinux2.6 \u624d\u5f15\u5165\u5f02\u6b65 I/O\uff0c\u76ee\u524d\u8fd8\u4e0d\u5b8c\u5584\uff0c\u6240\u4ee5\u5728 Linux \u4e0b\u5b9e\u73b0\u9ad8\u5e76\u53d1\u7f51\u7edc\u7f16\u7a0b\u90fd\u662f\u4ee5 Reactor \u6a21\u578b\u4e3a\u4e3b"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"netty-1",children:"Netty"}),"\n",(0,l.jsx)(n.p,{children:"Netty \u4e3b\u8981\u57fa\u4e8e\u4e3b\u4ece Reactors \u591a\u7ebf\u7a0b\u6a21\u578b\u505a\u4e86\u4e00\u5b9a\u7684\u6539\u8fdb\uff0cNetty \u7684\u5de5\u4f5c\u67b6\u6784\u56fe\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(94770).A+"",width:"1146",height:"960"})}),"\n",(0,l.jsx)(n.p,{children:"\u5de5\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Netty \u62bd\u8c61\u51fa\u4e24\u7ec4\u7ebf\u7a0b\u6c60 BossGroup \u4e13\u95e8\u8d1f\u8d23\u63a5\u6536\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0cWorkerGroup \u4e13\u95e8\u8d1f\u8d23\u7f51\u7edc\u7684\u8bfb\u5199"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"BossGroup \u548c WorkerGroup \u7c7b\u578b\u90fd\u662f NioEventLoopGroup\uff0c\u8be5 Group \u76f8\u5f53\u4e8e\u4e00\u4e2a\u4e8b\u4ef6\u5faa\u73af\u7ec4\uff0c\u542b\u6709\u591a\u4e2a\u4e8b\u4ef6\u5faa\u73af\uff0c\u6bcf\u4e00\u4e2a\u4e8b\u4ef6\u5faa\u73af\u662f NioEventLoop\uff0c\u6240\u4ee5\u53ef\u4ee5\u6709\u591a\u4e2a\u7ebf\u7a0b"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["NioEventLoop \u8868\u793a\u4e00\u4e2a",(0,l.jsx)(n.strong,{children:"\u5faa\u73af\u5904\u7406\u4efb\u52a1\u7684\u7ebf\u7a0b"}),"\uff0c\u6bcf\u4e2a NioEventLoop \u90fd\u6709\u4e00\u4e2a Selector\uff0c\u7528\u4e8e\u76d1\u542c\u7ed1\u5b9a\u5728\u5176\u4e0a\u7684 Socket \u7684\u901a\u8baf"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6bcf\u4e2a Boss NioEventLoop \u5faa\u73af\u6267\u884c\u7684\u6b65\u9aa4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8f6e\u8be2 accept \u4e8b\u4ef6"}),"\n",(0,l.jsxs)(n.li,{children:["\u5904\u7406 accept \u4e8b\u4ef6\uff0c\u4e0e client \u5efa\u7acb\u8fde\u63a5\uff0c\u751f\u6210 NioScocketChannel\uff0c\u5e76\u5c06\u5176",(0,l.jsx)(n.strong,{children:"\u6ce8\u518c\u5230\u67d0\u4e2a Worker \u4e2d"}),"\u7684\u67d0\u4e2a NioEventLoop \u4e0a\u7684 Selector\uff0c\u8fde\u63a5\u5c31\u4e0e NioEventLoop \u7ed1\u5b9a"]}),"\n",(0,l.jsx)(n.li,{children:"\u5904\u7406\u4efb\u52a1\u961f\u5217\u7684\u4efb\u52a1\uff0c\u5373 runAllTasks"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6bcf\u4e2a Worker NioEventLoop \u5faa\u73af\u6267\u884c\u7684\u6b65\u9aa4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8f6e\u8be2 read\u3001write \u4e8b\u4ef6"}),"\n",(0,l.jsx)(n.li,{children:"\u5904\u7406 I/O \u4e8b\u4ef6\uff0c\u5373 read\uff0cwrite \u4e8b\u4ef6\uff0c\u5728\u5bf9\u5e94 NioSocketChannel \u5904\u7406"}),"\n",(0,l.jsx)(n.li,{children:"\u5904\u7406\u4efb\u52a1\u961f\u5217\u7684\u4efb\u52a1\uff0c\u5373 runAllTasks"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6bcf\u4e2a Worker NioEventLoop \u5904\u7406\u4e1a\u52a1\u65f6\uff0c\u4f1a\u4f7f\u7528 Pipeline\uff08\u7ba1\u9053\uff09\uff0cPipeline \u4e2d\u5305\u542b\u4e86 Channel\uff0c\u5373\u901a\u8fc7 Pipeline \u53ef\u4ee5\u83b7\u53d6\u5230\u5bf9\u5e94\u901a\u9053\uff0c\u7ba1\u9053\u4e2d\u7ef4\u62a4\u4e86\u5f88\u591a\u7684\u5904\u7406\u5668 Handler"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(40741).A+"",width:"1240",height:"393"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u57fa\u672c\u5b9e\u73b0",children:"\u57fa\u672c\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u5f00\u53d1\u7b80\u5355\u7684\u670d\u52a1\u5668\u7aef\u548c\u5ba2\u6237\u7aef\uff0c\u57fa\u672c\u4ecb\u7ecd\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Channel \u7406\u89e3\u4e3a\u6570\u636e\u7684\u901a\u9053\uff0c\u628a msg \u7406\u89e3\u4e3a\u6d41\u52a8\u7684\u6570\u636e\uff0c\u6700\u5f00\u59cb\u8f93\u5165\u662f ByteBuf\uff0c\u4f46\u7ecf\u8fc7 Pipeline \u7684\u52a0\u5de5\uff0c\u4f1a\u53d8\u6210\u5176\u5b83\u7c7b\u578b\u5bf9\u8c61\uff0c\u6700\u540e\u8f93\u51fa\u53c8\u53d8\u6210 ByteBuf"}),"\n",(0,l.jsx)(n.li,{children:"Handler \u7406\u89e3\u4e3a\u6570\u636e\u7684\u5904\u7406\u5de5\u5e8f\uff0cPipeline \u8d1f\u8d23\u53d1\u5e03\u4e8b\u4ef6\u4f20\u64ad\u7ed9\u6bcf\u4e2a Handler\uff0cHandler \u5bf9\u81ea\u5df1\u611f\u5174\u8da3\u7684\u4e8b\u4ef6\u8fdb\u884c\u5904\u7406\uff08\u91cd\u5199\u4e86\u76f8\u5e94\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5\uff09\uff0c\u5206 Inbound \u548c Outbound \u4e24\u7c7b"}),"\n",(0,l.jsx)(n.li,{children:"EventLoop \u7406\u89e3\u4e3a\u5904\u7406\u6570\u636e\u7684\u6267\u884c\u8005\uff0c\u65e2\u53ef\u4ee5\u6267\u884c IO \u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u8fdb\u884c\u4efb\u52a1\u5904\u7406\u3002\u6bcf\u4e2a\u6267\u884c\u8005\u6709\u4efb\u52a1\u961f\u5217\uff0c\u961f\u5217\u91cc\u53ef\u4ee5\u5806\u653e\u591a\u4e2a Channel \u7684\u5f85\u5904\u7406\u4efb\u52a1\uff0c\u4efb\u52a1\u5206\u4e3a\u666e\u901a\u4efb\u52a1\u3001\u5b9a\u65f6\u4efb\u52a1\u3002\u6309\u7167 Pipeline \u987a\u5e8f\uff0c\u4f9d\u6b21\u6309\u7167 Handler \u7684\u89c4\u5212\uff08\u4ee3\u7801\uff09\u5904\u7406\u6570\u636e"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4ee3\u7801\u5b9e\u73b0\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"pom.xml"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.netty</groupId>\n    <artifactId>netty-all</artifactId>\n    <version>4.1.20.Final</version>\n</dependency>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Server.java"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class HelloServer {\n    public static void main(String[] args) {\n        EventLoopGroup boss = new NioEventLoopGroup();\n        EventLoopGroup worker = new NioEventLoopGroup(2);\n        // 1. \u542f\u52a8\u5668\uff0c\u8d1f\u8d23\u7ec4\u88c5 netty \u7ec4\u4ef6\uff0c\u542f\u52a8\u670d\u52a1\u5668\n        new ServerBootstrap()\n                // 2. \u7ebf\u7a0b\u7ec4\uff0cboss \u53ea\u8d1f\u8d23\u3010\u5904\u7406 accept \u4e8b\u4ef6\u3011\uff0c worker \u53ea\u3010\u8d1f\u8d23 channel \u4e0a\u7684\u8bfb\u5199\u3011\n                .group(boss, worker)\n           \t \t//.option() \t\t// \u7ed9 ServerSocketChannel \u914d\u7f6e\u53c2\u6570\n            \t//.childOption()   \t// \u7ed9 SocketChannel \u914d\u7f6e\u53c2\u6570\n                // 3. \u9009\u62e9\u670d\u52a1\u5668\u7684 ServerSocketChannel \u5b9e\u73b0\n                .channel(NioServerSocketChannel.class)\n                // 4. boss \u8d1f\u8d23\u5904\u7406\u8fde\u63a5\uff0cworker(child) \u8d1f\u8d23\u5904\u7406\u8bfb\u5199\uff0c\u51b3\u5b9a\u4e86\u80fd\u6267\u884c\u54ea\u4e9b\u64cd\u4f5c(handler)\n                .childHandler(new ChannelInitializer<NioSocketChannel>() {\n                    // 5. channel \u4ee3\u8868\u548c\u5ba2\u6237\u7aef\u8fdb\u884c\u6570\u636e\u8bfb\u5199\u7684\u901a\u9053 Initializer \u521d\u59cb\u5316\uff0c\u8d1f\u8d23\u6dfb\u52a0\u522b\u7684 handler\n                    // 7. \u8fde\u63a5\u5efa\u7acb\u540e\uff0c\u6267\u884c\u521d\u59cb\u5316\u65b9\u6cd5\n                    @Override\n                    protected void initChannel(NioSocketChannel ch) throws Exception {\n                        // \u6dfb\u52a0\u5177\u4f53\u7684 handler\n                        ch.pipeline().addLast(new StringDecoder());// \u5c06 ByteBuf \u8f6c\u6210\u5b57\u7b26\u4e32\n                        ch.pipeline().addLast(new ChannelInboundHandlerAdapter() { // \u81ea\u5b9a\u4e49 handler\n                            // \u8bfb\u4e8b\u4ef6\n                            @Override\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) {\n                                // \u6253\u5370\u8f6c\u6362\u597d\u7684\u5b57\u7b26\u4e32\n                                System.out.println(msg);\n                            }\n                        });\n                    }\n                })\n                // 6. \u7ed1\u5b9a\u76d1\u542c\u7aef\u53e3\n                .bind(8080);\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Client.java"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class HelloClient {\n    public static void main(String[] args) throws InterruptedException {\n        // 1. \u521b\u5efa\u542f\u52a8\u5668\u7c7b\n        new Bootstrap()\n                // 2. \u6dfb\u52a0 EventLoop\n                .group(new NioEventLoopGroup())\n            \t//.option()\uff0c\u7ed9 SocketChannel \u914d\u7f6e\u53c2\u6570\n                // 3. \u9009\u62e9\u5ba2\u6237\u7aef channel \u5b9e\u73b0\n                .channel(NioSocketChannel.class)\n                // 4. \u6dfb\u52a0\u5904\u7406\u5668\n                .handler(new ChannelInitializer<NioSocketChannel>() {\n                    // 4.1 \u8fde\u63a5\u5efa\u7acb\u540e\u88ab\u8c03\u7528\n                    @Override\n                    protected void initChannel(NioSocketChannel ch) throws Exception {\n                        // \u5c06 Hello World \u8f6c\u4e3a ByteBuf\n                        ch.pipeline().addLast(new StringEncoder());\n                    }\n                })\n                // 5. \u8fde\u63a5\u5230\u670d\u52a1\u5668\uff0c\u7136\u540e\u8c03\u7528 4.1\n                .connect(new InetSocketAddress("127.0.0.1",8080))\n                // 6. \u963b\u585e\u65b9\u6cd5\uff0c\u76f4\u5230\u8fde\u63a5\u5efa\u7acb\n                .sync()\n                // 7. \u4ee3\u8868\u8fde\u63a5\u5bf9\u8c61\n                .channel()\n                // 8. \u5411\u670d\u52a1\u5668\u53d1\u9001\u6570\u636e\n                .writeAndFlush("Hello World");\n    }\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,l.jsx)(n.a,{href:"https://www.bilibili.com/video/BV1py4y1E7oA",children:"https://www.bilibili.com/video/BV1py4y1E7oA"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u7ec4\u4ef6\u4ecb\u7ecd",children:"\u7ec4\u4ef6\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.h3,{id:"eventloop",children:"EventLoop"}),"\n",(0,l.jsx)(n.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-2",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsxs)(n.p,{children:["\u4e8b\u4ef6\u5faa\u73af\u5bf9\u8c61 EventLoop\uff0c",(0,l.jsx)(n.strong,{children:"\u672c\u8d28\u662f\u4e00\u4e2a\u5355\u7ebf\u7a0b\u6267\u884c\u5668\u540c\u65f6\u7ef4\u62a4\u4e86\u4e00\u4e2a Selector"}),"\uff0c\u6709 run \u65b9\u6cd5\u5904\u7406 Channel \u4e0a\u6e90\u6e90\u4e0d\u65ad\u7684 IO \u4e8b\u4ef6"]}),"\n",(0,l.jsx)(n.p,{children:"\u4e8b\u4ef6\u5faa\u73af\u7ec4 EventLoopGroup \u662f\u4e00\u7ec4 EventLoop\uff0cChannel \u4f1a\u8c03\u7528 Boss EventLoopGroup \u7684 register \u65b9\u6cd5\u6765\u7ed1\u5b9a\u5176\u4e2d\u4e00\u4e2a Worker \u7684 EventLoop\uff0c\u540e\u7eed\u8fd9\u4e2a Channel \u4e0a\u7684 IO \u4e8b\u4ef6\u90fd\u7531\u6b64 EventLoop \u6765\u5904\u7406\uff0c\u4fdd\u8bc1\u4e86\u4e8b\u4ef6\u5904\u7406\u65f6\u7684\u7ebf\u7a0b\u5b89\u5168"}),"\n",(0,l.jsx)(n.p,{children:"EventLoopGroup \u7c7b API\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"EventLoop next()"}),"\uff1a\u83b7\u53d6\u96c6\u5408\u4e2d\u4e0b\u4e00\u4e2a EventLoop\uff0cEventLoopGroup \u5b9e\u73b0\u4e86 Iterable \u63a5\u53e3\u63d0\u4f9b\u904d\u5386 EventLoop \u7684\u80fd\u529b"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Future<?> shutdownGracefully()"}),"\uff1a\u4f18\u96c5\u5173\u95ed\u7684\u65b9\u6cd5\uff0c\u4f1a\u9996\u5148\u5207\u6362 EventLoopGroup \u5230\u5173\u95ed\u72b6\u6001\u4ece\u800c\u62d2\u7edd\u65b0\u7684\u4efb\u52a1\u7684\u52a0\u5165\uff0c\u7136\u540e\u5728\u4efb\u52a1\u961f\u5217\u7684\u4efb\u52a1\u90fd\u5904\u7406\u5b8c\u6210\u540e\uff0c\u505c\u6b62\u7ebf\u7a0b\u7684\u8fd0\u884c\uff0c\u4ece\u800c\u786e\u4fdd\u6574\u4f53\u5e94\u7528\u662f\u5728\u6b63\u5e38\u6709\u5e8f\u7684\u72b6\u6001\u4e0b\u9000\u51fa\u7684"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"<T> Future<T> submit(Callable<T> task)"}),"\uff1a\u63d0\u4ea4\u4efb\u52a1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ScheduledFuture<?> scheduleWithFixedDelay"}),"\uff1a\u63d0\u4ea4\u5b9a\u65f6\u4efb\u52a1"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4efb\u52a1\u4f20\u9012",children:"\u4efb\u52a1\u4f20\u9012"}),"\n",(0,l.jsx)(n.p,{children:"\u628a\u8981\u8c03\u7528\u7684\u4ee3\u7801\u5c01\u88c5\u4e3a\u4e00\u4e2a\u4efb\u52a1\u5bf9\u8c61\uff0c\u7531\u4e0b\u4e00\u4e2a handler \u7684\u7ebf\u7a0b\u6765\u8c03\u7528"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class EventLoopServer {\n    public static void main(String[] args) {\n        EventLoopGroup group = new DefaultEventLoopGroup();\n        new ServerBootstrap()\n                .group(new NioEventLoopGroup(), new NioEventLoopGroup(2))\n                .channel(NioServerSocketChannel.class)\n                .childHandler(new ChannelInitializer<NioSocketChannel>() {\n                    @Override\n                    protected void initChannel(NioSocketChannel ch) {\n                        ch.pipeline().addLast("handler1", new ChannelInboundHandlerAdapter() {\n                            @Override\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) {\n                                ByteBuf buf = (ByteBuf) msg;\n                                log.debug(buf.toString(Charset.defaultCharset()));\n                                ctx.fireChannelRead(msg);   // \u8ba9\u6d88\u606f\u3010\u4f20\u9012\u3011\u7ed9\u4e0b\u4e00\u4e2a handler\n                            }\n                        }).addLast(group, "handler2", new ChannelInboundHandlerAdapter() {\n                            @Override\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) {\n                                ByteBuf buf = (ByteBuf) msg;\n                                log.debug(buf.toString(Charset.defaultCharset()));\n                            }\n                        });\n                    }\n                })\n                .bind(8080);\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6e90\u7801\u5206\u6790\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public ChannelHandlerContext fireChannelRead(final Object msg) {\n    invokeChannelRead(findContextInbound(MASK_CHANNEL_READ), msg);\n    return this;\n}\nstatic void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) {\n    final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, "msg"), next);\n    EventExecutor executor = next.executor();\n    // \u4e0b\u4e00\u4e2a handler \u7684\u4e8b\u4ef6\u5faa\u73af\u662f\u5426\u4e0e\u5f53\u524d\u7684\u4e8b\u4ef6\u5faa\u73af\u662f\u540c\u4e00\u4e2a\u7ebf\u7a0b\n    if (executor.inEventLoop()) {\n        // \u662f\uff0c\u76f4\u63a5\u8c03\u7528\n        next.invokeChannelRead(m);\n    } else {\n        // \u4e0d\u662f\uff0c\u5c06\u8981\u6267\u884c\u7684\u4ee3\u7801\u4f5c\u4e3a\u4efb\u52a1\u63d0\u4ea4\u7ed9\u4e0b\u4e00\u4e2a handler \u5904\u7406\n        executor.execute(new Runnable() {\n            @Override\n            public void run() {\n                next.invokeChannelRead(m);\n            }\n        });\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"channel",children:"Channel"}),"\n",(0,l.jsx)(n.h4,{id:"\u8fde\u63a5\u64cd\u4f5c",children:"\u8fde\u63a5\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:"Channel \u7c7b API\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ChannelFuture close()"}),"\uff1a\u5173\u95ed\u901a\u9053"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ChannelPipeline pipeline()"}),"\uff1a\u6dfb\u52a0\u5904\u7406\u5668"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ChannelFuture write(Object msg)"}),"\uff1a\u6570\u636e\u5199\u5165\u7f13\u51b2\u533a"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ChannelFuture writeAndFlush(Object msg)"}),"\uff1a\u6570\u636e\u5199\u5165\u7f13\u51b2\u533a\u5e76\u4e14\u5237\u51fa"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"ChannelFuture \u7c7b API\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ChannelFuture sync()"}),"\uff1a\u540c\u6b65\u963b\u585e\u7b49\u5f85\u8fde\u63a5\u6210\u529f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ChannelFuture addListener(GenericFutureListener listener)"}),"\uff1a\u5f02\u6b65\u7b49\u5f85"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4ee3\u7801\u5b9e\u73b0\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"connect \u65b9\u6cd5\u662f\u5f02\u6b65\u7684\uff0c\u4e0d\u7b49\u8fde\u63a5\u5efa\u7acb\u5b8c\u6210\u5c31\u8fd4\u56de\uff0c\u56e0\u6b64 channelFuture \u5bf9\u8c61\u4e2d\u4e0d\u80fd\u7acb\u523b\u83b7\u5f97\u5230\u6b63\u786e\u7684 Channel \u5bf9\u8c61\uff0c\u9700\u8981\u7b49\u5f85"}),"\n",(0,l.jsxs)(n.li,{children:["\u8fde\u63a5\u672a\u5efa\u7acb channel \u6253\u5370\u4e3a ",(0,l.jsx)(n.code,{children:"[id: 0x2e1884dd]"}),"\uff1b\u5efa\u7acb\u6210\u529f\u6253\u5370\u4e3a ",(0,l.jsx)(n.code,{children:"[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]"})]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class ChannelClient {\n    public static void main(String[] args) throws InterruptedException {\n        ChannelFuture channelFuture = new Bootstrap()\n                .group(new NioEventLoopGroup())\n                .channel(NioSocketChannel.class)\n                .handler(new ChannelInitializer<NioSocketChannel>() {\n                    @Override\n                    protected void initChannel(NioSocketChannel ch) throws Exception {\n                        ch.pipeline().addLast(new StringEncoder());\n                    }\n                })\n                // 1. \u8fde\u63a5\u670d\u52a1\u5668\uff0c\u3010\u5f02\u6b65\u975e\u963b\u585e\u3011\uff0cmain \u8c03\u7528 connect \u65b9\u6cd5\uff0c\u771f\u6b63\u6267\u884c\u8fde\u63a5\u7684\u662f nio \u7ebf\u7a0b\n                .connect(new InetSocketAddress("127.0.0.1", 8080));\n        // 2.1 \u4f7f\u7528 sync \u65b9\u6cd5\u3010\u540c\u6b65\u3011\u5904\u7406\u7ed3\u679c\uff0c\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\uff0c\u76f4\u5230 nio \u7ebf\u7a0b\u8fde\u63a5\u5efa\u7acb\u5b8c\u6bd5\n        channelFuture.sync();\n        Channel channel = channelFuture.channel();\n        System.out.println(channel); // \u3010\u6253\u5370\u3011\n        // \u5411\u670d\u52a1\u5668\u53d1\u9001\u6570\u636e\n        channel.writeAndFlush("hello world");\n        \n**************************************************************************************\u4e8c\u9009\u4e00\n        // 2.2 \u4f7f\u7528 addListener \u65b9\u6cd5\u3010\u5f02\u6b65\u3011\u5904\u7406\u7ed3\u679c\n        channelFuture.addListener(new ChannelFutureListener() {\n            @Override\n            // nio \u7ebf\u7a0b\u8fde\u63a5\u5efa\u7acb\u597d\u4ee5\u540e\uff0c\u56de\u8c03\u8be5\u65b9\u6cd5\n            public void operationComplete(ChannelFuture future) throws Exception {\n                if (future.isSuccess()) {\n                    Channel channel = future.channel();\n                \tchannel.writeAndFlush("hello, world");\n                } else {\n                    // \u5efa\u7acb\u5931\u8d25\uff0c\u9700\u8981\u5173\u95ed\n                    future.channel().close();\n                }\n            }\n        });\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5173\u95ed\u64cd\u4f5c",children:"\u5173\u95ed\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:"\u5173\u95ed EventLoopGroup \u7684\u8fd0\u884c\uff0c\u5206\u4e3a\u540c\u6b65\u5173\u95ed\u548c\u5f02\u6b65\u5173\u95ed"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class CloseFutureClient {\n    public static void main(String[] args) throws InterruptedException {\n        NioEventLoopGroup group = new NioEventLoopGroup();\n        ChannelFuture channelFuture = new Bootstrap()\n                // ....\n                .connect(new InetSocketAddress("127.0.0.1", 8080));\n        Channel channel = channelFuture.sync().channel();\n        // \u53d1\u9001\u6570\u636e\n        new Thread(() -> {\n            Scanner sc = new Scanner(System.in);\n            while (true) {\n                String line = sc.nextLine();\n                if (line.equals("q")) {\n                    channel.close();\n                    break;\n                }\n                channel.writeAndFlush(line);\n            }\n        }, "input").start();\n        // \u83b7\u53d6 CloseFuture \u5bf9\u8c61\n        ChannelFuture closeFuture = channel.closeFuture();\n        \n        // 1. \u540c\u6b65\u5904\u7406\u5173\u95ed\n        System.out.println("waiting close...");\n        closeFuture.sync();\n        System.out.println("\u5904\u7406\u5173\u95ed\u540e\u7684\u64cd\u4f5c");\n****************************************************\n        // 2. \u5f02\u6b65\u5904\u7406\u5173\u95ed\n        closeFuture.addListener(new ChannelFutureListener() {\n            @Override\n            public void operationComplete(ChannelFuture future) throws Exception {\n                System.out.println("\u5904\u7406\u5173\u95ed\u540e\u7684\u64cd\u4f5c");\n                group.shutdownGracefully();\n            }\n        });\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"future",children:"Future"}),"\n",(0,l.jsx)(n.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-3",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"Netty \u4e2d\u7684 Future \u4e0e JDK \u4e2d\u7684 Future \u540c\u540d\uff0c\u4f46\u662f\u529f\u80fd\u7684\u5b9e\u73b0\u4e0d\u540c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"package io.netty.util.concurrent;\npublic interface Future<V> extends java.util.concurrent.Future<V>\n"})}),"\n",(0,l.jsx)(n.p,{children:"Future \u7c7b API\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"V get()"}),"\uff1a\u963b\u585e\u7b49\u5f85\u83b7\u53d6\u4efb\u52a1\u6267\u884c\u7ed3\u679c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"V getNow()"}),"\uff1a\u975e\u963b\u585e\u83b7\u53d6\u4efb\u52a1\u7ed3\u679c\uff0c\u8fd8\u672a\u4ea7\u751f\u7ed3\u679c\u65f6\u8fd4\u56de null"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Throwable cause()"}),"\uff1a\u975e\u963b\u585e\u83b7\u53d6\u5931\u8d25\u4fe1\u606f\uff0c\u5982\u679c\u6ca1\u6709\u5931\u8d25\uff0c\u8fd4\u56de null"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Future<V> sync()"}),"\uff1a\u7b49\u5f85\u4efb\u52a1\u7ed3\u675f\uff0c\u5982\u679c\u4efb\u52a1\u5931\u8d25\uff0c\u629b\u51fa\u5f02\u5e38"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean cancel(boolean mayInterruptIfRunning)"}),"\uff1a\u53d6\u6d88\u4efb\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Future<V> addListener(GenericFutureListener listener)"}),"\uff1a\u6dfb\u52a0\u56de\u8c03\uff0c\u5f02\u6b65\u63a5\u6536\u7ed3\u679c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean isSuccess()"}),"\uff1a\u5224\u65ad\u4efb\u52a1\u662f\u5426\u6210\u529f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean isCancellable()"}),"\uff1a\u5224\u65ad\u4efb\u52a1\u662f\u5426\u53d6\u6d88"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class NettyFutureDemo {\n    public static void main(String[] args) throws Exception {\n        NioEventLoopGroup group = new NioEventLoopGroup();\n        EventLoop eventLoop = group.next();\n        Future<Integer> future = eventLoop.submit(new Callable<Integer>() {\n            @Override\n            public Integer call() throws Exception {\n                System.out.println("\u6267\u884c\u8ba1\u7b97");\n                Thread.sleep(1000);\n                return 70;\n            }\n        });\n        future.getNow();\n        System.out.println(new Date() + "\u7b49\u5f85\u7ed3\u679c");\n        System.out.println(new Date() + "" + future.get());\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u6269\u5c55\u5b50\u7c7b",children:"\u6269\u5c55\u5b50\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"Promise \u7c7b\u662f Future \u7684\u5b50\u7c7b\uff0c\u53ef\u4ee5\u8131\u79bb\u4efb\u52a1\u72ec\u7acb\u5b58\u5728\uff0c\u4f5c\u4e3a\u4e24\u4e2a\u7ebf\u7a0b\u95f4\u4f20\u9012\u7ed3\u679c\u7684\u5bb9\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public interface Promise<V> extends Future<V>\n"})}),"\n",(0,l.jsx)(n.p,{children:"Promise \u7c7b API\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Promise<V> setSuccess(V result)"}),"\uff1a\u8bbe\u7f6e\u6210\u529f\u7ed3\u679c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Promise<V> setFailure(Throwable cause)"}),"\uff1a\u8bbe\u7f6e\u5931\u8d25\u7ed3\u679c"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class NettyPromiseDemo {\n    public static void main(String[] args) throws Exception {\n        // 1. \u51c6\u5907 EventLoop \u5bf9\u8c61\n        EventLoop eventLoop = new NioEventLoopGroup().next();\n        // 2. \u4e3b\u52a8\u521b\u5efa promise\n        DefaultPromise<Integer> promise = new DefaultPromise<>(eventLoop);\n        // 3. \u4efb\u610f\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u8ba1\u7b97\uff0c\u8ba1\u7b97\u5b8c\u6bd5\u540e\u5411 promise \u586b\u5145\u7ed3\u679c\n        new Thread(() -> {\n            try {\n                Thread.sleep(1000);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            promise.setSuccess(200);\n        }).start();\n\n        // 4. \u63a5\u53d7\u7ed3\u679c\u7684\u7ebf\u7a0b\n        System.out.println(new Date() + "\u7b49\u5f85\u7ed3\u679c");\n        System.out.println(new Date() + "" + promise.get());\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"pipeline",children:"Pipeline"}),"\n",(0,l.jsx)(n.p,{children:"ChannelHandler \u7528\u6765\u5904\u7406 Channel \u4e0a\u7684\u5404\u79cd\u4e8b\u4ef6\uff0c\u5206\u4e3a\u5165\u7ad9\u51fa\u7ad9\u4e24\u79cd\uff0c\u6240\u6709 ChannelHandler \u8fde\u63a5\u6210\u53cc\u5411\u94fe\u8868\u5c31\u662f Pipeline"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5165\u7ad9\u5904\u7406\u5668\u901a\u5e38\u662f ChannelInboundHandlerAdapter \u7684\u5b50\u7c7b\uff0c\u4e3b\u8981\u7528\u6765\u8bfb\u53d6\u5ba2\u6237\u7aef\u6570\u636e\uff0c\u5199\u56de\u7ed3\u679c"}),"\n",(0,l.jsx)(n.li,{children:"\u51fa\u7ad9\u5904\u7406\u5668\u901a\u5e38\u662f ChannelOutboundHandlerAdapter \u7684\u5b50\u7c7b\uff0c\u4e3b\u8981\u5bf9\u5199\u56de\u7ed3\u679c\u8fdb\u884c\u52a0\u5de5\uff08\u5165\u7ad9\u548c\u51fa\u7ad9\u662f\u5bf9\u4e8e\u670d\u52a1\u7aef\u6765\u8bf4\u7684\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public static void main(String[] args) {\n    new ServerBootstrap()\n        .group(new NioEventLoopGroup())\n        .channel(NioServerSocketChannel.class)\n        .childHandler(new ChannelInitializer<NioSocketChannel>() {\n            @Override\n            protected void initChannel(NioSocketChannel ch) throws Exception {\n                // 1. \u901a\u8fc7 channel \u62ff\u5230 pipeline\n                ChannelPipeline pipeline = ch.pipeline();\n                // 2. \u6dfb\u52a0\u5904\u7406\u5668 head -> h1 -> h2 -> h3 -> h4 -> tail\n                pipeline.addLast("h1", new ChannelInboundHandlerAdapter() {\n                    @Override\n                    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n                        log.debug("1");\n                        ByteBuf buf = (ByteBuf) msg;\n                        String s = buf.toString(Charset.defaultCharset());\n                        // \u5c06\u6570\u636e\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2a\u3010\u5165\u7ad9\u3011handler\uff0c\u5982\u679c\u4e0d\u8c03\u7528\u8be5\u65b9\u6cd5\u5219\u94fe\u4f1a\u65ad\u5f00\n                        super.channelRead(ctx, s);\n                    }\n                });\n                pipeline.addLast("h2", new ChannelInboundHandlerAdapter() {\n                    @Override\n                    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n                        log.debug("2");\n                        // \u4ece\u3010\u5c3e\u90e8\u5f00\u59cb\u5411\u524d\u89e6\u53d1\u3011\u51fa\u7ad9\u5904\u7406\u5668\n                        ch.writeAndFlush(ctx.alloc().buffer().writeBytes("server".getBytes()));\n                        // \u8be5\u65b9\u6cd5\u4f1a\u8ba9\u7ba1\u9053\u4ece\u3010\u5f53\u524d handler \u5411\u524d\u3011\u5bfb\u627e\u51fa\u7ad9\u5904\u7406\u5668\n                        // ctx.writeAndFlush();\n                    }\n                });\n                pipeline.addLast("h3", new ChannelOutboundHandlerAdapter() {\n                    @Override\n                    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n                        log.debug("3");\n                        super.write(ctx, msg, promise);\n                    }\n                });\n                pipeline.addLast("h4", new ChannelOutboundHandlerAdapter() {\n                    @Override\n                    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n                        log.debug("4");\n                        super.write(ctx, msg, promise);\n                    }\n                });\n            }\n        })\n        .bind(8080);\n}\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u670d\u52a1\u5668\u7aef\u4f9d\u6b21\u6253\u5370\uff1a1 2 4 3 \uff0c\u6240\u4ee5",(0,l.jsx)(n.strong,{children:"\u5165\u7ad9\u662f\u6309\u7167 addLast \u7684\u987a\u5e8f\u6267\u884c\u7684\uff0c\u51fa\u7ad9\u662f\u6309\u7167 addLast \u7684\u9006\u5e8f\u6267\u884c"})]}),"\n",(0,l.jsx)(n.p,{children:"\u4e00\u4e2a Channel \u5305\u542b\u4e86\u4e00\u4e2a ChannelPipeline\uff0c\u800c ChannelPipeline \u4e2d\u53c8\u7ef4\u62a4\u4e86\u4e00\u4e2a\u7531 ChannelHandlerContext \u7ec4\u6210\u7684\u53cc\u5411\u94fe\u8868\uff0c\u5e76\u4e14\u6bcf\u4e2a ChannelHandlerContext \u4e2d\u5173\u8054\u7740\u4e00\u4e2a ChannelHandler"}),"\n",(0,l.jsx)(n.p,{children:"\u5165\u7ad9\u4e8b\u4ef6\u548c\u51fa\u7ad9\u4e8b\u4ef6\u5728\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\u4e2d\uff0c\u4e24\u79cd\u7c7b\u578b\u7684 handler \u4e92\u4e0d\u5e72\u6270\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5165\u7ad9\u4e8b\u4ef6\u4f1a\u4ece\u94fe\u8868 head \u5f80\u540e\u4f20\u9012\u5230\u6700\u540e\u4e00\u4e2a\u5165\u7ad9\u7684 handler"}),"\n",(0,l.jsx)(n.li,{children:"\u51fa\u7ad9\u4e8b\u4ef6\u4f1a\u4ece\u94fe\u8868 tail \u5f80\u524d\u4f20\u9012\u5230\u6700\u524d\u4e00\u4e2a\u51fa\u7ad9\u7684 handler"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(86918).A+"",width:"1005",height:"255"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"bytebuf",children:"ByteBuf"}),"\n",(0,l.jsx)(n.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-4",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"ByteBuf \u662f\u5bf9\u5b57\u8282\u6570\u636e\u7684\u5c01\u88c5\uff0c\u4f18\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6c60\u5316\uff0c\u53ef\u4ee5\u91cd\u7528\u6c60\u4e2d ByteBuf \u5b9e\u4f8b\uff0c\u66f4\u8282\u7ea6\u5185\u5b58\uff0c\u51cf\u5c11\u5185\u5b58\u6ea2\u51fa\u7684\u53ef\u80fd"}),"\n",(0,l.jsx)(n.li,{children:"\u8bfb\u5199\u6307\u9488\u5206\u79bb\uff0c\u4e0d\u9700\u8981\u50cf ByteBuffer \u4e00\u6837\u5207\u6362\u8bfb\u5199\u6a21\u5f0f"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u4ee5\u81ea\u52a8\u6269\u5bb9"}),"\n",(0,l.jsx)(n.li,{children:"\u652f\u6301\u94fe\u5f0f\u8c03\u7528\uff0c\u4f7f\u7528\u66f4\u6d41\u7545"}),"\n",(0,l.jsx)(n.li,{children:"\u96f6\u62f7\u8d1d\u601d\u60f3\uff0c\u4f8b\u5982 slice\u3001duplicate\u3001CompositeByteBuf"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u521b\u5efa\u65b9\u6cd5",children:"\u521b\u5efa\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa\u65b9\u5f0f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(10)"}),"\uff1a\u521b\u5efa\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u7684 ByteBuf\uff0c\u521d\u59cb\u5bb9\u91cf\u662f 10"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public ByteBuf buffer() {\n    if (directByDefault) {\n        return directBuffer();\n    }\n    return heapBuffer();\n}\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ByteBuf buffer = ByteBufAllocator.DEFAULT.heapBuffer(10)"}),"\uff1a\u521b\u5efa\u6c60\u5316\u57fa\u4e8e\u5806\u7684 ByteBuf"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ByteBuf buffer = ByteBufAllocator.DEFAULT.directBuffer(10)"}),"\uff1a\u521b\u5efa\u6c60\u5316\u57fa\u4e8e\u76f4\u63a5\u5185\u5b58\u7684 ByteBuf"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u63a8\u8350"}),"\u7684\u521b\u5efa\u65b9\u5f0f\uff1a\u5728\u6dfb\u52a0\u5904\u7406\u5668\u7684\u65b9\u6cd5\u4e2d"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"pipeline.addLast(new ChannelInboundHandlerAdapter() {\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n        ByteBuf buffer = ctx.alloc().buffer();\n    }\n});\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u76f4\u63a5\u5185\u5b58\u5bf9\u6bd4\u5806\u5185\u5b58\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u76f4\u63a5\u5185\u5b58\u521b\u5efa\u548c\u9500\u6bc1\u7684\u4ee3\u4ef7\u6602\u8d35\uff0c\u4f46\u8bfb\u5199\u6027\u80fd\u9ad8\uff08\u5c11\u4e00\u6b21\u5185\u5b58\u590d\u5236\uff09\uff0c\u9002\u5408\u914d\u5408\u6c60\u5316\u529f\u80fd\u4e00\u8d77\u7528"}),"\n",(0,l.jsx)(n.li,{children:"\u76f4\u63a5\u5185\u5b58\u5bf9 GC \u538b\u529b\u5c0f\uff0c\u56e0\u4e3a\u8fd9\u90e8\u5206\u5185\u5b58\u4e0d\u53d7 JVM \u5783\u573e\u56de\u6536\u7684\u7ba1\u7406\uff0c\u4f46\u4e5f\u8981\u6ce8\u610f\u53ca\u65f6\u4e3b\u52a8\u91ca\u653e"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u6c60\u5316\u7684\u610f\u4e49\u5728\u4e8e\u53ef\u4ee5",(0,l.jsx)(n.strong,{children:"\u91cd\u7528 ByteBuf"}),"\uff0c\u9ad8\u5e76\u53d1\u65f6\u6c60\u5316\u529f\u80fd\u66f4\u8282\u7ea6\u5185\u5b58\uff0c\u51cf\u5c11\u5185\u5b58\u6ea2\u51fa\u7684\u53ef\u80fd\uff0c\u4e0e\u975e\u6c60\u5316\u5bf9\u6bd4\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u975e\u6c60\u5316\uff0c\u6bcf\u6b21\u90fd\u8981\u521b\u5efa\u65b0\u7684 ByteBuf \u5b9e\u4f8b\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u5bf9\u76f4\u63a5\u5185\u5b58\u4ee3\u4ef7\u6602\u8d35\uff0c\u5806\u5185\u5b58\u4f1a\u589e\u52a0 GC \u538b\u529b"}),"\n",(0,l.jsx)(n.li,{children:"\u6c60\u5316\uff0c\u53ef\u4ee5\u91cd\u7528\u6c60\u4e2d ByteBuf \u5b9e\u4f8b\uff0c\u5e76\u4e14\u91c7\u7528\u4e86\u4e0e jemalloc \u7c7b\u4f3c\u7684\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u63d0\u5347\u5206\u914d\u6548\u7387"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6c60\u5316\u529f\u80fd\u7684\u5f00\u542f\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u6765\u8bbe\u7f6e\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"-Dio.netty.allocator.type={unpooled|pooled}\t # VM \u53c2\u6570\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"4.1 \u4ee5\u540e\uff0c\u975e Android \u5e73\u53f0\u9ed8\u8ba4\u542f\u7528\u6c60\u5316\u5b9e\u73b0\uff0cAndroid \u5e73\u53f0\u542f\u7528\u975e\u6c60\u5316\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.li,{children:"4.1 \u4e4b\u524d\uff0c\u6c60\u5316\u529f\u80fd\u8fd8\u4e0d\u6210\u719f\uff0c\u9ed8\u8ba4\u662f\u975e\u6c60\u5316\u5b9e\u73b0"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u8bfb\u5199\u64cd\u4f5c",children:"\u8bfb\u5199\u64cd\u4f5c"}),"\n",(0,l.jsxs)(n.p,{children:["ByteBuf \u7531\u56db\u90e8\u5206\u7ec4\u6210\uff0c\u6700\u5f00\u59cb\u8bfb\u5199\u6307\u9488\uff08",(0,l.jsx)(n.strong,{children:"\u53cc\u6307\u9488"}),"\uff09\u90fd\u5728 0 \u4f4d\u7f6e"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(95796).A+"",width:"626",height:"195"})}),"\n",(0,l.jsx)(n.p,{children:"\u5199\u5165\u65b9\u6cd5\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u65b9\u6cd5\u540d"}),(0,l.jsx)(n.th,{children:"\u8bf4\u660e"}),(0,l.jsx)(n.th,{children:"\u5907\u6ce8"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"writeBoolean(boolean value)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165 boolean \u503c"}),(0,l.jsx)(n.td,{children:"\u7528\u4e00\u5b57\u8282 01|00 \u4ee3\u8868 true|false"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"writeByte(int value)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165 byte \u503c"}),(0,l.jsx)(n.td,{})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"writeInt(int value)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165 int \u503c"}),(0,l.jsx)(n.td,{children:"Big Endian\uff0c\u5373 0x250\uff0c\u5199\u5165\u540e 00 00 02 50"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"writeIntLE(int value)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165 int \u503c"}),(0,l.jsx)(n.td,{children:"Little Endian\uff0c\u5373 0x250\uff0c\u5199\u5165\u540e 50 02 00 00"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"writeBytes(ByteBuf src)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165 ByteBuf"}),(0,l.jsx)(n.td,{})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"writeBytes(byte[] src)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165 byte[]"}),(0,l.jsx)(n.td,{})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"writeBytes(ByteBuffer src)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165 NIO \u7684 ByteBuffer"}),(0,l.jsx)(n.td,{})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"int writeCharSequence(CharSequence s, Charset c)"}),(0,l.jsx)(n.td,{children:"\u5199\u5165\u5b57\u7b26\u4e32"}),(0,l.jsx)(n.td,{})]})]})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8fd9\u4e9b\u65b9\u6cd5\u7684\u672a\u6307\u660e\u8fd4\u56de\u503c\u7684\uff0c\u5176\u8fd4\u56de\u503c\u90fd\u662f ByteBuf\uff0c\u610f\u5473\u7740\u53ef\u4ee5\u94fe\u5f0f\u8c03\u7528"}),"\n",(0,l.jsx)(n.li,{children:"\u5199\u5165\u51e0\u4f4d\u5199\u6307\u9488\u540e\u79fb\u51e0\u4f4d\uff0c\u6307\u5411\u53ef\u4ee5\u5199\u5165\u7684\u4f4d\u7f6e"}),"\n",(0,l.jsx)(n.li,{children:"\u7f51\u7edc\u4f20\u8f93\uff0c\u9ed8\u8ba4\u4e60\u60ef\u662f Big Endian"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u6269\u5bb9\uff1a\u5199\u5165\u6570\u636e\u65f6\uff0c\u5bb9\u91cf\u4e0d\u591f\u4e86\uff08\u521d\u59cb\u5bb9\u91cf\u662f 10\uff09\uff0c\u8fd9\u65f6\u4f1a\u5f15\u53d1",(0,l.jsx)(n.strong,{children:"\u6269\u5bb9"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u5199\u5165\u540e\u6570\u636e\u5927\u5c0f\u672a\u8d85\u8fc7 512\uff0c\u5219\u9009\u62e9\u4e0b\u4e00\u4e2a 16 \u7684\u6574\u6570\u500d\uff0c\u4f8b\u5982\u5199\u5165\u540e\u5927\u5c0f\u4e3a 12 \uff0c\u5219\u6269\u5bb9\u540e capacity \u662f 16"}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u5199\u5165\u540e\u6570\u636e\u5927\u5c0f\u8d85\u8fc7 512\uff0c\u5219\u9009\u62e9\u4e0b\u4e00\u4e2a 2^n\uff0c\u4f8b\u5982\u5199\u5165\u540e\u5927\u5c0f\u4e3a 513\uff0c\u5219\u6269\u5bb9\u540e capacity \u662f 2^10 = 1024\uff082^9=512 \u4e0d\u591f\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u6269\u5bb9\u4e0d\u80fd\u8d85\u8fc7 max capacity \u4f1a\u62a5\u9519"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u8bfb\u53d6\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"byte readByte()"}),"\uff1a\u8bfb\u53d6\u4e00\u4e2a\u5b57\u8282\uff0c\u8bfb\u6307\u9488\u540e\u79fb"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"byte getByte(int index)"}),"\uff1a\u8bfb\u53d6\u6307\u5b9a\u7d22\u5f15\u4f4d\u7f6e\u7684\u5b57\u8282\uff0c\u8bfb\u6307\u9488\u4e0d\u52a8"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ByteBuf markReaderIndex()"}),"\uff1a\u6807\u8bb0\u8bfb\u6570\u636e\u7684\u4f4d\u7f6e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ByteBuf resetReaderIndex()"}),"\uff1a\u91cd\u7f6e\u5230\u6807\u8bb0\u4f4d\u7f6e\uff0c\u53ef\u4ee5\u91cd\u590d\u8bfb\u53d6\u6807\u8bb0\u4f4d\u7f6e\u5411\u540e\u7684\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5185\u5b58\u91ca\u653e",children:"\u5185\u5b58\u91ca\u653e"}),"\n",(0,l.jsx)(n.p,{children:"Netty \u4e2d\u4e09\u79cd\u5185\u5b58\u7684\u56de\u6536\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"UnpooledHeapByteBuf \u4f7f\u7528\u7684\u662f JVM \u5185\u5b58\uff0c\u53ea\u9700\u7b49 GC \u56de\u6536\u5185\u5b58"}),"\n",(0,l.jsx)(n.li,{children:"UnpooledDirectByteBuf \u4f7f\u7528\u7684\u5c31\u662f\u76f4\u63a5\u5185\u5b58\u4e86\uff0c\u9700\u8981\u7279\u6b8a\u7684\u65b9\u6cd5\u6765\u56de\u6536\u5185\u5b58"}),"\n",(0,l.jsx)(n.li,{children:"PooledByteBuf \u548c\u5b50\u7c7b\u4f7f\u7528\u4e86\u6c60\u5316\u673a\u5236\uff0c\u9700\u8981\u66f4\u590d\u6742\u7684\u89c4\u5219\u6765\u56de\u6536\u5185\u5b58"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Netty \u91c7\u7528\u4e86\u5f15\u7528\u8ba1\u6570\u6cd5\u6765\u63a7\u5236\u56de\u6536\u5185\u5b58\uff0c\u6bcf\u4e2a ByteBuf \u90fd\u5b9e\u73b0\u4e86 ReferenceCounted \u63a5\u53e3\uff0c\u56de\u6536\u7684\u89c4\u5219\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6bcf\u4e2a ByteBuf \u5bf9\u8c61\u7684\u521d\u59cb\u8ba1\u6570\u4e3a 1"}),"\n",(0,l.jsx)(n.li,{children:"\u8c03\u7528 release \u65b9\u6cd5\u8ba1\u6570\u51cf 1\uff0c\u5982\u679c\u8ba1\u6570\u4e3a 0\uff0cByteBuf \u5185\u5b58\u88ab\u56de\u6536"}),"\n",(0,l.jsx)(n.li,{children:"\u8c03\u7528 retain \u65b9\u6cd5\u8ba1\u6570\u52a0 1\uff0c\u8868\u793a\u8c03\u7528\u8005\u6ca1\u7528\u5b8c\u4e4b\u524d\uff0c\u5176\u5b83 handler \u5373\u4f7f\u8c03\u7528\u4e86 release \u4e5f\u4e0d\u4f1a\u9020\u6210\u56de\u6536"}),"\n",(0,l.jsx)(n.li,{children:"\u5f53\u8ba1\u6570\u4e3a 0 \u65f6\uff0c\u5e95\u5c42\u5185\u5b58\u4f1a\u88ab\u56de\u6536\uff0c\u8fd9\u65f6\u5373\u4f7f ByteBuf \u5bf9\u8c61\u8fd8\u5728\uff0c\u5176\u5404\u4e2a\u65b9\u6cd5\u5747\u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"ByteBuf buf = .ByteBufAllocator.DEFAULT.buffer(10)\ntry {\n    // \u903b\u8f91\u5904\u7406\n} finally {\n    buf.release();\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"Pipeline \u7684\u5b58\u5728\uff0c\u9700\u8981\u5c06 ByteBuf \u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2a ChannelHandler\uff0c\u5982\u679c\u5728 finally \u4e2d release \u4e86\uff0c\u5c31\u5931\u53bb\u4e86\u4f20\u9012\u6027\uff0c\u5904\u7406\u89c4\u5219\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa ByteBuf \u653e\u5165 Pipeline"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5165\u7ad9 ByteBuf \u5904\u7406\u539f\u5219"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5bf9\u539f\u59cb ByteBuf \u4e0d\u505a\u5904\u7406\uff0c\u8c03\u7528 ctx.fireChannelRead(msg) \u5411\u540e\u4f20\u9012\uff0c\u8fd9\u65f6\u65e0\u987b release\uff0c\u53cd\u4e4b\u4e0d\u4f20\u9012\u9700\u8981"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5c06\u539f\u59cb ByteBuf \u8f6c\u6362\u4e3a\u5176\u5b83\u7c7b\u578b\u7684 Java \u5bf9\u8c61\uff0c\u8fd9\u65f6 ByteBuf \u5c31\u6ca1\u7528\u4e86\uff0c\u6b64\u65f6\u5fc5\u987b release"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u51fa\u73b0\u5f02\u5e38\uff0cByteBuf \u6ca1\u6709\u6210\u529f\u4f20\u9012\u5230\u4e0b\u4e00\u4e2a ChannelHandler\uff0c\u5fc5\u987b release"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5047\u8bbe\u6d88\u606f\u4e00\u76f4\u5411\u540e\u4f20\uff0c\u90a3\u4e48 TailContext \u4f1a\u8d1f\u8d23\u91ca\u653e\u672a\u5904\u7406\u6d88\u606f\uff08\u539f\u59cb\u7684 ByteBuf\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)\nprotected void onUnhandledInboundMessage(Object msg) {\n    try {\n        logger.debug();\n    } finally {\n        ReferenceCountUtil.release(msg);\n    }\n}\n// io.netty.util.ReferenceCountUtil#release(java.lang.Object)\npublic static boolean release(Object msg) {\n    if (msg instanceof ReferenceCounted) {\n        return ((ReferenceCounted) msg).release();\n    }\n    return false;\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u51fa\u7ad9 ByteBuf \u5904\u7406\u539f\u5219"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u51fa\u7ad9\u6d88\u606f\u6700\u7ec8\u90fd\u4f1a\u8f6c\u4e3a ByteBuf \u8f93\u51fa\uff0c\u4e00\u76f4\u5411\u524d\u4f20\uff0c\u7531 HeadContext flush \u540e release"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e0d\u786e\u5b9a ByteBuf \u88ab\u5f15\u7528\u4e86\u591a\u5c11\u6b21\uff0c\u4f46\u53c8\u5fc5\u987b\u5f7b\u5e95\u91ca\u653e\uff0c\u53ef\u4ee5\u5faa\u73af\u8c03\u7528 release \u76f4\u5230\u8fd4\u56de true"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u62f7\u8d1d\u64cd\u4f5c",children:"\u62f7\u8d1d\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:"\u96f6\u62f7\u8d1d\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ByteBuf slice(int index, int length)"}),"\uff1a\u5bf9\u539f\u59cb ByteBuf \u8fdb\u884c\u5207\u7247\u6210\u591a\u4e2a ByteBuf\uff0c\u5207\u7247\u540e\u7684 ByteBuf \u5e76\u6ca1\u6709\u53d1\u751f\u5185\u5b58\u590d\u5236\uff0c",(0,l.jsx)(n.strong,{children:"\u5171\u7528\u539f\u59cb ByteBuf \u7684\u5185\u5b58"}),"\uff0c\u5207\u7247\u540e\u7684 ByteBuf \u7ef4\u62a4\u72ec\u7acb\u7684 read\uff0cwrite \u6307\u9488"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public static void main(String[] args) {\n    ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(10);\n    buf.writeBytes(new byte[]{'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j'});\n    // \u5728\u5207\u7247\u8fc7\u7a0b\u4e2d\u5e76\u6ca1\u6709\u53d1\u751f\u6570\u636e\u590d\u5236\n    ByteBuf f1 = buf.slice(0, 5);\n    f1.retain();\n    ByteBuf f2 = buf.slice(5, 5);\n    f2.retain();\n    // \u5bf9 f1 \u8fdb\u884c\u76f8\u5173\u7684\u64cd\u4f5c\u4e5f\u4f1a\u4f53\u73b0\u5728 buf \u4e0a\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ByteBuf duplicate()"}),"\uff1a\u622a\u53d6\u539f\u59cb ByteBuf \u6240\u6709\u5185\u5bb9\uff0c\u5e76\u4e14\u6ca1\u6709 max capacity \u7684\u9650\u5236\uff0c\u4e5f\u662f\u4e0e\u539f\u59cb ByteBuf \u4f7f\u7528\u540c\u4e00\u5757\u5e95\u5c42\u5185\u5b58\uff0c\u53ea\u662f\u8bfb\u5199\u6307\u9488\u662f\u72ec\u7acb\u7684"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"CompositeByteBuf addComponents(boolean increaseWriterIndex, ByteBuf... buffers)"}),"\uff1a\u5408\u5e76\u591a\u4e2a ByteBuf"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public static void main(String[] args) {\n    ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer();\n    buf1.writeBytes(new byte[]{1, 2, 3, 4, 5});\n\n    ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer();\n    buf1.writeBytes(new byte[]{6, 7, 8, 9, 10});\n\n    CompositeByteBuf buf = ByteBufAllocator.DEFAULT.compositeBuffer();\n    // true \u8868\u793a\u589e\u52a0\u65b0\u7684 ByteBuf \u81ea\u52a8\u9012\u589e write index, \u5426\u5219 write index \u4f1a\u59cb\u7ec8\u4e3a 0\n    buf.addComponents(true, buf1, buf2);\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"CompositeByteBuf \u662f\u4e00\u4e2a\u7ec4\u5408\u7684 ByteBuf\uff0c\u5185\u90e8\u7ef4\u62a4\u4e86\u4e00\u4e2a Component \u6570\u7ec4\uff0c\u6bcf\u4e2a Component \u7ba1\u7406\u4e00\u4e2a ByteBuf\uff0c\u8bb0\u5f55\u4e86\u8fd9\u4e2a ByteBuf \u76f8\u5bf9\u4e8e\u6574\u4f53\u504f\u79fb\u91cf\u7b49\u4fe1\u606f\uff0c\u4ee3\u8868\u7740\u6574\u4f53\u4e2d\u67d0\u4e00\u6bb5\u7684\u6570\u636e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4f18\u70b9\uff1a\u5bf9\u5916\u662f\u4e00\u4e2a\u865a\u62df\u89c6\u56fe\uff0c\u7ec4\u5408\u8fd9\u4e9b ByteBuf \u4e0d\u4f1a\u4ea7\u751f\u5185\u5b58\u590d\u5236"}),"\n",(0,l.jsx)(n.li,{children:"\u7f3a\u70b9\uff1a\u590d\u6742\u4e86\u5f88\u591a\uff0c\u591a\u6b21\u64cd\u4f5c\u4f1a\u5e26\u6765\u6027\u80fd\u7684\u635f\u8017"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6df1\u62f7\u8d1d\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ByteBuf copy()"}),"\uff1a\u5c06\u5e95\u5c42\u5185\u5b58\u6570\u636e\u8fdb\u884c\u6df1\u62f7\u8d1d\uff0c\u56e0\u6b64\u65e0\u8bba\u8bfb\u5199\uff0c\u90fd\u4e0e\u539f\u59cb ByteBuf \u65e0\u5173"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6c60\u5316\u76f8\u5173\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Unpooled \u662f\u4e00\u4e2a\u5de5\u5177\u7c7b\uff0c\u63d0\u4f9b\u4e86\u975e\u6c60\u5316\u7684 ByteBuf \u521b\u5efa\u3001\u7ec4\u5408\u3001\u590d\u5236\u7b49\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);\nbuf1.writeBytes(new byte[]{1, 2, 3, 4, 5});\nByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);\nbuf2.writeBytes(new byte[]{6, 7, 8, 9, 10});\n\n// \u5f53\u5305\u88c5 ByteBuf \u4e2a\u6570\u8d85\u8fc7\u4e00\u4e2a\u65f6, \u5e95\u5c42\u4f7f\u7528\u4e86 CompositeByteBuf\uff0c\u96f6\u62f7\u8d1d\u601d\u60f3\nByteBuf buf = Unpooled.wrappedBuffer(buf1, buf2);\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u7c98\u5305\u534a\u5305",children:"\u7c98\u5305\u534a\u5305"}),"\n",(0,l.jsx)(n.h3,{id:"\u73b0\u8c61\u6f14\u793a",children:"\u73b0\u8c61\u6f14\u793a"}),"\n",(0,l.jsx)(n.p,{children:"\u5728 TCP \u4f20\u8f93\u4e2d\uff0c\u5ba2\u6237\u7aef\u53d1\u9001\u6d88\u606f\u65f6\uff0c\u5b9e\u9645\u4e0a\u662f\u5c06\u6570\u636e\u5199\u5165 TCP \u7684\u7f13\u5b58\uff0c\u6b64\u65f6\u6570\u636e\u7684\u5927\u5c0f\u548c\u7f13\u5b58\u7684\u5927\u5c0f\u5c31\u4f1a\u9020\u6210\u7c98\u5305\u548c\u534a\u5305"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5f53\u6570\u636e\u8d85\u8fc7 TCP \u7f13\u5b58\u5bb9\u91cf\u65f6\uff0c\u5c31\u4f1a\u88ab\u62c6\u5206\u6210\u591a\u4e2a\u5305\uff0c\u901a\u8fc7 Socket \u591a\u6b21\u53d1\u9001\u5230\u670d\u52a1\u7aef\uff0c\u670d\u52a1\u7aef\u6bcf\u6b21\u4ece\u7f13\u5b58\u4e2d\u53d6\u6570\u636e\uff0c\u4ea7\u751f\u534a\u5305\u95ee\u9898"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5f53\u6570\u636e\u5c0f\u4e8e TCP \u7f13\u5b58\u5bb9\u91cf\u65f6\uff0c\u7f13\u5b58\u4e2d\u53ef\u4ee5\u5b58\u653e\u591a\u4e2a\u5305\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4e00\u6b21\u901a\u4fe1\u5c31\u53ef\u80fd\u4f20\u9012\u591a\u4e2a\u5305\uff0c\u8fd9\u65f6\u5019\u670d\u52a1\u7aef\u5c31\u53ef\u80fd\u4e00\u6b21\u8bfb\u53d6\u591a\u4e2a\u5305\uff0c\u4ea7\u751f\u7c98\u5305\u7684\u95ee\u9898"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4ee3\u7801\u6f14\u793a\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u4ee3\u7801\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class HelloWorldClient {\n    public static void main(String[] args) {\n        send();\n    }\n\n    private static void send() {\n        NioEventLoopGroup worker = new NioEventLoopGroup();\n        try {\n            Bootstrap bootstrap = new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(worker);\n            bootstrap.handler(new ChannelInitializer<SocketChannel>() {\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception {\n                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {\n                        // \u3010\u5728\u8fde\u63a5 channel \u5efa\u7acb\u6210\u529f\u540e\uff0c\u4f1a\u89e6\u53d1 active \u65b9\u6cd5\u3011\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception {\n                            // \u53d1\u9001\u5185\u5bb9\u968f\u673a\u7684\u6570\u636e\u5305\n                            Random r = new Random();\n                            char c = \'0\';\n                            ByteBuf buf = ctx.alloc().buffer();\n                            for (int i = 0; i < 10; i++) {\n                                byte[] bytes = new byte[10];\n                                for (int j = 0; j < r.nextInt(9) + 1; j++) {\n                                    bytes[j] = (byte) c;\n                                }\n                                c++;\n                                buf.writeBytes(bytes);\n                            }\n                            ctx.writeAndFlush(buf);\n                        }\n                    });\n                }\n            });\n            ChannelFuture channelFuture = bootstrap.connect("127.0.0.1", 8080).sync();\n            channelFuture.channel().closeFuture().sync();\n\n        } catch (InterruptedException e) {\n            log.error("client error", e);\n        } finally {\n            worker.shutdownGracefully();\n        }\n    }\n}\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u5668\u4ee3\u7801\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class HelloWorldServer {\n    public static void main(String[] args) {\n        NioEventLoopGroup boss = new NioEventLoopGroup(1);\n        NioEventLoopGroup worker = new NioEventLoopGroup();\n        try {\n            ServerBootstrap serverBootstrap = new ServerBootstrap();\n            serverBootstrap.channel(NioServerSocketChannel.class);\n            // \u8c03\u6574\u7cfb\u7edf\u7684\u63a5\u53d7\u7f13\u51b2\u533a\u3010\u6ed1\u52a8\u7a97\u53e3\u3011\n            //serverBootstrap.option(ChannelOption.SO_RCVBUF, 10);\n            // \u8c03\u6574 netty \u7684\u63a5\u53d7\u7f13\u51b2\u533a\uff08ByteBuf\uff09\n            //serverBootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, \n            //                            new AdaptiveRecvByteBufAllocator(16, 16, 16));\n            serverBootstrap.group(boss, worker);\n            serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception {\n                    // \u3010\u8fd9\u91cc\u53ef\u4ee5\u6dfb\u52a0\u89e3\u7801\u5668\u3011\n                    // LoggingHandler \u7528\u6765\u6253\u5370\u6d88\u606f\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                }\n            });\n            ChannelFuture channelFuture = serverBootstrap.bind(8080);\n            channelFuture.sync();\n            channelFuture.channel().closeFuture().sync();\n        } catch (InterruptedException e) {\n            log.error("server error", e);\n        } finally {\n            boss.shutdownGracefully();\n            worker.shutdownGracefully();\n            log.debug("stop");\n        }\n    }\n}\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7c98\u5305\u6548\u679c\u5c55\u793a\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"09:57:27.140 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xddbaaef6, L:/127.0.0.1:8080 - R:/127.0.0.1:8701] READ: 100B\t// \u8bfb\u4e86 100 \u5b57\u8282\uff0c\u53d1\u751f\u7c98\u5305\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 30 30 30 30 30 00 00 00 00 00 31 00 00 00 00 00 |00000.....1.....|\n|00000010| 00 00 00 00 32 32 32 32 00 00 00 00 00 00 33 00 |....2222......3.|\n|00000020| 00 00 00 00 00 00 00 00 34 34 00 00 00 00 00 00 |........44......|\n|00000030| 00 00 35 35 35 35 00 00 00 00 00 00 36 36 36 00 |..5555......666.|\n|00000040| 00 00 00 00 00 00 37 37 37 37 00 00 00 00 00 00 |......7777......|\n|00000050| 38 38 38 38 38 00 00 00 00 00 39 39 00 00 00 00 |88888.....99....|\n|00000060| 00 00 00 00                                     |....            |\n+--------+-------------------------------------------------+----------------+\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u89e3\u51b3\u65b9\u6cd5\uff1a\u901a\u8fc7\u8c03\u6574\u7cfb\u7edf\u7684\u63a5\u53d7\u7f13\u51b2\u533a\u7684\u6ed1\u52a8\u7a97\u53e3\u548c Netty \u7684\u63a5\u53d7\u7f13\u51b2\u533a\u4fdd\u8bc1\u6bcf\u6761\u5305\u53ea\u542b\u6709\u4e00\u6761\u6570\u636e\uff0c\u6ed1\u52a8\u7a97\u53e3\u7684\u5927\u5c0f\u4ec5\u51b3\u5b9a\u4e86 Netty \u8bfb\u53d6\u7684",(0,l.jsx)(n.strong,{children:"\u6700\u5c0f\u5355\u4f4d"}),"\uff0c\u5b9e\u9645\u6bcf\u6b21\u8bfb\u53d6\u7684\u4e00\u822c\u662f\u5b83\u7684\u6574\u6570\u500d"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u89e3\u51b3\u65b9\u6848",children:"\u89e3\u51b3\u65b9\u6848"}),"\n",(0,l.jsx)(n.h4,{id:"\u77ed\u8fde\u63a5",children:"\u77ed\u8fde\u63a5"}),"\n",(0,l.jsx)(n.p,{children:"\u53d1\u4e00\u4e2a\u5305\u5efa\u7acb\u4e00\u6b21\u8fde\u63a5\uff0c\u8fd9\u6837\u8fde\u63a5\u5efa\u7acb\u5230\u8fde\u63a5\u65ad\u5f00\u4e4b\u95f4\u5c31\u662f\u6d88\u606f\u7684\u8fb9\u754c\uff0c\u7f3a\u70b9\u5c31\u662f\u6548\u7387\u5f88\u4f4e"}),"\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u4ee3\u7801\u6539\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class HelloWorldClient {\n    public static void main(String[] args) {\n        // \u5206 10 \u6b21\u53d1\u9001\n        for (int i = 0; i < 10; i++) {\n            send();\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u56fa\u5b9a\u957f\u5ea6",children:"\u56fa\u5b9a\u957f\u5ea6"}),"\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u5668\u7aef\u52a0\u5165\u5b9a\u957f\u89e3\u7801\u5668\uff0c\u6bcf\u4e00\u6761\u6d88\u606f\u91c7\u7528\u56fa\u5b9a\u957f\u5ea6\u3002\u5982\u679c\u662f\u534a\u5305\u6d88\u606f\uff0c\u4f1a\u7f13\u5b58\u534a\u5305\u6d88\u606f\u5e76\u7b49\u5f85\u4e0b\u4e2a\u5305\u5230\u8fbe\u4e4b\u540e\u8fdb\u884c\u62fc\u5305\u5408\u5e76\uff0c\u76f4\u5230\u8bfb\u53d6\u4e00\u4e2a\u5b8c\u6574\u7684\u6d88\u606f\u5305\uff1b\u5982\u679c\u662f\u7c98\u5305\u6d88\u606f\uff0c\u7a7a\u4f59\u7684\u4f4d\u7f6e\u4f1a\u8fdb\u884c\u8865 0\uff0c\u4f1a\u6d6a\u8d39\u7a7a\u95f4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\n    @Override\n    protected void initChannel(SocketChannel ch) throws Exception {\n        ch.pipeline().addLast(new FixedLengthFrameDecoder(10));\n        // LoggingHandler \u7528\u6765\u6253\u5370\u6d88\u606f\n        ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n    }\n});\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"10:29:06.522 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0x38a70fbf, L:/127.0.0.1:8080 - R:/127.0.0.1:10144] READ: 10B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 31 31 00 00 00 00 00 00 00 00                   |11........      |\n+--------+-------------------------------------------------+----------------+\n10:29:06.522 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0x38a70fbf, L:/127.0.0.1:8080 - R:/127.0.0.1:10144] READ: 10B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 32 32 32 32 32 32 00 00 00 00                   |222222....      |\n+--------+-------------------------------------------------+----------------+\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5206\u9694\u7b26",children:"\u5206\u9694\u7b26"}),"\n",(0,l.jsxs)(n.p,{children:["\u670d\u52a1\u7aef\u52a0\u5165\u884c\u89e3\u7801\u5668\uff0c\u9ed8\u8ba4\u4ee5 ",(0,l.jsx)(n.code,{children:"\\n"})," \u6216 ",(0,l.jsx)(n.code,{children:"\\r\\n"})," \u4f5c\u4e3a\u5206\u9694\u7b26\uff0c\u5982\u679c\u8d85\u51fa\u6307\u5b9a\u957f\u5ea6\u4ecd\u672a\u51fa\u73b0\u5206\u9694\u7b26\uff0c\u5219\u629b\u51fa\u5f02\u5e38\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\n    @Override\n    protected void initChannel(SocketChannel ch) throws Exception {\n        ch.pipeline().addLast(new FixedLengthFrameDecoder(8));\n        ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n    }\n});\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u5ba2\u6237\u7aef\u5728\u6bcf\u6761\u6d88\u606f\u4e4b\u540e\uff0c\u52a0\u5165 ",(0,l.jsx)(n.code,{children:"\\n"})," \u5206\u9694\u7b26\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void channelActive(ChannelHandlerContext ctx) throws Exception {\n    Random r = new Random();\n    char c = 'a';\n    ByteBuf buffer = ctx.alloc().buffer();\n    for (int i = 0; i < 10; i++) {\n        for (int j = 1; j <= r.nextInt(16)+1; j++) {\n            buffer.writeByte((byte) c);\n        }\n        // 10 \u4ee3\u8868 '\\n'\n        buffer.writeByte(10);\n        c++;\n    }\n    ctx.writeAndFlush(buffer);\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u9884\u8bbe\u957f\u5ea6",children:"\u9884\u8bbe\u957f\u5ea6"}),"\n",(0,l.jsx)(n.p,{children:"LengthFieldBasedFrameDecoder \u89e3\u7801\u5668\u81ea\u5b9a\u4e49\u957f\u5ea6\u89e3\u51b3 TCP \u7c98\u5305\u9ecf\u5305\u95ee\u9898"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"int maxFrameLength\t\t// \u6570\u636e\u6700\u5927\u957f\u5ea6\nint lengthFieldOffset \t// \u957f\u5ea6\u5b57\u6bb5\u504f\u79fb\u91cf\uff0c\u4ece\u7b2c\u51e0\u4e2a\u5b57\u8282\u5f00\u59cb\u662f\u5185\u5bb9\u7684\u957f\u5ea6\u5b57\u6bb5\nint lengthFieldLength\t// \u957f\u5ea6\u5b57\u6bb5\u672c\u8eab\u7684\u957f\u5ea6\nint lengthAdjustment \t// \u957f\u5ea6\u5b57\u6bb5\u4e3a\u57fa\u51c6\uff0c\u51e0\u4e2a\u5b57\u8282\u540e\u624d\u662f\u5185\u5bb9\nint initialBytesToStrip\t// \u4ece\u5934\u5f00\u59cb\u5265\u79bb\u51e0\u4e2a\u5b57\u8282\u89e3\u7801\u540e\u663e\u793a\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'lengthFieldOffset   = 1 (= the length of HDR1)\nlengthFieldLength   = 2\nlengthAdjustment    = 1 (= the length of HDR2)\ninitialBytesToStrip = 3 (= the length of HDR1 + LEN)\n\nBEFORE DECODE (16 bytes)                       AFTER DECODE (13 bytes)//\u89e3\u7801\n+------+--------+------+----------------+      +------+----------------+\n| HDR1 | Length | HDR2 | Actual Content |-----\x3e| HDR2 | Actual Content |\n| 0xCA | 0x000C | 0xFE | "HELLO, WORLD" |      | 0xFE | "HELLO, WORLD" |\n+------+--------+------+----------------+      +------+----------------+\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u4ee3\u7801\u5b9e\u73b0\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class LengthFieldDecoderDemo {\n    public static void main(String[] args) {\n        EmbeddedChannel channel = new EmbeddedChannel(\n                // int \u5360 4 \u5b57\u8282\uff0c\u7248\u672c\u53f7\u4e00\u4e2a\u5b57\u8282\n                new LengthFieldBasedFrameDecoder(1024, 0, 4, 1,5),\n                new LoggingHandler(LogLevel.DEBUG)\n        );\n\n        // 4 \u4e2a\u5b57\u8282\u7684\u5185\u5bb9\u957f\u5ea6\uff0c \u5b9e\u9645\u5185\u5bb9\n        ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();\n        send(buffer, "Hello, world");\n        send(buffer, "Hi!");\n        // \u5199\u51fa\u7f13\u5b58\n        channel.writeInbound(buffer);\n    }\n    // \u5199\u5165\u7f13\u5b58\n    private static void send(ByteBuf buffer, String content) {\n        byte[] bytes = content.getBytes();  // \u5b9e\u9645\u5185\u5bb9\n        int length = bytes.length;          // \u5b9e\u9645\u5185\u5bb9\u957f\u5ea6\n        buffer.writeInt(length);\n        buffer.writeByte(1);                // \u8868\u793a\u7248\u672c\u53f7\n        buffer.writeBytes(bytes);\n    }\n}\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"10:49:59.344 [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 12B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 48 65 6c 6c 6f 2c 20 77 6f 72 6c 64             |Hello, world    |\n+--------+-------------------------------------------------+----------------+\n10:49:59.344 [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 3B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 48 69 21                                        |Hi!             |\n+--------+-------------------------------------------------+----------------+\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u534f\u8bae\u8bbe\u8ba1",children:"\u534f\u8bae\u8bbe\u8ba1"}),"\n",(0,l.jsx)(n.h4,{id:"http",children:"HTTP"}),"\n",(0,l.jsxs)(n.p,{children:["\u8bbf\u95ee URL\uff1a",(0,l.jsx)(n.a,{href:"http://localhost:8080/",children:"http://localhost:8080/"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class HttpDemo {\n    public static void main(String[] args) {\n        NioEventLoopGroup boss = new NioEventLoopGroup();\n        NioEventLoopGroup worker = new NioEventLoopGroup();\n        try {\n            ServerBootstrap serverBootstrap = new ServerBootstrap();\n            serverBootstrap.channel(NioServerSocketChannel.class);\n            serverBootstrap.group(boss, worker);\n            serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception {\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                    ch.pipeline().addLast(new HttpServerCodec());\n                    // \u53ea\u9488\u5bf9\u67d0\u4e00\u79cd\u7c7b\u578b\u7684\u8bf7\u6c42\u5904\u7406\uff0c\u6b64\u5904\u9488\u5bf9 HttpRequest\n                    ch.pipeline().addLast(new SimpleChannelInboundHandler<HttpRequest>() {\n                        @Override\n                        protected void channelRead0(ChannelHandlerContext ctx, HttpRequest msg) {\n                            // \u83b7\u53d6\u8bf7\u6c42\n                            log.debug(msg.uri());\n\n                            // \u8fd4\u56de\u54cd\u5e94\n                            DefaultFullHttpResponse response = new DefaultFullHttpResponse(\n                                msg.protocolVersion(), HttpResponseStatus.OK);\n\n                            byte[] bytes = "<h1>Hello, world!</h1>".getBytes();\n\n                            response.headers().setInt(CONTENT_LENGTH, bytes.length);\n                            response.content().writeBytes(bytes);\n\n                            // \u5199\u56de\u54cd\u5e94\n                            ctx.writeAndFlush(response);\n                        }\n                    });\n                }\n            });\n            ChannelFuture channelFuture = serverBootstrap.bind(8080).sync();\n            channelFuture.channel().closeFuture().sync();\n        } catch (InterruptedException e) {\n            log.error("n3.server error", e);\n        } finally {\n            boss.shutdownGracefully();\n            worker.shutdownGracefully();\n        }\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u81ea\u5b9a\u4e49",children:"\u81ea\u5b9a\u4e49"}),"\n",(0,l.jsx)(n.p,{children:"\u5904\u7406\u5668\u4ee3\u7801\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@Slf4j\npublic class MessageCodec extends ByteToMessageCodec<Message> {\n    // \u7f16\u7801\n    @Override\n    public void encode(ChannelHandlerContext ctx, Message msg, ByteBuf out) throws Exception {\n        // 4 \u5b57\u8282\u7684\u9b54\u6570\n        out.writeBytes(new byte[]{1, 2, 3, 4});\n        // 1 \u5b57\u8282\u7684\u7248\u672c,\n        out.writeByte(1);\n        // 1 \u5b57\u8282\u7684\u5e8f\u5217\u5316\u65b9\u5f0f jdk 0 , json 1\n        out.writeByte(0);\n        // 1 \u5b57\u8282\u7684\u6307\u4ee4\u7c7b\u578b\n        out.writeByte(msg.getMessageType());\n        // 4 \u4e2a\u5b57\u8282\n        out.writeInt(msg.getSequenceId());\n        // \u65e0\u610f\u4e49\uff0c\u5bf9\u9f50\u586b\u5145, 1 \u5b57\u8282\n        out.writeByte(0xff);\n        // \u83b7\u53d6\u5185\u5bb9\u7684\u5b57\u8282\u6570\u7ec4\uff0cmsg \u5bf9\u8c61\u5e8f\u5217\u5316\n        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n        ObjectOutputStream oos = new ObjectOutputStream(bos);\n        oos.writeObject(msg);\n        byte[] bytes = bos.toByteArray();\n        // \u957f\u5ea6\n        out.writeInt(bytes.length);\n        // \u5199\u5165\u5185\u5bb9\n        out.writeBytes(bytes);\n    }\n\n    // \u89e3\u7801\n    @Override\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {\n        int magicNum = in.readInt();\n        byte version = in.readByte();\n        byte serializerType = in.readByte();\n        byte messageType = in.readByte();\n        int sequenceId = in.readInt();\n        in.readByte();\n        int length = in.readInt();\n        byte[] bytes = new byte[length];\n        in.readBytes(bytes, 0, length);\n        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes));\n        Message message = (Message) ois.readObject();\n        log.debug("{}, {}, {}, {}, {}, {}", magicNum, version, serializerType, messageType, sequenceId, length);\n        log.debug("{}", message);\n        out.add(message);\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6d4b\u8bd5\u4ee3\u7801\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public static void main(String[] args) throws Exception {\n    EmbeddedChannel channel = new EmbeddedChannel(new LoggingHandler(), new MessageCodec());\n    // encode\n    LoginRequestMessage message = new LoginRequestMessage("zhangsan", "123");\n    channel.writeOutbound(message);\n\n    // decode\n    ByteBuf buf = ByteBufAllocator.DEFAULT.buffer();\n    new MessageCodec().encode(null, message, buf);\n    // \u5165\u7ad9\n    channel.writeInbound(buf);\n}\npublic class LoginRequestMessage extends Message {\n    private String username;\n    private String password;\n    // set + get \n}\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(7415).A+"",width:"658",height:"459"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"sharable",children:"Sharable"}),"\n",(0,l.jsx)(n.p,{children:"@Sharable \u6ce8\u89e3\u7684\u6dfb\u52a0\u65f6\u673a\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5f53 handler \u4e0d\u4fdd\u5b58\u72b6\u6001\u65f6\uff0c\u5c31\u53ef\u4ee5\u5b89\u5168\u5730\u5728\u591a\u7ebf\u7a0b\u4e0b\u88ab\u5171\u4eab"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5bf9\u4e8e\u7f16\u89e3\u7801\u5668\u7c7b\u4e0d\u80fd\u7ee7\u627f ByteToMessageCodec \u6216 CombinedChannelDuplexHandler\uff0c\u5b83\u4eec\u7684\u6784\u9020\u65b9\u6cd5\u5bf9 @Sharable \u6709\u9650\u5236"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'protected ByteToMessageCodec(boolean preferDirect) {\n    ensureNotSharable();\n    outboundMsgMatcher = TypeParameterMatcher.find(this, ByteToMessageCodec.class, "I");\n    encoder = new Encoder(preferDirect);\n}\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected void ensureNotSharable() {\n    // \u5982\u679c\u7c7b\u4e0a\u6709\u8be5\u6ce8\u89e3\n    if (isSharable()) {\n        throw new IllegalStateException();\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u80fd\u786e\u4fdd\u7f16\u89e3\u7801\u5668\u4e0d\u4f1a\u4fdd\u5b58\u72b6\u6001\uff0c\u53ef\u4ee5\u7ee7\u627f MessageToMessageCodec \u7236\u7c7b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"@Slf4j\n@ChannelHandler.Sharable\n// \u5fc5\u987b\u548c LengthFieldBasedFrameDecoder \u4e00\u8d77\u4f7f\u7528\uff0c\u786e\u4fdd\u63a5\u5230\u7684 ByteBuf \u6d88\u606f\u662f\u5b8c\u6574\u7684\npublic class MessageCodecSharable extends MessageToMessageCodec<ByteBuf, Message> {\n    @Override\n    protected void encode(ChannelHandlerContext ctx, Message msg, List<Object> outList) throws Exception {\n        ByteBuf out = ctx.alloc().buffer();\n        // 4 \u5b57\u8282\u7684\u9b54\u6570\n        out.writeBytes(new byte[]{1, 2, 3, 4});\n\t\t// ....\n        outList.add(out);\n    }\n\n    @Override\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {\n        //....\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u573a\u666f\u4f18\u5316",children:"\u573a\u666f\u4f18\u5316"}),"\n",(0,l.jsx)(n.h3,{id:"\u7a7a\u95f2\u68c0\u6d4b",children:"\u7a7a\u95f2\u68c0\u6d4b"}),"\n",(0,l.jsx)(n.h4,{id:"\u8fde\u63a5\u5047\u6b7b",children:"\u8fde\u63a5\u5047\u6b7b"}),"\n",(0,l.jsx)(n.p,{children:"\u8fde\u63a5\u5047\u6b7b\u5c31\u662f\u5ba2\u6237\u7aef\u6570\u636e\u53d1\u4e0d\u51fa\u53bb\uff0c\u670d\u52a1\u7aef\u4e5f\u4e00\u76f4\u6536\u4e0d\u5230\u6570\u636e\uff0c\u4fdd\u6301\u8fd9\u79cd\u72b6\u6001\uff0c\u5047\u6b7b\u7684\u8fde\u63a5\u5360\u7528\u7684\u8d44\u6e90\u4e0d\u80fd\u81ea\u52a8\u91ca\u653e\uff0c\u800c\u4e14\u5411\u5047\u6b7b\u8fde\u63a5\u53d1\u9001\u6570\u636e\uff0c\u5f97\u5230\u7684\u53cd\u9988\u662f\u53d1\u9001\u8d85\u65f6"}),"\n",(0,l.jsx)(n.p,{children:"\u89e3\u51b3\u65b9\u6848\uff1a\u6bcf\u9694\u4e00\u6bb5\u65f6\u95f4\u5c31\u68c0\u67e5\u8fd9\u6bb5\u65f6\u95f4\u5185\u662f\u5426\u63a5\u6536\u5230\u5ba2\u6237\u7aef\u6570\u636e\uff0c\u6ca1\u6709\u5c31\u53ef\u4ee5\u5224\u5b9a\u4e3a\u8fde\u63a5\u5047\u6b7b"}),"\n",(0,l.jsx)(n.p,{children:"IdleStateHandler \u662f Netty \u63d0\u4f9b\u7684\u5904\u7406\u7a7a\u95f2\u72b6\u6001\u7684\u5904\u7406\u5668\uff0c\u7528\u6765\u5224\u65ad\u662f\u4e0d\u662f\u8bfb\u7a7a\u95f2\u65f6\u95f4\u6216\u5199\u7a7a\u95f2\u65f6\u95f4\u8fc7\u957f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u53c2\u6570\u4e00 long readerIdleTime\uff1a\u8bfb\u7a7a\u95f2\uff0c\u8868\u793a\u591a\u957f\u65f6\u95f4\u6ca1\u6709\u8bfb"}),"\n",(0,l.jsx)(n.li,{children:"\u53c2\u6570\u4e8c long writerIdleTime\uff1a\u5199\u7a7a\u95f2\uff0c\u8868\u793a\u591a\u957f\u65f6\u95f4\u6ca1\u6709\u5199"}),"\n",(0,l.jsx)(n.li,{children:"\u53c2\u6570\u4e09 long allIdleTime\uff1a\u8bfb\u5199\u7a7a\u95f2\uff0c\u8868\u793a\u591a\u957f\u65f6\u95f4\u6ca1\u6709\u8bfb\u5199"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\n\t@Override\n\tprotected void initChannel(SocketChannel ch) throws Exception {\n        ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0));\n        ch.pipeline().addLast(new MessageCodec());\n        // 5s \u5185\u5982\u679c\u6ca1\u6709\u6536\u5230 channel \u7684\u6570\u636e\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a IdleState#READER_IDLE \u4e8b\u4ef6\uff0c\n        ch.pipeline().addLast(new IdleStateHandler(5, 0, 0));\n        // ChannelDuplexHandler \u3010\u53ef\u4ee5\u540c\u65f6\u4f5c\u4e3a\u5165\u7ad9\u548c\u51fa\u7ad9\u3011\u5904\u7406\u5668\n        ch.pipeline().addLast(new ChannelDuplexHandler() {\n            // \u7528\u6765\u89e6\u53d1\u7279\u6b8a\u4e8b\u4ef6\n            @Override\n            public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception{\n                IdleStateEvent event = (IdleStateEvent) evt;\n                // \u89e6\u53d1\u4e86\u8bfb\u7a7a\u95f2\u4e8b\u4ef6\n                if (event.state() == IdleState.READER_IDLE) {\n                    log.debug("\u5df2\u7ecf 5s \u6ca1\u6709\u8bfb\u5230\u6570\u636e\u4e86");\n                    ctx.channel().close();\n                }\n            }\n        });\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5fc3\u8df3\u673a\u5236",children:"\u5fc3\u8df3\u673a\u5236"}),"\n",(0,l.jsxs)(n.p,{children:["\u5ba2\u6237\u7aef\u5b9a\u65f6\u5411\u670d\u52a1\u5668\u7aef\u53d1\u9001\u6570\u636e\uff0c",(0,l.jsx)(n.strong,{children:"\u65f6\u95f4\u95f4\u9694\u8981\u5c0f\u4e8e\u670d\u52a1\u5668\u5b9a\u4e49\u7684\u7a7a\u95f2\u68c0\u6d4b\u7684\u65f6\u95f4\u95f4\u9694"}),"\uff0c\u5c31\u80fd\u9632\u6b62\u8bef\u5224\u8fde\u63a5\u5047\u6b7b\uff0c\u8fd9\u5c31\u662f\u5fc3\u8df3\u673a\u5236"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"bootstrap.handler(new ChannelInitializer<SocketChannel>() {\n    @Override\n    protected void initChannel(SocketChannel ch) throws Exception {\n        ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0));\n        ch.pipeline().addLast(new MessageCodec());\n        // 3s \u5185\u5982\u679c\u6ca1\u6709\u5411\u670d\u52a1\u5668\u5199\u6570\u636e\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a IdleState#WRITER_IDLE \u4e8b\u4ef6\n        ch.pipeline().addLast(new IdleStateHandler(0, 3, 0));\n        // ChannelDuplexHandler \u53ef\u4ee5\u540c\u65f6\u4f5c\u4e3a\u5165\u7ad9\u548c\u51fa\u7ad9\u5904\u7406\u5668\n        ch.pipeline().addLast(new ChannelDuplexHandler() {\n            // \u7528\u6765\u89e6\u53d1\u7279\u6b8a\u4e8b\u4ef6\n            @Override\n            public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n                IdleStateEvent event = (IdleStateEvent) evt;\n                // \u89e6\u53d1\u4e86\u5199\u7a7a\u95f2\u4e8b\u4ef6\n                if (event.state() == IdleState.WRITER_IDLE) {\n                    // 3s \u6ca1\u6709\u5199\u6570\u636e\u4e86\uff0c\u3010\u53d1\u9001\u4e00\u4e2a\u5fc3\u8df3\u5305\u3011\n                    ctx.writeAndFlush(new PingMessage());\n                }\n            }\n        });\n    }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5e8f\u5217\u5316",children:"\u5e8f\u5217\u5316"}),"\n",(0,l.jsx)(n.h4,{id:"\u666e\u901a\u65b9\u5f0f",children:"\u666e\u901a\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u5e8f\u5217\u5316\uff0c\u53cd\u5e8f\u5217\u5316\u4e3b\u8981\u7528\u5728\u6d88\u606f\u6b63\u6587\u7684\u8f6c\u6362\u4e0a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5e8f\u5217\u5316\u65f6\uff0c\u9700\u8981\u5c06 Java \u5bf9\u8c61\u53d8\u4e3a\u8981\u4f20\u8f93\u7684\u6570\u636e\uff08\u53ef\u4ee5\u662f byte[]\uff0c\u6216 json \u7b49\uff0c\u6700\u7ec8\u90fd\u9700\u8981\u53d8\u6210 byte[]\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u53cd\u5e8f\u5217\u5316\u65f6\uff0c\u9700\u8981\u5c06\u4f20\u5165\u7684\u6b63\u6587\u6570\u636e\u8fd8\u539f\u6210 Java \u5bf9\u8c61\uff0c\u4fbf\u4e8e\u5904\u7406"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4ee3\u7801\u5b9e\u73b0\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u62bd\u8c61\u4e00\u4e2a Serializer \u63a5\u53e3"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public interface Serializer {\n    // \u53cd\u5e8f\u5217\u5316\u65b9\u6cd5\n    <T> T deserialize(Class<T> clazz, byte[] bytes);\n    // \u5e8f\u5217\u5316\u65b9\u6cd5\n    <T> byte[] serialize(T object);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u63d0\u4f9b\u4e24\u4e2a\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'enum SerializerAlgorithm implements Serializer {\n\t// Java \u5b9e\u73b0\n    Java {\n        @Override\n        public <T> T deserialize(Class<T> clazz, byte[] bytes) {\n            try {\n                ObjectInputStream in = \n                    new ObjectInputStream(new ByteArrayInputStream(bytes));\n                Object object = in.readObject();\n                return (T) object;\n            } catch (IOException | ClassNotFoundException e) {\n                throw new RuntimeException("SerializerAlgorithm.Java \u53cd\u5e8f\u5217\u5316\u9519\u8bef", e);\n            }\n        }\n\n        @Override\n        public <T> byte[] serialize(T object) {\n            try {\n                ByteArrayOutputStream out = new ByteArrayOutputStream();\n                new ObjectOutputStream(out).writeObject(object);\n                return out.toByteArray();\n            } catch (IOException e) {\n                throw new RuntimeException("SerializerAlgorithm.Java \u5e8f\u5217\u5316\u9519\u8bef", e);\n            }\n        }\n    }, \n    // Json \u5b9e\u73b0(\u5f15\u5165\u4e86 Gson \u4f9d\u8d56)\n    Json {\n        @Override\n        public <T> T deserialize(Class<T> clazz, byte[] bytes) {\n            return new Gson().fromJson(new String(bytes, StandardCharsets.UTF_8), clazz);\n        }\n\n        @Override\n        public <T> byte[] serialize(T object) {\n            return new Gson().toJson(object).getBytes(StandardCharsets.UTF_8);\n        }\n    };\n\n    // \u9700\u8981\u4ece\u534f\u8bae\u7684\u5b57\u8282\u4e2d\u5f97\u5230\u662f\u54ea\u79cd\u5e8f\u5217\u5316\u7b97\u6cd5\n    public static SerializerAlgorithm getByInt(int type) {\n        SerializerAlgorithm[] array = SerializerAlgorithm.values();\n        if (type < 0 || type > array.length - 1) {\n            throw new IllegalArgumentException("\u8d85\u8fc7 SerializerAlgorithm \u8303\u56f4");\n        }\n        return array[type];\n    }\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"protobuf",children:"ProtoBuf"}),"\n",(0,l.jsx)(n.h5,{id:"\u57fa\u672c\u4ecb\u7ecd-5",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"Codec\uff08\u7f16\u89e3\u7801\u5668\uff09\u7684\u7ec4\u6210\u90e8\u5206\u6709\u4e24\u4e2a\uff1aDecoder\uff08\u89e3\u7801\u5668\uff09\u548c Encoder\uff08\u7f16\u7801\u5668\uff09\u3002Encoder \u8d1f\u8d23\u628a\u4e1a\u52a1\u6570\u636e\u8f6c\u6362\u6210\u5b57\u8282\u7801\u6570\u636e\uff0cDecoder \u8d1f\u8d23\u628a\u5b57\u8282\u7801\u6570\u636e\u8f6c\u6362\u6210\u4e1a\u52a1\u6570\u636e"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(88410).A+"",width:"1220",height:"192"})}),"\n",(0,l.jsx)(n.p,{children:"Protobuf \u662f Google \u53d1\u5e03\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u5168\u79f0  Google Protocol Buffers \uff0c\u662f\u4e00\u79cd\u8f7b\u4fbf\u9ad8\u6548\u7684\u7ed3\u6784\u5316\u6570\u636e\u5b58\u50a8\u683c\u5f0f\uff0c\u53ef\u4ee5\u7528\u4e8e\u7ed3\u6784\u5316\u6570\u636e\u4e32\u884c\u5316\uff0c\u6216\u8005\u8bf4\u5e8f\u5217\u5316\u3002\u5f88\u9002\u5408\u505a\u6570\u636e\u5b58\u50a8\u6216 RPC\uff08\u8fdc\u7a0b\u8fc7\u7a0b\u8c03\u7528 remote procedure call\uff09\u6570\u636e\u4ea4\u6362\u683c\u5f0f\u3002\u76ee\u524d\u5f88\u591a\u516c\u53f8\u4ece HTTP + Json \u8f6c\u5411 TCP + Protobuf \uff0c\u6548\u7387\u4f1a\u66f4\u9ad8"}),"\n",(0,l.jsx)(n.p,{children:"Protobuf \u662f\u4ee5 message \u7684\u65b9\u5f0f\u6765\u7ba1\u7406\u6570\u636e\uff0c\u652f\u6301\u8de8\u5e73\u53f0\u3001\u8de8\u8bed\u8a00\uff08\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7aef\u53ef\u4ee5\u662f\u4e0d\u540c\u7684\u8bed\u8a00\u7f16\u5199\u7684\uff09\uff0c\u9ad8\u6027\u80fd\u3001\u9ad8\u53ef\u9760\u6027"}),"\n",(0,l.jsx)(n.p,{children:"\u5de5\u4f5c\u8fc7\u7a0b\uff1a\u4f7f\u7528 Protobuf \u7f16\u8bd1\u5668\u81ea\u52a8\u751f\u6210\u4ee3\u7801\uff0cProtobuf \u662f\u5c06\u7c7b\u7684\u5b9a\u4e49\u4f7f\u7528 .proto \u6587\u4ef6\u8fdb\u884c\u63cf\u8ff0\uff0c\u7136\u540e\u901a\u8fc7 protoc.exe \u7f16\u8bd1\u5668\u6839\u636e  .proto \u81ea\u52a8\u751f\u6210 .java \u6587\u4ef6"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u4ee3\u7801\u5b9e\u73b0",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5355\u4e2a message\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-protobuf",children:'syntax = "proto3"; \t\t\t\t\t\t\t\t// \u7248\u672c\noption java_outer_classname = "StudentPOJO";\t// \u751f\u6210\u7684\u5916\u90e8\u7c7b\u540d\uff0c\u540c\u65f6\u4e5f\u662f\u6587\u4ef6\u540d\n\nmessage Student { \t// \u5728 StudentPOJO \u5916\u90e8\u7c7b\u79cd\u751f\u6210\u4e00\u4e2a\u5185\u90e8\u7c7b Student\uff0c\u662f\u771f\u6b63\u53d1\u9001\u7684 POJO \u5bf9\u8c61\n    int32 id = 1; \t// Student \u7c7b\u4e2d\u6709\u4e00\u4e2a\u5c5e\u6027\uff1a\u540d\u5b57\u4e3a id \u7c7b\u578b\u4e3a int32(protobuf\u7c7b\u578b) \uff0c1\u8868\u793a\u5c5e\u6027\u5e8f\u53f7\uff0c\u4e0d\u662f\u503c\n    string name = 2;\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(47420).A+"",width:"1044",height:"249"})}),"\n",(0,l.jsxs)(n.p,{children:["\u7f16\u8bd1 ",(0,l.jsx)(n.code,{children:"protoc.exe --java_out=.Student.proto"}),"\uff08cmd \u7a97\u53e3\u8f93\u5165\uff09 \u5c06\u751f\u6210\u7684 StudentPOJO \u653e\u5165\u5230\u9879\u76ee\u4f7f\u7528"]}),"\n",(0,l.jsx)(n.p,{children:"Server \u7aef\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'new ServerBootstrap() //...\n    .childHandler(new ChannelInitializer<SocketChannel>() {\t// \u521b\u5efa\u4e00\u4e2a\u901a\u9053\u521d\u59cb\u5316\u5bf9\u8c61\n        // \u7ed9pipeline \u8bbe\u7f6e\u5904\u7406\u5668\n        @Override\n        protected void initChannel(SocketChannel ch) throws Exception {\n            // \u5728pipeline\u52a0\u5165ProtoBufDecoder\uff0c\u6307\u5b9a\u5bf9\u54ea\u79cd\u5bf9\u8c61\u8fdb\u884c\u89e3\u7801\n            ch.pipeline().addLast("decoder", new ProtobufDecoder(\n                \t\t\t\t\t\t\tStudentPOJO.Student.getDefaultInstance()));\n            ch.pipeline().addLast(new NettyServerHandler());\n        }\n    }); \n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"Client \u7aef\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'new Bootstrap().group(group) \t\t\t// \u8bbe\u7f6e\u7ebf\u7a0b\u7ec4\n    .channel(NioSocketChannel.class) \t// \u8bbe\u7f6e\u5ba2\u6237\u7aef\u901a\u9053\u7684\u5b9e\u73b0\u7c7b(\u53cd\u5c04)\n    .handler(new ChannelInitializer<SocketChannel>() {\n        @Override\n        protected void initChannel(SocketChannel ch) throws Exception {\n            // \u5728pipeline\u4e2d\u52a0\u5165 ProtoBufEncoder\n            ch.pipeline().addLast("encoder", new ProtobufEncoder());\n            ch.pipeline().addLast(new NettyClientHandler()); // \u52a0\u5165\u81ea\u5b9a\u4e49\u7684\u4e1a\u52a1\u5904\u7406\u5668\n        }\n    });\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u591a\u4e2a message\uff1aProtobuf \u53ef\u4ee5\u4f7f\u7528 message \u7ba1\u7406\u5176\u4ed6\u7684 message\u3002\u5047\u8bbe\u67d0\u4e2a\u9879\u76ee\u9700\u8981\u4f20\u8f93 20 \u4e2a\u5bf9\u8c61\uff0c\u53ef\u4ee5\u5728\u4e00\u4e2a\u6587\u4ef6\u91cc\u5b9a\u4e49 20 \u4e2a message\uff0c\u6700\u540e\u518d\u7528\u4e00\u4e2a\u603b\u7684 message \u6765\u51b3\u5b9a\u5728\u5b9e\u9645\u4f20\u8f93\u65f6\u771f\u6b63\u9700\u8981\u4f20\u8f93\u54ea\u4e00\u4e2a\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-protobuf",children:'syntax = "proto3";\noption optimize_for = SPEED; \t\t\t\t\t// \u52a0\u5feb\u89e3\u6790\noption java_package="com.atguigu.netty.codec2";\t// \u6307\u5b9a\u751f\u6210\u5230\u54ea\u4e2a\u5305\u4e0b\noption java_outer_classname="MyDataInfo"; \t\t// \u5916\u90e8\u7c7b\u540d, \u6587\u4ef6\u540d\n\nmessage MyMessage {\n    // \u5b9a\u4e49\u4e00\u4e2a\u679a\u4e3e\u7c7b\u578b\uff0cDataType \u5982\u679c\u662f 0 \u5219\u8868\u793a\u4e00\u4e2a Student \u5bf9\u8c61\u5b9e\u4f8b\uff0cDataType \u8fd9\u4e2a\u540d\u79f0\u81ea\u5b9a\u4e49\n    enum DataType {\n        StudentType = 0; //\u5728 proto3 \u8981\u6c42 enum \u7684\u7f16\u53f7\u4ece 0 \u5f00\u59cb\n        WorkerType = 1;\n    }\n\n    // \u7528 data_type \u6765\u6807\u8bc6\u4f20\u7684\u662f\u54ea\u4e00\u4e2a\u679a\u4e3e\u7c7b\u578b\uff0c\u8fd9\u91cc\u624d\u771f\u6b63\u5f00\u59cb\u5b9a\u4e49 Message \u7684\u6570\u636e\u7c7b\u578b\n    DataType data_type = 1;  // \u6240\u6709\u540e\u9762\u7684\u6570\u5b57\u90fd\u53ea\u662f\u7f16\u53f7\u800c\u5df2\n\n    // oneof \u5173\u952e\u5b57\uff0c\u8868\u793a\u6bcf\u6b21\u679a\u4e3e\u7c7b\u578b\u8fdb\u884c\u4f20\u8f93\u65f6\uff0c\u9650\u5236\u6700\u591a\u53ea\u80fd\u4f20\u8f93\u4e00\u4e2a\u5bf9\u8c61\u3002\n    // dataBody\u540d\u79f0\u4e5f\u662f\u81ea\u5b9a\u4e49\u7684\n    // MyMessage \u91cc\u51fa\u73b0\u7684\u7c7b\u578b\u53ea\u6709\u4e24\u4e2a DataType \u7c7b\u578b\uff0cStudent \u6216\u8005 Worker \u7c7b\u578b\uff0c\u5728\u771f\u6b63\u4f20\u8f93\u7684\u65f6\u5019\u53ea\u4f1a\u6709\u4e00\u4e2a\u51fa\u73b0\n    oneof dataBody {\n        Student student = 2;  //\u6ce8\u610f\u8fd9\u540e\u9762\u7684\u6570\u5b57\u4e5f\u90fd\u53ea\u662f\u7f16\u53f7\u800c\u5df2\uff0c\u4e0a\u9762DataType data_type = 1  \u5360\u4e86\u7b2c\u4e00\u4e2a\u5e8f\u53f7\u4e86\n        Worker worker = 3;\n    }\n\n\n}\n\nmessage Student {\n    int32 id = 1;\t\t// Student\u7c7b\u7684\u5c5e\u6027\n    string name = 2; \t//\n}\nmessage Worker {\n    string name=1;\n    int32 age=2;\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u7f16\u8bd1\uff1a"}),"\n",(0,l.jsx)(n.p,{children:"Server \u7aef\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'ch.pipeline().addLast("decoder", new ProtobufDecoder(MyDataInfo.MyMessage.getDefaultInstance()));\n'})}),"\n",(0,l.jsx)(n.p,{children:"Client \u7aef\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'pipeline.addLast("encoder", new ProtobufEncoder());\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u957f\u8fde\u63a5",children:"\u957f\u8fde\u63a5"}),"\n",(0,l.jsx)(n.p,{children:"HTTP \u534f\u8bae\u662f\u65e0\u72b6\u6001\u7684\uff0c\u6d4f\u89c8\u5668\u548c\u670d\u52a1\u5668\u95f4\u7684\u8bf7\u6c42\u54cd\u5e94\u4e00\u6b21\uff0c\u4e0b\u4e00\u6b21\u4f1a\u91cd\u65b0\u521b\u5efa\u8fde\u63a5\u3002\u5b9e\u73b0\u57fa\u4e8e WebSocket \u7684\u957f\u8fde\u63a5\u7684\u5168\u53cc\u5de5\u7684\u4ea4\u4e92\uff0c\u6539\u53d8 HTTP \u534f\u8bae\u591a\u6b21\u8bf7\u6c42\u7684\u7ea6\u675f"}),"\n",(0,l.jsx)(n.p,{children:"\u5f00\u53d1\u9700\u6c42\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5b9e\u73b0\u957f\u8fde\u63a5\uff0c\u670d\u52a1\u5668\u4e0e\u6d4f\u89c8\u5668\u76f8\u4e92\u901a\u4fe1\u5ba2\u6237\u7aef"}),"\n",(0,l.jsx)(n.li,{children:"\u6d4f\u89c8\u5668\u548c\u670d\u52a1\u5668\u7aef\u4f1a\u76f8\u4e92\u611f\u77e5\uff0c\u6bd4\u5982\u670d\u52a1\u5668\u5173\u95ed\u4e86\uff0c\u6d4f\u89c8\u5668\u4f1a\u611f\u77e5\uff0c\u540c\u6837\u6d4f\u89c8\u5668\u5173\u95ed\u4e86\uff0c\u670d\u52a1\u5668\u4f1a\u611f\u77e5"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4ee3\u7801\u5b9e\u73b0\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"WebSocket\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["WebSocket \u7684\u6570\u636e\u662f",(0,l.jsx)(n.strong,{children:"\u4ee5\u5e27\uff08frame\uff09\u5f62\u5f0f\u4f20\u9012"}),"\uff0cWebSocketFrame \u4e0b\u9762\u6709\u516d\u4e2a\u5b50\u7c7b\uff0c\u4ee3\u8868\u4e0d\u540c\u7684\u5e27\u683c\u5f0f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d4f\u89c8\u5668\u8bf7\u6c42 URL\uff1aws://localhost:8080/xxx"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class MyWebSocket {\n    public static void main(String[] args) throws Exception {\n        // \u521b\u5efa\u4e24\u4e2a\u7ebf\u7a0b\u7ec4\n        EventLoopGroup bossGroup = new NioEventLoopGroup(1);\n        EventLoopGroup workerGroup = new NioEventLoopGroup();\n        try {\n\n            ServerBootstrap serverBootstrap = new ServerBootstrap();\n            serverBootstrap.group(bossGroup, workerGroup);\n            serverBootstrap.channel(NioServerSocketChannel.class);\n            serverBootstrap.handler(new LoggingHandler(LogLevel.INFO));\n            serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception {\n                    ChannelPipeline pipeline = ch.pipeline();\n\n                    // \u57fa\u4e8e http \u534f\u8bae\uff0c\u4f7f\u7528 http \u7684\u7f16\u7801\u548c\u89e3\u7801\u5668\n                    pipeline.addLast(new HttpServerCodec());\n                    // \u662f\u4ee5\u5757\u65b9\u5f0f\u5199\uff0c\u6dfb\u52a0 ChunkedWriteHandler \u5904\u7406\u5668\n                    pipeline.addLast(new ChunkedWriteHandler());\n\n                    // http \u6570\u636e\u5728\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u662f\u5206\u6bb5, HttpObjectAggregator \u5c31\u662f\u53ef\u4ee5\u5c06\u591a\u4e2a\u6bb5\u805a\u5408\n                    //  \u8fd9\u5c31\u5c31\u662f\u4e3a\u4ec0\u4e48\uff0c\u5f53\u6d4f\u89c8\u5668\u53d1\u9001\u5927\u91cf\u6570\u636e\u65f6\uff0c\u5c31\u4f1a\u53d1\u51fa\u591a\u6b21 http \u8bf7\u6c42\n                    pipeline.addLast(new HttpObjectAggregator(8192));\n        \n                    // WebSocketServerProtocolHandler \u6838\u5fc3\u529f\u80fd\u662f\u3010\u5c06 http \u534f\u8bae\u5347\u7ea7\u4e3a ws \u534f\u8bae\u3011\uff0c\u4fdd\u6301\u957f\u8fde\u63a5\n                    pipeline.addLast(new WebSocketServerProtocolHandler("/hello"));\n\n                    // \u81ea\u5b9a\u4e49\u7684handler \uff0c\u5904\u7406\u4e1a\u52a1\u903b\u8f91\n                    pipeline.addLast(new MyTextWebSocketFrameHandler());\n                }\n            });\n\n            // \u542f\u52a8\u670d\u52a1\u5668\n            ChannelFuture channelFuture = serverBootstrap.bind(8080).sync();\n            channelFuture.channel().closeFuture().sync();\n\n        } finally {\n            bossGroup.shutdownGracefully();\n            workerGroup.shutdownGracefully();\n        }\n    }\n}\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5904\u7406\u5668\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class MyTextWebSocketFrameHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {\n    // TextWebSocketFrame \u7c7b\u578b\uff0c\u8868\u793a\u4e00\u4e2a\u6587\u672c\u5e27(frame)\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) throws Exception {\n        System.out.println("\u670d\u52a1\u5668\u6536\u5230\u6d88\u606f " + msg.text());\n        // \u56de\u590d\u6d88\u606f\n        ctx.writeAndFlush(new TextWebSocketFrame("\u670d\u52a1\u5668\u65f6\u95f4" + LocalDateTime.now() + " " + msg.text()));\n    }\n\n    // \u5f53web\u5ba2\u6237\u7aef\u8fde\u63a5\u540e\uff0c \u89e6\u53d1\u65b9\u6cd5\n    @Override\n    public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\n        // id \u8868\u793a\u552f\u4e00\u7684\u503c\uff0cLongText \u662f\u552f\u4e00\u7684 ShortText \u4e0d\u662f\u552f\u4e00\n        System.out.println("handlerAdded \u88ab\u8c03\u7528" + ctx.channel().id().asLongText());\n        System.out.println("handlerAdded \u88ab\u8c03\u7528" + ctx.channel().id().asShortText());\n    }\n\n    @Override\n    public void handlerRemoved(ChannelHandlerContext ctx) throws Exception {\n        System.out.println("handlerRemoved \u88ab\u8c03\u7528" + ctx.channel().id().asLongText());\n    }\n\n    @Override\n    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n        System.out.println("\u5f02\u5e38\u53d1\u751f " + cause.getMessage());\n        ctx.close(); // \u5173\u95ed\u8fde\u63a5\n    }\n}\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"HTML\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <title>Title</title>\n</head>\n<body>\n<script>\n    var socket;\n    // \u5224\u65ad\u5f53\u524d\u6d4f\u89c8\u5668\u662f\u5426\u652f\u6301websocket\n    if(window.WebSocket) {\n        //go on\n        socket = new WebSocket("ws://localhost:8080/hello");\n        //\u76f8\u5f53\u4e8echannelReado, ev \u6536\u5230\u670d\u52a1\u5668\u7aef\u56de\u9001\u7684\u6d88\u606f\n        socket.onmessage = function (ev) {\n            var rt = document.getElementById("responseText");\n            rt.value = rt.value + "\\n" + ev.data;\n        }\n\n        //\u76f8\u5f53\u4e8e\u8fde\u63a5\u5f00\u542f(\u611f\u77e5\u5230\u8fde\u63a5\u5f00\u542f)\n        socket.onopen = function (ev) {\n            var rt = document.getElementById("responseText");\n            rt.value = "\u8fde\u63a5\u5f00\u542f\u4e86.."\n        }\n\n        //\u76f8\u5f53\u4e8e\u8fde\u63a5\u5173\u95ed(\u611f\u77e5\u5230\u8fde\u63a5\u5173\u95ed)\n        socket.onclose = function (ev) {\n\n            var rt = document.getElementById("responseText");\n            rt.value = rt.value + "\\n" + "\u8fde\u63a5\u5173\u95ed\u4e86.."\n        }\n    } else {\n        alert("\u5f53\u524d\u6d4f\u89c8\u5668\u4e0d\u652f\u6301websocket")\n    }\n\n    // \u53d1\u9001\u6d88\u606f\u5230\u670d\u52a1\u5668\n    function send(message) {\n        // \u5148\u5224\u65adsocket\u662f\u5426\u521b\u5efa\u597d\n        if(!window.socket) {\n            return;\n        }\n        if(socket.readyState == WebSocket.OPEN) {\n            // \u901a\u8fc7socket \u53d1\u9001\u6d88\u606f\n            socket.send(message)\n        } else {\n            alert("\u8fde\u63a5\u6ca1\u6709\u5f00\u542f");\n        }\n    }\n<\/script>\n    <form onsubmit="return false">\n        <textarea name="message" style="height: 300px; width: 300px"></textarea>\n        <input type="button" value="\u53d1\u751f\u6d88\u606f" onclick="send(this.form.message.value)">\n        <textarea id="responseText" style="height: 300px; width: 300px"></textarea>\n        <input type="button" value="\u6e05\u7a7a\u5185\u5bb9" onclick="document.getElementById(\'responseText\').value=\'\'">\n    </form>\n</body>\n</html>\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u53c2\u6570\u8c03\u4f18",children:"\u53c2\u6570\u8c03\u4f18"}),"\n",(0,l.jsx)(n.h4,{id:"connect",children:"CONNECT"}),"\n",(0,l.jsx)(n.p,{children:"\u53c2\u6570\u914d\u7f6e\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5ba2\u6237\u7aef\u901a\u8fc7 .option() \u65b9\u6cd5\u914d\u7f6e\u53c2\u6570\uff0c\u7ed9 SocketChannel \u914d\u7f6e\u53c2\u6570"}),"\n",(0,l.jsxs)(n.li,{children:["\u670d\u52a1\u5668\u7aef\uff1a\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"new ServerBootstrap().option()\uff1a \u7ed9 ServerSocketChannel \u914d\u7f6e\u53c2\u6570"}),"\n",(0,l.jsx)(n.li,{children:"new ServerBootstrap().childOption()\uff1a\u7ed9 SocketChannel \u914d\u7f6e\u53c2\u6570"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"CONNECT_TIMEOUT_MILLIS \u53c2\u6570\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5c5e\u4e8e SocketChannal \u53c2\u6570"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5728\u5ba2\u6237\u7aef\u5efa\u7acb\u8fde\u63a5\u65f6\uff0c\u5982\u679c\u5728\u6307\u5b9a\u6beb\u79d2\u5185\u65e0\u6cd5\u8fde\u63a5\uff0c\u4f1a\u629b\u51fa timeout \u5f02\u5e38"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"SO_TIMEOUT \u4e3b\u8981\u7528\u5728\u963b\u585e IO\uff0c\u963b\u585e IO \u4e2d accept\uff0cread \u7b49\u90fd\u662f\u65e0\u9650\u7b49\u5f85\u7684\uff0c\u5982\u679c\u4e0d\u5e0c\u671b\u6c38\u8fdc\u963b\u585e\uff0c\u53ef\u4ee5\u8c03\u6574\u8d85\u65f6\u65f6\u95f4"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class ConnectionTimeoutTest {\n    public static void main(String[] args) {\n        NioEventLoopGroup group = new NioEventLoopGroup();\n        try {\n            Bootstrap bootstrap = new Bootstrap()\n                    .group(group)\n                    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)\n                    .channel(NioSocketChannel.class)\n                    .handler(new LoggingHandler());\n            ChannelFuture future = bootstrap.connect("127.0.0.1", 8080);\n            future.sync().channel().closeFuture().sync();\n        } catch (Exception e) {\n            e.printStackTrace();\n            log.debug("timeout");\n        } finally {\n            group.shutdownGracefully();\n        }\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"so_backlog",children:"SO_BACKLOG"}),"\n",(0,l.jsxs)(n.p,{children:["\u5c5e\u4e8e ServerSocketChannal \u53c2\u6570\uff0c\u901a\u8fc7 ",(0,l.jsx)(n.code,{children:"option(ChannelOption.SO_BACKLOG, value)"})," \u6765\u8bbe\u7f6e\u5927\u5c0f"]}),"\n",(0,l.jsx)(n.p,{children:"\u5728 Linux 2.2 \u4e4b\u524d\uff0cbacklog \u5927\u5c0f\u5305\u62ec\u4e86\u4e24\u4e2a\u961f\u5217\u7684\u5927\u5c0f\uff0c\u5728 2.2 \u4e4b\u540e\uff0c\u5206\u522b\u7528\u4e0b\u9762\u4e24\u4e2a\u53c2\u6570\u6765\u63a7\u5236"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["sync queue\uff1a\u534a\u8fde\u63a5\u961f\u5217\uff0c\u5927\u5c0f\u901a\u8fc7 ",(0,l.jsx)(n.code,{children:"/proc/sys/net/ipv4/tcp_max_syn_backlog"})," \u6307\u5b9a\uff0c\u5728 ",(0,l.jsx)(n.code,{children:"syncookies"})," \u542f\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u903b\u8f91\u4e0a\u6ca1\u6709\u6700\u5927\u503c\u9650\u5236"]}),"\n",(0,l.jsxs)(n.li,{children:["accept queue\uff1a\u5168\u8fde\u63a5\u961f\u5217\uff0c\u5927\u5c0f\u901a\u8fc7 ",(0,l.jsx)(n.code,{children:"/proc/sys/net/core/somaxconn"})," \u6307\u5b9a\uff0c\u5728\u4f7f\u7528 listen \u51fd\u6570\u65f6\uff0c\u5185\u6838\u4f1a\u6839\u636e\u4f20\u5165\u7684 backlog \u53c2\u6570\u4e0e\u7cfb\u7edf\u53c2\u6570\uff0c\u53d6\u4e8c\u8005\u7684\u8f83\u5c0f\u503c\u3002\u5982\u679c accpet queue \u961f\u5217\u6ee1\u4e86\uff0cserver \u5c06",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u4e00\u4e2a\u62d2\u7edd\u8fde\u63a5\u7684\u9519\u8bef\u4fe1\u606f"}),"\u5230 client"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(47418).A+"",width:"837",height:"834"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5176\u4ed6\u53c2\u6570",children:"\u5176\u4ed6\u53c2\u6570"}),"\n",(0,l.jsx)(n.p,{children:"ALLOCATOR\uff1a\u5c5e\u4e8e SocketChannal \u53c2\u6570\uff0c\u7528\u6765\u5206\u914d ByteBuf\uff0c ctx.alloc()"}),"\n",(0,l.jsx)(n.p,{children:"RCVBUF_ALLOCATOR\uff1a\u5c5e\u4e8e SocketChannal \u53c2\u6570"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u63a7\u5236 Netty \u63a5\u6536\u7f13\u51b2\u533a\u5927\u5c0f"}),"\n",(0,l.jsx)(n.li,{children:"\u8d1f\u8d23\u5165\u7ad9\u6570\u636e\u7684\u5206\u914d\uff0c\u51b3\u5b9a\u5165\u7ad9\u7f13\u51b2\u533a\u7684\u5927\u5c0f\uff08\u5e76\u53ef\u52a8\u6001\u8c03\u6574\uff09\uff0c\u7edf\u4e00\u91c7\u7528 direct \u76f4\u63a5\u5185\u5b58\uff0c\u5177\u4f53\u6c60\u5316\u8fd8\u662f\u975e\u6c60\u5316\u7531 allocator \u51b3\u5b9a"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h1,{id:"rocketmq",children:"RocketMQ"}),"\n",(0,l.jsx)(n.h2,{id:"\u57fa\u672c\u4ecb\u7ecd-6",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.h3,{id:"\u6d88\u606f\u961f\u5217",children:"\u6d88\u606f\u961f\u5217"}),"\n",(0,l.jsx)(n.h4,{id:"\u5e94\u7528\u573a\u666f",children:"\u5e94\u7528\u573a\u666f"}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u961f\u5217\u662f\u4e00\u79cd\u5148\u8fdb\u5148\u51fa\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5e38\u89c1\u7684\u5e94\u7528\u573a\u666f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5e94\u7528\u89e3\u8026\uff1a\u7cfb\u7edf\u7684\u8026\u5408\u6027\u8d8a\u9ad8\uff0c\u5bb9\u9519\u6027\u5c31\u8d8a\u4f4e"}),"\n",(0,l.jsx)(n.p,{children:"\u5b9e\u4f8b\uff1a\u7528\u6237\u521b\u5efa\u8ba2\u5355\u540e\uff0c\u8026\u5408\u8c03\u7528\u5e93\u5b58\u7cfb\u7edf\u3001\u7269\u6d41\u7cfb\u7edf\u3001\u652f\u4ed8\u7cfb\u7edf\uff0c\u4efb\u4f55\u4e00\u4e2a\u5b50\u7cfb\u7edf\u51fa\u4e86\u6545\u969c\u90fd\u4f1a\u9020\u6210\u4e0b\u5355\u5f02\u5e38\uff0c\u5f71\u54cd\u7528\u6237\u4f7f\u7528\u4f53\u9a8c\u3002\u4f7f\u7528\u6d88\u606f\u961f\u5217\u89e3\u8026\u5408\uff0c\u6bd4\u5982\u7269\u6d41\u7cfb\u7edf\u53d1\u751f\u6545\u969c\uff0c\u9700\u8981\u51e0\u5206\u949f\u6062\u590d\uff0c\u5c06\u7269\u6d41\u7cfb\u7edf\u8981\u5904\u7406\u7684\u6570\u636e\u7f13\u5b58\u5230\u6d88\u606f\u961f\u5217\u4e2d\uff0c\u7528\u6237\u7684\u4e0b\u5355\u64cd\u4f5c\u6b63\u5e38\u5b8c\u6210\u3002\u7b49\u5f85\u7269\u6d41\u7cfb\u7edf\u6b63\u5e38\u540e\u5904\u7406\u5b58\u5728\u6d88\u606f\u961f\u5217\u4e2d\u7684\u8ba2\u5355\u6d88\u606f\u5373\u53ef\uff0c\u7ec8\u7aef\u7cfb\u7edf\u611f\u77e5\u4e0d\u5230\u7269\u6d41\u7cfb\u7edf\u53d1\u751f\u8fc7\u51e0\u5206\u949f\u6545\u969c"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(22870).A+"",width:"1020",height:"271"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d41\u91cf\u524a\u5cf0\uff1a\u5e94\u7528\u7cfb\u7edf\u5982\u679c\u9047\u5230\u7cfb\u7edf\u8bf7\u6c42\u6d41\u91cf\u7684\u77ac\u95f4\u731b\u589e\uff0c\u6709\u53ef\u80fd\u4f1a\u5c06\u7cfb\u7edf\u538b\u57ae\uff0c\u4f7f\u7528\u6d88\u606f\u961f\u5217\u53ef\u4ee5\u5c06\u5927\u91cf\u8bf7\u6c42\u7f13\u5b58\u8d77\u6765\uff0c\u5206\u6563\u5230\u5f88\u957f\u4e00\u6bb5\u65f6\u95f4\u5904\u7406\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u548c\u7528\u6237\u4f53\u9a8c"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(16875).A+"",width:"812",height:"345"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u5206\u53d1\uff1a\u8ba9\u6570\u636e\u5728\u591a\u4e2a\u7cfb\u7edf\u66f4\u52a0\u4e4b\u95f4\u8fdb\u884c\u6d41\u901a\uff0c\u6570\u636e\u7684\u4ea7\u751f\u65b9\u4e0d\u9700\u8981\u5173\u5fc3\u8c01\u6765\u4f7f\u7528\u6570\u636e\uff0c\u53ea\u9700\u8981\u5c06\u6570\u636e\u53d1\u9001\u5230\u6d88\u606f\u961f\u5217\uff0c\u6570\u636e\u4f7f\u7528\u65b9\u76f4\u63a5\u5728\u6d88\u606f\u961f\u5217\u4e2d\u76f4\u63a5\u83b7\u53d6\u6570\u636e"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(8712).A+"",width:"656",height:"368"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,l.jsx)(n.a,{href:"https://www.bilibili.com/video/BV1L4411y7mn",children:"https://www.bilibili.com/video/BV1L4411y7mn"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u6280\u672f\u9009\u578b",children:"\u6280\u672f\u9009\u578b"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u5bf9\u6bd4 Kafka \u7684\u4f18\u70b9"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u652f\u6301 Pull\u548c Push \u4e24\u79cd\u6d88\u606f\u6a21\u5f0f"}),"\n"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u652f\u6301\u5ef6\u65f6\u6d88\u606f\u3001\u6b7b\u4fe1\u961f\u5217\u3001\u6d88\u606f\u91cd\u8bd5\u3001\u6d88\u606f\u56de\u6eaf\u3001\u6d88\u606f\u8ddf\u8e2a\u3001\u4e8b\u52a1\u6d88\u606f\u7b49\u9ad8\u7ea7\u7279\u6027"}),"\n",(0,l.jsxs)(n.li,{children:["\u5bf9\u6d88\u606f\u53ef\u9760\u6027\u505a\u4e86\u6539\u8fdb\uff0c",(0,l.jsx)(n.strong,{children:"\u4fdd\u8bc1\u6d88\u606f\u4e0d\u4e22\u5931\u5e76\u4e14\u81f3\u5c11\u6d88\u8d39\u4e00\u6b21"}),"\uff0c\u4e0e Kafka \u4e00\u6837\u662f\u5148\u5199 PageCache \u518d\u843d\u76d8\uff0c\u5e76\u4e14\u6570\u636e\u6709\u591a\u526f\u672c"]}),"\n",(0,l.jsx)(n.li,{children:"RocketMQ \u5b58\u50a8\u6a21\u578b\u662f\u6240\u6709\u7684 Topic \u90fd\u5199\u5230\u540c\u4e00\u4e2a Commitlog \u91cc\uff0c\u662f\u4e00\u4e2a append only \u64cd\u4f5c\uff0c\u5728\u6d77\u91cf Topic \u4e0b\u4e5f\u80fd\u5c06\u78c1\u76d8\u7684\u6027\u80fd\u53d1\u6325\u5230\u6781\u81f4\uff0c\u5e76\u4e14\u4fdd\u6301\u7a33\u5b9a\u7684\u5199\u5165\u65f6\u5ef6\u3002Kafka \u7684\u541e\u5410\u975e\u5e38\u9ad8\uff08\u96f6\u62f7\u8d1d\u3001\u64cd\u4f5c\u7cfb\u7edf\u9875\u7f13\u5b58\u3001\u78c1\u76d8\u987a\u5e8f\u5199\uff09\uff0c\u4f46\u662f\u5728\u591a Topic \u4e0b\u65f6\u5ef6\u4e0d\u591f\u7a33\u5b9a\uff08\u987a\u5e8f\u5199\u5165\u7279\u6027\u4f1a\u88ab\u7834\u574f\u4ece\u800c\u5f15\u5165\u5927\u91cf\u7684\u968f\u673a I/O\uff09\uff0c\u4e0d\u9002\u5408\u5b9e\u65f6\u5728\u7ebf\u4e1a\u52a1\u573a\u666f"}),"\n",(0,l.jsx)(n.li,{children:"\u7ecf\u8fc7\u963f\u91cc\u5df4\u5df4\u591a\u5e74\u53cc 11 \u9a8c\u8bc1\u8fc7\u3001\u53ef\u4ee5\u652f\u6301\u4ebf\u7ea7\u5e76\u53d1\u7684\u5f00\u6e90\u6d88\u606f\u961f\u5217"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Kafka \u6bd4 RocketMQ \u541e\u5410\u91cf\u9ad8\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Kafka \u5c06 Producer \u7aef\u5c06\u591a\u4e2a\u5c0f\u6d88\u606f\u5408\u5e76\uff0c\u91c7\u7528\u5f02\u6b65\u6279\u91cf\u53d1\u9001\u7684\u673a\u5236\uff0c\u5f53\u53d1\u9001\u4e00\u6761\u6d88\u606f\u65f6\uff0c\u6d88\u606f\u5e76\u6ca1\u6709\u53d1\u9001\u5230 Broker \u800c\u662f\u7f13\u5b58\u8d77\u6765\uff0c\u76f4\u63a5\u5411\u4e1a\u52a1\u8fd4\u56de\u6210\u529f\uff0c\u5f53\u7f13\u5b58\u7684\u6d88\u606f\u8fbe\u5230\u4e00\u5b9a\u6570\u91cf\u65f6\u518d\u6279\u91cf\u53d1\u9001"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u51cf\u5c11\u4e86\u7f51\u7edc I/O\uff0c\u63d0\u9ad8\u4e86\u6d88\u606f\u53d1\u9001\u7684\u6027\u80fd\uff0c\u4f46\u662f\u5982\u679c\u6d88\u606f\u53d1\u9001\u8005\u5b95\u673a\uff0c\u4f1a\u5bfc\u81f4\u6d88\u606f\u4e22\u5931\uff0c\u964d\u4f4e\u4e86\u53ef\u9760\u6027"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"RocketMQ \u7f13\u5b58\u8fc7\u591a\u6d88\u606f\u4f1a\u5bfc\u81f4\u9891\u7e41 GC\uff0c\u5e76\u4e14\u4e3a\u4e86\u4fdd\u8bc1\u53ef\u9760\u6027\u6ca1\u6709\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Topic \u7684 partition \u6570\u91cf\u8fc7\u591a\u65f6\uff0cKafka \u7684\u6027\u80fd\u4e0d\u5982 RocketMQ\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u4e24\u8005\u90fd\u4f7f\u7528\u6587\u4ef6\u5b58\u50a8\uff0c\u4f46\u662f Kafka \u662f\u4e00\u4e2a\u5206\u533a\u4e00\u4e2a\u6587\u4ef6\uff0cTopic \u8fc7\u591a\u65f6\u5206\u533a\u7684\u603b\u91cf\u4e5f\u4f1a\u589e\u52a0\uff0c\u8fc7\u591a\u7684\u6587\u4ef6\u5bfc\u81f4\u5bf9\u6d88\u606f\u5237\u76d8\u65f6\u51fa\u73b0\u6587\u4ef6\u7ade\u4e89\u78c1\u76d8\uff0c\u9020\u6210\u6027\u80fd\u7684\u4e0b\u964d\u3002",(0,l.jsx)(n.strong,{children:"\u4e00\u4e2a\u5206\u533a\u53ea\u80fd\u88ab\u4e00\u4e2a\u6d88\u8d39\u7ec4\u4e2d\u7684\u4e00\u4e2a\u6d88\u8d39\u7ebf\u7a0b\u8fdb\u884c\u6d88\u8d39"}),"\uff0c\u56e0\u6b64\u53ef\u4ee5\u540c\u65f6\u6d88\u8d39\u7684\u6d88\u8d39\u7aef\u4e5f\u6bd4\u8f83\u5c11"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"RocketMQ \u6240\u6709\u961f\u5217\u90fd\u5b58\u50a8\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\uff0c\u6bcf\u4e2a\u961f\u5217\u5b58\u50a8\u7684\u6d88\u606f\u91cf\u4e5f\u6bd4\u8f83\u5c0f\uff0c\u56e0\u6b64\u591a Topic \u7684\u5bf9 RocketMQ \u7684\u6027\u80fd\u7684\u5f71\u54cd\u8f83\u5c0f"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5b89\u88c5\u6d4b\u8bd5",children:"\u5b89\u88c5\u6d4b\u8bd5"}),"\n",(0,l.jsx)(n.p,{children:"\u5b89\u88c5\u9700\u8981 Java \u73af\u5883\uff0c\u4e0b\u8f7d\u89e3\u538b\u540e\u8fdb\u5165\u5b89\u88c5\u76ee\u5f55\uff0c\u8fdb\u884c\u542f\u52a8\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u542f\u52a8 NameServer"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"# 1.\u542f\u52a8 NameServer\nnohup sh bin/mqnamesrv &\n# 2.\u67e5\u770b\u542f\u52a8\u65e5\u5fd7\ntail -f ~/logs/rocketmqlogs/namesrv.log\n"})}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u9ed8\u8ba4\u7684\u865a\u62df\u673a\u5185\u5b58\u8f83\u5927\uff0c\u9700\u8981\u7f16\u8f91\u5982\u4e0b\u4e24\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u4fee\u6539 JVM \u5185\u5b58\u5927\u5c0f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u7f16\u8f91runbroker.sh\u548crunserver.sh\u4fee\u6539\u9ed8\u8ba4JVM\u5927\u5c0f\nvi runbroker.sh\nvi runserver.sh\n"})}),"\n",(0,l.jsx)(n.p,{children:'\u53c2\u8003\u914d\u7f6e\uff1aJAVA_OPT="${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m  -XX:MaxMetaspaceSize=320m"'}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u542f\u52a8 Broker"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"# 1.\u542f\u52a8 Broker\nnohup sh bin/mqbroker -n localhost:9876 autoCreateTopicEnable=true &\n# 2.\u67e5\u770b\u542f\u52a8\u65e5\u5fd7\ntail -f ~/logs/rocketmqlogs/broker.log \n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u53d1\u9001\u6d88\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"# 1.\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\nexport NAMESRV_ADDR=localhost:9876\n# 2.\u4f7f\u7528\u5b89\u88c5\u5305\u7684 Demo \u53d1\u9001\u6d88\u606f\nsh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u63a5\u53d7\u6d88\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"# 1.\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\nexport NAMESRV_ADDR=localhost:9876\n# 2.\u63a5\u6536\u6d88\u606f\nsh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer\n\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5173\u95ed RocketMQ\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"# 1.\u5173\u95ed NameServer\nsh bin/mqshutdown namesrv\n# 2.\u5173\u95ed Broker\nsh bin/mqshutdown broker\n\n\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u76f8\u5173\u6982\u5ff5",children:"\u76f8\u5173\u6982\u5ff5"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u4e3b\u8981\u7531 Producer\u3001Broker\u3001Consumer \u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u5176\u4e2d Producer \u8d1f\u8d23\u751f\u4ea7\u6d88\u606f\uff0cConsumer \u8d1f\u8d23\u6d88\u8d39\u6d88\u606f\uff0cBroker \u8d1f\u8d23\u5b58\u50a8\u6d88\u606f\uff0cNameServer \u8d1f\u8d23\u7ba1\u7406 Broker"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u4ee3\u7406\u670d\u52a1\u5668\uff08Broker Server\uff09\uff1a\u6d88\u606f\u4e2d\u8f6c\u89d2\u8272\uff0c\u8d1f\u8d23",(0,l.jsx)(n.strong,{children:"\u5b58\u50a8\u6d88\u606f\u3001\u8f6c\u53d1\u6d88\u606f"}),"\u3002\u5728 RocketMQ \u7cfb\u7edf\u4e2d\u8d1f\u8d23\u63a5\u6536\u4ece\u751f\u4ea7\u8005\u53d1\u9001\u6765\u7684\u6d88\u606f\u5e76\u5b58\u50a8\u3001\u540c\u65f6\u4e3a\u6d88\u8d39\u8005\u7684\u62c9\u53d6\u8bf7\u6c42\u4f5c\u51c6\u5907\uff0c\u4e5f\u5b58\u50a8\u6d88\u606f\u76f8\u5173\u7684\u5143\u6570\u636e\uff0c\u5305\u62ec\u6d88\u8d39\u8005\u7ec4\u3001\u6d88\u8d39\u8fdb\u5ea6\u504f\u79fb\u548c\u4e3b\u9898\u548c\u961f\u5217\u6d88\u606f\u7b49"]}),"\n",(0,l.jsxs)(n.li,{children:["\u540d\u5b57\u670d\u52a1\uff08Name Server\uff09\uff1a\u5145\u5f53",(0,l.jsx)(n.strong,{children:"\u8def\u7531\u6d88\u606f"}),"\u7684\u63d0\u4f9b\u8005\u3002\u751f\u4ea7\u8005\u6216\u6d88\u8d39\u8005\u80fd\u591f\u901a\u8fc7\u540d\u5b57\u670d\u52a1\u67e5\u627e\u5404\u4e3b\u9898\u76f8\u5e94\u7684 Broker IP \u5217\u8868"]}),"\n",(0,l.jsxs)(n.li,{children:["\u6d88\u606f\u751f\u4ea7\u8005\uff08Producer\uff09\uff1a\u8d1f\u8d23",(0,l.jsx)(n.strong,{children:"\u751f\u4ea7\u6d88\u606f"}),"\uff0c\u628a\u4e1a\u52a1\u5e94\u7528\u7cfb\u7edf\u91cc\u4ea7\u751f\u7684\u6d88\u606f\u53d1\u9001\u5230 Broker \u670d\u52a1\u5668\u3002RocketMQ \u63d0\u4f9b\u591a\u79cd\u53d1\u9001\u65b9\u5f0f\uff0c\u540c\u6b65\u53d1\u9001\u3001\u5f02\u6b65\u53d1\u9001\u3001\u987a\u5e8f\u53d1\u9001\u3001\u5355\u5411\u53d1\u9001\uff0c\u540c\u6b65\u548c\u5f02\u6b65\u65b9\u5f0f\u5747\u9700\u8981 Broker \u8fd4\u56de\u786e\u8ba4\u4fe1\u606f\uff0c\u5355\u5411\u53d1\u9001\u4e0d\u9700\u8981\uff1b\u53ef\u4ee5\u901a\u8fc7 MQ \u7684\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u9009\u62e9\u76f8\u5e94\u7684 Broker \u96c6\u7fa4\u961f\u5217\u8fdb\u884c\u6d88\u606f\u6295\u9012\uff0c\u6295\u9012\u7684\u8fc7\u7a0b\u652f\u6301\u5feb\u901f\u5931\u8d25\u5e76\u4e14\u4f4e\u5ef6\u8fdf"]}),"\n",(0,l.jsxs)(n.li,{children:["\u6d88\u606f\u6d88\u8d39\u8005\uff08Consumer\uff09\uff1a\u8d1f\u8d23",(0,l.jsx)(n.strong,{children:"\u6d88\u8d39\u6d88\u606f"}),"\uff0c\u4e00\u822c\u662f\u540e\u53f0\u7cfb\u7edf\u8d1f\u8d23\u5f02\u6b65\u6d88\u8d39\uff0c\u4e00\u4e2a\u6d88\u606f\u6d88\u8d39\u8005\u4f1a\u4ece Broker \u670d\u52a1\u5668\u62c9\u53d6\u6d88\u606f\u3001\u5e76\u5c06\u5176\u63d0\u4f9b\u7ed9\u5e94\u7528\u7a0b\u5e8f\u3002\u4ece\u7528\u6237\u5e94\u7528\u7684\u89d2\u5ea6\u800c\u63d0\u4f9b\u4e86\u4e24\u79cd\u6d88\u8d39\u5f62\u5f0f\uff1a\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u62c9\u53d6\u5f0f\u6d88\u8d39\uff08Pull Consumer\uff09\uff1a\u5e94\u7528\u901a\u4e3b\u52a8\u8c03\u7528 Consumer \u7684\u62c9\u6d88\u606f\u65b9\u6cd5\u4ece Broker \u670d\u52a1\u5668\u62c9\u6d88\u606f\uff0c\u4e3b\u52a8\u6743\u7531\u5e94\u7528\u63a7\u5236\uff0c\u4e00\u65e6\u83b7\u53d6\u4e86\u6279\u91cf\u6d88\u606f\uff0c\u5e94\u7528\u5c31\u4f1a\u542f\u52a8\u6d88\u8d39\u8fc7\u7a0b"}),"\n",(0,l.jsx)(n.li,{children:"\u63a8\u52a8\u5f0f\u6d88\u8d39\uff08Push Consumer\uff09\uff1a\u8be5\u6a21\u5f0f\u4e0b Broker \u6536\u5230\u6570\u636e\u540e\u4f1a\u4e3b\u52a8\u63a8\u9001\u7ed9\u6d88\u8d39\u7aef\uff0c\u5b9e\u65f6\u6027\u8f83\u9ad8"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u751f\u4ea7\u8005\u7ec4\uff08Producer Group\uff09\uff1a\u540c\u4e00\u7c7b Producer \u7684\u96c6\u5408\uff0c\u53d1\u9001\u540c\u4e00\u7c7b\u6d88\u606f\u4e14\u53d1\u9001\u903b\u8f91\u4e00\u81f4\u3002\u5982\u679c\u53d1\u9001\u7684\u662f\u4e8b\u52a1\u6d88\u606f\u4e14\u539f\u59cb\u751f\u4ea7\u8005\u5728\u53d1\u9001\u4e4b\u540e\u5d29\u6e83\uff0c",(0,l.jsx)(n.strong,{children:"\u5219 Broker \u670d\u52a1\u5668\u4f1a\u8054\u7cfb\u540c\u4e00\u751f\u4ea7\u8005\u7ec4\u7684\u5176\u4ed6\u751f\u4ea7\u8005\u5b9e\u4f8b\u4ee5\u63d0\u4ea4\u6216\u56de\u6eaf\u6d88\u8d39"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u6d88\u8d39\u8005\u7ec4\uff08Consumer Group\uff09\uff1a\u540c\u4e00\u7c7b Consumer \u7684\u96c6\u5408\uff0c\u6d88\u8d39\u8005\u5b9e\u4f8b\u5fc5\u987b\u8ba2\u9605\u5b8c\u5168\u76f8\u540c\u7684 Topic\uff0c\u6d88\u8d39\u540c\u4e00\u7c7b\u6d88\u606f\u4e14\u6d88\u8d39\u903b\u8f91\u4e00\u81f4\u3002\u6d88\u8d39\u8005\u7ec4\u4f7f\u5f97\u5728\u6d88\u606f\u6d88\u8d39\u65b9\u9762\u66f4\u5bb9\u6613\u7684\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u548c\u5bb9\u9519\u3002RocketMQ \u652f\u6301\u4e24\u79cd\u6d88\u606f\u6a21\u5f0f\uff1a\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u96c6\u7fa4\u6d88\u8d39\uff08Clustering\uff09\uff1a\u76f8\u540c Consumer Group \u7684\u6bcf\u4e2a Consumer \u5b9e\u4f8b\u5e73\u5747\u5206\u644a\u6d88\u606f"}),"\n",(0,l.jsx)(n.li,{children:"\u5e7f\u64ad\u6d88\u8d39\uff08Broadcasting\uff09\uff1a\u76f8\u540c Consumer Group \u7684\u6bcf\u4e2a Consumer \u5b9e\u4f8b\u90fd\u63a5\u6536\u5168\u91cf\u7684\u6d88\u606f"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6bcf\u4e2a Broker \u53ef\u4ee5\u5b58\u50a8\u591a\u4e2a Topic \u7684\u6d88\u606f\uff0c\u6bcf\u4e2a Topic \u7684\u6d88\u606f\u4e5f\u53ef\u4ee5\u5206\u7247\u5b58\u50a8\u4e8e\u4e0d\u540c\u7684 Broker\uff0cMessage Queue\uff08\u6d88\u606f\u961f\u5217\uff09\u662f\u7528\u4e8e\u5b58\u50a8\u6d88\u606f\u7684\u7269\u7406\u5730\u5740\uff0c\u6bcf\u4e2a Topic \u4e2d\u7684\u6d88\u606f\u5730\u5740\u5b58\u50a8\u4e8e\u591a\u4e2a Message Queue \u4e2d"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e3b\u9898\uff08Topic\uff09\uff1a\u8868\u793a\u4e00\u7c7b\u6d88\u606f\u7684\u96c6\u5408\uff0c\u6bcf\u4e2a\u4e3b\u9898\u5305\u542b\u82e5\u5e72\u6761\u6d88\u606f\uff0c\u6bcf\u6761\u6d88\u606f\u53ea\u5c5e\u4e8e\u4e00\u4e2a\u4e3b\u9898\uff0c\u662f RocketMQ \u6d88\u606f\u8ba2\u9605\u7684\u57fa\u672c\u5355\u4f4d"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\uff08Message\uff09\uff1a\u6d88\u606f\u7cfb\u7edf\u6240\u4f20\u8f93\u4fe1\u606f\u7684\u7269\u7406\u8f7d\u4f53\uff0c\u751f\u4ea7\u548c\u6d88\u8d39\u6570\u636e\u7684\u6700\u5c0f\u5355\u4f4d\uff0c\u6bcf\u6761\u6d88\u606f\u5fc5\u987b\u5c5e\u4e8e\u4e00\u4e2a\u4e3b\u9898\u3002RocketMQ \u4e2d\u6bcf\u4e2a\u6d88\u606f\u62e5\u6709\u552f\u4e00\u7684 Message ID\uff0c\u4e14\u53ef\u4ee5\u643a\u5e26\u5177\u6709\u4e1a\u52a1\u6807\u8bc6\u7684 Key\uff0c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u901a\u8fc7 Message ID \u548c Key \u67e5\u8be2\u6d88\u606f\u7684\u529f\u80fd"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6807\u7b7e\uff08Tag\uff09\uff1a\u4e3a\u6d88\u606f\u8bbe\u7f6e\u7684\u6807\u5fd7\uff0c\u7528\u4e8e\u540c\u4e00\u4e3b\u9898\u4e0b\u533a\u5206\u4e0d\u540c\u7c7b\u578b\u7684\u6d88\u606f\u3002\u6807\u7b7e\u80fd\u591f\u6709\u6548\u5730\u4fdd\u6301\u4ee3\u7801\u7684\u6e05\u6670\u5ea6\u548c\u8fde\u8d2f\u6027\uff0c\u5e76\u4f18\u5316 RocketMQ \u63d0\u4f9b\u7684\u67e5\u8be2\u7cfb\u7edf\uff0c\u6d88\u8d39\u8005\u53ef\u4ee5\u6839\u636e Tag \u5b9e\u73b0\u5bf9\u4e0d\u540c\u5b50\u4e3b\u9898\u7684\u4e0d\u540c\u6d88\u8d39\u903b\u8f91\uff0c\u5b9e\u73b0\u66f4\u597d\u7684\u6269\u5c55\u6027"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u666e\u901a\u987a\u5e8f\u6d88\u606f\uff08Normal Ordered Message\uff09\uff1a\u6d88\u8d39\u8005\u901a\u8fc7\u540c\u4e00\u4e2a\u6d88\u606f\u961f\u5217\uff08Topic \u5206\u533a\uff09\u6536\u5230\u7684\u6d88\u606f\u662f\u6709\u987a\u5e8f\u7684\uff0c\u4e0d\u540c\u6d88\u606f\u961f\u5217\u6536\u5230\u7684\u6d88\u606f\u5219\u53ef\u80fd\u662f\u65e0\u987a\u5e8f\u7684"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e25\u683c\u987a\u5e8f\u6d88\u606f\uff08Strictly Ordered Message\uff09\uff1a\u6d88\u8d39\u8005\u6536\u5230\u7684\u6240\u6709\u6d88\u606f\u5747\u662f\u6709\u987a\u5e8f\u7684"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5b98\u65b9\u6587\u6863\uff1a",(0,l.jsx)(n.a,{href:"https://github.com/apache/rocketmq/tree/master/docs/cn%EF%BC%88%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E9%83%A8%E5%88%86%E7%9A%84%E7%AC%94%E8%AE%B0%E5%8F%82%E8%80%83%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%BC%96%E5%86%99%EF%BC%89",children:"https://github.com/apache/rocketmq/tree/master/docs/cn\uff08\u57fa\u7840\u77e5\u8bc6\u90e8\u5206\u7684\u7b14\u8bb0\u53c2\u8003\u5b98\u65b9\u6587\u6863\u7f16\u5199\uff09"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u6d88\u606f\u64cd\u4f5c",children:"\u6d88\u606f\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u672c\u6837\u4f8b",children:"\u57fa\u672c\u6837\u4f8b"}),"\n",(0,l.jsx)(n.h4,{id:"\u8ba2\u9605\u53d1\u5e03",children:"\u8ba2\u9605\u53d1\u5e03"}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u7684\u53d1\u5e03\u662f\u6307\u67d0\u4e2a\u751f\u4ea7\u8005\u5411\u67d0\u4e2a Topic \u53d1\u9001\u6d88\u606f\uff0c\u6d88\u606f\u7684\u8ba2\u9605\u662f\u6307\u67d0\u4e2a\u6d88\u8d39\u8005\u5173\u6ce8\u4e86\u67d0\u4e2a Topic \u4e2d\u5e26\u6709\u67d0\u4e9b Tag \u7684\u6d88\u606f\uff0c\u8fdb\u800c\u4ece\u8be5 Topic \u6d88\u8d39\u6570\u636e"}),"\n",(0,l.jsx)(n.p,{children:"\u5bfc\u5165 MQ \u5ba2\u6237\u7aef\u4f9d\u8d56\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.apache.rocketmq</groupId>\n    <artifactId>rocketmq-client</artifactId>\n    <version>4.4.0</version>\n</dependency>\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u53d1\u9001\u8005\u6b65\u9aa4\u5206\u6790\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u521b\u5efa\u6d88\u606f\u751f\u4ea7\u8005 Producer\uff0c\u5e76\u5236\u5b9a\u751f\u4ea7\u8005\u7ec4\u540d"}),"\n",(0,l.jsx)(n.li,{children:"\u6307\u5b9a Nameserver \u5730\u5740"}),"\n",(0,l.jsx)(n.li,{children:"\u542f\u52a8 Producer"}),"\n",(0,l.jsx)(n.li,{children:"\u521b\u5efa\u6d88\u606f\u5bf9\u8c61\uff0c\u6307\u5b9a\u4e3b\u9898 Topic\u3001Tag \u548c\u6d88\u606f\u4f53"}),"\n",(0,l.jsx)(n.li,{children:"\u53d1\u9001\u6d88\u606f"}),"\n",(0,l.jsx)(n.li,{children:"\u5173\u95ed\u751f\u4ea7\u8005 Producer"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u6d88\u8d39\u8005\u6b65\u9aa4\u5206\u6790\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u521b\u5efa\u6d88\u8d39\u8005 Consumer\uff0c\u5236\u5b9a\u6d88\u8d39\u8005\u7ec4\u540d"}),"\n",(0,l.jsx)(n.li,{children:"\u6307\u5b9a Nameserver \u5730\u5740"}),"\n",(0,l.jsx)(n.li,{children:"\u8ba2\u9605\u4e3b\u9898 Topic \u548c Tag"}),"\n",(0,l.jsx)(n.li,{children:"\u8bbe\u7f6e\u56de\u8c03\u51fd\u6570\uff0c\u5904\u7406\u6d88\u606f"}),"\n",(0,l.jsx)(n.li,{children:"\u542f\u52a8\u6d88\u8d39\u8005 Consumer"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5b98\u65b9\u6587\u6863\uff1a",(0,l.jsx)(n.a,{href:"https://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md",children:"https://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u53d1\u9001\u6d88\u606f",children:"\u53d1\u9001\u6d88\u606f"}),"\n",(0,l.jsx)(n.h5,{id:"\u540c\u6b65\u53d1\u9001",children:"\u540c\u6b65\u53d1\u9001"}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528 RocketMQ \u53d1\u9001\u4e09\u79cd\u7c7b\u578b\u7684\u6d88\u606f\uff1a\u540c\u6b65\u6d88\u606f\u3001\u5f02\u6b65\u6d88\u606f\u548c\u5355\u5411\u6d88\u606f\uff0c\u5176\u4e2d\u524d\u4e24\u79cd\u6d88\u606f\u662f\u53ef\u9760\u7684\uff0c\u56e0\u4e3a\u4f1a\u6709\u53d1\u9001\u662f\u5426\u6210\u529f\u7684\u5e94\u7b54"}),"\n",(0,l.jsx)(n.p,{children:"\u8fd9\u79cd\u53ef\u9760\u6027\u540c\u6b65\u5730\u53d1\u9001\u65b9\u5f0f\u4f7f\u7528\u7684\u6bd4\u8f83\u5e7f\u6cdb\uff0c\u6bd4\u5982\uff1a\u91cd\u8981\u7684\u6d88\u606f\u901a\u77e5\uff0c\u77ed\u4fe1\u901a\u77e5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class SyncProducer {\n\tpublic static void main(String[] args) throws Exception {\n    \t// \u5b9e\u4f8b\u5316\u6d88\u606f\u751f\u4ea7\u8005Producer\n        DefaultMQProducer producer = new DefaultMQProducer("please_rename_unique_group_name");\n    \t// \u8bbe\u7f6eNameServer\u7684\u5730\u5740\n    \tproducer.setNamesrvAddr("localhost:9876");\n    \t// \u542f\u52a8Producer\u5b9e\u4f8b\n        producer.start();\n    \tfor (int i = 0; i < 100; i++) {\n    \t    // \u521b\u5efa\u6d88\u606f\uff0c\u5e76\u6307\u5b9aTopic\uff0cTag\u548c\u6d88\u606f\u4f53\n    \t    Message msg = new Message(\n                "TopicTest" /* Topic */,\n                "TagA" /* Tag */,\n        \t\t("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */);\n            \n        \t// \u53d1\u9001\u6d88\u606f\u5230\u4e00\u4e2aBroker\n            SendResult sendResult = producer.send(msg);\n            // \u901a\u8fc7sendResult\u8fd4\u56de\u6d88\u606f\u662f\u5426\u6210\u529f\u9001\u8fbe\n            System.out.printf("%s%n", sendResult);\n    \t}\n    \t// \u5982\u679c\u4e0d\u518d\u53d1\u9001\u6d88\u606f\uff0c\u5173\u95edProducer\u5b9e\u4f8b\u3002\n    \tproducer.shutdown();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5f02\u6b65\u53d1\u9001",children:"\u5f02\u6b65\u53d1\u9001"}),"\n",(0,l.jsx)(n.p,{children:"\u5f02\u6b65\u6d88\u606f\u901a\u5e38\u7528\u5728\u5bf9\u54cd\u5e94\u65f6\u95f4\u654f\u611f\u7684\u4e1a\u52a1\u573a\u666f\uff0c\u5373\u53d1\u9001\u7aef\u4e0d\u80fd\u5bb9\u5fcd\u957f\u65f6\u95f4\u5730\u7b49\u5f85 Broker \u7684\u54cd\u5e94"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class AsyncProducer {\n\tpublic static void main(String[] args) throws Exception {\n    \t// \u5b9e\u4f8b\u5316\u6d88\u606f\u751f\u4ea7\u8005Producer\n        DefaultMQProducer producer = new DefaultMQProducer("please_rename_unique_group_name");\n    \t// \u8bbe\u7f6eNameServer\u7684\u5730\u5740\n        producer.setNamesrvAddr("localhost:9876");\n    \t// \u542f\u52a8Producer\u5b9e\u4f8b\n        producer.start();\n        producer.setRetryTimesWhenSendAsyncFailed(0);\n\t\n        int messageCount = 100;\n\t\t// \u6839\u636e\u6d88\u606f\u6570\u91cf\u5b9e\u4f8b\u5316\u5012\u8ba1\u65f6\u8ba1\u7b97\u5668\n        final CountDownLatch2 countDownLatch = new CountDownLatch2(messageCount);\n        for (int i = 0; i < messageCount; i++) {\n            final int index = i;\n            // \u521b\u5efa\u6d88\u606f\uff0c\u5e76\u6307\u5b9aTopic\uff0cTag\u548c\u6d88\u606f\u4f53\n            Message msg = new Message("TopicTest", "TagA", "OrderID188",\n                                      "Hello world".getBytes(RemotingHelper.DEFAULT_CHARSET));\n\n            // SendCallback\u63a5\u6536\u5f02\u6b65\u8fd4\u56de\u7ed3\u679c\u7684\u56de\u8c03\n            producer.send(msg, new SendCallback() {\n                // \u53d1\u9001\u6210\u529f\u56de\u8c03\u51fd\u6570\n                @Override\n                public void onSuccess(SendResult sendResult) {\n                    countDownLatch.countDown();\n                    System.out.printf("%-10d OK %s %n", index, sendResult.getMsgId());\n                }\n                \n                @Override\n                public void onException(Throwable e) {\n                    countDownLatch.countDown();\n                    System.out.printf("%-10d Exception %s %n", index, e);\n                    e.printStackTrace();\n                }\n            });\n        }\n        // \u7b49\u5f855s\n        countDownLatch.await(5, TimeUnit.SECONDS);\n        // \u5982\u679c\u4e0d\u518d\u53d1\u9001\u6d88\u606f\uff0c\u5173\u95edProducer\u5b9e\u4f8b\u3002\n        producer.shutdown();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5355\u5411\u53d1\u9001",children:"\u5355\u5411\u53d1\u9001"}),"\n",(0,l.jsx)(n.p,{children:"\u5355\u5411\u53d1\u9001\u4e3b\u8981\u7528\u5728\u4e0d\u7279\u522b\u5173\u5fc3\u53d1\u9001\u7ed3\u679c\u7684\u573a\u666f\uff0c\u4f8b\u5982\u65e5\u5fd7\u53d1\u9001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class OnewayProducer {\n\tpublic static void main(String[] args) throws Exception{\n    \t// \u5b9e\u4f8b\u5316\u6d88\u606f\u751f\u4ea7\u8005Producer\n        DefaultMQProducer producer = new DefaultMQProducer("please_rename_unique_group_name");\n    \t// \u8bbe\u7f6eNameServer\u7684\u5730\u5740\n        producer.setNamesrvAddr("localhost:9876");\n    \t// \u542f\u52a8Producer\u5b9e\u4f8b\n        producer.start();\n    \tfor (int i = 0; i < 100; i++) {\n        \t// \u521b\u5efa\u6d88\u606f\uff0c\u5e76\u6307\u5b9aTopic\uff0cTag\u548c\u6d88\u606f\u4f53\n        \tMessage msg = new Message("TopicTest","TagA",\n                          ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET));\n        \t// \u53d1\u9001\u5355\u5411\u6d88\u606f\uff0c\u6ca1\u6709\u4efb\u4f55\u8fd4\u56de\u7ed3\u679c\n        \tproducer.sendOneway(msg);\n    \t}\n    \t// \u5982\u679c\u4e0d\u518d\u53d1\u9001\u6d88\u606f\uff0c\u5173\u95edProducer\u5b9e\u4f8b\u3002\n    \tproducer.shutdown();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u6d88\u8d39\u6d88\u606f",children:"\u6d88\u8d39\u6d88\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class Consumer {\n\tpublic static void main(String[] args) throws InterruptedException, MQClientException {\n    \t// \u5b9e\u4f8b\u5316\u6d88\u8d39\u8005\n        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("please_rename_unique_group_name");\n    \t// \u8bbe\u7f6eNameServer\u7684\u5730\u5740\n        consumer.setNamesrvAddr("localhost:9876");\n\n    \t// \u8ba2\u9605\u4e00\u4e2a\u6216\u8005\u591a\u4e2aTopic\uff0c\u4ee5\u53caTag\u6765\u8fc7\u6ee4\u9700\u8981\u6d88\u8d39\u7684\u6d88\u606f\n        consumer.subscribe("TopicTest", "*");\n    \t// \u6ce8\u518c\u6d88\u606f\u76d1\u542c\u5668\uff0c\u56de\u8c03\u5b9e\u73b0\u7c7b\u6765\u5904\u7406\u4ecebroker\u62c9\u53d6\u56de\u6765\u7684\u6d88\u606f\n        consumer.registerMessageListener(new MessageListenerConcurrently() {\n            // \u63a5\u53d7\u6d88\u606f\u5185\u5bb9\n            @Override\n            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {\n                System.out.printf("%s Receive New Messages: %s %n", Thread.currentThread().getName(), msgs);\n                // \u6807\u8bb0\u8be5\u6d88\u606f\u5df2\u7ecf\u88ab\u6210\u529f\u6d88\u8d39\n                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n            }\n        });\n        // \u542f\u52a8\u6d88\u8d39\u8005\u5b9e\u4f8b\n        consumer.start();\n        System.out.printf("Consumer Started.%n");\n\t}\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u987a\u5e8f\u6d88\u606f",children:"\u987a\u5e8f\u6d88\u606f"}),"\n",(0,l.jsx)(n.h4,{id:"\u539f\u7406\u89e3\u6790",children:"\u539f\u7406\u89e3\u6790"}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u6709\u5e8f\u6307\u7684\u662f\u4e00\u7c7b\u6d88\u606f\u6d88\u8d39\u65f6\uff0c\u80fd\u6309\u7167\u53d1\u9001\u7684\u987a\u5e8f\u6765\u6d88\u8d39\u3002\u4f8b\u5982\uff1a\u4e00\u4e2a\u8ba2\u5355\u4ea7\u751f\u4e86\u4e09\u6761\u6d88\u606f\u5206\u522b\u662f\u8ba2\u5355\u521b\u5efa\u3001\u8ba2\u5355\u4ed8\u6b3e\u3001\u8ba2\u5355\u5b8c\u6210\u3002\u6d88\u8d39\u65f6\u8981\u6309\u7167\u8fd9\u4e2a\u987a\u5e8f\u6d88\u8d39\u624d\u80fd\u6709\u610f\u4e49\uff0c\u4f46\u662f\u540c\u65f6\u8ba2\u5355\u4e4b\u95f4\u662f\u53ef\u4ee5\u5e76\u884c\u6d88\u8d39\u7684\uff0cRocketMQ \u53ef\u4ee5\u4e25\u683c\u7684\u4fdd\u8bc1\u6d88\u606f\u6709\u5e8f\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u987a\u5e8f\u6d88\u606f\u5206\u4e3a\u5168\u5c40\u987a\u5e8f\u6d88\u606f\u4e0e\u5206\u533a\u987a\u5e8f\u6d88\u606f\uff0c"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5168\u5c40\u987a\u5e8f\uff1a\u5bf9\u4e8e\u6307\u5b9a\u7684\u4e00\u4e2a Topic\uff0c\u6240\u6709\u6d88\u606f\u6309\u7167\u4e25\u683c\u7684\u5148\u5165\u5148\u51fa\uff08FIFO\uff09\u7684\u987a\u5e8f\u8fdb\u884c\u53d1\u5e03\u548c\u6d88\u8d39\uff0c\u9002\u7528\u4e8e\u6027\u80fd\u8981\u6c42\u4e0d\u9ad8\uff0c\u6240\u6709\u7684\u6d88\u606f\u4e25\u683c\u6309\u7167 FIFO \u539f\u5219\u8fdb\u884c\u6d88\u606f\u53d1\u5e03\u548c\u6d88\u8d39\u7684\u573a\u666f"}),"\n",(0,l.jsx)(n.li,{children:"\u5206\u533a\u987a\u5e8f\uff1a\u5bf9\u4e8e\u6307\u5b9a\u7684\u4e00\u4e2a Topic\uff0c\u6240\u6709\u6d88\u606f\u6839\u636e Sharding key \u8fdb\u884c\u5206\u533a\uff0c\u540c\u4e00\u4e2a\u5206\u7ec4\u5185\u7684\u6d88\u606f\u6309\u7167\u4e25\u683c\u7684 FIFO \u987a\u5e8f\u8fdb\u884c\u53d1\u5e03\u548c\u6d88\u8d39\u3002Sharding key \u662f\u987a\u5e8f\u6d88\u606f\u4e2d\u7528\u6765\u533a\u5206\u4e0d\u540c\u5206\u533a\u7684\u5173\u952e\u5b57\u6bb5\uff0c\u548c\u666e\u901a\u6d88\u606f\u7684 Key \u662f\u5b8c\u5168\u4e0d\u540c\u7684\u6982\u5ff5\uff0c\u9002\u7528\u4e8e\u6027\u80fd\u8981\u6c42\u9ad8\u7684\u573a\u666f"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5728\u9ed8\u8ba4\u7684\u60c5\u51b5\u4e0b\u6d88\u606f\u53d1\u9001\u4f1a\u91c7\u53d6 Round Robin \u8f6e\u8be2\u65b9\u5f0f\u628a\u6d88\u606f\u53d1\u9001\u5230\u4e0d\u540c\u7684 queue\uff08\u5206\u533a\u961f\u5217\uff09\uff0c\u800c\u6d88\u8d39\u6d88\u606f\u662f\u4ece\u591a\u4e2a queue \u4e0a\u62c9\u53d6\u6d88\u606f\uff0c\u8fd9\u79cd\u60c5\u51b5\u53d1\u9001\u548c\u6d88\u8d39\u662f\u4e0d\u80fd\u4fdd\u8bc1\u987a\u5e8f\u3002\u4f46\u662f\u5982\u679c\u63a7\u5236\u53d1\u9001\u7684\u987a\u5e8f\u6d88\u606f\u53ea\u4f9d\u6b21\u53d1\u9001\u5230\u540c\u4e00\u4e2a queue \u4e2d\uff0c\u6d88\u8d39\u7684\u65f6\u5019\u53ea\u4ece\u8fd9\u4e2a queue \u4e0a\u4f9d\u6b21\u62c9\u53d6\uff0c\u5219\u5c31\u4fdd\u8bc1\u4e86\u987a\u5e8f\u3002\u5f53",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u548c\u6d88\u8d39\u53c2\u4e0e\u7684 queue \u53ea\u6709\u4e00\u4e2a"}),"\uff0c\u5219\u662f\u5168\u5c40\u6709\u5e8f\uff1b\u5982\u679c\u591a\u4e2aqueue \u53c2\u4e0e\uff0c\u5219\u4e3a\u5206\u533a\u6709\u5e8f\uff0c\u5373\u76f8\u5bf9\u6bcf\u4e2a queue\uff0c\u6d88\u606f\u90fd\u662f\u6709\u5e8f\u7684"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4ee3\u7801\u5b9e\u73b0-1",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u4e00\u4e2a\u8ba2\u5355\u7684\u987a\u5e8f\u6d41\u7a0b\u662f\uff1a\u521b\u5efa\u3001\u4ed8\u6b3e\u3001\u63a8\u9001\u3001\u5b8c\u6210\uff0c\u8ba2\u5355\u53f7\u76f8\u540c\u7684\u6d88\u606f\u4f1a\u88ab\u5148\u540e\u53d1\u9001\u5230\u540c\u4e00\u4e2a\u961f\u5217\u4e2d\uff0c\u6d88\u8d39\u65f6\u540c\u4e00\u4e2a OrderId \u83b7\u53d6\u5230\u7684\u80af\u5b9a\u662f\u540c\u4e00\u4e2a\u961f\u5217"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class Producer {\n    public static void main(String[] args) throws Exception {\n        DefaultMQProducer producer = new DefaultMQProducer("please_rename_unique_group_name");\n        producer.setNamesrvAddr("127.0.0.1:9876");\n        producer.start();\n\t\t// \u6807\u7b7e\u96c6\u5408\n        String[] tags = new String[]{"TagA", "TagC", "TagD"};\n\n        // \u8ba2\u5355\u5217\u8868\n        List<OrderStep> orderList = new Producer().buildOrders();\n\n        Date date = new Date();\n        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");\n        String dateStr = sdf.format(date);\n        for (int i = 0; i < 10; i++) {\n            // \u52a0\u4e2a\u65f6\u95f4\u524d\u7f00\n            String body = dateStr + " Hello RocketMQ " + orderList.get(i);\n            Message msg = new Message("OrderTopic", tags[i % tags.length], "KEY" + i, body.getBytes());\n\t\t\t/**\n             * \u53c2\u6570\u4e00\uff1a\u6d88\u606f\u5bf9\u8c61\n             * \u53c2\u6570\u4e8c\uff1a\u6d88\u606f\u961f\u5217\u7684\u9009\u62e9\u5668\n             * \u53c2\u6570\u4e09\uff1a\u9009\u62e9\u961f\u5217\u7684\u4e1a\u52a1\u6807\u8bc6\uff08\u8ba2\u5355 ID\uff09\n             */\n            SendResult sendResult = producer.send(msg, new MessageQueueSelector() {\n                @Override\n                /**\n                 * mqs\uff1a\u961f\u5217\u96c6\u5408\n                 * msg\uff1a\u6d88\u606f\u5bf9\u8c61\n                 * arg\uff1a\u4e1a\u52a1\u6807\u8bc6\u7684\u53c2\u6570\n                 */\n                public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {\n                    Long id = (Long) arg;\n                    long index = id % mqs.size(); // \u6839\u636e\u8ba2\u5355id\u9009\u62e9\u53d1\u9001queue\n                    return mqs.get((int) index);\n                }\n            }, orderList.get(i).getOrderId());//\u8ba2\u5355id\n\n            System.out.println(String.format("SendResult status:%s, queueId:%d, body:%s",\n                    sendResult.getSendStatus(),\n                    sendResult.getMessageQueue().getQueueId(),\n                    body));\n        }\n\n        producer.shutdown();\n    }\n\n    // \u8ba2\u5355\u7684\u6b65\u9aa4\n    private static class OrderStep {\n        private long orderId;\n        private String desc;\n        // set + get\n    }\n\n    // \u751f\u6210\u6a21\u62df\u8ba2\u5355\u6570\u636e\n    private List<OrderStep> buildOrders() {\n        List<OrderStep> orderList = new ArrayList<OrderStep>();\n\n        OrderStep orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103111039L);\n        orderDemo.setDesc("\u521b\u5efa");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103111065L);\n        orderDemo.setDesc("\u521b\u5efa");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103111039L);\n        orderDemo.setDesc("\u4ed8\u6b3e");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103117235L);\n        orderDemo.setDesc("\u521b\u5efa");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103111065L);\n        orderDemo.setDesc("\u4ed8\u6b3e");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103117235L);\n        orderDemo.setDesc("\u4ed8\u6b3e");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103111065L);\n        orderDemo.setDesc("\u5b8c\u6210");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103111039L);\n        orderDemo.setDesc("\u63a8\u9001");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103117235L);\n        orderDemo.setDesc("\u5b8c\u6210");\n        orderList.add(orderDemo);\n\n        orderDemo = new OrderStep();\n        orderDemo.setOrderId(15103111039L);\n        orderDemo.setDesc("\u5b8c\u6210");\n        orderList.add(orderDemo);\n\n        return orderList;\n    }\n}\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u987a\u5e8f\u6d88\u606f\u6d88\u8d39\uff0c\u5e26\u4e8b\u52a1\u65b9\u5f0f\uff08\u5e94\u7528\u53ef\u63a7\u5236Offset\u4ec0\u4e48\u65f6\u5019\u63d0\u4ea4\uff09\npublic class ConsumerInOrder {\n    public static void main(String[] args) throws Exception {\n        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("please_rename_unique_group_name_3");\n        consumer.setNamesrvAddr("127.0.0.1:9876");\n        // \u8bbe\u7f6eConsumer\u7b2c\u4e00\u6b21\u542f\u52a8\u662f\u4ece\u961f\u5217\u5934\u90e8\u5f00\u59cb\u6d88\u8d39\u8fd8\u662f\u961f\u5217\u5c3e\u90e8\u5f00\u59cb\u6d88\u8d39\n        // \u5982\u679c\u975e\u7b2c\u4e00\u6b21\u542f\u52a8\uff0c\u90a3\u4e48\u6309\u7167\u4e0a\u6b21\u6d88\u8d39\u7684\u4f4d\u7f6e\u7ee7\u7eed\u6d88\u8d39\n        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);\n\t\t// \u8ba2\u9605\u4e09\u4e2atag\n        consumer.subscribe("OrderTopic", "TagA || TagC || TagD");\n        consumer.registerMessageListener(new MessageListenerOrderly() {\n            Random random = new Random();\n            @Override\n            public ConsumeOrderlyStatus consumeMessage(List<MessageExt> msgs, ConsumeOrderlyContext context) {\n                context.setAutoCommit(true);\n                for (MessageExt msg : msgs) {\n                    // \u53ef\u4ee5\u770b\u5230\u6bcf\u4e2aqueue\u6709\u552f\u4e00\u7684consume\u7ebf\u7a0b\u6765\u6d88\u8d39, \u8ba2\u5355\u5bf9\u6bcf\u4e2aqueue(\u5206\u533a)\u6709\u5e8f\n                    System.out.println("consumeThread=" + Thread.currentThread().getName() + "queueId=" + msg.getQueueId() + ", content:" + new String(msg.getBody()));\n                }\n                return ConsumeOrderlyStatus.SUCCESS;\n            }\n        });\n        consumer.start();\n        System.out.println("Consumer Started.");\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5ef6\u65f6\u6d88\u606f",children:"\u5ef6\u65f6\u6d88\u606f"}),"\n",(0,l.jsx)(n.h4,{id:"\u539f\u7406\u89e3\u6790-1",children:"\u539f\u7406\u89e3\u6790"}),"\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u6d88\u606f\uff08\u5ef6\u8fdf\u961f\u5217\uff09\u662f\u6307\u6d88\u606f\u53d1\u9001\u5230 Broker \u540e\uff0c\u4e0d\u4f1a\u7acb\u5373\u88ab\u6d88\u8d39\uff0c\u7b49\u5f85\u7279\u5b9a\u65f6\u95f4\u6295\u9012\u7ed9\u771f\u6b63\u7684 Topic"}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u5e76\u4e0d\u652f\u6301\u4efb\u610f\u65f6\u95f4\u7684\u5ef6\u65f6\uff0c\u9700\u8981\u8bbe\u7f6e\u51e0\u4e2a\u56fa\u5b9a\u7684\u5ef6\u65f6\u7b49\u7ea7\uff0c\u4ece 1s \u5230 2h \u5206\u522b\u5bf9\u5e94\u7740\u7b49\u7ea7 1 \u5230 18\uff0c\u6d88\u606f\u6d88\u8d39\u5931\u8d25\u4f1a\u8fdb\u5165\u5ef6\u65f6\u6d88\u606f\u961f\u5217\uff0c\u6d88\u606f\u53d1\u9001\u65f6\u95f4\u4e0e\u8bbe\u7f6e\u7684\u5ef6\u65f6\u7b49\u7ea7\u548c\u91cd\u8bd5\u6b21\u6570\u6709\u5173\uff0c\u8be6\u89c1\u4ee3\u7801 ",(0,l.jsx)(n.code,{children:"SendMessageProcessor.java"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'private String messageDelayLevel = "1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h";\n'})}),"\n",(0,l.jsx)(n.p,{children:"Broker \u53ef\u4ee5\u914d\u7f6e messageDelayLevel\uff0c\u8be5\u5c5e\u6027\u662f Broker \u7684\u5c5e\u6027\uff0c\u4e0d\u5c5e\u4e8e\u67d0\u4e2a Topic"}),"\n",(0,l.jsxs)(n.p,{children:["\u53d1\u6d88\u606f\u65f6\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u5ef6\u8fdf\u7b49\u7ea7 ",(0,l.jsx)(n.code,{children:"msg.setDelayLevel(level)"}),"\uff0clevel \u6709\u4ee5\u4e0b\u4e09\u79cd\u60c5\u51b5\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"level == 0\uff1a\u6d88\u606f\u4e3a\u975e\u5ef6\u8fdf\u6d88\u606f"}),"\n",(0,l.jsx)(n.li,{children:"1<=level<=maxLevel\uff1a\u6d88\u606f\u5ef6\u8fdf\u7279\u5b9a\u65f6\u95f4\uff0c\u4f8b\u5982 level==1\uff0c\u5ef6\u8fdf 1s"}),"\n",(0,l.jsx)(n.li,{children:"level > maxLevel\uff1a\u5219 level== maxLevel\uff0c\u4f8b\u5982 level==20\uff0c\u5ef6\u8fdf 2h"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5b9a\u65f6\u6d88\u606f\u4f1a\u6682\u5b58\u5728\u540d\u4e3a SCHEDULE_TOPIC_XXXX \u7684 Topic \u4e2d\uff0c\u5e76\u6839\u636e delayTimeLevel \u5b58\u5165\u7279\u5b9a\u7684 queue\uff0c\u961f\u5217\u7684\u6807\u8bc6 ",(0,l.jsx)(n.code,{children:"queueId = delayTimeLevel \u2013 1"}),"\uff0c\u5373",(0,l.jsx)(n.strong,{children:"\u4e00\u4e2a queue \u53ea\u5b58\u76f8\u540c\u5ef6\u8fdf\u7684\u6d88\u606f"}),"\uff0c\u4fdd\u8bc1\u5177\u6709\u76f8\u540c\u53d1\u9001\u5ef6\u8fdf\u7684\u6d88\u606f\u80fd\u591f\u987a\u5e8f\u6d88\u8d39\u3002Broker \u4f1a\u4e3a\u6bcf\u4e2a\u5ef6\u8fdf\u7ea7\u522b\u63d0\u4ea4\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\uff0c\u8c03\u5ea6\u5730\u6d88\u8d39 SCHEDULE_TOPIC_XXXX\uff0c\u5c06\u6d88\u606f\u5199\u5165\u771f\u5b9e\u7684 Topic"]}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u5b9a\u65f6\u6d88\u606f\u5728\u7b2c\u4e00\u6b21\u5199\u5165\u548c\u8c03\u5ea6\u5199\u5165\u771f\u5b9e Topic \u65f6\u90fd\u4f1a\u8ba1\u6570\uff0c\u56e0\u6b64\u53d1\u9001\u6570\u91cf\u3001tps \u90fd\u4f1a\u53d8\u9ad8"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4ee3\u7801\u5b9e\u73b0-2",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u63d0\u4ea4\u4e86\u4e00\u4e2a\u8ba2\u5355\u5c31\u53ef\u4ee5\u53d1\u9001\u4e00\u4e2a\u5ef6\u65f6\u6d88\u606f\uff0c1h \u540e\u53bb\u68c0\u67e5\u8fd9\u4e2a\u8ba2\u5355\u7684\u72b6\u6001\uff0c\u5982\u679c\u8fd8\u662f\u672a\u4ed8\u6b3e\u5c31\u53d6\u6d88\u8ba2\u5355\u91ca\u653e\u5e93\u5b58"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class ScheduledMessageProducer {\n    public static void main(String[] args) throws Exception {\n        // \u5b9e\u4f8b\u5316\u4e00\u4e2a\u751f\u4ea7\u8005\u6765\u4ea7\u751f\u5ef6\u65f6\u6d88\u606f\n        DefaultMQProducer producer = new DefaultMQProducer("ExampleProducerGroup");\n        producer.setNamesrvAddr("127.0.0.1:9876");\n        // \u542f\u52a8\u751f\u4ea7\u8005\n        producer.start();\n        int totalMessagesToSend = 100;\n        for (int i = 0; i < totalMessagesToSend; i++) {\n            Message message = new Message("DelayTopic", ("Hello scheduled message " + i).getBytes());\n            // \u8bbe\u7f6e\u5ef6\u65f6\u7b49\u7ea73,\u8fd9\u4e2a\u6d88\u606f\u5c06\u572810s\u4e4b\u540e\u53d1\u9001(\u73b0\u5728\u53ea\u652f\u6301\u56fa\u5b9a\u7684\u51e0\u4e2a\u65f6\u95f4,\u8be6\u770bdelayTimeLevel)\n            message.setDelayTimeLevel(3);\n            // \u53d1\u9001\u6d88\u606f\n            producer.send(message);\n        }\n        // \u5173\u95ed\u751f\u4ea7\u8005\n        producer.shutdown();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class ScheduledMessageConsumer {\n   public static void main(String[] args) throws Exception {\n      // \u5b9e\u4f8b\u5316\u6d88\u8d39\u8005\n      DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("ExampleConsumer");\n      consumer.setNamesrvAddr("127.0.0.1:9876");\n      // \u8ba2\u9605Topics\n      consumer.subscribe("DelayTopic", "*");\n      // \u6ce8\u518c\u6d88\u606f\u76d1\u542c\u8005\n      consumer.registerMessageListener(new MessageListenerConcurrently() {\n          @Override\n          public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> messages, ConsumeConcurrentlyContext context) {\n              for (MessageExt message : messages) {\n                  // \u6253\u5370\u5ef6\u8fdf\u7684\u65f6\u95f4\u6bb5\n                  System.out.println("Receive message[msgId=" + message.getMsgId() + "] " + (System.currentTimeMillis() - message.getBornTimestamp()) + "ms later");}\n              return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n          }\n      });\n      // \u542f\u52a8\u6d88\u8d39\u8005\n      consumer.start();\n  }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6279\u91cf\u6d88\u606f",children:"\u6279\u91cf\u6d88\u606f"}),"\n",(0,l.jsx)(n.p,{children:"\u6279\u91cf\u53d1\u9001\u6d88\u606f\u80fd\u663e\u8457\u63d0\u9ad8\u4f20\u9012\u5c0f\u6d88\u606f\u7684\u6027\u80fd\uff0c\u9650\u5236\u662f\u8fd9\u4e9b\u6279\u91cf\u6d88\u606f\u5e94\u8be5\u6709\u76f8\u540c\u7684 topic\uff0c\u76f8\u540c\u7684 waitStoreMsgOK\uff0c\u800c\u4e14\u4e0d\u80fd\u662f\u5ef6\u65f6\u6d88\u606f\uff0c\u5e76\u4e14\u8fd9\u4e00\u6279\u6d88\u606f\u7684\u603b\u5927\u5c0f\u4e0d\u5e94\u8d85\u8fc7 4MB"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class Producer {\n\n    public static void main(String[] args) throws Exception {\n        DefaultMQProducer producer = new DefaultMQProducer("ExampleProducerGroup")\n        producer.setNamesrvAddr("127.0.0.1:9876");\n        //\u542f\u52a8producer\n        producer.start();\n\n        List<Message> msgs = new ArrayList<Message>();\n        // \u521b\u5efa\u6d88\u606f\u5bf9\u8c61\uff0c\u6307\u5b9a\u4e3b\u9898Topic\u3001Tag\u548c\u6d88\u606f\u4f53\n        Message msg1 = new Message("BatchTopic", "Tag1", ("Hello World" + 1).getBytes());\n        Message msg2 = new Message("BatchTopic", "Tag1", ("Hello World" + 2).getBytes());\n        Message msg3 = new Message("BatchTopic", "Tag1", ("Hello World" + 3).getBytes());\n\n        msgs.add(msg1);\n        msgs.add(msg2);\n        msgs.add(msg3);\n\n        // \u53d1\u9001\u6d88\u606f\n        SendResult result = producer.send(msgs);\n        System.out.println("\u53d1\u9001\u7ed3\u679c:" + result);\n        // \u5173\u95ed\u751f\u4ea7\u8005producer\n        producer.shutdown();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u5f53\u53d1\u9001\u5927\u6279\u91cf\u6570\u636e\u65f6\uff0c\u53ef\u80fd\u4e0d\u786e\u5b9a\u6d88\u606f\u662f\u5426\u8d85\u8fc7\u4e86\u5927\u5c0f\u9650\u5236\uff084MB\uff09\uff0c\u6240\u4ee5\u9700\u8981\u5c06\u6d88\u606f\u5217\u8868\u5206\u5272\u4e00\u4e0b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class ListSplitter implements Iterator<List<Message>> {\n    private final int SIZE_LIMIT = 1024 * 1024 * 4;\n    private final List<Message> messages;\n    private int currIndex;\n\n    public ListSplitter(List<Message> messages) {\n        this.messages = messages;\n    }\n\n    @Override\n    public boolean hasNext() {\n        return currIndex < messages.size();\n    }\n\n    @Override\n    public List<Message> next() {\n        int startIndex = getStartIndex();\n        int nextIndex = startIndex;\n        int totalSize = 0;\n        for (; nextIndex < messages.size(); nextIndex++) {\n            Message message = messages.get(nextIndex);\n            int tmpSize = calcMessageSize(message);\n            // \u5355\u4e2a\u6d88\u606f\u8d85\u8fc7\u4e86\u6700\u5927\u7684\u9650\u5236\n            if (tmpSize + totalSize > SIZE_LIMIT) {\n                break;\n            } else {\n                totalSize += tmpSize;\n            }\n        }\n        List<Message> subList = messages.subList(startIndex, nextIndex);\n        currIndex = nextIndex;\n        return subList;\n    }\n\n    private int getStartIndex() {\n        Message currMessage = messages.get(currIndex);\n        int tmpSize = calcMessageSize(currMessage);\n        while (tmpSize > SIZE_LIMIT) {\n            currIndex += 1;\n            Message message = messages.get(curIndex);\n            tmpSize = calcMessageSize(message);\n        }\n        return currIndex;\n    }\n\n    private int calcMessageSize(Message message) {\n        int tmpSize = message.getTopic().length() + message.getBody().length;\n        Map<String, String> properties = message.getProperties();\n        for (Map.Entry<String, String> entry : properties.entrySet()) {\n            tmpSize += entry.getKey().length() + entry.getValue().length();\n        }\n        tmpSize = tmpSize + 20; // \u589e\u52a0\u2f47\u65e5\u5fd7\u7684\u5f00\u950020\u5b57\u8282\n        return tmpSize;\n    }\n\n    public static void main(String[] args) {\n        //\u628a\u5927\u7684\u6d88\u606f\u5206\u88c2\u6210\u82e5\u5e72\u4e2a\u5c0f\u7684\u6d88\u606f\n        ListSplitter splitter = new ListSplitter(messages);\n        while (splitter.hasNext()) {\n            try {\n                List<Message> listItem = splitter.next();\n                producer.send(listItem);\n            } catch (Exception e) {\n                e.printStackTrace();\n                //\u5904\u7406error\n            }\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u8fc7\u6ee4\u6d88\u606f",children:"\u8fc7\u6ee4\u6d88\u606f"}),"\n",(0,l.jsx)(n.h4,{id:"\u57fa\u672c\u8bed\u6cd5",children:"\u57fa\u672c\u8bed\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u5b9a\u4e49\u4e86\u4e00\u4e9b\u57fa\u672c\u8bed\u6cd5\u6765\u652f\u6301\u8fc7\u6ee4\u7279\u6027\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u6269\u5c55\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6570\u503c\u6bd4\u8f83\uff0c\u6bd4\u5982\uff1a>\uff0c>=\uff0c<\uff0c<=\uff0cBETWEEN\uff0c="}),"\n",(0,l.jsx)(n.li,{children:"\u5b57\u7b26\u6bd4\u8f83\uff0c\u6bd4\u5982\uff1a=\uff0c<>\uff0cIN"}),"\n",(0,l.jsx)(n.li,{children:"IS NULL \u6216\u8005 IS NOT NULL"}),"\n",(0,l.jsx)(n.li,{children:"\u903b\u8f91\u7b26\u53f7 AND\uff0cOR\uff0cNOT"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5e38\u91cf\u652f\u6301\u7c7b\u578b\u4e3a\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6570\u503c\uff0c\u6bd4\u5982 123\uff0c3.1415"}),"\n",(0,l.jsx)(n.li,{children:"\u5b57\u7b26\uff0c\u6bd4\u5982 'abc'\uff0c\u5fc5\u987b\u7528\u5355\u5f15\u53f7\u5305\u88f9\u8d77\u6765"}),"\n",(0,l.jsx)(n.li,{children:"NULL\uff0c\u7279\u6b8a\u7684\u5e38\u91cf"}),"\n",(0,l.jsx)(n.li,{children:"\u5e03\u5c14\u503c\uff0cTRUE \u6216 FALSE"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u53ea\u6709\u4f7f\u7528 push \u6a21\u5f0f\u7684\u6d88\u8d39\u8005\u624d\u80fd\u7528\u4f7f\u7528 SQL92 \u6807\u51c6\u7684 sql \u8bed\u53e5\uff0c\u63a5\u53e3\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void subscribe(final String topic, final MessageSelector messageSelector)\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u4f8b\u5982\uff1a\u6d88\u8d39\u8005\u63a5\u6536\u5305\u542b TAGA \u6216 TAGB \u6216 TAGC \u7684\u6d88\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("CID_EXAMPLE");\nconsumer.subscribe("TOPIC", "TAGA || TAGB || TAGC");\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u539f\u7406\u89e3\u6790-2",children:"\u539f\u7406\u89e3\u6790"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u5206\u5e03\u5f0f\u6d88\u606f\u961f\u5217\u7684\u6d88\u606f\u8fc7\u6ee4\u65b9\u5f0f\u662f\u5728 Consumer \u7aef\u8ba2\u9605\u6d88\u606f\u65f6\u518d\u505a\u6d88\u606f\u8fc7\u6ee4\u7684\uff0c\u6240\u4ee5\u662f\u5728 Broker \u7aef\u5b9e\u73b0\u7684\uff0c\u4f18\u70b9\u662f\u51cf\u5c11\u4e86\u5bf9\u4e8e Consumer \u65e0\u7528\u6d88\u606f\u7684\u7f51\u7edc\u4f20\u8f93\uff0c\u7f3a\u70b9\u662f\u589e\u52a0\u4e86 Broker \u7684\u8d1f\u62c5\uff0c\u800c\u4e14\u5b9e\u73b0\u76f8\u5bf9\u590d\u6742"}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u5728 Producer \u7aef\u5199\u5165\u6d88\u606f\u548c\u5728 Consumer \u7aef\u8ba2\u9605\u6d88\u606f\u91c7\u7528",(0,l.jsx)(n.strong,{children:"\u5206\u79bb\u5b58\u50a8"}),"\u7684\u673a\u5236\u5b9e\u73b0\uff0cConsumer \u7aef\u8ba2\u9605\u6d88\u606f\u662f\u9700\u8981\u901a\u8fc7 ConsumeQueue \u8fd9\u4e2a\u6d88\u606f\u6d88\u8d39\u7684\u903b\u8f91\u961f\u5217\u62ff\u5230\u4e00\u4e2a\u7d22\u5f15\uff0c\u7136\u540e\u518d\u4ece CommitLog \u91cc\u9762\u8bfb\u53d6\u771f\u6b63\u7684\u6d88\u606f\u5b9e\u4f53\u5185\u5bb9"]}),"\n",(0,l.jsx)(n.p,{children:"ConsumeQueue \u7684\u5b58\u50a8\u7ed3\u6784\u5982\u4e0b\uff0c\u6709 8 \u4e2a\u5b57\u8282\u5b58\u50a8\u7684 Message Tag \u7684\u54c8\u5e0c\u503c\uff0c\u57fa\u4e8e Tag \u7684\u6d88\u606f\u8fc7\u6ee4\u5c31\u662f\u57fa\u4e8e\u8fd9\u4e2a\u5b57\u6bb5"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(62759).A+"",width:"445",height:"76"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Tag \u8fc7\u6ee4\uff1aConsumer \u7aef\u8ba2\u9605\u6d88\u606f\u65f6\u6307\u5b9a Topic \u548c TAG\uff0c\u7136\u540e\u5c06\u8ba2\u9605\u8bf7\u6c42\u6784\u5efa\u6210\u4e00\u4e2a SubscriptionData\uff0c\u53d1\u9001\u4e00\u4e2a Pull \u6d88\u606f\u7684\u8bf7\u6c42\u7ed9 Broker \u7aef\u3002Broker \u7aef\u7528\u8fd9\u4e9b\u6570\u636e\u5148\u6784\u5efa\u4e00\u4e2a MessageFilter\uff0c\u7136\u540e\u4f20\u7ed9\u6587\u4ef6\u5b58\u50a8\u5c42 Store\u3002Store \u4ece ConsumeQueue \u8bfb\u53d6\u5230\u4e00\u6761\u8bb0\u5f55\u540e\uff0c\u4f1a\u7528\u5b83\u8bb0\u5f55\u7684\u6d88\u606f tag hash \u503c\u53bb\u505a\u8fc7\u6ee4\u3002\u56e0\u4e3a\u5728\u670d\u52a1\u7aef\u53ea\u662f\u6839\u636e hashcode \u8fdb\u884c\u5224\u65ad\uff0c\u65e0\u6cd5\u7cbe\u786e\u5bf9 tag \u539f\u59cb\u5b57\u7b26\u4e32\u8fdb\u884c\u8fc7\u6ee4\uff0c\u6240\u4ee5\u6d88\u8d39\u7aef\u62c9\u53d6\u5230\u6d88\u606f\u540e\uff0c\u8fd8\u9700\u8981\u5bf9\u6d88\u606f\u7684\u539f\u59cb tag \u5b57\u7b26\u4e32\u8fdb\u884c\u6bd4\u5bf9\uff0c\u5982\u679c\u4e0d\u540c\uff0c\u5219\u4e22\u5f03\u8be5\u6d88\u606f\uff0c\u4e0d\u8fdb\u884c\u6d88\u606f\u6d88\u8d39"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"SQL92 \u8fc7\u6ee4\uff1a\u5de5\u4f5c\u6d41\u7a0b\u548c Tag \u8fc7\u6ee4\u5927\u81f4\u4e00\u6837\uff0c\u53ea\u662f\u5728 Store \u5c42\u7684\u5177\u4f53\u8fc7\u6ee4\u65b9\u5f0f\u4e0d\u4e00\u6837\u3002\u771f\u6b63\u7684 SQL expression \u7684\u6784\u5efa\u548c\u6267\u884c\u7531 rocketmq-filter \u6a21\u5757\u8d1f\u8d23\uff0c\u6bcf\u6b21\u8fc7\u6ee4\u90fd\u53bb\u6267\u884c SQL \u8868\u8fbe\u5f0f\u4f1a\u5f71\u54cd\u6548\u7387\uff0c\u6240\u4ee5 RocketMQ \u4f7f\u7528\u4e86 BloomFilter \u6765\u907f\u514d\u4e86\u6bcf\u6b21\u90fd\u53bb\u6267\u884c"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4ee3\u7801\u5b9e\u73b0-3",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u53d1\u9001\u6d88\u606f\u65f6\uff0c\u901a\u8fc7 putUserProperty \u6765\u8bbe\u7f6e\u6d88\u606f\u7684\u5c5e\u6027\uff0cSQL92 \u7684\u8868\u8fbe\u5f0f\u4e0a\u4e0b\u6587\u4e3a\u6d88\u606f\u7684\u5c5e\u6027"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class Producer {\n    public static void main(String[] args) throws Exception {\n        DefaultMQProducer producer = new DefaultMQProducer("please_rename_unique_group_name");\n        producer.setNamesrvAddr("127.0.0.1:9876");\n        producer.start();\n        for (int i = 0; i < 10; i++) {\n            Message msg = new Message("FilterTopic", "tag",\n               ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET));\n            // \u8bbe\u7f6e\u4e00\u4e9b\u5c5e\u6027\n            msg.putUserProperty("i", String.valueOf(i));\n            SendResult sendResult = producer.send(msg);\n        }\n        producer.shutdown();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528 SQL \u7b5b\u9009\u8fc7\u6ee4\u6d88\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class Consumer {\n    public static void main(String[] args) throws Exception {\n        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("please_rename_unique_group_name");\n        consumer.setNamesrvAddr("127.0.0.1:9876");\n        // \u8fc7\u6ee4\u5c5e\u6027\u5927\u4e8e 5  \u7684\u6d88\u606f\n        consumer.subscribe("FilterTopic", MessageSelector.bySql("i>5"));\n\n        // \u8bbe\u7f6e\u56de\u8c03\u51fd\u6570\uff0c\u5904\u7406\u6d88\u606f\n        consumer.registerMessageListener(new MessageListenerConcurrently() {\n            //\u63a5\u53d7\u6d88\u606f\u5185\u5bb9\n            @Override\n            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {\n                for (MessageExt msg : msgs) {\n                    System.out.println("consumeThread=" + Thread.currentThread().getName() + "," + new String(msg.getBody()));\n                }\n                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n            }\n        });\n        // \u542f\u52a8\u6d88\u8d39\u8005consumer\n        consumer.start();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u4e8b\u52a1\u6d88\u606f",children:"\u4e8b\u52a1\u6d88\u606f"}),"\n",(0,l.jsx)(n.h4,{id:"\u5de5\u4f5c\u6d41\u7a0b",children:"\u5de5\u4f5c\u6d41\u7a0b"}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u652f\u6301\u5206\u5e03\u5f0f\u4e8b\u52a1\u6d88\u606f\uff0c\u91c7\u7528\u4e86 2PC \u7684\u601d\u60f3\u6765\u5b9e\u73b0\u4e86\u63d0\u4ea4\u4e8b\u52a1\u6d88\u606f\uff0c\u540c\u65f6\u589e\u52a0\u4e00\u4e2a",(0,l.jsx)(n.strong,{children:"\u8865\u507f\u903b\u8f91"}),"\u6765\u5904\u7406\u4e8c\u9636\u6bb5\u8d85\u65f6\u6216\u8005\u5931\u8d25\u7684\u6d88\u606f\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(97726).A+"",width:"947",height:"408"})}),"\n",(0,l.jsx)(n.p,{children:"\u4e8b\u52a1\u6d88\u606f\u7684\u5927\u81f4\u65b9\u6848\u5206\u4e3a\u4e24\u4e2a\u6d41\u7a0b\uff1a\u6b63\u5e38\u4e8b\u52a1\u6d88\u606f\u7684\u53d1\u9001\u53ca\u63d0\u4ea4\u3001\u4e8b\u52a1\u6d88\u606f\u7684\u8865\u507f\u6d41\u7a0b"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e8b\u52a1\u6d88\u606f\u53d1\u9001\u53ca\u63d0\u4ea4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u53d1\u9001\u6d88\u606f\uff08Half \u6d88\u606f\uff09\uff0c\u670d\u52a1\u5668\u5c06\u6d88\u606f\u7684\u4e3b\u9898\u548c\u961f\u5217\u6539\u4e3a\u534a\u6d88\u606f\u72b6\u6001\uff0c\u5e76\u653e\u5165\u534a\u6d88\u606f\u961f\u5217"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u54cd\u5e94\u6d88\u606f\u5199\u5165\u7ed3\u679c\uff08\u5982\u679c\u5199\u5165\u5931\u8d25\uff0c\u6b64\u65f6 Half \u6d88\u606f\u5bf9\u4e1a\u52a1\u4e0d\u53ef\u89c1\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6839\u636e\u53d1\u9001\u7ed3\u679c\u6267\u884c\u672c\u5730\u4e8b\u52a1"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6839\u636e\u672c\u5730\u4e8b\u52a1\u72b6\u6001\u6267\u884c Commit \u6216\u8005 Rollback"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(53629).A+"",width:"1452",height:"625"})}),"\n",(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8865\u507f\u673a\u5236\uff1a\u7528\u4e8e\u89e3\u51b3\u6d88\u606f Commit \u6216\u8005 Rollback \u53d1\u751f\u8d85\u65f6\u6216\u8005\u5931\u8d25\u7684\u60c5\u51b5\uff0c\u6bd4\u5982\u51fa\u73b0\u7f51\u7edc\u95ee\u9898"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Broker \u670d\u52a1\u7aef\u901a\u8fc7",(0,l.jsx)(n.strong,{children:"\u5bf9\u6bd4 Half \u6d88\u606f\u548c Op \u6d88\u606f"}),"\uff0c\u5bf9\u672a\u786e\u5b9a\u72b6\u6001\u7684\u6d88\u606f\u63a8\u8fdb CheckPoint"]}),"\n",(0,l.jsxs)(n.li,{children:["\u6ca1\u6709 Commit/Rollback \u7684\u4e8b\u52a1\u6d88\u606f\uff0c\u670d\u52a1\u7aef\u6839\u636e\u6839\u636e\u534a\u6d88\u606f\u7684\u751f\u4ea7\u8005\u7ec4\uff0c\u5230 ProducerManager \u4e2d\u83b7\u53d6\u751f\u4ea7\u8005\uff08\u540c\u4e00\u4e2a Group \u7684 Producer\uff09\u7684\u4f1a\u8bdd\u901a\u9053\uff0c\u53d1\u8d77\u4e00\u6b21\u56de\u67e5\uff08",(0,l.jsx)(n.strong,{children:"\u5355\u5411\u8bf7\u6c42"}),"\uff09"]}),"\n",(0,l.jsx)(n.li,{children:"Producer \u6536\u5230\u56de\u67e5\u6d88\u606f\uff0c\u68c0\u67e5\u4e8b\u52a1\u6d88\u606f\u72b6\u6001\u8868\u5185\u5bf9\u5e94\u7684\u672c\u5730\u4e8b\u52a1\u7684\u72b6\u6001"}),"\n",(0,l.jsx)(n.li,{children:"\u6839\u636e\u672c\u5730\u4e8b\u52a1\u72b6\u6001\uff0c\u91cd\u65b0 Commit \u6216\u8005 Rollback"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u5e76\u4e0d\u4f1a\u65e0\u4f11\u6b62\u7684\u8fdb\u884c\u4e8b\u52a1\u72b6\u6001\u56de\u67e5\uff0c\u6700\u5927\u56de\u67e5 15 \u6b21\uff0c\u5982\u679c 15 \u6b21\u56de\u67e5\u8fd8\u662f\u65e0\u6cd5\u5f97\u77e5\u4e8b\u52a1\u72b6\u6001\uff0c\u5219\u9ed8\u8ba4\u56de\u6eda\u8be5\u6d88\u606f\uff0c"}),"\n",(0,l.jsxs)(n.p,{children:["\u56de\u67e5\u670d\u52a1\uff1a",(0,l.jsx)(n.code,{children:"TransactionalMessageCheckService#run"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4e24\u9636\u6bb5",children:"\u4e24\u9636\u6bb5"}),"\n",(0,l.jsx)(n.h5,{id:"\u4e00\u9636\u6bb5",children:"\u4e00\u9636\u6bb5"}),"\n",(0,l.jsxs)(n.p,{children:["\u4e8b\u52a1\u6d88\u606f\u76f8\u5bf9\u666e\u901a\u6d88\u606f\u6700\u5927\u7684\u7279\u70b9\u5c31\u662f",(0,l.jsx)(n.strong,{children:"\u4e00\u9636\u6bb5\u53d1\u9001\u7684\u6d88\u606f\u5bf9\u7528\u6237\u662f\u4e0d\u53ef\u89c1\u7684"}),"\uff0c\u56e0\u4e3a\u5bf9\u4e8e Half \u6d88\u606f\uff0c\u4f1a\u5907\u4efd\u539f\u6d88\u606f\u7684\u4e3b\u9898\u4e0e\u6d88\u606f\u6d88\u8d39\u961f\u5217\uff0c\u7136\u540e\u6539\u53d8\u4e3b\u9898\u4e3a RMQ_SYS_TRANS_HALF_TOPIC\uff0c\u7531\u4e8e\u6d88\u8d39\u7ec4\u672a\u8ba2\u9605\u8be5\u4e3b\u9898\uff0c\u6545\u6d88\u8d39\u7aef\u65e0\u6cd5\u6d88\u8d39 Half \u7c7b\u578b\u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u4f1a\u5f00\u542f\u4e00\u4e2a",(0,l.jsx)(n.strong,{children:"\u5b9a\u65f6\u4efb\u52a1"}),"\uff0c\u4ece Topic \u4e3a RMQ_SYS_TRANS_HALF_TOPIC \u4e2d\u62c9\u53d6\u6d88\u606f\u8fdb\u884c\u6d88\u8d39\uff0c\u6839\u636e\u751f\u4ea7\u8005\u7ec4\u83b7\u53d6\u4e00\u4e2a\u670d\u52a1\u63d0\u4f9b\u8005\u53d1\u9001\u56de\u67e5\u4e8b\u52a1\u72b6\u6001\u8bf7\u6c42\uff0c\u6839\u636e\u4e8b\u52a1\u72b6\u6001\u6765\u51b3\u5b9a\u662f\u63d0\u4ea4\u6216\u56de\u6eda\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u7684\u5177\u4f53\u5b9e\u73b0\u7b56\u7565\uff1a\u5982\u679c\u5199\u5165\u7684\u662f\u4e8b\u52a1\u6d88\u606f\uff0c\u5bf9\u6d88\u606f\u7684 Topic \u548c Queue \u7b49\u5c5e\u6027\u8fdb\u884c\u66ff\u6362\uff0c\u540c\u65f6\u5c06\u539f\u6765\u7684 Topic \u548c Queue \u4fe1\u606f\u5b58\u50a8\u5230",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u7684\u5c5e\u6027"}),"\u4e2d\uff0c\u56e0\u4e3a\u6d88\u606f\u7684\u4e3b\u9898\u88ab\u66ff\u6362\uff0c\u6240\u4ee5\u6d88\u606f\u4e0d\u4f1a\u8f6c\u53d1\u5230\u8be5\u539f\u4e3b\u9898\u7684\u6d88\u606f\u6d88\u8d39\u961f\u5217\uff0c\u6d88\u8d39\u8005\u65e0\u6cd5\u611f\u77e5\u6d88\u606f\u7684\u5b58\u5728\uff0c\u4e0d\u4f1a\u6d88\u8d39"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u4e8c\u9636\u6bb5",children:"\u4e8c\u9636\u6bb5"}),"\n",(0,l.jsx)(n.p,{children:"\u4e00\u9636\u6bb5\u5199\u5165\u4e0d\u53ef\u89c1\u7684\u6d88\u606f\u540e\uff0c\u4e8c\u9636\u6bb5\u64cd\u4f5c\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u6267\u884c Commit \u64cd\u4f5c\uff0c\u5219\u9700\u8981\u8ba9\u6d88\u606f\u5bf9\u7528\u6237\u53ef\u89c1\uff0c\u6784\u5efa\u51fa Half \u6d88\u606f\u7684\u7d22\u5f15\u3002\u4e00\u9636\u6bb5\u7684 Half \u6d88\u606f\u5199\u5230\u4e00\u4e2a\u7279\u6b8a\u7684 Topic\uff0c\u6784\u5efa\u7d22\u5f15\u65f6\u9700\u8981\u8bfb\u53d6\u51fa Half \u6d88\u606f\uff0c\u7136\u540e\u901a\u8fc7\u4e00\u6b21\u666e\u901a\u6d88\u606f\u7684\u5199\u5165\u64cd\u4f5c\u5c06 Topic \u548c Queue \u66ff\u6362\u6210\u771f\u6b63\u7684\u76ee\u6807 Topic \u548c Queue\uff0c\u751f\u6210\u4e00\u6761\u5bf9\u7528\u6237\u53ef\u89c1\u7684\u6d88\u606f\u3002\u5176\u5b9e\u5c31\u662f\u5229\u7528\u4e86\u4e00\u9636\u6bb5\u5b58\u50a8\u7684\u6d88\u606f\u7684\u5185\u5bb9\uff0c\u5728\u4e8c\u9636\u6bb5\u65f6\u6062\u590d\u51fa\u4e00\u6761\u5b8c\u6574\u7684\u666e\u901a\u6d88\u606f\uff0c\u7136\u540e\u8d70\u4e00\u904d\u6d88\u606f\u5199\u5165\u6d41\u7a0b"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5982\u679c\u662f Rollback \u5219\u9700\u8981\u64a4\u9500\u4e00\u9636\u6bb5\u7684\u6d88\u606f\uff0c\u56e0\u4e3a\u6d88\u606f\u672c\u5c31\u4e0d\u53ef\u89c1\uff0c\u6240\u4ee5\u5e76",(0,l.jsx)(n.strong,{children:"\u4e0d\u9700\u8981\u771f\u6b63\u64a4\u9500\u6d88\u606f"}),"\uff08\u5b9e\u9645\u4e0a RocketMQ \u4e5f\u65e0\u6cd5\u53bb\u5220\u9664\u4e00\u6761\u6d88\u606f\uff0c\u56e0\u4e3a\u662f\u987a\u5e8f\u5199\u6587\u4ef6\u7684\uff09\u3002RocketMQ \u4e3a\u4e86\u533a\u5206\u8fd9\u6761\u6d88\u606f\u6ca1\u6709\u786e\u5b9a\u72b6\u6001\u7684\u6d88\u606f\uff0c\u91c7\u7528 Op \u6d88\u606f\u6807\u8bc6\u5df2\u7ecf\u786e\u5b9a\u72b6\u6001\u7684\u4e8b\u52a1\u6d88\u606f\uff08Commit \u6216\u8005 Rollback\uff09"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u4e8b\u52a1\u6d88\u606f\u65e0\u8bba\u662f Commit \u6216\u8005 Rollback \u90fd\u4f1a\u8bb0\u5f55\u4e00\u4e2a Op \u64cd\u4f5c"}),"\uff0c\u4e24\u8005\u7684\u533a\u522b\u662f Commit \u76f8\u5bf9\u4e8e Rollback \u5728\u5199\u5165 Op \u6d88\u606f\u524d\u5c06\u539f\u6d88\u606f\u7684\u4e3b\u9898\u548c\u961f\u5217\u6062\u590d\u3002\u5982\u679c\u4e00\u6761\u4e8b\u52a1\u6d88\u606f\u6ca1\u6709\u5bf9\u5e94\u7684 Op \u6d88\u606f\uff0c\u8bf4\u660e\u8fd9\u4e2a\u4e8b\u52a1\u7684\u72b6\u6001\u8fd8\u65e0\u6cd5\u786e\u5b9a\uff08\u53ef\u80fd\u662f\u4e8c\u9636\u6bb5\u5931\u8d25\u4e86\uff09"]}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u5c06 Op \u6d88\u606f\u5199\u5165\u5230\u5168\u5c40\u4e00\u4e2a\u7279\u5b9a\u7684 Topic \u4e2d\uff0c\u901a\u8fc7\u6e90\u7801\u4e2d\u7684\u65b9\u6cd5 ",(0,l.jsx)(n.code,{children:"TransactionalMessageUtil.buildOpTopic()"}),"\uff0c\u8fd9\u4e2a\u4e3b\u9898\u662f\u4e00\u4e2a\u5185\u90e8\u7684 Topic\uff08\u50cf Half \u6d88\u606f\u7684 Topic \u4e00\u6837\uff09\uff0c\u4e0d\u4f1a\u88ab\u7528\u6237\u6d88\u8d39\u3002Op \u6d88\u606f\u7684\u5185\u5bb9\u4e3a\u5bf9\u5e94\u7684 Half \u6d88\u606f\u7684\u5b58\u50a8\u7684 Offset\uff0c\u8fd9\u6837",(0,l.jsx)(n.strong,{children:"\u901a\u8fc7 Op  \u6d88\u606f\u80fd\u7d22\u5f15\u5230 Half \u6d88\u606f"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(78131).A+"",width:"773",height:"443"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u57fa\u672c\u4f7f\u7528",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,l.jsx)(n.h5,{id:"\u4f7f\u7528\u65b9\u5f0f",children:"\u4f7f\u7528\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u4e8b\u52a1\u6d88\u606f\u5171\u6709\u4e09\u79cd\u72b6\u6001\uff0c\u63d0\u4ea4\u72b6\u6001\u3001\u56de\u6eda\u72b6\u6001\u3001\u4e2d\u95f4\u72b6\u6001\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"TransactionStatus.CommitTransaction\uff1a\u63d0\u4ea4\u4e8b\u52a1\uff0c\u5141\u8bb8\u6d88\u8d39\u8005\u6d88\u8d39\u6b64\u6d88\u606f\u3002"}),"\n",(0,l.jsx)(n.li,{children:"TransactionStatus.RollbackTransaction\uff1a\u56de\u6eda\u4e8b\u52a1\uff0c\u4ee3\u8868\u8be5\u6d88\u606f\u5c06\u88ab\u5220\u9664\uff0c\u4e0d\u5141\u8bb8\u88ab\u6d88\u8d39"}),"\n",(0,l.jsx)(n.li,{children:"TransactionStatus.Unknown\uff1a\u4e2d\u95f4\u72b6\u6001\uff0c\u4ee3\u8868\u9700\u8981\u68c0\u67e5\u6d88\u606f\u961f\u5217\u6765\u786e\u5b9a\u72b6\u6001"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528\u9650\u5236\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e8b\u52a1\u6d88\u606f\u4e0d\u652f\u6301\u5ef6\u65f6\u6d88\u606f\u548c\u6279\u91cf\u6d88\u606f"}),"\n",(0,l.jsxs)(n.li,{children:["Broker \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u53c2\u6570 ",(0,l.jsx)(n.code,{children:"transactionTimeout"})," \u4e3a\u7279\u5b9a\u65f6\u95f4\uff0c\u4e8b\u52a1\u6d88\u606f\u5c06\u5728\u7279\u5b9a\u65f6\u95f4\u957f\u5ea6\u4e4b\u540e\u88ab\u68c0\u67e5\u3002\u5f53\u53d1\u9001\u4e8b\u52a1\u6d88\u606f\u65f6\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u7528\u6237\u5c5e\u6027 ",(0,l.jsx)(n.code,{children:"CHECK_IMMUNITY_TIME_IN_SECONDS"})," \u6765\u6539\u53d8\u8fd9\u4e2a\u9650\u5236\uff0c\u8be5\u53c2\u6570\u4f18\u5148\u4e8e ",(0,l.jsx)(n.code,{children:"transactionTimeout"})," \u53c2\u6570"]}),"\n",(0,l.jsxs)(n.li,{children:["\u4e3a\u4e86\u907f\u514d\u5355\u4e2a\u6d88\u606f\u88ab\u68c0\u67e5\u592a\u591a\u6b21\u800c\u5bfc\u81f4\u534a\u961f\u5217\u6d88\u606f\u7d2f\u79ef\uff0c\u9ed8\u8ba4\u5c06\u5355\u4e2a\u6d88\u606f\u7684\u68c0\u67e5\u6b21\u6570\u9650\u5236\u4e3a 15 \u6b21\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u901a\u8fc7 Broker \u914d\u7f6e\u6587\u4ef6\u7684 ",(0,l.jsx)(n.code,{children:"transactionCheckMax"})," \u53c2\u6570\u6765\u4fee\u6539\u6b64\u9650\u5236\u3002\u5982\u679c\u5df2\u7ecf\u68c0\u67e5\u67d0\u6761\u6d88\u606f\u8d85\u8fc7 N \u6b21\uff08N = ",(0,l.jsx)(n.code,{children:"transactionCheckMax"}),"\uff09\uff0c \u5219 Broker \u5c06\u4e22\u5f03\u6b64\u6d88\u606f\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u6253\u5370\u9519\u8bef\u65e5\u5fd7\u3002\u53ef\u4ee5\u901a\u8fc7\u91cd\u5199 ",(0,l.jsx)(n.code,{children:"AbstractTransactionalMessageCheckListener"})," \u7c7b\u6765\u4fee\u6539\u8fd9\u4e2a\u884c\u4e3a"]}),"\n",(0,l.jsx)(n.li,{children:"\u4e8b\u52a1\u6027\u6d88\u606f\u53ef\u80fd\u4e0d\u6b62\u4e00\u6b21\u88ab\u68c0\u67e5\u6216\u6d88\u8d39"}),"\n",(0,l.jsx)(n.li,{children:"\u63d0\u4ea4\u7ed9\u7528\u6237\u7684\u76ee\u6807\u4e3b\u9898\u6d88\u606f\u53ef\u80fd\u4f1a\u5931\u8d25\uff0c\u53ef\u4ee5\u67e5\u770b\u65e5\u5fd7\u7684\u8bb0\u5f55\u3002\u4e8b\u52a1\u7684\u9ad8\u53ef\u7528\u6027\u901a\u8fc7 RocketMQ \u672c\u8eab\u7684\u9ad8\u53ef\u7528\u6027\u673a\u5236\u6765\u4fdd\u8bc1\uff0c\u5982\u679c\u5e0c\u671b\u4e8b\u52a1\u6d88\u606f\u4e0d\u4e22\u5931\u3001\u5e76\u4e14\u4e8b\u52a1\u5b8c\u6574\u6027\u5f97\u5230\u4fdd\u8bc1\uff0c\u53ef\u4ee5\u4f7f\u7528\u540c\u6b65\u7684\u53cc\u91cd\u5199\u5165\u673a\u5236"}),"\n",(0,l.jsx)(n.li,{children:"\u4e8b\u52a1\u6d88\u606f\u7684\u751f\u4ea7\u8005 ID \u4e0d\u80fd\u4e0e\u5176\u4ed6\u7c7b\u578b\u6d88\u606f\u7684\u751f\u4ea7\u8005 ID \u5171\u4eab\u3002\u4e0e\u5176\u4ed6\u7c7b\u578b\u7684\u6d88\u606f\u4e0d\u540c\uff0c\u4e8b\u52a1\u6d88\u606f\u5141\u8bb8\u53cd\u5411\u67e5\u8be2\uff0cMQ \u670d\u52a1\u5668\u80fd\u901a\u8fc7\u6d88\u606f\u7684\u751f\u4ea7\u8005 ID \u67e5\u8be2\u5230\u6d88\u8d39\u8005"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u4ee3\u7801\u5b9e\u73b0-4",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u5b9e\u73b0\u4e8b\u52a1\u7684\u76d1\u542c\u63a5\u53e3\uff0c\u5f53\u53d1\u9001\u534a\u6d88\u606f\u6210\u529f\u65f6\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"executeLocalTransaction"})," \u65b9\u6cd5\u6765\u6267\u884c\u672c\u5730\u4e8b\u52a1\uff0c\u8fd4\u56de\u4e09\u4e2a\u4e8b\u52a1\u72b6\u6001\u4e4b\u4e00"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"checkLocalTransaction"})," \u65b9\u6cd5\u68c0\u67e5\u672c\u5730\u4e8b\u52a1\u72b6\u6001\uff0c\u54cd\u5e94\u6d88\u606f\u961f\u5217\u7684\u68c0\u67e5\u8bf7\u6c42\uff0c\u8fd4\u56de\u4e09\u4e2a\u4e8b\u52a1\u72b6\u6001\u4e4b\u4e00"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class TransactionListenerImpl implements TransactionListener {\n    private AtomicInteger transactionIndex = new AtomicInteger(0);\n    private ConcurrentHashMap<String, Integer> localTrans = new ConcurrentHashMap<>();\n\n    @Override\n    public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {\n        int value = transactionIndex.getAndIncrement();\n        int status = value % 3;\n        // \u5c06\u4e8b\u52a1ID\u548c\u72b6\u6001\u5b58\u5165 map \u96c6\u5408\n        localTrans.put(msg.getTransactionId(), status);\n        return LocalTransactionState.UNKNOW;\n    }\n\n    @Override\n    public LocalTransactionState checkLocalTransaction(MessageExt msg) {\n        // \u4ece map \u96c6\u5408\u8bfb\u51fa\u5f53\u524d\u4e8b\u52a1\u5bf9\u5e94\u7684\u72b6\u6001\n        Integer status = localTrans.get(msg.getTransactionId());\n        if (null != status) {\n            switch (status) {\n                case 0:\n                    return LocalTransactionState.UNKNOW;\n                case 1:\n                    return LocalTransactionState.COMMIT_MESSAGE;\n                case 2:\n                    return LocalTransactionState.ROLLBACK_MESSAGE;\n            }\n        }\n        return LocalTransactionState.COMMIT_MESSAGE;\n    }\n}\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u4f7f\u7528 ",(0,l.jsx)(n.strong,{children:"TransactionMQProducer"})," \u7c7b\u521b\u5efa\u4e8b\u52a1\u6027\u751f\u4ea7\u8005\uff0c\u5e76\u6307\u5b9a\u552f\u4e00\u7684 ",(0,l.jsx)(n.code,{children:"ProducerGroup"}),"\uff0c\u5c31\u53ef\u4ee5\u8bbe\u7f6e\u81ea\u5b9a\u4e49\u7ebf\u7a0b\u6c60\u6765\u5904\u7406\u8fd9\u4e9b\u68c0\u67e5\u8bf7\u6c42\uff0c\u6267\u884c\u672c\u5730\u4e8b\u52a1\u540e\uff0c\u9700\u8981\u6839\u636e\u6267\u884c\u7ed3\u679c\u5bf9\u6d88\u606f\u961f\u5217\u8fdb\u884c\u56de\u590d"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class Producer {\n\tpublic static void main(String[] args) throws MQClientException, InterruptedException {\n        // \u521b\u5efa\u6d88\u606f\u751f\u4ea7\u8005\n       \tTransactionMQProducer producer = new TransactionMQProducer("please_rename_unique_group_name");\n       \tExecutorService executorService = new ThreadPoolExecutor(2, 5, 100, TimeUnit.SECONDS);\n        producer.setExecutorService(executorService);\n        \n        // \u521b\u5efa\u4e8b\u52a1\u76d1\u542c\u5668\n\t\tTransactionListener transactionListener = new TransactionListenerImpl();\n        // \u751f\u4ea7\u8005\u7684\u76d1\u542c\u5668\n        producer.setTransactionListener(transactionListener);\n       \t// \u542f\u52a8\u751f\u4ea7\u8005\n        producer.start();\n        String[] tags = new String[] {"TagA", "TagB", "TagC", "TagD", "TagE"};\n        for (int i = 0; i < 10; i++) {\n            try {\n                Message msg = new Message("TransactionTopic", tags[i % tags.length], "KEY" + i,\n                                ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET));\n                // \u53d1\u9001\u6d88\u606f\n                SendResult sendResult = producer.sendMessageInTransaction(msg, null);\n                System.out.printf("%s%n", sendResult);\n                Thread.sleep(10);\n            } catch (MQClientException | UnsupportedEncodingException e) {\n                e.printStackTrace();\n            }\n        }\n       \t//Thread.sleep(1000000);\n        //producer.shutdown();\u6682\u65f6\u4e0d\u5173\u95ed\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u4ee3\u7801\u548c\u524d\u9762\u7684\u5b9e\u4f8b\u76f8\u540c\u7684"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u7cfb\u7edf\u7279\u6027",children:"\u7cfb\u7edf\u7279\u6027"}),"\n",(0,l.jsx)(n.h3,{id:"\u5de5\u4f5c\u6d41\u7a0b-1",children:"\u5de5\u4f5c\u6d41\u7a0b"}),"\n",(0,l.jsx)(n.h4,{id:"\u6a21\u5757\u4ecb\u7ecd",children:"\u6a21\u5757\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"NameServer \u662f\u4e00\u4e2a\u7b80\u5355\u7684 Topic \u8def\u7531\u6ce8\u518c\u4e2d\u5fc3\uff0c\u652f\u6301 Broker \u7684\u52a8\u6001\u6ce8\u518c\u4e0e\u53d1\u73b0\uff0c\u751f\u4ea7\u8005\u6216\u6d88\u8d39\u8005\u80fd\u591f\u901a\u8fc7\u540d\u5b57\u670d\u52a1\u67e5\u627e\u5404\u4e3b\u9898\u76f8\u5e94\u7684 Broker IP \u5217\u8868"}),"\n",(0,l.jsx)(n.p,{children:"NameServer \u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u529f\u80fd\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Broker \u7ba1\u7406\uff0cNameServer \u63a5\u53d7 Broker \u96c6\u7fa4\u7684\u6ce8\u518c\u4fe1\u606f\uff0c\u4fdd\u5b58\u4e0b\u6765\u4f5c\u4e3a\u8def\u7531\u4fe1\u606f\u7684\u57fa\u672c\u6570\u636e\uff0c\u63d0\u4f9b",(0,l.jsx)(n.strong,{children:"\u5fc3\u8df3\u68c0\u6d4b\u673a\u5236"}),"\u68c0\u67e5 Broker \u662f\u5426\u8fd8\u5b58\u6d3b\uff0c\u6bcf 10 \u79d2\u6e05\u9664\u4e00\u6b21\u4e24\u5c0f\u65f6\u6ca1\u6709\u6d3b\u8dc3\u7684 Broker"]}),"\n",(0,l.jsx)(n.li,{children:"\u8def\u7531\u4fe1\u606f\u7ba1\u7406\uff0c\u6bcf\u4e2a NameServer \u5c06\u4fdd\u5b58\u5173\u4e8e Broker \u96c6\u7fa4\u7684\u6574\u4e2a\u8def\u7531\u4fe1\u606f\u548c\u7528\u4e8e\u5ba2\u6237\u7aef\u67e5\u8be2\u7684\u961f\u5217\u4fe1\u606f\uff0c\u7136\u540e Producer \u548c Conumser \u901a\u8fc7 NameServer \u5c31\u53ef\u4ee5\u77e5\u9053\u6574\u4e2a Broker \u96c6\u7fa4\u7684\u8def\u7531\u4fe1\u606f\uff0c\u4ece\u800c\u8fdb\u884c\u6d88\u606f\u7684\u6295\u9012\u548c\u6d88\u8d39"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"NameServer \u7279\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["NameServer \u901a\u5e38\u662f\u96c6\u7fa4\u7684\u65b9\u5f0f\u90e8\u7f72\uff0c",(0,l.jsx)(n.strong,{children:"\u5404\u5b9e\u4f8b\u95f4\u76f8\u4e92\u4e0d\u8fdb\u884c\u4fe1\u606f\u901a\u8baf"})]}),"\n",(0,l.jsxs)(n.li,{children:["Broker \u5411\u6bcf\u4e00\u53f0 NameServer\uff08\u96c6\u7fa4\uff09\u6ce8\u518c\u81ea\u5df1\u7684\u8def\u7531\u4fe1\u606f\uff0c\u6240\u4ee5\u6bcf\u4e2a NameServer \u5b9e\u4f8b\u4e0a\u9762",(0,l.jsx)(n.strong,{children:"\u90fd\u4fdd\u5b58\u4e00\u4efd\u5b8c\u6574\u7684\u8def\u7531\u4fe1\u606f"})]}),"\n",(0,l.jsx)(n.li,{children:"\u5f53\u67d0\u4e2a NameServer \u56e0\u67d0\u79cd\u539f\u56e0\u4e0b\u7ebf\u4e86\uff0cBroker \u4ecd\u53ef\u4ee5\u5411\u5176\u5b83 NameServer \u540c\u6b65\u5176\u8def\u7531\u4fe1\u606f"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"BrokerServer \u4e3b\u8981\u8d1f\u8d23\u6d88\u606f\u7684\u5b58\u50a8\u3001\u6295\u9012\u548c\u67e5\u8be2\u4ee5\u53ca\u670d\u52a1\u9ad8\u53ef\u7528\u4fdd\u8bc1\uff0c\u5728 RocketMQ \u7cfb\u7edf\u4e2d\u63a5\u6536\u4ece\u751f\u4ea7\u8005\u53d1\u9001\u6765\u7684\u6d88\u606f\u5e76\u5b58\u50a8\u3001\u540c\u65f6\u4e3a\u6d88\u8d39\u8005\u7684\u62c9\u53d6\u8bf7\u6c42\u4f5c\u51c6\u5907\uff0c\u4e5f\u5b58\u50a8\u6d88\u606f\u76f8\u5173\u7684\u5143\u6570\u636e\uff0c\u5305\u62ec\u6d88\u8d39\u8005\u7ec4\u3001\u6d88\u8d39\u8fdb\u5ea6\u504f\u79fb\u548c\u4e3b\u9898\u548c\u961f\u5217\u6d88\u606f\u7b49"}),"\n",(0,l.jsx)(n.p,{children:"Broker \u5305\u542b\u4e86\u4ee5\u4e0b\u51e0\u4e2a\u91cd\u8981\u5b50\u6a21\u5757\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Remoting Module\uff1a\u6574\u4e2a Broker \u7684\u5b9e\u4f53\uff0c\u8d1f\u8d23\u5904\u7406\u6765\u81ea Clients \u7aef\u7684\u8bf7\u6c42"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Client Manager\uff1a\u8d1f\u8d23\u7ba1\u7406\u5ba2\u6237\u7aef\uff08Producer/Consumer\uff09\u548c\u7ef4\u62a4 Consumer \u7684 Topic \u8ba2\u9605\u4fe1\u606f"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Store Service\uff1a\u63d0\u4f9b\u65b9\u4fbf\u7b80\u5355\u7684 API \u63a5\u53e3\u5904\u7406\u6d88\u606f\u5b58\u50a8\u5230\u7269\u7406\u786c\u76d8\u548c\u67e5\u8be2\u529f\u80fd"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"HA Service\uff1a\u9ad8\u53ef\u7528\u670d\u52a1\uff0c\u63d0\u4f9b Master Broker \u548c Slave Broker \u4e4b\u95f4\u7684\u6570\u636e\u540c\u6b65\u529f\u80fd"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Index Service\uff1a\u6839\u636e\u7279\u5b9a\u7684 Message key \u5bf9\u6295\u9012\u5230 Broker \u7684\u6d88\u606f\u8fdb\u884c\u7d22\u5f15\u670d\u52a1\uff0c\u4ee5\u63d0\u4f9b\u6d88\u606f\u7684\u5feb\u901f\u67e5\u8be2"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(45301).A+"",width:"805",height:"401"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u603b\u4f53\u6d41\u7a0b",children:"\u603b\u4f53\u6d41\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u7684\u5de5\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u542f\u52a8 NameServer \u76d1\u542c\u7aef\u53e3\uff0c\u7b49\u5f85 Broker\u3001Producer\u3001Consumer \u8fde\u4e0a\u6765\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u8def\u7531\u63a7\u5236\u4e2d\u5fc3"}),"\n",(0,l.jsxs)(n.li,{children:["Broker \u542f\u52a8\uff0c\u8ddf",(0,l.jsx)(n.strong,{children:"\u6240\u6709\u7684 NameServer \u4fdd\u6301\u957f\u8fde\u63a5"}),"\uff0c\u6bcf\u9694 30s \u65f6\u95f4\u5411 NameServer \u4e0a\u62a5 Topic \u8def\u7531\u4fe1\u606f\uff08\u5fc3\u8df3\u5305\uff09\u3002\u5fc3\u8df3\u5305\u4e2d\u5305\u542b\u5f53\u524d Broker \u4fe1\u606f\uff08IP\u3001\u7aef\u53e3\u7b49\uff09\u4ee5\u53ca\u5b58\u50a8\u6240\u6709 Topic \u4fe1\u606f\u3002\u6ce8\u518c\u6210\u529f\u540e\uff0cNameServer \u96c6\u7fa4\u4e2d\u5c31\u6709 Topic \u8ddf Broker \u7684\u6620\u5c04\u5173\u7cfb"]}),"\n",(0,l.jsx)(n.li,{children:"\u6536\u53d1\u6d88\u606f\u524d\uff0c\u5148\u521b\u5efa Topic\uff0c\u521b\u5efa Topic \u65f6\u9700\u8981\u6307\u5b9a\u8be5 Topic \u8981\u5b58\u50a8\u5728\u54ea\u4e9b Broker \u4e0a\uff0c\u4e5f\u53ef\u4ee5\u5728\u53d1\u9001\u6d88\u606f\u65f6\u81ea\u52a8\u521b\u5efa Topic"}),"\n",(0,l.jsxs)(n.li,{children:["Producer \u542f\u52a8\u65f6\u5148\u8ddf NameServer \u96c6\u7fa4\u4e2d\u7684",(0,l.jsx)(n.strong,{children:"\u5176\u4e2d\u4e00\u53f0"}),"\u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u5e76\u4ece NameServer \u4e2d\u83b7\u53d6\u5f53\u524d\u53d1\u9001\u7684 Topic \u5b58\u5728\u54ea\u4e9b Broker \u4e0a\uff0c\u540c\u65f6 Producer \u4f1a\u9ed8\u8ba4\u6bcf\u9694 30s \u5411 NameServer ",(0,l.jsx)(n.strong,{children:"\u5b9a\u65f6\u62c9\u53d6"}),"\u4e00\u6b21\u8def\u7531\u4fe1\u606f"]}),"\n",(0,l.jsx)(n.li,{children:"Producer \u53d1\u9001\u6d88\u606f\u65f6\uff0c\u6839\u636e\u6d88\u606f\u7684 Topic \u4ece\u672c\u5730\u7f13\u5b58\u7684 TopicPublishInfoTable \u83b7\u53d6\u8def\u7531\u4fe1\u606f\uff0c\u5982\u679c\u6ca1\u6709\u5219\u4f1a\u4ece NameServer \u4e0a\u91cd\u65b0\u62c9\u53d6\u5e76\u66f4\u65b0\uff0c\u8f6e\u8be2\u961f\u5217\u5217\u8868\u5e76\u9009\u62e9\u4e00\u4e2a\u961f\u5217 MessageQueue\uff0c\u7136\u540e\u4e0e\u961f\u5217\u6240\u5728\u7684 Broker \u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u5411 Broker \u53d1\u6d88\u606f"}),"\n",(0,l.jsxs)(n.li,{children:["Consumer \u8ddf Producer \u7c7b\u4f3c\uff0c\u8ddf\u5176\u4e2d\u4e00\u53f0 NameServer \u5efa\u7acb\u957f\u8fde\u63a5\uff0c",(0,l.jsx)(n.strong,{children:"\u5b9a\u65f6\u83b7\u53d6\u8def\u7531\u4fe1\u606f"}),"\uff0c\u6839\u636e\u5f53\u524d\u8ba2\u9605 Topic \u5b58\u5728\u54ea\u4e9b Broker \u4e0a\uff0c\u76f4\u63a5\u8ddf Broker \u5efa\u7acb\u8fde\u63a5\u901a\u9053\uff0c\u5728\u5b8c\u6210\u5ba2\u6237\u7aef\u7684\u8d1f\u8f7d\u5747\u8861\u540e\uff0c\u9009\u62e9\u5176\u4e2d\u7684\u67d0\u4e00\u4e2a\u6216\u8005\u67d0\u51e0\u4e2a MessageQueue \u6765\u62c9\u53d6\u6d88\u606f\u5e76\u8fdb\u884c\u6d88\u8d39"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u751f\u4ea7\u6d88\u8d39",children:"\u751f\u4ea7\u6d88\u8d39"}),"\n",(0,l.jsx)(n.p,{children:"At least Once\uff1a\u81f3\u5c11\u4e00\u6b21\uff0c\u6307\u6bcf\u4e2a\u6d88\u606f\u5fc5\u987b\u6295\u9012\u4e00\u6b21\uff0cConsumer \u5148 Pull \u6d88\u606f\u5230\u672c\u5730\uff0c\u6d88\u8d39\u5b8c\u6210\u540e\u624d\u5411\u670d\u52a1\u5668\u8fd4\u56de ACK\uff0c\u5982\u679c\u6ca1\u6709\u6d88\u8d39\u4e00\u5b9a\u4e0d\u4f1a ACK \u6d88\u606f"}),"\n",(0,l.jsx)(n.p,{children:"\u56de\u6eaf\u6d88\u8d39\uff1a\u6307 Consumer \u5df2\u7ecf\u6d88\u8d39\u6210\u529f\u7684\u6d88\u606f\uff0c\u7531\u4e8e\u4e1a\u52a1\u4e0a\u9700\u6c42\u9700\u8981\u91cd\u65b0\u6d88\u8d39\uff0cBroker \u5728\u5411 Consumer \u6295\u9012\u6210\u529f\u6d88\u606f\u540e\uff0c\u6d88\u606f\u4ecd\u7136\u9700\u8981\u4fdd\u7559\u3002\u5e76\u4e14\u91cd\u65b0\u6d88\u8d39\u4e00\u822c\u662f\u6309\u7167\u65f6\u95f4\u7ef4\u5ea6\uff0c\u4f8b\u5982\u7531\u4e8e Consumer \u7cfb\u7edf\u6545\u969c\uff0c\u6062\u590d\u540e\u9700\u8981\u91cd\u65b0\u6d88\u8d39 1 \u5c0f\u65f6\u524d\u7684\u6570\u636e\uff0cRocketMQ \u652f\u6301\u6309\u7167\u65f6\u95f4\u56de\u6eaf\u6d88\u8d39\uff0c\u65f6\u95f4\u7ef4\u5ea6\u7cbe\u786e\u5230\u6beb\u79d2"}),"\n",(0,l.jsxs)(n.p,{children:["\u5206\u5e03\u5f0f\u961f\u5217\u56e0\u4e3a\u6709\u9ad8\u53ef\u9760\u6027\u7684\u8981\u6c42\uff0c\u6240\u4ee5\u6570\u636e\u8981\u8fdb\u884c",(0,l.jsx)(n.strong,{children:"\u6301\u4e45\u5316\u5b58\u50a8"})]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u6d88\u606f\u751f\u4ea7\u8005\u53d1\u9001\u6d88\u606f"}),"\n",(0,l.jsx)(n.li,{children:"MQ \u6536\u5230\u6d88\u606f\uff0c\u5c06\u6d88\u606f\u8fdb\u884c\u6301\u4e45\u5316\uff0c\u5728\u5b58\u50a8\u4e2d\u65b0\u589e\u4e00\u6761\u8bb0\u5f55"}),"\n",(0,l.jsx)(n.li,{children:"\u8fd4\u56de ACK \u7ed9\u751f\u4ea7\u8005"}),"\n",(0,l.jsx)(n.li,{children:"MQ push \u6d88\u606f\u7ed9\u5bf9\u5e94\u7684\u6d88\u8d39\u8005\uff0c\u7136\u540e\u7b49\u5f85\u6d88\u8d39\u8005\u8fd4\u56de ACK"}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u6d88\u606f\u6d88\u8d39\u8005\u5728\u6307\u5b9a\u65f6\u95f4\u5185\u6210\u529f\u8fd4\u56de ACK\uff0c\u90a3\u4e48 MQ \u8ba4\u4e3a\u6d88\u606f\u6d88\u8d39\u6210\u529f\uff0c\u5728\u5b58\u50a8\u4e2d\u5220\u9664\u6d88\u606f\uff1b\u5982\u679c MQ \u5728\u6307\u5b9a\u65f6\u95f4\u5185\u6ca1\u6709\u6536\u5230 ACK\uff0c\u5219\u8ba4\u4e3a\u6d88\u606f\u6d88\u8d39\u5931\u8d25\uff0c\u4f1a\u5c1d\u8bd5\u91cd\u65b0 push \u6d88\u606f\uff0c\u91cd\u590d\u6267\u884c 4\u30015\u30016 \u6b65\u9aa4"}),"\n",(0,l.jsx)(n.li,{children:"MQ \u5220\u9664\u6d88\u606f"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(55820).A+"",width:"855",height:"408"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5b58\u50a8\u673a\u5236",children:"\u5b58\u50a8\u673a\u5236"}),"\n",(0,l.jsx)(n.h4,{id:"\u5b58\u50a8\u7ed3\u6784",children:"\u5b58\u50a8\u7ed3\u6784"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u4e2d Broker \u8d1f\u8d23\u5b58\u50a8\u6d88\u606f\u8f6c\u53d1\u6d88\u606f\uff0c\u6240\u4ee5\u4ee5\u4e0b\u7684\u7ed3\u6784\u662f\u5b58\u50a8\u5728 Broker Server \u4e0a\u7684\uff0c\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u4e0e Broker \u8fdb\u884c\u6d88\u606f\u7684\u6536\u53d1\u662f\u901a\u8fc7\u4e3b\u9898\u5bf9\u5e94\u7684 Message Queue \u5b8c\u6210\uff0c\u7c7b\u4f3c\u4e8e\u901a\u9053"}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u6d88\u606f\u7684\u5b58\u50a8\u662f\u7531 ConsumeQueue \u548c CommitLog \u914d\u5408\u5b8c\u6210 \u7684\uff0cCommitLog \u662f\u6d88\u606f\u771f\u6b63\u7684",(0,l.jsx)(n.strong,{children:"\u7269\u7406\u5b58\u50a8"}),"\u6587\u4ef6\uff0cConsumeQueue \u662f\u6d88\u606f\u7684\u903b\u8f91\u961f\u5217\uff0c\u7c7b\u4f3c\u6570\u636e\u5e93\u7684",(0,l.jsx)(n.strong,{children:"\u7d22\u5f15\u8282\u70b9"}),"\uff0c\u5b58\u50a8\u7684\u662f\u6307\u5411\u7269\u7406\u5b58\u50a8\u7684\u5730\u5740\u3002",(0,l.jsx)(n.strong,{children:"\u6bcf\u4e2a Topic \u4e0b\u7684\u6bcf\u4e2a Message Queue \u90fd\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684 ConsumeQueue \u6587\u4ef6"})]}),"\n",(0,l.jsx)(n.p,{children:"\u6bcf\u6761\u6d88\u606f\u90fd\u4f1a\u6709\u5bf9\u5e94\u7684\u7d22\u5f15\u4fe1\u606f\uff0cConsumer \u901a\u8fc7 ConsumeQueue \u8fd9\u4e2a\u7ed3\u6784\u6765\u8bfb\u53d6\u6d88\u606f\u5b9e\u4f53\u5185\u5bb9"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(90703).A+"",width:"1108",height:"543"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["CommitLog\uff1a\u6d88\u606f\u4e3b\u4f53\u4ee5\u53ca\u5143\u6570\u636e\u7684\u5b58\u50a8\u4e3b\u4f53\uff0c\u5b58\u50a8 Producer \u7aef\u5199\u5165\u7684\u6d88\u606f\u5185\u5bb9\uff0c\u6d88\u606f\u5185\u5bb9\u4e0d\u662f\u5b9a\u957f\u7684\u3002\u6d88\u606f\u4e3b\u8981\u662f",(0,l.jsx)(n.strong,{children:"\u987a\u5e8f\u5199\u5165"}),"\u65e5\u5fd7\u6587\u4ef6\uff0c\u5355\u4e2a\u6587\u4ef6\u5927\u5c0f\u9ed8\u8ba4 1G\uff0c\u504f\u79fb\u91cf\u4ee3\u8868\u4e0b\u4e00\u6b21\u5199\u5165\u7684\u4f4d\u7f6e\uff0c\u5f53\u6587\u4ef6\u5199\u6ee1\u4e86\u5c31\u7ee7\u7eed\u5199\u5165\u4e0b\u4e00\u4e2a\u6587\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:["ConsumerQueue\uff1a\u6d88\u606f\u6d88\u8d39\u961f\u5217\uff0c\u5b58\u50a8\u6d88\u606f\u5728 CommitLog \u7684\u7d22\u5f15\u3002RocketMQ \u6d88\u606f\u6d88\u8d39\u65f6\u8981\u904d\u5386 CommitLog \u6587\u4ef6\uff0c\u5e76\u6839\u636e\u4e3b\u9898 Topic \u68c0\u7d22\u6d88\u606f\uff0c\u8fd9\u662f\u975e\u5e38\u4f4e\u6548\u7684\u3002\u5f15\u5165 ConsumeQueue \u4f5c\u4e3a\u6d88\u8d39\u6d88\u606f\u7684\u7d22\u5f15\uff0c",(0,l.jsx)(n.strong,{children:"\u4fdd\u5b58\u4e86\u6307\u5b9a Topic \u4e0b\u7684\u961f\u5217\u6d88\u606f\u5728 CommitLog \u4e2d\u7684\u8d77\u59cb\u7269\u7406\u504f\u79fb\u91cf offset"}),"\uff0c\u6d88\u606f\u5927\u5c0f size \u548c\u6d88\u606f Tag \u7684 HashCode \u503c\uff0c\u6bcf\u4e2a ConsumeQueue \u6587\u4ef6\u5927\u5c0f\u7ea6 5.72M"]}),"\n",(0,l.jsxs)(n.li,{children:["IndexFile\uff1a\u4e3a\u4e86\u6d88\u606f\u67e5\u8be2\u63d0\u4f9b\u4e86\u4e00\u79cd\u901a\u8fc7 Key \u6216\u65f6\u95f4\u533a\u95f4\u6765\u67e5\u8be2\u6d88\u606f\u7684\u65b9\u6cd5\uff0c\u901a\u8fc7 IndexFile \u6765\u67e5\u627e\u6d88\u606f\u7684\u65b9\u6cd5",(0,l.jsx)(n.strong,{children:"\u4e0d\u5f71\u54cd\u53d1\u9001\u4e0e\u6d88\u8d39\u6d88\u606f\u7684\u4e3b\u6d41\u7a0b"}),"\u3002IndexFile \u7684\u5e95\u5c42\u5b58\u50a8\u4e3a\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5b9e\u73b0\u7684 HashMap \u7ed3\u6784\uff0c\u6545 RocketMQ \u7684\u7d22\u5f15\u6587\u4ef6\u5176\u5e95\u5c42\u5b9e\u73b0\u4e3a ",(0,l.jsx)(n.strong,{children:"hash \u7d22\u5f15"})]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u91c7\u7528\u7684\u662f\u6df7\u5408\u578b\u7684\u5b58\u50a8\u7ed3\u6784\uff0c\u5373\u4e3a Broker \u5355\u4e2a\u5b9e\u4f8b\u4e0b\u6240\u6709\u7684\u961f\u5217\u5171\u7528\u4e00\u4e2a\u65e5\u5fd7\u6570\u636e\u6587\u4ef6\uff08CommitLog\uff09\u6765\u5b58\u50a8\uff0c\u591a\u4e2a Topic \u7684\u6d88\u606f\u5b9e\u4f53\u5185\u5bb9\u90fd\u5b58\u50a8\u4e8e\u4e00\u4e2a CommitLog \u4e2d\u3002\u6df7\u5408\u578b\u5b58\u50a8\u7ed3\u6784\u9488\u5bf9 Producer \u548c Consumer \u5206\u522b\u91c7\u7528\u4e86",(0,l.jsx)(n.strong,{children:"\u6570\u636e\u548c\u7d22\u5f15\u90e8\u5206\u76f8\u5206\u79bb"}),"\u7684\u5b58\u50a8\u7ed3\u6784\uff0cProducer \u53d1\u9001\u6d88\u606f\u81f3 Broker \u7aef\uff0c\u7136\u540e Broker \u7aef\u4f7f\u7528\u540c\u6b65\u6216\u8005\u5f02\u6b65\u7684\u65b9\u5f0f\u5bf9\u6d88\u606f\u5237\u76d8\u6301\u4e45\u5316\uff0c\u4fdd\u5b58\u81f3 CommitLog \u4e2d\u3002\u53ea\u8981\u6d88\u606f\u88ab\u6301\u4e45\u5316\u81f3\u78c1\u76d8\u6587\u4ef6 CommitLog \u4e2d\uff0cProducer \u53d1\u9001\u7684\u6d88\u606f\u5c31\u4e0d\u4f1a\u4e22\u5931\uff0cConsumer \u4e5f\u5c31\u80af\u5b9a\u6709\u673a\u4f1a\u53bb\u6d88\u8d39\u8fd9\u6761\u6d88\u606f"]}),"\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u652f\u6301\u957f\u8f6e\u8be2\u6a21\u5f0f\uff0c\u5f53\u6d88\u8d39\u8005\u65e0\u6cd5\u62c9\u53d6\u5230\u6d88\u606f\u540e\uff0c\u53ef\u4ee5\u7b49\u4e0b\u4e00\u6b21\u6d88\u606f\u62c9\u53d6\uff0cBroker \u5141\u8bb8\u7b49\u5f85 30s \u7684\u65f6\u95f4\uff0c\u53ea\u8981\u8fd9\u6bb5\u65f6\u95f4\u5185\u6709\u65b0\u6d88\u606f\u5230\u8fbe\uff0c\u5c06\u76f4\u63a5\u8fd4\u56de\u7ed9\u6d88\u8d39\u7aef\u3002RocketMQ \u7684\u5177\u4f53\u505a\u6cd5\u662f\uff0c\u4f7f\u7528 Broker \u7aef\u7684\u540e\u53f0\u670d\u52a1\u7ebf\u7a0b ReputMessageService \u4e0d\u505c\u5730\u5206\u53d1\u8bf7\u6c42\u5e76\u5f02\u6b65\u6784\u5efa ConsumeQueue\uff08\u903b\u8f91\u6d88\u8d39\u961f\u5217\uff09\u548c IndexFile\uff08\u7d22\u5f15\u6587\u4ef6\uff09\u6570\u636e"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5185\u5b58\u6620\u5c04",children:"\u5185\u5b58\u6620\u5c04"}),"\n",(0,l.jsx)(n.p,{children:"\u64cd\u4f5c\u7cfb\u7edf\u5206\u4e3a\u7528\u6237\u6001\u548c\u5185\u6838\u6001\uff0c\u6587\u4ef6\u64cd\u4f5c\u3001\u7f51\u7edc\u64cd\u4f5c\u9700\u8981\u6d89\u53ca\u8fd9\u4e24\u79cd\u5f62\u6001\u7684\u5207\u6362\uff0c\u9700\u8981\u8fdb\u884c\u6570\u636e\u590d\u5236\u3002\u4e00\u53f0\u670d\u52a1\u5668\u628a\u672c\u673a\u78c1\u76d8\u6587\u4ef6\u7684\u5185\u5bb9\u53d1\u9001\u5230\u5ba2\u6237\u7aef\uff0c\u5206\u4e3a\u4e24\u4e2a\u6b65\u9aa4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"read\uff1a\u8bfb\u53d6\u672c\u5730\u6587\u4ef6\u5185\u5bb9"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"write\uff1a\u5c06\u8bfb\u53d6\u7684\u5185\u5bb9\u901a\u8fc7\u7f51\u7edc\u53d1\u9001\u51fa\u53bb"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(29242).A+"",width:"939",height:"125"})}),"\n",(0,l.jsx)(n.p,{children:"\u8865\u5145\uff1aProg \u2192 NET \u2192 I/O \u2192 \u96f6\u62f7\u8d1d\u90e8\u5206\u7684\u7b14\u8bb0\u8be6\u89e3\u76f8\u5173\u5185\u5bb9"}),"\n",(0,l.jsxs)(n.p,{children:["\u901a\u8fc7\u4f7f\u7528 mmap \u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u7701\u53bb\u5411\u7528\u6237\u6001\u7684\u5185\u5b58\u590d\u5236\uff0cRocketMQ \u5145\u5206\u5229\u7528",(0,l.jsx)(n.strong,{children:"\u96f6\u62f7\u8d1d\u6280\u672f"}),"\uff0c\u63d0\u9ad8\u6d88\u606f\u5b58\u76d8\u548c\u7f51\u7edc\u53d1\u9001\u7684\u901f\u5ea6"]}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u901a\u8fc7 MappedByteBuffer \u5bf9\u6587\u4ef6\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\uff0c\u5229\u7528\u4e86 NIO \u4e2d\u7684 FileChannel \u6a21\u578b\u5c06\u78c1\u76d8\u4e0a\u7684\u7269\u7406\u6587\u4ef6\u76f4\u63a5\u6620\u5c04\u5230\u7528\u6237\u6001\u7684\u5185\u5b58\u5730\u5740\u4e2d\uff0c\u5c06\u5bf9\u6587\u4ef6\u7684\u64cd\u4f5c\u8f6c\u5316\u4e3a\u76f4\u63a5\u5bf9\u5185\u5b58\u5730\u5740\u8fdb\u884c\u64cd\u4f5c\uff0c\u4ece\u800c\u6781\u5927\u5730\u63d0\u9ad8\u4e86\u6587\u4ef6\u7684\u8bfb\u5199\u6548\u7387"}),"\n",(0,l.jsxs)(n.p,{children:["MappedByteBuffer \u5185\u5b58\u6620\u5c04\u7684\u65b9\u5f0f",(0,l.jsx)(n.strong,{children:"\u9650\u5236"}),"\u4e00\u6b21\u53ea\u80fd\u6620\u5c04 1.5~2G \u7684\u6587\u4ef6\u81f3\u7528\u6237\u6001\u7684\u865a\u62df\u5185\u5b58\uff0c\u6240\u4ee5 RocketMQ \u9ed8\u8ba4\u8bbe\u7f6e\u5355\u4e2a CommitLog \u65e5\u5fd7\u6570\u636e\u6587\u4ef6\u4e3a 1G\u3002RocketMQ \u7684\u6587\u4ef6\u5b58\u50a8\u4f7f\u7528\u5b9a\u957f\u7ed3\u6784\u6765\u5b58\u50a8\uff0c\u65b9\u4fbf\u4e00\u6b21\u5c06\u6574\u4e2a\u6587\u4ef6\u6620\u5c04\u81f3\u5185\u5b58"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u9875\u9762\u7f13\u5b58",children:"\u9875\u9762\u7f13\u5b58"}),"\n",(0,l.jsx)(n.p,{children:"\u9875\u7f13\u5b58\uff08PageCache\uff09\u662f OS \u5bf9\u6587\u4ef6\u7684\u7f13\u5b58\uff0c\u6bcf\u4e00\u9875\u7684\u5927\u5c0f\u901a\u5e38\u662f 4K\uff0c\u7528\u4e8e\u52a0\u901f\u5bf9\u6587\u4ef6\u7684\u8bfb\u5199\u3002\u56e0\u4e3a OS \u5c06\u4e00\u90e8\u5206\u7684\u5185\u5b58\u7528\u4f5c PageCache\uff0c\u6240\u4ee5\u7a0b\u5e8f\u5bf9\u6587\u4ef6\u8fdb\u884c\u987a\u5e8f\u8bfb\u5199\u7684\u901f\u5ea6\u51e0\u4e4e\u63a5\u8fd1\u4e8e\u5185\u5b58\u7684\u8bfb\u5199\u901f\u5ea6"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5bf9\u4e8e\u6570\u636e\u7684\u5199\u5165\uff0cOS \u4f1a\u5148\u5199\u5165\u81f3 Cache \u5185\uff0c\u968f\u540e",(0,l.jsx)(n.strong,{children:"\u901a\u8fc7\u5f02\u6b65\u7684\u65b9\u5f0f\u7531 pdflush \u5185\u6838\u7ebf\u7a0b\u5c06 Cache \u5185\u7684\u6570\u636e\u5237\u76d8\u81f3\u7269\u7406\u78c1\u76d8\u4e0a"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u5bf9\u4e8e\u6570\u636e\u7684\u8bfb\u53d6\uff0c\u5982\u679c\u4e00\u6b21\u8bfb\u53d6\u6587\u4ef6\u65f6\u51fa\u73b0\u672a\u547d\u4e2d PageCache \u7684\u60c5\u51b5\uff0cOS \u4ece\u7269\u7406\u78c1\u76d8\u4e0a\u8bbf\u95ee\u8bfb\u53d6\u6587\u4ef6\u7684\u540c\u65f6\uff0c\u4f1a\u987a\u5e8f\u5bf9\u5176\u4ed6\u76f8\u90bb\u5757\u7684\u6570\u636e\u6587\u4ef6\u8fdb\u884c",(0,l.jsx)(n.strong,{children:"\u9884\u8bfb\u53d6"}),"\uff08\u5c40\u90e8\u6027\u539f\u7406\uff0c\u6700\u5927 128K\uff09"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5728 RocketMQ \u4e2d\uff0cConsumeQueue \u903b\u8f91\u6d88\u8d39\u961f\u5217\u5b58\u50a8\u7684\u6570\u636e\u8f83\u5c11\uff0c\u5e76\u4e14\u662f\u987a\u5e8f\u8bfb\u53d6\uff0c\u5728 PageCache \u673a\u5236\u7684\u9884\u8bfb\u53d6\u4f5c\u7528\u4e0b\uff0cConsume Queue \u6587\u4ef6\u7684\u8bfb\u6027\u80fd\u51e0\u4e4e\u63a5\u8fd1\u8bfb\u5185\u5b58\uff0c\u5373\u4f7f\u5728\u6709\u6d88\u606f\u5806\u79ef\u60c5\u51b5\u4e0b\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u6027\u80fd\u3002\u4f46\u662f CommitLog \u6d88\u606f\u5b58\u50a8\u7684\u65e5\u5fd7\u6570\u636e\u6587\u4ef6\u8bfb\u53d6\u5185\u5bb9\u65f6\u4f1a\u4ea7\u751f\u8f83\u591a\u7684\u968f\u673a\u8bbf\u95ee\u8bfb\u53d6\uff0c\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\u3002\u9009\u62e9\u5408\u9002\u7684\u7cfb\u7edf IO \u8c03\u5ea6\u7b97\u6cd5\u548c\u56fa\u6001\u786c\u76d8\uff0c\u6bd4\u5982\u8bbe\u7f6e\u8c03\u5ea6\u7b97\u6cd5\u4e3a Deadline\uff0c\u968f\u673a\u8bfb\u7684\u6027\u80fd\u4e5f\u4f1a\u6709\u6240\u63d0\u5347"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5237\u76d8\u673a\u5236",children:"\u5237\u76d8\u673a\u5236"}),"\n",(0,l.jsx)(n.p,{children:"\u4e24\u79cd\u6301\u4e45\u5316\u7684\u65b9\u6848\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5173\u7cfb\u578b\u6570\u636e\u5e93 DB\uff1aIO \u8bfb\u5199\u6027\u80fd\u6bd4\u8f83\u5dee\uff0c\u5982\u679c DB \u51fa\u73b0\u6545\u969c\uff0c\u5219 MQ \u7684\u6d88\u606f\u5c31\u65e0\u6cd5\u843d\u76d8\u5b58\u50a8\u5bfc\u81f4\u7ebf\u4e0a\u6545\u969c\uff0c\u53ef\u9760\u6027\u4e0d\u9ad8"}),"\n",(0,l.jsx)(n.li,{children:"\u6587\u4ef6\u7cfb\u7edf\uff1a\u6d88\u606f\u5237\u76d8\u81f3\u6240\u90e8\u7f72\u865a\u62df\u673a/\u7269\u7406\u673a\u7684\u6587\u4ef6\u7cfb\u7edf\u6765\u505a\u6301\u4e45\u5316\uff0c\u5206\u4e3a\u5f02\u6b65\u5237\u76d8\u548c\u540c\u6b65\u5237\u76d8\u4e24\u79cd\u6a21\u5f0f\u3002\u6d88\u606f\u5237\u76d8\u4e3a\u6d88\u606f\u5b58\u50a8\u63d0\u4f9b\u4e86\u4e00\u79cd\u9ad8\u6548\u7387\u3001\u9ad8\u53ef\u9760\u6027\u548c\u9ad8\u6027\u80fd\u7684\u6570\u636e\u6301\u4e45\u5316\u65b9\u5f0f\uff0c\u9664\u975e\u90e8\u7f72 MQ \u673a\u5668\u672c\u8eab\u6216\u662f\u672c\u5730\u78c1\u76d8\u6302\u4e86\uff0c\u4e00\u822c\u4e0d\u4f1a\u51fa\u73b0\u65e0\u6cd5\u6301\u4e45\u5316\u7684\u95ee\u9898"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u91c7\u7528\u6587\u4ef6\u7cfb\u7edf\u7684\u65b9\u5f0f\uff0c\u65e0\u8bba\u540c\u6b65\u8fd8\u662f\u5f02\u6b65\u5237\u76d8\uff0c\u90fd\u4f7f\u7528",(0,l.jsx)(n.strong,{children:"\u987a\u5e8f IO"}),"\uff0c\u56e0\u4e3a\u78c1\u76d8\u7684\u987a\u5e8f\u8bfb\u5199\u8981\u6bd4\u968f\u673a\u8bfb\u5199\u5feb\u5f88\u591a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u540c\u6b65\u5237\u76d8\uff1a\u53ea\u6709\u5728\u6d88\u606f\u771f\u6b63\u6301\u4e45\u5316\u81f3\u78c1\u76d8\u540e RocketMQ \u7684 Broker \u7aef\u624d\u4f1a\u771f\u6b63\u8fd4\u56de\u7ed9 Producer \u7aef\u4e00\u4e2a\u6210\u529f\u7684 ACK \u54cd\u5e94\uff0c\u4fdd\u969c MQ \u6d88\u606f\u7684\u53ef\u9760\u6027\uff0c\u4f46\u662f\u6027\u80fd\u4e0a\u4f1a\u6709\u8f83\u5927\u5f71\u54cd\uff0c\u4e00\u822c\u9002\u7528\u4e8e\u91d1\u878d\u4e1a\u52a1\u5e94\u7528\u8be5\u6a21\u5f0f\u8f83\u591a"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5f02\u6b65\u5237\u76d8\uff1a\u5229\u7528 OS \u7684 PageCache\uff0c\u53ea\u8981\u6d88\u606f\u5199\u5165\u5185\u5b58 PageCache \u5373\u53ef\u5c06\u6210\u529f\u7684 ACK \u8fd4\u56de\u7ed9 Producer \u7aef\uff0c\u964d\u4f4e\u4e86\u8bfb\u5199\u5ef6\u8fdf\uff0c\u63d0\u9ad8\u4e86 MQ \u7684\u6027\u80fd\u548c\u541e\u5410\u91cf\u3002\u6d88\u606f\u5237\u76d8\u91c7\u7528",(0,l.jsx)(n.strong,{children:"\u540e\u53f0\u5f02\u6b65\u7ebf\u7a0b"}),"\u63d0\u4ea4\u7684\u65b9\u5f0f\u8fdb\u884c\uff0c\u5f53\u5185\u5b58\u91cc\u7684\u6d88\u606f\u91cf\u79ef\u7d2f\u5230\u4e00\u5b9a\u7a0b\u5ea6\u65f6\uff0c\u89e6\u53d1\u5199\u78c1\u76d8\u52a8\u4f5c"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u901a\u8fc7 Broker \u914d\u7f6e\u6587\u4ef6\u91cc\u7684 flushDiskType \u53c2\u6570\u8bbe\u7f6e\u91c7\u7528\u4ec0\u4e48\u65b9\u5f0f\uff0c\u53ef\u4ee5\u914d\u7f6e\u6210 SYNC_FLUSH\u3001ASYNC_FLUSH \u4e2d\u7684\u4e00\u4e2a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(17656).A+"",width:"609",height:"555"})}),"\n",(0,l.jsxs)(n.p,{children:["\u5b98\u65b9\u6587\u6863\uff1a",(0,l.jsx)(n.a,{href:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md",children:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u96c6\u7fa4\u8bbe\u8ba1",children:"\u96c6\u7fa4\u8bbe\u8ba1"}),"\n",(0,l.jsx)(n.h4,{id:"\u96c6\u7fa4\u6a21\u5f0f",children:"\u96c6\u7fa4\u6a21\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u5e38\u7528\u7684\u4ee5\u4e0b\u51e0\u79cd\u6a21\u5f0f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5355 Master \u6a21\u5f0f\uff1a\u8fd9\u79cd\u65b9\u5f0f\u98ce\u9669\u8f83\u5927\uff0c\u4e00\u65e6 Broker \u91cd\u542f\u6216\u8005\u5b95\u673a\uff0c\u4f1a\u5bfc\u81f4\u6574\u4e2a\u670d\u52a1\u4e0d\u53ef\u7528"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u591a Master \u6a21\u5f0f\uff1a\u4e00\u4e2a\u96c6\u7fa4\u65e0 Slave\uff0c\u5168\u662f Master"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4f18\u70b9\uff1a\u914d\u7f6e\u7b80\u5355\uff0c\u5355\u4e2a Master \u5b95\u673a\u6216\u91cd\u542f\u7ef4\u62a4\u5bf9\u5e94\u7528\u65e0\u5f71\u54cd\uff0c\u5728\u78c1\u76d8\u914d\u7f6e\u4e3a RAID10 \u65f6\uff0c\u5373\u4f7f\u673a\u5668\u5b95\u673a\u4e0d\u53ef\u6062\u590d\u60c5\u51b5\u4e0b\uff0c\u7531\u4e8e RAID10 \u78c1\u76d8\u975e\u5e38\u53ef\u9760\uff0c\u6d88\u606f\u4e5f\u4e0d\u4f1a\u4e22\uff08\u5f02\u6b65\u5237\u76d8\u4e22\u5931\u5c11\u91cf\u6d88\u606f\uff0c\u540c\u6b65\u5237\u76d8\u4e00\u6761\u4e0d\u4e22\uff09\uff0c\u6027\u80fd\u6700\u9ad8"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7f3a\u70b9\uff1a\u5355\u53f0\u673a\u5668\u5b95\u673a\u671f\u95f4\uff0c\u8fd9\u53f0\u673a\u5668\u4e0a\u672a\u88ab\u6d88\u8d39\u7684\u6d88\u606f\u5728\u673a\u5668\u6062\u590d\u4e4b\u524d\u4e0d\u53ef\u8ba2\u9605\uff0c\u6d88\u606f\u5b9e\u65f6\u6027\u4f1a\u53d7\u5230\u5f71\u54cd"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u591a Master \u591a Slave \u6a21\u5f0f\uff08\u540c\u6b65\uff09\uff1a\u6bcf\u4e2a Master \u914d\u7f6e\u4e00\u4e2a Slave\uff0c\u6709\u591a\u5bf9 Master-Slave\uff0cHA \u91c7\u7528",(0,l.jsx)(n.strong,{children:"\u540c\u6b65\u53cc\u5199"}),"\u65b9\u5f0f\uff0c\u5373\u53ea\u6709\u4e3b\u5907\u90fd\u5199\u6210\u529f\uff0c\u624d\u5411\u5e94\u7528\u8fd4\u56de\u6210\u529f"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4f18\u70b9\uff1a\u6570\u636e\u4e0e\u670d\u52a1\u90fd\u65e0\u5355\u70b9\u6545\u969c\uff0cMaster \u5b95\u673a\u60c5\u51b5\u4e0b\uff0c\u6d88\u606f\u65e0\u5ef6\u8fdf\uff0c\u670d\u52a1\u53ef\u7528\u6027\u4e0e\u6570\u636e\u53ef\u7528\u6027\u90fd\u975e\u5e38\u9ad8"}),"\n",(0,l.jsx)(n.li,{children:"\u7f3a\u70b9\uff1a\u6027\u80fd\u6bd4\u5f02\u6b65\u590d\u5236\u7565\u4f4e\uff08\u5927\u7ea6\u4f4e 10% \u5de6\u53f3\uff09\uff0c\u53d1\u9001\u5355\u4e2a\u6d88\u606f\u7684 RT \u7565\u9ad8\uff0c\u76ee\u524d\u4e0d\u80fd\u5b9e\u73b0\u4e3b\u8282\u70b9\u5b95\u673a\uff0c\u5907\u673a\u81ea\u52a8\u5207\u6362\u4e3a\u4e3b\u673a"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u591a Master \u591a Slave \u6a21\u5f0f\uff08\u5f02\u6b65\uff09\uff1aHA \u91c7\u7528\u5f02\u6b65\u590d\u5236\u7684\u65b9\u5f0f\uff0c\u4f1a\u9020\u6210\u4e3b\u5907\u6709\u77ed\u6682\u7684\u6d88\u606f\u5ef6\u8fdf\uff08\u6beb\u79d2\u7ea7\u522b\uff09"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4f18\u70b9\uff1a\u5373\u4f7f\u78c1\u76d8\u635f\u574f\uff0c\u6d88\u606f\u4e22\u5931\u7684\u975e\u5e38\u5c11\uff0c\u4e14\u6d88\u606f\u5b9e\u65f6\u6027\u4e0d\u4f1a\u53d7\u5f71\u54cd\uff0c\u540c\u65f6 Master \u5b95\u673a\u540e\uff0c\u6d88\u8d39\u8005\u4ecd\u7136\u53ef\u4ee5\u4ece Slave \u6d88\u8d39\uff0c\u800c\u4e14\u6b64\u8fc7\u7a0b\u5bf9\u5e94\u7528\u900f\u660e\uff0c\u4e0d\u9700\u8981\u4eba\u5de5\u5e72\u9884\uff0c\u6027\u80fd\u540c\u591a Master \u6a21\u5f0f\u51e0\u4e4e\u4e00\u6837"}),"\n",(0,l.jsx)(n.li,{children:"\u7f3a\u70b9\uff1aMaster \u5b95\u673a\uff0c\u78c1\u76d8\u635f\u574f\u60c5\u51b5\u4e0b\u4f1a\u4e22\u5931\u5c11\u91cf\u6d88\u606f"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u96c6\u7fa4\u67b6\u6784",children:"\u96c6\u7fa4\u67b6\u6784"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u7f51\u7edc\u90e8\u7f72\u7279\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["NameServer \u662f\u4e00\u4e2a\u51e0\u4e4e",(0,l.jsx)(n.strong,{children:"\u65e0\u72b6\u6001\u8282\u70b9"}),"\uff0c\u8282\u70b9\u4e4b\u95f4\u76f8\u4e92\u72ec\u7acb\uff0c\u65e0\u4efb\u4f55\u4fe1\u606f\u540c\u6b65"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Broker \u90e8\u7f72\u76f8\u5bf9\u590d\u6742\uff0cBroker \u5206\u4e3a Master \u4e0e Slave\uff0cMaster \u53ef\u4ee5\u90e8\u7f72\u591a\u4e2a\uff0c\u4e00\u4e2a Master \u53ef\u4ee5\u5bf9\u5e94\u591a\u4e2a Slave\uff0c\u4f46\u662f\u4e00\u4e2a Slave \u53ea\u80fd\u5bf9\u5e94\u4e00\u4e2a Master\uff0cMaster \u4e0e Slave \u7684\u5bf9\u5e94\u5173\u7cfb\u901a\u8fc7\u6307\u5b9a\u76f8\u540c BrokerName\u3001\u4e0d\u540c BrokerId \u6765\u5b9a\u4e49\uff0cBrokerId \u4e3a 0 \u662f Master\uff0c\u975e 0 \u8868\u793a Slave\u3002",(0,l.jsx)(n.strong,{children:"\u6bcf\u4e2a Broker \u4e0e NameServer \u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u5efa\u7acb\u957f\u8fde\u63a5"}),"\uff0c\u5b9a\u65f6\u6ce8\u518c Topic \u4fe1\u606f\u5230\u6240\u6709 NameServer"]}),"\n",(0,l.jsx)(n.p,{children:"\u8bf4\u660e\uff1a\u90e8\u7f72\u67b6\u6784\u4e0a\u4e5f\u652f\u6301\u4e00 Master \u591a Slave\uff0c\u4f46\u53ea\u6709 BrokerId=1 \u7684\u4ece\u670d\u52a1\u5668\u624d\u4f1a\u53c2\u4e0e\u6d88\u606f\u7684\u8bfb\u8d1f\u8f7d\uff08\u8bfb\u5199\u5206\u79bb\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Producer \u4e0e NameServer \u96c6\u7fa4\u4e2d\u7684\u5176\u4e2d",(0,l.jsx)(n.strong,{children:"\u4e00\u4e2a\u8282\u70b9\uff08\u968f\u673a\u9009\u62e9\uff09\u5efa\u7acb\u957f\u8fde\u63a5"}),"\uff0c\u5b9a\u671f\u4ece NameServer \u83b7\u53d6 Topic \u8def\u7531\u4fe1\u606f\uff0c\u5e76\u5411\u63d0\u4f9b Topic \u670d\u52a1\u7684 Master \u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u4e14\u5b9a\u65f6\u5411 Master ",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u5fc3\u8df3"}),"\u3002Producer \u5b8c\u5168\u65e0\u72b6\u6001\uff0c\u53ef\u96c6\u7fa4\u90e8\u7f72"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Consumer \u4e0e NameServer \u96c6\u7fa4\u4e2d\u7684\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\uff08\u968f\u673a\u9009\u62e9\uff09\u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u5b9a\u671f\u4ece NameServer \u83b7\u53d6 Topic \u8def\u7531\u4fe1\u606f\uff0c\u5e76\u5411\u63d0\u4f9b  Topic \u670d\u52a1\u7684 Master\u3001Slave \u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u4e14\u5b9a\u65f6\u5411 Master\u3001Slave \u53d1\u9001\u5fc3\u8df3"}),"\n",(0,l.jsx)(n.p,{children:"Consumer \u65e2\u53ef\u4ee5\u4ece Master \u8ba2\u9605\u6d88\u606f\uff0c\u4e5f\u53ef\u4ee5\u4ece Slave \u8ba2\u9605\u6d88\u606f\uff0c\u5728\u5411 Master \u62c9\u53d6\u6d88\u606f\u65f6\uff0cMaster \u670d\u52a1\u5668\u4f1a\u6839\u636e\u62c9\u53d6\u504f\u79fb\u91cf\u4e0e\u6700\u5927\u504f\u79fb\u91cf\u7684\u8ddd\u79bb\uff08\u5224\u65ad\u662f\u5426\u8bfb\u8001\u6d88\u606f\uff0c\u4ea7\u751f\u8bfb I/O\uff09\uff0c\u4ee5\u53ca\u4ece\u670d\u52a1\u5668\u662f\u5426\u53ef\u8bfb\u7b49\u56e0\u7d20\u5efa\u8bae\u4e0b\u4e00\u6b21\u662f\u4ece Master \u8fd8\u662f Slave \u62c9\u53d6"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(26525).A+"",width:"1216",height:"571"})}),"\n",(0,l.jsxs)(n.p,{children:["\u5b98\u65b9\u6587\u6863\uff1a",(0,l.jsx)(n.a,{href:"https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md",children:"https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u9ad8\u53ef\u7528\u6027",children:"\u9ad8\u53ef\u7528\u6027"}),"\n",(0,l.jsx)(n.p,{children:"NameServer \u8282\u70b9\u662f\u65e0\u72b6\u6001\u7684\uff0c\u4e14\u5404\u4e2a\u8282\u70b9\u76f4\u63a5\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\uff0c\u90e8\u5206 NameServer \u4e0d\u53ef\u7528\u4e5f\u53ef\u4ee5\u4fdd\u8bc1 MQ \u670d\u52a1\u6b63\u5e38\u8fd0\u884c"}),"\n",(0,l.jsx)(n.p,{children:"BrokerServer \u7684\u9ad8\u53ef\u7528\u901a\u8fc7 Master \u548c Slave \u7684\u914d\u5408\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Slave \u53ea\u8d1f\u8d23\u8bfb\uff0c\u5f53 Master \u4e0d\u53ef\u7528\uff0c\u5bf9\u5e94\u7684 Slave \u4ecd\u80fd\u4fdd\u8bc1\u6d88\u606f\u88ab\u6b63\u5e38\u6d88\u8d39"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u591a\u7ec4 Master-Slave \u7ec4\uff0c\u5176\u4ed6\u7684 Master-Slave \u7ec4\u4e5f\u4f1a\u4fdd\u8bc1\u6d88\u606f\u7684\u6b63\u5e38\u53d1\u9001\u548c\u6d88\u8d39"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u76ee\u524d\u4e0d\u652f\u6301\u628a Slave \u81ea\u52a8\u8f6c\u6210 Master"}),"\uff0c\u9700\u8981\u624b\u52a8\u505c\u6b62 Slave \u89d2\u8272\u7684 Broker\uff0c\u66f4\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u7528\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\u542f\u52a8 Broker"]}),"\n",(0,l.jsx)(n.p,{children:"\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u591a\u4e2a Master \u4fdd\u8bc1\u53ef\u7528\u6027\uff0c\u5426\u5219\u4e00\u4e2a Master \u6302\u4e86\u5bfc\u81f4\u6574\u4f53\u7cfb\u7edf\u7684\u5199\u64cd\u4f5c\u4e0d\u53ef\u7528"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u751f\u4ea7\u7aef\u7684\u9ad8\u53ef\u7528\uff1a\u5728\u521b\u5efa Topic \u7684\u65f6\u5019\uff0c\u628a Topic \u7684",(0,l.jsx)(n.strong,{children:"\u591a\u4e2a Message Queue \u521b\u5efa\u5728\u591a\u4e2a Broker \u7ec4"}),"\u4e0a\uff08\u76f8\u540c Broker \u540d\u79f0\uff0c\u4e0d\u540c brokerId \u7684\u673a\u5668\uff09\uff0c\u5f53\u4e00\u4e2a Broker \u7ec4\u7684 Master \u4e0d\u53ef\u7528\u540e\uff0c\u5176\u4ed6\u7ec4\u7684 Master \u4ecd\u7136\u53ef\u7528\uff0cProducer \u4ecd\u7136\u53ef\u4ee5\u53d1\u9001\u6d88\u606f"]}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u7aef\u7684\u9ad8\u53ef\u7528\uff1a\u5728 Consumer \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5e76\u4e0d\u9700\u8981\u8bbe\u7f6e\u662f\u4ece Master Broker \u8bfb\u8fd8\u662f\u4ece Slave \u8bfb\uff0c\u5f53 Master \u4e0d\u53ef\u7528\u6216\u8005\u7e41\u5fd9\u7684\u65f6\u5019\uff0cConsumer \u4f1a\u88ab\u81ea\u52a8\u5207\u6362\u5230\u4ece Slave \u8bfb\u3002\u6709\u4e86\u81ea\u52a8\u5207\u6362\u7684\u673a\u5236\uff0c\u5f53\u4e00\u4e2a Master \u673a\u5668\u51fa\u73b0\u6545\u969c\u540e\uff0cConsumer \u4ecd\u7136\u53ef\u4ee5\u4ece Slave \u8bfb\u53d6\u6d88\u606f\uff0c\u4e0d\u5f71\u54cd Consumer \u7a0b\u5e8f\uff0c\u8fbe\u5230\u4e86\u6d88\u8d39\u7aef\u7684\u9ad8\u53ef\u7528\u6027"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(3688).A+"",width:"860",height:"533"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4e3b\u4ece\u590d\u5236",children:"\u4e3b\u4ece\u590d\u5236"}),"\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u4e00\u4e2a Broker \u7ec4\u6709 Master \u548c Slave\uff0c\u6d88\u606f\u9700\u8981\u4ece Master \u590d\u5236\u5230 Slave \u4e0a\uff0c\u6709\u540c\u6b65\u548c\u5f02\u6b65\u4e24\u79cd\u590d\u5236\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u540c\u6b65\u590d\u5236\u65b9\u5f0f\uff1aMaster \u548c Slave \u5747\u5199\u6210\u529f\u540e\u624d\u53cd\u9988\u7ed9\u5ba2\u6237\u7aef\u5199\u6210\u529f\u72b6\u6001\uff08\u5199 Page Cache\uff09\u3002\u5728\u540c\u6b65\u590d\u5236\u65b9\u5f0f\u4e0b\uff0c\u5982\u679c Master \u51fa\u6545\u969c\uff0c Slave \u4e0a\u6709\u5168\u90e8\u7684\u5907\u4efd\u6570\u636e\uff0c\u5bb9\u6613\u6062\u590d\uff0c\u4f46\u662f\u540c\u6b65\u590d\u5236\u4f1a\u589e\u5927\u6570\u636e\u5199\u5165\u5ef6\u8fdf\uff0c\u964d\u4f4e\u7cfb\u7edf\u541e\u5410\u91cf"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5f02\u6b65\u590d\u5236\u65b9\u5f0f\uff1a\u53ea\u8981 Master \u5199\u6210\u529f\uff0c\u5373\u53ef\u53cd\u9988\u7ed9\u5ba2\u6237\u7aef\u5199\u6210\u529f\u72b6\u6001\uff0c\u7cfb\u7edf\u62e5\u6709\u8f83\u4f4e\u7684\u5ef6\u8fdf\u548c\u8f83\u9ad8\u7684\u541e\u5410\u91cf\uff0c\u4f46\u662f\u5982\u679c Master \u51fa\u4e86\u6545\u969c\uff0c\u6709\u4e9b\u6570\u636e\u56e0\u4e3a\u6ca1\u6709\u88ab\u5199\u5165 Slave\uff0c\u6709\u53ef\u80fd\u4f1a\u4e22\u5931"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u540c\u6b65\u590d\u5236\u548c\u5f02\u6b65\u590d\u5236\u662f\u901a\u8fc7 Broker \u914d\u7f6e\u6587\u4ef6\u91cc\u7684 brokerRole \u53c2\u6570\u8fdb\u884c\u8bbe\u7f6e\u7684\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u6210 ASYNC_MASTE\u3001RSYNC_MASTER\u3001SLAVE \u4e09\u4e2a\u503c\u4e2d\u7684\u4e00\u4e2a"}),"\n",(0,l.jsx)(n.p,{children:"\u4e00\u822c\u628a\u5237\u76d8\u673a\u5236\u914d\u7f6e\u6210 ASYNC_FLUSH\uff0c\u4e3b\u4ece\u590d\u5236\u4e3a SYNC_MASTER\uff0c\u8fd9\u6837\u5373\u4f7f\u6709\u4e00\u53f0\u673a\u5668\u51fa\u6545\u969c\uff0c\u4ecd\u7136\u80fd\u4fdd\u8bc1\u6570\u636e\u4e0d\u4e22"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u652f\u6301\u6d88\u606f\u7684\u9ad8\u53ef\u9760\uff0c\u5f71\u54cd\u6d88\u606f\u53ef\u9760\u6027\u7684\u51e0\u79cd\u60c5\u51b5\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Broker \u975e\u6b63\u5e38\u5173\u95ed"}),"\n",(0,l.jsx)(n.li,{children:"Broker \u5f02\u5e38 Crash"}),"\n",(0,l.jsx)(n.li,{children:"OS Crash"}),"\n",(0,l.jsx)(n.li,{children:"\u673a\u5668\u6389\u7535\uff0c\u4f46\u662f\u80fd\u7acb\u5373\u6062\u590d\u4f9b\u7535\u60c5\u51b5"}),"\n",(0,l.jsx)(n.li,{children:"\u673a\u5668\u65e0\u6cd5\u5f00\u673a\uff08\u53ef\u80fd\u662f CPU\u3001\u4e3b\u677f\u3001\u5185\u5b58\u7b49\u5173\u952e\u8bbe\u5907\u635f\u574f\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u78c1\u76d8\u8bbe\u5907\u635f\u574f"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u524d\u56db\u79cd\u60c5\u51b5\u90fd\u5c5e\u4e8e\u786c\u4ef6\u8d44\u6e90\u53ef\u7acb\u5373\u6062\u590d\u60c5\u51b5\uff0cRocketMQ \u5728\u8fd9\u56db\u79cd\u60c5\u51b5\u4e0b\u80fd\u4fdd\u8bc1\u6d88\u606f\u4e0d\u4e22\uff0c\u6216\u8005\u4e22\u5931\u5c11\u91cf\u6570\u636e\uff08\u4f9d\u8d56\u5237\u76d8\u65b9\u5f0f\uff09"}),"\n",(0,l.jsxs)(n.p,{children:["\u540e\u4e24\u79cd\u5c5e\u4e8e\u5355\u70b9\u6545\u969c\uff0c\u4e14\u65e0\u6cd5\u6062\u590d\uff0c\u4e00\u65e6\u53d1\u751f\uff0c\u5728\u6b64\u5355\u70b9\u4e0a\u7684\u6d88\u606f\u5168\u90e8\u4e22\u5931\u3002RocketMQ \u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7\u4e3b\u4ece\u5f02\u6b65\u590d\u5236\uff0c\u53ef\u4fdd\u8bc1 99% \u7684\u6d88\u606f\u4e0d\u4e22\uff0c\u4f46\u662f\u4ecd\u7136\u4f1a\u6709\u6781\u5c11\u91cf\u7684\u6d88\u606f\u53ef\u80fd\u4e22\u5931\u3002\u901a\u8fc7",(0,l.jsx)(n.strong,{children:"\u540c\u6b65\u53cc\u5199\u6280\u672f"}),"\u53ef\u4ee5\u5b8c\u5168\u907f\u514d\u5355\u70b9\uff0c\u4f46\u662f\u4f1a\u5f71\u54cd\u6027\u80fd\uff0c\u9002\u5408\u5bf9\u6d88\u606f\u53ef\u9760\u6027\u8981\u6c42\u6781\u9ad8\u7684\u573a\u5408\uff0cRocketMQ \u4ece 3.0 \u7248\u672c\u5f00\u59cb\u652f\u6301\u540c\u6b65\u53cc\u5199"]}),"\n",(0,l.jsx)(n.p,{children:"\u4e00\u822c\u800c\u8a00\uff0c\u6211\u4eec\u4f1a\u5efa\u8bae\u91c7\u53d6\u540c\u6b65\u53cc\u5199 + \u5f02\u6b65\u5237\u76d8\u7684\u65b9\u5f0f\uff0c\u5728\u6d88\u606f\u7684\u53ef\u9760\u6027\u548c\u6027\u80fd\u95f4\u6709\u4e00\u4e2a\u8f83\u597d\u7684\u5e73\u8861"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u8d1f\u8f7d\u5747\u8861",children:"\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsx)(n.h4,{id:"\u751f\u4ea7\u7aef",children:"\u751f\u4ea7\u7aef"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u53ef\u4ee5\u5206\u4e3a Producer \u7aef\u53d1\u9001\u6d88\u606f\u65f6\u5019\u7684\u8d1f\u8f7d\u5747\u8861\u548c Consumer \u7aef\u8ba2\u9605\u6d88\u606f\u7684\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsxs)(n.p,{children:["Producer \u7aef\u5728\u53d1\u9001\u6d88\u606f\u65f6\uff0c\u4f1a\u5148\u6839\u636e Topic \u627e\u5230\u6307\u5b9a\u7684 TopicPublishInfo\uff0c\u5728\u83b7\u53d6\u4e86 TopicPublishInfo \u8def\u7531\u4fe1\u606f\u540e\uff0cRocketMQ \u7684\u5ba2\u6237\u7aef\u5728\u9ed8\u8ba4\u65b9\u5f0f\u8c03\u7528 ",(0,l.jsx)(n.code,{children:"selectOneMessageQueue()"})," \u65b9\u6cd5\u4ece TopicPublishInfo \u4e2d\u7684 messageQueueList \u4e2d\u9009\u62e9\u4e00\u4e2a\u961f\u5217 MessageQueue \u8fdb\u884c\u53d1\u9001\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:["\u9ed8\u8ba4\u4f1a",(0,l.jsx)(n.strong,{children:"\u8f6e\u8be2\u6240\u6709\u7684 Message Queue \u53d1\u9001"}),"\uff0c\u4ee5\u8ba9\u6d88\u606f\u5e73\u5747\u843d\u5728\u4e0d\u540c\u7684 queue \u4e0a\uff0c\u800c\u7531\u4e8e queue\u53ef\u4ee5\u6563\u843d\u5728\u4e0d\u540c\u7684 Broker\uff0c\u6240\u4ee5\u6d88\u606f\u5c31\u53d1\u9001\u5230\u4e0d\u540c\u7684 Broker \u4e0b\uff0c\u56fe\u4e2d\u7bad\u5934\u7ebf\u6761\u4e0a\u7684\u6807\u53f7\u4ee3\u8868\u987a\u5e8f\uff0c\u53d1\u5e03\u65b9\u4f1a\u628a\u7b2c\u4e00\u6761\u6d88\u606f\u53d1\u9001\u81f3 Queue 0\uff0c\u7136\u540e\u7b2c\u4e8c\u6761\u6d88\u606f\u53d1\u9001\u81f3 Queue 1\uff0c\u4ee5\u6b64\u7c7b\u63a8\uff1a"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(8811).A+"",width:"727",height:"354"})}),"\n",(0,l.jsx)(n.p,{children:"\u5bb9\u9519\u7b56\u7565\u5747\u5728 MQFaultStrategy \u8fd9\u4e2a\u7c7b\u4e2d\u5b9a\u4e49\uff0c\u6709\u4e00\u4e2a sendLatencyFaultEnable \u5f00\u5173\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5982\u679c\u5f00\u542f\uff0c\u4f1a\u5728",(0,l.jsx)(n.strong,{children:"\u968f\u673a\uff08\u53ea\u6709\u521d\u59cb\u5316\u7d22\u5f15\u53d8\u91cf\u65f6\u624d\u968f\u673a\uff0c\u6b63\u5e38\u90fd\u662f\u9012\u589e\uff09\u9012\u589e\u53d6\u6a21"}),"\u7684\u57fa\u7840\u4e0a\uff0c\u518d\u8fc7\u6ee4\u6389 not available \u7684 Broker"]}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u5173\u95ed\uff0c\u91c7\u7528\u968f\u673a\u9012\u589e\u53d6\u6a21\u7684\u65b9\u5f0f\u9009\u62e9\u4e00\u4e2a\u961f\u5217\uff08MessageQueue\uff09\u6765\u53d1\u9001\u6d88\u606f"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"LatencyFaultTolerance \u673a\u5236\u662f\u5b9e\u73b0\u6d88\u606f\u53d1\u9001\u9ad8\u53ef\u7528\u7684\u6838\u5fc3\u5173\u952e\u6240\u5728\uff0c\u5bf9\u4e4b\u524d\u5931\u8d25\u7684\uff0c\u6309\u4e00\u5b9a\u7684\u65f6\u95f4\u505a\u9000\u907f\u3002\u4f8b\u5982\u4e0a\u6b21\u8bf7\u6c42\u7684 latency \u8d85\u8fc7 550Lms\uff0c\u5c31\u9000\u907f 3000Lms\uff1b\u8d85\u8fc7 1000L\uff0c\u5c31\u9000\u907f 60000L"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u6d88\u8d39\u7aef",children:"\u6d88\u8d39\u7aef"}),"\n",(0,l.jsx)(n.p,{children:"\u5728 RocketMQ \u4e2d\uff0cConsumer \u7aef\u7684\u4e24\u79cd\u6d88\u8d39\u6a21\u5f0f\uff08Push/Pull\uff09\u90fd\u662f\u57fa\u4e8e\u62c9\u6a21\u5f0f\u6765\u83b7\u53d6\u6d88\u606f\u7684\uff0c\u800c\u5728 Push \u6a21\u5f0f\u53ea\u662f\u5bf9 Pull \u6a21\u5f0f\u7684\u4e00\u79cd\u5c01\u88c5\uff0c\u5176\u672c\u8d28\u5b9e\u73b0\u4e3a\u6d88\u606f\u62c9\u53d6\u7ebf\u7a0b\u5728\u4ece\u670d\u52a1\u5668\u62c9\u53d6\u5230\u4e00\u6279\u6d88\u606f\uff0c\u63d0\u4ea4\u5230\u6d88\u606f\u6d88\u8d39\u7ebf\u7a0b\u6c60\u540e\uff0c\u53c8\u7ee7\u7eed\u5411\u670d\u52a1\u5668\u518d\u6b21\u5c1d\u8bd5\u62c9\u53d6\u6d88\u606f\uff0c\u5982\u679c\u672a\u62c9\u53d6\u5230\u6d88\u606f\uff0c\u5219\u5ef6\u8fdf\u4e00\u4e0b\u53c8\u7ee7\u7eed\u62c9\u53d6"}),"\n",(0,l.jsx)(n.p,{children:"\u5728\u4e24\u79cd\u57fa\u4e8e\u62c9\u6a21\u5f0f\u7684\u6d88\u8d39\u65b9\u5f0f\uff08Push/Pull\uff09\u4e2d\uff0c\u5747\u9700\u8981 Consumer \u7aef\u5728\u77e5\u9053\u4ece Broker \u7aef\u7684\u54ea\u4e00\u4e2a\u6d88\u606f\u961f\u5217\u4e2d\u53bb\u83b7\u53d6\u6d88\u606f\uff0c\u6240\u4ee5\u5728 Consumer \u7aef\u6765\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u5373 Broker \u7aef\u4e2d\u591a\u4e2a MessageQueue \u5206\u914d\u7ed9\u540c\u4e00\u4e2a Consumer Group \u4e2d\u7684\u54ea\u4e9b Consumer \u6d88\u8d39"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5e7f\u64ad\u6a21\u5f0f\u4e0b\u8981\u6c42\u4e00\u6761\u6d88\u606f\u9700\u8981\u6295\u9012\u5230\u4e00\u4e2a\u6d88\u8d39\u7ec4\u4e0b\u9762\u6240\u6709\u7684\u6d88\u8d39\u8005\u5b9e\u4f8b\uff0c\u6240\u4ee5\u4e0d\u5b58\u5728\u8d1f\u8f7d\u5747\u8861\uff0c\u5728\u5b9e\u73b0\u4e0a\uff0cConsumer \u5206\u914d queue \u65f6\uff0c\u6240\u6709 Consumer \u90fd\u5206\u5230\u6240\u6709\u7684 queue\u3002"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5728\u96c6\u7fa4\u6d88\u8d39\u6a21\u5f0f\u4e0b\uff0c\u6bcf\u6761\u6d88\u606f\u53ea\u9700\u8981\u6295\u9012\u5230\u8ba2\u9605\u8fd9\u4e2a Topic \u7684 Consumer Group \u4e0b\u7684\u4e00\u4e2a\u5b9e\u4f8b\u5373\u53ef\uff0cRocketMQ \u91c7\u7528\u4e3b\u52a8\u62c9\u53d6\u7684\u65b9\u5f0f\u62c9\u53d6\u5e76\u6d88\u8d39\u6d88\u606f\uff0c\u5728\u62c9\u53d6\u7684\u65f6\u5019\u9700\u8981\u660e\u786e\u6307\u5b9a\u62c9\u53d6\u54ea\u4e00\u6761 Message Queue"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u96c6\u7fa4\u6a21\u5f0f\u4e0b\uff0c\u6bcf\u5f53\u6d88\u8d39\u8005\u5b9e\u4f8b\u7684\u6570\u91cf\u6709\u53d8\u66f4\uff0c\u90fd\u4f1a\u89e6\u53d1\u4e00\u6b21\u6240\u6709\u5b9e\u4f8b\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u8fd9\u65f6\u5019\u4f1a\u6309\u7167 queue \u7684\u6570\u91cf\u548c\u5b9e\u4f8b\u7684\u6570\u91cf\u5e73\u5747\u5206\u914d queue \u7ed9\u6bcf\u4e2a\u5b9e\u4f8b\u3002\u9ed8\u8ba4\u7684\u5206\u914d\u7b97\u6cd5\u662f AllocateMessageQueueAveragely\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(15813).A+"",width:"1148",height:"267"})}),"\n",(0,l.jsx)(n.p,{children:"\u8fd8\u6709\u4e00\u79cd\u5e73\u5747\u7684\u7b97\u6cd5\u662f AllocateMessageQueueAveragelyByCircle\uff0c\u4ee5\u73af\u72b6\u8f6e\u6d41\u5747\u5206 queue \u7684\u5f62\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(96765).A+"",width:"1120",height:"219"})}),"\n",(0,l.jsxs)(n.p,{children:["\u96c6\u7fa4\u6a21\u5f0f\u4e0b\uff0c",(0,l.jsx)(n.strong,{children:"queue \u90fd\u662f\u53ea\u5141\u8bb8\u5206\u914d\u4e00\u4e2a\u5b9e\u4f8b"}),"\uff0c\u5982\u679c\u591a\u4e2a\u5b9e\u4f8b\u540c\u65f6\u6d88\u8d39\u4e00\u4e2a queue \u7684\u6d88\u606f\uff0c\u7531\u4e8e\u62c9\u53d6\u54ea\u4e9b\u6d88\u606f\u662f Consumer \u4e3b\u52a8\u63a7\u5236\u7684\uff0c\u4f1a\u5bfc\u81f4\u540c\u4e00\u4e2a\u6d88\u606f\u5728\u4e0d\u540c\u7684\u5b9e\u4f8b\u4e0b\u88ab\u6d88\u8d39\u591a\u6b21"]}),"\n",(0,l.jsxs)(n.p,{children:["\u901a\u8fc7\u589e\u52a0 Consumer \u5b9e\u4f8b\u53bb\u5206\u644a queue \u7684\u6d88\u8d39\uff0c\u53ef\u4ee5\u8d77\u5230\u6c34\u5e73\u6269\u5c55\u7684\u6d88\u8d39\u80fd\u529b\u7684\u4f5c\u7528\u3002\u800c\u5f53\u6709\u5b9e\u4f8b\u4e0b\u7ebf\u65f6\uff0c\u4f1a\u91cd\u65b0\u89e6\u53d1\u8d1f\u8f7d\u5747\u8861\uff0c\u8fd9\u65f6\u5019\u539f\u6765\u5206\u914d\u5230\u7684 queue \u5c06\u5206\u914d\u5230\u5176\u4ed6\u5b9e\u4f8b\u4e0a\u7ee7\u7eed\u6d88\u8d39\u3002\u4f46\u662f\u5982\u679c Consumer \u5b9e\u4f8b\u7684\u6570\u91cf\u6bd4 Message Queue \u7684\u603b\u6570\u91cf\u8fd8\u591a\u7684\u8bdd\uff0c\u591a\u51fa\u6765\u7684 Consumer \u5b9e\u4f8b\u5c06\u65e0\u6cd5\u5206\u5230 queue\uff0c\u4e5f\u5c31\u65e0\u6cd5\u6d88\u8d39\u5230\u6d88\u606f\uff0c\u4e5f\u5c31\u65e0\u6cd5\u8d77\u5230\u5206\u644a\u8d1f\u8f7d\u7684\u4f5c\u7528\u4e86\uff0c\u6240\u4ee5\u9700\u8981",(0,l.jsx)(n.strong,{children:"\u63a7\u5236\u8ba9 queue \u7684\u603b\u6570\u91cf\u5927\u4e8e\u7b49\u4e8e Consumer \u7684\u6570\u91cf"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u539f\u7406\u89e3\u6790-3",children:"\u539f\u7406\u89e3\u6790"}),"\n",(0,l.jsx)(n.p,{children:"\u5728 Consumer \u542f\u52a8\u540e\uff0c\u4f1a\u901a\u8fc7\u5b9a\u65f6\u4efb\u52a1\u4e0d\u65ad\u5730\u5411 RocketMQ \u96c6\u7fa4\u4e2d\u7684\u6240\u6709 Broker \u5b9e\u4f8b\u53d1\u9001\u5fc3\u8df3\u5305\u3002Broker \u7aef\u5728\u6536\u5230 Consumer \u7684\u5fc3\u8df3\u6d88\u606f\u540e\uff0c\u4f1a\u5c06\u5b83\u7ef4\u62a4\u5728 ConsumerManager \u7684\u672c\u5730\u7f13\u5b58\u53d8\u91cf consumerTable\uff0c\u540c\u65f6\u5e76\u5c06\u5c01\u88c5\u540e\u7684\u5ba2\u6237\u7aef\u7f51\u7edc\u901a\u9053\u4fe1\u606f\u4fdd\u5b58\u5728\u672c\u5730\u7f13\u5b58\u53d8\u91cf channelInfoTable \u4e2d\uff0c\u4e3a Consumer \u7aef\u7684\u8d1f\u8f7d\u5747\u8861\u63d0\u4f9b\u53ef\u4ee5\u4f9d\u636e\u7684\u5143\u6570\u636e\u4fe1\u606f"}),"\n",(0,l.jsxs)(n.p,{children:["Consumer \u7aef\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u7684\u6838\u5fc3\u7c7b ",(0,l.jsx)(n.strong,{children:"RebalanceImpl"})]}),"\n",(0,l.jsxs)(n.p,{children:["\u5728 Consumer \u5b9e\u4f8b\u7684\u542f\u52a8\u6d41\u7a0b\u4e2d\u7684\u4f1a\u542f\u52a8 MQClientInstance \u5b9e\u4f8b\uff0c\u5b8c\u6210\u8d1f\u8f7d\u5747\u8861\u670d\u52a1\u7ebf\u7a0b RebalanceService \u7684\u542f\u52a8\uff08",(0,l.jsx)(n.strong,{children:"\u6bcf\u9694 20s \u6267\u884c\u4e00\u6b21"}),"\u8d1f\u8f7d\u5747\u8861\uff09\uff0cRebalanceService \u7ebf\u7a0b\u7684 run() \u65b9\u6cd5\u6700\u7ec8\u8c03\u7528\u7684\u662f RebalanceImpl \u7c7b\u7684 rebalanceByTopic() \u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u662f\u5b9e\u73b0 Consumer \u7aef\u8d1f\u8f7d\u5747\u8861\u7684\u6838\u5fc3\u3002rebalanceByTopic() \u65b9\u6cd5\u4f1a\u6839\u636e\u5e7f\u64ad\u6a21\u5f0f\u8fd8\u662f\u96c6\u7fa4\u6a21\u5f0f\u505a\u4e0d\u540c\u7684\u903b\u8f91\u5904\u7406\u3002\u4e3b\u8981\u770b\u96c6\u7fa4\u6a21\u5f0f\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4ece rebalanceImpl \u5b9e\u4f8b\u7684\u672c\u5730\u7f13\u5b58\u53d8\u91cf topicSubscribeInfoTable \u4e2d\uff0c\u83b7\u53d6\u8be5 Topic \u4e3b\u9898\u4e0b\u7684\u6d88\u606f\u6d88\u8d39\u961f\u5217\u96c6\u5408 mqSet"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u6839\u636e Topic \u548c consumerGroup \u4e3a\u53c2\u6570\u8c03\u7528 ",(0,l.jsx)(n.code,{children:"mQClientFactory.findConsumerIdList()"})," \u65b9\u6cd5\u5411 Broker \u7aef\u53d1\u9001\u83b7\u53d6\u8be5\u6d88\u8d39\u7ec4\u4e0b\u6d88\u8d39\u8005 ID \u5217\u8868\u7684 RPC \u901a\u4fe1\u8bf7\u6c42\uff08Broker \u7aef\u57fa\u4e8e\u524d\u9762 Consumer \u7aef\u4e0a\u62a5\u7684\u5fc3\u8df3\u5305\u6570\u636e\u800c\u6784\u5efa\u7684 consumerTable \u505a\u51fa\u54cd\u5e94\u8fd4\u56de\uff0c\u4e1a\u52a1\u8bf7\u6c42\u7801 ",(0,l.jsx)(n.code,{children:"GET_CONSUMER_LIST_BY_GROUP"}),"\uff09"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5148\u5bf9 Topic \u4e0b\u7684\u6d88\u606f\u6d88\u8d39\u961f\u5217\u3001\u6d88\u8d39\u8005 ID \u6392\u5e8f\uff0c\u7136\u540e\u7528\u6d88\u606f\u961f\u5217\u5206\u914d\u7b56\u7565\u7b97\u6cd5\uff08\u9ed8\u8ba4\u662f\u6d88\u606f\u961f\u5217\u7684\u5e73\u5747\u5206\u914d\u7b97\u6cd5\uff09\uff0c\u8ba1\u7b97\u51fa\u5f85\u62c9\u53d6\u7684\u6d88\u606f\u961f\u5217\u3002\u5e73\u5747\u5206\u914d\u7b97\u6cd5\u7c7b\u4f3c\u4e8e\u5206\u9875\u7684\u7b97\u6cd5\uff0c\u5c06\u6240\u6709 MessageQueue \u6392\u597d\u5e8f\u7c7b\u4f3c\u4e8e\u8bb0\u5f55\uff0c\u5c06\u6240\u6709\u6d88\u8d39\u7aef Consumer \u6392\u597d\u5e8f\u7c7b\u4f3c\u9875\u6570\uff0c\u5e76\u6c42\u51fa\u6bcf\u4e00\u9875\u9700\u8981\u5305\u542b\u7684\u5e73\u5747 size \u548c\u6bcf\u4e2a\u9875\u9762\u8bb0\u5f55\u7684\u8303\u56f4 range\uff0c\u6700\u540e\u904d\u5386\u6574\u4e2a range \u800c\u8ba1\u7b97\u51fa\u5f53\u524d Consumer \u7aef\u5e94\u8be5\u5206\u914d\u5230\u7684\u8bb0\u5f55\uff08\u8fd9\u91cc\u5373\u4e3a MessageQueue\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8c03\u7528 updateProcessQueueTableInRebalance() \u65b9\u6cd5\uff0c\u5148\u5c06\u5206\u914d\u5230\u7684\u6d88\u606f\u961f\u5217\u96c6\u5408 mqSet \u4e0e processQueueTable \u505a\u4e00\u4e2a\u8fc7\u6ee4\u6bd4\u5bf9"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(62850).A+"",width:"833",height:"344"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"processQueueTable \u6807\u6ce8\u7684\u7ea2\u8272\u90e8\u5206\uff0c\u8868\u793a\u4e0e\u5206\u914d\u5230\u7684\u6d88\u606f\u961f\u5217\u96c6\u5408 mqSet \u4e92\u4e0d\u5305\u542b\uff0c\u5c06\u8fd9\u4e9b\u961f\u5217\u8bbe\u7f6e Dropped \u5c5e\u6027\u4e3a true\uff0c\u7136\u540e\u67e5\u770b\u8fd9\u4e9b\u961f\u5217\u662f\u5426\u53ef\u4ee5\u79fb\u9664\u51fa processQueueTable \u7f13\u5b58\u53d8\u91cf\u3002\u5177\u4f53\u6267\u884c removeUnnecessaryMessageQueue() \u65b9\u6cd5\uff0c\u5373\u6bcf\u9694 1s  \u67e5\u770b\u662f\u5426\u53ef\u4ee5\u83b7\u53d6\u5f53\u524d\u6d88\u8d39\u5904\u7406\u961f\u5217\u7684\u9501\uff0c\u62ff\u5230\u7684\u8bdd\u8fd4\u56de true\uff1b\u5982\u679c\u7b49\u5f85 1s \u540e\uff0c\u4ecd\u7136\u62ff\u4e0d\u5230\u5f53\u524d\u6d88\u8d39\u5904\u7406\u961f\u5217\u7684\u9501\u5219\u8fd4\u56de false\u3002\u5982\u679c\u8fd4\u56de true\uff0c\u5219\u4ece processQueueTable \u7f13\u5b58\u53d8\u91cf\u4e2d\u79fb\u9664\u5bf9\u5e94\u7684 Entry"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"processQueueTable \u7684\u7eff\u8272\u90e8\u5206\uff0c\u8868\u793a\u4e0e\u5206\u914d\u5230\u7684\u6d88\u606f\u961f\u5217\u96c6\u5408 mqSet \u7684\u4ea4\u96c6\uff0c\u5224\u65ad\u8be5 ProcessQueue \u662f\u5426\u5df2\u7ecf\u8fc7\u671f\u4e86\uff0c\u5728 Pull \u6a21\u5f0f\u7684\u4e0d\u7528\u7ba1\uff0c\u5982\u679c\u662f Push \u6a21\u5f0f\u7684\uff0c\u8bbe\u7f6e Dropped \u5c5e\u6027\u4e3a true\uff0c\u5e76\u4e14\u8c03\u7528 removeUnnecessaryMessageQueue() \u65b9\u6cd5\uff0c\u50cf\u4e0a\u9762\u4e00\u6837\u5c1d\u8bd5\u79fb\u9664 Entry"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u4e3a\u8fc7\u6ee4\u540e\u7684\u6d88\u606f\u961f\u5217\u96c6\u5408 mqSet \u4e2d\u6bcf\u4e2a MessageQueue \u521b\u5efa ProcessQueue \u5bf9\u8c61\u5b58\u5165 RebalanceImpl \u7684 processQueueTable \u961f\u5217\u4e2d\uff08\u5176\u4e2d\u8c03\u7528 RebalanceImpl \u5b9e\u4f8b\u7684 ",(0,l.jsx)(n.code,{children:"computePullFromWhere(MessageQueue mq)"})," \u65b9\u6cd5\u83b7\u53d6\u8be5 MessageQueue \u5bf9\u8c61\u7684\u4e0b\u4e00\u4e2a\u8fdb\u5ea6\u6d88\u8d39\u503c offset\uff0c\u968f\u540e\u586b\u5145\u81f3\u63a5\u4e0b\u6765\u8981\u521b\u5efa\u7684 pullRequest \u5bf9\u8c61\u5c5e\u6027\u4e2d\uff09\uff0c\u5e76",(0,l.jsx)(n.strong,{children:"\u521b\u5efa\u62c9\u53d6\u8bf7\u6c42\u5bf9\u8c61"})," pullRequest \u6dfb\u52a0\u5230\u62c9\u53d6\u5217\u8868 pullRequestList \u4e2d\uff0c\u6700\u540e\u6267\u884c dispatchPullRequest() \u65b9\u6cd5\uff0c\u5c06 Pull \u6d88\u606f\u7684\u8bf7\u6c42\u5bf9\u8c61 PullRequest \u653e\u5165 PullMessageService \u670d\u52a1\u7ebf\u7a0b\u7684",(0,l.jsx)(n.strong,{children:"\u963b\u585e\u961f\u5217"})," pullRequestQueue \u4e2d\uff0c\u5f85\u8be5\u670d\u52a1\u7ebf\u7a0b\u53d6\u51fa\u540e\u5411 Broker \u7aef\u53d1\u8d77 Pull \u6d88\u606f\u7684\u8bf7\u6c42"]}),"\n",(0,l.jsx)(n.p,{children:"\u5bf9\u6bd4\u4e0b RebalancePushImpl \u548c RebalancePullImpl \u4e24\u4e2a\u5b9e\u73b0\u7c7b\u7684 dispatchPullRequest() \u65b9\u6cd5\uff0cRebalancePullImpl \u7c7b\u91cc\u9762\u7684\u8be5\u65b9\u6cd5\u4e3a\u7a7a"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u6d88\u606f\u6d88\u8d39\u961f\u5217\u5728",(0,l.jsx)(n.strong,{children:"\u540c\u4e00\u6d88\u8d39\u7ec4\u4e0d\u540c\u6d88\u8d39\u8005\u4e4b\u95f4\u7684\u8d1f\u8f7d\u5747\u8861"}),"\uff0c\u5176\u6838\u5fc3\u8bbe\u8ba1\u7406\u5ff5\u662f\u5728",(0,l.jsx)(n.strong,{children:"\u4e00\u4e2a\u6d88\u606f\u6d88\u8d39\u961f\u5217\u5728\u540c\u4e00\u65f6\u95f4\u53ea\u5141\u8bb8\u88ab\u540c\u4e00\u6d88\u8d39\u7ec4\u5185\u7684\u4e00\u4e2a\u6d88\u8d39\u8005\u6d88\u8d39\uff0c\u4e00\u4e2a\u6d88\u606f\u6d88\u8d39\u8005\u80fd\u540c\u65f6\u6d88\u8d39\u591a\u4e2a\u6d88\u606f\u961f\u5217"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6d88\u606f\u67e5\u8be2",children:"\u6d88\u606f\u67e5\u8be2"}),"\n",(0,l.jsx)(n.h4,{id:"\u67e5\u8be2\u65b9\u5f0f",children:"\u67e5\u8be2\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u652f\u6301\u6309\u7167\u4e24\u79cd\u7ef4\u5ea6\u8fdb\u884c\u6d88\u606f\u67e5\u8be2\uff1a\u6309\u7167 Message ID \u67e5\u8be2\u6d88\u606f\u3001\u6309\u7167 Message Key \u67e5\u8be2\u6d88\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"RocketMQ \u4e2d\u7684 MessageID \u7684\u957f\u5ea6\u603b\u5171\u6709 16 \u5b57\u8282\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u6d88\u606f\u5b58\u50a8\u4e3b\u673a\u5730\u5740\uff08IP \u5730\u5740\u548c\u7aef\u53e3\uff09\uff0c\u6d88\u606f Commit Log offset"}),"\n",(0,l.jsx)(n.p,{children:"\u5b9e\u73b0\u65b9\u5f0f\uff1aClient \u7aef\u4ece MessageID \u4e2d\u89e3\u6790\u51fa Broker \u7684\u5730\u5740\uff08IP \u5730\u5740\u548c\u7aef\u53e3\uff09\u548c Commit Log \u7684\u504f\u79fb\u5730\u5740\uff0c\u5c01\u88c5\u6210\u4e00\u4e2a RPC \u8bf7\u6c42\u540e\u901a\u8fc7 Remoting \u901a\u4fe1\u5c42\u53d1\u9001\uff08\u4e1a\u52a1\u8bf7\u6c42\u7801 VIEW_MESSAGE_BY_ID\uff09\u3002Broker \u7aef\u8d70\u7684\u662f QueryMessageProcessor\uff0c\u8bfb\u53d6\u6d88\u606f\u7684\u8fc7\u7a0b\u7528\u5176\u4e2d\u7684 CommitLog \u7684 offset \u548c size \u53bb CommitLog \u4e2d\u627e\u5230\u771f\u6b63\u7684\u8bb0\u5f55\u5e76\u89e3\u6790\u6210\u4e00\u4e2a\u5b8c\u6574\u7684\u6d88\u606f\u8fd4\u56de"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6309\u7167 Message Key \u67e5\u8be2\u6d88\u606f\uff0cIndexFile \u7d22\u5f15\u6587\u4ef6\u4e3a\u63d0\u4f9b\u4e86\u901a\u8fc7 Message Key \u67e5\u8be2\u6d88\u606f\u7684\u670d\u52a1"}),"\n",(0,l.jsxs)(n.p,{children:["\u5b9e\u73b0\u65b9\u5f0f\uff1a\u901a\u8fc7 Broker \u7aef\u7684 QueryMessageProcessor \u4e1a\u52a1\u5904\u7406\u5668\u6765\u67e5\u8be2\uff0c\u8bfb\u53d6\u6d88\u606f\u7684\u8fc7\u7a0b\u7528 ",(0,l.jsx)(n.strong,{children:"Topic \u548c Key"})," \u627e\u5230 IndexFile \u7d22\u5f15\u6587\u4ef6\u4e2d\u7684\u4e00\u6761\u8bb0\u5f55\uff0c\u6839\u636e\u5176\u4e2d\u7684 CommitLog Offset \u4ece CommitLog \u6587\u4ef6\u4e2d\u8bfb\u53d6\u6d88\u606f\u7684\u5b9e\u4f53\u5185\u5bb9"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u7d22\u5f15\u673a\u5236",children:"\u7d22\u5f15\u673a\u5236"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u7684\u7d22\u5f15\u6587\u4ef6\u903b\u8f91\u7ed3\u6784\uff0c\u7c7b\u4f3c JDK \u4e2d HashMap \u7684\u5b9e\u73b0\uff0c\u5177\u4f53\u7ed3\u6784\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(95119).A+"",width:"718",height:"470"})}),"\n",(0,l.jsxs)(n.p,{children:["IndexFile \u6587\u4ef6\u7684\u5b58\u50a8\u5728 ",(0,l.jsx)(n.code,{children:"$HOME\\store\\index${fileName}"}),"\uff0c\u6587\u4ef6\u540d fileName \u662f\u4ee5\u521b\u5efa\u65f6\u7684\u65f6\u95f4\u6233\u547d\u540d\uff0c\u6587\u4ef6\u5927\u5c0f\u662f\u56fa\u5b9a\u7684\uff0c\u7b49\u4e8e ",(0,l.jsx)(n.code,{children:"40+500W*4+2000W*20= 420000040"})," \u4e2a\u5b57\u8282\u5927\u5c0f\u3002\u5982\u679c\u6d88\u606f\u7684 properties \u4e2d\u8bbe\u7f6e\u4e86 UNIQ_KEY \u8fd9\u4e2a\u5c5e\u6027\uff0c\u5c31\u7528 ",(0,l.jsx)(n.code,{children:"topic + \u201c#\u201d + UNIQ_KEY"})," \u4f5c\u4e3a key \u6765\u505a\u5199\u5165\u64cd\u4f5c\uff1b\u5982\u679c\u6d88\u606f\u8bbe\u7f6e\u4e86 KEYS \u5c5e\u6027\uff08\u591a\u4e2a KEY \u4ee5\u7a7a\u683c\u5206\u9694\uff09\uff0c\u4e5f\u4f1a\u7528 ",(0,l.jsx)(n.code,{children:"topic + \u201c#\u201d + KEY"})," \u6765\u505a\u7d22\u5f15"]}),"\n",(0,l.jsxs)(n.p,{children:["\u6574\u4e2a Index File \u7684\u7ed3\u6784\u5982\u56fe\uff0c40 Byte \u7684 Header \u7528\u4e8e\u4fdd\u5b58\u4e00\u4e9b\u603b\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c",(0,l.jsx)(n.code,{children:"4*500W"})," \u7684 Slot Table \u5e76\u4e0d\u4fdd\u5b58\u771f\u6b63\u7684\u7d22\u5f15\u6570\u636e\uff0c\u800c\u662f\u4fdd\u5b58\u6bcf\u4e2a\u69fd\u4f4d\u5bf9\u5e94\u7684\u5355\u5411\u94fe\u8868\u7684",(0,l.jsx)(n.strong,{children:"\u5934\u6307\u9488"}),"\uff0c\u5373\u4e00\u4e2a Index File \u53ef\u4ee5\u4fdd\u5b58 2000W \u4e2a\u7d22\u5f15\uff0c",(0,l.jsx)(n.code,{children:"20*2000W"})," \u662f",(0,l.jsx)(n.strong,{children:"\u771f\u6b63\u7684\u7d22\u5f15\u6570\u636e"})]}),"\n",(0,l.jsx)(n.p,{children:"\u7d22\u5f15\u6570\u636e\u5305\u542b\u4e86 Key Hash/CommitLog Offset/Timestamp/NextIndex offset \u8fd9\u56db\u4e2a\u5b57\u6bb5\uff0c\u4e00\u5171 20 Byte"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"NextIndex offset \u5373\u524d\u9762\u8bfb\u51fa\u6765\u7684 slotValue\uff0c\u5982\u679c\u6709 hash \u51b2\u7a81\uff0c\u5c31\u53ef\u4ee5\u7528\u8fd9\u4e2a\u5b57\u6bb5\u5c06\u6240\u6709\u51b2\u7a81\u7684\u7d22\u5f15\u7528\u94fe\u8868\u7684\u65b9\u5f0f\u4e32\u8d77\u6765"}),"\n",(0,l.jsx)(n.li,{children:"Timestamp \u8bb0\u5f55\u7684\u662f\u6d88\u606f storeTimestamp \u4e4b\u95f4\u7684\u5dee\uff0c\u5e76\u4e0d\u662f\u4e00\u4e2a\u7edd\u5bf9\u7684\u65f6\u95f4"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u6587\u6863\uff1a",(0,l.jsx)(n.a,{href:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md",children:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6d88\u606f\u91cd\u8bd5",children:"\u6d88\u606f\u91cd\u8bd5"}),"\n",(0,l.jsx)(n.h4,{id:"\u6d88\u606f\u91cd\u6295",children:"\u6d88\u606f\u91cd\u6295"}),"\n",(0,l.jsx)(n.p,{children:"\u751f\u4ea7\u8005\u5728\u53d1\u9001\u6d88\u606f\u65f6\uff0c\u540c\u6b65\u6d88\u606f\u548c\u5f02\u6b65\u6d88\u606f\u5931\u8d25\u4f1a\u91cd\u6295\uff0coneway \u6ca1\u6709\u4efb\u4f55\u4fdd\u8bc1\u3002\u6d88\u606f\u91cd\u6295\u4fdd\u8bc1\u6d88\u606f\u5c3d\u53ef\u80fd\u53d1\u9001\u6210\u529f\u3001\u4e0d\u4e22\u5931\uff0c\u4f46\u5f53\u51fa\u73b0\u6d88\u606f\u91cf\u5927\u3001\u7f51\u7edc\u6296\u52a8\u65f6\uff0c\u53ef\u80fd\u4f1a\u9020\u6210\u6d88\u606f\u91cd\u590d\uff1b\u751f\u4ea7\u8005\u4e3b\u52a8\u91cd\u53d1\u3001Consumer \u8d1f\u8f7d\u53d8\u5316\u4e5f\u4f1a\u5bfc\u81f4\u91cd\u590d\u6d88\u606f"}),"\n",(0,l.jsx)(n.p,{children:"\u5982\u4e0b\u65b9\u6cd5\u53ef\u4ee5\u8bbe\u7f6e\u6d88\u606f\u91cd\u6295\u7b56\u7565\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["retryTimesWhenSendFailed\uff1a\u540c\u6b65\u53d1\u9001\u5931\u8d25\u91cd\u6295\u6b21\u6570\uff0c\u9ed8\u8ba4\u4e3a 2\uff0c\u56e0\u6b64\u751f\u4ea7\u8005\u4f1a\u6700\u591a\u5c1d\u8bd5\u53d1\u9001 retryTimesWhenSendFailed + 1 \u6b21\u3002\u4e0d\u4f1a\u9009\u62e9\u4e0a\u6b21\u5931\u8d25\u7684 Broker\uff0c\u5c1d\u8bd5\u5411\u5176\u4ed6 Broker \u53d1\u9001\uff0c",(0,l.jsx)(n.strong,{children:"\u6700\u5927\u7a0b\u5ea6\u4fdd\u8bc1\u6d88\u606f\u4e0d\u4e22"}),"\u3002\u8d85\u8fc7\u91cd\u6295\u6b21\u6570\u629b\u51fa\u5f02\u5e38\uff0c\u7531\u5ba2\u6237\u7aef\u4fdd\u8bc1\u6d88\u606f\u4e0d\u4e22\u3002\u5f53\u51fa\u73b0 RemotingException\u3001MQClientException \u548c\u90e8\u5206 MQBrokerException \u65f6\u4f1a\u91cd\u6295"]}),"\n",(0,l.jsxs)(n.li,{children:["retryTimesWhenSendAsyncFailed\uff1a\u5f02\u6b65\u53d1\u9001\u5931\u8d25\u91cd\u8bd5\u6b21\u6570\uff0c\u5f02\u6b65\u91cd\u8bd5\u4e0d\u4f1a\u9009\u62e9\u5176\u4ed6 Broker\uff0c\u4ec5\u5728\u540c\u4e00\u4e2a Broker \u4e0a\u505a\u91cd\u8bd5\uff0c",(0,l.jsx)(n.strong,{children:"\u4e0d\u4fdd\u8bc1\u6d88\u606f\u4e0d\u4e22"})]}),"\n",(0,l.jsx)(n.li,{children:"retryAnotherBrokerWhenNotStoreOK\uff1a\u6d88\u606f\u5237\u76d8\uff08\u4e3b\u6216\u5907\uff09\u8d85\u65f6\u6216 slave \u4e0d\u53ef\u7528\uff08\u8fd4\u56de\u72b6\u6001\u975e SEND_OK\uff09\uff0c\u662f\u5426\u5c1d\u8bd5\u53d1\u9001\u5230\u5176\u4ed6  Broker\uff0c\u9ed8\u8ba4 false\uff0c\u5341\u5206\u91cd\u8981\u6d88\u606f\u53ef\u4ee5\u5f00\u542f"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\u70b9\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5982\u679c\u540c\u6b65\u6a21\u5f0f\u53d1\u9001\u5931\u8d25\uff0c\u5219\u9009\u62e9\u5230\u4e0b\u4e00\u4e2a Broker\uff0c\u5982\u679c\u5f02\u6b65\u6a21\u5f0f\u53d1\u9001\u5931\u8d25\uff0c\u5219",(0,l.jsx)(n.strong,{children:"\u53ea\u4f1a\u5728\u5f53\u524d Broker \u8fdb\u884c\u91cd\u8bd5"})]}),"\n",(0,l.jsx)(n.li,{children:"\u53d1\u9001\u6d88\u606f\u8d85\u65f6\u65f6\u95f4\u9ed8\u8ba4 3000 \u6beb\u79d2\uff0c\u5c31\u4e0d\u4f1a\u518d\u5c1d\u8bd5\u91cd\u8bd5"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u6d88\u606f\u91cd\u8bd5-1",children:"\u6d88\u606f\u91cd\u8bd5"}),"\n",(0,l.jsx)(n.p,{children:"Consumer \u6d88\u8d39\u6d88\u606f\u5931\u8d25\u540e\uff0c\u63d0\u4f9b\u4e86\u4e00\u79cd\u91cd\u8bd5\u673a\u5236\uff0c\u4ee4\u6d88\u606f\u518d\u6d88\u8d39\u4e00\u6b21\u3002Consumer \u6d88\u8d39\u6d88\u606f\u5931\u8d25\u53ef\u4ee5\u8ba4\u4e3a\u6709\u4ee5\u4e0b\u51e0\u79cd\u60c5\u51b5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7531\u4e8e\u6d88\u606f\u672c\u8eab\u7684\u539f\u56e0\uff0c\u4f8b\u5982\u53cd\u5e8f\u5217\u5316\u5931\u8d25\uff0c\u6d88\u606f\u6570\u636e\u672c\u8eab\u65e0\u6cd5\u5904\u7406\u7b49\u3002\u8fd9\u79cd\u9519\u8bef\u901a\u5e38\u9700\u8981\u8df3\u8fc7\u8fd9\u6761\u6d88\u606f\uff0c\u518d\u6d88\u8d39\u5176\u5b83\u6d88\u606f\uff0c\u800c\u8fd9\u6761\u5931\u8d25\u7684\u6d88\u606f\u5373\u4f7f\u7acb\u523b\u91cd\u8bd5\u6d88\u8d39\uff0c99% \u4e5f\u4e0d\u6210\u529f\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u4f9b\u4e00\u79cd\u5b9a\u65f6\u91cd\u8bd5\u673a\u5236\uff0c\u5373\u8fc7 10 \u79d2\u540e\u518d\u91cd\u8bd5"}),"\n",(0,l.jsx)(n.li,{children:"\u7531\u4e8e\u4f9d\u8d56\u7684\u4e0b\u6e38\u5e94\u7528\u670d\u52a1\u4e0d\u53ef\u7528\uff0c\u4f8b\u5982 DB \u8fde\u63a5\u4e0d\u53ef\u7528\uff0c\u5916\u7cfb\u7edf\u7f51\u7edc\u4e0d\u53ef\u8fbe\u7b49\u3002\u8fd9\u79cd\u60c5\u51b5\u5373\u4f7f\u8df3\u8fc7\u5f53\u524d\u5931\u8d25\u7684\u6d88\u606f\uff0c\u6d88\u8d39\u5176\u4ed6\u6d88\u606f\u540c\u6837\u4e5f\u4f1a\u62a5\u9519\uff0c\u8fd9\u79cd\u60c5\u51b5\u5efa\u8bae\u5e94\u7528 sleep 30s\uff0c\u518d\u6d88\u8d39\u4e0b\u4e00\u6761\u6d88\u606f\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u8f7b Broker \u91cd\u8bd5\u6d88\u606f\u7684\u538b\u529b"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["RocketMQ \u4f1a\u4e3a\u6bcf\u4e2a\u6d88\u8d39\u7ec4\u90fd\u8bbe\u7f6e\u4e00\u4e2a Topic \u540d\u79f0\u4e3a ",(0,l.jsx)(n.code,{children:"%RETRY%+consumerGroup"})," \u7684\u91cd\u8bd5\u961f\u5217\uff08\u8fd9\u4e2a Topic \u7684\u91cd\u8bd5\u961f\u5217\u662f",(0,l.jsx)(n.strong,{children:"\u9488\u5bf9\u6d88\u8d39\u7ec4"}),"\uff0c\u800c\u4e0d\u662f\u9488\u5bf9\u6bcf\u4e2a Topic \u8bbe\u7f6e\u7684\uff09\uff0c\u7528\u4e8e\u6682\u65f6\u4fdd\u5b58\u56e0\u4e3a\u5404\u79cd\u5f02\u5e38\u800c\u5bfc\u81f4 Consumer \u7aef\u65e0\u6cd5\u6d88\u8d39\u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u987a\u5e8f\u6d88\u606f\u7684\u91cd\u8bd5\uff0c\u5f53\u6d88\u8d39\u8005\u6d88\u8d39\u6d88\u606f\u5931\u8d25\u540e\uff0c\u6d88\u606f\u961f\u5217 RocketMQ \u4f1a\u81ea\u52a8\u4e0d\u65ad\u8fdb\u884c\u6d88\u606f\u91cd\u8bd5\uff08\u6bcf\u6b21\u95f4\u9694\u65f6\u95f4\u4e3a 1 \u79d2\uff09\uff0c\u8fd9\u65f6\u5e94\u7528\u4f1a\u51fa\u73b0\u6d88\u606f\u6d88\u8d39\u88ab\u963b\u585e\u7684\u60c5\u51b5\u3002\u6240\u4ee5\u5728\u4f7f\u7528\u987a\u5e8f\u6d88\u606f\u65f6\uff0c\u5fc5\u987b\u4fdd\u8bc1\u5e94\u7528\u80fd\u591f\u53ca\u65f6\u76d1\u63a7\u5e76\u5904\u7406\u6d88\u8d39\u5931\u8d25\u7684\u60c5\u51b5\uff0c\u907f\u514d\u963b\u585e\u73b0\u8c61\u7684\u53d1\u751f"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u65e0\u5e8f\u6d88\u606f\uff08\u666e\u901a\u3001\u5b9a\u65f6\u3001\u5ef6\u65f6\u3001\u4e8b\u52a1\u6d88\u606f\uff09\u7684\u91cd\u8bd5\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u8fd4\u56de\u72b6\u6001\u8fbe\u5230\u6d88\u606f\u91cd\u8bd5\u7684\u7ed3\u679c\u3002\u65e0\u5e8f\u6d88\u606f\u7684\u91cd\u8bd5\u53ea\u9488\u5bf9\u96c6\u7fa4\u6d88\u8d39\u65b9\u5f0f\u751f\u6548\uff0c\u5e7f\u64ad\u65b9\u5f0f\u4e0d\u63d0\u4f9b\u5931\u8d25\u91cd\u8bd5\u7279\u6027\uff0c\u5373\u6d88\u8d39\u5931\u8d25\u540e\uff0c\u5931\u8d25\u6d88\u606f\u4e0d\u518d\u91cd\u8bd5\uff0c\u7ee7\u7eed\u6d88\u8d39\u65b0\u7684\u6d88\u606f"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u65e0\u5e8f\u6d88\u606f\u60c5\u51b5\u4e0b"}),"\uff0c\u56e0\u4e3a\u5f02\u5e38\u6062\u590d\u9700\u8981\u4e00\u4e9b\u65f6\u95f4\uff0c\u4f1a\u4e3a\u91cd\u8bd5\u961f\u5217\u8bbe\u7f6e\u591a\u4e2a\u91cd\u8bd5\u7ea7\u522b\uff0c\u6bcf\u4e2a\u91cd\u8bd5\u7ea7\u522b\u90fd\u6709\u5bf9\u5e94\u7684\u91cd\u65b0\u6295\u9012\u5ef6\u65f6\uff0c\u91cd\u8bd5\u6b21\u6570\u8d8a\u591a\u6295\u9012\u5ef6\u65f6\u5c31\u8d8a\u5927\u3002RocketMQ \u5bf9\u4e8e\u91cd\u8bd5\u6d88\u606f\u7684\u5904\u7406\u662f\u5148\u4fdd\u5b58\u81f3 Topic \u540d\u79f0\u4e3a ",(0,l.jsx)(n.code,{children:"SCHEDULE_TOPIC_XXXX"})," \u7684\u5ef6\u8fdf\u961f\u5217\u4e2d\uff0c\u540e\u53f0\u5b9a\u65f6\u4efb\u52a1",(0,l.jsx)(n.strong,{children:"\u6309\u7167\u5bf9\u5e94\u7684\u65f6\u95f4\u8fdb\u884c Delay \u540e"}),"\u91cd\u65b0\u4fdd\u5b58\u81f3 ",(0,l.jsx)(n.code,{children:"%RETRY%+consumerGroup"})," \u7684\u91cd\u8bd5\u961f\u5217\u4e2d"]}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u961f\u5217 RocketMQ \u9ed8\u8ba4\u5141\u8bb8\u6bcf\u6761\u6d88\u606f\u6700\u591a\u91cd\u8bd5 16 \u6b21\uff0c\u6bcf\u6b21\u91cd\u8bd5\u7684\u95f4\u9694\u65f6\u95f4\u5982\u4e0b\u8868\u793a\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{style:{textAlign:"center"},children:"\u7b2c\u51e0\u6b21\u91cd\u8bd5"}),(0,l.jsx)(n.th,{style:{textAlign:"center"},children:"\u4e0e\u4e0a\u6b21\u91cd\u8bd5\u7684\u95f4\u9694\u65f6\u95f4"}),(0,l.jsx)(n.th,{style:{textAlign:"center"},children:"\u7b2c\u51e0\u6b21\u91cd\u8bd5"}),(0,l.jsx)(n.th,{style:{textAlign:"center"},children:"\u4e0e\u4e0a\u6b21\u91cd\u8bd5\u7684\u95f4\u9694\u65f6\u95f4"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"1"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"10 \u79d2"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"9"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"7 \u5206\u949f"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"2"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"30 \u79d2"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"10"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"8 \u5206\u949f"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"3"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"1 \u5206\u949f"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"11"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"9 \u5206\u949f"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"4"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"2 \u5206\u949f"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"12"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"10 \u5206\u949f"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"5"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"3 \u5206\u949f"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"13"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"20 \u5206\u949f"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"6"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"4 \u5206\u949f"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"14"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"30 \u5206\u949f"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"7"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"5 \u5206\u949f"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"15"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"1 \u5c0f\u65f6"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"8"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"6 \u5206\u949f"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"16"}),(0,l.jsx)(n.td,{style:{textAlign:"center"},children:"2 \u5c0f\u65f6"})]})]})]}),"\n",(0,l.jsxs)(n.p,{children:["\u5982\u679c\u6d88\u606f\u91cd\u8bd5 16 \u6b21\u540e\u4ecd\u7136\u5931\u8d25\uff0c\u6d88\u606f\u5c06",(0,l.jsx)(n.strong,{children:"\u4e0d\u518d\u6295\u9012"}),"\uff0c\u5982\u679c\u4e25\u683c\u6309\u7167\u4e0a\u8ff0\u91cd\u8bd5\u65f6\u95f4\u95f4\u9694\u8ba1\u7b97\uff0c\u67d0\u6761\u6d88\u606f\u5728\u4e00\u76f4\u6d88\u8d39\u5931\u8d25\u7684\u524d\u63d0\u4e0b\uff0c\u5c06\u4f1a\u5728\u63a5\u4e0b\u6765\u7684 4 \u5c0f\u65f6 46 \u5206\u949f\u4e4b\u5185\u8fdb\u884c 16 \u6b21\u91cd\u8bd5\uff0c\u8d85\u8fc7\u8fd9\u4e2a\u65f6\u95f4\u8303\u56f4\u6d88\u606f\u5c06\u4e0d\u518d\u91cd\u8bd5\u6295\u9012"]}),"\n",(0,l.jsxs)(n.p,{children:["\u65f6\u95f4\u95f4\u9694\u4e0d\u652f\u6301\u81ea\u5b9a\u4e49\u914d\u7f6e\uff0c\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u53ef\u901a\u8fc7\u81ea\u5b9a\u4e49\u53c2\u6570 ",(0,l.jsx)(n.code,{children:"MaxReconsumeTimes"})," \u53d6\u503c\u8fdb\u884c\u914d\u7f6e\uff0c\u82e5\u914d\u7f6e\u8d85\u8fc7 16 \u6b21\uff0c\u5219\u8d85\u8fc7\u7684\u95f4\u9694\u65f6\u95f4\u5747\u4e3a 2 \u5c0f\u65f6"]}),"\n",(0,l.jsxs)(n.p,{children:["\u8bf4\u660e\uff1a\u4e00\u6761\u6d88\u606f\u65e0\u8bba\u91cd\u8bd5\u591a\u5c11\u6b21\uff0c",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u7684 Message ID \u662f\u4e0d\u4f1a\u6539\u53d8\u7684"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u91cd\u8bd5\u64cd\u4f5c",children:"\u91cd\u8bd5\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:"\u96c6\u7fa4\u6d88\u8d39\u65b9\u5f0f\u4e0b\uff0c\u6d88\u606f\u6d88\u8d39\u5931\u8d25\u540e\u671f\u671b\u6d88\u606f\u91cd\u8bd5\uff0c\u9700\u8981\u5728\u6d88\u606f\u76d1\u542c\u5668\u63a5\u53e3\u7684\u5b9e\u73b0\u4e2d\u660e\u786e\u8fdb\u884c\u914d\u7f6e\uff08\u4e09\u79cd\u65b9\u5f0f\u4efb\u9009\u4e00\u79cd\uff09\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8fd4\u56de Action.ReconsumeLater \uff08\u63a8\u8350\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u8fd4\u56de null"}),"\n",(0,l.jsx)(n.li,{children:"\u629b\u51fa\u5f02\u5e38"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class MessageListenerImpl implements MessageListener {\n    @Override\n    public Action consume(Message message, ConsumeContext context) {\n        // \u5904\u7406\u6d88\u606f\n        doConsumeMessage(message);\n        //\u65b9\u5f0f1\uff1a\u8fd4\u56de Action.ReconsumeLater\uff0c\u6d88\u606f\u5c06\u91cd\u8bd5\n        return Action.ReconsumeLater;\n        //\u65b9\u5f0f2\uff1a\u8fd4\u56de null\uff0c\u6d88\u606f\u5c06\u91cd\u8bd5\n        return null;\n        //\u65b9\u5f0f3\uff1a\u76f4\u63a5\u629b\u51fa\u5f02\u5e38\uff0c \u6d88\u606f\u5c06\u91cd\u8bd5\n        throw new RuntimeException("Consumer Message exceotion");\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u96c6\u7fa4\u6d88\u8d39\u65b9\u5f0f\u4e0b\uff0c\u6d88\u606f\u5931\u8d25\u540e\u671f\u671b\u6d88\u606f\u4e0d\u91cd\u8bd5\uff0c\u9700\u8981\u6355\u83b7\u6d88\u8d39\u903b\u8f91\u4e2d\u53ef\u80fd\u629b\u51fa\u7684\u5f02\u5e38\uff0c\u6700\u7ec8\u8fd4\u56de Action.CommitMessage\uff0c\u6b64\u540e\u8fd9\u6761\u6d88\u606f\u5c06\u4e0d\u4f1a\u518d\u91cd\u8bd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class MessageListenerImpl implements MessageListener {\n    @Override\n    public Action consume(Message message, ConsumeContext context) {\n        try {\n            doConsumeMessage(message);\n        } catch (Throwable e) {\n            // \u6355\u83b7\u6d88\u8d39\u903b\u8f91\u4e2d\u7684\u6240\u6709\u5f02\u5e38\uff0c\u5e76\u8fd4\u56de Action.CommitMessage;\n            return Action.CommitMessage;\n        }\n        //\u6d88\u606f\u5904\u7406\u6b63\u5e38\uff0c\u76f4\u63a5\u8fd4\u56de Action.CommitMessage;\n        return Action.CommitMessage;\n    }\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49\u6d88\u606f\u6700\u5927\u91cd\u8bd5\u6b21\u6570\uff0cRocketMQ \u5141\u8bb8 Consumer \u542f\u52a8\u7684\u65f6\u5019\u8bbe\u7f6e\u6700\u5927\u91cd\u8bd5\u6b21\u6570\uff0c\u91cd\u8bd5\u65f6\u95f4\u95f4\u9694\u5c06\u6309\u7167\u5982\u4e0b\u7b56\u7565\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u5c0f\u4e8e\u7b49\u4e8e 16 \u6b21\uff0c\u5219\u91cd\u8bd5\u65f6\u95f4\u95f4\u9694\u540c\u4e0a\u8868\u63cf\u8ff0"}),"\n",(0,l.jsx)(n.li,{children:"\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u5927\u4e8e 16 \u6b21\uff0c\u8d85\u8fc7 16 \u6b21\u7684\u91cd\u8bd5\u65f6\u95f4\u95f4\u9694\u5747\u4e3a\u6bcf\u6b21 2 \u5c0f\u65f6"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'Properties properties = new Properties();\n// \u914d\u7f6e\u5bf9\u5e94 Group ID \u7684\u6700\u5927\u6d88\u606f\u91cd\u8bd5\u6b21\u6570\u4e3a 20 \u6b21\nproperties.put(PropertyKeyConst.MaxReconsumeTimes,"20");\nConsumer consumer = ONSFactory.createConsumer(properties);\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6d88\u606f\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u7684\u8bbe\u7f6e\u5bf9\u76f8\u540c Group ID \u4e0b\u7684\u6240\u6709 Consumer \u5b9e\u4f8b\u6709\u6548\u3002\u4f8b\u5982\u53ea\u5bf9\u76f8\u540c Group ID \u4e0b\u4e24\u4e2a Consumer \u5b9e\u4f8b\u4e2d\u7684\u5176\u4e2d\u4e00\u4e2a\u8bbe\u7f6e\u4e86 MaxReconsumeTimes\uff0c\u90a3\u4e48\u8be5\u914d\u7f6e\u5bf9\u4e24\u4e2a Consumer \u5b9e\u4f8b\u5747\u751f\u6548"}),"\n",(0,l.jsx)(n.li,{children:"\u914d\u7f6e\u91c7\u7528\u8986\u76d6\u7684\u65b9\u5f0f\u751f\u6548\uff0c\u5373\u6700\u540e\u542f\u52a8\u7684 Consumer \u5b9e\u4f8b\u4f1a\u8986\u76d6\u4e4b\u524d\u7684\u542f\u52a8\u5b9e\u4f8b\u7684\u914d\u7f6e"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u6536\u5230\u6d88\u606f\u540e\uff0c\u53ef\u6309\u7167\u5982\u4e0b\u65b9\u5f0f\u83b7\u53d6\u6d88\u606f\u7684\u91cd\u8bd5\u6b21\u6570\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class MessageListenerImpl implements MessageListener {\n    @Override\n    public Action consume(Message message, ConsumeContext context) {\n        // \u83b7\u53d6\u6d88\u606f\u7684\u91cd\u8bd5\u6b21\u6570\n        System.out.println(message.getReconsumeTimes());\n        return Action.CommitMessage;\n    }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6b7b\u4fe1\u961f\u5217",children:"\u6b7b\u4fe1\u961f\u5217"}),"\n",(0,l.jsx)(n.p,{children:"\u6b63\u5e38\u60c5\u51b5\u4e0b\u65e0\u6cd5\u88ab\u6d88\u8d39\u7684\u6d88\u606f\u79f0\u4e3a\u6b7b\u4fe1\u6d88\u606f\uff08Dead-Letter Message\uff09\uff0c\u5b58\u50a8\u6b7b\u4fe1\u6d88\u606f\u7684\u7279\u6b8a\u961f\u5217\u79f0\u4e3a\u6b7b\u4fe1\u961f\u5217\uff08Dead-Letter Queue\uff09"}),"\n",(0,l.jsx)(n.p,{children:"\u5f53\u4e00\u6761\u6d88\u606f\u521d\u6b21\u6d88\u8d39\u5931\u8d25\uff0c\u6d88\u606f\u961f\u5217 RocketMQ \u4f1a\u81ea\u52a8\u8fdb\u884c\u6d88\u606f\u91cd\u8bd5\uff0c\u8fbe\u5230\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u540e\uff0c\u82e5\u6d88\u8d39\u4f9d\u7136\u5931\u8d25\uff0c\u5219\u8868\u660e\u6d88\u8d39\u8005\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u65e0\u6cd5\u6b63\u786e\u5730\u6d88\u8d39\u8be5\u6d88\u606f\uff0c\u6b64\u65f6 RocketMQ \u4e0d\u4f1a\u7acb\u523b\u5c06\u6d88\u606f\u4e22\u5f03\uff0c\u800c\u662f\u5c06\u5176\u53d1\u9001\u5230\u8be5\u6d88\u8d39\u8005\u5bf9\u5e94\u7684\u6b7b\u4fe1\u961f\u5217\u4e2d"}),"\n",(0,l.jsx)(n.p,{children:"\u6b7b\u4fe1\u6d88\u606f\u5177\u6709\u4ee5\u4e0b\u7279\u6027\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e0d\u4f1a\u518d\u88ab\u6d88\u8d39\u8005\u6b63\u5e38\u6d88\u8d39"}),"\n",(0,l.jsx)(n.li,{children:"\u6709\u6548\u671f\u4e0e\u6b63\u5e38\u6d88\u606f\u76f8\u540c\uff0c\u5747\u4e3a 3 \u5929\uff0c3 \u5929\u540e\u4f1a\u88ab\u81ea\u52a8\u5220\u9664\uff0c\u6240\u4ee5\u8bf7\u5728\u6b7b\u4fe1\u6d88\u606f\u4ea7\u751f\u540e\u7684 3 \u5929\u5185\u53ca\u65f6\u5904\u7406"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6b7b\u4fe1\u961f\u5217\u5177\u6709\u4ee5\u4e0b\u7279\u6027\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"\u4e00\u4e2a\u6b7b\u4fe1\u961f\u5217\u5bf9\u5e94\u4e00\u4e2a Group ID\uff0c \u800c\u4e0d\u662f\u5bf9\u5e94\u5355\u4e2a\u6d88\u8d39\u8005\u5b9e\u4f8b"})}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u4e00\u4e2a Group ID \u672a\u4ea7\u751f\u6b7b\u4fe1\u6d88\u606f\uff0c\u6d88\u606f\u961f\u5217 RocketMQ \u4e0d\u4f1a\u4e3a\u5176\u521b\u5efa\u76f8\u5e94\u7684\u6b7b\u4fe1\u961f\u5217"}),"\n",(0,l.jsx)(n.li,{children:"\u4e00\u4e2a\u6b7b\u4fe1\u961f\u5217\u5305\u542b\u4e86\u5bf9\u5e94 Group ID \u4ea7\u751f\u7684\u6240\u6709\u6b7b\u4fe1\u6d88\u606f\uff0c\u4e0d\u8bba\u8be5\u6d88\u606f\u5c5e\u4e8e\u54ea\u4e2a Topic"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4e00\u6761\u6d88\u606f\u8fdb\u5165\u6b7b\u4fe1\u961f\u5217\uff0c\u9700\u8981\u6392\u67e5\u53ef\u7591\u56e0\u7d20\u5e76\u89e3\u51b3\u95ee\u9898\u540e\uff0c\u53ef\u4ee5\u5728\u6d88\u606f\u961f\u5217 RocketMQ \u63a7\u5236\u53f0\u91cd\u65b0\u53d1\u9001\u8be5\u6d88\u606f\uff0c\u8ba9\u6d88\u8d39\u8005\u91cd\u65b0\u6d88\u8d39\u4e00\u6b21"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u9ad8\u53ef\u9760\u6027",children:"\u9ad8\u53ef\u9760\u6027"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u6d88\u606f\u4e22\u5931\u53ef\u80fd\u53d1\u751f\u5728\u4ee5\u4e0b\u4e09\u4e2a\u9636\u6bb5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u751f\u4ea7\u9636\u6bb5\uff1a\u6d88\u606f\u5728 Producer \u53d1\u9001\u7aef\u521b\u5efa\u51fa\u6765\uff0c\u7ecf\u8fc7\u7f51\u7edc\u4f20\u8f93\u53d1\u9001\u5230 Broker \u5b58\u50a8\u7aef\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u751f\u4ea7\u8005\u5f97\u5230\u4e00\u4e2a\u6210\u529f\u7684\u54cd\u5e94\uff0c\u5c31\u53ef\u4ee5\u8ba4\u4e3a\u6d88\u606f\u7684\u5b58\u50a8\u548c\u6d88\u606f\u7684\u6d88\u8d39\u90fd\u662f\u53ef\u9760\u7684"}),"\n",(0,l.jsx)(n.li,{children:"\u6d88\u606f\u91cd\u6295\u673a\u5236"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5b58\u50a8\u9636\u6bb5\uff1a\u6d88\u606f\u5728 Broker \u7aef\u5b58\u50a8\uff0c\u5982\u679c\u662f\u4e3b\u5907\u6216\u8005\u591a\u526f\u672c\uff0c\u6d88\u606f\u4f1a\u5728\u8fd9\u4e2a\u9636\u6bb5\u88ab\u590d\u5236\u5230\u5176\u4ed6\u7684\u8282\u70b9\u6216\u8005\u526f\u672c\u4e0a\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5355\u70b9\uff1a\u5237\u76d8\u673a\u5236\uff08\u540c\u6b65\u6216\u5f02\u6b65\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u4e3b\u4ece\uff1a\u6d88\u606f\u540c\u6b65\u673a\u5236\uff08\u5f02\u6b65\u590d\u5236\u6216\u540c\u6b65\u53cc\u5199\uff0c\u4e3b\u4ece\u590d\u5236\u7ae0\u8282\u8be6\u89e3\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u8fc7\u671f\u5220\u9664\uff1a\u64cd\u4f5c CommitLog\u3001ConsumeQueue \u6587\u4ef6\u662f\u57fa\u4e8e\u6587\u4ef6\u5185\u5b58\u6620\u5c04\u673a\u5236\uff0c\u5e76\u4e14\u5728\u542f\u52a8\u7684\u65f6\u5019\u4f1a\u5c06\u6240\u6709\u7684\u6587\u4ef6\u52a0\u8f7d\uff0c\u4e3a\u4e86\u907f\u514d\u5185\u5b58\u4e0e\u78c1\u76d8\u7684\u6d6a\u8d39\uff0c\u8ba9\u78c1\u76d8\u80fd\u591f\u5faa\u73af\u5229\u7528\uff0c\u9632\u6b62\u78c1\u76d8\u4e0d\u8db3\u5bfc\u81f4\u6d88\u606f\u65e0\u6cd5\u5199\u5165\u7b49\u5f15\u5165\u4e86\u6587\u4ef6\u8fc7\u671f\u5220\u9664\u673a\u5236\u3002\u6700\u7ec8\u4f7f\u5f97\u78c1\u76d8\u6c34\u4f4d\u4fdd\u6301\u5728\u4e00\u5b9a\u6c34\u5e73\uff0c\u6700\u7ec8\u4fdd\u8bc1\u65b0\u5199\u5165\u6d88\u606f\u7684\u53ef\u9760\u5b58\u50a8"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u6d88\u8d39\u9636\u6bb5\uff1aConsumer \u6d88\u8d39\u7aef\u4ece Broker\u5b58\u50a8\u7aef\u62c9\u53d6\u6d88\u606f\uff0c\u7ecf\u8fc7\u7f51\u7edc\u4f20\u8f93\u53d1\u9001\u5230 Consumer \u6d88\u8d39\u7aef\u4e0a\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6d88\u606f\u91cd\u8bd5\u673a\u5236\u6765\u6700\u5927\u9650\u5ea6\u7684\u4fdd\u8bc1\u6d88\u606f\u7684\u6d88\u8d39"}),"\n",(0,l.jsx)(n.li,{children:"\u6d88\u8d39\u5931\u8d25\u7684\u8fdb\u884c\u6d88\u606f\u56de\u9000\uff0c\u91cd\u8bd5\u6b21\u6570\u8fc7\u591a\u7684\u6d88\u606f\u653e\u5165\u6b7b\u4fe1\u961f\u5217"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u63a8\u8350\u6587\u7ae0\uff1a",(0,l.jsx)(n.a,{href:"https://cdn.modb.pro/db/394751",children:"https://cdn.modb.pro/db/394751"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5e42\u7b49\u6d88\u8d39",children:"\u5e42\u7b49\u6d88\u8d39"}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u961f\u5217 RocketMQ \u6d88\u8d39\u8005\u5728\u63a5\u6536\u5230\u6d88\u606f\u4ee5\u540e\uff0c\u9700\u8981\u6839\u636e\u4e1a\u52a1\u4e0a\u7684\u552f\u4e00 Key \u5bf9\u6d88\u606f\u505a\u5e42\u7b49\u5904\u7406"}),"\n",(0,l.jsx)(n.p,{children:"At least Once \u673a\u5236\u4fdd\u8bc1\u6d88\u606f\u4e0d\u4e22\u5931\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u9020\u6210\u6d88\u606f\u91cd\u590d\uff0cRocketMQ \u4e2d\u65e0\u6cd5\u907f\u514d\u6d88\u606f\u91cd\u590d\uff08Exactly-Once\uff09\uff0c\u5728\u4e92\u8054\u7f51\u5e94\u7528\u4e2d\uff0c\u5c24\u5176\u5728\u7f51\u7edc\u4e0d\u7a33\u5b9a\u7684\u60c5\u51b5\u4e0b\uff0c\u51e0\u79cd\u60c5\u51b5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u53d1\u9001\u65f6\u6d88\u606f\u91cd\u590d\uff1a\u5f53\u4e00\u6761\u6d88\u606f\u5df2\u88ab\u6210\u529f\u53d1\u9001\u5230\u670d\u52a1\u7aef\u5e76\u5b8c\u6210\u6301\u4e45\u5316\uff0c\u6b64\u65f6\u51fa\u73b0\u4e86\u7f51\u7edc\u95ea\u65ad\u6216\u5ba2\u6237\u7aef\u5b95\u673a\uff0c\u5bfc\u81f4\u670d\u52a1\u7aef\u5bf9\u5ba2\u6237\u7aef\u5e94\u7b54\u5931\u8d25\u3002\u6b64\u65f6\u751f\u4ea7\u8005\u610f\u8bc6\u5230\u6d88\u606f\u53d1\u9001\u5931\u8d25\u5e76\u5c1d\u8bd5\u518d\u6b21\u53d1\u9001\u6d88\u606f\uff0c\u6d88\u8d39\u8005\u540e\u7eed\u4f1a\u6536\u5230\u4e24\u6761\u5185\u5bb9\u76f8\u540c\u5e76\u4e14 Message ID \u4e5f\u76f8\u540c\u7684\u6d88\u606f"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6295\u9012\u65f6\u6d88\u606f\u91cd\u590d\uff1a\u6d88\u606f\u6d88\u8d39\u7684\u573a\u666f\u4e0b\uff0c\u6d88\u606f\u5df2\u6295\u9012\u5230\u6d88\u8d39\u8005\u5e76\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\uff0c\u5f53\u5ba2\u6237\u7aef\u7ed9\u670d\u52a1\u7aef\u53cd\u9988\u5e94\u7b54\u7684\u65f6\u5019\u7f51\u7edc\u95ea\u65ad\u3002\u4e3a\u4e86\u4fdd\u8bc1\u6d88\u606f\u81f3\u5c11\u88ab\u6d88\u8d39\u4e00\u6b21\uff0c\u6d88\u606f\u961f\u5217 RocketMQ \u7684\u670d\u52a1\u7aef\u5c06\u5728\u7f51\u7edc\u6062\u590d\u540e\u518d\u6b21\u5c1d\u8bd5\u6295\u9012\u4e4b\u524d\u5df2\u88ab\u5904\u7406\u8fc7\u7684\u6d88\u606f\uff0c\u6d88\u8d39\u8005\u540e\u7eed\u4f1a\u6536\u5230\u4e24\u6761\u5185\u5bb9\u76f8\u540c\u5e76\u4e14 Message ID \u4e5f\u76f8\u540c\u7684\u6d88\u606f"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8d1f\u8f7d\u5747\u8861\u65f6\u6d88\u606f\u91cd\u590d\uff1a\u5f53\u6d88\u606f\u961f\u5217 RocketMQ \u7684 Broker \u6216\u5ba2\u6237\u7aef\u91cd\u542f\u3001\u6269\u5bb9\u6216\u7f29\u5bb9\u65f6\uff0c\u4f1a\u89e6\u53d1 Rebalance\uff0c\u6b64\u65f6\u6d88\u8d39\u8005\u53ef\u80fd\u4f1a\u6536\u5230\u91cd\u590d\u6d88\u606f"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5904\u7406\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u56e0\u4e3a Message ID \u6709\u53ef\u80fd\u51fa\u73b0\u51b2\u7a81\uff08\u91cd\u590d\uff09\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u771f\u6b63\u5b89\u5168\u7684\u5e42\u7b49\u5904\u7406\uff0c\u4e0d\u5efa\u8bae\u4ee5 Message ID \u4f5c\u4e3a\u5904\u7406\u4f9d\u636e\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u662f\u4ee5\u4e1a\u52a1\u552f\u4e00\u6807\u8bc6\u4f5c\u4e3a\u5e42\u7b49\u5904\u7406\u7684\u5173\u952e\u4f9d\u636e\uff0c\u800c\u4e1a\u52a1\u7684\u552f\u4e00\u6807\u8bc6\u53ef\u4ee5\u901a\u8fc7\u6d88\u606f Key \u8fdb\u884c\u8bbe\u7f6e\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'Message message = new Message();\nmessage.setKey("ORDERID_100");\nSendResult sendResult = producer.send(message);\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8ba2\u9605\u65b9\u6536\u5230\u6d88\u606f\u65f6\u53ef\u4ee5\u6839\u636e\u6d88\u606f\u7684 Key \u8fdb\u884c\u5e42\u7b49\u5904\u7406\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'consumer.subscribe("ons_test", "*", new MessageListener() {\n    public Action consume(Message message, ConsumeContext context) {\n        String key = message.getKey()\n        // \u6839\u636e\u4e1a\u52a1\u552f\u4e00\u6807\u8bc6\u7684 key \u505a\u5e42\u7b49\u5904\u7406\n    }\n});\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6d41\u91cf\u63a7\u5236",children:"\u6d41\u91cf\u63a7\u5236"}),"\n",(0,l.jsx)(n.p,{children:"\u751f\u4ea7\u8005\u6d41\u63a7\uff0c\u56e0\u4e3a Broker \u5904\u7406\u80fd\u529b\u8fbe\u5230\u74f6\u9888\uff1b\u6d88\u8d39\u8005\u6d41\u63a7\uff0c\u56e0\u4e3a\u6d88\u8d39\u80fd\u529b\u8fbe\u5230\u74f6\u9888"}),"\n",(0,l.jsx)(n.p,{children:"\u751f\u4ea7\u8005\u6d41\u63a7\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"CommitLog \u6587\u4ef6\u88ab\u9501\u65f6\u95f4\u8d85\u8fc7 osPageCacheBusyTimeOutMills \u65f6\uff0c\u53c2\u6570\u9ed8\u8ba4\u4e3a 1000ms\uff0c\u8fd4\u56de\u6d41\u63a7"}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u5f00\u542f transientStorePoolEnable == true\uff0c\u4e14 Broker \u4e3a\u5f02\u6b65\u5237\u76d8\u7684\u4e3b\u673a\uff0c\u4e14 transientStorePool \u4e2d\u8d44\u6e90\u4e0d\u8db3\uff0c\u62d2\u7edd\u5f53\u524d send \u8bf7\u6c42\uff0c\u8fd4\u56de\u6d41\u63a7"}),"\n",(0,l.jsx)(n.li,{children:"Broker \u6bcf\u9694 10ms \u68c0\u67e5 send \u8bf7\u6c42\u961f\u5217\u5934\u90e8\u8bf7\u6c42\u7684\u7b49\u5f85\u65f6\u95f4\uff0c\u5982\u679c\u8d85\u8fc7 waitTimeMillsInSendQueue\uff0c\u9ed8\u8ba4 200ms\uff0c\u62d2\u7edd\u5f53\u524d send \u8bf7\u6c42\uff0c\u8fd4\u56de\u6d41\u63a7\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Broker \u901a\u8fc7\u62d2\u7edd send \u8bf7\u6c42\u65b9\u5f0f\u5b9e\u73b0\u6d41\u91cf\u63a7\u5236"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u751f\u4ea7\u8005\u6d41\u63a7\uff0c\u4e0d\u4f1a\u5c1d\u8bd5\u6d88\u606f\u91cd\u6295"}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u6d41\u63a7\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6d88\u8d39\u8005\u672c\u5730\u7f13\u5b58\u6d88\u606f\u6570\u8d85\u8fc7 pullThresholdForQueue \u65f6\uff0c\u9ed8\u8ba4 1000"}),"\n",(0,l.jsx)(n.li,{children:"\u6d88\u8d39\u8005\u672c\u5730\u7f13\u5b58\u6d88\u606f\u5927\u5c0f\u8d85\u8fc7 pullThresholdSizeForQueue \u65f6\uff0c\u9ed8\u8ba4 100MB"}),"\n",(0,l.jsx)(n.li,{children:"\u6d88\u8d39\u8005\u672c\u5730\u7f13\u5b58\u6d88\u606f\u8de8\u5ea6\u8d85\u8fc7 consumeConcurrentlyMaxSpan \u65f6\uff0c\u9ed8\u8ba4 2000"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u6d41\u63a7\u7684\u7ed3\u679c\u662f\u964d\u4f4e\u62c9\u53d6\u9891\u7387"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u539f\u7406\u89e3\u6790-4",children:"\u539f\u7406\u89e3\u6790"}),"\n",(0,l.jsx)(n.h3,{id:"namesrv",children:"Namesrv"}),"\n",(0,l.jsx)(n.h4,{id:"\u670d\u52a1\u542f\u52a8",children:"\u670d\u52a1\u542f\u52a8"}),"\n",(0,l.jsx)(n.h5,{id:"\u542f\u52a8\u65b9\u6cd5",children:"\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"NamesrvStartup \u7c7b\u4e2d\u6709 Namesrv \u670d\u52a1\u7684\u542f\u52a8\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public static void main(String[] args) {\n    // \u5982\u679c\u542f\u52a8\u65f6 \u4f7f\u7528 -c  -p  \u8bbe\u7f6e\u53c2\u6570\u4e86\uff0c\u8fd9\u4e9b\u53c2\u6570\u5b58\u50a8\u5728 args \u4e2d\n    main0(args);\n}\n\npublic static NamesrvController main0(String[] args) {\n    try {\n        // \u521b\u5efa namesrv \u63a7\u5236\u5668\uff0c\u7528\u6765\u521d\u59cb\u5316 namesrv \u542f\u52a8 namesrv \u5173\u95ed namesrv\n        NamesrvController controller = createNamesrvController(args);\n\t\t// \u542f\u52a8 controller\n        start(controller);\n        return controller;\n    } catch (Throwable e) {\n        // \u51fa\u73b0\u5f02\u5e38\uff0c\u505c\u6b62\u7cfb\u7edf\n        System.exit(-1);\n    }\n    return null;\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"NamesrvStartup#createNamesrvController\uff1a\u8bfb\u53d6\u914d\u7f6e\u4fe1\u606f\uff0c\u521d\u59cb\u5316 Namesrv \u63a7\u5236\u5668"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:'ServerUtil.parseCmdLine("mqnamesrv", args, buildCommandlineOptions(options)\uff0c..)'}),"\uff1a\u89e3\u6790\u542f\u52a8\u65f6\u7684\u53c2\u6570\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"namesrvConfig = new NamesrvConfig()"}),"\uff1a\u521b\u5efa Namesrv \u914d\u7f6e\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private String rocketmqHome"}),"\uff1a\u83b7\u53d6 ROCKETMQ_HOME \u503c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private boolean orderMessageEnable = false"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u987a\u5e8f\u6d88\u606f"}),"\u529f\u80fd\u662f\u5426\u5f00\u542f"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"nettyServerConfig = new NettyServerConfig()"}),"\uff1aNetty \u7684\u670d\u52a1\u5668\u914d\u7f6e\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"nettyServerConfig.setListenPort(9876)"}),"\uff1aNamesrv \u670d\u52a1\u5668\u7684",(0,l.jsx)(n.strong,{children:"\u76d1\u542c\u7aef\u53e3\u8bbe\u7f6e\u4e3a 9876"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (commandLine.hasOption('c'))"}),"\uff1a\u8bfb\u53d6\u547d\u4ee4\u884c -c \u7684\u53c2\u6570\u503c"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"in = new BufferedInputStream(new FileInputStream(file))"}),"\uff1a\u8bfb\u53d6\u6307\u5b9a\u76ee\u5f55\u7684\u914d\u7f6e\u6587\u4ef6"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"properties.load(in)"}),"\uff1a\u5c06\u914d\u7f6e\u6587\u4ef6\u4fe1\u606f\u52a0\u8f7d\u5230 properties \u5bf9\u8c61\uff0c\u76f8\u5173\u5c5e\u6027\u4f1a\u590d\u5199\u5230 Namesrv \u914d\u7f6e\u548c Netty \u914d\u7f6e\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"namesrvConfig.setConfigStorePath(file)"}),"\uff1a\u5c06\u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f84\u4fdd\u5b58\u5230\u914d\u7f6e\u4fdd\u5b58\u5b57\u6bb5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == namesrvConfig.getRocketmqHome())"}),"\uff1a\u68c0\u67e5 ROCKETMQ_HOME \u914d\u7f6e\u662f\u5426\u662f\u7a7a\uff0c\u662f\u7a7a\u5c31\u62a5\u9519"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"lc = (LoggerContext) LoggerFactory.getILoggerFactory()"}),"\uff1a\u521b\u5efa\u65e5\u5fd7\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"controller = new NamesrvController(namesrvConfig, nettyServerConfig)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u521b\u5efa Namesrv \u63a7\u5236\u5668"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"NamesrvStartup#start\uff1a\u542f\u52a8 Namesrv \u63a7\u5236\u5668"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean initResult = controller.initialize()"}),"\uff1a\u521d\u59cb\u5316\u65b9\u6cd5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:" Runtime.getRuntime().addShutdownHook(new ShutdownHookThread())"}),"\uff1aJVM HOOK \u5e73\u6ed1\u5173\u95ed\u7684\u903b\u8f91\uff0c \u5f53 JVM \u88ab\u5173\u95ed\u65f6\uff0c\u4e3b\u52a8\u8c03\u7528 controller.shutdown() \u65b9\u6cd5\uff0c\u8ba9\u670d\u52a1\u5668\u5e73\u6ed1\u5173\u673a"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"controller.start()"}),"\uff1a\u542f\u52a8\u670d\u52a1\u5668"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u6e90\u7801\u89e3\u6790\u53c2\u8003\u89c6\u9891\uff1a",(0,l.jsx)(n.a,{href:"https://space.bilibili.com/457326371",children:"https://space.bilibili.com/457326371"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u63a7\u5236\u5668\u7c7b",children:"\u63a7\u5236\u5668\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"NamesrvController \u7528\u6765\u521d\u59cb\u5316\u548c\u542f\u52a8 Namesrv \u670d\u52a1\u5668"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ScheduledExecutorService scheduledExecutorService;\t// \u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff0c\u7528\u6765\u6267\u884c\u5b9a\u65f6\u4efb\u52a1\nprivate final RouteInfoManager routeInfoManager;\t\t\t\t\t// \u7ba1\u7406\u3010\u8def\u7531\u4fe1\u606f\u3011\u7684\u5bf9\u8c61\nprivate RemotingServer remotingServer;\t\t\t\t\t\t\t\t// \u3010\u7f51\u7edc\u5c42\u3011\u5c01\u88c5\u5bf9\u8c61\nprivate BrokerHousekeepingService brokerHousekeepingService;\t\t// \u7528\u4e8e\u76d1\u542c channel \u72b6\u6001\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"private ExecutorService remotingExecutor"}),"\uff1a\u4e1a\u52a1\u7ebf\u7a0b\u6c60\uff0c",(0,l.jsx)(n.strong,{children:"netty \u7ebf\u7a0b\u89e3\u6790\u62a5\u6587\u6210 RemotingCommand \u5bf9\u8c61\uff0c\u7136\u540e\u5c06\u8be5\u5bf9\u8c61\u4ea4\u7ed9\u4e1a\u52a1\u7ebf\u7a0b\u6c60\u518d\u7ee7\u7eed\u5904\u7406"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521d\u59cb\u5316\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean initialize() {\n    // \u52a0\u8f7d\u672c\u5730kv\u914d\u7f6e\uff08\u6211\u8fd8\u4e0d\u660e\u767d kv \u914d\u7f6e\u662f\u5565\uff09\n    this.kvConfigManager.load();\n    // \u521b\u5efa\u7f51\u7edc\u670d\u52a1\u5668\u5bf9\u8c61\uff0c\u3010\u5c06 netty \u7684\u914d\u7f6e\u548c\u76d1\u542c\u5668\u4f20\u5165\u3011\n    // \u76d1\u542c\u5668\u76d1\u542c channel \u72b6\u6001\u7684\u6539\u53d8\uff0c\u4f1a\u5411\u4e8b\u4ef6\u961f\u5217\u53d1\u8d77\u4e8b\u4ef6\uff0c\u6700\u540e\u4ea4\u7531 service \u5904\u7406\n    this.remotingServer = new NettyRemotingServer(this.nettyServerConfig, this.brokerHousekeepingService);\n    // \u3010\u521b\u5efa\u4e1a\u52a1\u7ebf\u7a0b\u6c60\uff0c\u9ed8\u8ba4\u7ebf\u7a0b\u6570 8\u3011\n    this.remotingExecutor = Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads().);\n\n    // \u6ce8\u518c\u534f\u8bae\u5904\u7406\u5668\uff08\u7f3a\u7701\u534f\u8bae\u5904\u7406\u5668\uff09\uff0c\u3010\u5904\u7406\u5668\u662f DefaultRequestProcessor\u3011\uff0c\u7ebf\u7a0b\u4f7f\u7528\u7684\u662f\u521a\u521b\u5efa\u7684\u4e1a\u52a1\u7684\u7ebf\u7a0b\u6c60\n    this.registerProcessor();\n\n    // \u5b9a\u65f6\u4efb\u52a11\uff1a\u6bcf 10 \u79d2\u949f\u68c0\u67e5 broker \u5b58\u6d3b\u72b6\u6001\uff0c\u5c06 IDLE \u72b6\u6001\u7684 broker \u79fb\u9664\u3010\u626b\u63cf\u673a\u5236\uff0c\u5fc3\u8df3\u68c0\u6d4b\u3011\n    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n        @Override\n        public void run() {\n            // \u626b\u63cf brokerLiveTable \u8868\uff0c\u5c06\u4e24\u5c0f\u65f6\u6ca1\u6709\u6d3b\u52a8\u7684 broker \u5173\u95ed\uff0c\n            // \u901a\u8fc7 next.getKey() \u83b7\u53d6 broker \u7684\u5730\u5740\uff0c\u7136\u540e\u3010\u5173\u95ed\u670d\u52a1\u5668\u4e0ebroker\u7269\u7406\u8282\u70b9\u7684 channel\u3011\n            NamesrvController.this.routeInfoManager.scanNotActiveBroker();\n        }\n    }, 5, 10, TimeUnit.SECONDS);\n\n    // \u5b9a\u65f6\u4efb\u52a12\uff1a\u6bcf 10 \u5206\u949f\u6253\u5370\u4e00\u904d kv \u914d\u7f6e\u3002\n    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n        @Override\n        public void run() {\n            NamesrvController.this.kvConfigManager.printAllPeriodically();\n        }\n    }, 1, 10, TimeUnit.MINUTES);\n\n    return true;\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u542f\u52a8\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start() throws Exception {\n    // \u670d\u52a1\u5668\u7f51\u7edc\u5c42\u542f\u52a8\u3002\n    this.remotingServer.start();\n\n    if (this.fileWatchService != null) {\n        this.fileWatchService.start();\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u7f51\u7edc\u901a\u4fe1",children:"\u7f51\u7edc\u901a\u4fe1"}),"\n",(0,l.jsx)(n.h5,{id:"\u901a\u4fe1\u539f\u7406",children:"\u901a\u4fe1\u539f\u7406"}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u7684 RPC \u901a\u4fe1\u91c7\u7528 Netty \u7ec4\u4ef6\u4f5c\u4e3a\u5e95\u5c42\u901a\u4fe1\u5e93\uff0c\u540c\u6837\u4e5f\u9075\u5faa\u4e86 Reactor \u591a\u7ebf\u7a0b\u6a21\u578b\uff0cNettyRemotingServer \u7c7b\u8d1f\u8d23\u6846\u67b6\u7684\u901a\u4fe1\u670d\u52a1\uff0c\u540c\u65f6\u53c8\u5728\u8fd9\u4e4b\u4e0a\u505a\u4e86\u4e00\u4e9b\u6269\u5c55\u548c\u4f18\u5316"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(76324).A+"",width:"956",height:"447"})}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u57fa\u4e8e NettyRemotingServer \u7684 Reactor \u591a\u7ebf\u7a0b\u6a21\u578b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e00\u4e2a Reactor \u4e3b\u7ebf\u7a0b\uff08eventLoopGroupBoss\uff09\u8d1f\u8d23\u76d1\u542c TCP \u7f51\u7edc\u8fde\u63a5\u8bf7\u6c42\uff0c\u5efa\u7acb\u597d\u8fde\u63a5\u521b\u5efa SocketChannel\uff08RocketMQ \u4f1a\u81ea\u52a8\u6839\u636e OS \u7684\u7c7b\u578b\u9009\u62e9 NIO \u548c Epoll\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570\u914d\u7f6e\uff09\uff0c\u5e76\u6ce8\u518c\u5230 Selector \u4e0a\uff0c\u7136\u540e\u76d1\u542c\u771f\u6b63\u7684\u7f51\u7edc\u6570\u636e"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u62ff\u5230\u7f51\u7edc\u6570\u636e\u4ea4\u7ed9 Worker \u7ebf\u7a0b\u6c60\uff08eventLoopGroupSelector\uff0c\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a 3\uff09\uff0c\u5728\u771f\u6b63\u6267\u884c\u4e1a\u52a1\u903b\u8f91\u4e4b\u524d\u9700\u8981\u8fdb\u884c SSL \u9a8c\u8bc1\u3001\u7f16\u89e3\u7801\u3001\u7a7a\u95f2\u68c0\u67e5\u3001\u7f51\u7edc\u8fde\u63a5\u7ba1\u7406\uff0c\u8fd9\u4e9b\u5de5\u4f5c\u4ea4\u7ed9 defaultEventExecutorGroup\uff08\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a 8\uff09\u53bb\u505a"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5904\u7406\u4e1a\u52a1\u64cd\u4f5c\u653e\u5728\u4e1a\u52a1\u7ebf\u7a0b\u6c60\u4e2d\u6267\u884c\uff0c\u6839\u636e RomotingCommand \u7684",(0,l.jsx)(n.strong,{children:"\u4e1a\u52a1\u8bf7\u6c42\u7801 code"})," \u53bb processorTable \u8fd9\u4e2a\u672c\u5730\u7f13\u5b58\u53d8\u91cf\u4e2d\u627e\u5230\u5bf9\u5e94\u7684 processor\uff0c\u5c01\u88c5\u6210 task \u4efb\u52a1\u63d0\u4ea4\u7ed9\u5bf9\u5e94\u7684 processor \u5904\u7406\u7ebf\u7a0b\u6c60\u6765\u6267\u884c\uff08sendMessageExecutor\uff0c\u4ee5\u53d1\u9001\u6d88\u606f\u4e3a\u4f8b\uff09"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4ece\u5165\u53e3\u5230\u4e1a\u52a1\u903b\u8f91\u7684\u51e0\u4e2a\u6b65\u9aa4\u4e2d\u7ebf\u7a0b\u6c60\u4e00\u76f4\u518d\u589e\u52a0\uff0c\u8fd9\u8ddf\u6bcf\u4e00\u6b65\u903b\u8f91\u590d\u6742\u6027\u76f8\u5173\uff0c\u8d8a\u590d\u6742\uff0c\u9700\u8981\u7684\u5e76\u53d1\u901a\u9053\u8d8a\u5bbd"}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u7ebf\u7a0b\u6570"}),(0,l.jsx)(n.th,{children:"\u7ebf\u7a0b\u540d"}),(0,l.jsx)(n.th,{children:"\u7ebf\u7a0b\u5177\u4f53\u8bf4\u660e"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"1"}),(0,l.jsx)(n.td,{children:"NettyBoss_%d"}),(0,l.jsx)(n.td,{children:"Reactor \u4e3b\u7ebf\u7a0b"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"N"}),(0,l.jsx)(n.td,{children:"NettyServerEPOLLSelector_%d_%d"}),(0,l.jsx)(n.td,{children:"Reactor \u7ebf\u7a0b\u6c60"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"M1"}),(0,l.jsx)(n.td,{children:"NettyServerCodecThread_%d"}),(0,l.jsx)(n.td,{children:"Worker \u7ebf\u7a0b\u6c60"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"M2"}),(0,l.jsx)(n.td,{children:"RemotingExecutorThread_%d"}),(0,l.jsx)(n.td,{children:"\u4e1a\u52a1 processor \u5904\u7406\u7ebf\u7a0b\u6c60"})]})]})]}),"\n",(0,l.jsx)(n.p,{children:"RocketMQ \u7684\u5f02\u6b65\u901a\u4fe1\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(97081).A+"",width:"620",height:"493"})}),"\n",(0,l.jsx)(n.p,{children:"==todo\uff1a\u540e\u671f\u5bf9 Netty \u6709\u4e86\u66f4\u6df1\u7684\u8ba4\u77e5\u540e\u4f1a\u8fdb\u884c\u6269\u5145\uff0c\u73b0\u5728\u6682\u65f6 copy \u5b98\u65b9\u6587\u6863=="}),"\n",(0,l.jsxs)(n.p,{children:["\u5b98\u65b9\u6587\u6863\uff1a",(0,l.jsx)(n.a,{href:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md#2-%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6",children:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md#2-%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"NettyRemotingServer \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u5668\u76f8\u5173\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ServerBootstrap serverBootstrap;\t\t\t\t// netty \u670d\u52a1\u7aef\u542f\u52a8\u5bf9\u8c61\nprivate final EventLoopGroup eventLoopGroupSelector;\t\t// netty worker \u7ec4\u7ebf\u7a0b\u6c60\uff0c\u3010\u9ed8\u8ba4 3 \u4e2a\u7ebf\u7a0b\u3011\nprivate final EventLoopGroup eventLoopGroupBoss;\t\t\t// netty boss \u7ec4\u7ebf\u7a0b\u6c60\uff0c\u3010\u4e00\u822c\u662f 1 \u4e2a\u7ebf\u7a0b\u3011\nprivate final NettyServerConfig nettyServerConfig;\t\t\t// netty \u670d\u52a1\u7aef\u7f51\u7edc\u914d\u7f6e\nprivate int port = 0;\t\t\t\t\t\t\t\t\t\t// \u670d\u52a1\u5668\u7ed1\u5b9a\u7684\u7aef\u53e3\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u516c\u5171\u7ebf\u7a0b\u6c60\uff1a\u6ce8\u518c\u5904\u7406\u5668\u65f6\u5982\u679c\u672a\u6307\u5b9a\u7ebf\u7a0b\u6c60\uff0c\u5219\u4e1a\u52a1\u5904\u7406\u4f7f\u7528\u516c\u5171\u7ebf\u7a0b\u6c60\uff0c\u7ebf\u7a0b\u6570\u91cf\u9ed8\u8ba4\u662f 4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ExecutorService publicExecutor;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e8b\u4ef6\u76d1\u542c\u5668\uff1aNameserver \u4f7f\u7528 BrokerHouseKeepingService\uff0cBroker \u4f7f\u7528 ClientHouseKeepingService"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ChannelEventListener channelEventListener;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e8b\u4ef6\u5904\u7406\u7ebf\u7a0b\u6c60\uff1a\u9ed8\u8ba4\u662f 8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private DefaultEventExecutorGroup defaultEventExecutorGroup;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u5668\uff1a\u6267\u884c\u5faa\u73af\u4efb\u52a1\uff0c\u5e76\u4e14\u5c06\u5b9a\u65f6\u5668\u7ebf\u7a0b\u8bbe\u7f6e\u4e3a\u5b88\u62a4\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:' private final Timer timer = new Timer("ServerHouseKeepingService", true);\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5904\u7406\u5668\uff1a\u591a\u4e2a Channel \u5171\u4eab\u7684\u5904\u7406\u5668 Handler\uff0c\u591a\u4e2a\u901a\u9053\u4f7f\u7528\u540c\u4e00\u4e2a\u5bf9\u8c61"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Netty \u914d\u7f6e\u5bf9\u8c61\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class NettyServerConfig implements Cloneable {\n    // \u670d\u52a1\u7aef\u542f\u52a8\u65f6\u76d1\u542c\u7684\u7aef\u53e3\u53f7\n    private int listenPort = 8888;\n    // \u3010\u4e1a\u52a1\u7ebf\u7a0b\u6c60\u3011 \u7ebf\u7a0b\u6570\u91cf\n    private int serverWorkerThreads = 8;\n    // \u6839\u636e\u8be5\u503c\u521b\u5efa remotingServer \u5185\u90e8\u7684\u4e00\u4e2a publicExecutor\n    private int serverCallbackExecutorThreads = 0;\n    // netty \u3010worker\u3011\u7ebf\u7a0b\u6570\n    private int serverSelectorThreads = 3;\n    // \u3010\u5355\u5411\u8bbf\u95ee\u3011\u65f6\u7684\u5e76\u53d1\u9650\u5236\n    private int serverOnewaySemaphoreValue = 256;\n    // \u3010\u5f02\u6b65\u8bbf\u95ee\u3011\u65f6\u7684\u5e76\u53d1\u9650\u5236\n    private int serverAsyncSemaphoreValue = 64;\n    // channel \u6700\u5927\u7684\u7a7a\u95f2\u5b58\u6d3b\u65f6\u95f4 \u9ed8\u8ba4\u662f 2min\n    private int serverChannelMaxIdleTimeSeconds = 120;\n    // \u53d1\u9001\u7f13\u51b2\u533a\u5927\u5c0f 65535\n    private int serverSocketSndBufSize = NettySystemConfig.socketSndbufSize;\n    // \u63a5\u6536\u7f13\u51b2\u533a\u5927\u5c0f 65535\n    private int serverSocketRcvBufSize = NettySystemConfig.socketRcvbufSize;\n    // \u662f\u5426\u542f\u7528 netty \u5185\u5b58\u6c60 \u9ed8\u8ba4\u5f00\u542f\n    private boolean serverPooledByteBufAllocatorEnable = true;\n\n    // \u9ed8\u8ba4 linux \u4f1a\u542f\u7528 \u3010epoll\u3011\n    private boolean useEpollNativeSelector = false;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u65e0\u76d1\u542c\u5668\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public NettyRemotingServer(final NettyServerConfig nettyServerConfig) {\n    this(nettyServerConfig, null);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6709\u53c2\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public NettyRemotingServer(final NettyServerConfig nettyServerConfig,\n                           final ChannelEventListener channelEventListener) {\n    // \u670d\u52a1\u5668\u5bf9\u5ba2\u6237\u7aef\u4e3b\u52a8\u53d1\u8d77\u8bf7\u6c42\u65f6\u5e76\u53d1\u9650\u5236\u3002\u3010\u5355\u5411\u8bf7\u6c42\u548c\u5f02\u6b65\u8bf7\u6c42\u3011\u7684\u5e76\u53d1\u9650\u5236\n    super(nettyServerConfig.getServerOnewaySemaphoreValue(), nettyServerConfig.getServerAsyncSemaphoreValue());\n\t// Netty \u7684\u542f\u52a8\u5668\uff0c\u8d1f\u8d23\u7ec4\u88c5 netty \u7ec4\u4ef6\n    this.serverBootstrap = new ServerBootstrap();\n    // \u6210\u5458\u53d8\u91cf\u7684\u8d4b\u503c\n    this.nettyServerConfig = nettyServerConfig;\n    this.channelEventListener = channelEventListener;\n\n    // \u516c\u5171\u7ebf\u7a0b\u6c60\u7684\u7ebf\u7a0b\u6570\u91cf\uff0c\u9ed8\u8ba4\u7ed9\u76840\uff0c\u8fd9\u91cc\u6700\u7ec8\u4fee\u6539\u4e3a4.\n    int publicThreadNums = nettyServerConfig.getServerCallbackExecutorThreads();\n    if (publicThreadNums <= 0) {\n        publicThreadNums = 4;\n    }\n    // \u521b\u5efa\u516c\u5171\u7ebf\u7a0b\u6c60\uff0c\u6307\u5b9a\u7ebf\u7a0b\u5de5\u5382\uff0c\u8bbe\u7f6e\u7ebf\u7a0b\u540d\u79f0\u524d\u7f00\uff1aNettyServerPublicExecutor_[\u6570\u5b57]\n    this.publicExecutor = Executors.newFixedThreadPool(publicThreadNums, new ThreadFactory(){.});\n\n    // \u521b\u5efa\u4e24\u4e2a netty \u7684\u7ebf\u7a0b\u7ec4\uff0c\u4e00\u4e2a\u662fboss\u7ec4\uff0c\u4e00\u4e2a\u662fworker\u7ec4\uff0c\u3010linux \u7cfb\u7edf\u9ed8\u8ba4\u542f\u7528 epoll\u3011\n    if (useEpoll()) {...} else {...}\n\t// SSL \u76f8\u5173\n    loadSslContext();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u542f\u52a8\u65b9\u6cd5-1",children:"\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\u7684\u89e3\u6790\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["start()\uff1a\u542f\u52a8\u65b9\u6cd5\uff0c",(0,l.jsx)(n.strong,{children:"\u521b\u5efa BootStrap\uff0c\u5e76\u6dfb\u52a0 NettyServerHandler \u5904\u7406\u5668"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start() {\n    // Channel Pipeline \u5185\u7684 handler \u4f7f\u7528\u7684\u7ebf\u7a0b\u8d44\u6e90\uff0c\u3010\u7ebf\u7a0b\u5206\u914d\u7ed9 handler \u5904\u7406\u4e8b\u4ef6\u3011\n    this.defaultEventExecutorGroup = new DefaultEventExecutorGroup(...);\n\n    // \u521b\u5efa\u901a\u7528\u5171\u4eab\u7684\u5904\u7406\u5668 handler\uff0c\u3010\u975e\u5e38\u91cd\u8981\u7684 NettyServerHandler\u3011\n    prepareSharableHandlers();\n\n    ServerBootstrap childHandler =\n        // \u914d\u7f6e\u5de5\u4f5c\u7ec4 boss\uff08\u6570\u91cf1\uff09 \u548c worker\uff08\u6570\u91cf3\uff09 \u7ec4\n        this.serverBootstrap.group(this.eventLoopGroupBoss, this.eventLoopGroupSelector)\n        // \u8bbe\u7f6e\u670d\u52a1\u7aef ServerSocketChannel \u7c7b\u578b\uff0c Linux \u7528 epoll\n        .channel(useEpoll() ? EpollServerSocketChannel.class : NioServerSocketChannel.class)\n        // \u8bbe\u7f6e\u670d\u52a1\u7aef channel \u9009\u9879\n        .option(ChannelOption.SO_BACKLOG, 1024)\n        // \u5ba2\u6237\u7aef channel \u9009\u9879\n        .childOption(ChannelOption.TCP_NODELAY, true)\n        // \u8bbe\u7f6e\u670d\u52a1\u5668\u7aef\u53e3\n        .localAddress(new InetSocketAddress(this.nettyServerConfig.getListenPort()))\n        // \u5411 channel pipeline \u6dfb\u52a0\u4e86\u5f88\u591a handler\uff0c\u3010\u5305\u62ec NettyServerHandler\u3011\n        .childHandler(new ChannelInitializer<SocketChannel>() {});\n            \n\t// \u5ba2\u6237\u7aef\u5f00\u542f \u5185\u5b58\u6c60\uff0c\u4f7f\u7528\u7684\u5185\u5b58\u6c60\u662f  PooledByteBufAllocator.DEFAULT\n    if (nettyServerConfig.isServerPooledByteBufAllocatorEnable()) {\n        childHandler.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);\n    }\n\n    try {\n        // \u540c\u6b65\u7b49\u5f85\u5efa\u7acb\u8fde\u63a5\uff0c\u5e76\u7ed1\u5b9a\u7aef\u53e3\u3002\n        ChannelFuture sync = this.serverBootstrap.bind().sync();\n        InetSocketAddress addr = (InetSocketAddress) sync.channel().localAddress();\n        // \u5c06\u670d\u52a1\u5668\u6210\u529f\u7ed1\u5b9a\u7684\u7aef\u53e3\u53f7\u8d4b\u503c\u7ed9\u5b57\u6bb5 port\u3002\n        this.port = addr.getPort();\n    } catch (InterruptedException e1) {}\n\n    // housekeepingService \u4e0d\u4e3a\u7a7a\uff0c\u5219\u521b\u5efa\u3010\u7f51\u7edc\u5f02\u5e38\u4e8b\u4ef6\u5904\u7406\u5668\u3011\n    if (this.channelEventListener != null) {\n        // \u7ebf\u7a0b\u4e00\u76f4\u8f6e\u8be2 nettyEvent \u72b6\u6001\uff0c\u6839\u636e CONNECT,CLOSE,IDLE,EXCEPTION \u56db\u79cd\u4e8b\u4ef6\u7c7b\u578b\n        // CONNECT \u4e0d\u505a\u64cd\u4f5c\uff0c\u5176\u4f59\u90fd\u662f\u56de\u8c03 onChannelDestroy \u3010\u5173\u95ed\u670d\u52a1\u5668\u4e0e Broker \u7269\u7406\u8282\u70b9\u7684 Channel\u3011\n        this.nettyEventExecutor.start();\n    }\n\n    // \u63d0\u4ea4\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf\u4e00\u79d2 \u6267\u884c\u4e00\u6b21\u3002\u626b\u63cf responseTable \u8868\uff0c\u5c06\u8fc7\u671f\u7684\u6570\u636e\u79fb\u9664\n    this.timer.scheduleAtFixedRate(new TimerTask() {\n        @Override\n        public void run() {\n       \t\tNettyRemotingServer.this.scanResponseTable();\n        }\n    }, 1000 * 3, 1000);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"registerProcessor()\uff1a\u6ce8\u518c\u4e1a\u52a1\u5904\u7406\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void registerProcessor(int requestCode, NettyRequestProcessor processor, ExecutorService executor) {\n    ExecutorService executorThis = executor;\n    if (null == executor) {\n        // \u672a\u6307\u5b9a\u7ebf\u7a0b\u6c60\u8d44\u6e90\uff0c\u5c06\u516c\u5171\u7ebf\u7a0b\u6c60\u8d4b\u503c\n        executorThis = this.publicExecutor;\n    }\n    // pair \u5bf9\u8c61\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u4ee3\u8868\u7684\u662f\u5904\u7406\u5668\uff0c \u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f\u7ebf\u7a0b\u6c60\uff0c\u9ed8\u8ba4\u662f\u516c\u5171\u7684\u7ebf\u7a0b\u6c60\n    Pair<NettyRequestProcessor, ExecutorService> pair = new Pair<NettyRequestProcessor, ExecutorService>(processor, executorThis);\n\n    // key \u662f\u8bf7\u6c42\u7801\uff0cvalue \u662f Pair \u5bf9\u8c61\n    this.processorTable.put(requestCode, pair);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["getProcessorPair()\uff1a",(0,l.jsx)(n.strong,{children:"\u6839\u636e\u8bf7\u6c42\u7801\u83b7\u53d6\u5bf9\u5e94\u7684\u5904\u7406\u5668\u548c\u7ebf\u7a0b\u6c60\u8d44\u6e90"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public Pair<NettyRequestProcessor, ExecutorService> getProcessorPair(int requestCode) {\n    return processorTable.get(requestCode);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u8bf7\u6c42\u65b9\u6cd5",children:"\u8bf7\u6c42\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"\u5728 RocketMQ \u6d88\u606f\u961f\u5217\u4e2d\u652f\u6301\u901a\u4fe1\u7684\u65b9\u5f0f\u4e3b\u8981\u6709\u540c\u6b65\uff08sync\uff09\u3001\u5f02\u6b65\uff08async\uff09\u3001\u5355\u5411\uff08oneway\uff09\u4e09\u79cd\uff0c\u5176\u4e2d\u5355\u5411\u901a\u4fe1\u6a21\u5f0f\u76f8\u5bf9\u7b80\u5355\uff0c\u4e00\u822c\u7528\u5728\u53d1\u9001\u5fc3\u8df3\u5305\u573a\u666f\u4e0b\uff0c\u65e0\u9700\u5173\u6ce8\u5176 Response"}),"\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u5668\u4e3b\u52a8\u5411\u5ba2\u6237\u7aef\u53d1\u8d77\u8bf7\u6c42\u65f6\uff0c\u4f7f\u7528\u4e09\u79cd\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["invokeSync()\uff1a \u540c\u6b65\u8c03\u7528\uff0c",(0,l.jsx)(n.strong,{children:"\u670d\u52a1\u5668\u9700\u8981\u963b\u585e\u7b49\u5f85\u8c03\u7528\u7684\u8fd4\u56de\u7ed3\u679c"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int opaque = request.getOpaque()"}),"\uff1a\u83b7\u53d6\u8bf7\u6c42 ID\uff08\u4e0e\u8bf7\u6c42\u7801\u4e0d\u540c\uff09"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture = new ResponseFuture(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u521b\u5efa\u54cd\u5e94\u5bf9\u8c61"}),"\uff0c\u6ca1\u6709\u56de\u8c03\u51fd\u6570\u548c Once"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.responseTable.put(opaque, responseFuture)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u52a0\u5165\u5230\u54cd\u5e94\u6620\u5c04\u8868\u4e2d"}),"\uff0ckey \u4e3a\u8bf7\u6c42 ID"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SocketAddress addr = channel.remoteAddress()"}),"\uff1a\u83b7\u53d6\u5ba2\u6237\u7aef\u7684\u5730\u5740\u4fe1\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"channel.writeAndFlush(request).addListener(...)"}),"\uff1a\u5c06",(0,l.jsx)(n.strong,{children:"\u4e1a\u52a1 Command \u4fe1\u606f"}),"\u5199\u5165\u901a\u9053\uff0c\u4e1a\u52a1\u7ebf\u7a0b\u5c06\u6570\u636e\u4ea4\u7ed9 Netty \uff0cNetty \u7684 IO \u7ebf\u7a0b\u63a5\u7ba1\u5199\u5237\u6570\u636e\u7684\u64cd\u4f5c\uff0c",(0,l.jsx)(n.strong,{children:"\u76d1\u542c\u5668\u7531 IO \u7ebf\u7a0b\u5728\u5199\u5237\u540e\u56de\u8c03"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (f.isSuccess())"}),"\uff1a\u5199\u5165\u6210\u529f\u4f1a\u5c06\u54cd\u5e94\u5bf9\u8c61\u8bbe\u7f6e\u4e3a\u6210\u529f\u72b6\u6001\u76f4\u63a5 return\uff0c\u5199\u5165\u5931\u8d25\u8bbe\u7f6e\u4e3a\u5931\u8d25\u72b6\u6001"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseTable.remove(opaque)"}),"\uff1a\u5c06\u5f53\u524d\u8bf7\u6c42\u7684 responseFuture ",(0,l.jsx)(n.strong,{children:"\u4ece\u6620\u5c04\u8868\u79fb\u9664"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture.setCause(f.cause())"}),"\uff1a\u8bbe\u7f6e\u9519\u8bef\u7684\u4fe1\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture.putResponse(null)"}),"\uff1a\u54cd\u5e94 Command \u8bbe\u7f6e\u4e3a null"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseCommand = responseFuture.waitResponse(timeoutMillis)"}),"\uff1a\u5f53\u524d\u7ebf\u7a0b\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\u6302\u8d77\uff0c",(0,l.jsx)(n.strong,{children:"\u540c\u6b65\u7b49\u5f85\u54cd\u5e94"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (null == responseCommand)"}),"\uff1a\u8d85\u65f6\u6216\u8005\u51fa\u73b0\u5f02\u5e38\uff0c\u76f4\u63a5\u62a5\u9519"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"return responseCommand"}),"\uff1a\u8fd4\u56de\u54cd\u5e94 Command \u4fe1\u606f"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"invokeAsync()\uff1a\u5f02\u6b65\u8c03\u7528\uff0c\u6709\u56de\u8c03\u5bf9\u8c61\uff0c\u65e0\u8fd4\u56de\u503c"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean acquired = this.semaphoreAsync.tryAcquire(timeoutMillis, TimeUnit.MILLISECONDS)"}),"\uff1a\u83b7\u53d6\u4fe1\u53f7\u91cf\u7684\u8bb8\u53ef\u8bc1\uff0c\u4fe1\u53f7\u91cf\u7528\u6765",(0,l.jsx)(n.strong,{children:"\u9650\u5236\u5f02\u6b65\u8bf7\u6c42"}),"\u7684\u6570\u91cf"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (acquired)"}),"\uff1a\u8bb8\u53ef\u8bc1\u83b7\u53d6\u5931\u8d25\u8bf4\u660e\u5e76\u53d1\u8f83\u9ad8\uff0c\u4f1a\u629b\u51fa\u5f02\u5e38"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"once = new SemaphoreReleaseOnlyOnce(this.semaphoreAsync)"}),"\uff1aOnce \u5bf9\u8c61\u5c01\u88c5\u4e86\u91ca\u653e\u4fe1\u53f7\u91cf\u7684\u64cd\u4f5c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"costTime = System.currentTimeMillis() - beginStartTime"}),"\uff1a\u8ba1\u7b97\u4e00\u4e0b\u8017\u8d39\u7684\u65f6\u95f4\uff0c\u8d85\u65f6\u4e0d\u518d\u53d1\u8d77\u8bf7\u6c42"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture = new ResponseFuture()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u521b\u5efa\u54cd\u5e94\u5bf9\u8c61\uff0c\u5305\u88c5\u4e86\u56de\u8c03\u51fd\u6570\u548c Once \u5bf9\u8c61"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.responseTable.put(opaque, responseFuture)"}),"\uff1a\u52a0\u5165\u5230\u54cd\u5e94\u6620\u5c04\u8868\u4e2d\uff0ckey \u4e3a\u8bf7\u6c42 ID"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"channel.writeAndFlush(request).addListener(...)"}),"\uff1a\u5199\u5237\u6570\u636e\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (f.isSuccess())"}),"\uff1a\u5199\u5237\u6210\u529f\uff0c\u8bbe\u7f6e responseFuture \u53d1\u751f\u72b6\u6001\u4e3a true"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"requestFail(opaque)"}),"\uff1a\u5199\u5165\u5931\u8d25\uff0c\u4f7f\u7528 publicExecutor ",(0,l.jsx)(n.strong,{children:"\u516c\u5171\u7ebf\u7a0b\u6c60\u5f02\u6b65\u6267\u884c\u56de\u8c03\u5bf9\u8c61\u7684\u51fd\u6570"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture.release()"}),"\uff1a\u51fa\u73b0\u5f02\u5e38\u4f1a\u91ca\u653e\u4fe1\u53f7\u91cf"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"invokeOneway()\uff1a\u5355\u5411\u8c03\u7528\uff0c\u4e0d\u5173\u6ce8\u54cd\u5e94\u7ed3\u679c"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"request.markOnewayRPC()"}),"\uff1a\u8bbe\u7f6e\u5355\u5411\u6807\u8bb0\uff0c\u5bf9\u7aef\u68c0\u67e5\u6807\u8bb0\u53ef\u77e5\u8be5\u8bf7\u662f\u5355\u5411\u8bf7\u6c42"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean acquired = this.semaphoreOneway.tryAcquire(timeoutMillis, TimeUnit.MILLISECONDS)"}),"\uff1a\u83b7\u53d6\u4fe1\u53f7\u91cf\u7684\u8bb8\u53ef\u8bc1\uff0c\u4fe1\u53f7\u91cf\u7528\u6765",(0,l.jsx)(n.strong,{children:"\u9650\u5236\u5355\u5411\u8bf7\u6c42"}),"\u7684\u6570\u91cf"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5904\u7406\u5668\u7c7b",children:"\u5904\u7406\u5668\u7c7b"}),"\n",(0,l.jsx)(n.h5,{id:"\u534f\u8bae\u8bbe\u8ba1-1",children:"\u534f\u8bae\u8bbe\u8ba1"}),"\n",(0,l.jsx)(n.p,{children:"\u5728 Client \u548c Server \u4e4b\u95f4\u5b8c\u6210\u4e00\u6b21\u6d88\u606f\u53d1\u9001\u65f6\uff0c\u9700\u8981\u5bf9\u53d1\u9001\u7684\u6d88\u606f\u8fdb\u884c\u4e00\u4e2a\u534f\u8bae\u7ea6\u5b9a\uff0c\u6240\u4ee5\u81ea\u5b9a\u4e49 RocketMQ \u7684\u6d88\u606f\u534f\u8bae\u3002\u5728 RocketMQ \u4e2d\uff0c\u4e3a\u4e86\u9ad8\u6548\u5730\u5728\u7f51\u7edc\u4e2d\u4f20\u8f93\u6d88\u606f\u548c\u5bf9\u6536\u5230\u7684\u6d88\u606f\u8bfb\u53d6\uff0c\u5c31\u9700\u8981\u5bf9\u6d88\u606f\u8fdb\u884c\u7f16\u89e3\u7801\uff0cRemotingCommand \u8fd9\u4e2a\u7c7b\u5728\u6d88\u606f\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u5bf9\u6240\u6709\u6570\u636e\u5185\u5bb9\u7684\u5c01\u88c5\uff0c\u4e0d\u4f46\u5305\u542b\u4e86\u6240\u6709\u7684\u6570\u636e\u7ed3\u6784\uff0c\u8fd8\u5305\u542b\u4e86\u7f16\u7801\u89e3\u7801\u64cd\u4f5c"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Header\u5b57\u6bb5"}),(0,l.jsx)(n.th,{children:"\u7c7b\u578b"}),(0,l.jsx)(n.th,{children:"Request \u8bf4\u660e"}),(0,l.jsx)(n.th,{children:"Response \u8bf4\u660e"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"code"}),(0,l.jsx)(n.td,{children:"int"}),(0,l.jsx)(n.td,{children:"\u8bf7\u6c42\u64cd\u4f5c\u7801\uff0c\u5e94\u7b54\u65b9\u6839\u636e\u4e0d\u540c\u7684\u8bf7\u6c42\u7801\u8fdb\u884c\u4e0d\u540c\u7684\u5904\u7406"}),(0,l.jsx)(n.td,{children:"\u5e94\u7b54\u54cd\u5e94\u7801\uff0c0 \u8868\u793a\u6210\u529f\uff0c\u975e 0 \u5219\u8868\u793a\u5404\u79cd\u9519\u8bef"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"language"}),(0,l.jsx)(n.td,{children:"LanguageCode"}),(0,l.jsx)(n.td,{children:"\u8bf7\u6c42\u65b9\u5b9e\u73b0\u7684\u8bed\u8a00"}),(0,l.jsx)(n.td,{children:"\u5e94\u7b54\u65b9\u5b9e\u73b0\u7684\u8bed\u8a00"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"version"}),(0,l.jsx)(n.td,{children:"int"}),(0,l.jsx)(n.td,{children:"\u8bf7\u6c42\u65b9\u7a0b\u5e8f\u7684\u7248\u672c"}),(0,l.jsx)(n.td,{children:"\u5e94\u7b54\u65b9\u7a0b\u5e8f\u7684\u7248\u672c"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"opaque"}),(0,l.jsx)(n.td,{children:"int"}),(0,l.jsx)(n.td,{children:"\u76f8\u5f53\u4e8e requestId\uff0c\u5728\u540c\u4e00\u4e2a\u8fde\u63a5\u4e0a\u7684\u4e0d\u540c\u8bf7\u6c42\u6807\u8bc6\u7801\uff0c\u4e0e\u54cd\u5e94\u6d88\u606f\u4e2d\u7684\u76f8\u5bf9\u5e94"}),(0,l.jsx)(n.td,{children:"\u5e94\u7b54\u4e0d\u505a\u4fee\u6539\u76f4\u63a5\u8fd4\u56de"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"flag"}),(0,l.jsx)(n.td,{children:"int"}),(0,l.jsx)(n.td,{children:"\u533a\u5206\u662f\u666e\u901a RPC \u8fd8\u662f onewayRPC \u7684\u6807\u5fd7"}),(0,l.jsx)(n.td,{children:"\u533a\u5206\u662f\u666e\u901a RPC \u8fd8\u662f onewayRPC\u7684\u6807\u5fd7"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"remark"}),(0,l.jsx)(n.td,{children:"String"}),(0,l.jsx)(n.td,{children:"\u4f20\u8f93\u81ea\u5b9a\u4e49\u6587\u672c\u4fe1\u606f"}),(0,l.jsx)(n.td,{children:"\u4f20\u8f93\u81ea\u5b9a\u4e49\u6587\u672c\u4fe1\u606f"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"extFields"}),(0,l.jsx)(n.td,{children:"HashMap<String, String>"}),(0,l.jsx)(n.td,{children:"\u8bf7\u6c42\u81ea\u5b9a\u4e49\u6269\u5c55\u4fe1\u606f"}),(0,l.jsx)(n.td,{children:"\u54cd\u5e94\u81ea\u5b9a\u4e49\u6269\u5c55\u4fe1\u606f"})]})]})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(14313).A+"",width:"619",height:"73"})}),"\n",(0,l.jsx)(n.p,{children:"\u4f20\u8f93\u5185\u5bb9\u4e3b\u8981\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u56db\u90e8\u5206\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u957f\u5ea6\uff1a\u603b\u957f\u5ea6\uff0c\u56db\u4e2a\u5b57\u8282\u5b58\u50a8\uff0c\u5360\u7528\u4e00\u4e2a int \u7c7b\u578b"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5e8f\u5217\u5316\u7c7b\u578b&\u6d88\u606f\u5934\u957f\u5ea6\uff1a\u540c\u6837\u5360\u7528\u4e00\u4e2a int \u7c7b\u578b\uff0c\u7b2c\u4e00\u4e2a\u5b57\u8282\u8868\u793a\u5e8f\u5217\u5316\u7c7b\u578b\uff0c\u540e\u9762\u4e09\u4e2a\u5b57\u8282\u8868\u793a\u6d88\u606f\u5934\u957f\u5ea6"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u5934\u6570\u636e\uff1a\u7ecf\u8fc7\u5e8f\u5217\u5316\u540e\u7684\u6d88\u606f\u5934\u6570\u636e"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u4e3b\u4f53\u6570\u636e\uff1a\u6d88\u606f\u4e3b\u4f53\u7684\u4e8c\u8fdb\u5236\u5b57\u8282\u6570\u636e\u5185\u5bb9"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5b98\u65b9\u6587\u6863\uff1a",(0,l.jsx)(n.a,{href:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md",children:"https://github.com/apache/rocketmq/blob/master/docs/cn/design.md"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5904\u7406\u65b9\u6cd5",children:"\u5904\u7406\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.p,{children:["NettyServerHandler \u7c7b\u7528\u6765\u5904\u7406 Channel \u4e0a\u7684\u4e8b\u4ef6\uff0c\u5728 NettyRemotingServer \u542f\u52a8\u65f6\u6ce8\u518c\u5230 Netty \u4e2d\uff0c\u53ef\u4ee5\u5904\u7406 RemotingCommand \u76f8\u5173\u7684\u6570\u636e\uff0c\u9488\u5bf9\u67d0\u4e00\u79cd\u7c7b\u578b\u7684",(0,l.jsx)(n.strong,{children:"\u8bf7\u6c42\u5904\u7406"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"class NettyServerHandler extends SimpleChannelInboundHandler<RemotingCommand> {\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, RemotingCommand msg) throws Exception {\n        // \u670d\u52a1\u5668\u5904\u7406\u63a5\u53d7\u5230\u7684\u8bf7\u6c42\u4fe1\u606f\n        processMessageReceived(ctx, msg);\n    }\n}\npublic void processMessageReceived(ChannelHandlerContext ctx, RemotingCommand msg) throws Exception {\n    final RemotingCommand cmd = msg;\n    if (cmd != null) {\n\t\t// \u6839\u636e\u8bf7\u6c42\u7684\u7c7b\u578b\u8fdb\u884c\u5904\u7406\n        switch (cmd.getType()) {\n            case REQUEST_COMMAND:// \u5ba2\u6237\u7aef\u53d1\u8d77\u7684\u8bf7\u6c42\uff0c\u8d70\u8fd9\u91cc\n                processRequestCommand(ctx, cmd);\n                break;\n            case RESPONSE_COMMAND:// \u5ba2\u6237\u7aef\u54cd\u5e94\u7684\u6570\u636e\uff0c\u8d70\u8fd9\u91cc\u3010\u5f53\u524d\u7c7b\u672c\u8eab\u662f\u670d\u52a1\u5668\u7c7b\u4e5f\u662f\u5ba2\u6237\u7aef\u7c7b\u3011\n                processResponseCommand(ctx, cmd);\n                break;\n            default:\n                break;\n        }\n    }\n}\n"})}),"\n",(0,l.jsxs)(n.p,{children:["NettyRemotingAbstract#processRequestCommand\uff1a",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u8bf7\u6c42\u7684\u6570\u636e"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"matched = this.processorTable.get(cmd.getCode())"}),"\uff1a\u6839\u636e\u4e1a\u52a1\u8bf7\u6c42\u7801\u83b7\u53d6 Pair \u5bf9\u8c61\uff0c\u5305\u542b",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u5668\u548c\u7ebf\u7a0b\u6c60\u8d44\u6e90"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pair = null == matched ? this.defaultRequestProcessor : matched"}),"\uff1a\u672a\u627e\u5230\u5904\u7406\u5668\u5219\u4f7f\u7528\u7f3a\u7701\u5904\u7406\u5668"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int opaque = cmd.getOpaque()"}),"\uff1a\u83b7\u53d6\u8bf7\u6c42 ID"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Runnable run = new Runnable()"}),"\uff1a\u521b\u5efa\u4efb\u52a1\u5bf9\u8c61\uff0c\u4efb\u52a1\u5728\u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\u540e\u5f00\u59cb\u6267\u884c"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"doBeforeRpcHooks()"}),"\uff1aRPC HOOK \u524d\u7f6e\u5904\u7406"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"callback = new RemotingResponseCallback()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c01\u88c5\u54cd\u5e94\u5ba2\u6237\u7aef\u7684\u903b\u8f91"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"doAfterRpcHooks()"}),"\uff1aRPC HOOK \u540e\u7f6e\u5904\u7406"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (!cmd.isOnewayRPC())"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u4e0d\u662f\u5355\u5411\u8bf7\u6c42\uff0c\u9700\u8981\u7ed3\u679c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"response.setOpaque(opaque)"}),"\uff1a\u5c06\u8bf7\u6c42 ID \u8bbe\u7f6e\u5230 response"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"response.markResponseType()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8bbe\u7f6e\u5f53\u524d\u8bf7\u6c42\u662f\u54cd\u5e94"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ctx.writeAndFlush(response)"}),"\uff1a ",(0,l.jsx)(n.strong,{children:"\u5c06\u54cd\u5e94\u6570\u636e\u4ea4\u7ed9 Netty IO \u7ebf\u7a0b\uff0c\u5b8c\u6210\u6570\u636e\u5199\u548c\u5237"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (pair.getObject1() instanceof AsyncNettyRequestProcessor)"}),"\uff1aNameserver \u9ed8\u8ba4\u4f7f\u7528 DefaultRequestProcessor \u5904\u7406\u5668\uff0c\u662f\u4e00\u4e2a AsyncNettyRequestProcessor \u5b50\u7c7b"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"processor = (AsyncNettyRequestProcessor)pair.getObject1()"}),"\uff1a\u83b7\u53d6\u5904\u7406\u5668"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"processor.asyncProcessRequest(ctx, cmd, callback)"}),"\uff1a\u5f02\u6b65\u8c03\u7528\uff0c\u9996\u5148 processRequest\uff0c\u7136\u540e callback \u54cd\u5e94\u5ba2\u6237\u7aef"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultRequestProcessor.processRequest"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6839\u636e\u4e1a\u52a1\u7801\u5904\u7406\u8bf7\u6c42\uff0c\u6267\u884c\u5bf9\u5e94\u7684\u64cd\u4f5c"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ClientRemotingProcessor.processRequest"}),"\uff1a\u5904\u7406\u4e8b\u52a1\u56de\u67e5\u6d88\u606f\uff0c\u6216\u8005\u56de\u6267\u6d88\u606f\uff0c\u9700\u8981\u6d88\u8d39\u8005\u56de\u6267\u4e00\u6761\u6d88\u606f\u7ed9\u751f\u4ea7\u8005"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"requestTask = new RequestTask(run, ctx.channel(), cmd)"}),"\uff1a\u5c06\u4efb\u52a1\u5bf9\u8c61\u3001\u901a\u9053\u3001\u8bf7\u6c42\u5c01\u88c5\u6210 RequestTask \u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pair.getObject2().submit(requestTask)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u5904\u7406\u5668\u5bf9\u5e94\u7684\u7ebf\u7a0b\u6c60\uff0c\u5c06 task \u63d0\u4ea4\uff0c\u4ece IO \u7ebf\u7a0b\u5207\u6362\u5230\u4e1a\u52a1\u7ebf\u7a0b"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["NettyRemotingAbstract#processResponseCommand\uff1a",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u54cd\u5e94\u7684\u6570\u636e"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int opaque = cmd.getOpaque()"}),"\uff1a\u83b7\u53d6\u8bf7\u6c42 ID"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture = responseTable.get(opaque)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4ece\u54cd\u5e94\u6620\u5c04\u8868\u4e2d\u83b7\u53d6\u5bf9\u5e94\u7684\u5bf9\u8c61"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture.setResponseCommand(cmd)"}),"\uff1a\u8bbe\u7f6e\u54cd\u5e94\u7684 Command \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseTable.remove(opaque)"}),"\uff1a\u4ece\u6620\u5c04\u8868\u4e2d\u79fb\u9664\u5bf9\u8c61\uff0c\u4ee3\u8868\u5904\u7406\u5b8c\u6210"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (responseFuture.getInvokeCallback() != null)"}),"\uff1a\u5305\u542b\u56de\u8c03\u5bf9\u8c61\uff0c\u5f02\u6b65\u6267\u884c\u56de\u8c03\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"responseFuture.putResponse(cmd)"}),"\uff1a\u4e0d\u5305\u542b\u56de\u8c03\u5bf9\u8c61\uff0c",(0,l.jsx)(n.strong,{children:"\u540c\u6b65\u8c03\u7528\u65f6\uff0c\u5524\u9192\u7b49\u5f85\u7684\u4e1a\u52a1\u7ebf\u7a0b"})]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6d41\u7a0b\uff1a\u5ba2\u6237\u7aef invokeSync \u2192 \u670d\u52a1\u5668\u7684 processRequestCommand \u2192 \u5ba2\u6237\u7aef\u7684 processResponseCommand \u2192 \u7ed3\u675f"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u8def\u7531\u4fe1\u606f",children:"\u8def\u7531\u4fe1\u606f"}),"\n",(0,l.jsx)(n.h5,{id:"\u4fe1\u606f\u7ba1\u7406",children:"\u4fe1\u606f\u7ba1\u7406"}),"\n",(0,l.jsx)(n.p,{children:"RouteInfoManager \u7c7b\u8d1f\u8d23\u7ba1\u7406\u8def\u7531\u4fe1\u606f\uff0cNamesrvController \u7684\u6784\u9020\u65b9\u6cd5\u4e2d\u521b\u5efa\u8be5\u7c7b\u7684\u5b9e\u4f8b\u5bf9\u8c61\uff0c\u7ba1\u7406\u670d\u52a1\u7aef\u7684\u8def\u7531\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class RouteInfoManager {\n    // Broker \u4e24\u4e2a\u5c0f\u65f6\u4e0d\u6d3b\u8dc3\uff0c\u89c6\u4e3a\u79bb\u7ebf\uff0c\u88ab\u5b9a\u65f6\u4efb\u52a1\u5220\u9664\n    private final static long BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;\n    // \u8bfb\u5199\u9501\uff0c\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168\n    private final ReadWriteLock lock = new ReentrantReadWriteLock();\n    // \u4e3b\u9898\u961f\u5217\u6570\u636e\uff0c\u4e00\u4e2a\u4e3b\u9898\u5bf9\u5e94\u591a\u4e2a\u961f\u5217\n    private final HashMap<String/* topic */, List<QueueData>> topicQueueTable;\n    // Broker \u6570\u636e\u5217\u8868\n    private final HashMap<String/* brokerName */, BrokerData> brokerAddrTable;\n    // \u96c6\u7fa4\n    private final HashMap<String/* clusterName */, Set<String/* brokerName */>> clusterAddrTable;\n    // Broker \u5b58\u6d3b\u4fe1\u606f\n    private final HashMap<String/* brokerAddr */, BrokerLiveInfo> brokerLiveTable;\n    // \u670d\u52a1\u8fc7\u6ee4\n    private final HashMap<String/* brokerAddr */, List<String>/* Filter Server */> filterServerTable;\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u8def\u7531\u6ce8\u518c",children:"\u8def\u7531\u6ce8\u518c"}),"\n",(0,l.jsx)(n.p,{children:"DefaultRequestProcessor REGISTER_BROKER \u65b9\u6cd5\u89e3\u6790\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public RemotingCommand registerBroker(ChannelHandlerContext ctx, RemotingCommand request) {\n    // \u521b\u5efa\u54cd\u5e94\u8bf7\u6c42\u7684\u5bf9\u8c61\uff0c\u8bbe\u7f6e\u4e3a\u54cd\u5e94\u7c7b\u578b\uff0c\u3010\u5148\u8bbe\u7f6e\u54cd\u5e94\u7684\u72b6\u6001\u7801\u65f6\u7cfb\u7edf\u9519\u8bef\u7801\u3011\n    // \u53cd\u5c04\u521b\u5efa RegisterBrokerResponseHeader \u5bf9\u8c61\u8bbe\u7f6e\u5230 response.customHeader \u5c5e\u6027\u4e2d\n    final RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);\n\n    // \u83b7\u53d6\u51fa\u53cd\u5c04\u521b\u5efa\u7684 RegisterBrokerResponseHeader \u7528\u6237\u81ea\u5b9a\u4e49header\u5bf9\u8c61\u3002\n    final RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader();\n\n    // \u53cd\u5c04\u521b\u5efa RegisterBrokerRequestHeader \u5bf9\u8c61\uff0c\u5e76\u4e14\u5c06 request.extFields \u4e2d\u7684\u6570\u636e\u5199\u5165\u5230\u8be5\u5bf9\u8c61\u4e2d\n    final RegisterBrokerRequestHeader requestHeader = request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);\n\n    // CRC \u6821\u9a8c\uff0c\u8ba1\u7b97\u8bf7\u6c42\u4e2d\u7684 CRC \u503c\u548c\u8bf7\u6c42\u5934\u4e2d\u5305\u542b\u7684\u662f\u5426\u4e00\u81f4\n    if (!checksum(ctx, request, requestHeader)) {\n        response.setCode(ResponseCode.SYSTEM_ERROR);\n        response.setRemark("crc32 not match");\n        return response;\n    }\n\n    TopicConfigSerializeWrapper topicConfigWrapper;\n    if (request.getBody() != null) {\n        // \u3010\u89e3\u6790\u8bf7\u6c42\u4f53 body\u3011\uff0c\u89e3\u7801\u51fa\u6765\u7684\u6570\u636e\u5c31\u662f\u5f53\u524d\u673a\u5668\u7684\u4e3b\u9898\u4fe1\u606f\n        topicConfigWrapper = TopicConfigSerializeWrapper.decode(request.getBody(), TopicConfigSerializeWrapper.class);\n    } else {\n        topicConfigWrapper = new TopicConfigSerializeWrapper();\n        topicConfigWrapper.getDataVersion().setCounter(new AtomicLong(0));\n        topicConfigWrapper.getDataVersion().setTimestamp(0);\n    }\n\n    // \u6ce8\u518c\u65b9\u6cd5\n    // \u53c2\u65701 \u96c6\u7fa4\u3001\u53c2\u65702\uff1a\u8282\u70b9ip\u5730\u5740\u3001\u53c2\u65703\uff1abrokerName\u3001\u53c2\u65704\uff1abrokerId \u6ce8\u610fbrokerId=0\u7684\u8282\u70b9\u4e3a\u4e3b\u8282\u70b9\n    // \u53c2\u65705\uff1aha\u8282\u70b9ip\u5730\u5740\u3001\u53c2\u65706\u5f53\u524d\u8282\u70b9\u4e3b\u9898\u4fe1\u606f\u3001\u53c2\u65707\uff1a\u8fc7\u6ee4\u670d\u52a1\u5668\u5217\u8868\u3001\u53c2\u65708\uff1a\u5f53\u524d\u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef\u901a\u4fe1\u7684channel\n    RegisterBrokerResult result = this.namesrvController.getRouteInfoManager().registerBroker(..);\n\n    // \u5c06\u7ed3\u679c\u4fe1\u606f \u5199\u5230 responseHeader \u4e2d\n    responseHeader.setHaServerAddr(result.getHaServerAddr());\n    responseHeader.setMasterAddr(result.getMasterAddr());\n    // \u83b7\u53d6 kv\u914d\u7f6e\uff0c\u5199\u5165 response body \u4e2d\uff0c\u3010kv \u914d\u7f6e\u662f\u987a\u5e8f\u6d88\u606f\u76f8\u5173\u7684\u3011\n    byte[] jsonValue = this.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC);\n    response.setBody(jsonValue);\n\n    // code \u8bbe\u7f6e\u4e3a SUCCESS\n    response.setCode(ResponseCode.SUCCESS);\n    response.setRemark(null);\n\t// \u8fd4\u56de response \uff0c\u3010\u8fd4\u56de\u7684 response \u7531 callback \u5bf9\u8c61\u5904\u7406\u3011\n    return response;\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"RouteInfoManager#registerBroker\uff1a\u6ce8\u518c Broker \u7684\u4fe1\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"RegisterBrokerResult result = new RegisterBrokerResult()"}),"\uff1a\u8fd4\u56de\u7ed3\u679c\u7684\u5c01\u88c5\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.lock.writeLock().lockInterruptibly()"}),"\uff1a\u52a0\u5199\u9501\u540e",(0,l.jsx)(n.strong,{children:"\u540c\u6b65\u6267\u884c"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"brokerNames = this.clusterAddrTable.get(clusterName)"}),"\uff1a\u83b7\u53d6\u5f53\u524d\u96c6\u7fa4\u4e0a\u7684 Broker \u540d\u79f0\u5217\u8868\uff0c\u662f\u7a7a\u5c31\u65b0\u5efa\u5217\u8868"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"brokerNames.add(brokerName)"}),"\uff1a\u5c06\u5f53\u524d Broker \u540d\u5b57\u52a0\u5165\u5230\u96c6\u7fa4\u5217\u8868"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"brokerData = this.brokerAddrTable.get(brokerName)"}),"\uff1a\u83b7\u53d6\u5f53\u524d Broker \u7684 brokerData\uff0c\u662f\u7a7a\u5c31\u65b0\u5efa\u653e\u5165\u6620\u5c04\u8868"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"brokerAddrsMap = brokerData.getBrokerAddrs()"}),"\uff1a\u83b7\u53d6\u5f53\u524d Broker \u7684\u7269\u7406\u8282\u70b9 map \u8868\uff0c\u8fdb\u884c\u904d\u5386\uff0c\u5982\u679c\u7269\u7406\u8282\u70b9\u89d2\u8272\u53d1\u751f\u53d8\u5316\uff08slave \u2192 master\uff09\uff0c\u5148\u5c06\u65e7\u6570\u636e\u4ece\u7269\u7406\u8282\u70b9 map \u4e2d\u79fb\u9664\uff0c\u7136\u540e\u91cd\u5199\u653e\u5165\uff0c",(0,l.jsx)(n.strong,{children:"\u4fdd\u8bc1\u8282\u70b9\u7684\u552f\u4e00\u6027"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null != topicConfigWrapper && MixAll.MASTER_ID == brokerId)"}),"\uff1aBroker \u4e0a\u7684 Topic \u4e0d\u4e3a null\uff0c\u5e76\u4e14\u5f53\u524d\u7269\u7406\u8282\u70b9\u662f  Broker \u4e0a\u7684 master \u8282\u70b9"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"tcTable = topicConfigWrapper.getTopicConfigTable()"}),"\uff1a\u83b7\u53d6\u5f53\u524d Broker \u4fe1\u606f\u4e2d\u7684\u4e3b\u9898\u6620\u5c04\u8868"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (tcTable != null)"}),"\uff1a\u6620\u5c04\u8868\u4e0d\u7a7a\u5c31\u52a0\u5165\u6216\u8005\u66f4\u65b0\u5230 Namesrv \u5185"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:" prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr)"}),"\uff1a\u6dfb\u52a0",(0,l.jsx)(n.strong,{children:"\u5f53\u524d\u8282\u70b9\u7684 BrokerLiveInfo"})," \uff0c\u8fd4\u56de\u4e0a\u4e00\u6b21\u5fc3\u8df3\u65f6\u5f53\u524d Broker \u8282\u70b9\u7684\u5b58\u6d3b\u5bf9\u8c61\u6570\u636e\u3002",(0,l.jsx)(n.strong,{children:"NamesrvController  \u4e2d\u7684\u5b9a\u65f6\u4efb\u52a1\u4f1a\u626b\u63cf\u6620\u5c04\u8868 brokerLiveTable"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"BrokerLiveInfo prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr, new BrokerLiveInfo(\n    System.currentTimeMillis(),topicConfigWrapper.getDataVersion(), channel,haServerAddr));\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (MixAll.MASTER_ID != brokerId)"}),"\uff1a\u5f53\u524d Broker \u4e0d\u662f master \u8282\u70b9\uff0c",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u4e3b\u8282\u70b9\u7684\u4fe1\u606f"}),"\u8bbe\u7f6e\u5230\u7ed3\u679c\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.lock.writeLock().unlock()"}),"\uff1a\u91ca\u653e\u5199\u9501"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"broker",children:"Broker"}),"\n",(0,l.jsx)(n.h4,{id:"mappedfile",children:"MappedFile"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-1",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsxs)(n.p,{children:["MappedFile \u7c7b\u662f\u6700\u57fa\u7840\u7684\u5b58\u50a8\u7c7b\uff0c\u7ee7\u627f\u81ea ReferenceResource \u7c7b\uff0c\u7528\u6765",(0,l.jsx)(n.strong,{children:"\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168"})]}),"\n",(0,l.jsx)(n.p,{children:"MappedFile \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5185\u5b58\u76f8\u5173\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public static final int OS_PAGE_SIZE = 1024 * 4;// \u5185\u5b58\u9875\u5927\u5c0f\uff1a\u9ed8\u8ba4\u662f 4k\nprivate AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY;\t// \u5f53\u524d\u8fdb\u7a0b\u4e0b\u6240\u6709\u7684 mappedFile \u5360\u7528\u7684\u603b\u865a\u62df\u5185\u5b58\u5927\u5c0f\nprivate AtomicInteger TOTAL_MAPPED_FILES;\t\t// \u5f53\u524d\u8fdb\u7a0b\u4e0b\u6240\u6709\u7684 mappedFile \u4e2a\u6570\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u4f4d\u70b9\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final AtomicInteger wrotePosition;\t// \u5f53\u524d mappedFile \u7684\u6570\u636e\u5199\u5165\u70b9\nprotected final AtomicInteger committedPosition;// \u5f53\u524d mappedFile \u7684\u6570\u636e\u63d0\u4ea4\u70b9\nprivate final AtomicInteger flushedPosition;\t// \u6570\u636e\u843d\u76d8\u4f4d\u70b9\uff0c\u5728\u8fd9\u4e4b\u524d\u7684\u6570\u636e\u662f\u6301\u4e45\u5316\u7684\u5b89\u5168\u6570\u636e\n\t\t\t\t\t\t\t\t\t\t\t\t// flushedPosition-wrotePosition \u4e4b\u95f4\u7684\u6570\u636e\u5c5e\u4e8e\u810f\u9875\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6587\u4ef6\u76f8\u5173\uff1aCL \u662f CommitLog\uff0cCQ \u662f ConsumeQueue"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private String fileName;\t// \u6587\u4ef6\u540d\u79f0\uff0cCL\u548cCQ\u6587\u4ef6\u540d\u662f\u3010\u7b2c\u4e00\u6761\u6d88\u606f\u7684\u7269\u7406\u504f\u79fb\u91cf\u3011\uff0c\u7d22\u5f15\u6587\u4ef6\u662f\u3010\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u3011\nprivate long fileFromOffset;// \u6587\u4ef6\u540d\u8f6clong\uff0c\u4ee3\u8868\u8be5\u5bf9\u8c61\u7684\u3010\u8d77\u59cb\u504f\u79fb\u91cf\u3011\t\nprivate File file;\t\t\t// \u6587\u4ef6\u5bf9\u8c61\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"MF \u4e2d\u4ee5\u7269\u7406\u504f\u79fb\u91cf\u4f5c\u4e3a\u6587\u4ef6\u540d\uff0c\u53ef\u4ee5\u66f4\u597d\u7684\u5bfb\u5740\u548c\u8fdb\u884c\u5224\u65ad"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5185\u5b58\u6620\u5c04\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected FileChannel fileChannel;\t\t\t// \u6587\u4ef6\u901a\u9053\nprivate MappedByteBuffer mappedByteBuffer;\t// \u5185\u5b58\u6620\u5c04\u7f13\u51b2\u533a\uff0c\u8bbf\u95ee\u865a\u62df\u5185\u5b58\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"ReferenceResource \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5f15\u7528\u6570\u91cf\uff1a\u5f53 ",(0,l.jsx)(n.code,{children:"refCount <= 0"})," \u65f6\uff0c\u8868\u793a\u8be5\u8d44\u6e90\u53ef\u4ee5\u91ca\u653e\u4e86\uff0c\u6ca1\u6709\u4efb\u4f55\u5176\u4ed6\u7a0b\u5e8f\u4f9d\u8d56\u5b83\u4e86\uff0c\u7528\u539f\u5b50\u7c7b\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final AtomicLong refCount = new AtomicLong(1);\t// \u521d\u59cb\u503c\u4e3a 1\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b58\u6d3b\u72b6\u6001\uff1a\u8868\u793a\u8d44\u6e90\u7684\u5b58\u6d3b\u72b6\u6001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected volatile boolean available = true;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u662f\u5426\u6e05\u7406\uff1a\u9ed8\u8ba4\u503c false\uff0c\u5f53\u6267\u884c\u5b8c\u5b50\u7c7b\u5bf9\u8c61\u7684 cleanup() \u6e05\u7406\u65b9\u6cd5\u540e\uff0c\u8be5\u503c\u7f6e\u4e3a true \uff0c\u8868\u793a\u8d44\u6e90\u5df2\u7ecf\u5168\u90e8\u91ca\u653e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected volatile boolean cleanupOver = false;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7b2c\u4e00\u6b21\u5173\u95ed\u8d44\u6e90\u7684\u65f6\u95f4\uff1a\u7528\u6765\u8bb0\u5f55\u8d85\u65f6\u65f6\u95f4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile long firstShutdownTimestamp = 0;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"MappedFile \u7c7b\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"appendMessage()\uff1a\u63d0\u4f9b\u4e0a\u5c42\u5411\u5185\u5b58\u6620\u5c04\u4e2d\u8ffd\u52a0\u6d88\u606f\u7684\u65b9\u6cd5\uff0c\u6d88\u606f\u5982\u4f55\u8ffd\u52a0\u7531 AppendMessageCallback \u63a7\u5236"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u6d88\u606f     \u53c2\u6570\u4e8c\uff1a\u8ffd\u52a0\u6d88\u606f\u56de\u8c03\npublic AppendMessageResult appendMessage(MessageExtBrokerInner msg, AppendMessageCallback cb)\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u5c06\u5b57\u8282\u6570\u7ec4\u5199\u5165\u5230\u6587\u4ef6\u901a\u9053\npublic boolean appendMessage(final byte[] data)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"flush()\uff1a\u5237\u76d8\u63a5\u53e3\uff0c\u53c2\u6570 flushLeastPages  \u4ee3\u8868\u5237\u76d8\u7684\u6700\u5c0f\u9875\u6570 \uff0c\u7b49\u4e8e 0 \u65f6\u5c5e\u4e8e\u5f3a\u5236\u5237\u76d8\uff1b> 0 \u65f6\u9700\u8981\u810f\u9875\uff08\u8ba1\u7b97\u65b9\u6cd5\u5728\u6570\u636e\u4f4d\u70b9\uff09\u8fbe\u5230\u8be5\u503c\u624d\u8fdb\u884c\u7269\u7406\u5237\u76d8\uff1b\u6587\u4ef6\u5199\u6ee1\u65f6\u5f3a\u5236\u5237\u76d8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public int flush(final int flushLeastPages)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"selectMappedBuffer()\uff1a\u8be5\u65b9\u6cd5\u4ee5 pos \u4e3a\u5f00\u59cb\u4f4d\u70b9 \uff0c\u5230\u6709\u6548\u6570\u636e\u4e3a\u6b62\uff0c\u521b\u5efa\u4e00\u4e2a\u5207\u7247 ByteBuffer \u4f5c\u4e3a\u6570\u636e\u526f\u672c\uff0c\u4f9b\u4e1a\u52a1\u8bbf\u95ee\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public SelectMappedBufferResult selectMappedBuffer(int pos)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"destroy()\uff1a\u9500\u6bc1\u6620\u5c04\u6587\u4ef6\u5bf9\u8c61\uff0c\u5e76\u5220\u9664\u5173\u8054\u7684\u7cfb\u7edf\u6587\u4ef6\uff0c\u53c2\u6570\u662f\u5f3a\u5236\u5173\u95ed\u8d44\u6e90\u7684\u65f6\u95f4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean destroy(final long intervalForcibly)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["cleanup()\uff1a",(0,l.jsx)(n.strong,{children:"\u91ca\u653e\u5806\u5916\u5185\u5b58"}),"\uff0c\u66f4\u65b0\u603b\u865a\u62df\u5185\u5b58\u548c\u603b\u5185\u5b58\u6620\u5c04\u6587\u4ef6\u6570"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean cleanup(final long currentRef)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["warmMappedFile()\uff1a\u5185\u5b58\u9884\u70ed\uff0c\u5f53\u8981\u65b0\u5efa\u7684 MappedFile \u5bf9\u8c61\u5927\u4e8e 1g \u65f6\u6267\u884c\u8be5\u65b9\u6cd5\u3002mappedByteBuffer \u5df2\u7ecf\u901a\u8fc7mmap\u6620\u5c04\uff0c\u6b64\u65f6\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u53ea\u662f\u8bb0\u5f55\u4e86\u8be5\u6587\u4ef6\u548c\u8be5 Buffer \u7684\u6620\u5c04\u5173\u7cfb\uff0c\u800c\u5e76\u6ca1\u6709\u6620\u5c04\u5230\u7269\u7406\u5185\u5b58\u4e2d\uff0c\u5bf9\u8be5 MappedFile \u7684\u6bcf\u4e2a Page Cache \u8fdb\u884c\u5199\u5165\u4e00\u4e2a\u5b57\u8282\u5206\u914d\u5185\u5b58\uff0c",(0,l.jsx)(n.strong,{children:"\u5c06\u6620\u5c04\u6587\u4ef6\u5168\u90e8\u52a0\u8f7d\u5230\u5185\u5b58"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void warmMappedFile(FlushDiskType type, int pages)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"mlock()\uff1a\u9501\u4f4f\u6307\u5b9a\u7684\u5185\u5b58\u533a\u57df\u907f\u514d\u88ab\u64cd\u4f5c\u7cfb\u7edf\u8c03\u5230 swap \u7a7a\u95f4\uff0c\u51cf\u5c11\u4e86\u7f3a\u9875\u5f02\u5e38\u7684\u4ea7\u751f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void mlock()\n"})}),"\n",(0,l.jsxs)(n.p,{children:["swap space \u662f\u78c1\u76d8\u4e0a\u7684\u4e00\u5757\u533a\u57df\uff0c\u53ef\u4ee5\u662f\u4e00\u4e2a\u5206\u533a\u6216\u8005\u4e00\u4e2a\u6587\u4ef6\u6216\u8005\u662f\u7ec4\u5408\u3002\u5f53\u7cfb\u7edf\u7269\u7406\u5185\u5b58\u4e0d\u8db3\u65f6\uff0cLinux \u4f1a\u5c06\u5185\u5b58\u4e2d\u4e0d\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u4fdd\u5b58\u5230 swap \u533a\u57df\u4e0a\uff0c\u8fd9\u6837\u7cfb\u7edf\u5c31\u53ef\u4ee5\u6709\u66f4\u591a\u7684\u7269\u7406\u5185\u5b58\u4e3a\u5404\u4e2a\u8fdb\u7a0b\u670d\u52a1\uff0c\u800c\u5f53\u7cfb\u7edf\u9700\u8981\u8bbf\u95ee swap \u4e0a\u5b58\u50a8\u7684\u5185\u5bb9\u65f6\uff0c\u9700\u8981\u901a\u8fc7",(0,l.jsx)(n.strong,{children:"\u7f3a\u9875\u4e2d\u65ad"}),"\u5c06 swap \u4e0a\u7684\u6570\u636e\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"ReferenceResource \u7c7b\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"hold()\uff1a\u589e\u52a0\u5f15\u7528\u8bb0\u6570 refCount\uff0c\u65b9\u6cd5\u52a0\u9501"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public synchronized boolean hold()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"shutdown()\uff1a\u5173\u95ed\u8d44\u6e90\uff0c\u53c2\u6570\u4ee3\u8868\u5f3a\u5236\u5173\u95ed\u8d44\u6e90\u7684\u65f6\u95f4\u95f4\u9694"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u7cfb\u7edf\u5f53\u524d\u65f6\u95f4 - firstShutdownTimestamp \u65f6\u95f4  > intervalForcibly \u8fdb\u884c\u3010\u5f3a\u5236\u5173\u95ed\u3011\npublic void shutdown(final long intervalForcibly)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"release()\uff1a\u5f15\u7528\u8ba1\u6570\u51cf 1\uff0c\u5f53 refCount  \u4e3a 0 \u65f6\uff0c\u8c03\u7528\u5b50\u7c7b\u7684 cleanup \u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void release()\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"mapqueue",children:"MapQueue"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-2",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"MappedFileQueue \u7528\u6765\u7ba1\u7406 MappedFile \u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u7ba1\u7406\u76ee\u5f55\uff1aCommitLog \u662f ",(0,l.jsx)(n.code,{children:"../store/commitlog"}),"\uff0c ConsumeQueue \u662f ",(0,l.jsx)(n.code,{children:"../store/xxx_topic/0"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final String storePath;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6587\u4ef6\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final int mappedFileSize;\t// \u76ee\u5f55\u4e0b\u6bcf\u4e2a\u6587\u4ef6\u5927\u5c0f\uff0cCL\u6587\u4ef6\u9ed8\u8ba4 1g\uff0cCQ\u6587\u4ef6 \u9ed8\u8ba4 600w\u5b57\u8282\nprivate final CopyOnWriteArrayList<MappedFile> mappedFiles;\t//\u76ee\u5f55\u4e0b\u7684\u6bcf\u4e2a mappedFile \u90fd\u52a0\u5165\u8be5\u96c6\u5408\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u4f4d\u70b9\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private long flushedWhere = 0;\t\t// \u76ee\u5f55\u7684\u5237\u76d8\u4f4d\u70b9\uff0c\u503c\u4e3a mf.fileName + mf.wrotePosition\nprivate long committedWhere = 0;\t// \u76ee\u5f55\u7684\u63d0\u4ea4\u4f4d\u70b9\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u5b58\u50a8\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile long storeTimestamp = 0;\t// \u5f53\u524d\u76ee\u5f55\u4e0b\u6700\u540e\u4e00\u6761 msg \u7684\u5b58\u50a8\u65f6\u95f4\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa\u670d\u52a1\uff1a\u65b0\u5efa MappedFile \u5b9e\u4f8b\uff0c\u7ee7\u627f\u81ea ServiceThread \u662f\u4e00\u4e2a\u4efb\u52a1\u5bf9\u8c61\uff0crun \u65b9\u6cd5\u7528\u6765\u521b\u5efa\u5b9e\u4f8b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final AllocateMappedFileService allocateMappedFileService;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-1",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"load()\uff1aBroker \u542f\u52a8\u65f6\uff0c\u52a0\u8f7d\u672c\u5730\u78c1\u76d8\u6570\u636e\uff0c\u8be5\u65b9\u6cd5\u8bfb\u53d6 storePath \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff0c\u521b\u5efa MappedFile \u5bf9\u8c61\u653e\u5165\u96c6\u5408\u5185"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean load()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"getLastMappedFile()\uff1a\u83b7\u53d6\u5f53\u524d\u6b63\u5728\u987a\u5e8f\u5199\u5165\u7684 MappedFile \u5bf9\u8c61\uff0c\u5982\u679c\u6700\u540e\u4e00\u4e2a MappedFile \u5199\u6ee1\u4e86\uff0c\u6216\u8005\u4e0d\u5b58\u5728 MappedFile \u5bf9\u8c61\uff0c\u5219\u521b\u5efa\u65b0\u7684 MappedFile"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u6587\u4ef6\u8d77\u59cb\u504f\u79fb\u91cf\uff1b\u53c2\u6570\u4e8c\uff1a\u5f53list\u4e3a\u7a7a\u65f6\uff0c\u662f\u5426\u65b0\u5efa MappedFile\npublic MappedFile getLastMappedFile(final long startOffset, boolean needCreate)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"flush()\uff1a\u6839\u636e flushedWhere \u5c5e\u6027\u67e5\u627e\u5408\u9002\u7684 MappedFile\uff0c\u8c03\u7528\u8be5 MappedFile \u7684\u843d\u76d8\u65b9\u6cd5\uff0c\u5e76\u66f4\u65b0\u5168\u5c40\u7684 flushedWhere"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"//\u53c2\u6570\uff1a0 \u8868\u793a\u5f3a\u5236\u5237\u65b0\uff0c > 0 \u810f\u9875\u6570\u636e\u5fc5\u987b\u8fbe\u5230 flushLeastPages \u624d\u5237\u65b0\npublic boolean flush(final int flushLeastPages)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"findMappedFileByOffset()\uff1a\u6839\u636e\u504f\u79fb\u91cf\u67e5\u8be2\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public MappedFile findMappedFileByOffset(final long offset, final boolean returnFirstOnNotFound)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"deleteExpiredFileByTime()\uff1aCL \u5220\u9664\u8fc7\u671f\u6587\u4ef6\uff0c\u6839\u636e\u6587\u4ef6\u7684\u4fdd\u7559\u65f6\u957f\u51b3\u5b9a\u662f\u5426\u5220\u9664"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u8fc7\u671f\u65f6\u95f4\uff1b \u53c2\u6570\u4e8c\uff1a\u5220\u9664\u4e24\u4e2a\u6587\u4ef6\u4e4b\u95f4\u7684\u65f6\u95f4\u95f4\u9694\uff1b \u53c2\u6570\u4e09\uff1amf.destory\u4f20\u9012\u7684\u53c2\u6570\uff1b \u53c2\u6570\u56db\uff1atrue \u5f3a\u5236\u5220\u9664\npublic int deleteExpiredFileByTime(final long expiredTime,final int deleteFilesInterval, final long intervalForcibly, final boolean cleanImmediately)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"deleteExpiredFileByOffset()\uff1aCQ \u5220\u9664\u8fc7\u671f\u6587\u4ef6\uff0c\u904d\u5386\u6bcf\u4e2a MF \u6587\u4ef6\uff0c\u83b7\u53d6\u5f53\u524d\u6587\u4ef6\u6700\u540e\u4e00\u4e2a\u6570\u636e\u5355\u5143\u7684\u7269\u7406\u504f\u79fb\u91cf\uff0c\u5c0f\u4e8e offset \u8bf4\u660e\u5f53\u524d MF \u6587\u4ef6\u5185\u90fd\u662f\u8fc7\u671f\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1aconsumeLog \u76ee\u5f55\u4e0b\u6700\u5c0f\u7269\u7406\u504f\u79fb\u91cf\uff0c\u5c31\u662f\u7b2c\u4e00\u6761\u6d88\u606f\u7684 offset\uff1b \n// \u53c2\u6570\u4e8c\uff1aConsumerQueue \u6587\u4ef6\u5185\u6bcf\u4e2a\u6570\u636e\u5355\u5143\u56fa\u5b9a\u5927\u5c0f\npublic int deleteExpiredFileByOffset(long offset, int unitSize)\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"commitlog",children:"CommitLog"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-3",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9b54\u6570\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public final static int MESSAGE_MAGIC_CODE = -626843481;\t// \u6d88\u606f\u7684\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u662f\u5927\u5c0f\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\u5c31\u662f\u9b54\u6570\t\nprotected final static int BLANK_MAGIC_CODE = -875286124;\t// \u6587\u4ef6\u5c3e\u6d88\u606f\u7684\u9b54\u6cd5\u503c\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["MappedFileQueue\uff1a\u7528\u4e8e\u7ba1\u7406 ",(0,l.jsx)(n.code,{children:"../store/commitlog"})," \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final MappedFileQueue mappedFileQueue;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b58\u50a8\u670d\u52a1\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final DefaultMessageStore defaultMessageStore;\t// \u5b58\u50a8\u6a21\u5757\u5bf9\u8c61\uff0c\u4e0a\u5c42\u670d\u52a1\nprivate final FlushCommitLogService flushCommitLogService;\t// \u5237\u76d8\u670d\u52a1\uff0c\u9ed8\u8ba4\u5b9e\u73b0\u662f\u5f02\u6b65\u5237\u76d8\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u56de\u8c03\u5668\uff1a\u63a7\u5236\u6d88\u606f\u7684\u54ea\u4e9b\u5b57\u6bb5\u6dfb\u52a0\u5230 MappedFile"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final AppendMessageCallback appendMessageCallback;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u961f\u5217\u504f\u79fb\u91cf\u5b57\u5178\u8868\uff1akey \u662f\u4e3b\u9898\u961f\u5217 id\uff0cvalue \u662f\u504f\u79fb\u91cf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected HashMap<String, Long> topicQueueTable = new HashMap<String, Long>(1024);\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9501\u76f8\u5173\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile long beginTimeInLock = 0;\t\t \t// \u5199\u6570\u636e\u65f6\u52a0\u9501\u7684\u5f00\u59cb\u65f6\u95f4\nprotected final PutMessageLock putMessageLock;\t\t// \u5199\u9501\uff0c\u4e24\u4e2a\u5b9e\u73b0\u7c7b\uff1a\u81ea\u65cb\u9501\u548c\u91cd\u5165\u9501\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u56e0\u4e3a\u53d1\u9001\u6d88\u606f\u662f\u9700\u8981\u6301\u4e45\u5316\u7684\uff0c\u5728 Broker \u7aef\u6301\u4e45\u5316\u65f6\u4f1a\u83b7\u53d6\u8be5\u9501\uff0c",(0,l.jsx)(n.strong,{children:"\u4fdd\u8bc1\u53d1\u9001\u7684\u6d88\u606f\u7684\u7ebf\u7a0b\u5b89\u5168"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6709\u53c2\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public CommitLog(final DefaultMessageStore defaultMessageStore) {\n    // \u521b\u5efa MappedFileQueue \u5bf9\u8c61\n    // \u53c2\u65701\uff1a../store/commitlog\uff1b \u53c2\u65702\uff1a\u30101g\u3011\uff1b \u53c2\u65703\uff1aallocateMappedFileService\n    this.mappedFileQueue = new MappedFileQueue(...);\n    // \u9ed8\u8ba4 \u5f02\u6b65\u5237\u76d8\uff0c\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\n   \tthis.flushCommitLogService = new FlushRealTimeService();\n    // \u63a7\u5236\u6d88\u606f\u54ea\u4e9b\u5b57\u6bb5\u8ffd\u52a0\u5230 mappedFile\uff0c\u3010\u6d88\u606f\u6700\u5927\u662f 4M\u3011\n   \tthis.appendMessageCallback = new DefaultAppendMessageCallback(...);\n    // \u9ed8\u8ba4\u4f7f\u7528\u81ea\u65cb\u9501\n    this.putMessageLock = ...;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-2",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"CommitLog \u7c7b\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u4f1a\u542f\u52a8\u5237\u76d8\u670d\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"shutdown()\uff1a\u5173\u95ed\u5237\u76d8\u670d\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void shutdown()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"load()\uff1a\u52a0\u8f7d CommitLog \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean load()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["getMessage()\uff1a\u6839\u636e offset \u67e5\u8be2\u5355\u6761\u4fe1\u606f\uff0c\u8fd4\u56de\u7684\u7ed3\u679c\u5bf9\u8c61\u5185\u90e8\u5c01\u88c5\u4e86\u4e00\u4e2a ByteBuffer\uff0c\u8be5 Buffer \u8868\u793a ",(0,l.jsx)(n.code,{children:"[offset, offset + size]"})," \u533a\u95f4\u7684 MappedFile \u7684\u6570\u636e"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public SelectMappedBufferResult getMessage(final long offset, final int size)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"deleteExpiredFile()\uff1a\u5220\u9664\u8fc7\u671f\u6587\u4ef6\uff0c\u65b9\u6cd5\u7531 DefaultMessageStore \u7684\u5b9a\u65f6\u4efb\u52a1\u8c03\u7528"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public int deleteExpiredFile()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["asyncPutMessage()\uff1a",(0,l.jsx)(n.strong,{children:"\u5b58\u50a8\u6d88\u606f"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public CompletableFuture<PutMessageResult> asyncPutMessage(final MessageExtBrokerInner msg)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msg.setStoreTimestamp(System.currentTimeMillis())"}),"\uff1a\u8bbe\u7f6e\u5b58\u50a8\u65f6\u95f4\uff0c\u540e\u9762\u83b7\u53d6\u5230\u5199\u9501\u540e\u8fd9\u4e2a\u4e8b\u4ef6\u4f1a\u91cd\u5199"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msg.setBodyCRC(UtilAll.crc32(msg.getBody()))"}),"\uff1a\u83b7\u53d6\u6d88\u606f\u7684 CRC \u503c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"topic\u3001queueId"}),"\uff1a\u83b7\u53d6\u4e3b\u9898\u548c\u961f\u5217 ID"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (msg.getDelayTimeLevel() > 0) "}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u6d88\u606f\u7684\u5ef6\u8fdf\u7ea7\u522b\uff0c\u8fd9\u91cc\u662f\u5ef6\u8fdf\u6d88\u606f\u5b9e\u73b0\u7684\u5173\u952e"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"topic = TopicValidator.RMQ_SYS_SCHEDULE_TOPIC"}),"\uff1a",(0,l.jsxs)(n.strong,{children:["\u4fee\u6539\u6d88\u606f\u7684\u4e3b\u9898\u4e3a ",(0,l.jsx)(n.code,{children:"SCHEDULE_TOPIC_XXXX"})]})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"queueId = ScheduleMessageService.delayLevel2QueueId()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u961f\u5217 ID \u4e3a\u5ef6\u8fdf\u7ea7\u522b -1"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"MessageAccessor.putProperty"}),"\uff1a",(0,l.jsxs)(n.strong,{children:["\u5c06\u539f\u6765\u7684\u6d88\u606f\u4e3b\u9898\u548c ID \u5b58\u5165\u6d88\u606f\u7684\u5c5e\u6027 ",(0,l.jsx)(n.code,{children:"REAL_TOPIC"})," \u4e2d"]})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mappedFile = this.mappedFileQueue.getLastMappedFile()"}),"\uff1a\u83b7\u53d6\u5f53\u524d\u987a\u5e8f\u5199\u7684 MappedFile \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"putMessageLock.lock()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u5199\u9501"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msg.setStoreTimestamp(beginLockTimestamp)"}),"\uff1a\u8bbe\u7f6e\u6d88\u606f\u7684\u5b58\u50a8\u65f6\u95f4\u4e3a\u83b7\u53d6\u9501\u7684\u65f6\u95f4"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (null == mappedFile || mappedFile.isFull())"}),"\uff1a\u6587\u4ef6\u5199\u6ee1\u4e86\u521b\u5efa\u65b0\u7684 MF \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"result = mappedFile.appendMessage(msg, this.appendMessageCallback)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u8ffd\u52a0"}),"\uff0c\u6838\u5fc3\u903b\u8f91\u5728\u56de\u8c03\u5668\u7c7b"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"putMessageLock.unlock()"}),"\uff1a\u91ca\u653e\u5199\u9501"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.defaultMessageStore.unlockMappedFile(..)"}),"\uff1a\u5c06 MappedByteBuffer \u4ece lock \u5207\u6362\u4e3a unlock \u72b6\u6001"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result)"}),"\uff1a\u7ed3\u679c\u5c01\u88c5"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"flushResultFuture = submitFlushRequest(result, msg)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5524\u9192\u5237\u76d8\u7ebf\u7a0b"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"replicaResultFuture = submitReplicaRequest(result, msg)"}),"\uff1aHA \u6d88\u606f\u540c\u6b65"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["recoverNormally()\uff1a\u6b63\u5e38\u5173\u673a\u65f6\u7684\u6062\u590d\u65b9\u6cd5\uff0c\u5b58\u50a8\u6a21\u5757\u542f\u52a8\u65f6",(0,l.jsx)(n.strong,{children:"\u5148\u6062\u590d\u6240\u6709\u7684 ConsumeQueue \u6570\u636e\uff0c\u518d\u6062\u590d CommitLog \u6570\u636e"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u8868\u793a\u6062\u590d\u9636\u6bb5 ConsumeQueue \u4e2d\u5df2\u77e5\u7684\u6700\u5927\u7684\u6d88\u606f offset\npublic void recoverNormally(long maxPhyOffsetOfConsumeQueue)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int index = mappedFiles.size() - 3"}),"\uff1a\u4ece\u5012\u6570\u7b2c\u4e09\u4e2a file \u5f00\u59cb\u5411\u540e\u6062\u590d"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"dispatchRequest = this.checkMessageAndReturnSize()"}),"\uff1a\u6bcf\u6b21\u4ece\u5207\u7247\u5185\u89e3\u6790\u51fa\u4e00\u6761 msg \u5c01\u88c5\u6210 DispatchRequest \u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"size = dispatchRequest.getMsgSize()"}),"\uff1a\u83b7\u53d6\u6d88\u606f\u7684\u5927\u5c0f\uff0c\u68c0\u67e5 DispatchRequest \u5bf9\u8c61\u7684\u72b6\u6001"]}),"\n",(0,l.jsxs)(n.p,{children:["\u60c5\u51b5 1\uff1a\u6b63\u5e38\u6570\u636e\uff0c\u5219 ",(0,l.jsx)(n.code,{children:"mappedFileOffset += size"})]}),"\n",(0,l.jsx)(n.p,{children:"\u60c5\u51b5 2\uff1a\u6587\u4ef6\u5c3e\u6570\u636e\uff0c\u5904\u7406\u4e0b\u4e00\u4e2a\u6587\u4ef6\uff0cmappedFileOffset \u7f6e\u4e3a 0\uff0cmagic_code \u8868\u793a\u6587\u4ef6\u5c3e"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"processOffset += mappedFileOffset"}),"\uff1a\u8ba1\u7b97\u51fa\u6b63\u786e\u7684\u6570\u636e\u5b58\u50a8\u4f4d\u70b9\uff0c\u5e76\u8bbe\u7f6e MappedFileQueue \u7684\u76ee\u5f55\u5237\u76d8\u4f4d\u70b9"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.mappedFileQueue.truncateDirtyFiles(processOffset)"}),"\uff1a\u8c03\u6574 MFQ \u4e2d\u6587\u4ef6\u7684\u5237\u76d8\u4f4d\u70b9"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (maxPhyOffsetOfConsumeQueue >= processOffset)"}),"\uff1a\u5220\u9664\u5197\u4f59\u6570\u636e\uff0c\u5c06\u8d85\u8fc7\u5168\u5c40\u4f4d\u70b9\u7684 CQ \u4e0b\u7684\u6587\u4ef6\u5220\u9664\uff0c\u5c06\u5305\u542b\u5168\u5c40\u4f4d\u70b9\u7684 CQ \u4e0b\u7684\u6587\u4ef6\u91cd\u65b0\u5b9a\u4f4d"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"recoverAbnormally()\uff1a\u5f02\u5e38\u5173\u673a\u65f6\u7684\u6062\u590d\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void recoverAbnormally(long maxPhyOffsetOfConsumeQueue)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int index = mappedFiles.size() - 1"}),"\uff1a\u4ece\u5c3e\u90e8\u5f00\u59cb\u904d\u5386 MFQ\uff0c\u9a8c\u8bc1 MF \u7684\u7b2c\u4e00\u6761\u6d88\u606f\uff0c\u627e\u5230\u7b2c\u4e00\u4e2a\u9a8c\u8bc1\u901a\u8fc7\u7684\u6587\u4ef6\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"dispatchRequest = this.checkMessageAndReturnSize()"}),"\uff1a\u6bcf\u6b21\u89e3\u6790\u51fa\u4e00\u6761 msg \u5c01\u88c5\u6210 DispatchRequest \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.defaultMessageStore.doDispatch(dispatchRequest)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u91cd\u5efa ConsumerQueue \u548c Index\uff0c\u907f\u514d\u4e0a\u6b21\u5f02\u5e38\u505c\u673a\u5bfc\u81f4 CQ \u548c Index \u4e0e CommitLog \u4e0d\u5bf9\u9f50"})]}),"\n",(0,l.jsx)(n.li,{children:"\u5269\u4f59\u903b\u8f91\u4e0e\u6b63\u5e38\u5173\u673a\u7684\u6062\u590d\u65b9\u6cd5\u76f8\u4f3c"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u670d\u52a1\u7ebf\u7a0b",children:"\u670d\u52a1\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:"AppendMessageCallback \u6d88\u606f\u8ffd\u52a0\u670d\u52a1\u5b9e\u73b0\u7c7b\u4e3a DefaultAppendMessageCallback"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"doAppend()\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public AppendMessageResult doAppend()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long wroteOffset = fileFromOffset + byteBuffer.position()"}),"\uff1a\u6d88\u606f\u5199\u5165\u7684\u4f4d\u7f6e\uff0c\u7269\u7406\u504f\u79fb\u91cf phyOffset"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String msgId"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u606f ID\uff0c\u89c4\u5219\u662f\u5ba2\u6237\u7aef IP + \u6d88\u606f\u504f\u79fb\u91cf phyOffset"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"byte[] topicData"}),"\uff1a\u5e8f\u5217\u5316\u6d88\u606f\uff0c\u5c06\u6d88\u606f\u7684\u5b57\u6bb5\u538b\u5165\u5230  msgStoreItemMemory \u8fd9\u4e2a Buffer \u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"byteBuffer.put(this.msgStoreItemMemory.array(), 0, msgLen)"}),"\uff1a\u5c06 msgStoreItemMemory \u4e2d\u7684\u6570\u636e\u5199\u5165 MF \u5bf9\u8c61\u7684\u5185\u5b58\u6620\u5c04\u7684 Buffer \u4e2d\uff0c\u6570\u636e\u8fd8\u6ca1\u843d\u76d8"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"AppendMessageResult result"}),"\uff1a\u6784\u9020\u7ed3\u679c\u5bf9\u8c61\uff0c\u5305\u62ec\u5b58\u50a8\u4f4d\u70b9\u3001\u662f\u5426\u6210\u529f\u3001\u961f\u5217\u504f\u79fb\u91cf\u7b49\u4fe1\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"CommitLog.this.topicQueueTable.put(key, ++queueOffset)"}),"\uff1a\u66f4\u65b0\u961f\u5217\u504f\u79fb\u91cf"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"FlushRealTimeService \u5237\u76d8 CL \u6570\u636e\uff0c\u9ed8\u8ba4\u662f\u5f02\u6b65\u5237\u76d8\u7c7b FlushRealTimeService"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u8fd0\u884c\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (!this.isStopped())"}),"\uff1astopped\u4e3a true \u624d\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean flushCommitLogTimed"}),"\uff1a\u63a7\u5236\u7ebf\u7a0b\u7684\u4f11\u7720\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u662f false\uff0c\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"CountDownLatch.await()"})," \u4f11\u7720\uff0c\u8bbe\u7f6e\u4e3a true \u65f6\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"Thread.sleep()"})," \u4f11\u7720"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int interval"}),"\uff1a\u83b7\u53d6\u914d\u7f6e\u4e2d\u7684\u5237\u76d8\u65f6\u95f4\u95f4\u9694"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int flushPhysicQueueLeastPages"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u6700\u5c0f\u5237\u76d8\u9875\u6570\uff0c\u9ed8\u8ba4\u662f 4 \u9875"}),"\uff0c\u810f\u9875\u8fbe\u5230\u6307\u5b9a\u9875\u6570\u624d\u5237\u76d8"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int flushPhysicQueueThoroughInterval"}),"\uff1a\u83b7\u53d6\u5f3a\u5236\u5237\u76d8\u5468\u671f\uff0c\u9ed8\u8ba4\u662f 10 \u79d2\uff0c\u8fbe\u5230\u5468\u671f\u540e\u5f3a\u5236\u5237\u76d8\uff0c\u4e0d\u8003\u8651\u810f\u9875"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (flushCommitLogTimed)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4f11\u7720\u903b\u8f91"}),"\uff0c\u907f\u514d CPU \u5360\u7528\u592a\u957f\u65f6\u95f4\uff0c\u5bfc\u81f4\u65e0\u6cd5\u6267\u884c\u5176\u4ed6\u66f4\u7d27\u6025\u7684\u4efb\u52a1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5237\u76d8"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (int i = 0; i < RETRY_TIMES_OVER && !result; i++)"}),"\uff1astopped \u505c\u6b62\u6807\u8bb0\u4e3a true \u65f6\uff0c\u9700\u8981\u786e\u4fdd\u6240\u6709\u7684\u6570\u636e\u90fd\u5df2\u7ecf\u5237\u76d8\uff0c\u6240\u4ee5\u6b64\u5904\u5c1d\u8bd5 10 \u6b21\u5f3a\u5236\u5237\u76d8\uff0c"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"result = CommitLog.this.mappedFileQueue.flush(0)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5f3a\u5236\u5237\u76d8"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u540c\u6b65\u5237\u76d8\u7c7b GroupCommitService"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u8fd0\u884c\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (!this.isStopped())"}),"\uff1astopped\u4e3a true \u624d\u8df3\u51fa\u5faa\u73af"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.waitForRunning(10)"}),"\uff1a\u7ebf\u7a0b\u4f11\u7720 10 \u6beb\u79d2\uff0c\u6700\u540e\u8c03\u7528 ",(0,l.jsx)(n.code,{children:"onWaitEnd()"})," \u8fdb\u884c",(0,l.jsx)(n.strong,{children:"\u8bf7\u6c42\u7684\u4ea4\u6362"})," ",(0,l.jsx)(n.code,{children:"swapRequests()"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.doCommit()"}),"\uff1a\u505a\u63d0\u4ea4\u903b\u8f91"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!this.requestsRead.isEmpty()) "}),"\uff1a\u8bfb\u8bf7\u6c42\u96c6\u5408\u4e0d\u4e3a\u7a7a"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (GroupCommitRequest req : this.requestsRead)"}),"\uff1a\u904d\u5386\u6240\u6709\u7684\u8bfb\u8bf7\u6c42\uff0c\u8bf7\u6c42\u4e2d\u7684\u5c5e\u6027\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private final long nextOffset"}),"\uff1a\u672c\u6761\u6d88\u606f\u5b58\u50a8\u4e4b\u540e\uff0c\u4e0b\u4e00\u6761\u6d88\u606f\u5f00\u59cb\u7684 offset"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private CompletableFuture<PutMessageStatus> flushOKFuture"}),"\uff1aFuture \u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean flushOK = ..."}),"\uff1a\u5f53\u524d\u8bf7\u6c42\u5173\u6ce8\u7684\u6570\u636e\u662f\u5426\u5168\u90e8\u843d\u76d8\uff0c",(0,l.jsx)(n.strong,{children:"\u843d\u76d8\u6210\u529f\u5524\u9192\u6d88\u8d39\u8005\u7ebf\u7a0b"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (int i = 0; i < 2 && !flushOK; i++)"}),"\uff1a\u5c1d\u8bd5\u8fdb\u884c\u4e24\u6b21\u5f3a\u5236\u5237\u76d8\uff0c\u4fdd\u8bc1\u5237\u76d8\u6210\u529f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"CommitLog.this.mappedFileQueue.flush(0)"}),"\uff1a\u5f3a\u5236\u5237\u76d8"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"req.wakeupCustomer(flushOK ? ...)"}),"\uff1a\u8bbe\u7f6e Future \u7ed3\u679c\uff0c\u5728 Future \u963b\u585e\u7684\u7ebf\u7a0b\u5728\u8fd9\u91cc\u4f1a\u88ab\u5524\u9192"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.requestsRead.clear()"}),"\uff1a\u6e05\u7406 reqeustsRead \u5217\u8868\uff0c\u65b9\u4fbf\u4ea4\u6362\u65f6\u6210\u4e3a requestsWrite \u4f7f\u7528"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u8bfb\u8bf7\u6c42\u96c6\u5408\u4e3a\u7a7a"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"CommitLog.this.mappedFileQueue.flush(0)"}),"\uff1a\u5f3a\u5236\u5237\u76d8"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.swapRequests()"}),"\uff1a\u4ea4\u6362\u8bfb\u5199\u8bf7\u6c42"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.doCommit()"}),"\uff1a\u4ea4\u6362\u540e\u505a\u4e00\u6b21\u63d0\u4ea4"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"consqueue",children:"ConsQueue"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-4",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"ConsumerQueue \u662f\u6d88\u606f\u6d88\u8d39\u961f\u5217\uff0c\u5b58\u50a8\u6d88\u606f\u5728 CommitLog \u7684\u7d22\u5f15\uff0c\u4fbf\u4e8e\u5feb\u901f\u5b9a\u4f4d\u6d88\u606f"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u5355\u5143\uff1aConsumerQueueData \u6570\u636e\u5355\u5143\u7684\u56fa\u5b9a\u5927\u5c0f\u662f 20 \u5b57\u8282\uff0c\u9ed8\u8ba4\u7533\u8bf7 20 \u5b57\u8282\u7684\u7f13\u51b2\u533a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public static final int CQ_STORE_UNIT_SIZE = 20;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6587\u4ef6\u7ba1\u7406\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final MappedFileQueue mappedFileQueue;\t// \u6587\u4ef6\u7ba1\u7406\u5668\uff0c\u7ba1\u7406 CQ \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\nprivate final String storePath;\t\t\t\t\t// \u76ee\u5f55\uff0c\u6bd4\u5982../store/consumequeue/xxx_topic/0\nprivate final int mappedFileSize;\t\t\t\t// \u6bcf\u4e00\u4e2a CQ \u5b58\u50a8\u6587\u4ef6\u5927\u5c0f\uff0c\u9ed8\u8ba4 20 * 30w = 600w byte\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b58\u50a8\u4e3b\u6a21\u5757\uff1a\u4e0a\u5c42\u7684\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final DefaultMessageStore defaultMessageStore;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final String topic;\t\t\t\t\t// CQ \u4e3b\u9898\nprivate final int queueId;\t\t\t\t\t// CQ \u961f\u5217\uff0c\u6bcf\u4e00\u4e2a\u961f\u5217\u90fd\u6709\u4e00\u4e2a ConsumeQueue \u5bf9\u8c61\u8fdb\u884c\u7ba1\u7406\nprivate final ByteBuffer byteBufferIndex;\t// \u4e34\u65f6\u7f13\u51b2\u533a\uff0c\u63d2\u65b0\u7684 CQData \u65f6\u4f7f\u7528\nprivate long maxPhysicOffset = -1;\t\t\t// \u5f53\u524dConsumeQueue\u5185\u5b58\u50a8\u7684\u6700\u5927\u6d88\u606f\u7269\u7406\u504f\u79fb\u91cf\nprivate volatile long minLogicOffset = 0;\t// \u5f53\u524dConsumeQueue\u5185\u5b58\u50a8\u7684\u6700\u5c0f\u6d88\u606f\u7269\u7406\u504f\u79fb\u91cf\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6709\u53c2\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public ConsumeQueue() {\n    // \u7533\u8bf7\u4e86\u4e00\u4e2a 20 \u5b57\u8282\u5927\u5c0f\u7684 \u4e34\u65f6\u7f13\u51b2\u533a\n    this.byteBufferIndex = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-3",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"ConsumeQueue \u542f\u52a8\u9636\u6bb5\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"load()\uff1a\u7b2c\u4e00\u6b65\uff0c\u52a0\u8f7d storePath \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff0c\u521d\u59cb\u5316 MappedFileQueue"}),"\n",(0,l.jsxs)(n.li,{children:["recover()\uff1a\u7b2c\u4e8c\u6b65\uff0c\u6062\u590d ConsumeQueue \u6570\u636e\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4ece\u5012\u6570\u7b2c\u4e09\u4e2a MF \u6587\u4ef6\u5f00\u59cb\u5411\u540e\u904d\u5386\uff0c\u4f9d\u6b21\u8bfb\u53d6 MF \u4e2d 20 \u4e2a\u5b57\u8282\u7684 CQData \u6570\u636e\uff0c\u68c0\u67e5 offset \u548c size \u662f\u5426\u662f\u6709\u6548\u6570\u636e"}),"\n",(0,l.jsx)(n.li,{children:"\u627e\u5230\u65e0\u6548\u7684 CQData \u7684\u4f4d\u70b9\uff0c\u8be5\u4f4d\u70b9\u5c31\u662f CQ \u7684\u5237\u76d8\u70b9\u548c\u6570\u636e\u987a\u5e8f\u5199\u5165\u70b9"}),"\n",(0,l.jsx)(n.li,{children:"\u5220\u9664\u65e0\u6548\u7684 MF \u6587\u4ef6\uff0c\u8c03\u6574\u5f53\u524d\u987a\u5e8f\u5199\u7684 MF \u6587\u4ef6\u7684\u6570\u636e\u4f4d\u70b9"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5176\u4ed6\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["truncateDirtyLogicFiles()\uff1aCommitLog \u6062\u590d\u9636\u6bb5\u8c03\u7528\uff0c\u5c06 ConsumeQueue \u6709\u6548\u6570\u636e\u6587\u4ef6\u4e0e CommitLog \u5bf9\u9f50\uff0c\u5c06\u8d85\u51fa\u90e8\u5206\u7684\u6570\u636e\u6587\u5220\u9664\u6389\uff0c\u5e76\u8c03\u6574\u5f53\u524d\u6587\u4ef6\u7684\u6570\u636e\u4f4d\u70b9\u3002Broker \u542f\u52a8\u9636\u6bb5\u5148\u6062\u590d CQ \u7684\u6570\u636e\uff0c\u518d\u6062\u590d CL \u6570\u636e\uff0c\u4f46\u662f",(0,l.jsx)(n.strong,{children:"\u6570\u636e\u8981\u4ee5 CL \u4e3a\u57fa\u51c6"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u662f\u6700\u5927\u6d88\u606f\u7269\u7406\u504f\u79fb\u91cf\npublic void truncateDirtyLogicFiles(long phyOffet)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"flush()\uff1a\u5237\u76d8\uff0c\u8c03\u7528 MFQ \u7684\u5237\u76d8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean flush(final int flushLeastPages)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"deleteExpiredFile()\uff1a\u5220\u9664\u8fc7\u671f\u6587\u4ef6\uff0c\u5c06\u5c0f\u4e8e offset \u7684\u6240\u6709 MF \u6587\u4ef6\u5220\u9664\uff0coffset \u662f CommitLog \u76ee\u5f55\u4e0b\u6700\u5c0f\u7684\u7269\u7406\u504f\u79fb\u91cf\uff0c\u5c0f\u4e8e\u8be5\u503c\u7684 CL \u6587\u4ef6\u5df2\u7ecf\u6ca1\u6709\u4e86\uff0c\u6240\u4ee5 CQ \u4e5f\u6ca1\u6709\u5b58\u5728\u7684\u5fc5\u8981"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public int deleteExpiredFile(long offset)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["putMessagePositionInfoWrapper()\uff1a",(0,l.jsx)(n.strong,{children:"\u5411 CQ \u4e2d\u8ffd\u52a0 CQData \u6570\u636e"}),"\uff0c\u7531\u5b58\u50a8\u4e3b\u6a21\u5757 DefaultMessageStore \u5185\u90e8\u7684\u5f02\u6b65\u7ebf\u7a0b\u8c03\u7528\uff0c\u8d1f\u8d23\u6784\u5efa ConsumeQueue \u6587\u4ef6\u548c Index \u6587\u4ef6\u7684\uff0c\u8be5\u7ebf\u7a0b\u4f1a\u6301\u7eed\u5173\u6ce8 CommitLog \u6587\u4ef6\uff0c\u5f53 CommitLog \u6587\u4ef6\u5185\u6709\u65b0\u6570\u636e\u5199\u5165\uff0c\u5c31\u8bfb\u51fa\u6765\u5c01\u88c5\u6210 DispatchRequest \u5bf9\u8c61\uff0c\u8f6c\u53d1\u7ed9 ConsumeQueue \u6216\u8005 IndexService"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void putMessagePositionInfoWrapper(DispatchRequest request)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["getIndexBuffer()\uff1a\u8f6c\u6362 startIndex \u4e3a offset\uff0c\u83b7\u53d6\u5305\u542b\u8be5 offset \u7684 MappedFile \u6587\u4ef6\uff0c\u8bfb\u53d6 ",(0,l.jsx)(n.code,{children:"[offset%maxSize, mfPos]"})," \u8303\u56f4\u7684\u6570\u636e\uff0c\u5305\u88c5\u6210\u7ed3\u679c\u5bf9\u8c61\u8fd4\u56de"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:" public SelectMappedBufferResult getIndexBuffer(final long startIndex)\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"indexfile",children:"IndexFile"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-5",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"IndexFile \u7c7b\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u54c8\u5e0c\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private static int hashSlotSize = 4;\t// \u6bcf\u4e2a hash \u6876\u7684\u5927\u5c0f\u662f 4 \u5b57\u8282\uff0c\u3010\u7528\u6765\u5b58\u653e\u7d22\u5f15\u7684\u7f16\u53f7\u3011\nprivate final int hashSlotNum;\t\t\t// hash \u6876\u7684\u4e2a\u6570\uff0c\u9ed8\u8ba4 500 \u4e07\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7d22\u5f15\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private static int indexSize = 20;\t\t// \u6bcf\u4e2a index \u6761\u76ee\u7684\u5927\u5c0f\u662f 20 \u5b57\u8282\nprivate static int invalidIndex = 0;\t// \u65e0\u6548\u7d22\u5f15\u7f16\u53f7\uff1a0 \u7279\u6b8a\u503c\nprivate final int indexNum;\t\t\t\t// \u9ed8\u8ba4\u503c\uff1a2000w\nprivate final IndexHeader indexHeader;\t// \u7d22\u5f15\u5934\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6620\u5c04\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final MappedFile mappedFile;\t\t\t// \u3010\u7d22\u5f15\u6587\u4ef6\u4f7f\u7528\u7684 MF \u6587\u4ef6\u3011\nprivate final FileChannel fileChannel;\t\t\t// \u6587\u4ef6\u901a\u9053\nprivate final MappedByteBuffer mappedByteBuffer;// \u4ece MF \u4e2d\u83b7\u53d6\u7684\u5185\u5b58\u6620\u5c04\u7f13\u51b2\u533a\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6709\u53c2\u6784\u9020"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// endPhyOffset \u4e0a\u4e2a\u7d22\u5f15\u6587\u4ef6 \u6700\u540e\u4e00\u6761\u6d88\u606f\u7684 \u7269\u7406\u504f\u79fb\u91cf\n// endTimestamp \u4e0a\u4e2a\u7d22\u5f15\u6587\u4ef6 \u6700\u540e\u4e00\u6761\u6d88\u606f\u7684 \u5b58\u50a8\u65f6\u95f4\npublic IndexFile(final String fileName, final int hashSlotNum, final int indexNum,\n                 final long endPhyOffset, final long endTimestamp) throws IOException {\n    // \u6587\u4ef6\u5927\u5c0f 40 + 500w * 4 + 2000w * 20\n    int fileTotalSize =\n        IndexHeader.INDEX_HEADER_SIZE + (hashSlotNum * hashSlotSize) + (indexNum * indexSize);\n    // \u521b\u5efa mf \u5bf9\u8c61\uff0c\u4f1a\u5728disk\u4e0a\u521b\u5efa\u6587\u4ef6\n    this.mappedFile = new MappedFile(fileName, fileTotalSize);\n    // \u521b\u5efa \u7d22\u5f15\u5934\u5bf9\u8c61\uff0c\u4f20\u9012 \u7d22\u5f15\u6587\u4ef6mf \u7684\u5207\u7247\u6570\u636e\n    this.indexHeader = new IndexHeader(byteBuffer);\n\t//...\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-4",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"IndexFile \u7c7b\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"load()\uff1a\u52a0\u8f7d IndexHeader"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void load()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"flush()\uff1aMappedByteBuffer \u5185\u7684\u6570\u636e\u5f3a\u5236\u843d\u76d8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void flush()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"isWriteFull()\uff1a\u68c0\u67e5\u5f53\u524d\u7684 IndexFile \u5df2\u5199\u7d22\u5f15\u6570\u662f\u5426 >= indexNum\uff0c\u8fbe\u5230\u8be5\u503c\u5219\u5f53\u524d IndexFile \u4e0d\u80fd\u7ee7\u7eed\u8ffd\u52a0 IndexData \u4e86"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean isWriteFull()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"destroy()\uff1a\u5220\u9664\u6587\u4ef6\u65f6\u4f7f\u7528\u7684\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean destroy(final long intervalForcibly)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["putKey()\uff1a\u6dfb\u52a0\u7d22\u5f15\u6570\u636e\uff0c\u89e3\u51b3\u54c8\u5e0c\u51b2\u7a81\u4f7f\u7528",(0,l.jsx)(n.strong,{children:"\u5934\u63d2\u6cd5"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u53c2\u6570\u4e00\uff1a\u6d88\u606f\u7684 key\uff0cuniq_key \u6216\u8005 keys="aaa bbb ccc" \u4f1a\u5206\u522b\u4e3a aaa bbb ccc \u521b\u5efa\u7d22\u5f15\n// \u53c2\u6570\u4e8c\uff1a\u6d88\u606f\u7684\u7269\u7406\u504f\u79fb\u91cf\uff1b  \u53c2\u6570\u4e09\uff1a\u6d88\u606f\u5b58\u50a8\u65f6\u95f4\npublic boolean putKey(final String key, final long phyOffset, final long storeTimestamp)\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int slotPos = keyHash % this.hashSlotNum"}),"\uff1a\u5bf9 key \u8ba1\u7b97\u54c8\u5e0c\u540e\uff0c\u53d6\u6a21\u5f97\u5230\u5bf9\u5e94\u7684\u54c8\u5e0c\u69fd slot \u4e0b\u6807\uff0c\u7136\u540e\u8ba1\u7b97\u51fa\u54c8\u5e0c\u69fd\u7684\u5b58\u50a8\u4f4d\u7f6e absSlotPos"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int slotValue = this.mappedByteBuffer.getInt(absSlotPos)"}),"\uff1a\u83b7\u53d6\u69fd\u4e2d\u7684\u503c\uff0c\u5982\u679c\u662f\u65e0\u6548\u503c\u8bf4\u660e\u6ca1\u6709\u54c8\u5e0c\u51b2\u7a81"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"timeDiff = timeDiff / 1000"}),"\uff1a\u8ba1\u7b97\u5f53\u524d msg \u5b58\u50a8\u65f6\u95f4\u51cf\u53bb\u7d22\u5f15\u6587\u4ef6\u5185\u7b2c\u4e00\u6761\u6d88\u606f\u5b58\u50a8\u65f6\u95f4\u7684\u5dee\u503c\uff0c\u8f6c\u5316\u4e3a\u79d2\u8fdb\u884c\u5b58\u50a8"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int absIndexPos"}),"\uff1a\u8ba1\u7b97\u5f53\u524d\u7d22\u5f15\u6570\u636e\u5b58\u50a8\u7684\u4f4d\u7f6e\uff0c\u5f00\u59cb\u586b\u5145\u7d22\u5f15\u6570\u636e\u5230\u5bf9\u5e94\u7684\u4f4d\u7f6e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mappedByteBuffer.putInt(absIndexPos + 4 + 8 + 4, slotValue)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"hash \u6876\u7684\u539f\u503c\uff0c\u5934\u63d2\u6cd5"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mappedByteBuffer.putInt(absSlotPos, this.indexHeader...)"}),"\uff1a\u5728 slot \u653e\u5165\u5f53\u524d\u7d22\u5f15\u7684\u7d22\u5f15\u7f16\u53f7"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (this.indexHeader.getIndexCount() <= 1)"}),"\uff1a\u7d22\u5f15\u6587\u4ef6\u63d2\u5165\u7684\u7b2c\u4e00\u6761\u6570\u636e\uff0c\u9700\u8981\u8bbe\u7f6e\u8d77\u59cb\u504f\u79fb\u91cf\u548c\u5b58\u50a8\u65f6\u95f4"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (invalidIndex == slotValue)"}),"\uff1a\u6ca1\u6709\u54c8\u5e0c\u51b2\u7a81\uff0c\u8bf4\u660e\u5360\u7528\u4e86\u4e00\u4e2a\u65b0\u7684 hash slot"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.indexHeader"}),"\uff1a\u8bbe\u7f6e\u7d22\u5f15\u5934\u7684\u76f8\u5173\u5c5e\u6027"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"selectPhyOffset()\uff1a\u4ece\u7d22\u5f15\u6587\u4ef6\u67e5\u8be2\u6d88\u606f\u7684\u7269\u7406\u504f\u79fb\u91cf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u67e5\u8be2\u7ed3\u679c\u5168\u90e8\u653e\u5230\u8be5list\u5185\uff1b \u53c2\u6570\u4e8c\uff1a\u67e5\u8be2key\uff1b \u53c2\u6570\u4e09\uff1a\u7ed3\u679c\u6700\u5927\u6570\u9650\u5236\uff1b \u53c2\u6570\u56db\u4e94\uff1a\u65f6\u95f4\u8303\u56f4\npublic void selectPhyOffset(final List<Long> phyOffsets, final String key, final int maxNum,final long begin, final long end, boolean lock)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (this.mappedFile.hold())"}),"\uff1a MF \u7684\u5f15\u7528\u8bb0\u6570 +1\uff0c\u67e5\u8be2\u671f\u95f4 MF \u8d44\u6e90",(0,l.jsx)(n.strong,{children:"\u4e0d\u80fd\u88ab\u91ca\u653e"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int slotValue = this.mappedByteBuffer.getInt(absSlotPos)"}),"\uff1a\u83b7\u53d6\u69fd\u4e2d\u7684\u503c\uff0c\u53ef\u80fd\u662f\u65e0\u6548\u503c\u6216\u8005\u7d22\u5f15\u7f16\u53f7\uff0c\u5982\u679c\u662f\u65e0\u6548\u503c\u8bf4\u660e\u67e5\u8be2\u672a\u547d\u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int absIndexPos"}),"\uff1a\u8ba1\u7b97\u51fa\u7d22\u5f15\u7f16\u53f7\u5bf9\u5e94\u7d22\u5f15\u6570\u636e\u7684\u5f00\u59cb\u4f4d\u70b9"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mappedByteBuffer"}),"\uff1a\u8bfb\u53d6\u7d22\u5f15\u6570\u636e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long timeRead = this.indexHeader.getBeginTimestamp() + timeDiff"}),"\uff1a\u8ba1\u7b97\u51fa\u51c6\u786e\u7684\u5b58\u50a8\u65f6\u95f4"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean timeMatched = (timeRead >= begin) && (timeRead <= end)"}),"\uff1a\u65f6\u95f4\u8303\u56f4\u7684\u5339\u914d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"phyOffsets.add(phyOffsetRead)"}),"\uff1a\u5c06\u547d\u4e2d\u7684\u6d88\u606f\u7d22\u5f15\u7684\u6d88\u606f\u504f\u79fb\u91cf\u52a0\u5165\u5230 list \u96c6\u5408\u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"nextIndexToRead = prevIndexRead"}),"\uff1a\u904d\u5386\u524d\u9a71\u8282\u70b9"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"indexserv",children:"IndexServ"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-6",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"IndexService \u7c7b\u7528\u6765\u7ba1\u7406 IndexFile \u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b58\u50a8\u4e3b\u6a21\u5757\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final DefaultMessageStore defaultMessageStore;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u7d22\u5f15\u6587\u4ef6\u5b58\u50a8\u76ee\u5f55\uff1a",(0,l.jsx)(n.code,{children:"../store/index"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final String storePath;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7d22\u5f15\u5bf9\u8c61\u96c6\u5408\uff1a\u76ee\u5f55\u4e0b\u7684\u6bcf\u4e2a\u6587\u4ef6\u90fd\u6709\u4e00\u4e2a IndexFile \u5bf9\u8c61"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ArrayList<IndexFile> indexFileList = new ArrayList<IndexFile>();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7d22\u5f15\u6587\u4ef6\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final int hashSlotNum;\t\t// \u6bcf\u4e2a\u7d22\u5f15\u6587\u4ef6\u5305\u542b\u7684 \u54c8\u5e0c\u6876\u6570\u91cf \uff1a500w\nprivate final int indexNum;\t\t\t// \u6bcf\u4e2a\u7d22\u5f15\u6587\u4ef6\u5305\u542b\u7684 \u7d22\u5f15\u6761\u76ee\u6570\u91cf \uff1a2000w\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-5",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"load()\uff1a\u52a0\u8f7d storePath \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff0c\u4e3a\u6bcf\u4e2a\u6587\u4ef6\u521b\u5efa\u4e00\u4e2a IndexFile \u5b9e\u4f8b\u5bf9\u8c61\uff0c\u5e76\u52a0\u8f7d IndexHeader \u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean load(final boolean lastExitOK)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"deleteExpiredFile()\uff1a\u5220\u9664\u8fc7\u671f\u7d22\u5f15\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570 offset \u8868\u793a CommitLog \u5185\u6700\u65e9\u7684\u6d88\u606f\u7684 phyOffset\npublic void deleteExpiredFile(long offset)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.readWriteLock.readLock().lock()"}),"\uff1a\u52a0\u9501\u5224\u65ad"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long endPhyOffset = this.indexFileList.get(0).getEndPhyOffset()"}),"\uff1a\u83b7\u53d6\u76ee\u5f55\u4e2d\u7b2c\u4e00\u4e2a\u6587\u4ef6\u7684\u7ed3\u675f\u504f\u79fb\u91cf"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (endPhyOffset < offset)"}),"\uff1a\u7d22\u5f15\u76ee\u5f55\u5185\u5b58\u5728\u8fc7\u671f\u7684\u7d22\u5f15\u6587\u4ef6\uff0c\u5e76\u4e14\u5f53\u524d\u7684 IndexFile \u90fd\u662f\u8fc7\u671f\u7684\u6570\u636e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (int i = 0; i < (files.length - 1); i++)"}),"\uff1a\u904d\u5386\u6587\u4ef6\u5217\u8868\uff0c\u5220\u9664\u8fc7\u671f\u7684\u6587\u4ef6"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"buildIndex()\uff1a\u5b58\u50a8\u4e3b\u6a21\u5757 DefaultMessageStore \u5185\u90e8\u7684\u5f02\u6b65\u7ebf\u7a0b\u8c03\u7528\uff0c\u6784\u5efa Index \u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void buildIndex(DispatchRequest req)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"indexFile = retryGetAndCreateIndexFile()"}),"\uff1a\u83b7\u53d6\u6216\u8005\u521b\u5efa\u987a\u5e8f\u5199\u7684\u7d22\u5f15\u6587\u4ef6\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"buildKey(topic, req.getUniqKey())"}),"\uff1a",(0,l.jsxs)(n.strong,{children:["\u6784\u5efa\u7d22\u5f15 key\uff0c",(0,l.jsx)(n.code,{children:"topic + # + uniqKey"})]})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"indexFile = putKey()"}),"\uff1a\u63d2\u5165\u7d22\u5f15\u6587\u4ef6"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (keys != null && keys.length() > 0)"}),"\uff1a\u6d88\u606f\u5b58\u5728\u81ea\u5b9a\u4e49\u7d22\u5f15 keys"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (int i = 0; i < keyset.length; i++)"}),"\uff1a\u904d\u5386\u6bcf\u4e2a\u7d22\u5f15\uff0c\u4e3a\u6bcf\u4e2a key \u8c03\u7528\u4e00\u6b21 putKey"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"getAndCreateLastIndexFile()\uff1a\u83b7\u53d6\u5f53\u524d\u987a\u5e8f\u5199\u7684 IndexFile\uff0c\u6ca1\u6709\u5c31\u521b\u5efa"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public IndexFile getAndCreateLastIndexFile()\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"haservice",children:"HAService"}),"\n",(0,l.jsx)(n.h5,{id:"haservice-1",children:"HAService"}),"\n",(0,l.jsx)(n.h6,{id:"service",children:"Service"}),"\n",(0,l.jsx)(n.p,{children:"HAService \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e3b\u8282\u70b9\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// master \u8282\u70b9\u5f53\u524d\u6709\u591a\u5c11\u4e2a slave \u8282\u70b9\u4e0e\u5176\u8fdb\u884c\u6570\u636e\u540c\u6b65\nprivate final AtomicInteger connectionCount = new AtomicInteger(0);\n// master \u8282\u70b9\u4f1a\u7ed9\u6bcf\u4e2a\u53d1\u8d77\u8fde\u63a5\u7684 slave \u8282\u70b9\u7684\u901a\u9053\u521b\u5efa\u4e00\u4e2a HAConnection\uff0c\u3010\u63a7\u5236 master \u7aef\u5411 slave \u7aef\u4f20\u8f93\u6570\u636e\u3011\nprivate final List<HAConnection> connectionList = new LinkedList<>();\n// master \u5411 slave \u8282\u70b9\u63a8\u9001\u7684\u6700\u5927\u7684 offset\uff0c\u8868\u793a\u6570\u636e\u540c\u6b65\u7684\u8fdb\u5ea6\nprivate final AtomicLong push2SlaveMaxOffset = new AtomicLong(0)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5185\u90e8\u7c7b\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u5c01\u88c5\u4e86\u7ed1\u5b9a\u670d\u52a1\u5668\u6307\u5b9a\u7aef\u53e3\uff0c\u76d1\u542c slave \u7684\u8fde\u63a5\u7684\u903b\u8f91\uff0c\u6ca1\u6709\u4f7f\u7528 Netty\uff0c\u4f7f\u7528\u4e86\u539f\u751f\u6001\u7684 NIO \u53bb\u505a\nprivate final AcceptSocketService acceptSocketService;\n// \u63a7\u5236\u751f\u4ea7\u8005\u7ebf\u7a0b\u963b\u585e\u7b49\u5f85\u7684\u903b\u8f91\nprivate final GroupTransferService groupTransferService;\n// slave \u8282\u70b9\u7684\u5ba2\u6237\u7aef\u5bf9\u8c61\uff0c\u3010slave \u7aef\u624d\u4f1a\u6b63\u5e38\u8fd0\u884c\u8be5\u5b9e\u4f8b\u3011\nprivate final HAClient haClient;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ebf\u7a0b\u901a\u4fe1\u5bf9\u8c61\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final WaitNotifyObject waitNotifyObject = new WaitNotifyObject()\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u9ad8\u53ef\u7528\u670d\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void  start() throws Exception {\n    // \u76d1\u542c\u4ece\u8282\u70b9\n    this.acceptSocketService.beginAccept();\n    // \u542f\u52a8\u76d1\u542c\u670d\u52a1\n    this.acceptSocketService.start();\n    // \u542f\u52a8\u8f6c\u79fb\u670d\u52a1\n    this.groupTransferService.start();\n    // \u542f\u52a8\u4ece\u8282\u70b9\u5ba2\u6237\u7aef\u5b9e\u4f8b\n    this.haClient.start();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h6,{id:"accept",children:"Accept"}),"\n",(0,l.jsxs)(n.p,{children:["AcceptSocketService \u7c7b\u7528\u4e8e",(0,l.jsx)(n.strong,{children:"\u76d1\u542c\u4ece\u8282\u70b9\u7684\u8fde\u63a5"}),"\uff0c\u521b\u5efa HAConnection \u8fde\u63a5\u5bf9\u8c61"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7aef\u53e3\u4fe1\u606f\uff1aMaster \u7ed1\u5b9a\u76d1\u542c\u7684\u7aef\u53e3\u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final SocketAddress socketAddressListen;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u901a\u9053\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private ServerSocketChannel serverSocketChannel;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u591a\u8def\u590d\u7528\u5668\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private Selector selector;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["beginAccept()\uff1a\u5f00\u59cb\u76d1\u542c\u8fde\u63a5\uff0c",(0,l.jsx)(n.strong,{children:"NIO"})," \u6807\u51c6\u6a21\u677f"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void beginAccept()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u670d\u52a1\u542f\u52a8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.selector.select(1000)"}),"\uff1a\u591a\u8def\u590d\u7528\u5668\u963b\u585e\u83b7\u53d6\u5c31\u7eea\u7684\u901a\u9053\uff0c\u6700\u591a\u7b49\u5f85 1 \u79d2\u949f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Set<SelectionKey> selected = this.selector.selectedKeys()"}),"\uff1a\u83b7\u53d6\u9009\u62e9\u5668\u4e2d\u6240\u6709\u6ce8\u518c\u7684\u901a\u9053\u4e2d\u5df2\u7ecf\u5c31\u7eea\u597d\u7684\u4e8b\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (SelectionKey k : selected)"}),"\uff1a\u904d\u5386\u6240\u6709\u5c31\u7eea\u7684\u4e8b\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if ((k.readyOps() & SelectionKey.OP_ACCEPT) != 0)"}),"\uff1a\u8bf4\u660e ",(0,l.jsx)(n.code,{children:"OP_ACCEPT"})," \u4e8b\u4ef6\u5c31\u7eea"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SocketChannel sc = ((ServerSocketChannel) k.channel()).accept()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u5230\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u901a\u9053"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"HAConnection conn = new HAConnection(HAService.this, sc)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e3a\u6bcf\u4e2a\u8fde\u63a5 master \u670d\u52a1\u5668\u7684 slave \u521b\u5efa\u8fde\u63a5\u5bf9\u8c61"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"conn.start()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u542f\u52a8 HAConnection \u5bf9\u8c61"}),"\uff0c\u5185\u90e8\u542f\u52a8\u4e24\u4e2a\u670d\u52a1\u4e3a\u8bfb\u6570\u636e\u670d\u52a1\u3001\u5199\u6570\u636e\u670d\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"HAService.this.addConnection(conn)"}),"\uff1a\u52a0\u5165\u5230 HAConnection \u96c6\u5408\u5185"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h6,{id:"group",children:"Group"}),"\n",(0,l.jsx)(n.p,{children:"GroupTransferService \u7528\u6765\u63a7\u5236\u6570\u636e\u540c\u6b65"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"doWaitTransfer()\uff1a\u7b49\u5f85\u4e3b\u4ece\u6570\u636e\u540c\u6b65"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void doWaitTransfer()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (!this.requestsRead.isEmpty())"}),"\uff1a\u8bfb\u8bf7\u6c42\u4e0d\u4e3a\u7a7a"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean transferOK = HAService.this.push2SlaveMaxOffset... >= req.getNextOffset()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e3b\u4ece\u540c\u6b65\u662f\u5426\u5b8c\u6210"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"req.wakeupCustomer(transferOK ? ...)"}),"\uff1a\u5524\u9192\u6d88\u8d39\u8005"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.requestsRead.clear()"}),"\uff1a\u6e05\u7a7a\u8bfb\u8bf7\u6c42"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"swapRequests()\uff1a\u4ea4\u6362\u8bfb\u5199\u8bf7\u6c42"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void swapRequests()\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"haclient",children:"HAClient"}),"\n",(0,l.jsx)(n.h6,{id:"\u6210\u5458\u5c5e\u6027-7",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsxs)(n.p,{children:["HAClient \u662f slave \u7aef\u8fd0\u884c\u7684\u4ee3\u7801\uff0c\u7528\u4e8e",(0,l.jsx)(n.strong,{children:"\u548c master \u670d\u52a1\u5668\u5efa\u7acb\u957f\u8fde\u63a5"}),"\uff0c\u4e0a\u62a5\u672c\u5730\u540c\u6b65\u8fdb\u5ea6\uff0c\u6d88\u8d39\u670d\u52a1\u5668\u53d1\u6765\u7684 msg \u6570\u636e"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7f13\u51b2\u533a\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private static final int READ_MAX_BUFFER_SIZE = 1024 * 1024 * 4;\t// \u9ed8\u8ba4\u5927\u5c0f\uff1a4 MB\nprivate ByteBuffer byteBufferRead = ByteBuffer.allocate(READ_MAX_BUFFER_SIZE);\nprivate ByteBuffer byteBufferBackup = ByteBuffer.allocate(READ_MAX_BUFFER_SIZE);\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u4e3b\u8282\u70b9\u5730\u5740\uff1a\u683c\u5f0f\u4e3a ",(0,l.jsx)(n.code,{children:"ip:port"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final AtomicReference<String> masterAddress = new AtomicReference<>()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"NIO \u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ByteBuffer reportOffset;\t// \u901a\u4fe1\u4f7f\u7528NIO\uff0c\u6240\u4ee5\u6d88\u606f\u4f7f\u7528\u5757\u4f20\u8f93\uff0c\u4e0a\u62a5 slave offset \u4f7f\u7528\nprivate SocketChannel socketChannel;\t// \u5ba2\u6237\u7aef\u4e0e master \u7684\u4f1a\u8bdd\u901a\u9053\t\t\t\t\nprivate Selector selector;\t\t\t\t// \u591a\u8def\u590d\u7528\u5668\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u901a\u4fe1\u65f6\u95f4\uff1a\u4e0a\u6b21\u4f1a\u8bdd\u901a\u4fe1\u65f6\u95f4\uff0c\u7528\u4e8e\u63a7\u5236 socketChannel \u662f\u5426\u5173\u95ed\u7684"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private long lastWriteTimestamp = System.currentTimeMillis();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8fdb\u5ea6\u4fe1\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private long currentReportedOffset = 0;\t// slave \u5f53\u524d\u7684\u8fdb\u5ea6\u4fe1\u606f\nprivate int dispatchPosition = 0;\t\t// \u63a7\u5236 byteBufferRead position \u6307\u9488\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h6,{id:"\u6210\u5458\u65b9\u6cd5-6",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.connectMaster())"}),"\uff1a\u8fde\u63a5\u4e3b\u8282\u70b9\uff0c\u8fde\u63a5\u5931\u8d25\u4f1a\u4f11\u7720 5 \u79d2"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String addr = this.masterAddress.get()"}),"\uff1a\u83b7\u53d6 master \u66b4\u9732\u7684 HA \u5730\u5740\u7aef\u53e3\u4fe1\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.socketChannel = RemotingUtil.connect(socketAddress)"}),"\uff1a\u5efa\u7acb\u8fde\u63a5"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.socketChannel.register(this.selector, SelectionKey.OP_READ)"}),"\uff1a\u6ce8\u518c\u5230\u591a\u8def\u590d\u7528\u5668\uff0c",(0,l.jsx)(n.strong,{children:"\u5173\u6ce8\u8bfb\u4e8b\u4ef6"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.currentReportedOffset"}),"\uff1a \u521d\u59cb\u5316\u4e0a\u62a5\u8fdb\u5ea6\u5b57\u6bb5\u4e3a slave \u7684 maxPhyOffset"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.isTimeToReportOffset())"}),"\uff1aslave \u6bcf 5 \u79d2\u4f1a\u4e0a\u62a5\u4e00\u6b21 slave \u7aef\u7684\u540c\u6b65\u8fdb\u5ea6\u4fe1\u606f\u7ed9 master"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean result = this.reportSlaveMaxOffset()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e0a\u62a5\u540c\u6b65\u4fe1\u606f"}),"\uff0c\u4e0a\u62a5\u5931\u8d25\u5173\u95ed\u8fde\u63a5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.selector.select(1000)"}),"\uff1a\u591a\u8def\u590d\u7528\u5668\u963b\u585e\u83b7\u53d6\u5c31\u7eea\u7684\u901a\u9053\uff0c\u6700\u591a\u7b49\u5f85 1 \u79d2\u949f\uff0c",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u5230\u5c31\u7eea\u4e8b\u4ef6\u6216\u8005\u8d85\u65f6\u540e\u7ed3\u675f"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean ok = this.processReadEvent()"}),"\uff1a\u5904\u7406\u8bfb\u4e8b\u4ef6"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!reportSlaveMaxOffsetPlus())"}),"\uff1a\u68c0\u67e5\u662f\u5426\u91cd\u65b0\u4e0a\u62a5\u540c\u6b65\u8fdb\u5ea6"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"reportSlaveMaxOffset()\uff1a\u4e0a\u62a5 slave \u540c\u6b65\u8fdb\u5ea6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private boolean reportSlaveMaxOffset(final long maxOffset)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9996\u5148\u5411\u7f13\u51b2\u533a\u5199\u5165 slave \u7aef\u6700\u5927\u504f\u79fb\u91cf\uff0c\u5199\u5b8c\u4ee5\u540e\u5207\u6362\u4e3a\u6307\u5b9a\u7f6e\u4e3a\u521d\u59cb\u72b6\u6001"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (int i = 0; i < 3 && this.reportOffset.hasRemaining(); i++)"}),"\uff1a\u5c1d\u8bd5\u4e09\u6b21\u5199\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.socketChannel.write(this.reportOffset)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5199\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"return !this.reportOffset.hasRemaining()"}),"\uff1a\u5199\u6210\u529f\u4e4b\u540e pos = limit"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"processReadEvent()\uff1a\u5904\u7406 master \u53d1\u9001\u7ed9 slave \u6570\u636e\uff0c\u8fd4\u56de true \u8868\u793a\u5904\u7406\u6210\u529f   false \u8868\u793a Socket \u5904\u4e8e\u534a\u5173\u95ed\u72b6\u6001\uff0c\u9700\u8981\u4e0a\u5c42\u91cd\u5efa haClient"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private boolean processReadEvent()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int readSizeZeroTimes = 0"}),"\uff1a\u63a7\u5236 while \u5faa\u73af\u7684\u4e00\u4e2a\u6761\u4ef6\u53d8\u91cf\uff0c\u5f53\u503c\u4e3a 3 \u65f6\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (this.byteBufferRead.hasRemaining())"}),"\uff1abyteBufferRead \u6709\u7a7a\u95f4\u53ef\u4ee5\u53bb Socket \u8bfb\u7f13\u51b2\u533a\u52a0\u8f7d\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int readSize = this.socketChannel.read(this.byteBufferRead)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4ece\u901a\u9053\u8bfb\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (readSize > 0)"}),"\uff1a\u52a0\u8f7d\u6210\u529f\uff0c\u6709\u65b0\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"readSizeZeroTimes = 0"}),"\uff1a\u7f6e\u4e3a 0"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean result = this.dispatchReadRequest()"}),"\uff1a\u5904\u7406\u6570\u636e\u7684\u6838\u5fc3\u903b\u8f91"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else if (readSize == 0) "}),"\uff1a\u8fde\u7eed\u65e0\u65b0\u6570\u636e 3 \u6b21\uff0c\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1areadSize = -1 \u5c31\u8868\u793a Socket \u5904\u4e8e\u534a\u5173\u95ed\u72b6\u6001\uff0c\u5bf9\u7aef\u5df2\u7ecf\u5173\u95ed\u4e86"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["dispatchReadRequest()\uff1a",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u6570\u636e\u7684\u6838\u5fc3\u903b\u8f91"}),"\uff0cmaster \u4e0e slave \u4f20\u8f93\u7684\u6570\u636e\u683c\u5f0f ",(0,l.jsx)(n.code,{children:"{[phyOffset][size][data...]}"}),"\uff0cphyOffset \u8868\u793a\u6570\u636e\u533a\u95f4\u7684\u5f00\u59cb\u504f\u79fb\u91cf\uff0cdata \u4ee3\u8868\u6570\u636e\u5757\uff0c\u6700\u5927 32kb\uff0c\u53ef\u80fd\u5305\u542b\u591a\u6761\u6d88\u606f\u7684\u6570\u636e"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private boolean dispatchReadRequest()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final int msgHeaderSize = 8 + 4"}),"\uff1a\u534f\u8bae\u5934\u5927\u5c0f 12"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int readSocketPos = this.byteBufferRead.position()"}),"\uff1a\u8bb0\u5f55\u7f13\u51b2\u533a\u5904\u7406\u6570\u636e\u524d\u7684 pos \u4f4d\u70b9\uff0c\u7528\u4e8e\u6062\u590d\u6307\u9488"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int diff = ..."}),"\uff1a\u5f53\u524d byteBufferRead \u8fd8\u5269\u591a\u5c11 byte \u672a\u5904\u7406\uff0c\u6bcf\u5904\u7406\u4e00\u6761\u5e27\u6570\u636e\u90fd\u4f1a\u66f4\u65b0 dispatchPosition"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (diff >= msgHeaderSize)"}),"\uff1a\u7f13\u51b2\u533a\u8fd8\u6709\u5b8c\u6574\u7684\u534f\u8bae\u5934 header \u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (diff >= (msgHeaderSize + bodySize))"}),"\uff1a\u8bf4\u660e",(0,l.jsx)(n.strong,{children:"\u7f13\u51b2\u533a\u5185\u662f\u5305\u542b\u5f53\u524d\u5e27\u7684\u5168\u90e8\u6570\u636e\u7684"}),"\uff0c\u5f00\u59cb\u5904\u7406\u5e27\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"HAService...appendToCommitLog(masterPhyOffset, bodyData)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5b58\u50a8\u6570\u636e\u5230 CommitLog"}),"\uff0c\u5e76\u6784\u5efa Index \u548c CQ"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.byteBufferRead.position(readSocketPos)"}),"\uff1a\u6062\u590d byteBufferRead \u7684 pos \u6307\u9488"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.dispatchPosition += msgHeaderSize + bodySize"}),"\uff1a\u52a0\u4e00\u5e27\u6570\u636e\u957f\u5ea6\uff0c\u5904\u7406\u4e0b\u4e00\u6761\u6570\u636e\u4f7f\u7528"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!reportSlaveMaxOffsetPlus())"}),"\uff1a\u4e0a\u62a5 slave \u540c\u6b65\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!this.byteBufferRead.hasRemaining())"}),"\uff1a\u7f13\u51b2\u533a\u5199\u6ee1\u4e86\uff0c\u91cd\u65b0\u5206\u914d\u7f13\u51b2\u533a"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"reallocateByteBuffer()\uff1a\u91cd\u65b0\u5206\u914d\u7f13\u51b2\u533a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void reallocateByteBuffer()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int remain = READ_MAX_BUFFER_SIZE - this.dispatchPosition"}),"\uff1a\u8868\u793a\u7f13\u51b2\u533a\u5c1a\u672a\u5904\u7406\u8fc7\u7684\u5b57\u8282\u6570\u91cf"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (remain > 0)"}),"\uff1a\u6761\u4ef6\u6210\u7acb\uff0c\u8bf4\u660e\u7f13\u51b2\u533a",(0,l.jsx)(n.strong,{children:"\u6700\u540e\u4e00\u5e27\u6570\u636e\u662f\u534a\u5305\u6570\u636e"}),"\uff0c\u4f46\u662f\u4e0d\u80fd\u4e22\u5931\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.byteBufferBackup.put(this.byteBufferRead)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u534a\u5305\u6570\u636e\u62f7\u8d1d\u5230 backup \u7f13\u51b2\u533a"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.swapByteBuffer()"}),"\uff1a\u4ea4\u6362 backup \u6210\u4e3a read"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.byteBufferRead.position(remain)"}),"\uff1a\u8bbe\u7f6e pos \u4e3a remain \uff0c\u540e\u7eed\u52a0\u8f7d\u6570\u636e pos \u4eceremain \u5f00\u59cb\u5411\u540e\u79fb\u52a8"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.dispatchPosition = 0"}),"\uff1a\u5f53\u524d\u7f13\u51b2\u533a\u4ea4\u6362\u4e4b\u540e\uff0c\u76f8\u5f53\u4e8e\u662f\u4e00\u4e2a\u5168\u65b0\u7684 byteBuffer\uff0c\u6240\u4ee5\u5206\u914d\u6307\u9488\u5f52\u96f6"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"haconn",children:"HAConn"}),"\n",(0,l.jsx)(n.h6,{id:"connection",children:"Connection"}),"\n",(0,l.jsx)(n.p,{children:"HAConnection \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4f1a\u8bdd\u901a\u9053\uff1amaster \u548c slave \u4e4b\u95f4\u901a\u4fe1\u7684 SocketChannel"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final SocketChannel socketChannel;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u5730\u5740\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final String clientAddr;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7c7b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private WriteSocketService writeSocketService;\t// \u5199\u6570\u636e\u670d\u52a1\nprivate ReadSocketService readSocketService;\t// \u8bfb\u6570\u636e\u670d\u52a1\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8bf7\u6c42\u4f4d\u70b9\uff1a\u5728 slave \u4e0a\u62a5\u672c\u5730\u7684\u8fdb\u5ea6\u4e4b\u540e\u88ab\u8d4b\u503c\uff0c\u8be5\u503c\u5927\u4e8e 0 \u540e\u540c\u6b65\u903b\u8f91\u624d\u4f1a\u8fd0\u884c\uff0cmaster \u5982\u679c\u4e0d\u77e5\u9053 slave \u8282\u70b9\u5f53\u524d\u6d88\u606f\u7684\u5b58\u50a8\u8fdb\u5ea6\uff0c\u5c31\u65e0\u6cd5\u7ed9 slave \u63a8\u9001\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile long slaveRequestOffset = -1;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5e94\u7b54\u4f4d\u70b9\uff1a \u4fdd\u5b58\u6700\u65b0\u7684 slave \u4e0a\u62a5\u7684 offset \u4fe1\u606f\uff0cslaveAckOffset \u4e4b\u524d\u7684\u6570\u636e\u90fd\u53ef\u4ee5\u8ba4\u4e3a slave \u5df2\u7ecf\u540c\u6b65\u5b8c\u6210"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile long slaveAckOffset = -1;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public HAConnection(final HAService haService, final SocketChannel socketChannel) {\n    // \u521d\u59cb\u5316\u4e00\u4e9b\u4e1c\u897f\n    // \u8bbe\u7f6e socket \u8bfb\u5199\u7f13\u51b2\u533a\u4e3a 64kb \u5927\u5c0f\n    this.socketChannel.socket().setReceiveBufferSize(1024 * 64);\n    this.socketChannel.socket().setSendBufferSize(1024 * 64);\n    // \u521b\u5efa\u8bfb\u5199\u670d\u52a1\n    this.writeSocketService = new WriteSocketService(this.socketChannel);\n    this.readSocketService = new ReadSocketService(this.socketChannel);\n    // \u81ea\u589e\n    this.haService.getConnectionCount().incrementAndGet();\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u542f\u52a8\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start() {\n    this.readSocketService.start();\n    this.writeSocketService.start();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h6,{id:"readsocket",children:"ReadSocket"}),"\n",(0,l.jsxs)(n.p,{children:["ReadSocketService \u7c7b\u662f\u4e00\u4e2a\u4efb\u52a1\u5bf9\u8c61\uff0cslave \u5411 master \u4f20\u8f93\u7684\u5e27\u683c\u5f0f\u4e3a ",(0,l.jsx)(n.code,{children:"[long][long][long]"}),"\uff0c\u4e0a\u62a5\u7684\u662f slave \u672c\u5730\u7684\u540c\u6b65\u8fdb\u5ea6\uff0c\u540c\u6b65\u8fdb\u5ea6\u662f\u4e00\u4e2a long \u503c"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8bfb\u7f13\u51b2\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private static final int READ_MAX_BUFFER_SIZE = 1024 * 1024;\t// \u9ed8\u8ba4\u5927\u5c0f 1MB\nprivate final ByteBuffer byteBufferRead = ByteBuffer.allocate(READ_MAX_BUFFER_SIZE);\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"NIO \u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final Selector selector;\t\t\t// \u591a\u8def\u590d\u7528\u5668\nprivate final SocketChannel socketChannel;\t// master \u4e0e slave \u4e4b\u95f4\u7684\u4f1a\u8bdd SocketChannel\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5904\u7406\u4f4d\u70b9\uff1a\u7f13\u51b2\u533a\u5904\u7406\u4f4d\u70b9"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private int processPosition = 0;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e0a\u6b21\u8bfb\u64cd\u4f5c\u7684\u65f6\u95f4\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile long lastReadTimestamp = System.currentTimeMillis();\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public ReadSocketService(final SocketChannel socketChannel)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.socketChannel.register(this.selector, SelectionKey.OP_READ)"}),"\uff1a\u901a\u9053\u6ce8\u518c\u5230\u591a\u8def\u590d\u7528\u5668\uff0c\u5173\u6ce8\u8bfb\u4e8b\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.setDaemon(true)"}),"\uff1a\u8bbe\u7f6e\u4e3a\u5b88\u62a4\u7ebf\u7a0b"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8fd0\u884c\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.selector.select(1000)"}),"\uff1a\u591a\u8def\u590d\u7528\u5668\u963b\u585e\u83b7\u53d6\u5c31\u7eea\u7684\u901a\u9053\uff0c\u6700\u591a\u7b49\u5f85 1 \u79d2\u949f\uff0c\u83b7\u53d6\u5230\u5c31\u7eea\u4e8b\u4ef6\u6216\u8005\u8d85\u65f6\u540e\u7ed3\u675f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean ok = this.processReadEvent()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8bfb\u6570\u636e\u7684\u6838\u5fc3\u65b9\u6cd5"}),"\uff0c\u8fd4\u56de true \u8868\u793a\u5904\u7406\u6210\u529f   false \u8868\u793a Socket \u5904\u4e8e\u534a\u5173\u95ed\u72b6\u6001\uff0c\u9700\u8981\u4e0a\u5c42\u91cd\u5efa HAConnection \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int readSizeZeroTimes = 0"}),"\uff1a\u63a7\u5236 while \u5faa\u73af\uff0c\u5f53\u8fde\u7eed\u4ece Socket \u8bfb\u53d6\u5931\u8d25 3 \u6b21\uff08\u672a\u52a0\u8f7d\u5230\u6570\u636e\uff09\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!this.byteBufferRead.hasRemaining())"}),"\uff1abyteBufferRead \u5df2\u7ecf\u5168\u90e8\u4f7f\u7528\u5b8c\uff0c\u9700\u8981\u6e05\u7406\u6570\u636e\u5e76\u66f4\u65b0\u4f4d\u70b9"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (this.byteBufferRead.hasRemaining())"}),"\uff1abyteBufferRead \u6709\u7a7a\u95f4\u53ef\u4ee5\u53bb Socket \u8bfb\u7f13\u51b2\u533a\u52a0\u8f7d\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int readSize = this.socketChannel.read(this.byteBufferRead)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4ece\u901a\u9053\u8bfb\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (readSize > 0)"}),"\uff1a\u52a0\u8f7d\u6210\u529f\uff0c\u6709\u65b0\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if ((byteBufferRead.position() - processPosition) >= 8)"}),"\uff1a\u7f13\u51b2\u533a\u7684\u53ef\u8bfb\u6570\u636e\u6700\u5c11\u5305\u542b\u4e00\u4e2a\u6570\u636e\u5e27"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int pos = ..."}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u53ef\u8bfb\u5e27\u6570\u636e\u4e2d\u6700\u540e\u4e00\u4e2a\u5b8c\u6574\u7684\u5e27\u6570\u636e\u7684\u4f4d\u70b9\uff0c\u540e\u9762\u7684\u6570\u636e\u4e22\u5f03"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long readOffset = ...byteBufferRead.getLong(pos - 8)"}),"\uff1a\u8bfb\u53d6\u6700\u540e\u4e00\u5e27\u6570\u636e\uff0cslave \u7aef\u5f53\u524d\u7684\u540c\u6b65\u8fdb\u5ea6\u4fe1\u606f"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.processPosition = pos"}),"\uff1a\u66f4\u65b0\u5904\u7406\u4f4d\u70b9"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"HAConnection.this.slaveAckOffset = readOffset"}),"\uff1a\u66f4\u65b0\u5e94\u7b54\u4f4d\u70b9"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (HAConnection.this.slaveRequestOffset < 0)"}),"\uff1a\u6761\u4ef6\u6210\u7acb",(0,l.jsx)(n.strong,{children:"\u7ed9 slaveRequestOffset \u8d4b\u503c"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"HAConnection...notifyTransferSome(slaveAckOffset)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5524\u9192\u963b\u585e\u7684\u751f\u4ea7\u8005\u7ebf\u7a0b"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else if (readSize == 0) "}),"\uff1a\u8bfb\u53d6 3 \u6b21\u65e0\u65b0\u6570\u636e\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1areadSize = -1 \u5c31\u8868\u793a Socket \u5904\u4e8e\u534a\u5173\u95ed\u72b6\u6001\uff0c\u5bf9\u7aef\u5df2\u7ecf\u5173\u95ed\u4e86"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (interval > 20)"}),"\uff1a\u8d85\u8fc7 20 \u79d2\u672a\u53d1\u751f\u901a\u4fe1\uff0c\u76f4\u63a5\u7ed3\u675f\u5faa\u73af"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h6,{id:"writesocket",children:"WriteSocket"}),"\n",(0,l.jsxs)(n.p,{children:["WriteSocketService \u7c7b\u662f\u4e00\u4e2a\u4efb\u52a1\u5bf9\u8c61\uff0cmaster \u5411 slave \u4f20\u8f93\u7684\u6570\u636e\u5e27\u683c\u5f0f\u4e3a ",(0,l.jsx)(n.code,{children:"{[phyOffset][size][data...]}{[phyOffset][size][data...]}"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"phyOffset\uff1a\u6570\u636e\u533a\u95f4\u7684\u5f00\u59cb\u504f\u79fb\u91cf\uff0c\u5e76\u4e0d\u8868\u793a\u67d0\u4e00\u6761\u5177\u4f53\u7684\u6d88\u606f\uff0c\u8868\u793a\u7684\u6570\u636e\u5757\u5f00\u59cb\u7684\u504f\u79fb\u91cf\u4f4d\u7f6e"}),"\n",(0,l.jsx)(n.li,{children:"size\uff1a\u540c\u6b65\u7684\u6570\u636e\u5757\u7684\u5927\u5c0f"}),"\n",(0,l.jsx)(n.li,{children:"data\uff1a\u6570\u636e\u5757\uff0c\u6700\u5927 32kb\uff0c\u53ef\u80fd\u5305\u542b\u591a\u6761\u6d88\u606f\u7684\u6570\u636e"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u534f\u8bae\u5934\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final int headerSize = 8 + 4;\t\t// \u534f\u8bae\u5934\u5927\u5c0f\uff1a12\nprivate final ByteBuffer byteBufferHeader;\t// \u5e27\u5934\u7f13\u51b2\u533a\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"NIO \u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final Selector selector;\t\t\t// \u591a\u8def\u590d\u7528\u5668\nprivate final SocketChannel socketChannel;\t// master \u4e0e slave \u4e4b\u95f4\u7684\u4f1a\u8bdd SocketChannel\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5904\u7406\u4f4d\u70b9\uff1a\u4e0b\u4e00\u6b21\u4f20\u8f93\u540c\u6b65\u6570\u636e\u7684\u4f4d\u7f6e\u4fe1\u606f\uff0cmaster \u7ed9\u5f53\u524d slave \u540c\u6b65\u7684\u4f4d\u70b9"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private long nextTransferFromWhere = -1;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e0a\u6b21\u5199\u64cd\u4f5c\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private boolean lastWriteOver = true;\t\t\t\t\t\t\t// \u4e0a\u4e00\u8f6e\u6570\u636e\u662f\u5426\u4f20\u8f93\u5b8c\u6bd5\nprivate long lastWriteTimestamp = System.currentTimeMillis();\t// \u4e0a\u6b21\u5199\u64cd\u4f5c\u7684\u65f6\u95f4\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public WriteSocketService(final SocketChannel socketChannel)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.socketChannel.register(this.selector, SelectionKey.OP_WRITE)"}),"\uff1a\u901a\u9053\u6ce8\u518c\u5230\u591a\u8def\u590d\u7528\u5668\uff0c\u5173\u6ce8\u5199\u4e8b\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.setDaemon(true)"}),"\uff1a\u8bbe\u7f6e\u4e3a\u5b88\u62a4\u7ebf\u7a0b"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8fd0\u884c\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.selector.select(1000)"}),"\uff1a\u591a\u8def\u590d\u7528\u5668\u963b\u585e\u83b7\u53d6\u5c31\u7eea\u7684\u901a\u9053\uff0c\u6700\u591a\u7b49\u5f85 1 \u79d2\u949f\uff0c\u83b7\u53d6\u5230\u5c31\u7eea\u4e8b\u4ef6\u6216\u8005\u8d85\u65f6\u540e\u7ed3\u675f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (-1 == HAConnection.this.slaveRequestOffset)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u7b49\u5f85 slave \u540c\u6b65\u5b8c\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (-1 == this.nextTransferFromWhere)"}),"\uff1a\u6761\u4ef6\u6210\u7acb\uff0c\u9700\u8981\u521d\u59cb\u5316\u8be5\u53d8\u91cf"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (0 == HAConnection.this.slaveRequestOffset)"}),"\uff1aslave \u662f\u4e00\u4e2a\u5168\u65b0\u8282\u70b9\uff0c\u4ece\u6b63\u5728\u987a\u5e8f\u5199\u7684 MF \u5f00\u59cb\u540c\u6b65\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long masterOffset = ..."}),"\uff1a\u83b7\u53d6 master \u6700\u5927\u7684 offset\uff0c\u5e76\u8ba1\u7b97\u5f52\u5c5e\u7684 mappedFile \u6587\u4ef6\u7684\u5f00\u59cb offset"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.nextTransferFromWhere = masterOffset"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8d4b\u503c\u7ed9\u4e0b\u4e00\u6b21\u4f20\u8f93\u540c\u6b65\u6570\u636e\u7684\u4f4d\u7f6e\u4fe1\u606f"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.nextTransferFromWhere = HAConnection.this.slaveRequestOffset"}),"\uff1a\u5927\u90e8\u5206\u60c5\u51b5\u8d70\u8fd9\u4e2a\u8d4b\u503c\u903b\u8f91"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.lastWriteOver)"}),"\uff1a\u4e0a\u4e00\u6b21\u5f85\u53d1\u9001\u6570\u636e\u5168\u90e8\u53d1\u9001\u5b8c\u6210"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (interval > 5)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8d85\u8fc7 5 \u79d2\u672a\u540c\u6b65\u6570\u636e\uff0c\u53d1\u9001\u4e00\u4e2a header \u5fc3\u8df3\u6570\u636e\u5305\uff0c\u7ef4\u6301\u957f\u8fde\u63a5"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u4e0a\u4e00\u8f6e\u7684\u5f85\u53d1\u9001\u6570\u636e\u672a\u5168\u90e8\u53d1\u9001\uff0c\u9700\u8981\u540c\u6b65\u6570\u636e\u5230 slave \u8282\u70b9"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"SelectMappedBufferResult selectResult"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5230 CommitLog \u4e2d\u67e5\u8be2 nextTransferFromWhere \u5f00\u59cb\u4f4d\u7f6e\u7684\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (size > 32k)"}),"\uff1a\u4e00\u6b21\u6700\u591a\u540c\u6b65 32k \u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.nextTransferFromWhere += size"}),"\uff1a\u589e\u52a0 size\uff0c\u4e0b\u4e00\u8f6e\u4f20\u8f93\u8df3\u8fc7\u672c\u5e27\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"selectResult.getByteBuffer().limit(size)"}),"\uff1a\u8bbe\u7f6e byteBuffer \u53ef\u8bbf\u95ee\u6570\u636e\u533a\u95f4\u4e3a [pos, size]"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.selectMappedBufferResult = selectResult"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5f85\u53d1\u9001\u7684\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.byteBufferHeader.put"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6784\u5efa\u5e27\u5934\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.lastWriteOver = this.transferData()"}),"\uff1a\u5904\u7406\u6570\u636e\uff0c\u8fd4\u56de\u662f\u5426\u5904\u7406\u5b8c\u6210"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u540c\u6b65\u65b9\u6cd5\uff1a",(0,l.jsx)(n.strong,{children:"\u540c\u6b65\u6570\u636e\u5230 slave \u8282\u70b9"}),"\uff0c\u8fd4\u56de true \u8868\u793a\u672c\u8f6e\u6570\u636e\u5168\u90e8\u540c\u6b65\u5b8c\u6210\uff0cfalse \u8868\u793a\u672c\u8f6e\u540c\u6b65\u672a\u5b8c\u6210\uff08Header \u548c Body \u5176\u4e2d\u4e00\u4e2a\u672a\u540c\u6b65\u5b8c\u6210\u90fd\u4f1a\u8fd4\u56de false\uff09"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private boolean transferData()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int writeSizeZeroTimes= 0"}),"\uff1a\u63a7\u5236 while \u5faa\u73af\uff0c\u5f53\u5199\u5931\u8d25\u8fde\u7eed 3 \u6b21\u65f6\uff0c\u8df3\u51fa\u5faa\u73af\uff09\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (this.byteBufferHeader.hasRemaining())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5e27\u5934\u6570\u636e\u7f13\u51b2\u533a\u6709\u5f85\u53d1\u9001\u7684\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int writeSize = this.socketChannel.write(this.byteBufferHeader)"}),"\uff1a\u5411\u901a\u9053\u5199\u5e27\u5934\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == this.selectMappedBufferResult)"}),"\uff1a\u8bf4\u660e\u662f\u5fc3\u8df3\u6570\u636e\uff0c\u8fd4\u56de\u5fc3\u8df3\u6570\u636e\u662f\u5426\u53d1\u9001\u5b8c\u6210"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!this.byteBufferHeader.hasRemaining())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"Header\u5199\u6210\u529f\u4e4b\u540e\uff0c\u624d\u8fdb\u884c\u5199 Body"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (this.selectMappedBufferResult.getByteBuffer().hasRemaining())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6570\u636e\u7f13\u51b2\u533a\u6709\u5f85\u53d1\u9001\u7684\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int writeSize = this.socketChannel.write(this.selectMappedBufferResult...)"}),"\uff1a\u5411\u901a\u9053\u5199\u5e27\u5934\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (writeSize > 0)"}),"\uff1a\u5199\u6570\u636e\u6210\u529f\uff0c\u4f46\u662f\u4e0d\u4ee3\u8868 SMBR \u4e2d\u7684\u6570\u636e\u5168\u90e8\u5199\u5b8c\u6210"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean result"}),"\uff1a\u5224\u65ad\u662f\u5426\u53d1\u9001\u5b8c\u6210\uff0c\u8fd4\u56de\u8be5\u503c"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"messtore",children:"MesStore"}),"\n",(0,l.jsx)(n.h5,{id:"\u751f\u547d\u5468\u671f-1",children:"\u751f\u547d\u5468\u671f"}),"\n",(0,l.jsx)(n.p,{children:"DefaultMessageStore \u7c7b\u6838\u5fc3\u662f\u6574\u4e2a\u5b58\u50a8\u670d\u52a1\u7684\u8c03\u5ea6\u7c7b"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public DefaultMessageStore()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.allocateMappedFileService.start()"}),"\uff1a\u542f\u52a8",(0,l.jsx)(n.strong,{children:"\u521b\u5efa MappedFile \u6587\u4ef6\u670d\u52a1"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.indexService.start()"}),"\uff1a\u542f\u52a8\u7d22\u5f15\u670d\u52a1"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"load()\uff1a\u5148\u52a0\u8f7d CommitLog\uff0c\u518d\u52a0\u8f7d ConsumeQueue\uff0c\u6700\u540e\u52a0\u8f7d IndexFile\uff0c\u52a0\u8f7d\u5b8c\u8fdb\u5165\u6062\u590d\u9636\u6bb5\uff0c\u5148\u6062\u590d CQ\uff0c\u5728\u6062\u590d CL"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean load()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u6838\u5fc3\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"lock = lockFile.getChannel().tryLock(0, 1, false)"}),"\uff1a\u83b7\u53d6\u6587\u4ef6\u9501\uff0c\u83b7\u53d6\u5931\u8d25\u8bf4\u660e\u5f53\u524d\u76ee\u5f55\u5df2\u7ecf\u542f\u52a8\u8fc7 Broker"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long maxPhysicalPosInLogicQueue = commitLog.getMinOffset()"}),"\uff1a\u904d\u5386\u5168\u90e8\u7684 CQ \u5bf9\u8c61\uff0c\u83b7\u53d6 CQ \u4e2d\u6d88\u606f\u7684\u6700\u5927\u504f\u79fb\u91cf"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.reputMessageService.start()"}),"\uff1a\u8bbe\u7f6e\u5206\u53d1\u670d\u52a1\u7684\u5206\u53d1\u4f4d\u70b9\uff0c\u542f\u52a8",(0,l.jsx)(n.strong,{children:"\u5206\u53d1\u670d\u52a1"}),"\uff0c\u6784\u5efa ConsumerQueue \u548c IndexFile"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (dispatchBehindBytes() <= 0)"}),"\uff1a\u7ebf\u7a0b\u7b49\u5f85\u5206\u53d1\u670d\u52a1\u5c06\u5206\u53d1\u6570\u636e\u5168\u90e8\u5904\u7406\u5b8c\u6bd5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.recoverTopicQueueTable()"}),"\uff1a\u56e0\u4e3a\u4fee\u6539\u4e86 CQ \u6570\u636e\uff0c\u6240\u4ee5\u518d\u6b21\u6784\u5efa\u961f\u5217\u504f\u79fb\u91cf\u5b57\u6bb5\u8868"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.haService.start()"}),"\uff1a\u542f\u52a8 ",(0,l.jsx)(n.strong,{children:"HA \u670d\u52a1"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.handleScheduleMessageService()"}),"\uff1a\u542f\u52a8",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u8c03\u5ea6\u670d\u52a1"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.flushConsumeQueueService.start()"}),"\uff1a\u542f\u52a8 CQ ",(0,l.jsx)(n.strong,{children:"\u6d88\u8d39\u961f\u5217\u5237\u76d8\u670d\u52a1"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.commitLog.start()"}),"\uff1a\u542f\u52a8 ",(0,l.jsx)(n.strong,{children:"CL \u5237\u76d8\u670d\u52a1"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.storeStatsService.start()"}),"\uff1a\u542f\u52a8\u72b6\u6001\u5b58\u50a8\u670d\u52a1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.createTempFile()"}),"\uff1a\u521b\u5efa AbortFile\uff0c\u6b63\u5e38\u5173\u673a\u65f6 JVM HOOK \u4f1a\u5220\u9664\u8be5\u6587\u4ef6\uff0c",(0,l.jsx)(n.strong,{children:"\u5f02\u5e38\u5b95\u673a\u65f6\u8be5\u6587\u4ef6\u4e0d\u4f1a\u5220\u9664"}),"\uff0c\u5f00\u673a\u6570\u636e\u6062\u590d\u9636\u6bb5\u6839\u636e\u662f\u5426\u5b58\u5728\u8be5\u6587\u4ef6\uff0c\u6267\u884c\u4e0d\u540c\u7684\u6062\u590d\u7b56\u7565"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.addScheduleTask()"}),"\uff1a\u6dfb\u52a0\u5b9a\u65f6\u4efb\u52a1"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore.this.cleanFilesPeriodically()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5b9a\u65f6\u6e05\u7406\u8fc7\u671f\u6587\u4ef6"}),"\uff0c\u5468\u671f\u662f 10 \u79d2"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.cleanCommitLogService.run()"}),"\uff1a\u542f\u52a8\u6e05\u7406\u8fc7\u671f\u7684 CL \u6587\u4ef6\u670d\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.cleanConsumeQueueService.run()"}),"\uff1a\u542f\u52a8\u6e05\u7406\u8fc7\u671f\u7684 CQ \u6587\u4ef6\u670d\u52a1"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore.this.checkSelf()"}),"\uff1a\u6bcf 10 \u5206\u79cd\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore.this.cleanCommitLogService.isSpaceFull()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u78c1\u76d8\u9884\u8b66\u5b9a\u65f6\u4efb\u52a1"}),"\uff0c\u6bcf 10 \u79d2\u4e00\u6b21"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (physicRatio > this.diskSpaceWarningLevelRatio)"}),"\uff1a\u68c0\u67e5\u78c1\u76d8\u662f\u5426\u5230\u8fbe waring \u9608\u503c\uff0c\u9ed8\u8ba4 90%"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean diskok = ...runningFlags.getAndMakeDiskFull()"}),"\uff1a\u8bbe\u7f6e\u78c1\u76d8\u5199\u6ee1\u6807\u8bb0"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean diskok = ...this.runningFlags.getAndMakeDiskOK()"}),"\uff1a\u8bbe\u7f6e\u78c1\u76d8\u53ef\u5199\u6807\u8bb0"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.shutdown = false"}),"\uff1a\u521a\u542f\u52a8\uff0c\u8bbe\u7f6e\u4e3a false"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"shutdown()\uff1a\u5173\u95ed\u5404\u79cd\u670d\u52a1\u548c\u7ebf\u7a0b\u8d44\u6e90\uff0c\u8bbe\u7f6e\u5b58\u50a8\u6a21\u5757\u72b6\u6001\u4e3a\u5173\u95ed\u72b6\u6001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void shutdown()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"destroy()\uff1a\u9500\u6bc1 Broker \u7684\u5de5\u4f5c\u76ee\u5f55"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void destroy()\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u670d\u52a1\u7ebf\u7a0b-1",children:"\u670d\u52a1\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:"ServiceThread \u7c7b\u88ab\u5f88\u591a\u670d\u52a1\u7ee7\u627f\uff0c\u672c\u8eab\u662f\u4e00\u4e2a Runnable \u4efb\u52a1\u5bf9\u8c61\uff0c\u7ee7\u627f\u8005\u901a\u8fc7\u91cd\u5199 run \u65b9\u6cd5\u6765\u5b9e\u73b0\u670d\u52a1\u7684\u903b\u8f91"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u4e00\u822c\u5b9e\u73b0\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run() {\n    while (!this.isStopped()) {\n        // \u4e1a\u52a1\u903b\u8f91\n    }\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u901a\u8fc7\u53c2\u6570 stopped \u63a7\u5236\u670d\u52a1\u7684\u505c\u6b62\uff0c\u4f7f\u7528 volatile \u4fee\u9970\u4fdd\u8bc1\u53ef\u89c1\u6027"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected volatile boolean stopped = false\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"shutdown()\uff1a\u505c\u6b62\u7ebf\u7a0b\uff0c\u9996\u5148\u8bbe\u7f6e stopped \u4e3a true\uff0c\u7136\u540e\u8fdb\u884c\u5524\u9192\uff0c\u9ed8\u8ba4\u4e0d\u76f4\u63a5\u6253\u65ad\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void shutdown()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"waitForRunning()\uff1a\u6302\u8d77\u7ebf\u7a0b\uff0c\u8bbe\u7f6e\u5524\u9192\u6807\u8bb0 hasNotified \u4e3a false"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected void waitForRunning(long interval)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"wakeup()\uff1a\u5524\u9192\u7ebf\u7a0b\uff0c\u8bbe\u7f6e hasNotified \u4e3a true"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void wakeup()\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6784\u5efa\u670d\u52a1",children:"\u6784\u5efa\u670d\u52a1"}),"\n",(0,l.jsxs)(n.p,{children:["AllocateMappedFileService ",(0,l.jsx)(n.strong,{children:"\u521b\u5efa MappedFile \u670d\u52a1"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"mmapOperation()\uff1a\u6838\u5fc3\u670d\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private boolean mmapOperation()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"req = this.requestQueue.take()"}),"\uff1a ",(0,l.jsx)(n.strong,{children:"\u4ece requestQueue \u963b\u585e\u961f\u5217\uff08\u4f18\u5148\u7ea7\uff09\u4e2d\u83b7\u53d6 AllocateRequest \u4efb\u52a1"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (...isTransientStorePoolEnable())"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u4f7f\u7528\u76f4\u63a5\u5185\u5b58\u5199\u5165\u6570\u636e\uff0c \u4ece\u76f4\u63a5\u5185\u5b58\u4e2d commit \u5230 FileChannel \u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mappedFile = new MappedFile(req.getFilePath(), req.getFileSize())"}),"\uff1a\u6839\u636e\u8bf7\u6c42\u7684\u8def\u5f84\u548c\u5927\u5c0f\u521b\u5efa\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mappedFile.warmMappedFile()"}),"\uff1a\u5224\u65ad mappedFile \u5927\u5c0f\uff0c\u53ea\u6709 CommitLog \u624d\u8fdb\u884c\u6587\u4ef6\u9884\u70ed"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"req.setMappedFile(mappedFile)"}),"\uff1a\u5c06\u521b\u5efa\u597d\u7684 MF \u5bf9\u8c61\u7684\u8d4b\u503c\u7ed9\u8bf7\u6c42\u5bf9\u8c61\u7684\u6210\u5458\u5c5e\u6027"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"req.getCountDownLatch().countDown()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5524\u9192\u8bf7\u6c42\u7684\u963b\u585e\u7ebf\u7a0b"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"putRequestAndReturnMappedFile()\uff1aMappedFileQueue \u4e2d\u7528\u6765\u521b\u5efa MF \u5bf9\u8c61\u7684\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public MappedFile putRequestAndReturnMappedFile(String nextFilePath, String nextNextFilePath, int fileSize)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"AllocateRequest nextReq = new AllocateRequest(...)"}),"\uff1a\u521b\u5efa nextFilePath \u7684 AllocateRequest \u5bf9\u8c61\uff0c\u653e\u5165\u8bf7\u6c42\u5217\u8868\u548c\u963b\u585e\u961f\u5217\uff0c\u7136\u540e\u521b\u5efa nextNextFilePath \u7684 AllocateRequest \u5bf9\u8c61\uff0c\u653e\u5165\u8bf7\u6c42\u5217\u8868\u548c\u963b\u585e\u961f\u5217"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"AllocateRequest result = this.requestTable.get(nextFilePath)"}),"\uff1a\u4ece\u8bf7\u6c42\u5217\u8868\u83b7\u53d6 nextFilePath \u7684\u8bf7\u6c42\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"result.getCountDownLatch().await(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u7ebf\u7a0b\u6302\u8d77"}),"\uff0c\u76f4\u5230\u8d85\u65f6\u6216\u8005 nextFilePath \u5bf9\u5e94\u7684 MF \u6587\u4ef6\u521b\u5efa\u5b8c\u6210"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"return result.getMappedFile()"}),"\uff1a\u8fd4\u56de\u521b\u5efa\u597d\u7684 MF \u6587\u4ef6\u5bf9\u8c61"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["ReputMessageService \u6d88\u606f\u5206\u53d1\u670d\u52a1\uff0c\u7528\u4e8e\u6784",(0,l.jsx)(n.strong,{children:"\u5efa ConsumerQueue \u548c IndexFile \u6587\u4ef6"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["run()\uff1a",(0,l.jsx)(n.strong,{children:"\u5faa\u73af\u6267\u884c doReput \u65b9\u6cd5"}),"\uff0c",(0,l.jsx)(n.strong,{children:"\u6240\u4ee5\u53d1\u9001\u7684\u6d88\u606f\u5b58\u50a8\u8fdb CL \u5c31\u53ef\u4ee5\u4ea7\u751f\u5bf9\u5e94\u7684 CQ"}),"\uff0c\u6bcf\u6267\u884c\u4e00\u6b21\u7ebf\u7a0b\u4f11\u7720 1 \u6beb\u79d2"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"doReput()\uff1a\u5b9e\u73b0\u5206\u53d1\u7684\u6838\u5fc3\u903b\u8f91"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void doReput()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (boolean doNext = true; this.isCommitLogAvailable() && doNext; )"}),"\uff1a\u5faa\u73af\u904d\u5386"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SelectMappedBufferResult result"}),"\uff1a \u4ece CommitLog \u62c9\u53d6\u6570\u636e\uff0c\u6570\u636e\u8303\u56f4 ",(0,l.jsx)(n.code,{children:"[reputFromOffset, \u5305\u542b\u8be5\u504f\u79fb\u91cf\u7684 MF \u7684\u6700\u5927 Pos]"}),"\uff0c\u5c01\u88c5\u6210\u7ed3\u679c\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"DispatchRequest dispatchRequest"}),"\uff1a\u4ece\u7ed3\u679c\u5bf9\u8c61\u8bfb\u53d6\u51fa\u4e00\u6761 DispatchRequest \u6570\u636e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore.this.doDispatch(dispatchRequest)"}),"\uff1a\u5c06\u6570\u636e\u4ea4\u7ed9\u5206\u53d1\u5668\u8fdb\u884c\u5206\u53d1\uff0c\u7528\u4e8e",(0,l.jsx)(n.strong,{children:"\u6784\u5efa CQ \u548c\u7d22\u5f15\u6587\u4ef6"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.reputFromOffset += size"}),"\uff1a\u66f4\u65b0\u6570\u636e\u8303\u56f4"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5237\u76d8\u670d\u52a1",children:"\u5237\u76d8\u670d\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"FlushConsumeQueueService \u5237\u76d8 CQ \u6570\u636e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u6bcf\u9694 1 \u79d2\u6267\u884c\u4e00\u6b21\u5237\u76d8\u670d\u52a1\uff0c\u8df3\u51fa\u5faa\u73af\u540e\u8fd8\u4f1a\u6267\u884c\u4e00\u6b21\u5f3a\u5236\u5237\u76d8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"doFlush()\uff1a\u5237\u76d8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void doFlush(int retryTimes)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int flushConsumeQueueLeastPages"}),"\uff1a\u810f\u9875\u9608\u503c\uff0c\u9ed8\u8ba4\u662f 2"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (retryTimes == RETRY_TIMES_OVER)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u91cd\u8bd5\u6b21\u6570\u662f 3"})," \u65f6\u8bbe\u7f6e\u5f3a\u5236\u5237\u76d8\uff0c\u8bbe\u7f6e\u810f\u9875\u9608\u503c\u4e3a 0"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int flushConsumeQueueThoroughInterval"}),"\uff1a\u4e24\u6b21\u5237\u65b0\u7684",(0,l.jsx)(n.strong,{children:"\u65f6\u95f4\u95f4\u9694\u8d85\u8fc7 60 \u79d2"}),"\u4f1a\u5f3a\u5236\u5237\u76d8"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (ConsumeQueue cq : maps.values())"}),"\uff1a\u904d\u5386\u6240\u6709\u7684 CQ\uff0c\u8fdb\u884c\u5237\u76d8"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore.this.getStoreCheckpoint().flush()"}),"\uff1a\u5f3a\u5236\u5237\u76d8\u65f6\u5c06 StoreCheckpoint \u77ac\u65f6\u6570\u636e\u5237\u76d8"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"FlushCommitLogService \u5237\u76d8 CL \u6570\u636e\uff0c\u9ed8\u8ba4\u662f\u5f02\u6b65\u5237\u76d8"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u8fd0\u884c\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (!this.isStopped())"}),"\uff1astopped\u4e3a true \u624d\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean flushCommitLogTimed"}),"\uff1a\u63a7\u5236\u7ebf\u7a0b\u7684\u4f11\u7720\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u662f false\uff0c\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"CountDownLatch.await()"})," \u4f11\u7720\uff0c\u8bbe\u7f6e\u4e3a true \u65f6\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"Thread.sleep()"})," \u4f11\u7720"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int interval"}),"\uff1a\u83b7\u53d6\u914d\u7f6e\u4e2d\u7684\u5237\u76d8\u65f6\u95f4\u95f4\u9694"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int flushPhysicQueueLeastPages"}),"\uff1a\u83b7\u53d6\u6700\u5c0f\u5237\u76d8\u9875\u6570\uff0c\u9ed8\u8ba4\u662f 4 \u9875\uff0c\u810f\u9875\u8fbe\u5230\u6307\u5b9a\u9875\u6570\u624d\u5237\u76d8"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int flushPhysicQueueThoroughInterval"}),"\uff1a\u83b7\u53d6\u5f3a\u5236\u5237\u76d8\u5468\u671f\uff0c\u9ed8\u8ba4\u662f 10 \u79d2\uff0c\u8fbe\u5230\u5468\u671f\u540e\u5f3a\u5236\u5237\u76d8\uff0c\u4e0d\u8003\u8651\u810f\u9875"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (flushCommitLogTimed)"}),"\uff1a\u4f11\u7720\u903b\u8f91\uff0c\u907f\u514d CPU \u5360\u7528\u592a\u957f\u65f6\u95f4\uff0c\u5bfc\u81f4\u65e0\u6cd5\u6267\u884c\u5176\u4ed6\u66f4\u7d27\u6025\u7684\u4efb\u52a1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5237\u76d8"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (int i = 0; i < RETRY_TIMES_OVER && !result; i++)"}),"\uff1astopped \u505c\u6b62\u6807\u8bb0\u4e3a true \u65f6\uff0c\u9700\u8981\u786e\u4fdd\u6240\u6709\u7684\u6570\u636e\u90fd\u5df2\u7ecf\u5237\u76d8\uff0c\u6240\u4ee5\u6b64\u5904\u5c1d\u8bd5 10 \u6b21\u5f3a\u5236\u5237\u76d8\uff0c"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"result = CommitLog.this.mappedFileQueue.flush(0)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5f3a\u5236\u5237\u76d8"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6e05\u7406\u670d\u52a1",children:"\u6e05\u7406\u670d\u52a1"}),"\n",(0,l.jsxs)(n.p,{children:["CleanCommitLogService \u6e05\u7406\u8fc7\u671f\u7684 CL \u6570\u636e\uff0c\u5b9a\u65f6\u4efb\u52a1 10 \u79d2\u8c03\u7528\u4e00\u6b21\uff0c",(0,l.jsx)(n.strong,{children:"\u5148\u6e05\u7406 CL\uff0c\u518d\u6e05\u7406 CQ"}),"\uff0c\u56e0\u4e3a CQ \u4f9d\u8d56\u4e8e CL \u7684\u6570\u636e"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u8fd0\u884c\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"deleteExpiredFiles()\uff1a\u5220\u9664\u8fc7\u671f CL \u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void deleteExpiredFiles()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long fileReservedTime"}),"\uff1a\u9ed8\u8ba4 72\uff0c\u4ee3\u8868\u6587\u4ef6\u7684\u4fdd\u7559\u65f6\u95f4"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean timeup = this.isTimeToDelete()"}),"\uff1a\u5f53\u524d\u65f6\u95f4\u662f\u5426\u662f\u51cc\u6668 4 \u70b9"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean spacefull = this.isSpaceToDelete()"}),"\uff1aCL \u6216\u8005 CQ \u7684\u76ee\u5f55\u78c1\u76d8\u4f7f\u7528\u7387\u8fbe\u5230\u9608\u503c\u6807\u51c6 85%"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean manualDelete = this.manualDeleteFileSeveralTimes > 0"}),"\uff1a\u624b\u52a8\u5220\u9664\u6587\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"fileReservedTime *= 60 * 60 * 1000"}),"\uff1a\u9ed8\u8ba4\u4fdd\u7559 72 \u5c0f\u65f6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"deleteCount = DefaultMessageStore.this.commitLog.deleteExpiredFile()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8c03\u7528 MFQ \u5bf9\u8c61\u7684\u5220\u9664\u65b9\u6cd5"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"CleanConsumeQueueService \u6e05\u7406\u8fc7\u671f\u7684 CQ \u6570\u636e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u8fd0\u884c\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"deleteExpiredFiles()\uff1a\u5220\u9664\u8fc7\u671f CQ \u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void deleteExpiredFiles()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int deleteLogicsFilesInterval"}),"\uff1a\u6e05\u7406 CQ \u7684\u65f6\u95f4\u95f4\u9694\uff0c\u9ed8\u8ba4 100 \u6beb\u79d2"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long minOffset = DefaultMessageStore.this.commitLog.getMinOffset()"}),"\uff1a\u83b7\u53d6 CL \u6587\u4ef6\u4e2d\u6700\u5c0f\u7684\u7269\u7406\u504f\u79fb\u91cf"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (minOffset > this.lastPhysicalMinOffset)"}),"\uff1aCL \u6700\u5c0f\u7684\u504f\u79fb\u91cf\u5927\u4e8e CQ \u6700\u5c0f\u7684\uff0c\u8bf4\u660e\u6709\u8fc7\u671f\u6570\u636e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lastPhysicalMinOffset = minOffset"}),"\uff1a\u66f4\u65b0 CQ \u7684\u6700\u5c0f\u504f\u79fb\u91cf"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (ConsumeQueue logic : maps.values())"}),"\uff1a\u904d\u5386\u6240\u6709\u7684 CQ \u6587\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"logic.deleteExpiredFile(minOffset)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8c03\u7528 MFQ \u5bf9\u8c61\u7684\u5220\u9664\u65b9\u6cd5"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore.this.indexService.deleteExpiredFile(minOffset)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5220\u9664\u8fc7\u671f\u7684\u7d22\u5f15\u6587\u4ef6"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u83b7\u53d6\u6d88\u606f",children:"\u83b7\u53d6\u6d88\u606f"}),"\n",(0,l.jsx)(n.p,{children:"DefaultMessageStore#getMessage \u7528\u4e8e\u83b7\u53d6\u6d88\u606f\uff0c\u5728 PullMessageProcessor#processRequest \u65b9\u6cd5\u4e2d\u88ab\u8c03\u7528 \uff08\u63d0\u793a\uff1a\u5efa\u8bae\u5b66\u4e60\u6d88\u8d39\u8005\u6e90\u7801\u65f6\u518d\u9605\u8bfb\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// offset: \u5ba2\u6237\u7aef\u62c9\u6d88\u606f\u4f7f\u7528\u4f4d\u70b9\uff1b   maxMsgNums: 32\uff1b  messageFilter: \u4e00\u822c\u8fd9\u91cc\u662f tagCode \u8fc7\u6ee4 \npublic GetMessageResult getMessage(final String group, final String topic, final int queueId, final long offset, final int maxMsgNums, final MessageFilter messageFilter)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.shutdown)"}),"\uff1a\u68c0\u67e5\u8fd0\u884c\u72b6\u6001"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"GetMessageResult getResult"}),"\uff1a\u521b\u5efa\u67e5\u8be2\u7ed3\u679c\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final long maxOffsetPy = this.commitLog.getMaxOffset()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6 CommitLog \u6700\u5927\u7269\u7406\u504f\u79fb\u91cf"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId)"}),"\uff1a\u6839\u636e\u4e3b\u9898\u548c\u961f\u5217 ID \u83b7\u53d6 ConsumeQueue\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"minOffset, maxOffset"}),"\uff1a\u83b7\u53d6\u5f53\u524d ConsumeQueue \u7684\u6700\u5c0f offset \u548c \u6700\u5927 offset\uff0c",(0,l.jsx)(n.strong,{children:"\u5224\u65ad\u662f\u5426\u6ee1\u8db3\u672c\u6b21 Pull \u7684 offset"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (maxOffset == 0)"}),"\uff1a\u8bf4\u660e\u961f\u5217\u5185\u65e0\u6570\u636e\uff0c\u8bbe\u7f6e\u72b6\u6001\u4e3a NO_MESSAGE_IN_QUEUE\uff0c\u5916\u5c42\u8fdb\u884c\u957f\u8f6e\u8be2"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else if (offset < minOffset)"}),"\uff1a\u8bf4\u660e offset \u592a\u5c0f\u4e86\uff0c\u8bbe\u7f6e\u72b6\u6001\u4e3a OFFSET_TOO_SMALL"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else if (offset == maxOffset)"}),"\uff1a\u6d88\u8d39\u8fdb\u5ea6\u6301\u5e73\uff0c\u8bbe\u7f6e\u72b6\u6001\u4e3a OFFSET_OVERFLOW_ONE\uff0c\u5916\u5c42\u8fdb\u884c\u957f\u8f6e\u8be2"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else if (offset > maxOffset)"}),"\uff1a\u8bf4\u660e offset \u8d8a\u754c\u4e86\uff0c\u8bbe\u7f6e\u72b6\u6001\u4e3a OFFSET_OVERFLOW_BADLY"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"SelectMappedBufferResult bufferConsumeQueue"}),"\uff1a\u67e5\u8be2 CQData ",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u5305\u542b\u8be5 offset \u7684 MappedFile \u6587\u4ef6"}),"\uff0c\u5982\u679c\u8be5\u6587\u4ef6\u4e0d\u662f\u987a\u5e8f\u5199\u7684\u6587\u4ef6\uff0c\u5c31\u8bfb\u53d6 ",(0,l.jsx)(n.code,{children:"[offset%maxSize, \u6587\u4ef6\u5c3e]"})," \u8303\u56f4\u7684\u6570\u636e\uff0c\u53cd\u4e4b\u8bfb\u53d6 ",(0,l.jsx)(n.code,{children:"[offset%maxSize, \u6587\u4ef6\u540d+wrotePosition\u5c3e]"})]}),"\n",(0,l.jsx)(n.p,{children:"\u5148\u67e5 CQ \u7684\u539f\u56e0\uff1a\u56e0\u4e3a CQ \u65f6 CL \u7684\u7d22\u5f15\uff0c\u901a\u8fc7 CQ \u67e5\u8be2 CL \u66f4\u52a0\u5feb\u6377"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (bufferConsumeQueue != null)"}),"\uff1a\u53ea\u6709\u518d CQ \u5220\u9664\u8fc7\u671f\u6570\u636e\u7684\u903b\u8f91\u6267\u884c\u65f6\uff0c\u6761\u4ef6\u624d\u4e0d\u6210\u7acb\uff0c\u4e00\u822c\u90fd\u662f\u6210\u7acb\u7684"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long nextPhyFileStartOffset = Long.MIN_VALUE"}),"\uff1a\u4e0b\u4e00\u4e2a commitLog \u7269\u7406\u6587\u4ef6\u540d\uff0c\u521d\u59cb\u503c\u4e3a\u6700\u5c0f\u503c"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long maxPhyOffsetPulling = 0"}),"\uff1a\u672c\u6b21\u62c9\u6d88\u606f\u6700\u540e\u4e00\u6761\u6d88\u606f\u7684\u7269\u7406\u504f\u79fb\u91cf"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for ()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u6570\u636e"}),"\uff0c\u6bcf\u6b21\u5904\u7406 20 \u5b57\u8282\u5904\u7406\u5b57\u8282\u6570\u5927\u4e8e 16000 \u65f6\u8df3\u51fa\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"offsetPy, sizePy, tagsCode"}),"\uff1a\u8bfb\u53d6 20 \u4e2a\u5b57\u8282\u540e\uff0c\u83b7\u53d6\u6d88\u606f\u7269\u7406\u504f\u79fb\u91cf\u3001\u6d88\u606f\u5927\u5c0f\u3001\u6d88\u606f tagCode"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean isInDisk = checkInDiskByCommitOffset(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u68c0\u67e5\u6d88\u606f\u662f\u70ed\u6570\u636e\u8fd8\u662f\u51b7\u6570\u636e"}),"\uff0cfalse \u4e3a\u70ed\u6570\u636e"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long memory"}),"\uff1aBroker \u7cfb\u7edf 40% \u5185\u5b58\u7684\u5b57\u8282\u6570\uff0c\u5199\u6570\u636e\u65f6\u5185\u5b58\u4e0d\u591f\u4f1a\u4f7f\u7528 LRU \u7b97\u6cd5\u6dd8\u6c70\u6570\u636e\uff0c\u5c06\u6dd8\u6c70\u6570\u636e\u6301\u4e45\u5316\u5230\u78c1\u76d8"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"return (maxOffsetPy - offsetPy) > memory"}),"\uff1a\u8fd4\u56de true \u8bf4\u660e\u6570\u636e\u5df2\u7ecf\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u4e3a\u51b7\u6570\u636e"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.isTheBatchFull())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u63a7\u5236\u662f\u5426\u8df3\u51fa\u5faa\u73af"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (0 == bufferTotal || 0 == messageTotal)"}),"\uff1a\u672c\u6b21 pull \u6d88\u606f\u672a\u62c9\u53d6\u5230\u4efb\u4f55\u4e1c\u897f\uff0c\u9700\u8981\u5916\u5c42 for \u5faa\u73af\u7ee7\u7eed\uff0c\u8fd4\u56de false"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (maxMsgNums <= messageTotal)"}),"\uff1a\u7ed3\u679c\u5bf9\u8c61\u5185\u6d88\u606f\u6570\u5df2\u7ecf\u8d85\u8fc7\u4e86\u6700\u5927\u6d88\u606f\u6570\u91cf\uff0c\u53ef\u4ee5\u7ed3\u675f\u5faa\u73af\u4e86"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (isInDisk)"}),"\uff1a\u51b7\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if ((bufferTotal + sizePy) > ...)"}),"\uff1a\u51b7\u6570\u636e\u4e00\u6b21 pull \u8bf7\u6c42\u6700\u5927\u5141\u8bb8\u83b7\u53d6 64kb \u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (messageTotal > ...)"}),"\uff1a\u51b7\u6570\u636e\u4e00\u6b21 pull \u8bf7\u6c42\u6700\u5927\u5141\u8bb8\u83b7\u53d68 \u6761\u6d88\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u70ed\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if ((bufferTotal + sizePy) > ...)"}),"\uff1a\u70ed\u6570\u636e\u4e00\u6b21 pull \u8bf7\u6c42\u6700\u5927\u5141\u8bb8\u83b7\u53d6 256kb \u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (messageTotal > ...)"}),"\uff1a\u51b7\u6570\u636e\u4e00\u6b21 pull \u8bf7\u6c42\u6700\u5927\u5141\u8bb8\u83b7\u53d6 32 \u6761\u6d88\u606f"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (messageFilter != null)"}),"\uff1a\u6309\u7167\u6d88\u606f tagCode \u8fdb\u884c\u8fc7\u6ee4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"selectResult = this.commitLog.getMessage(offsetPy, sizePy)"}),"\uff1a\u6839\u636e CQ \u6d88\u606f\u7269\u7406\u504f\u79fb\u91cf\u548c\u6d88\u606f\u5927\u5c0f",(0,l.jsx)(n.strong,{children:"\u5230 commitLog \u4e2d\u67e5\u8be2\u8fd9\u6761 msg"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == selectResult)"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e commitLog \u6267\u884c\u4e86\u5220\u9664\u8fc7\u671f\u6587\u4ef6\u7684\u5b9a\u65f6\u4efb\u52a1\uff0c\u56e0\u4e3a\u662f\u5148\u6e05\u7406\u7684 CL\uff0c\u6240\u4ee5 CQ \u8fd8\u6709\u8be5\u7d22\u5f15\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"nextPhyFileStartOffset = this.commitLog.rollNextFile(offsetPy)"}),"\uff1a\u83b7\u53d6\u5305\u542b\u8be5 offsetPy \u7684\u4e0b\u4e00\u4e2a\u6570\u636e\u6587\u4ef6\u7684\u6587\u4ef6\u540d"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"getResult.addMessage(selectResult)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u672c\u6b21\u5faa\u73af\u67e5\u8be2\u51fa\u6765\u7684 msg \u52a0\u5165\u5230 getResult \u5185"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"status = GetMessageStatus.FOUND"}),"\uff1a\u67e5\u8be2\u72b6\u6001\u8bbe\u7f6e\u4e3a FOUND"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"nextPhyFileStartOffset = Long.MIN_VALUE"}),"\uff1a\u8bbe\u7f6e\u4e3a\u6700\u5c0f\u503c\uff0c\u8df3\u8fc7\u671f CQData \u6570\u636e\u7684\u903b\u8f91"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE)"}),"\uff1a\u8ba1\u7b97\u5ba2\u6237\u7aef\u4e0b\u4e00\u6b21 pull \u65f6\u4f7f\u7528\u7684\u4f4d\u70b9\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"getResult.setSuggestPullingFromSlave(diff > memory)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u9009\u62e9\u4e3b\u4ece\u8282\u70b9\u7684\u5efa\u8bae"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"diff > memory => true"}),"\uff1a\u8868\u793a\u672c\u8f6e\u67e5\u8be2\u6700\u540e\u4e00\u6761\u6d88\u606f\u4e3a\u51b7\u6570\u636e\uff0cBroker \u5efa\u8bae\u5ba2\u6237\u7aef\u4e0b\u4e00\u6b21 pull \u65f6\u5230 slave \u8282\u70b9"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"diff > memory => false"}),"\uff1a\u8868\u793a\u672c\u8f6e\u67e5\u8be2\u6700\u540e\u4e00\u6761\u6d88\u606f\u4e3a\u70ed\u6570\u636e\uff0cBroker \u5efa\u8bae\u5ba2\u6237\u7aef\u4e0b\u4e00\u6b21 pull \u65f6\u5230 master \u8282\u70b9"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"getResult.setStatus(status)"}),"\uff1a\u8bbe\u7f6e\u7ed3\u679c\u72b6\u6001"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"getResult.setNextBeginOffset(nextBeginOffset)"}),"\uff1a\u8bbe\u7f6e\u5ba2\u6237\u7aef\u4e0b\u4e00\u6b21 pull \u65f6\u7684 offset"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"getResult.setMaxOffset(maxOffset)"}),"\uff1a\u8bbe\u7f6e queue \u7684\u6700\u5927 offset \u548c\u6700\u5c0f offset"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"return getResult"}),"\uff1a\u8fd4\u56de\u7ed3\u679c\u5bf9\u8c61"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"broker-1",children:"Broker"}),"\n",(0,l.jsx)(n.p,{children:"BrokerStartup \u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public static void main(String[] args) {\n    start(createBrokerController(args));\n}\npublic static BrokerController start(BrokerController controller) {\n    controller.start();\t// \u542f\u52a8\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"BrokerStartup#createBrokerController\uff1a\u6784\u9020\u63a7\u5236\u5668\uff0c\u5e76\u521d\u59cb\u5316"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final BrokerController controller()"}),"\uff1a\u521b\u5efa\u5b9e\u4f8b\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean initResult = controller.initialize()"}),"\uff1a\u63a7\u5236\u5668\u521d\u59cb\u5316\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.registerProcessor()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6ce8\u518c\u4e86\u5904\u7406\u5668\uff0c\u5305\u62ec\u53d1\u9001\u6d88\u606f\u3001\u62c9\u53d6\u6d88\u606f\u3001\u67e5\u8be2\u6d88\u606f\u7b49\u6838\u5fc3\u5904\u7406\u5668"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"initialTransaction()"}),"\uff1a\u521d\u59cb\u5316\u4e86\u4e8b\u52a1\u670d\u52a1\uff0c\u7528\u4e8e\u8fdb\u884c",(0,l.jsx)(n.strong,{children:"\u4e8b\u52a1\u56de\u67e5"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"BrokerController#start\uff1a\u6838\u5fc3\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.messageStore.start()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u542f\u52a8\u5b58\u50a8\u670d\u52a1"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.remotingServer.start()"}),"\uff1a\u542f\u52a8 Netty \u901a\u4fe1\u670d\u52a1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.fileWatchService.start()"}),"\uff1a\u542f\u52a8\u6587\u4ef6\u76d1\u542c\u670d\u52a1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"startProcessorByHa(messageStoreConfig.getBrokerRole())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u542f\u52a8\u4e8b\u52a1\u56de\u67e5"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.scheduledExecutorService.scheduleAtFixedRate()"}),"\uff1a\u6bcf\u9694 30s \u5411 NameServer \u4e0a\u62a5 Topic \u8def\u7531\u4fe1\u606f\uff0c",(0,l.jsx)(n.strong,{children:"\u5fc3\u8df3\u673a\u5236"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:"BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister())"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"producer",children:"Producer"}),"\n",(0,l.jsx)(n.h4,{id:"\u751f\u4ea7\u8005\u7c7b",children:"\u751f\u4ea7\u8005\u7c7b"}),"\n",(0,l.jsx)(n.h5,{id:"\u751f\u4ea7\u8005\u7c7b-1",children:"\u751f\u4ea7\u8005\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"DefaultMQProducer \u662f\u751f\u4ea7\u8005\u7684\u9ed8\u8ba4\u5b9e\u73b0\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u751f\u4ea7\u8005\u5b9e\u73b0\u7c7b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final transient DefaultMQProducerImpl defaultMQProducerImpl\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u751f\u4ea7\u8005\u7ec4\uff1a\u53d1\u9001\u4e8b\u52a1\u6d88\u606f\uff0cBroker \u7aef\u8fdb\u884c\u4e8b\u52a1\u56de\u67e5\uff08\u8865\u507f\u673a\u5236\uff09\u65f6\uff0c\u9009\u62e9\u5f53\u524d\u751f\u4ea7\u8005\u7ec4\u7684\u4e0b\u4e00\u4e2a\u751f\u4ea7\u8005\u8fdb\u884c\u4e8b\u52a1\u56de\u67e5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private String producerGroup;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9ed8\u8ba4\u4e3b\u9898\uff1aisAutoCreateTopicEnable \u5f00\u542f\u65f6\uff0c\u5f53\u53d1\u9001\u6d88\u606f\u6307\u5b9a\u7684 Topic \u5728 Namesrv \u672a\u627e\u5230\u8def\u7531\u4fe1\u606f\uff0c\u4f7f\u7528\u8be5\u503c\u521b\u5efa Topic \u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;\n// \u503c\u4e3a\u3010TBW102\u3011\uff0cJust for testing or demo program\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u91cd\u6295\uff1a\u7cfb\u7edf\u7279\u6027\u6d88\u606f\u91cd\u8bd5\u90e8\u5206\u8be6\u89e3\u4e86\u4e09\u4e2a\u53c2\u6570\u7684\u4f5c\u7528"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private int retryTimesWhenSendFailed = 2;\t\t// \u540c\u6b65\u53d1\u9001\u5931\u8d25\u540e\u91cd\u8bd5\u7684\u53d1\u9001\u6b21\u6570\uff0c\u52a0\u4e0a\u7b2c\u4e00\u6b21\u53d1\u9001\uff0c\u4e00\u5171\u4e09\u6b21\nprivate int retryTimesWhenSendAsyncFailed = 2;\t// \u5f02\u6b65\nprivate boolean retryAnotherBrokerWhenNotStoreOK = false;\t// \u6d88\u606f\u672a\u5b58\u50a8\u6210\u529f\uff0c\u9009\u62e9\u5176\u4ed6 Broker \u91cd\u8bd5\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u961f\u5217\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile int defaultTopicQueueNums = 4;\t\t// \u9ed8\u8ba4 Broker \u521b\u5efa\u7684\u961f\u5217\u6570\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private int sendMsgTimeout = 3000;\t\t\t\t\t// \u53d1\u9001\u6d88\u606f\u7684\u8d85\u65f6\u9650\u5236\nprivate int compressMsgBodyOverHowmuch = 1024 * 4;\t// \u538b\u7f29\u9608\u503c\uff0c\u5f53 msg body \u8d85\u8fc7 4k \u540e\u4f7f\u7528\u538b\u7f29\nprivate int maxMessageSize = 1024 * 1024 * 4;\t\t// \u6d88\u606f\u4f53\u7684\u6700\u5927\u9650\u5236\uff0c\u9ed8\u8ba4 4M\nprivate TraceDispatcher traceDispatcher = null;\t\t// \u6d88\u606f\u8f68\u8ff9\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public DefaultMQProducer(final String namespace, final String producerGroup, RPCHook rpcHook) {\n    this.namespace = namespace;\n    this.producerGroup = producerGroup;\n    // \u521b\u5efa\u751f\u4ea7\u8005\u5b9e\u73b0\u5bf9\u8c61\n    defaultMQProducerImpl = new DefaultMQProducerImpl(this, rpcHook);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start() throws MQClientException {\n    // \u91cd\u7f6e\u751f\u4ea7\u8005\u7ec4\u540d\uff0c\u5982\u679c\u4f20\u9012\u4e86\u547d\u540d\u7a7a\u95f4\uff0c\u5219 \u3010namespace%group\u3011\n    this.setProducerGroup(withNamespace(this.producerGroup));\n    // \u751f\u4ea7\u8005\u5b9e\u73b0\u5bf9\u8c61\u542f\u52a8\n    this.defaultMQProducerImpl.start();\n    if (null != traceDispatcher) {\n      \t// \u6d88\u606f\u8f68\u8ff9\u7684\u903b\u8f91\n   \t\ttraceDispatcher.start(this.getNamesrvAddr(), this.getAccessChannel());\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["send()\uff1a",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u6d88\u606f"}),"\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public SendResult send(Message msg){\n    // \u6821\u9a8c\u6d88\u606f\n    Validators.checkMessage(msg, this);\n    // \u8bbe\u7f6e\u6d88\u606f Topic\n    msg.setTopic(withNamespace(msg.getTopic()));\n    return this.defaultMQProducerImpl.send(msg);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["request()\uff1a\u8bf7\u6c42\u65b9\u6cd5\uff0c",(0,l.jsx)(n.strong,{children:"\u9700\u8981\u6d88\u8d39\u8005\u56de\u6267\u6d88\u606f"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public Message request(final Message msg, final MessageQueue mq, final long timeout) {\n    msg.setTopic(withNamespace(msg.getTopic()));\n    return this.defaultMQProducerImpl.request(msg, mq, timeout);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5b9e\u73b0\u8005\u7c7b",children:"\u5b9e\u73b0\u8005\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"DefaultMQProducerImpl \u7c7b\u662f\u9ed8\u8ba4\u7684\u751f\u4ea7\u8005\u5b9e\u73b0\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9e\u4f8b\u5bf9\u8c61\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final DefaultMQProducer defaultMQProducer;\t// \u6301\u6709\u9ed8\u8ba4\u751f\u4ea7\u8005\u5bf9\u8c61\uff0c\u7528\u6765\u83b7\u53d6\u5bf9\u8c61\u4e2d\u7684\u914d\u7f6e\u4fe1\u606f\nprivate MQClientInstance mQClientFactory;\t\t\t// \u5ba2\u6237\u7aef\u5b9e\u4f8b\u5bf9\u8c61\uff0c\u751f\u4ea7\u8005\u542f\u52a8\u540e\u9700\u8981\u6ce8\u518c\u5230\u8be5\u5ba2\u6237\u7aef\u5bf9\u8c61\u5185\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\u6620\u5c04\u8868\uff1akey \u662f Topic\uff0cvalue \u662f\u53d1\u5e03\u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ConcurrentMap<String, TopicPublishInfo> topicPublishInfoTable = new ConcurrentHashMap<String, TopicPublishInfo>();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5f02\u6b65\u53d1\u9001\u6d88\u606f\uff1a\u76f8\u5173\u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final BlockingQueue<Runnable> asyncSenderThreadPoolQueue;// \u5f02\u6b65\u53d1\u9001\u6d88\u606f\uff0c\u5f02\u6b65\u7ebf\u7a0b\u6c60\u4f7f\u7528\u7684\u961f\u5217\nprivate final ExecutorService defaultAsyncSenderExecutor;\t// \u5f02\u6b65\u53d1\u9001\u6d88\u606f\u9ed8\u8ba4\u4f7f\u7528\u7684\u7ebf\u7a0b\u6c60\nprivate ExecutorService asyncSenderExecutor;\t\t\t\t// \u5f02\u6b65\u6d88\u606f\u53d1\u9001\u7ebf\u7a0b\u6c60\uff0c\u6307\u5b9a\u540e\u5c31\u4e0d\u4f7f\u7528\u9ed8\u8ba4\u7ebf\u7a0b\u6c60\u4e86\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u5668\uff1a\u6267\u884c\u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'private final Timer timer = new Timer("RequestHouseKeepingService", true);\t// \u5b88\u62a4\u7ebf\u7a0b\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u72b6\u6001\u4fe1\u606f\uff1a\u670d\u52a1\u7684\u72b6\u6001\uff0c\u9ed8\u8ba4\u521b\u5efa\u72b6\u6001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private ServiceState serviceState = ServiceState.CREATE_JUST;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u538b\u7f29\u7b49\u7ea7\uff1aZIP \u538b\u7f29\u7b97\u6cd5\u7684\u7b49\u7ea7\uff0c\u9ed8\u8ba4\u662f 5\uff0c\u8d8a\u9ad8\u538b\u7f29\u6548\u679c\u597d\uff0c\u4f46\u662f\u538b\u7f29\u7684\u66f4\u6162"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'private int zipCompressLevel = Integer.parseInt(System.getProperty..., "5"));\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5bb9\u9519\u7b56\u7565\uff1a\u9009\u62e9\u961f\u5217\u7684\u5bb9\u9519\u7b56\u7565"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private MQFaultStrategy mqFaultStrategy = new MQFaultStrategy();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u94a9\u5b50\uff1a\u7528\u6765\u8fdb\u884c\u524d\u7f6e\u6216\u8005\u540e\u7f6e\u5904\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"ArrayList<SendMessageHook> sendMessageHookList;\t\t\t// \u53d1\u9001\u6d88\u606f\u7684\u94a9\u5b50\uff0c\u7559\u7ed9\u7528\u6237\u6269\u5c55\u4f7f\u7528\nArrayList<CheckForbiddenHook> checkForbiddenHookList;\t// \u5bf9\u6bd4\u4e0a\u9762\u7684\u94a9\u5b50\uff0c\u53ef\u4ee5\u629b\u5f02\u5e38\uff0c\u63a7\u5236\u6d88\u606f\u662f\u5426\u53ef\u4ee5\u53d1\u9001\nprivate final RPCHook rpcHook;\t\t\t\t\t\t \t// \u4f20\u9012\u7ed9 NettyRemotingClient\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9ed8\u8ba4\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer) {\n    // \u9ed8\u8ba4 RPC HOOK \u662f\u7a7a\n    this(defaultMQProducer, null);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6709\u53c2\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer, RPCHook rpcHook) {\n    // \u5c5e\u6027\u8d4b\u503c\n    this.defaultMQProducer = defaultMQProducer;\n    this.rpcHook = rpcHook;\n\n    // \u521b\u5efa\u3010\u5f02\u6b65\u6d88\u606f\u7ebf\u7a0b\u6c60\u4efb\u52a1\u961f\u5217\u3011\uff0c\u957f\u5ea6\u662f 5w\n    this.asyncSenderThreadPoolQueue = new LinkedBlockingQueue<Runnable>(50000);\n    // \u521b\u5efa\u9ed8\u8ba4\u7684\u5f02\u6b65\u6d88\u606f\u4efb\u52a1\u7ebf\u7a0b\u6c60\n    this.defaultAsyncSenderExecutor = new ThreadPoolExecutor(\n        // \u6838\u5fc3\u7ebf\u7a0b\u6570\u548c\u6700\u5927\u7ebf\u7a0b\u6570\u90fd\u662f \u7cfb\u7edf\u53ef\u7528\u7684\u8ba1\u7b97\u8d44\u6e90\uff088\u683816\u7ebf\u7a0b\u7684\u7cfb\u7edf\u5c31\u662f 16\uff09...\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5b9e\u73b0\u65b9\u6cd5",children:"\u5b9e\u73b0\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u65b9\u6cd5\uff0c\u53c2\u6570\u9ed8\u8ba4\u662f true\uff0c\u4ee3\u8868\u6b63\u5e38\u7684\u542f\u52a8\u8def\u5f84"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start(final boolean startFactory)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.serviceState = ServiceState.START_FAILED"}),"\uff1a\u5148\u4fee\u6539\u4e3a\u542f\u52a8\u5931\u8d25\uff0c\u6210\u529f\u540e\u518d\u4fee\u6539\uff0c\u8fd9\u79cd\u601d\u60f3\u5f88\u5e38\u89c1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.checkConfig()"}),"\uff1a\u5224\u65ad\u751f\u4ea7\u8005\u7ec4\u540d\u4e0d\u80fd\u662f\u7a7a\uff0c\u4e5f\u4e0d\u80fd\u662f default_PRODUCER"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP))"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u751f\u4ea7\u8005\u4e0d\u662f\u5185\u90e8\u4ea7\u751f\u8005\uff0c\u5185\u90e8\u751f\u4ea7\u8005\u662f",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u6d88\u606f\u56de\u9000"}),"\u7684\u8fd9\u79cd\u60c5\u51b5\u4f7f\u7528\u7684\u751f\u4ea7\u8005"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.defaultMQProducer.changeInstanceNameToPID()"}),"\uff1a\u4fee\u6539\u751f\u4ea7\u8005\u5b9e\u4f8b\u540d\u79f0\u4e3a\u5f53\u524d\u8fdb\u7a0b\u7684 PID"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:" this.mQClientFactory = ..."}),"\uff1a\u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684 MQ \u5ba2\u6237\u7aef\u5b9e\u4f8b\u5bf9\u8c61\uff0c\u4ece factoryTable \u4e2d\u83b7\u53d6 key \u4e3a \u5ba2\u6237\u7aef ID\uff0c\u683c\u5f0f\u662f",(0,l.jsx)(n.code,{children:"ip@pid"}),"\uff0c",(0,l.jsx)(n.strong,{children:"\u4e00\u4e2a JVM \u8fdb\u7a0b\u53ea\u6709\u4e00\u4e2a PID\uff0c\u4e5f\u53ea\u6709\u4e00\u4e2a MQClientInstance"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean registerOK = mQClientFactory.registerProducer(...)"}),"\uff1a\u5c06\u751f\u4ea7\u8005\u6ce8\u518c\u5230 RocketMQ \u5ba2\u6237\u7aef\u5b9e\u4f8b\u5185"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.topicPublishInfoTable.put(...)"}),"\uff1a\u6dfb\u52a0\u4e00\u4e2a\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\uff0ckey \u662f ",(0,l.jsx)(n.strong,{children:"TBW102"})," \uff0cvalue \u662f\u4e00\u4e2a\u7a7a\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"mQClientFactory.start()"}),"\uff1a\u542f\u52a8 RocketMQ \u5ba2\u6237\u7aef\u5b9e\u4f8b\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()"}),"\uff1aRocketMQ ",(0,l.jsx)(n.strong,{children:"\u5ba2\u6237\u7aef\u5b9e\u4f8b\u5411\u5df2\u77e5\u7684 Broker \u8282\u70b9\u53d1\u9001\u4e00\u6b21\u5fc3\u8df3"}),"\uff08\u4e5f\u662f\u5b9a\u65f6\u4efb\u52a1\uff09"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.timer.scheduleAtFixedRate()"}),"\uff1a request \u53d1\u9001\u7684\u6d88\u606f\u9700\u8981\u6d88\u8d39\u7740\u56de\u6267\u4fe1\u606f\uff0c\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1\u6bcf\u79d2\u4e00\u6b21\u5220\u9664\u8d85\u65f6\u8bf7\u6c42"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u751f\u4ea7\u8005 msg \u6dfb\u52a0\u4fe1\u606f\u5173\u8054 ID \u53d1\u9001\u5230 Broker"}),"\n",(0,l.jsx)(n.li,{children:"\u6d88\u8d39\u8005\u4ece Broker \u62ff\u5230\u6d88\u606f\u540e\u4f1a\u68c0\u67e5 msg \u7c7b\u578b\u662f\u4e00\u4e2a\u9700\u8981\u56de\u6267\u7684\u6d88\u606f\uff0c\u5904\u7406\u5b8c\u6d88\u606f\u540e\u4f1a\u6839\u636e msg \u5173\u8054 ID \u548c\u5ba2\u6237\u7aef ID \u751f\u6210\u4e00\u6761\u54cd\u5e94\u7ed3\u679c\u6d88\u606f\u53d1\u9001\u5230 Broker\uff0cBroker \u5224\u65ad\u4e3a\u56de\u6267\u6d88\u606f\uff0c\u4f1a\u6839\u636e\u5ba2\u6237\u7aefID \u627e\u5230 channel \u63a8\u9001\u7ed9\u751f\u4ea7\u8005"}),"\n",(0,l.jsx)(n.li,{children:"\u751f\u4ea7\u8005\u62ff\u5230\u56de\u6267\u6d88\u606f\u540e\uff0c\u8bfb\u53d6\u51fa\u6765\u5173\u8054 ID \u627e\u5230\u5bf9\u5e94\u7684 RequestFuture\uff0c\u5c06\u963b\u585e\u7ebf\u7a0b\u5524\u9192"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"sendDefaultImpl()\uff1a\u53d1\u9001\u6d88\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"//\u53c2\u65701\uff1a\u6d88\u606f\uff1b\u53c2\u65702\uff1a\u53d1\u9001\u6a21\u5f0f\uff08\u540c\u6b65\u5f02\u6b65\u5355\u5411\uff09\uff1b\u53c2\u65703\uff1a\u56de\u8c03\u51fd\u6570\uff0c\u5f02\u6b65\u53d1\u9001\u65f6\u9700\u8981\uff1b\u53c2\u65704\uff1a\u53d1\u9001\u8d85\u65f6\u65f6\u95f4, \u9ed8\u8ba4 3 \u79d2\nprivate SendResult sendDefaultImpl(msg, communicationMode, sendCallback,timeout) {}\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.makeSureStateOK()"}),"\uff1a\u6821\u9a8c\u751f\u4ea7\u8005\u72b6\u6001\u662f\u8fd0\u884c\u4e2d\uff0c\u5426\u5219\u629b\u51fa\u5f02\u5e38"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u5f53\u524d\u6d88\u606f\u4e3b\u9898\u7684\u53d1\u5e03\u4fe1\u606f"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.topicPublishInfoTable.get(topic)"}),"\uff1a\u5148\u5c1d\u8bd5\u4ece\u672c\u5730\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\u6620\u5c04\u8868\u83b7\u53d6\u4fe1\u606f\uff0c\u83b7\u53d6\u4e0d\u5230\u7ee7\u7eed\u6267\u884c"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory.update...FromNameServer(topic)"}),"\uff1a\u7136\u540e\u4ece Namesrv \u66f4\u65b0\u8be5 Topic \u7684\u8def\u7531\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory.update...FromNameServer(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8def\u7531\u6570\u636e\u662f\u7a7a\uff0c\u83b7\u53d6\u9ed8\u8ba4 TBW102 \u7684\u6570\u636e"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"return topicPublishInfo"}),"\uff1a\u8fd4\u56de TBW102 \u4e3b\u9898\u7684\u53d1\u5e03\u4fe1\u606f"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"String[] brokersSent = new String[timesTotal]"}),"\uff1a\u4e0b\u6807\u7d22\u5f15\u4ee3\u8868\u7b2c\u51e0\u6b21\u53d1\u9001\uff0c\u503c\u4ee3\u8868\u8fd9\u6b21\u53d1\u9001\u9009\u62e9 Broker name"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (; times < timesTotal; times++)"}),"\uff1a\u5faa\u73af\u53d1\u9001\uff0c",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u6210\u529f\u6216\u8005\u53d1\u9001\u5c1d\u8bd5\u6b21\u6570\u8fbe\u5230\u4e0a\u9650\uff0c\u7ed3\u675f\u5faa\u73af"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"String lastBrokerName = null == mq ? null : mq.getBrokerName()"}),"\uff1a\u83b7\u53d6\u4e0a\u6b21\u53d1\u9001\u5931\u8d25\u7684 BrokerName"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"mqSelected = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName)"}),"\uff1a\u4ece\u53d1\u5e03\u4fe1\u606f\u4e2d\u9009\u62e9\u4e00\u4e2a\u961f\u5217\uff0c\u751f\u4ea7\u8005\u7684",(0,l.jsx)(n.strong,{children:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565"}),"\uff0c\u53c2\u8003\u7cfb\u7edf\u7279\u6027\u7ae0\u8282"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"brokersSent[times] = mq.getBrokerName()"}),"\uff1a\u5c06\u672c\u6b21\u9009\u62e9\u7684 BrokerName \u5b58\u5165\u6570\u7ec4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"msg.setTopic(this.defaultMQProducer.withNamespace(msg.getTopic()))"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4ea7\u751f\u91cd\u6295\uff0c\u91cd\u6295\u6d88\u606f\u9700\u8981\u52a0\u4e0a\u6807\u8bb0"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"sendResult = this.sendKernelImpl"}),"\uff1a\u6838\u5fc3\u53d1\u9001\u65b9\u6cd5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (communicationMode)"}),"\uff1a\u5f02\u6b65\u6216\u8005\u5355\u5411\u6d88\u606f\u76f4\u63a5\u8fd4\u56de null\uff0c\u5f02\u6b65\u901a\u8fc7\u56de\u8c03\u51fd\u6570\u5904\u7406\uff0c\u540c\u6b65\u53d1\u9001\u8fdb\u5165\u903b\u8f91\u5224\u65ad"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (sendResult.getSendStatus() != SendStatus.SEND_OK)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u670d\u52a1\u7aef Broker \u5b58\u50a8\u5931\u8d25\uff0c\u9700\u8981\u91cd\u8bd5\u5176\u4ed6 Broker"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"throw new MQClientException()"}),"\uff1a\u672a\u627e\u5230\u5f53\u524d\u4e3b\u9898\u7684\u8def\u7531\u6570\u636e\uff0c\u65e0\u6cd5\u53d1\u9001\u6d88\u606f\uff0c\u629b\u51fa\u5f02\u5e38"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["sendKernelImpl()\uff1a",(0,l.jsx)(n.strong,{children:"\u6838\u5fc3\u53d1\u9001\u65b9\u6cd5"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"//\u53c2\u65701\uff1a\u6d88\u606f\uff1b\u53c2\u65702\uff1a\u9009\u62e9\u7684\u961f\u5217\uff1b\u53c2\u65703\uff1a\u53d1\u9001\u6a21\u5f0f\uff08\u540c\u6b65\u5f02\u6b65\u5355\u5411\uff09\uff1b\u53c2\u65704\uff1a\u56de\u8c03\u51fd\u6570\uff0c\u5f02\u6b65\u53d1\u9001\u65f6\u9700\u8981\uff1b\u53c2\u65705\uff1a\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\uff1b\u53c2\u65706\uff1a\u5269\u4f59\u8d85\u65f6\u65f6\u95f4\u9650\u5236\nprivate SendResult sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"brokerAddr = this.mQClientFactory(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u6307\u5b9a BrokerName \u5bf9\u5e94\u7684 mater \u8282\u70b9\u7684\u5730\u5740"}),"\uff0cmaster \u8282\u70b9\u7684 ID \u4e3a 0\uff0c\u96c6\u7fa4\u6a21\u5f0f\u4e0b\uff0c",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u6d88\u606f\u8981\u53d1\u5230\u4e3b\u8282\u70b9"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"brokerAddr = MixAll.brokerVIPChannel()"}),"\uff1aBroker \u542f\u52a8\u65f6\u4f1a\u7ed1\u5b9a\u4e24\u4e2a\u670d\u52a1\u5668\u7aef\u53e3\uff0c\u4e00\u4e2a\u662f\u666e\u901a\u7aef\u53e3\uff0c\u4e00\u4e2a\u662f VIP \u7aef\u53e3\uff0c\u670d\u52a1\u5668\u7aef\u6839\u636e\u4e0d\u540c\u7aef\u53e3\u521b\u5efa\u4e0d\u540c\u7684\u7684 NioSocketChannel"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"byte[] prevBody = msg.getBody()"}),"\uff1a\u83b7\u53d6\u6d88\u606f\u4f53"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!(msg instanceof MessageBatch))"}),"\uff1a\u975e\u6279\u91cf\u6d88\u606f\uff0c\u9700\u8981\u91cd\u65b0\u8bbe\u7f6e\u6d88\u606f ID"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageClientIDSetter.setUniqID(msg)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"msg id \u7531\u4e24\u90e8\u5206\u7ec4\u6210"}),"\uff0c\u4e00\u90e8\u5206\u662f ip \u5730\u5740\u3001\u8fdb\u7a0b\u53f7\u3001Classloader \u7684 hashcode\uff0c\u53e6\u4e00\u90e8\u5206\u662f\u65f6\u95f4\u5dee\uff08\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u5f53\u6708\u4e00\u53f7\u7684\u65f6\u95f4\uff09\u548c\u8ba1\u6570\u5668\u7684\u503c"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.tryToCompressMessage(msg))"}),"\uff1a\u5224\u65ad\u6d88\u606f\u662f\u5426\u538b\u7f29\uff0c\u538b\u7f29\u9700\u8981\u8bbe\u7f6e\u538b\u7f29\u6807\u8bb0"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"hasCheckForbiddenHook\u3001hasSendMessageHook"}),"\uff1a\u6267\u884c\u94a9\u5b50\u65b9\u6cd5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"requestHeader = new SendMessageRequestHeader()"}),"\uff1a\u8bbe\u7f6e\u53d1\u9001\u6d88\u606f\u7684\u6d88\u606f\u5934"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX))"}),"\uff1a\u91cd\u6295\u7684\u53d1\u9001\u6d88\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (communicationMode)"}),"\uff1a\u5f02\u6b65\u53d1\u9001\u4e00\u79cd\u5904\u7406\u65b9\u5f0f\uff0c\u5355\u5411\u548c\u540c\u6b65\u540c\u6837\u7684\u5904\u7406\u903b\u8f91"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u6d88\u606f"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"request = RemotingCommand.createRequestCommand()"}),"\uff1a\u521b\u5efa\u4e00\u4e2a RequestCommand \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"request.setBody(msg.getBody())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u6d88\u606f\u653e\u5165\u8bf7\u6c42\u4f53"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"switch (communicationMode)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6839\u636e\u4e0d\u540c\u7684\u6a21\u5f0f invoke \u4e0d\u540c\u7684\u65b9\u6cd5"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"request()\uff1a\u8bf7\u6c42\u65b9\u6cd5\uff0c\u6d88\u8d39\u8005\u56de\u6267\u6d88\u606f\uff0c\u8fd9\u79cd\u6d88\u606f\u662f\u5f02\u6b65\u6d88\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"requestResponseFuture = new RequestResponseFuture(correlationId, timeout, null)"}),"\uff1a\u521b\u5efa\u8bf7\u6c42\u54cd\u5e94\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"getRequestFutureTable().put(correlationId, requestResponseFuture)"}),"\uff1a\u653e\u5165RequestFutureTable \u6620\u5c04\u8868\u4e2d"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.sendDefaultImpl(msg, CommunicationMode.ASYNC, new SendCallback())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u5f02\u6b65\u6d88\u606f\uff0c\u6709\u56de\u8c03\u51fd\u6570"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"return waitResponse(msg, timeout, requestResponseFuture, cost)"}),"\uff1a\u7528\u6765\u6302\u8d77\u8bf7\u6c42\u7684\u65b9\u6cd5"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public Message waitResponseMessage(final long timeout) throws InterruptedException {\n    // \u8bf7\u6c42\u6302\u8d77\n    this.countDownLatch.await(timeout, TimeUnit.MILLISECONDS);\n    return this.responseMsg;\n}\n\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5f53\u6d88\u606f\u88ab\u6d88\u8d39\u540e\uff0c\u5ba2\u6237\u7aef\u5904\u7406\u54cd\u5e94\u65f6\u901a\u8fc7\u6d88\u606f\u7684\u5173\u8054 ID\uff0c\u4ece\u6620\u5c04\u8868\u4e2d\u83b7\u53d6\u6d88\u606f\u7684 RequestResponseFuture\uff0c\u6267\u884c\u4e0b\u9762\u7684\u65b9\u6cd5\u5524\u9192\u6302\u8d77\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void putResponseMessage(final Message responseMsg) {\n    this.responseMsg = responseMsg;\n    this.countDownLatch.countDown();\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u8def\u7531\u4fe1\u606f-1",children:"\u8def\u7531\u4fe1\u606f"}),"\n",(0,l.jsx)(n.p,{children:"TopicPublishInfo \u7c7b\u7528\u6765\u5b58\u50a8\u8def\u7531\u4fe1\u606f"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u987a\u5e8f\u6d88\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private boolean orderTopic = false;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u961f\u5217\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private List<MessageQueue> messageQueueList = new ArrayList<>();\t\t\t// \u4e3b\u9898\u5168\u90e8\u7684\u6d88\u606f\u961f\u5217\nprivate volatile ThreadLocalIndex sendWhichQueue = new ThreadLocalIndex();\t// \u6d88\u606f\u961f\u5217\u7d22\u5f15\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u3010\u6d88\u606f\u961f\u5217\u7c7b\u3011\npublic class MessageQueue implements Comparable<MessageQueue>, Serializable {\n    private String topic;\n    private String brokerName;\n    private int queueId;// \u961f\u5217 ID\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8def\u7531\u6570\u636e\uff1a\u4e3b\u9898\u5bf9\u5e94\u7684\u8def\u7531\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private TopicRouteData topicRouteData;\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class TopicRouteData extends RemotingSerializable {\n    private String orderTopicConf;\n    private List<QueueData> queueDatas;\t\t// \u961f\u5217\u6570\u636e\n    private List<BrokerData> brokerDatas;\t// Broker \u6570\u636e\n    private HashMap<String/* brokerAddr */, List<String>/* Filter Server */> filterServerTable;\n}\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class QueueData implements Comparable<QueueData> {\n    private String brokerName;\t// \u8282\u70b9\u540d\u79f0\n    private int readQueueNums;\t// \u8bfb\u961f\u5217\u6570\n    private int writeQueueNums;\t// \u5199\u961f\u5217\u6570\n    private int perm;\t\t\t// \u6743\u9650\n    private int topicSynFlag;\n}\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class BrokerData implements Comparable<BrokerData> {\n    private String cluster;\t\t// \u96c6\u7fa4\u540d\n    private String brokerName;\t// Broker\u8282\u70b9\u540d\u79f0\n    private HashMap<Long/* brokerId */, String/* broker address */> brokerAddrs;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["selectOneMessageQueue()\uff1a",(0,l.jsx)(n.strong,{children:"\u9009\u62e9\u6d88\u606f\u961f\u5217"}),"\u4f7f\u7528"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u662f\u4e0a\u6b21\u5931\u8d25\u65f6\u7684 brokerName\uff0c\u53ef\u4ee5\u4e3a null\npublic MessageQueue selectOneMessageQueue(final String lastBrokerName) {\n    if (lastBrokerName == null) {\n        return selectOneMessageQueue();\n    } else {\n        // \u904d\u5386\u6d88\u606f\u961f\u5217\n        for (int i = 0; i < this.messageQueueList.size(); i++) {\n            // \u3010\u83b7\u53d6\u961f\u5217\u7684\u7d22\u5f15\uff0c+1\u3011\n            int index = this.sendWhichQueue.getAndIncrement();\n            // \u83b7\u53d6\u961f\u5217\u7684\u4e0b\u6807\u4f4d\u7f6e\n            int pos = Math.abs(index) % this.messageQueueList.size();\n            if (pos < 0)\n                pos = 0;\n            // \u83b7\u53d6\u6d88\u606f\u961f\u5217\n            MessageQueue mq = this.messageQueueList.get(pos);\n            // \u4e0e\u4e0a\u6b21\u9009\u62e9\u7684\u4e0d\u540c\u5c31\u53ef\u4ee5\u8fd4\u56de\n            if (!mq.getBrokerName().equals(lastBrokerName)) {\n                return mq;\n            }\n        }\n        return selectOneMessageQueue();\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u516c\u5171\u914d\u7f6e",children:"\u516c\u5171\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u516c\u5171\u7684\u914d\u7f6e\u4fe1\u606f\u7c7b"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ClientConfig \u7c7b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class ClientConfig {\n    // Namesrv \u5730\u5740\u914d\u7f6e\n    private String namesrvAddr = NameServerAddressUtils.getNameServerAddresses();\n    // \u5ba2\u6237\u7aef\u7684 IP \u5730\u5740\n    private String clientIP = RemotingUtil.getLocalAddress();\n    // \u5ba2\u6237\u7aef\u5b9e\u4f8b\u540d\u79f0\n    private String instanceName = System.getProperty("rocketmq.client.name", "DEFAULT");\n    // \u5ba2\u6237\u7aef\u56de\u8c03\u7ebf\u7a0b\u6c60\u7684\u6570\u91cf\uff0c\u5e73\u53f0\u6838\u5fc3\u6570\uff0c8\u683816\u7ebf\u7a0b\u7684\u7535\u8111\u8fd4\u56de16\n    private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors();\n    // \u547d\u540d\u7a7a\u95f4\n    protected String namespace;\n    protected AccessChannel accessChannel = AccessChannel.LOCAL;\n\n    // \u83b7\u53d6\u8def\u7531\u4fe1\u606f\u7684\u95f4\u9694\u65f6\u95f4 30s\n    private int pollNameServerInterval = 1000 * 30;\n    // \u5ba2\u6237\u7aef\u4e0e broker \u4e4b\u95f4\u7684\u5fc3\u8df3\u5468\u671f 30s\n    private int heartbeatBrokerInterval = 1000 * 30;\n    // \u6d88\u8d39\u8005\u6301\u4e45\u5316\u6d88\u8d39\u7684\u5468\u671f 5s\n    private int persistConsumerOffsetInterval = 1000 * 5;\n    private long pullTimeDelayMillsWhenException = 1000;\n    private boolean unitMode = false;\n    private String unitName;\n    // vip \u901a\u9053\uff0cbroker \u542f\u52a8\u65f6\u7ed1\u5b9a\u4e24\u4e2a\u7aef\u53e3\uff0c\u5176\u4e2d\u4e00\u4e2a\u662f vip \u901a\u9053\n    private boolean vipChannelEnabled = Boolean.parseBoolean();\n    // \u8bed\u8a00\uff0c\u9ed8\u8ba4\u662f Java\n    private LanguageCode language = LanguageCode.JAVA;\n}\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"NettyClientConfig"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class NettyClientConfig {\n    // \u5ba2\u6237\u7aef\u5de5\u4f5c\u7ebf\u7a0b\u6570\n    private int clientWorkerThreads = 4;\n    // \u56de\u8c03\u5904\u7406\u7ebf\u7a0b\u6c60 \u7ebf\u7a0b\u6570\uff1a\u5e73\u53f0\u6838\u5fc3\u6570\n    private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors();\n    // \u5355\u5411\u8bf7\u6c42\u5e76\u53d1\u6570\uff0c\u9ed8\u8ba4 65535\n    private int clientOnewaySemaphoreValue = NettySystemConfig.CLIENT_ONEWAY_SEMAPHORE_VALUE;\n    // \u5f02\u6b65\u8bf7\u6c42\u5e76\u53d1\u6570\uff0c\u9ed8\u8ba4 65535\n    private int clientAsyncSemaphoreValue = NettySystemConfig.CLIENT_ASYNC_SEMAPHORE_VALUE;\n    // \u5ba2\u6237\u7aef\u8fde\u63a5\u670d\u52a1\u5668\u7684\u8d85\u65f6\u65f6\u95f4\u9650\u5236 3\u79d2\n    private int connectTimeoutMillis = 3000;\n    // \u5ba2\u6237\u7aef\u672a\u6fc0\u6d3b\u5468\u671f\uff0c60s\uff08\u6307\u5b9a\u65f6\u95f4\u5185 ch \u672a\u6fc0\u6d3b\uff0c\u9700\u8981\u5173\u95ed\uff09\n    private long channelNotActiveInterval = 1000 * 60;\n    // \u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u5668 ch \u6700\u5927\u7a7a\u95f2\u65f6\u95f4 2\u5206\u949f\n    private int clientChannelMaxIdleTimeSeconds = 120;\n\n    // \u5e95\u5c42 Socket \u5199\u548c\u6536 \u7f13\u51b2\u533a\u7684\u5927\u5c0f 65535  64k\n    private int clientSocketSndBufSize = NettySystemConfig.socketSndbufSize;\n    private int clientSocketRcvBufSize = NettySystemConfig.socketRcvbufSize;\n    // \u5ba2\u6237\u7aef netty \u662f\u5426\u542f\u52a8\u5185\u5b58\u6c60\n    private boolean clientPooledByteBufAllocatorEnable = false;\n    // \u5ba2\u6237\u7aef\u662f\u5426\u8d85\u65f6\u5173\u95ed Socket \u8fde\u63a5\n    private boolean clientCloseSocketIfTimeout = false;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5ba2\u6237\u7aef\u7c7b",children:"\u5ba2\u6237\u7aef\u7c7b"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-8",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsxs)(n.p,{children:["MQClientInstance \u662f RocketMQ \u5ba2\u6237\u7aef\u5b9e\u4f8b\uff0c\u5728\u4e00\u4e2a JVM \u8fdb\u7a0b\u4e2d\u53ea\u6709\u4e00\u4e2a\u5ba2\u6237\u7aef\u5b9e\u4f8b\uff0c",(0,l.jsx)(n.strong,{children:"\u65e2\u670d\u52a1\u4e8e\u751f\u4ea7\u8005\uff0c\u4e5f\u670d\u52a1\u4e8e\u6d88\u8d39\u8005"})]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u4fe1\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final int instanceIndex;\t\t\t// \u7d22\u5f15\u4e00\u822c\u662f 0\uff0c\u56e0\u4e3a\u5ba2\u6237\u7aef\u5b9e\u4f8b\u4e00\u822c\u90fd\u662f\u4e00\u4e2a\u8fdb\u7a0b\u53ea\u6709\u4e00\u4e2a\nprivate final String clientId;\t\t\t\t// \u5ba2\u6237\u7aef ID ip@pid\nprivate final long bootTimestamp;\t\t\t// \u5ba2\u6237\u7aef\u7684\u542f\u52a8\u65f6\u95f4\nprivate ServiceState serviceState;\t\t\t// \u5ba2\u6237\u7aef\u72b6\u6001\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u751f\u4ea7\u8005\u6d88\u8d39\u8005\u7684\u6620\u5c04\u8868\uff1akey \u662f\u7ec4\u540d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ConcurrentMap<String, MQProducerInner> producerTable\nprivate final ConcurrentMap<String, MQConsumerInner> consumerTable\nprivate final ConcurrentMap<String, MQAdminExtInner> adminExtTable\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7f51\u7edc\u5c42\u914d\u7f6e\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final NettyClientConfig nettyClientConfig;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u529f\u80fd\u7684\u5b9e\u73b0\uff1a\u8d1f\u8d23\u5c06 MQ \u4e1a\u52a1\u5c42\u7684\u6570\u636e\u8f6c\u6362\u4e3a\u7f51\u7edc\u5c42\u7684 RemotingCommand \u5bf9\u8c61\uff0c\u4f7f\u7528\u5185\u90e8\u6301\u6709\u7684 NettyRemotingClient \u5bf9\u8c61\u7684 invoke \u7cfb\u5217\u65b9\u6cd5\uff0c\u5b8c\u6210\u7f51\u7edc IO\uff08\u540c\u6b65\u3001\u5f02\u6b65\u3001\u5355\u5411\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final MQClientAPIImpl mQClientAPIImpl;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u672c\u5730\u8def\u7531\u6570\u636e\uff1akey \u662f\u4e3b\u9898\u540d\u79f0\uff0cvalue \u8def\u7531\u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ConcurrentMap<String, TopicRouteData> topicRouteTable = new ConcurrentHashMap<>();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9501\u4fe1\u606f\uff1a\u4e24\u628a\u9501\uff0c\u9501\u4e0d\u540c\u7684\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final Lock lockNamesrv = new ReentrantLock();\nprivate final Lock lockHeartbeat = new ReentrantLock();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff1a\u5355\u7ebf\u7a0b\uff0c\u6267\u884c\u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ScheduledExecutorService scheduledExecutorService;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Broker \u6620\u5c04\u8868\uff1akey \u662f BrokerName"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u7269\u7406\u8282\u70b9\u6620\u5c04\u8868\uff0cvalue\uff1aLong \u662f brokerID\uff0c\u3010ID=0 \u7684\u662f\u4e3b\u8282\u70b9\uff0c\u5176\u4ed6\u662f\u4ece\u8282\u70b9\u3011\uff0cString \u662f\u5730\u5740 ip:port\nprivate final ConcurrentMap<String, HashMap<Long, String>> brokerAddrTable;\n// \u7269\u7406\u8282\u70b9\u7248\u672c\u6620\u5c04\u8868\uff0cString \u662f\u5730\u5740 ip:port\uff0cInteger \u662f\u7248\u672c\nConcurrentMap<String, HashMap<String, Integer>> brokerVersionTable;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u5ba2\u6237\u7aef\u7684\u534f\u8bae\u5904\u7406\u5668"}),"\uff1a\u7528\u4e8e\u5904\u7406 IO \u4e8b\u4ef6"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ClientRemotingProcessor clientRemotingProcessor;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u670d\u52a1\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final PullMessageService pullMessageService;\t\t// \u62c9\u6d88\u606f\u670d\u52a1\nprivate final RebalanceService rebalanceService;\t\t\t// \u6d88\u8d39\u8005\u8d1f\u8f7d\u5747\u8861\u670d\u52a1\nprivate final ConsumerStatsManager consumerStatsManager;\t// \u6d88\u8d39\u8005\u72b6\u6001\u7ba1\u7406\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5185\u90e8\u751f\u4ea7\u8005\u5b9e\u4f8b\uff1a\u5904\u7406\u6d88\u8d39\u7aef",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u56de\u9000"}),"\uff0c\u7528\u8be5\u751f\u4ea7\u8005\u53d1\u9001\u56de\u9000\u6d88\u606f"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final DefaultMQProducer defaultMQProducer;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5fc3\u8df3\u6b21\u6570\u7edf\u8ba1\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final AtomicLong sendHeartbeatTimesTotal = new AtomicLong(0)\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"MQClientInstance \u6709\u53c2\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public MQClientInstance(ClientConfig clientConfig, int instanceIndex, String clientId, RPCHook rpcHook) {\n    this.clientConfig = clientConfig;\n    this.instanceIndex = instanceIndex;\n    // Netty \u76f8\u5173\u7684\u914d\u7f6e\u4fe1\u606f\n    this.nettyClientConfig = new NettyClientConfig();\n    // \u5e73\u53f0\u6838\u5fc3\u6570\n    this.nettyClientConfig.setClientCallbackExecutorThreads(...);\n    this.nettyClientConfig.setUseTLS(clientConfig.isUseTLS());\n    // \u3010\u521b\u5efa\u5ba2\u6237\u7aef\u534f\u8bae\u5904\u7406\u5668\u3011\n    this.clientRemotingProcessor = new ClientRemotingProcessor(this);\n    // \u521b\u5efa API \u5b9e\u73b0\u5bf9\u8c61\n    // \u53c2\u6570\u4e00\uff1a\u5ba2\u6237\u7aef\u7f51\u7edc\u914d\u7f6e\n    // \u53c2\u6570\u4e8c\uff1a\u5ba2\u6237\u7aef\u534f\u8bae\u5904\u7406\u5668\uff0c\u6ce8\u518c\u5230\u5ba2\u6237\u7aef\u7f51\u7edc\u5c42\n    // \u53c2\u6570\u4e09\uff1arpcHook\uff0c\u6ce8\u518c\u5230\u5ba2\u6237\u7aef\u7f51\u7edc\u5c42\n    // \u53c2\u6570\u56db\uff1a\u5ba2\u6237\u7aef\u914d\u7f6e\n    this.mQClientAPIImpl = new MQClientAPIImpl(this.nettyClientConfig, this.clientRemotingProcessor, rpcHook, clientConfig);\n\n    //...\n    // \u5185\u90e8\u751f\u4ea7\u8005\uff0c\u6307\u5b9a\u5185\u90e8\u751f\u4ea7\u8005\u7684\u7ec4\n    this.defaultMQProducer = new DefaultMQProducer(MixAll.CLIENT_INNER_PRODUCER_GROUP);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"MQClientAPIImpl \u6709\u53c2\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public MQClientAPIImpl(nettyClientConfig, clientRemotingProcessor, rpcHook, clientConfig) {\n    this.clientConfig = clientConfig;\n    topAddressing = new TopAddressing(MixAll.getWSAddr(), clientConfig.getUnitName());\n    // \u521b\u5efa\u7f51\u7edc\u5c42\u5bf9\u8c61\uff0c\u53c2\u6570\u4e8c\u4e3a null \u8bf4\u660e\u5ba2\u6237\u7aef\u5e76\u4e0d\u5173\u5fc3 channel event\n    this.remotingClient = new NettyRemotingClient(nettyClientConfig, null);\n    // \u4e1a\u52a1\u5904\u7406\u5668\n    this.clientRemotingProcessor = clientRemotingProcessor;\n    // \u6ce8\u518c RpcHook\n    this.remotingClient.registerRPCHook(rpcHook);\n\t// ...\n    // \u6ce8\u518c\u56de\u9000\u6d88\u606f\u7684\u8bf7\u6c42\u7801\n    this.remotingClient.registerProcessor(RequestCode.PUSH_REPLY_MESSAGE_TO_CLIENT, this.clientRemotingProcessor, null);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-7",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"synchronized (this)"}),"\uff1a\u52a0\u9501\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168\uff0c\u4fdd\u8bc1\u53ea\u6709\u4e00\u4e2a\u5b9e\u4f8b\u5bf9\u8c61\u542f\u52a8"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mQClientAPIImpl.start()"}),"\uff1a\u542f\u52a8\u5ba2\u6237\u7aef\u7f51\u7edc\u5c42\uff0c\u5e95\u5c42\u8c03\u7528 RemotingClient \u7c7b"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.startScheduledTask()"}),"\uff1a\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.pullMessageService.start()"}),"\uff1a\u542f\u52a8\u62c9\u53d6\u6d88\u606f\u670d\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.rebalanceService.start()"}),"\uff1a\u542f\u52a8\u8d1f\u8f7d\u5747\u8861\u670d\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.defaultMQProducer...start(false)"}),"\uff1a\u542f\u52a8\u5185\u90e8\u751f\u4ea7\u8005\uff0c\u53c2\u6570\u4e3a false \u4ee3\u8868\u4e0d\u542f\u52a8\u5b9e\u4f8b"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["startScheduledTask()\uff1a",(0,l.jsx)(n.strong,{children:"\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1"}),"\uff0c\u8c03\u5ea6\u7ebf\u7a0b\u6c60\u662f\u5355\u7ebf\u7a0b"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == this.clientConfig.getNamesrvAddr())"}),"\uff1aNamesrv \u5730\u5740\u662f\u7a7a\uff0c\u9700\u8981\u4e24\u5206\u949f\u62c9\u53d6\u4e00\u6b21 Namesrv \u5730\u5740"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5b9a\u65f6\u4efb\u52a1 1\uff1a",(0,l.jsx)(n.strong,{children:"\u4ece Namesrv \u66f4\u65b0\u5ba2\u6237\u7aef\u672c\u5730\u7684\u8def\u7531\u6570\u636e"}),"\uff0c\u5468\u671f 30 \u79d2\u4e00\u6b21"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u83b7\u53d6\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u8ba2\u9605\u7684\u4e3b\u9898\u96c6\u5408\uff0c\u904d\u5386\u96c6\u5408\uff0c\u5bf9\u6bd4\u4ece namesrv \u62c9\u53d6\u6700\u65b0\u7684\u4e3b\u9898\u8def\u7531\u6570\u636e\u548c\u672c\u5730\u6570\u636e\uff0c\u662f\u5426\u9700\u8981\u66f4\u65b0\nMQClientInstance.this.updateTopicRouteInfoFromNameServer();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u4efb\u52a1 2\uff1a\u5468\u671f 30 \u79d2\u4e00\u6b21\uff0c\u4e24\u4e2a\u4efb\u52a1"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u6e05\u7406\u4e0b\u7ebf\u7684 Broker \u8282\u70b9"}),"\uff0c\u904d\u5386\u5ba2\u6237\u7aef\u7684 Broker \u7269\u7406\u8282\u70b9\u6620\u5c04\u8868\uff0c\u5c06\u6240\u6709\u4e3b\u9898\u6570\u636e\u90fd\u4e0d\u5305\u542b\u7684 Broker \u7269\u7406\u8282\u70b9\u6e05\u7406\u6389\uff0c\u5982\u679c\u88ab\u6e05\u7406\u7684 Broker \u4e0b\u6240\u6709\u7684\u7269\u7406\u8282\u70b9\u90fd\u6ca1\u6709\u4e86\uff0c\u5c31\u5c06\u8be5 Broker \u7684\u6620\u5c04\u6570\u636e\u5220\u9664\u6389"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u5411\u5728\u7ebf\u7684\u6240\u6709\u7684 Broker \u53d1\u9001\u5fc3\u8df3\u6570\u636e"}),"\uff0c\u540c\u6b65\u53d1\u9001\u7684\u65b9\u5f0f\uff0c\u8fd4\u56de\u503c\u662f Broker \u7269\u7406\u8282\u70b9\u7684\u7248\u672c\u53f7\uff0c\u66f4\u65b0\u7248\u672c\u6620\u5c04\u8868"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"MQClientInstance.this.cleanOfflineBroker();\nMQClientInstance.this.sendHeartbeatToAllBrokerWithLock();\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u5fc3\u8df3\u6570\u636e\npublic class HeartbeatData extends RemotingSerializable {\n    // \u5ba2\u6237\u7aef ID  ip@pid\n    private String clientID;\n    // \u5b58\u50a8\u5ba2\u6237\u7aef\u6240\u6709\u751f\u4ea7\u8005\u6570\u636e\n    private Set<ProducerData> producerDataSet = new HashSet<ProducerData>();\n    // \u5b58\u50a8\u5ba2\u6237\u7aef\u6240\u6709\u6d88\u8d39\u8005\u6570\u636e\n    private Set<ConsumerData> consumerDataSet = new HashSet<ConsumerData>();\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u4efb\u52a1 3\uff1a\u6d88\u8d39\u8005\u6301\u4e45\u5316\u6d88\u8d39\u6570\u636e\uff0c\u5468\u671f 5 \u79d2\u4e00\u6b21"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"MQClientInstance.this.persistAllConsumerOffset();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u4efb\u52a1 4\uff1a\u52a8\u6001\u8c03\u6574\u6d88\u8d39\u8005\u7ebf\u7a0b\u6c60\uff0c\u5468\u671f 1 \u5206\u949f\u4e00\u6b21"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"MQClientInstance.this.adjustThreadPool();\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["updateTopicRouteInfoFromNameServer()\uff1a",(0,l.jsx)(n.strong,{children:"\u66f4\u65b0\u8def\u7531\u6570\u636e"}),"\uff0c\u901a\u8fc7\u52a0\u9501\u4fdd\u8bc1\u5f53\u524d\u5b9e\u4f8b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u53bb\u66f4\u65b0"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (isDefault && defaultMQProducer != null)"}),"\uff1a\u9700\u8981\u9ed8\u8ba4\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"topicRouteData = ...getDefaultTopicRouteInfoFromNameServer()"}),"\uff1a\u4ece Namesrv \u83b7\u53d6\u9ed8\u8ba4\u7684 TBW102 \u7684\u8def\u7531\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"topicRouteData = ...getTopicRouteInfoFromNameServer(topic)"}),"\uff1a\u9700\u8981",(0,l.jsx)(n.strong,{children:"\u4ece Namesrv \u83b7\u53d6"}),"\u8def\u7531\u6570\u636e\uff08\u540c\u6b65\uff09"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"old = this.topicRouteTable.get(topic)"}),"\uff1a\u83b7\u53d6\u5ba2\u6237\u7aef\u5b9e\u4f8b\u672c\u5730\u7684\u8be5\u4e3b\u9898\u7684\u8def\u7531\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean changed = topicRouteDataIsChange(old, topicRouteData)"}),"\uff1a\u5bf9\u6bd4\u672c\u5730\u548c\u6700\u65b0\u4e0b\u62c9\u7684\u6570\u636e\u662f\u5426\u4e00\u81f4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (changed)"}),"\uff1a\u4e0d\u4e00\u81f4\u8fdb\u5165\u66f4\u65b0\u903b\u8f91"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.brokerAddrTable.put(...)"}),"\uff1a\u66f4\u65b0\u5ba2\u6237\u7aef broker \u7269\u7406",(0,l.jsx)(n.strong,{children:"\u8282\u70b9\u6620\u5c04\u8868"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Update Pub info"}),"\uff1a\u66f4\u65b0\u751f\u4ea7\u8005\u4fe1\u606f"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"publishInfo = topicRouteData2TopicPublishInfo(topic, topicRouteData)"}),"\uff1a\u5c06\u4e3b\u9898\u8def\u7531\u6570\u636e\u8f6c\u5316\u4e3a\u53d1\u5e03\u6570\u636e\uff0c\u4f1a",(0,l.jsx)(n.strong,{children:"\u521b\u5efa\u6d88\u606f\u961f\u5217 MQ"}),"\uff0c\u653e\u5165\u53d1\u5e03\u6570\u636e\u5bf9\u8c61\u7684\u96c6\u5408\u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"impl.updateTopicPublishInfo(topic, publishInfo)"}),"\uff1a\u751f\u4ea7\u8005\u5c06\u4e3b\u9898\u7684\u53d1\u5e03\u6570\u636e\u4fdd\u5b58\u5230\u5b83\u672c\u5730\uff0c\u65b9\u4fbf\u53d1\u9001\u6d88\u606f\u4f7f\u7528"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Update sub info"}),"\uff1a\u66f4\u65b0\u6d88\u8d39\u8005\u4fe1\u606f\uff0c\u521b\u5efa MQ \u961f\u5217\uff0c\u66f4\u65b0\u8ba2\u9605\u4fe1\u606f\uff0c\u7528\u4e8e\u8d1f\u8f7d\u5747\u8861"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.topicRouteTable.put(topic, cloneTopicRouteData)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u6570\u636e\u653e\u5165\u672c\u5730\u8def\u7531\u8868"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u7f51\u7edc\u901a\u4fe1-1",children:"\u7f51\u7edc\u901a\u4fe1"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-9",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"NettyRemotingClient \u7c7b\u8d1f\u8d23\u5ba2\u6237\u7aef\u7684\u7f51\u7edc\u901a\u4fe1"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Netty \u670d\u52a1\u76f8\u5173\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final NettyClientConfig nettyClientConfig;\t\t\t// \u5ba2\u6237\u7aef\u7684\u7f51\u7edc\u5c42\u914d\u7f6e\nprivate final Bootstrap bootstrap = new Bootstrap();\t\t// \u5ba2\u6237\u7aef\u7f51\u7edc\u5c42\u542f\u52a8\u5bf9\u8c61\nprivate final EventLoopGroup eventLoopGroupWorker;\t\t\t// \u5ba2\u6237\u7aef\u7f51\u7edc\u5c42 Netty IO \u7ebf\u7a0b\u7ec4\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Channel \u6620\u5c04\u8868\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ConcurrentMap<String, ChannelWrapper> channelTables;// key \u662f\u670d\u52a1\u5668\u7684\u5730\u5740\uff0cvalue \u662f\u901a\u9053\u5bf9\u8c61\nprivate final Lock lockChannelTables = new ReentrantLock();\t\t  // \u9501\uff0c\u63a7\u5236\u5e76\u53d1\u5b89\u5168\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u5668\uff1a\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'private final Timer timer = new Timer("ClientHouseKeepingService", true)\n'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ebf\u7a0b\u6c60\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private ExecutorService publicExecutor;\t\t// \u516c\u5171\u7ebf\u7a0b\u6c60\nprivate ExecutorService callbackExecutor; \t// \u56de\u8c03\u7ebf\u7a0b\u6c60\uff0c\u5ba2\u6237\u7aef\u53d1\u8d77\u5f02\u6b65\u8bf7\u6c42\uff0c\u670d\u52a1\u5668\u7684\u54cd\u5e94\u6570\u636e\u7531\u56de\u8c03\u7ebf\u7a0b\u6c60\u5904\u7406\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e8b\u4ef6\u76d1\u542c\u5668\uff1a\u5ba2\u6237\u7aef\u8fd9\u91cc\u662f null"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ChannelEventListener channelEventListener;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u9020\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u65e0\u53c2\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public NettyRemotingClient(final NettyClientConfig nettyClientConfig) {\n    this(nettyClientConfig, null);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6709\u53c2\u6784\u9020\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public NettyRemotingClient(nettyClientConfig, channelEventListener) {\n    // \u7236\u7c7b\u521b\u5efa\u4e862\u4e2a\u4fe1\u53f7\u91cf\uff0c1\u3001\u63a7\u5236\u5355\u5411\u8bf7\u6c42\u7684\u5e76\u53d1\u5ea6\uff0c2\u3001\u63a7\u5236\u5f02\u6b65\u8bf7\u6c42\u7684\u5e76\u53d1\u5ea6\n    super(nettyClientConfig.getClientOnewaySemaphoreValue(), nettyClientConfig.getClientAsyncSemaphoreValue());\n    this.nettyClientConfig = nettyClientConfig;\n    this.channelEventListener = channelEventListener;\n\n    // \u521b\u5efa\u516c\u5171\u7ebf\u7a0b\u6c60\n    int publicThreadNums = nettyClientConfig.getClientCallbackExecutorThreads();\n    if (publicThreadNums <= 0) {\n        publicThreadNums = 4;\n    }\n    this.publicExecutor = Executors.newFixedThreadPool(publicThreadNums,);\n\n    // \u521b\u5efa Netty IO \u7ebf\u7a0b\uff0c1\u4e2a\u7ebf\u7a0b\n    this.eventLoopGroupWorker = new NioEventLoopGroup(1, );\n\n    if (nettyClientConfig.isUseTLS()) {\n  \t\tsslContext = TlsHelper.buildSslContext(true);\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-8",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start() {\n    // channel pipeline \u5185\u7684 handler \u4f7f\u7528\u7684\u7ebf\u7a0b\u8d44\u6e90\uff0c\u9ed8\u8ba4 4 \u4e2a\n    this.defaultEventExecutorGroup = new DefaultEventExecutorGroup();\n    // \u914d\u7f6e netty \u5ba2\u6237\u7aef\u542f\u52a8\u7c7b\u5bf9\u8c61\n    Bootstrap handler = this.bootstrap.group(this.eventLoopGroupWorker).channel(NioSocketChannel.class)\n        //...\n        .handler(new ChannelInitializer<SocketChannel>() {\n            @Override\n            public void initChannel(SocketChannel ch) throws Exception {\n                ChannelPipeline pipeline = ch.pipeline();\n                // \u52a0\u51e0\u4e2ahandler\n                pipeline.addLast(\n                    // \u670d\u52a1\u7aef\u7684\u6570\u636e\uff0c\u90fd\u4f1a\u6765\u5230\u8fd9\u4e2a\n                    new NettyClientHandler());\n            }\n        });\n    // \u6ce8\u610f Bootstrap \u53ea\u662f\u914d\u7f6e\u597d\u5ba2\u6237\u7aef\u7684\u5143\u6570\u636e\u4e86\uff0c\u3010\u5728\u8fd9\u91cc\u5e76\u6ca1\u6709\u521b\u5efa\u4efb\u4f55 channel \u5bf9\u8c61\u3011\n    // \u5b9a\u65f6\u4efb\u52a1 \u626b\u63cf responseTable \u4e2d\u8d85\u65f6\u7684 ResponseFuture\uff0c\u907f\u514d\u5ba2\u6237\u7aef\u7ebf\u7a0b\u957f\u65f6\u95f4\u963b\u585e\n    this.timer.scheduleAtFixedRate(() -> {\n     \tNettyRemotingClient.this.scanResponseTable();\n    }, 1000 * 3, 1000);\n    // \u8fd9\u91cc\u662f null\uff0c\u4e0d\u542f\u52a8\n    if (this.channelEventListener != null) {\n        this.nettyEventExecutor.start();\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5355\u5411\u901a\u4fe1\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public RemotingCommand invokeSync(String addr, final RemotingCommand request, long timeoutMillis) {\n    // \u5f00\u59cb\u65f6\u95f4\n    long beginStartTime = System.currentTimeMillis();\n    // \u83b7\u53d6\u6216\u8005\u521b\u5efa\u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u7aef\uff08addr\uff09\u7684\u901a\u9053 channel\n    final Channel channel = this.getAndCreateChannel(addr);\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u7aef channel \u901a\u9053\u6b63\u5e38\uff0c\u53ef\u4ee5\u901a\u4fe1\n    if (channel != null && channel.isActive()) {\n        try {\n            // \u6267\u884c rpcHook \u62d3\u5c55\u70b9\n            doBeforeRpcHooks(addr, request);\n            // \u8ba1\u7b97\u8017\u65f6\uff0c\u5982\u679c\u5f53\u524d\u8017\u65f6\u5df2\u7ecf\u8d85\u8fc7 timeoutMillis \u9650\u5236\uff0c\u5219\u76f4\u63a5\u629b\u51fa\u5f02\u5e38\uff0c\u4e0d\u518d\u8fdb\u884c\u7cfb\u7edf\u901a\u4fe1\n            long costTime = System.currentTimeMillis() - beginStartTime;\n            if (timeoutMillis < costTime) {\n                throw new RemotingTimeoutException("invokeSync call timeout");\n            }\n            // \u53c2\u65701\uff1a\u5ba2\u6237\u7aef-\u670d\u52a1\u7aef\u901a\u9053channel\n            // \u53c2\u6570\u4e8c\uff1a\u7f51\u7edc\u5c42\u4f20\u8f93\u5bf9\u8c61\uff0c\u5c01\u88c5\u7740\u8bf7\u6c42\u6570\u636e\n            // \u53c2\u6570\u4e09\uff1a\u5269\u4f59\u7684\u8d85\u65f6\u9650\u5236\n            RemotingCommand response = this.invokeSyncImpl(channel, request, ...);\n            // \u540e\u7f6e\u5904\u7406\n            doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(channel), request, response);\n            // \u8fd4\u56de\u54cd\u5e94\u6570\u636e\n            return response;\n        } catch (RemotingSendRequestException e) {}\n    } else {\n        this.closeChannel(addr, channel);\n        throw new RemotingConnectException(addr);\n    }\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5ef6\u8fdf\u6d88\u606f",children:"\u5ef6\u8fdf\u6d88\u606f"}),"\n",(0,l.jsx)(n.h5,{id:"\u6d88\u606f\u5904\u7406",children:"\u6d88\u606f\u5904\u7406"}),"\n",(0,l.jsxs)(n.p,{children:["BrokerStartup \u521d\u59cb\u5316 BrokerController \u8c03\u7528 ",(0,l.jsx)(n.code,{children:"registerProcessor()"})," \u65b9\u6cd5\u5c06 SendMessageProcessor \u6ce8\u518c\u5230 NettyRemotingServer \u4e2d\uff0c\u5bf9\u5e94\u7684\u8bf7\u6c42 ID \u4e3a ",(0,l.jsx)(n.code,{children:"SEND_MESSAGE = 10"}),"\uff0cNettyServerHandler \u5728\u5904\u7406\u8bf7\u6c42\u65f6\u901a\u8fc7 CMD \u4f1a\u83b7\u53d6\u5904\u7406\u5668\u6267\u884c processRequest"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u5904\u7406\u901a\u9053\u7684\u4e8b\u4ef6\uff1b   \u53c2\u6570\u4e8c\uff1a\u5ba2\u6237\u7aef\npublic RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request)  {\n    RemotingCommand response = null;\n   \tresponse = asyncProcessRequest(ctx, request).get();\n    return response;\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"SendMessageProcessor#asyncConsumerSendMsgBack\uff1a\u5f02\u6b65\u53d1\u9001\u6d88\u8d39\u8005\u7684\u56de\u8c03\u6d88\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final RemotingCommand response"}),"\uff1a\u521b\u5efa\u4e00\u4e2a\u670d\u52a1\u5668\u54cd\u5e94\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final ConsumerSendMsgBackRequestHeader requestHeader"}),"\uff1a\u89e3\u6790\u51fa\u5ba2\u6237\u7aef\u8bf7\u6c42\u5934\u4fe1\u606f\uff0c\u51e0\u4e2a",(0,l.jsx)(n.strong,{children:"\u6838\u5fc3\u5b57\u6bb5"}),"\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private Long offset"}),"\uff1a\u56de\u9000\u6d88\u606f\u7684 CommitLog offset"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private Integer delayLevel"}),"\uff1a\u5ef6\u8fdf\u7ea7\u522b\uff0c\u4e00\u822c\u662f 0"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private String originMsgId, originTopic"}),"\uff1a\u539f\u59cb\u7684\u6d88\u606f ID\uff0c\u4e3b\u9898"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private Integer maxReconsumeTimes"}),"\uff1a\u6700\u5927\u91cd\u8bd5\u6b21\u6570\uff0c\u9ed8\u8ba4\u662f 16 \u6b21"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if ()"}),"\uff1a\u9274\u6743\uff0c\u662f\u5426\u627e\u5230\u8ba2\u9605\u7ec4\u914d\u7f6e\u3001Broker \u662f\u5426\u652f\u6301\u5199\u8bf7\u6c42\u3001\u8ba2\u9605\u7ec4\u662f\u5426\u652f\u6301\u6d88\u606f\u91cd\u8bd5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"String newTopic = MixAll.getRetryTopic(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u6d88\u8d39\u8005\u7ec4\u7684\u91cd\u8bd5\u4e3b\u9898"}),"\uff0c\u89c4\u5219\u662f ",(0,l.jsx)(n.code,{children:"%RETRY%GroupName"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int queueIdInt = Math.abs()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u91cd\u8bd5\u4e3b\u9898\u4e0b\u7684\u961f\u5217 ID \u662f 0"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"TopicConfig topicConfig"}),"\uff1a\u83b7\u53d6\u91cd\u8bd5\u4e3b\u9898\u7684\u914d\u7f6e\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageExt msgExt"}),"\uff1a\u6839\u636e\u6d88\u606f\u7684\u7269\u7406 offset \u5230\u5b58\u50a8\u6a21\u5757\u67e5\u8be2\uff0c\u5185\u90e8\u5148\u67e5\u8be2\u51fa\u8fd9\u6761\u6d88\u606f\u7684 size\uff0c\u7136\u540e\u518d\u6839\u636e offset \u548c size \u67e5\u8be2\u51fa\u6574\u6761 msg"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final String retryTopic"}),"\uff1a\u83b7\u53d6\u6d88\u606f\u7684\u539f\u59cb\u4e3b\u9898"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == retryTopic)"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e",(0,l.jsx)(n.strong,{children:"\u5f53\u524d\u6d88\u606f\u662f\u7b2c\u4e00\u6b21\u88ab\u56de\u9000"}),"\uff0c \u6dfb\u52a0 ",(0,l.jsx)(n.code,{children:"RETRY_TOPIC"})," \u5c5e\u6027"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"msgExt.setWaitStoreMsgOK(false)"}),"\uff1a\u5f02\u6b65\u5237\u76d8"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (msgExt...() >= maxReconsumeTimes || delayLevel < 0)"}),"\uff1a\u6d88\u606f\u91cd\u8bd5\u6b21\u6570\u8d85\u8fc7\u6700\u5927\u6b21\u6570\uff0c\u4e0d\u652f\u6301\u91cd\u8bd5"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"newTopic = MixAll.getDLQTopic()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u6d88\u8d39\u8005\u7684\u6b7b\u4fe1\u961f\u5217"}),"\uff0c\u89c4\u5219\u662f ",(0,l.jsx)(n.code,{children:"%DLQ%GroupName"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"queueIdInt, topicConfig"}),"\uff1a\u6b7b\u4fe1\u961f\u5217 ID \u4e3a 0\uff0c\u521b\u5efa\u6b7b\u4fe1\u961f\u5217\u7684\u914d\u7f6e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (0 == delayLevel)"}),"\uff1a\u8bf4\u660e\u5ef6\u8fdf\u7ea7\u522b\u7531 Broker \u63a7\u5236"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"delayLevel = 3 + msgExt.getReconsumeTimes()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5ef6\u8fdf\u7ea7\u522b\u9ed8\u8ba4\u4ece 3 \u7ea7\u5f00\u59cb"}),"\uff0c\u6bcf\u91cd\u8bd5\u4e00\u6b21\uff0c\u5ef6\u8fdf\u7ea7\u522b +1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"msgExt.setDelayTimeLevel(delayLevel)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u5ef6\u8fdf\u7ea7\u522b\u8bbe\u7f6e\u8fdb\u6d88\u606f\u5c5e\u6027"}),"\uff0c\u5b58\u50a8\u65f6\u4f1a\u68c0\u67e5\u8be5\u5c5e\u6027\uff0c\u8be5\u5c5e\u6027\u503c > 0 \u4f1a",(0,l.jsx)(n.strong,{children:"\u5c06\u6d88\u606f\u7684\u4e3b\u9898\u548c\u961f\u5217\u4fee\u6539\u4e3a\u8c03\u5ea6\u4e3b\u9898\u548c\u8c03\u5ea6\u961f\u5217 ID"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageExtBrokerInner msgInner"}),"\uff1a\u521b\u5efa\u4e00\u6761\u7a7a\u6d88\u606f\uff0c\u6d88\u606f\u5c5e\u6027\u4ece offset \u67e5\u8be2\u51fa\u6765\u7684 msg \u4e2d\u62f7\u8d1d"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"msgInner.setReconsumeTimes)"}),"\uff1a\u91cd\u8bd5\u6b21\u6570\u8bbe\u7f6e\u4e3a\u539f msg \u7684\u6b21\u6570 +1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"UtilAll.isBlank(originMsgId)"}),"\uff1a\u5224\u65ad\u6d88\u606f\u662f\u5426\u662f\u521d\u6b21\u8fd4\u56de\u5230\u670d\u52a1\u5668"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"true\uff1a\u8bf4\u660e msgExt \u6d88\u606f\u662f\u7b2c\u4e00\u6b21\u88ab\u8fd4\u56de\u5230\u670d\u52a1\u5668\uff0c\u6b64\u65f6\u4f7f\u7528\u8be5 msg \u7684 id \u4f5c\u4e3a originMessageId"}),"\n",(0,l.jsx)(n.li,{children:"false\uff1a\u8bf4\u660e\u539f\u59cb\u6d88\u606f\u5df2\u7ecf\u88ab\u91cd\u8bd5\u4e0d\u6b62 1 \u6b21\uff0c\u6b64\u65f6\u4f7f\u7528 offset \u67e5\u8be2\u51fa\u6765\u7684 msg \u4e2d\u7684 originMessageId"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"CompletableFuture putMessageResult = ..asyncPutMessage(msgInner)"}),"\uff1a\u8c03\u7528\u5b58\u50a8\u6a21\u5757\u5b58\u50a8\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore#asyncPutMessage"}),"\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"PutMessageResult result = this.commitLog.asyncPutMessage(msg)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u65b0\u6d88\u606f\u5b58\u50a8\u5230 CommitLog \u4e2d"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u8c03\u5ea6\u670d\u52a1",children:"\u8c03\u5ea6\u670d\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"DefaultMessageStore \u4e2d\u6709\u6210\u5458\u5c5e\u6027 ScheduleMessageService\uff0c\u5728 start \u65b9\u6cd5\u4e2d\u4f1a\u542f\u52a8\u8be5\u8c03\u5ea6\u670d\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5ef6\u8fdf\u7ea7\u522b\u5c5e\u6027\u8868\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u5b58\u50a8\u5ef6\u8fdf\u7ea7\u522b\u5bf9\u5e94\u7684 \u5ef6\u8fdf\u65f6\u95f4\u957f\u5ea6 \uff08\u5355\u4f4d\uff1a\u6beb\u79d2\uff09\nprivate final ConcurrentMap<Integer /* level */, Long/* delay timeMillis */> delayLevelTable;\n// \u5b58\u50a8\u5ef6\u8fdf\u7ea7\u522b queue \u7684\u6d88\u8d39\u8fdb\u5ea6 offset\uff0c\u8be5 table \u6bcf 10 \u79d2\u949f\uff0c\u4f1a\u6301\u4e45\u5316\u4e00\u6b21\uff0c\u6301\u4e45\u5316\u5230\u672c\u5730\u78c1\u76d8\nprivate final ConcurrentMap<Integer /* level */, Long/* offset */> offsetTable;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6700\u5927\u5ef6\u8fdf\u7ea7\u522b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private int maxDelayLevel;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6a21\u5757\u542f\u52a8\u72b6\u6001\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final AtomicBoolean started = new AtomicBoolean(false);\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9a\u65f6\u5668\uff1a\u5185\u90e8\u6709\u7ebf\u7a0b\u8d44\u6e90\uff0c\u53ef\u6267\u884c\u8c03\u5ea6\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private Timer timer;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["load()\uff1a\u52a0\u8f7d\u8c03\u5ea6\u6d88\u606f\uff0c",(0,l.jsx)(n.strong,{children:"\u521d\u59cb\u5316 delayLevelTable \u548c offsetTable"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean load()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u6d88\u606f\u8c03\u5ea6\u670d\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (started.compareAndSet(false, true))"}),"\uff1a\u5c06\u542f\u52a8\u72b6\u6001\u8bbe\u4e3a true"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.timer"}),"\uff1a\u521b\u5efa\u5b9a\u65f6\u5668\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (... : this.delayLevelTable.entrySet())"}),"\uff1a\u4e3a",(0,l.jsx)(n.strong,{children:"\u6bcf\u4e2a\u5ef6\u8fdf\u7ea7\u522b\u521b\u5efa\u4e00\u4e2a\u5ef6\u8fdf\u4efb\u52a1"}),"\u63d0\u4ea4\u5230 timer \uff0c\u5468\u671f\u6267\u884c\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5",(0,l.jsx)(n.strong,{children:"\u5c06\u5ef6\u8fdf\u6d88\u606f\u5f97\u5230\u53ca\u65f6\u7684\u6d88\u8d39"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.timer.scheduleAtFixedRate()"}),"\uff1a\u63d0\u4ea4\u5468\u671f\u578b\u4efb\u52a1\uff0c\u5ef6\u8fdf 10 \u79d2\u6267\u884c\uff0c\u5468\u671f\u4e3a 10 \u79d2\uff0c\u6301\u4e45\u5316\u5ef6\u8fdf\u961f\u5217\u6d88\u8d39\u8fdb\u5ea6\u4efb\u52a1"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ScheduleMessageService.this.persist()"}),"\uff1a\u6301\u4e45\u5316\u6d88\u8d39\u8fdb\u5ea6"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u8c03\u5ea6\u4efb\u52a1",children:"\u8c03\u5ea6\u4efb\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"DeliverDelayedMessageTimerTask \u662f\u4e00\u4e2a\u4efb\u52a1\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5ef6\u8fdf\u7ea7\u522b\uff1a\u5ef6\u8fdf\u961f\u5217\u4efb\u52a1\u5904\u7406\u7684\u5ef6\u8fdf\u7ea7\u522b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final int delayLevel;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8fdb\u5ea6\uff1a\u5ef6\u8fdf\u961f\u5217\u4efb\u52a1\u5904\u7406\u7684\u5ef6\u8fdf\u961f\u5217\u7684\u6d88\u8d39\u8fdb\u5ea6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final long offset;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u6267\u884c\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run() {\n    if (isStarted()) {\n        this.executeOnTimeup();\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"executeOnTimeup()\uff1a\u6267\u884c\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void executeOnTimeup()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ConsumeQueue cq"}),"\uff1a\u83b7\u53d6\u51fa\u8be5\u5ef6\u8fdf\u961f\u5217\u4efb\u52a1\u5904\u7406\u7684",(0,l.jsx)(n.strong,{children:"\u5ef6\u8fdf\u961f\u5217 ConsumeQueue"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"SelectMappedBufferResult bufferCQ"}),"\uff1a\u6839\u636e\u6d88\u8d39\u8fdb\u5ea6\u67e5\u8be2\u51fa SMBR \u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (; i < bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE)"}),"\uff1a\u6bcf\u6b21\u8bfb\u53d6 20 \u5404\u5b57\u8282\u7684\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"offsetPy, sizePy"}),"\uff1a\u5ef6\u8fdf\u6d88\u606f\u7684\u7269\u7406\u504f\u79fb\u91cf\u548c\u6d88\u606f\u5927\u5c0f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long tagsCode"}),"\uff1a\u5ef6\u8fdf\u6d88\u606f\u7684\u4ea4\u4ed8\u65f6\u95f4\uff0c\u5728 ReputMessageService \u8f6c\u53d1\u65f6\u6839\u636e\u6d88\u606f\u7684 DELAY \u5c5e\u6027\u662f\u5426 >0 \uff0c\u4f1a\u5728 tagsCode \u5b57\u6bb5\u5b58\u50a8\u4ea4\u4ed8\u65f6\u95f4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long deliver... = this.correctDeliverTimestamp(..)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6821\u51c6\u4ea4\u4ed8\u65f6\u95f4"}),"\uff0c\u5ef6\u8fdf\u65f6\u95f4\u8fc7\u957f\u4f1a\u8c03\u6574\u4e3a\u5f53\u524d\u65f6\u95f4\u7acb\u523b\u6267\u884c"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long countdown = deliverTimestamp - now"}),"\uff1a\u8ba1\u7b97\u5dee\u503c"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (countdown <= 0)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u5df2\u7ecf\u5230\u8fbe\u4ea4\u4ed8\u65f6\u95f4\u4e86"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageExt msgExt"}),"\uff1a\u6839\u636e\u7269\u7406\u504f\u79fb\u91cf\u548c\u6d88\u606f\u5927\u5c0f\u83b7\u53d6\u8fd9\u6761\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageExtBrokerInner msgInner"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6784\u5efa\u4e00\u6761\u65b0\u6d88\u606f"}),"\uff0c\u5c06\u539f\u6d88\u606f\u7684\u5c5e\u6027\u62f7\u8d1d\u8fc7\u6765"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long tagsCodeValue"}),"\uff1a\u4e0d\u518d\u662f\u4ea4\u4ed8\u65f6\u95f4\u4e86"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"MessageAccessor.clearProperty(msgInner, DELAY..)"}),"\uff1a\u6e05\u7406\u65b0\u6d88\u606f\u7684 DELAY \u5c5e\u6027\uff0c\u907f\u514d\u5b58\u50a8\u65f6\u91cd\u5b9a\u5411\u5230\u5ef6\u8fdf\u961f\u5217"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msgInner.setTopic()"}),"\uff1a",(0,l.jsxs)(n.strong,{children:["\u4fee\u6539\u4e3b\u9898\u4e3a\u539f\u59cb\u7684\u4e3b\u9898 ",(0,l.jsx)(n.code,{children:"%RETRY%GroupName"})]})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String queueIdStr"}),"\uff1a\u4fee\u6539\u961f\u5217 ID \u4e3a\u539f\u59cb\u7684 ID"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"PutMessageResult putMessageResult"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u65b0\u6d88\u606f\u5b58\u50a8\u5230 CommitLog"}),"\uff0c\u6d88\u8d39\u8005\u8ba2\u9605\u7684\u662f\u76ee\u6807\u4e3b\u9898\uff0c\u4f1a\u518d\u6b21\u6d88\u8d39\u8be5\u6d88\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u6d88\u606f\u8fd8\u672a\u5230\u8fbe\u4ea4\u4ed8\u65f6\u95f4"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ScheduleMessageService.this.timer.schedule()"}),"\uff1a\u521b\u5efa\u8be5\u5ef6\u8fdf\u7ea7\u522b\u7684\u4efb\u52a1\uff0c\u5ef6\u8fdf countDown \u6beb\u79d2\u4e4b\u540e\u518d\u6267\u884c"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ScheduleMessageService.this.updateOffset()"}),"\uff1a\u66f4\u65b0\u5ef6\u8fdf\u7ea7\u522b\u961f\u5217\u7684\u6d88\u8d39\u8fdb\u5ea6"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:"PutMessageResult putMessageResult"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"bufferCQ == null"}),"\uff1a\u8bf4\u660e\u901a\u8fc7\u6d88\u8d39\u8fdb\u5ea6\u6ca1\u6709\u83b7\u53d6\u5230\u6570\u636e"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (offset < cqMinOffset)"}),"\uff1a\u5982\u679c\u6d88\u8d39\u8fdb\u5ea6\u6bd4\u6700\u5c0f\u4f4d\u70b9\u90fd\u5c0f\uff0c\u8bf4\u660e\u662f\u8fc7\u671f\u6570\u636e\uff0c\u91cd\u7f6e\u4e3a\u6700\u5c0f\u4f4d\u70b9"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ScheduleMessageService.this.timer.schedule()"}),"\uff1a\u91cd\u65b0\u63d0\u4ea4\u8be5\u5ef6\u8fdf\u7ea7\u522b\u5bf9\u5e94\u7684\u5ef6\u8fdf\u961f\u5217\u4efb\u52a1\uff0c\u5ef6\u8fdf 100 \u6beb\u79d2\u540e\u6267\u884c"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4e8b\u52a1\u6d88\u606f-1",children:"\u4e8b\u52a1\u6d88\u606f"}),"\n",(0,l.jsx)(n.h5,{id:"\u751f\u4ea7\u8005\u7c7b-2",children:"\u751f\u4ea7\u8005\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"TransactionMQProducer \u7c7b\u53d1\u9001\u4e8b\u52a1\u6d88\u606f\u65f6\u4f7f\u7528"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e8b\u52a1\u56de\u67e5\u7ebf\u7a0b\u6c60\u8d44\u6e90\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private ExecutorService executorService;\n\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e8b\u52a1\u76d1\u542c\u5668\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private TransactionListener transactionListener;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.defaultMQProducerImpl.initTransactionEnv()"}),"\uff1a\u521d\u59cb\u5316\u751f\u4ea7\u8005\u5b9e\u4f8b\u548c\u56de\u67e5\u7ebf\u7a0b\u6c60\u8d44\u6e90"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"super.start()"}),"\uff1a\u542f\u52a8\u751f\u4ea7\u8005\u5b9e\u4f8b"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"sendMessageInTransaction()\uff1a\u53d1\u9001\u4e8b\u52a1\u6d88\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public TransactionSendResult sendMessageInTransaction(final Message msg, final Object arg) {\n    msg.setTopic(NamespaceUtil.wrapNamespace(this.getNamespace(), msg.getTopic()));\n    // \u8c03\u7528\u5b9e\u73b0\u7c7b\u7684\u53d1\u9001\u65b9\u6cd5\n    return this.defaultMQProducerImpl.sendMessageInTransaction(msg, null, arg);\n}\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"TransactionListener transactionListener = getCheckListener()"}),"\uff1a\u83b7\u53d6\u76d1\u542c\u5668"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == localTransactionExecuter && null == transactionListener)"}),"\uff1a\u4e24\u8005\u90fd\u4e3a null \u629b\u51fa\u5f02\u5e38"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:'MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, "true")'}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8bbe\u7f6e\u4e8b\u52a1\u6807\u5fd7"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"sendResult = this.send(msg)"}),"\uff1a\u53d1\u9001\u6d88\u606f\uff0c\u540c\u6b65\u53d1\u9001"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (sendResult.getSendStatus())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5224\u65ad\u53d1\u9001\u6d88\u606f\u7684\u7ed3\u679c\u72b6\u6001"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case SEND_OK"}),"\uff1a\u6d88\u606f\u53d1\u9001\u6210\u529f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"msg.setTransactionId(transactionId)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8bbe\u7f6e\u4e8b\u52a1 ID \u4e3a\u6d88\u606f\u7684 UNIQ_KEY \u5c5e\u6027"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"localTransactionState = ...executeLocalTransactionBranch(msg, arg)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6267\u884c\u672c\u5730\u4e8b\u52a1"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case SLAVE_NOT_AVAILABLE"}),"\uff1a\u5176\u4ed6\u60c5\u51b5\u90fd\u9700\u8981\u56de\u6eda\u4e8b\u52a1"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e8b\u52a1\u72b6\u6001\u8bbe\u7f6e\u4e3a\u56de\u6eda"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.endTransaction(sendResult, ...)"}),"\uff1a\u7ed3\u675f\u4e8b\u52a1"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"EndTransactionRequestHeader requestHeader"}),"\uff1a\u6784\u5efa\u4e8b\u52a1\u7ed3\u675f\u5934\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway()"}),"\uff1a\u5411 Broker \u53d1\u8d77\u4e8b\u52a1\u7ed3\u675f\u7684\u5355\u5411\u8bf7\u6c42"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u63a5\u53d7\u6d88\u606f",children:"\u63a5\u53d7\u6d88\u606f"}),"\n",(0,l.jsxs)(n.p,{children:["SendMessageProcessor \u662f\u670d\u52a1\u7aef\u5904\u7406\u5ba2\u6237\u7aef\u53d1\u9001\u6765\u7684\u6d88\u606f\u7684\u5904\u7406\u5668\uff0c",(0,l.jsx)(n.code,{children:"processRequest()"})," \u65b9\u6cd5\u5904\u7406\u8bf7\u6c42"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"asyncProcessRequest()"}),"\uff1a\u5904\u7406\u8bf7\u6c42"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public CompletableFuture<RemotingCommand> asyncProcessRequest(ChannelHandlerContext ctx,\n                                                              RemotingCommand request) {\n    final SendMessageContext mqtraceContext;\n    switch (request.getCode()) {\n            // \u56de\u8c03\u6d88\u606f\u56de\u9000\n        case RequestCode.CONSUMER_SEND_MSG_BACK:\n            return this.asyncConsumerSendMsgBack(ctx, request);\n        default:\n            // \u89e3\u6790\u51fa\u8bf7\u6c42\u5934\u5bf9\u8c61\n            SendMessageRequestHeader requestHeader = parseRequestHeader(request);\n            if (requestHeader == null) {\n                return CompletableFuture.completedFuture(null);\n            }\n            // \u521b\u5efa\u4e0a\u4e0b\u6587\u5bf9\u8c61\n            mqtraceContext = buildMsgContext(ctx, requestHeader);\n            // \u524d\u7f6e\u5904\u7406\u5668\n            this.executeSendMessageHookBefore(ctx, request, mqtraceContext);\n            // \u5224\u65ad\u662f\u5426\u662f\u6279\u91cf\u6d88\u606f\n            if (requestHeader.isBatch()) {\n                return this.asyncSendBatchMessage(ctx, request, mqtraceContext, requestHeader);\n            } else {\n                return this.asyncSendMessage(ctx, request, mqtraceContext, requestHeader);\n            }\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"asyncSendMessage()\uff1a\u5f02\u6b65\u5904\u7406\u53d1\u9001\u6d88\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private CompletableFuture<RemotingCommand> asyncSendMessage(ChannelHandlerContext ctx, RemotingCommand request, SendMessageContext mqtraceContext, SendMessageRequestHeader requestHeader)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"RemotingCommand response"}),"\uff1a\u521b\u5efa\u54cd\u5e94\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageExtBrokerInner msgInner = new MessageExtBrokerInner()"}),"\uff1a\u521b\u5efa msgInner \u5bf9\u8c61\uff0c\u5e76\u8d4b\u503c\u76f8\u5173\u7684\u5c5e\u6027\uff0c\u4e3b\u9898\u548c\u961f\u5217 ID \u90fd\u662f\u8bf7\u6c42\u5934\u4e2d\u7684"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"String transFlag"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u4e8b\u52a1\u5c5e\u6027"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (transFlag != null && Boolean.parseBoolean(transFlag))"}),"\uff1a\u5224\u65ad\u4e8b\u52a1\u5c5e\u6027\u662f\u5426\u662f true\uff0c\u8d70\u4e8b\u52a1\u6d88\u606f\u7684\u5b58\u50a8\u6d41\u7a0b"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"putMessageResult = ...asyncPrepareMessage(msgInner)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e8b\u52a1\u6d88\u606f\u5904\u7406\u6d41\u7a0b"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public CompletableFuture<PutMessageResult> asyncPutHalfMessage(MessageExtBrokerInner messageInner) {\n    // \u8c03\u7528\u5b58\u50a8\u6a21\u5757\uff0c\u5c06\u4fee\u6539\u540e\u7684 msg \u5b58\u50a8\u8fdb Broker(CommitLog)\n    return store.asyncPutMessage(parseHalfMessageInner(messageInner));\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"TransactionalMessageBridge#parseHalfMessageInner\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"MessageAccessor.putProperty(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u6d88\u606f\u7684\u539f\u4e3b\u9898\u548c\u961f\u5217 ID \u653e\u5165\u6d88\u606f\u7684\u5c5e\u6027\u4e2d"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msgInner.setSysFlag(...)"}),"\uff1a\u6d88\u606f\u8bbe\u7f6e\u4e3a\u975e\u4e8b\u52a1\u72b6\u6001"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msgInner.setTopic(TransactionalMessageUtil.buildHalfTopic())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u4e3b\u9898\u8bbe\u7f6e\u4e3a\u534a\u6d88\u606f\u4e3b\u9898"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msgInner.setQueueId(0)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u961f\u5217 ID \u8bbe\u7f6e\u4e3a 0"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u666e\u901a\u6d88\u606f\u5b58\u50a8"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u56de\u67e5\u5904\u7406",children:"\u56de\u67e5\u5904\u7406"}),"\n",(0,l.jsxs)(n.p,{children:["ClientRemotingProcessor \u662f\u5ba2\u6237\u7aef\u7528\u4e8e\u5904\u7406\u8bf7\u6c42\uff0c\u521b\u5efa MQClientAPIImpl \u65f6\u5c06\u8be5\u5904\u7406\u5668\u6ce8\u518c\u5230 Netty \u4e2d\uff0c",(0,l.jsx)(n.code,{children:"processRequest()"})," \u65b9\u6cd5\u6839\u636e\u8bf7\u6c42\u7684\u547d\u4ee4\u7801\uff0c\u8fdb\u884c\u4e0d\u540c\u7684\u5904\u7406\uff0c\u4e8b\u52a1\u56de\u67e5\u7684\u5904\u7406\u547d\u4ee4\u7801\u4e3a ",(0,l.jsx)(n.code,{children:"CHECK_TRANSACTION_STATE"})]}),"\n",(0,l.jsx)(n.p,{children:"Broker \u7aef\u6709\u5b9a\u65f6\u4efb\u52a1\u53d1\u9001\u56de\u67e5\u8bf7\u6c42"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"checkTransactionState()\uff1a\u68c0\u67e5\u4e8b\u52a1\u72b6\u6001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public RemotingCommand checkTransactionState(ChannelHandlerContext ctx, RemotingCommand request)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final CheckTransactionStateRequestHeader requestHeader"}),"\uff1a\u89e3\u6790\u51fa\u8bf7\u6c42\u5934\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final MessageExt messageExt"}),"\uff1a\u4ece\u8bf7\u6c42 body \u4e2d\u89e3\u6790\u51fa\u670d\u52a1\u5668\u56de\u67e5\u7684\u4e8b\u52a1\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String transactionId"}),"\uff1a\u63d0\u53d6 UNIQ_KEY \u5b57\u6bb5\u5c5e\u6027\u503c\u8d4b\u503c\u7ed9\u4e8b\u52a1 ID"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final String group"}),"\uff1a\u63d0\u53d6\u751f\u4ea7\u8005\u7ec4\u540d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"MQProducerInner producer = this...selectProducer(group)"}),"\uff1a\u6839\u636e\u751f\u4ea7\u8005\u7ec4\u83b7\u53d6\u751f\u4ea7\u8005\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String addr = RemotingHelper.parseChannelRemoteAddr()"}),"\uff1a\u89e3\u6790\u51fa\u8981\u56de\u67e5\u7684 Broker \u670d\u52a1\u5668\u7684\u5730\u5740"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"producer.checkTransactionState(addr, messageExt, requestHeader)"}),"\uff1a\u751f\u4ea7\u8005\u7684\u4e8b\u52a1\u56de\u67e5\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Runnable request = new Runnable()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u521b\u5efa\u56de\u67e5\u4e8b\u52a1\u72b6\u6001\u4efb\u52a1\u5bf9\u8c61"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u83b7\u53d6\u751f\u4ea7\u8005\u7684 TransactionCheckListener \u548c TransactionListener\uff0c\u9009\u62e9\u4e00\u4e2a\u4e0d\u4e3a null \u7684\u76d1\u542c\u5668\u8fdb\u884c\u4e8b\u52a1\u72b6\u6001\u56de\u67e5"}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.processTransactionState()"}),"\uff1a\u5904\u7406\u56de\u67e5\u72b6\u6001\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"EndTransactionRequestHeader thisHeader"}),"\uff1a\u6784\u5efa EndTransactionRequestHeader \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"DefaultMQProducerImpl...endTransactionOneway()"}),"\uff1a\u5411 Broker \u53d1\u8d77\u7ed3\u675f\u4e8b\u52a1\u5355\u5411\u8bf7\u6c42\uff0c",(0,l.jsx)(n.strong,{children:"\u4e8c\u9636\u6bb5\u63d0\u4ea4"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.checkExecutor.submit(request)"}),"\uff1a\u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\u8fd0\u884c"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u56fe\uff1a",(0,l.jsx)(n.a,{href:"https://www.processon.com/view/link/61c8257e0e3e7474fb9dcbc0",children:"https://www.processon.com/view/link/61c8257e0e3e7474fb9dcbc0"})]}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,l.jsx)(n.a,{href:"https://space.bilibili.com/457326371",children:"https://space.bilibili.com/457326371"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u4e8b\u52a1\u63d0\u4ea4",children:"\u4e8b\u52a1\u63d0\u4ea4"}),"\n",(0,l.jsx)(n.p,{children:"EndTransactionProcessor \u7c7b\u662f\u670d\u52a1\u7aef\u7528\u6765\u5904\u7406\u5ba2\u6237\u7aef\u53d1\u6765\u7684\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u8bf7\u6c42"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"processRequest()\uff1a\u5904\u7406\u8bf7\u6c42"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"EndTransactionRequestHeader requestHeader"}),"\uff1a\u4ece\u8bf7\u6c42\u4e2d\u89e3\u6790\u51fa EndTransactionRequestHeader"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (MessageSysFlag.TRANSACTION_COMMIT_TYPE)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e8b\u52a1\u63d0\u4ea4"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"result = this.brokerController...commitMessage(requestHeader)"}),"\uff1a\u6839\u636e commitLogOffset \u63d0\u53d6\u51fa halfMsg \u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageExtBrokerInner msgInner"}),"\uff1a\u6839\u636e result \u514b\u9686\u51fa\u4e00\u6761\u65b0\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"msgInner.setTopic(msgExt.getUserProperty(...))"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8bbe\u7f6e\u56de\u539f\u4e3b\u9898"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"msgInner.setQueueId(Integer.parseInt(msgExt.getUserProperty(..)))"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8bbe\u7f6e\u56de\u539f\u961f\u5217 ID"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageAccessor.clearProperty()"}),"\uff1a\u6e05\u7406\u4e0a\u9762\u7684\u4e24\u4e2a\u5c5e\u6027"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageAccessor.clearProperty(msgInner, ...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6e05\u7406\u4e8b\u52a1\u5c5e\u6027"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"RemotingCommand sendResult = sendFinalMessage(msgInner)"}),"\uff1a\u8c03\u7528\u5b58\u50a8\u6a21\u5757\u5b58\u50a8\u81f3 Broker"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.brokerController...deletePrepareMessage(result.getPrepareMessage())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5411\u5220\u9664\uff08OP\uff09\u961f\u5217\u6dfb\u52a0\u6d88\u606f"}),"\uff0c\u6d88\u606f\u4f53\u7684\u6570\u636e\u662f halfMsg \u7684 queueOffset\uff0c",(0,l.jsx)(n.strong,{children:"\u8868\u793a\u534a\u6d88\u606f\u961f\u5217\u6307\u5b9a\u7684 offset \u7684\u6d88\u606f\u5df2\u88ab\u5220\u9664"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (this...putOpMessage(msgExt, TransactionalMessageUtil.REMOVETAG))"}),"\uff1a\u6dfb\u52a0\u4e00\u6761 OP \u6570\u636e\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"MessageQueue messageQueue"}),"\uff1a\u65b0\u5efa\u4e00\u4e2a\u6d88\u606f\u961f\u5217\uff0cOP \u961f\u5217"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"return addRemoveTagInTransactionOp(messageExt, messageQueue)"}),"\uff1a\u6dfb\u52a0\u6570\u636e\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Message message"}),"\uff1a\u521b\u5efa OP \u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"writeOp(message, messageQueue)"}),"\uff1a\u5199\u5165 OP \u6d88\u606f"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else if (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e8b\u52a1\u56de\u6eda"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.brokerController...deletePrepareMessage(result.getPrepareMessage())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e5f\u9700\u8981\u5411 OP \u961f\u5217\u6dfb\u52a0\u6d88\u606f"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"consumer",children:"Consumer"}),"\n",(0,l.jsx)(n.h4,{id:"\u6d88\u8d39\u8005\u7c7b",children:"\u6d88\u8d39\u8005\u7c7b"}),"\n",(0,l.jsx)(n.h5,{id:"\u9ed8\u8ba4\u6d88\u8d39",children:"\u9ed8\u8ba4\u6d88\u8d39"}),"\n",(0,l.jsx)(n.p,{children:"DefaultMQPushConsumer \u7c7b\u662f\u9ed8\u8ba4\u7684\u6d88\u8d39\u8005\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u5b9e\u73b0\u7c7b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final transient DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private String consumerGroup;\t\t\t\t\t\t\t\t\t// \u6d88\u8d39\u8005\u7ec4\nprivate MessageModel messageModel = MessageModel.CLUSTERING;\t// \u6d88\u8d39\u6a21\u5f0f\uff0c\u9ed8\u8ba4\u96c6\u7fa4\u6a21\u5f0f\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8ba2\u9605\u4fe1\u606f\uff1akey \u662f\u4e3b\u9898\uff0cvalue \u662f\u8fc7\u6ee4\u8868\u8fbe\u5f0f\uff0c\u4e00\u822c\u662f tag"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private Map<String, String > subscription = new HashMap<String, String>()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u6d88\u606f\u76d1\u542c\u5668\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u5904\u7406\u903b\u8f91"}),"\uff0c\u5e76\u53d1\u6d88\u8d39 MessageListenerConcurrently\uff0c\u987a\u5e8f\uff08\u5206\u533a\uff09\u6d88\u8d39 MessageListenerOrderly"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private MessageListener messageListener;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u4f4d\u70b9\uff1a\u5f53\u4ece Broker \u83b7\u53d6\u5f53\u524d\u7ec4\u5185\u8be5 queue \u7684 offset \u4e0d\u5b58\u5728\u65f6\uff0cconsumeFromWhere \u624d\u6709\u6548\uff0c\u9ed8\u8ba4\u503c\u4ee3\u8868\u4ece\u961f\u5217\u7684\u6700\u540e offset \u5f00\u59cb\u6d88\u8d39\uff0c\u5f53\u961f\u5217\u5185\u518d\u6709\u4e00\u6761\u65b0\u7684 msg \u52a0\u5165\u65f6\uff0c\u6d88\u8d39\u8005\u624d\u4f1a\u53bb\u6d88\u8d39"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private ConsumeFromWhere consumeFromWhere = ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u65f6\u95f4\u6233\uff1a\u5f53\u6d88\u8d39\u4f4d\u70b9\u914d\u7f6e\u7684\u662f CONSUME_FROM_TIMESTAMP \u65f6\uff0c\u5e76\u4e14\u670d\u52a1\u5668 Group \u5185\u4e0d\u5b58\u5728\u8be5 queue \u7684 offset \u65f6\uff0c\u4f1a\u4f7f\u7528\u8be5\u65f6\u95f4\u6233\u8fdb\u884c\u6d88\u8d39"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private String consumeTimestamp = UtilAll.timeMillisToHumanString3(System.currentTimeMillis() - (1000 * 60 * 30));// \u6d88\u8d39\u8005\u521b\u5efa\u65f6\u95f4 - 30\u79d2\uff0c\u8f6c\u6362\u6210 \u683c\u5f0f\uff1a \u5e74\u6708\u65e5\u5c0f\u65f6\u5206\u949f\u79d2\uff0c\u6bd4\u5982 20220203171201\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u961f\u5217\u5206\u914d\u7b56\u7565\uff1a\u4e3b\u9898\u4e0b\u7684\u961f\u5217\u5206\u914d\u7b56\u7565\uff0cRebalanceImpl \u5bf9\u8c61\u4f9d\u8d56\u8be5\u7b97\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private AllocateMessageQueueStrategy allocateMessageQueueStrategy;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8fdb\u5ea6\u5b58\u50a8\u5668\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private OffsetStore offsetStore;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u6d88\u8d39\u8005"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"shutdown()\uff1a\u5173\u95ed\u6d88\u8d39\u8005"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void shutdown()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"registerMessageListener()\uff1a\u6ce8\u518c\u6d88\u606f\u76d1\u542c\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void registerMessageListener(MessageListener messageListener) \n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["subscribe()\uff1a\u6dfb\u52a0\u8ba2\u9605\u4fe1\u606f\uff0c",(0,l.jsx)(n.strong,{children:"\u5c06\u8ba2\u9605\u4fe1\u606f\u653e\u5165\u8d1f\u8f7d\u5747\u8861\u5bf9\u8c61\u7684 subscriptionInner \u4e2d"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void subscribe(String topic, String subExpression)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"unsubscribe()\uff1a\u5220\u9664\u8ba2\u9605\u6307\u5b9a\u4e3b\u9898\u7684\u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void unsubscribe(String topic)\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"suspend()\uff1a\u505c\u6b62\u6d88\u8d39"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void suspend()\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"resume()\uff1a\u6062\u590d\u6d88\u8d39"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void resume()\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u9ed8\u8ba4\u5b9e\u73b0",children:"\u9ed8\u8ba4\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"DefaultMQPushConsumerImpl \u662f\u9ed8\u8ba4\u6d88\u8d39\u8005\u7684\u5b9e\u73b0\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u5b9e\u4f8b\uff1a\u6574\u4e2a\u8fdb\u7a0b\u5185\u53ea\u6709\u4e00\u4e2a\u5ba2\u6237\u7aef\u5b9e\u4f8b\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private MQClientInstance mQClientFactory;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u5b9e\u4f8b\uff1a\u95e8\u9762\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:" private final DefaultMQPushConsumer defaultMQPushConsumer;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u8d1f\u8f7d\u5747\u8861"}),"\uff1a\u5206\u914d\u8ba2\u9605\u4e3b\u9898\u7684\u961f\u5217\u7ed9\u5f53\u524d\u6d88\u8d39\u8005\uff0c20 \u79d2\u949f\u4e00\u4e2a\u5468\u671f\u6267\u884c Rebalance \u7b97\u6cd5\uff08\u5ba2\u6237\u7aef\u5b9e\u4f8b\u89e6\u53d1\uff09"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final RebalanceImpl rebalanceImpl = new RebalancePushImpl(this);\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u4fe1\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final long consumerStartTimestamp;\t// \u6d88\u8d39\u8005\u542f\u52a8\u65f6\u95f4\nprivate volatile ServiceState serviceState;\t// \u6d88\u8d39\u8005\u72b6\u6001\nprivate volatile boolean pause = false;\t\t// \u662f\u5426\u6682\u505c\nprivate boolean consumeOrderly = false;\t\t// \u662f\u5426\u987a\u5e8f\u6d88\u8d39\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u62c9\u53d6\u6d88\u606f"}),"\uff1a\u5c01\u88c5\u62c9\u6d88\u606f\u7684 API\uff0c\u670d\u52a1\u5668 Broker \u8fd4\u56de\u7ed3\u679c\u4e2d\u5305\u542b\u4e0b\u6b21 Pull \u65f6\u63a8\u8350\u7684 BrokerId\uff0c\u6839\u636e\u672c\u6b21\u8bf7\u6c42\u6570\u636e\u7684\u51b7\u70ed\u7a0b\u5ea6\u8fdb\u884c\u63a8\u8350"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private PullAPIWrapper pullAPIWrapper;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u6d88\u8d39"}),"\u670d\u52a1\uff1a\u5e76\u53d1\u6d88\u8d39\u548c\u987a\u5e8f\u6d88\u8d39"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private ConsumeMessageService consumeMessageService;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d41\u63a7\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private long queueFlowControlTimes = 0;\t\t\t// \u961f\u5217\u6d41\u63a7\u6b21\u6570\uff0c\u9ed8\u8ba4\u6bcf1000\u6b21\u6d41\u63a7\uff0c\u8fdb\u884c\u4e00\u6b21\u65e5\u5fd7\u6253\u5370\nprivate long queueMaxSpanFlowControlTimes = 0;\t// \u6d41\u63a7\u4f7f\u7528\uff0c\u63a7\u5236\u6253\u5370\u65e5\u5fd7\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"HOOK\uff1a\u94a9\u5b50\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u8fc7\u6ee4\u6d88\u606f hook\nprivate final ArrayList<FilterMessageHook> filterMessageHookList;\n// \u6d88\u606f\u6267\u884chook\uff0c\u5728\u6d88\u606f\u5904\u7406\u524d\u548c\u5904\u7406\u540e\u5206\u522b\u6267\u884c hook.before  hook.after \u7cfb\u5217\u65b9\u6cd5\nprivate final ArrayList<ConsumeMessageHook> consumeMessageHookList;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u52a0\u9501\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public synchronized void start() \n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.checkConfig()"}),"\uff1a\u68c0\u67e5\u914d\u7f6e\uff0c\u5305\u62ec\u7ec4\u540d\u3001\u6d88\u8d39\u6a21\u5f0f\u3001\u8ba2\u9605\u4fe1\u606f\u3001\u6d88\u606f\u76d1\u542c\u5668\u7b49"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.copySubscription()"}),"\uff1a\u62f7\u8d1d\u8ba2\u9605\u4fe1\u606f\u5230 RebalanceImpl \u5bf9\u8c61\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData)"}),"\uff1a\u5c06\u8ba2\u9605\u4fe1\u606f\u52a0\u5165 rbl \u7684 map \u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.messageListenerInner = ...getMessageListener()"}),"\uff1a\u5c06\u6d88\u606f\u76d1\u542c\u5668\u4fdd\u5b58\u5230\u5b9e\u4f8b\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"switch (this.defaultMQPushConsumer.getMessageModel())"}),"\uff1a\u5224\u65ad\u6d88\u8d39\u6a21\u5f0f\uff0c\u5e7f\u64ad\u6a21\u5f0f\u4e0b\u76f4\u63a5\u8fd4\u56de"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final String retryTopic"}),"\uff1a\u521b\u5efa\u5f53\u524d",(0,l.jsx)(n.strong,{children:"\u6d88\u8d39\u8005\u7ec4\u91cd\u8bd5\u7684\u4e3b\u9898\u540d"}),"\uff0c\u89c4\u5219 ",(0,l.jsx)(n.code,{children:"%RETRY%ConsumerGroup"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData()"}),"\uff1a\u521b\u5efa\u91cd\u8bd5\u4e3b\u9898\u7684\u8ba2\u9605\u6570\u636e\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.rebalanceImpl.getSubscriptionInner().put(retryTopic, subscriptionData)"}),"\uff1a\u5c06\u521b\u5efa\u7684\u91cd\u8bd5\u4e3b\u9898\u52a0\u5165\u5230 rbl \u5bf9\u8c61\u7684 map \u4e2d\uff0c",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u91cd\u8bd5\u65f6\u4f1a\u52a0\u5165\u5230\u8be5\u4e3b\u9898\uff0c\u6d88\u8d39\u8005\u8ba2\u9605\u8fd9\u4e2a\u4e3b\u9898\u4e4b\u540e\uff0c\u5c31\u6709\u673a\u4f1a\u518d\u6b21\u62ff\u5230\u8be5\u6d88\u606f\u8fdb\u884c\u6d88\u8d39\u5904\u7406"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory = ...getOrCreateMQClientInstance()"}),"\uff1a\u83b7\u53d6\u5ba2\u6237\u7aef\u5b9e\u4f8b\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.rebalanceImpl."}),"\uff1a\u521d\u59cb\u5316\u8d1f\u8f7d\u5747\u8861\u5bf9\u8c61\uff0c\u8bbe\u7f6e",(0,l.jsx)(n.strong,{children:"\u961f\u5217\u5206\u914d\u7b56\u7565\u5bf9\u8c61"}),"\u5230\u5c5e\u6027\u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.pullAPIWrapper = new PullAPIWrapper()"}),"\uff1a\u521b\u5efa\u62c9\u6d88\u606f API \u5bf9\u8c61\uff0c\u5185\u90e8\u5c01\u88c5\u4e86\u67e5\u8be2\u63a8\u8350\u4e3b\u673a\u7b97\u6cd5"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList)"}),"\uff1a\u5c06\u8fc7\u6ee4 Hook \u5217\u8868\u6ce8\u518c\u5230\u8be5\u5bf9\u8c61\u5185\uff0c\u6d88\u606f\u62c9\u53d6\u4e0b\u6765\u4e4b\u540e\u4f1a\u6267\u884c\u8be5 Hook\uff0c",(0,l.jsx)(n.strong,{children:"\u518d\u8fdb\u884c\u4e00\u6b21\u81ea\u5b9a\u4e49\u7684\u6d88\u606f\u8fc7\u6ee4"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.offsetStore = new RemoteBrokerOffsetStore()"}),"\uff1a\u9ed8\u8ba4\u96c6\u7fa4\u6a21\u5f0f\u4e0b\u521b\u5efa\u6d88\u606f\u8fdb\u5ea6\u5b58\u50a8\u5668"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.consumeMessageService = ..."}),"\uff1a\u6839\u636e\u6d88\u606f\u76d1\u542c\u5668\u7684\u7c7b\u578b\u521b\u5efa\u6d88\u8d39\u670d\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.consumeMessageService.start()"}),"\uff1a\u542f\u52a8\u6d88\u8d39\u670d\u52a1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean registerOK = mQClientFactory.registerConsumer()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u6d88\u8d39\u8005\u6ce8\u518c\u5230\u5ba2\u6237\u7aef\u5b9e\u4f8b\u4e2d"}),"\uff0c\u5ba2\u6237\u7aef\u63d0\u4f9b\u7684\u670d\u52a1\uff1a\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5fc3\u8df3\u670d\u52a1\uff1a\u628a\u8ba2\u9605\u6570\u636e\u540c\u6b65\u5230\u8ba2\u9605\u4e3b\u9898\u7684 Broker"}),"\n",(0,l.jsx)(n.li,{children:"\u62c9\u6d88\u606f\u670d\u52a1\uff1a\u5185\u90e8 PullMessageService \u542f\u52a8\u7ebf\u7a0b\uff0c\u57fa\u4e8e PullRequestQueue \u5de5\u4f5c\uff0c\u6d88\u8d39\u8005\u8d1f\u8f7d\u5747\u8861\u5206\u914d\u5230\u961f\u5217\u540e\u4f1a\u5411\u8be5\u961f\u5217\u63d0\u4ea4 PullRequest"}),"\n",(0,l.jsxs)(n.li,{children:["\u961f\u5217\u8d1f\u8f7d\u670d\u52a1\uff1a\u6bcf 20 \u79d2\u8c03\u7528\u4e00\u6b21 ",(0,l.jsx)(n.code,{children:"consumer.doRebalance()"})," \u63a5\u53e3"]}),"\n",(0,l.jsx)(n.li,{children:"\u6d88\u606f\u8fdb\u5ea6\u6301\u4e45\u5316"}),"\n",(0,l.jsx)(n.li,{children:"\u52a8\u6001\u8c03\u6574\u6d88\u8d39\u8005\u3001\u6d88\u8d39\u670d\u52a1\u7ebf\u7a0b\u6c60"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mQClientFactory.start()"}),"\uff1a\u542f\u52a8\u5ba2\u6237\u7aef\u5b9e\u4f8b"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:" this.updateTopic"}),"\uff1a\u4ece nameserver \u83b7\u53d6\u4e3b\u9898\u8def\u7531\u6570\u636e\uff0c\u751f\u6210\u4e3b\u9898\u96c6\u5408\u653e\u5165 rbl \u5bf9\u8c61\u7684 table"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory.checkClientInBroker()"}),"\uff1a\u68c0\u67e5\u670d\u52a1\u5668\u662f\u5426\u652f\u6301\u6d88\u606f\u8fc7\u6ee4\u6a21\u5f0f\uff0c\u4e00\u822c\u4f7f\u7528 tag \u8fc7\u6ee4\uff0c\u670d\u52a1\u5668\u9ed8\u8ba4\u652f\u6301"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()"}),"\uff1a\u5411\u6240\u6709\u5df2\u77e5\u7684 Broker \u8282\u70b9\uff0c",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u5fc3\u8df3\u6570\u636e"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.mQClientFactory.rebalanceImmediately()"}),"\uff1a\u5524\u9192 rbl \u7ebf\u7a0b\uff0c\u89e6\u53d1\u8d1f\u8f7d\u5747\u8861\u6267\u884c"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u8d1f\u8f7d\u5747\u8861-1",children:"\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsx)(n.h5,{id:"\u5b9e\u73b0\u65b9\u5f0f",children:"\u5b9e\u73b0\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"MQClientInstance#start \u4e2d\u4f1a\u542f\u52a8\u8d1f\u8f7d\u5747\u8861\u670d\u52a1 RebalanceService\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run() {\n\t// \u68c0\u67e5\u505c\u6b62\u6807\u8bb0\n    while (!this.isStopped()) {\n        // \u4f11\u7720 20 \u79d2\uff0c\u9632\u6b62\u5176\u4ed6\u7ebf\u7a0b\u9965\u997f\uff0c\u6240\u4ee5\u3010\u6bcf 20 \u79d2\u8d1f\u8f7d\u5747\u8861\u4e00\u6b21\u3011\n        this.waitForRunning(waitInterval);\n        // \u8c03\u7528\u5ba2\u6237\u7aef\u5b9e\u4f8b\u7684\u8d1f\u8f7d\u5747\u8861\u65b9\u6cd5\uff0c\u5e95\u5c42\u3010\u4f1a\u904d\u5386\u6240\u6709\u6d88\u8d39\u8005\uff0c\u8c03\u7528\u6d88\u8d39\u8005\u7684\u8d1f\u8f7d\u5747\u8861\u3011\n        this.mqClientFactory.doRebalance();\n    }\t\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"RebalanceImpl \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5206\u914d\u7ed9\u5f53\u524d\u6d88\u8d39\u8005\u7684\u5904\u7406\u961f\u5217\uff1a\u5904\u7406\u6d88\u606f\u961f\u5217\u96c6\u5408\uff0c",(0,l.jsx)(n.strong,{children:"ProcessQueue \u662f MQ \u961f\u5217\u5728\u6d88\u8d39\u8005\u7aef\u7684\u5feb\u7167"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final ConcurrentMap<MessageQueue, ProcessQueue> processQueueTable;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u8ba2\u9605\u4e3b\u9898\u7684\u961f\u5217\u4fe1\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final ConcurrentMap<String/* topic */, Set<MessageQueue>> topicSubscribeInfoTable;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8ba2\u9605\u6570\u636e\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected final ConcurrentMap<String/* topic */, SubscriptionData> subscriptionInner;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u961f\u5217\u5206\u914d\u7b56\u7565\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected AllocateMessageQueueStrategy allocateMessageQueueStrategy;\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"doRebalance()\uff1a\u8d1f\u8f7d\u5747\u8861\u65b9\u6cd5\uff0c\u4ee5\u6bcf\u4e2a\u6d88\u8d39\u8005\u5b9e\u4f8b\u4e3a\u7c92\u5ea6\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void doRebalance(final boolean isOrder) {\n    // \u83b7\u53d6\u5f53\u524d\u6d88\u8d39\u8005\u7684\u8ba2\u9605\u6570\u636e\n    Map<String, SubscriptionData> subTable = this.getSubscriptionInner();\n    if (subTable != null) {\n        // \u904d\u5386\u6240\u6709\u7684\u8ba2\u9605\u4e3b\u9898\n        for (final Entry<String, SubscriptionData> entry : subTable.entrySet()) {\n            // \u83b7\u53d6\u8ba2\u9605\u7684\u4e3b\u9898\n            final String topic = entry.getKey();\n            // \u6309\u7167\u4e3b\u9898\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\n            this.rebalanceByTopic(topic, isOrder);\n        }\n    }\n    // \u5c06\u5206\u914d\u5230\u5f53\u524d\u6d88\u8d39\u8005\u7684\u961f\u5217\u8fdb\u884c\u8fc7\u6ee4\uff0c\u4e0d\u5c5e\u4e8e\u5f53\u524d\u6d88\u8d39\u8005\u8ba2\u9605\u4e3b\u9898\u7684\u76f4\u63a5\u79fb\u9664\n    this.truncateMessageQueueNotMyTopic();\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u96c6\u7fa4\u6a21\u5f0f\u4e0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Set<MessageQueue> mqSet = this.topicSubscribeInfoTable.get(topic)"}),"\uff1a\u8ba2\u9605\u7684\u4e3b\u9898\u4e0b\u7684\u5168\u90e8\u961f\u5217\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"cidAll = this...findConsumerIdList(topic, consumerGroup)"}),"\uff1a\u4ece\u670d\u52a1\u5668\u83b7\u53d6\u6d88\u8d39\u8005\u7ec4\u4e0b\u7684\u5168\u90e8\u6d88\u8d39\u8005 ID"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Collections.sort(mqAll)"}),"\uff1a\u4e3b\u9898 MQ \u961f\u5217\u548c\u6d88\u8d39\u8005 ID \u90fd\u8fdb\u884c\u6392\u5e8f\uff0c",(0,l.jsx)(n.strong,{children:"\u4fdd\u8bc1\u6bcf\u4e2a\u6d88\u8d39\u8005\u7684\u89c6\u56fe\u4e00\u81f4\u6027"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"allocateResult = strategy.allocate()"}),"\uff1a ",(0,l.jsx)(n.strong,{children:"\u8c03\u7528\u961f\u5217\u5206\u914d\u7b56\u7565"}),"\uff0c\u7ed9\u5f53\u524d\u6d88\u8d39\u8005\u8fdb\u884c\u5206\u914d MessageQueue\uff08\u4e0b\u4e00\u8282\uff09"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean changed = this.updateProcessQueueTableInRebalance(...)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u66f4\u65b0\u961f\u5217\u5904\u7406\u96c6\u5408"}),"\uff0cmqSet \u662f rbl \u7b97\u6cd5\u5206\u914d\u5230\u5f53\u524d\u6d88\u8d39\u8005\u7684 MQ \u96c6\u5408"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (it.hasNext())"}),"\uff1a\u904d\u5386\u5f53\u524d\u6d88\u8d39\u8005\u7684\u6240\u6709\u5904\u7406\u961f\u5217"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (mq.getTopic().equals(topic))"}),"\uff1a\u8be5 MQ \u662f \u672c\u6b21 rbl \u5206\u914d\u7b97\u6cd5\u8ba1\u7b97\u7684\u4e3b\u9898"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!mqSet.contains(mq))"}),"\uff1a\u8be5 MQ \u7ecf\u8fc7 rbl \u8ba1\u7b97\u4e4b\u540e\uff0c",(0,l.jsx)(n.strong,{children:"\u88ab\u5206\u914d\u5230\u5176\u5b83 Consumer \u8282\u70b9"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pq.setDropped(true)"}),"\uff1a\u5c06\u5220\u9664\u72b6\u6001\u8bbe\u7f6e\u4e3a true"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.removeUnnecessaryMessageQueue(mq, pq))"}),"\uff1a\u5220\u9664\u4e0d\u9700\u8981\u7684 MQ \u961f\u5217"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this...getOffsetStore().persist(mq)"}),"\uff1a\u5728 MQ \u5f52\u5c5e\u7684 Broker \u8282\u70b9\u6301\u4e45\u5316\u6d88\u8d39\u8fdb\u5ea6"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this...getOffsetStore().removeOffset(mq)"}),"\uff1a\u5220\u9664\u8be5 MQ \u5728\u672c\u5730\u7684\u6d88\u8d39\u8fdb\u5ea6"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.defaultMQPushConsumerImpl.isConsumeOrderly() &&)"}),"\uff1a\u662f\u5426\u662f",(0,l.jsx)(n.strong,{children:"\u987a\u5e8f\u6d88\u8d39"}),"\u548c\u96c6\u7fa4\u6a21\u5f0f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (pq.getLockConsume().tryLock(1000, ..))"}),"\uff1a \u83b7\u53d6\u9501\u6210\u529f\uff0c\u8bf4\u660e\u987a\u5e8f\u6d88\u8d39\u4efb\u52a1\u5df2\u7ecf\u505c\u6b62\u6d88\u8d39\u5de5\u4f5c"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"return this.unlockDelay(mq, pq)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u91ca\u653e\u9501 Broker \u7aef\u7684\u961f\u5217\u9501\uff0c\u5411\u670d\u52a1\u5668\u53d1\u8d77 oneway \u7684\u89e3\u9501\u8bf7\u6c42"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (pq.hasTempMessage())"}),"\uff1a\u961f\u5217\u4e2d\u6709\u6d88\u606f\uff0c\u5ef6\u8fdf 20 \u79d2\u91ca\u653e\u961f\u5217\u5206\u5e03\u5f0f\u9501\uff0c\u786e\u4fdd\u5168\u5c40\u8303\u56f4\u5185\u53ea\u6709\u4e00\u4e2a\u6d88\u8d39\u4efb\u52a1 \u8fd0\u884c\u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u5f53\u524d\u6d88\u8d39\u8005\u672c\u5730\u8be5\u6d88\u8d39\u4efb\u52a1\u5df2\u7ecf\u9000\u51fa\uff0c\u76f4\u63a5\u91ca\u653e\u9501"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u987a\u5e8f\u6d88\u8d39\u4efb\u52a1\u6b63\u5728\u6d88\u8d39\u4e00\u6279\u6d88\u606f\uff0c\u4e0d\u53ef\u6253\u65ad\uff0c\u589e\u52a0\u5c1d\u8bd5\u83b7\u53d6\u9501\u7684\u6b21\u6570"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"it.remove()"}),"\uff1a\u4ece processQueueTable \u79fb\u9664\u8be5 MQ"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else if (pq.isPullExpired())"}),"\uff1a\u8bf4\u660e\u5f53\u524d MQ \u8fd8\u662f\u88ab\u5f53\u524d Consumer \u6d88\u8d39\uff0c\u6b64\u65f6\u5224\u65ad\u4e00\u4e0b\u662f\u5426\u8d85\u8fc7 2 \u5206\u949f\u672a\u5230\u670d\u52a1\u5668 \u62c9\u6d88\u606f\uff0c\u5982\u679c\u6761\u4ef6\u6210\u7acb\u8fdb\u884c\u4e0a\u8ff0\u76f8\u540c\u7684\u903b\u8f91"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (MessageQueue mq : mqSet)"}),"\uff1a\u5f00\u59cb\u5904\u7406\u5f53\u524d\u4e3b\u9898",(0,l.jsx)(n.strong,{children:"\u65b0\u5206\u914d\u5230\u5f53\u524d\u8282\u70b9\u7684\u961f\u5217"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (isOrder && !this.lock(mq))"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u987a\u5e8f\u6d88\u606f\u4e3a\u4e86\u4fdd\u8bc1\u6709\u5e8f\u6027\uff0c\u9700\u8981\u83b7\u53d6\u961f\u5217\u9501"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ProcessQueue pq = new ProcessQueue()"}),"\uff1a\u4e3a\u6bcf\u4e2a\u65b0\u5206\u914d\u7684\u6d88\u606f\u961f\u5217\u521b\u5efa\u5feb\u7167\u961f\u5217"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long nextOffset = this.computePullFromWhere(mq)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4ece\u670d\u52a1\u7aef\u83b7\u53d6\u65b0\u5206\u914d\u7684 MQ \u7684\u6d88\u8d39\u8fdb\u5ea6"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq)"}),"\uff1a\u4fdd\u5b58\u5230\u5904\u7406\u961f\u5217\u96c6\u5408"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"PullRequest pullRequest = new PullRequest()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u521b\u5efa\u62c9\u53d6\u8bf7\u6c42\u5bf9\u8c61"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.dispatchPullRequest(pullRequestList)"}),"\uff1a\u653e\u5165 PullMessageService \u7684",(0,l.jsx)(n.strong,{children:"\u672c\u5730\u963b\u585e\u961f\u5217"}),"\u5185\uff0c\u7528\u4e8e\u62c9\u53d6\u6d88\u606f\u5de5\u4f5c"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"lockAll()\uff1a\u7eed\u7ea6\u9501\uff0c\u5bf9\u6d88\u8d39\u8005\u7684\u6240\u6709\u961f\u5217\u8fdb\u884c\u7eed\u7ea6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void lockAll()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"HashMap<String, Set<MessageQueue>> brokerMqs"}),"\uff1a\u5c06\u5206\u914d\u7ed9\u5f53\u524d\u6d88\u8d39\u8005\u7684\u5168\u90e8 MQ \u6309\u7167 BrokerName \u5206\u7ec4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"while (it.hasNext())"}),"\uff1a\u904d\u5386\u6240\u6709\u7684\u5206\u7ec4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final Set<MessageQueue> mqs"}),"\uff1a\u83b7\u53d6\u8be5 Broker \u4e0a\u5206\u914d\u7ed9\u5f53\u524d\u6d88\u8d39\u8005\u7684 queue \u96c6\u5408"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"FindBrokerResult findBrokerResult"}),"\uff1a\u67e5\u8be2 Broker \u4e3b\u8282\u70b9\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"LockBatchRequestBody requestBody"}),"\uff1a\u521b\u5efa\u8bf7\u6c42\u5bf9\u8c61\uff0c\u586b\u5145\u5c5e\u6027"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Set<MessageQueue> lockOKMQSet"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4ee5\u7ec4\u4e3a\u5355\u4f4d\u5411 Broker \u53d1\u8d77\u6279\u91cf\u7eed\u7ea6\u9501\u7684\u540c\u6b65\u8bf7\u6c42"}),"\uff0c\u8fd4\u56de\u6210\u529f\u7684\u961f\u5217\u96c6\u5408"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (MessageQueue mq : lockOKMQSet)"}),"\uff1a\u904d\u5386\u7eed\u7ea6\u9501\u6210\u529f\u7684 MQ"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"processQueue.setLocked(true)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5206\u5e03\u5f0f\u9501\u72b6\u6001\u8bbe\u7f6e\u4e3a true\uff0c\u8868\u793a\u5141\u8bb8\u987a\u5e8f\u6d88\u8d39"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"processQueue.setLastLockTimestamp(System.currentTimeMillis())"}),"\uff1a\u8bbe\u7f6e\u4e0a\u6b21\u83b7\u53d6\u9501\u7684\u65f6\u95f4\u4e3a\u5f53\u524d\u65f6\u95f4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (MessageQueue mq : mqs)"}),"\uff1a\u904d\u5386\u5f53\u524d Broker \u4e0a\u7684\u6240\u6709\u961f\u5217\u96c6\u5408"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!lockOKMQSet.contains(mq))"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u7eed\u7ea6\u9501\u5931\u8d25"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"processQueue.setLocked(false)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5206\u5e03\u5f0f\u9501\u72b6\u6001\u8bbe\u7f6e\u4e3a false\uff0c\u8868\u793a\u4e0d\u5141\u8bb8\u987a\u5e8f\u6d88\u8d39"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u961f\u5217\u5206\u914d",children:"\u961f\u5217\u5206\u914d"}),"\n",(0,l.jsx)(n.p,{children:"AllocateMessageQueueStrategy \u7c7b\u662f\u961f\u5217\u7684\u5206\u914d\u7b56\u7565"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5e73\u5747\u5206\u914d\uff1aAllocateMessageQueueAveragely \u7c7b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u6d88\u8d39\u8005\u7ec4       \t\t\t\t\t\t\t\t\u53c2\u6570\u4e8c\uff1a\u5f53\u524d\u6d88\u8d39\u8005id   \n// \u53c2\u6570\u4e09\uff1a\u4e3b\u9898\u7684\u5168\u90e8\u961f\u5217\uff0c\u5305\u62ec\u6240\u6709 broker \u4e0a\u8be5\u4e3b\u9898\u7684 mq  \t\u53c2\u6570\u56db\uff1a\u5168\u90e8\u6d88\u8d39\u8005id\u96c6\u5408\npublic List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll, List<String> cidAll) {\n    // \u83b7\u53d6\u5f53\u524d\u6d88\u8d39\u8005\u5728\u5168\u90e8\u6d88\u8d39\u8005\u4e2d\u7684\u4f4d\u7f6e\uff0c\u3010\u5168\u90e8\u6d88\u8d39\u8005\u662f\u5df2\u7ecf\u6392\u5e8f\u597d\u7684\uff0c\u6392\u5728\u524d\u9762\u7684\u4f18\u5148\u5206\u914d\u66f4\u591a\u7684\u961f\u5217\u3011\n    int index = cidAll.indexOf(currentCID);\n    // \u5e73\u5747\u5206\u914d\u5b8c\u4ee5\u540e\uff0c\u8fd8\u5269\u4f59\u7684\u5f85\u5206\u914d\u7684 mq \u7684\u6570\u91cf\n    int mod = mqAll.size() % cidAll.size();\n    // \u9996\u5148\u5224\u65ad\u6574\u4f53\u7684 mq \u7684\u6570\u91cf\u662f\u5426\u5c0f\u4e8e\u6d88\u8d39\u8005\u7684\u6570\u91cf\uff0c\u5c0f\u4e8e\u6d88\u8d39\u8005\u7684\u6570\u91cf\u5c31\u8bf4\u660e\u4e0d\u591f\u5206\u7684\uff0c\u5148\u5206\u4e00\u4e2a\n    int averageSize = mqAll.size() <= cidAll.size() ? 1 :\n    \t// \u6210\u7acb\u9700\u8981\u591a\u5206\u914d\u4e00\u4e2a\u961f\u5217\uff0c\u56e0\u4e3a\u66f4\u9760\u524d\n    \t(mod > 0 && index < mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size());\n    // \u83b7\u53d6\u8d77\u59cb\u7684\u5206\u914d\u4f4d\u7f6e\n    int startIndex = (mod > 0 && index < mod) ? index * averageSize : index * averageSize + mod;\n    // \u9632\u6b62\u7d22\u5f15\u8d8a\u754c\n    int range = Math.min(averageSize, mqAll.size() - startIndex);\n    // \u5f00\u59cb\u5206\u914d\uff0c\u3010\u6328\u7740\u5206\u914d\uff0c\u662f\u76f4\u63a5\u5c31\u628a\u5f53\u524d\u7684 \u6d88\u8d39\u8005\u5206\u914d\u5b8c\u6210\u3011\n    for (int i = 0; i < range; i++) {\n        result.add(mqAll.get((startIndex + i) % mqAll.size()));\n    }\n    return result;\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u961f\u5217\u6392\u5e8f\u540e\uff1aQ1 \u2192 Q2 \u2192 Q3\uff0c\u6d88\u8d39\u8005\u6392\u5e8f\u540e C1 \u2192 C2 \u2192 C3"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(15813).A+"",width:"1148",height:"267"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8f6e\u6d41\u5206\u914d\uff1aAllocateMessageQueueAveragelyByCircle"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(96765).A+"",width:"1120",height:"219"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u6307\u5b9a\u673a\u623f\u5e73\u5747\u5206\u914d\uff1aAllocateMessageQueueByMachineRoom\uff0c\u524d\u63d0\u662f Broker \u7684\u547d\u540d\u89c4\u5219\u4e3a ",(0,l.jsx)(n.code,{children:"\u673a\u623f\u540d@BrokerName"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u62c9\u53d6\u670d\u52a1",children:"\u62c9\u53d6\u670d\u52a1"}),"\n",(0,l.jsx)(n.h5,{id:"\u5b9e\u73b0\u65b9\u5f0f-1",children:"\u5b9e\u73b0\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"MQClientInstance#start \u4e2d\u4f1a\u542f\u52a8\u6d88\u606f\u62c9\u53d6\u670d\u52a1\uff1aPullMessageService"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public void run() {\n    // \u68c0\u67e5\u505c\u6b62\u6807\u8bb0\uff0c\u3010\u5faa\u73af\u62c9\u53d6\u3011\n    while (!this.isStopped()) {\n        try {\n            // \u4ece\u963b\u585e\u961f\u5217\u4e2d\u83b7\u53d6\u62c9\u6d88\u606f\u8bf7\u6c42\n            PullRequest pullRequest = this.pullRequestQueue.take();\n            // \u62c9\u53d6\u6d88\u606f\uff0c\u83b7\u53d6\u8bf7\u6c42\u5bf9\u5e94\u7684\u4f7f\u7528\u5f53\u524d\u6d88\u8d39\u8005\u7ec4\u4e2d\u7684\u54ea\u4e2a\u6d88\u8d39\u8005\uff0c\u8c03\u7528\u6d88\u8d39\u8005\u7684 pullMessage \u65b9\u6cd5\n            this.pullMessage(pullRequest);\n        } catch (Exception e) {\n            log.error("Pull Message Service Run Method exception", e);\n        }\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"DefaultMQPushConsumerImpl#pullMessage\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ProcessQueue processQueue = pullRequest.getProcessQueue()"}),"\uff1a\u83b7\u53d6\u8bf7\u6c42\u5bf9\u5e94\u7684\u5feb\u7167\u961f\u5217\uff0c\u5e76\u5224\u65ad\u662f\u5426\u662f\u5220\u9664\u72b6\u6001"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.executePullRequestLater()"}),"\uff1a\u5982\u679c\u5f53\u524d\u6d88\u8d39\u8005\u4e0d\u662f\u8fd0\u884c\u72b6\u6001\uff0c\u5219\u62c9\u6d88\u606f\u4efb\u52a1\u5ef6\u8fdf 3 \u79d2\u540e\u6267\u884c\uff0c\u5982\u679c\u662f\u6682\u505c\u72b6\u6001\u5ef6\u8fdf 1 \u79d2"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6d41\u63a7\u7684\u903b\u8f91"}),"\uff1a"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long cachedMessageCount = processQueue.getMsgCount().get()"}),"\uff1a\u83b7\u53d6\u6d88\u8d39\u8005\u672c\u5730\u8be5 queue \u5feb\u7167\u5185\u7f13\u5b58\u7684\u6d88\u606f\u6570\u91cf\uff0c\u5982\u679c\u5927\u4e8e 1000 \u6761\uff0c\u8fdb\u884c\u6d41\u63a7\uff0c\u5ef6\u8fdf 50 \u6beb\u79d2"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long cachedMessageSizeInMiB"}),"\uff1a \u6d88\u8d39\u8005\u672c\u5730\u8be5 queue \u5feb\u7167\u5185\u7f13\u5b58\u7684\u6d88\u606f\u5bb9\u91cf size\uff0c\u8d85\u8fc7 100m \u6d88\u606f\u672a\u88ab\u6d88\u8d39\u8fdb\u884c\u6d41\u63a7"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if(processQueue.getMaxSpan() > 2000)"}),"\uff1a\u6d88\u8d39\u8005\u672c\u5730\u7f13\u5b58\u6d88\u606f\u7b2c\u4e00\u6761\u6d88\u606f\u6700\u540e\u4e00\u6761\u6d88\u606f\u8de8\u5ea6\u8d85\u8fc7 2000 \u8fdb\u884c\u6d41\u63a7"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"SubscriptionData subscriptionData"}),"\uff1a\u672c\u6b21\u62c9\u6d88\u606f\u8bf7\u6c42\u8ba2\u9605\u7684\u4e3b\u9898\u6570\u636e\uff0c\u5982\u679c\u8c03\u7528\u4e86 ",(0,l.jsx)(n.code,{children:"unsubscribe(\u4e3b\u9898)"})," \u5c06\u4f1a\u83b7\u53d6\u4e3a null"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"PullCallback pullCallback = new PullCallback()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u62c9\u6d88\u606f\u5904\u7406\u56de\u8c03\u5bf9\u8c61"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pullResult = ...processPullResult()"}),"\uff1a\u9884\u5904\u7406 PullResult \u7ed3\u679c\uff0c\u5c06\u670d\u52a1\u5668\u7aef\u6307\u5b9a MQ \u7684\u62c9\u6d88\u606f",(0,l.jsx)(n.strong,{children:"\u4e0b\u4e00\u6b21\u7684\u63a8\u8350\u8282\u70b9"}),"\u4fdd\u5b58\u5230 pullFromWhichNodeTable \u4e2d\uff0c",(0,l.jsx)(n.strong,{children:"\u5e76\u8fdb\u884c\u6d88\u606f\u8fc7\u6ee4"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case FOUND"}),"\uff1a\u6b63\u5e38\u62c9\u53d6\u5230\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pullRequest.setNextOffset(pullResult.getNextBeginOffset())"}),"\uff1a\u66f4\u65b0 pullRequest \u5bf9\u8c61\u4e0b\u4e00\u6b21\u62c9\u53d6\u6d88\u606f\u7684\u4f4d\u70b9"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (pullResult.getMsgFoundList() == null...)"}),"\uff1a\u6d88\u606f\u8fc7\u6ee4\u5bfc\u81f4\u6d88\u606f\u5168\u90e8\u88ab\u8fc7\u6ee4\u6389\uff0c\u9700\u8981\u7acb\u9a6c\u53d1\u8d77\u4e0b\u4e00\u6b21\u62c9\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean .. = processQueue.putMessage()"}),"\uff1a\u5c06\u670d\u52a1\u5668\u62c9\u53d6\u7684\u6d88\u606f\u96c6\u5408",(0,l.jsx)(n.strong,{children:"\u52a0\u5165\u5230\u6d88\u8d39\u8005\u672c\u5730"}),"\u7684 processQueue \u5185"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMQPushConsumerImpl...submitConsumeRequest()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\uff0c\u5206\u4e3a\u987a\u5e8f\u6d88\u8d39\u548c\u5e76\u53d1\u6d88\u8d39"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Defaul..executePullRequestImmediately(pullRequest)"}),"\uff1a\u5c06\u66f4\u65b0\u8fc7 nextOffset \u5b57\u6bb5\u7684 PullRequest \u5bf9\u8c61\uff0c\u518d\u6b21\u653e\u5230 pullMessageService \u7684\u963b\u585e\u961f\u5217\u4e2d\uff0c",(0,l.jsx)(n.strong,{children:"\u5f62\u6210\u95ed\u73af"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case NO_NEW_MSG ||NO_MATCHED_MSG"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8868\u793a\u672c\u6b21 pull \u6ca1\u6709\u65b0\u7684\u53ef\u6d88\u8d39\u7684\u4fe1\u606f"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pullRequest.setNextOffset()"}),"\uff1a\u66f4\u65b0\u66f4\u65b0 pullRequest \u5bf9\u8c61\u4e0b\u4e00\u6b21\u62c9\u53d6\u6d88\u606f\u7684\u4f4d\u70b9"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Defaul..executePullRequestImmediately(pullRequest)"}),"\uff1a\u518d\u6b21\u62c9\u53d6\u8bf7\u6c42"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case OFFSET_ILLEGAL"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u672c\u6b21 pull \u65f6\u4f7f\u7528\u7684 offset \u662f\u65e0\u6548\u7684"}),"\uff0c\u5373 offset > maxOffset || offset  < minOffset"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pullRequest.setNextOffset()"}),"\uff1a\u8c03\u6574 pullRequest.nextOffset \u4e3a\u6b63\u786e\u7684 offset"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pullRequest.getProcessQueue().setDropped(true)"}),"\uff1a\u8bbe\u7f6e\u8be5 processQueue \u4e3a\u5220\u9664\u72b6\u6001\uff0c\u5982\u679c\u6709\u8be5 queue \u7684\u6d88\u8d39\u4efb\u52a1\uff0c\u6d88\u8d39\u4efb\u52a1\u4f1a\u9a6c\u4e0a\u505c\u6b62"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMQPushConsumerImpl.this.executeTaskLater()"}),"\uff1a\u63d0\u4ea4\u5f02\u6b65\u4efb\u52a1\uff0c10 \u79d2\u540e\u53bb\u6267\u884c"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMQPushConsumerImpl...updateOffset()"}),"\uff1a\u66f4\u65b0 offsetStore \u8be5 MQ \u7684 offset \u4e3a\u6b63\u786e\u503c\uff0c\u5185\u90e8\u76f4\u63a5\u66ff\u6362"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMQPushConsumerImpl...persist()"}),"\uff1a\u6301\u4e45\u5316\u8be5 messageQueue \u7684 offset \u5230 Broker \u7aef"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMQPushConsumerImpl...removeProcessQueue()"}),"\uff1a \u5220\u9664\u8be5\u6d88\u8d39\u8005\u8be5 messageQueue \u5bf9\u5e94\u7684 processQueue"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8fd9\u91cc\u6ca1\u6709\u518d\u6b21\u63d0\u4ea4 pullRequest \u5230 pullMessageService \u7684\u961f\u5217\uff0c\u90a3\u8be5\u961f\u5217\u4e0d\u518d\u62c9\u6d88\u606f\u4e86\u5417\uff1f"}),"\n",(0,l.jsx)(n.p,{children:"\u8d1f\u8f7d\u5747\u8861 rbl \u7a0b\u5e8f\u4f1a\u91cd\u5efa\u8be5\u961f\u5217\u7684 processQueue\uff0c\u91cd\u5efa\u5b8c\u4e4b\u540e\u4f1a\u4e3a\u8be5\u961f\u5217\u521b\u5efa\u65b0\u7684 PullRequest \u5bf9\u8c61"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"int sysFlag = PullSysFlag.buildSysFlag()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6784\u5efa\u6807\u5fd7\u5bf9\u8c61"}),"\uff0csysFlag \u9ad8 4 \u4f4d\u672a\u4f7f\u7528\uff0c\u4f4e 4 \u4f4d\u4f7f\u7528\uff0c\u4ece\u5de6\u5230\u53f3 0000 0011"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7b2c\u4e00\u4f4d\uff1a\u8868\u793a\u662f\u5426\u63d0\u4ea4\u6d88\u8d39\u8005\u672c\u5730\u8be5\u961f\u5217\u7684 offset\uff0c\u4e00\u822c\u662f 1"}),"\n",(0,l.jsx)(n.li,{children:"\u7b2c\u4e8c\u4f4d\uff1a\u8868\u793a\u662f\u5426\u5141\u8bb8\u670d\u52a1\u5668\u7aef\u8fdb\u884c\u957f\u8f6e\u8be2\uff0c\u4e00\u822c\u662f 1"}),"\n",(0,l.jsx)(n.li,{children:"\u7b2c\u4e09\u4f4d\uff1a\u8868\u793a\u662f\u5426\u63d0\u4ea4\u6d88\u8d39\u8005\u672c\u5730\u8be5\u4e3b\u9898\u7684\u8ba2\u9605\u6570\u636e\uff0c\u4e00\u822c\u662f 0"}),"\n",(0,l.jsx)(n.li,{children:"\u7b2c\u56db\u4f4d\uff1a\u8868\u793a\u662f\u5426\u4e3a\u7c7b\u8fc7\u6ee4\uff0c\u4e00\u822c\u662f 0"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.pullAPIWrapper.pullKernelImpl()"}),"\uff1a\u62c9\u53d6\u6d88\u606f\u7684\u6838\u5fc3\u65b9\u6cd5"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u5c01\u88c5\u5bf9\u8c61",children:"\u5c01\u88c5\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.p,{children:"PullAPIWrapper \u7c7b\u5c01\u88c5\u4e86\u62c9\u53d6\u6d88\u606f\u7684 API"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u63a8\u8350\u62c9\u6d88\u606f\u4f7f\u7528\u7684\u4e3b\u673a ID\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private ConcurrentMap<MessageQueue, AtomicLong/* brokerId */> pullFromWhichNodeTable\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"pullKernelImpl()\uff1a\u62c9\u6d88\u606f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"FindBrokerResult findBrokerResult"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u672c\u5730\u67e5\u8be2\u6307\u5b9a BrokerName \u7684\u5730\u5740\u4fe1\u606f"}),"\uff0c\u63a8\u8350\u8282\u70b9\u6216\u8005\u4e3b\u8282\u70b9"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == findBrokerResult)"}),"\uff1a\u67e5\u8be2\u4e0d\u5230\uff0c\u5c31\u5230 Namesrv \u83b7\u53d6\u6307\u5b9a topic \u7684\u8def\u7531\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (findBrokerResult.isSlave())"}),"\uff1a\u6210\u7acb\u8bf4\u660e findBrokerResult \u8868\u793a\u7684\u4e3b\u673a\u4e3a slave \u8282\u70b9\uff0c",(0,l.jsx)(n.strong,{children:"slave \u4e0d\u5b58\u50a8 offset \u4fe1\u606f"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner)"}),"\uff1a\u5c06 sysFlag \u6807\u8bb0\u4f4d\u4e2d CommitOffset \u7684\u4f4d\u7f6e\u4e3a 0"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"PullMessageRequestHeader requestHeader"}),"\uff1a\u521b\u5efa\u8bf7\u6c42\u5934\u5bf9\u8c61\uff0c\u5c01\u88c5\u6240\u6709\u7684\u53c2\u6570"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage()"}),"\uff1a\u8c03\u7528\u5ba2\u6237\u7aef\u5b9e\u4f8b\u7684\u65b9\u6cd5\uff0c\u6838\u5fc3\u903b\u8f91\u5c31\u662f",(0,l.jsx)(n.strong,{children:"\u5c06\u4e1a\u52a1\u6570\u636e\u8f6c\u5316\u4e3a RemotingCommand  \u901a\u8fc7 NettyRemotingClient \u7684 IO \u8fdb\u884c\u901a\u4fe1"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"RemotingCommand request"}),"\uff1a\u521b\u5efa\u7f51\u7edc\u5c42\u4f20\u8f93\u5bf9\u8c61 RemotingCommand \u5bf9\u8c61\uff0c",(0,l.jsxs)(n.strong,{children:["\u8bf7\u6c42 ID \u4e3a ",(0,l.jsx)(n.code,{children:"PULL_MESSAGE = 11"})]})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"return this.pullMessageSync(...)"}),"\uff1a\u6b64\u5904\u662f",(0,l.jsx)(n.strong,{children:"\u5f02\u6b65\u8c03\u7528\uff0c\u5904\u7406\u7ed3\u679c\u653e\u5165 ResponseFuture \u4e2d"}),"\uff0c\u53c2\u8003\u670d\u52a1\u7aef\u5c0f\u8282\u7684\u5904\u7406\u5668\u7c7b ",(0,l.jsx)(n.code,{children:"NettyServerHandler#processMessageReceived"})," \u65b9\u6cd5"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"RemotingCommand response = responseFuture.getResponseCommand()"}),"\uff1a\u83b7\u53d6\u670d\u52a1\u5668\u7aef\u54cd\u5e94\u6570\u636e response"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"PullResult pullResult"}),"\uff1a\u4ece response \u5185\u63d0\u53d6\u51fa\u6765\u62c9\u6d88\u606f\u7ed3\u679c\u5bf9\u8c61\uff0c\u5c06\u54cd\u5e94\u5934 PullMessageResponseHeader \u5bf9\u8c61\u4e2d\u4fe1\u606f",(0,l.jsx)(n.strong,{children:"\u586b\u5145\u5230 PullResult \u4e2d"}),"\uff0c\u5217\u51fa\u4e24\u4e2a\u91cd\u8981\u7684\u5b57\u6bb5\uff1a"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private Long suggestWhichBrokerId"}),"\uff1a\u670d\u52a1\u7aef\u5efa\u8bae\u5ba2\u6237\u7aef\u4e0b\u6b21 Pull \u65f6\u9009\u62e9\u7684 BrokerID"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"private Long nextBeginOffset"}),"\uff1a\u5ba2\u6237\u7aef\u4e0b\u6b21 Pull \u65f6\u4f7f\u7528\u7684 offset \u4fe1\u606f"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"pullCallback.onSuccess(pullResult)"}),"\uff1a\u5c06 PullResult \u4ea4\u7ed9\u62c9\u6d88\u606f\u7ed3\u679c\u5904\u7406\u56de\u8c03\u5bf9\u8c61\uff0c\u8c03\u7528 onSuccess \u65b9\u6cd5"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u62c9\u53d6\u5904\u7406",children:"\u62c9\u53d6\u5904\u7406"}),"\n",(0,l.jsx)(n.h5,{id:"\u5904\u7406\u5668",children:"\u5904\u7406\u5668"}),"\n",(0,l.jsxs)(n.p,{children:["BrokerStartup#createBrokerController \u65b9\u6cd5\u4e2d\u521b\u5efa\u4e86 BrokerController \u5e76\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u8c03\u7528 ",(0,l.jsx)(n.code,{children:"registerProcessor()"})," \u65b9\u6cd5\u5c06\u5904\u7406\u5668 PullMessageProcessor \u6ce8\u518c\u5230 NettyRemotingServer \u4e2d\uff0c\u5bf9\u5e94\u7684\u8bf7\u6c42 ID \u4e3a ",(0,l.jsx)(n.code,{children:"PULL_MESSAGE = 11"}),"\uff0cNettyServerHandler \u5728\u5904\u7406\u8bf7\u6c42\u65f6\u901a\u8fc7\u8bf7\u6c42 ID \u4f1a\u83b7\u53d6\u5904\u7406\u5668\u6267\u884c processRequest \u65b9\u6cd5"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u670d\u52a1\u5668\u4e0e\u5ba2\u6237\u7aef netty \u901a\u9053\uff1b \u53c2\u6570\u4e8c\uff1a\u5ba2\u6237\u7aef\u8bf7\u6c42\uff1b \u53c2\u6570\u4e09\uff1a\u662f\u5426\u5141\u8bb8\u670d\u52a1\u5668\u7aef\u957f\u8f6e\u8be2\uff0c\u9ed8\u8ba4 true\nprivate RemotingCommand processRequest(final Channel channel, RemotingCommand request, boolean brokerAllowSuspend)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"RemotingCommand response"}),"\uff1a\u521b\u5efa\u54cd\u5e94\u5bf9\u8c61\uff0c\u8bbe\u7f6e\u4e3a\u54cd\u5e94\u7c7b\u578b\u7684\u8bf7\u6c42\uff0c\u54cd\u5e94\u5934\u662f PullMessageResponseHeader"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final PullMessageResponseHeader responseHeader"}),"\uff1a\u83b7\u53d6\u54cd\u5e94\u5bf9\u8c61\u7684 header"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final PullMessageRequestHeader requestHeader"}),"\uff1a\u89e3\u6790\u51fa\u8bf7\u6c42\u5934 PullMessageRequestHeader"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"response.setOpaque(request.getOpaque())"}),"\uff1a\u8bbe\u7f6e opaque \u5c5e\u6027\uff0c\u5ba2\u6237\u7aef",(0,l.jsx)(n.strong,{children:"\u6839\u636e\u8be5\u5b57\u6bb5\u83b7\u53d6 ResponseFuture"})," \u8fdb\u884c\u5904\u7406"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8fdb\u884c\u4e00\u4e9b\u9274\u6743\u7684\u903b\u8f91\uff1a\u662f\u5426\u5141\u8bb8\u957f\u8f6e\u8be2\u3001\u63d0\u4ea4 offset\u3001topicConfig \u662f\u5426\u662f\u7a7a\u3001\u961f\u5217 ID \u662f\u5426\u5408\u7406"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ConsumerGroupInfo consumerGroupInfo"}),"\uff1a\u83b7\u53d6\u6d88\u8d39\u8005\u7ec4\u4fe1\u606f\uff0c\u5305\u542b\u5168\u90e8\u7684\u6d88\u8d39\u8005\u548c\u8ba2\u9605\u6570\u636e"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"subscriptionData = consumerGroupInfo.findSubscriptionData()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u6307\u5b9a\u4e3b\u9898\u7684\u8ba2\u9605\u6570\u636e"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!ExpressionType.isTagType()"}),"\uff1a\u8868\u8fbe\u5f0f\u5339\u914d"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageFilter messageFilter"}),"\uff1a\u521b\u5efa\u6d88\u606f\u8fc7\u6ee4\u5668\uff0c\u4e00\u822c\u662f\u901a\u8fc7 tagCode \u8fdb\u884c\u8fc7\u6ee4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"DefaultMessageStore.getMessage()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u67e5\u8be2\u6d88\u606f\u7684\u6838\u5fc3\u903b\u8f91\uff0c\u5728 Broker \u7aef\u67e5\u8be2\u6d88\u606f"}),"\uff08\u5b58\u50a8\u7aef\u7b14\u8bb0\u8be6\u89e3\u4e86\u8be5\u6e90\u7801\uff09"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"response.setRemark()"}),"\uff1a\u8bbe\u7f6e\u6b64\u6b21\u54cd\u5e94\u7684\u72b6\u6001"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"responseHeader.set.."}),"\uff1a\u8bbe\u7f6e\u54cd\u5e94\u5934\u5bf9\u8c61\u7684\u4e00\u4e9b\u5b57\u6bb5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (this.brokerController.getMessageStoreConfig().getBrokerRole())"}),"\uff1a\u5982\u679c\u5f53\u524d\u4e3b\u673a\u8282\u70b9\u89d2\u8272\u4e3a slave \u5e76\u4e14",(0,l.jsx)(n.strong,{children:"\u4ece\u8282\u70b9\u8bfb"}),"\u5e76\u672a\u5f00\u542f\u7684\u8bdd\uff0c\u76f4\u63a5\u7ed9\u5ba2\u6237\u7aef \u4e00\u4e2a\u72b6\u6001 ",(0,l.jsx)(n.code,{children:"PULL_RETRY_IMMEDIATELY"}),"\uff0c\u5e76\u8bbe\u7f6e\u4e3a\u4e0b\u6b21\u4ece\u4e3b\u8282\u70b9\u8bfb"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.brokerController.getBrokerConfig().isSlaveReadEnable())"}),"\uff1a\u6d88\u8d39\u592a\u6162\uff0c",(0,l.jsx)(n.strong,{children:"\u4e0b\u6b21\u4ece\u53e6\u4e00\u53f0\u673a\u5668\u62c9\u53d6"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (getMessageResult.getStatus())"}),"\uff1a\u6839\u636e getMessageResult \u7684\u72b6\u6001\u8bbe\u7f6e response \u7684 code"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public enum GetMessageStatus {\n    FOUND,\t\t\t\t\t// \u67e5\u8be2\u6210\u529f\n    NO_MATCHED_MESSAGE,\t\t// \u672a\u67e5\u8be2\u5230\u5230\u6d88\u606f\uff0c\u670d\u52a1\u7aef\u8fc7\u6ee4 tagCode\n    MESSAGE_WAS_REMOVING,\t// \u67e5\u8be2\u65f6\u8d76\u4e0a CommitLog \u6e05\u7406\u8fc7\u671f\u6587\u4ef6\uff0c\u5bfc\u81f4\u67e5\u8be2\u5931\u8d25\uff0c\u7acb\u523b\u5c1d\u8bd5\n    OFFSET_FOUND_NULL,\t\t// \u67e5\u8be2\u65f6\u8d76\u4e0a ConsumerQueue \u6e05\u7406\u8fc7\u671f\u6587\u4ef6\uff0c\u5bfc\u81f4\u67e5\u8be2\u5931\u8d25\uff0c\u3010\u8fdb\u884c\u957f\u8f6e\u8be2\u3011\n    OFFSET_OVERFLOW_BADLY,\t// pullRequest.offset \u8d8a\u754c maxOffset\n    OFFSET_OVERFLOW_ONE,\t// pullRequest.offset == CQ.maxOffset\uff0c\u3010\u8fdb\u884c\u957f\u8f6e\u8be2\u3011\n    OFFSET_TOO_SMALL,\t\t// pullRequest.offset \u8d8a\u754c minOffset\n    NO_MATCHED_LOGIC_QUEUE,\t// \u6ca1\u6709\u5339\u914d\u5230\u903b\u8f91\u961f\u5217\n    NO_MESSAGE_IN_QUEUE,\t// \u7a7a\u961f\u5217\uff0c\u521b\u5efa\u961f\u5217\u4e5f\u662f\u56e0\u4e3a\u67e5\u8be2\u5bfc\u81f4\uff0c\u3010\u8fdb\u884c\u957f\u8f6e\u8be2\u3011\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (response.getCode())"}),"\uff1a\u6839\u636e response \u72b6\u6001\u505a\u5bf9\u5e94\u7684\u4e1a\u52a1\u5904\u7406"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case ResponseCode.SUCCESS"}),"\uff1a\u67e5\u8be2\u6210\u529f"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final byte[] r = this.readGetMessageResult()"}),"\uff1a\u672c\u6b21 pull \u51fa\u6765\u7684\u5168\u90e8\u6d88\u606f\u5bfc\u5165 byte \u6570\u7ec4"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"response.setBody(r)"}),"\uff1a\u5c06\u6d88\u606f\u7684 byte \u6570\u7ec4\u4fdd\u5b58\u5230 response body \u5b57\u6bb5"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case ResponseCode.PULL_NOT_FOUND"}),"\uff1a\u4ea7\u751f\u8fd9\u79cd\u60c5\u51b5\u5927\u90e8\u5206\u539f\u56e0\u662f ",(0,l.jsx)(n.code,{children:"pullRequest.offset  ==  queue.maxOffset"}),"\uff0c\u8bf4\u660e\u5df2\u7ecf\u6ca1\u6709\u9700\u8981\u83b7\u53d6\u7684\u6d88\u606f\uff0c\u6b64\u65f6\u5982\u679c\u76f4\u63a5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u5ba2\u6237\u7aef\u4f1a\u7acb\u523b\u91cd\u65b0\u8bf7\u6c42\uff0c\u8fd8\u662f\u7ee7\u7eed\u8fd4\u56de\u8be5\u72b6\u6001\uff0c\u9891\u7e41\u62c9\u53d6\u670d\u52a1\u5668\u5bfc\u81f4\u670d\u52a1\u5668\u538b\u529b\u5927\uff0c\u6240\u4ee5\u6b64\u5904",(0,l.jsx)(n.strong,{children:"\u9700\u8981\u957f\u8f6e\u8be2"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (brokerAllowSuspend && hasSuspendFlag)"}),"\uff1abrokerAllowSuspend = true\uff0c\u5f53\u957f\u8f6e\u8be2\u7ed3\u675f\u518d\u6b21\u6267\u884c processRequest \u65f6\u8be5\u53c2\u6570\u4e3a false\uff0c\u6240\u4ee5",(0,l.jsx)(n.strong,{children:"\u6bcf\u6b21 Pull \u8bf7\u6c42\u81f3\u591a\u5728\u670d\u52a1\u5668\u7aef\u957f\u8f6e\u8be2\u63a7\u5236\u4e00\u6b21"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"PullRequest pullRequest = new PullRequest()"}),"\uff1a\u521b\u5efa\u957f\u8f6e\u8be2 PullRequest \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.brokerController...suspendPullRequest(topic, queueId, pullRequest)"}),"\uff1a\u5c06\u957f\u8f6e\u8be2\u8bf7\u6c42\u5bf9\u8c61\u4ea4\u7ed9\u957f\u8f6e\u8be2\u670d\u52a1\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String key = this.buildKey(topic, queueId)"}),"\uff1a\u6784\u5efa\u4e00\u4e2a ",(0,l.jsx)(n.code,{children:"topic@queueId"})," \u7684 key"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ManyPullRequest mpr = this.pullRequestTable.get(key)"}),"\uff1a\u4ece\u62c9\u8bf7\u6c42\u8868\u4e2d\u83b7\u53d6\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mpr.addPullRequest(pullRequest)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06 PullRequest \u5bf9\u8c61\u653e\u5165\u5230\u957f\u8f6e\u8be2\u7684\u8bf7\u6c42\u96c6\u5408\u4e2d"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"response = null"}),"\uff1a\u54cd\u5e94\u8bbe\u7f6e\u4e3a null \u5185\u90e8\u7684 callBack \u5c31\u4e0d\u4f1a\u7ed9\u5ba2\u6237\u7aef\u53d1\u9001\u4efb\u4f55\u6570\u636e\uff0c",(0,l.jsx)(n.strong,{children:"\u4e0d\u8fdb\u884c\u901a\u4fe1"}),"\uff0c\u5426\u5219\u5c31\u53c8\u5f00\u59cb\u91cd\u65b0\u8bf7\u6c42"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean storeOffsetEnable"}),"\uff1a\u5141\u8bb8\u957f\u8f6e\u8be2\u3001sysFlag \u8868\u793a\u63d0\u4ea4\u6d88\u8d39\u8005\u672c\u5730\u8be5\u961f\u5217\u7684offset\u3001\u5f53\u524d broker \u8282\u70b9\u89d2\u8272\u4e3a master \u8282\u70b9\u4e09\u4e2a\u6761\u4ef6\u6210\u7acb\uff0c\u624d",(0,l.jsx)(n.strong,{children:"\u5728 Broker \u7aef\u5b58\u50a8\u6d88\u8d39\u8005\u7ec4\u5185\u8be5\u4e3b\u9898\u7684\u6307\u5b9a queue \u7684\u6d88\u8d39\u8fdb\u5ea6"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"return response"}),"\uff1a\u8fd4\u56de response\uff0c\u4e0d\u4e3a null \u65f6\u5916\u5c42 processRequestCommand \u7684 callback \u4f1a\u5c06\u6570\u636e\u5199\u7ed9\u5ba2\u6237\u7aef"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u957f\u8f6e\u8be2",children:"\u957f\u8f6e\u8be2"}),"\n",(0,l.jsxs)(n.p,{children:["PullRequestHoldService \u7c7b\u8d1f\u8d23\u957f\u8f6e\u8be2\uff0cBrokerController#start \u65b9\u6cd5\u4e2d\u8c03\u7528\u4e86 ",(0,l.jsx)(n.code,{children:"this.pullRequestHoldService.start()"})," \u542f\u52a8\u8be5\u670d\u52a1"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u6838\u5fc3\u8fd0\u884c\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run() {\n\t// \u5faa\u73af\u8fd0\u884c\n    while (!this.isStopped()) {\n        if (this.brokerController.getBrokerConfig().isLongPollingEnable()) {\n            // \u670d\u52a1\u5668\u5f00\u542f\u957f\u8f6e\u8be2\u5f00\u5173\uff1a\u6bcf\u6b21\u5faa\u73af\u4f11\u77205\u79d2\n            this.waitForRunning(5 * 1000);\n        } else {\n            // \u670d\u52a1\u5668\u5173\u95ed\u957f\u8f6e\u8be2\u5f00\u5173\uff1a\u6bcf\u6b21\u5faa\u73af\u4f11\u77201\u79d2\n            this.waitForRunning(...);\n        }\n        // \u68c0\u67e5\u6301\u6709\u7684\u8bf7\u6c42\n        this.checkHoldRequest();\n        // .....\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"checkHoldRequest()\uff1a\u68c0\u67e5\u6240\u6709\u7684\u8bf7\u6c42"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (String key : this.pullRequestTable.keySet())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u6240\u6709\u7684 topic@queueId \u7684\u903b\u8f91"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR)"}),"\uff1akey \u6309\u7167 @ \u62c6\u5206\uff0c\u5f97\u5230 topic \u548c queueId"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long offset = this...getMaxOffsetInQueue(topic, queueId)"}),"\uff1a \u5230\u5b58\u50a8\u6a21\u5757\u67e5\u8be2\u8be5 ConsumeQueue \u7684",(0,l.jsx)(n.strong,{children:"\u6700\u5927 offset"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.notifyMessageArriving(topic, queueId, offset)"}),"\uff1a\u901a\u77e5\u6d88\u606f\u5230\u8fbe"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["notifyMessageArriving()\uff1a",(0,l.jsx)(n.strong,{children:"\u901a\u77e5\u6d88\u606f\u5230\u8fbe"}),"\u7684\u903b\u8f91\uff0cReputMessageService \u6d88\u606f\u5206\u53d1\u670d\u52a1\u4e5f\u4f1a\u8c03\u7528\u8be5\u65b9\u6cd5"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ManyPullRequest mpr = this.pullRequestTable.get(key)"}),"\uff1a\u83b7\u53d6\u5bf9\u5e94\u7684\u7684 manyPullRequest \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"List<PullRequest> requestList"}),"\uff1a\u83b7\u53d6\u8be5\u961f\u5217\u4e0b\u7684\u6240\u6709 PullRequest\uff0c\u5e76\u8fdb\u884c\u904d\u5386"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"List<PullRequest> replayList"}),"\uff1a\u5f53\u67d0\u4e2a pullRequest \u4e0d\u8d85\u65f6\uff0c\u5e76\u4e14\u5bf9\u5e94\u7684 ",(0,l.jsx)(n.code,{children:"CQ.maxOffset <= pullRequest.offset"}),"\uff0c\u5c31\u5c06\u8be5 PullRequest \u518d\u653e\u5165\u8be5\u5217\u8868"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long newestOffset"}),"\uff1a\u8be5\u503c\u4e3a CQ \u7684 maxOffset"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (newestOffset > request.getPullFromThisOffset())"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u8bf7\u6c42\u5bf9\u5e94\u7684\u961f\u5217\u5185\u53ef\u4ee5 pull \u6d88\u606f\u4e86\uff0c\u7ed3\u675f\u957f\u8f6e\u8be2"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean match"}),"\uff1a\u8fdb\u884c\u8fc7\u6ee4\u5339\u914d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.brokerController...executeRequestWhenWakeup()"}),"\uff1a\u5c06\u6ee1\u8db3\u6761\u4ef6\u7684 pullRequest \u518d\u6b21\u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\u5185\u6267\u884c\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final RemotingCommand response"}),"\uff1a\u6267\u884c processRequest \u65b9\u6cd5\uff0c\u5e76\u4e14",(0,l.jsx)(n.strong,{children:"\u4e0d\u4f1a\u89e6\u53d1\u957f\u8f6e\u8be2"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"channel.writeAndFlush(response).addListene()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5c06\u7ed3\u679c\u6570\u636e\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (System.currentTimeMillis() >= ...)"}),"\uff1a\u5224\u65ad\u8be5 pullRequest \u662f\u5426\u8d85\u65f6\uff0c\u8d85\u65f6\u540e\u7684\u4e5f\u662f\u91cd\u65b0\u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\uff0c\u5e76\u4e14\u4e0d\u8fdb\u884c\u957f\u8f6e\u8be2"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"mpr.addPullRequest(replayList)"}),"\uff1a\u5c06\u672a\u6ee1\u8db3\u6761\u4ef6\u7684 PullRequest \u5bf9\u8c61\u518d\u6b21\u6dfb\u52a0\u5230 ManyPullRequest \u5c5e\u6027\u4e2d"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u7ed3\u679c\u7c7b",children:"\u7ed3\u679c\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"GetMessageResult \u7c7b\u6210\u5458\u4fe1\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class GetMessageResult {\n    // \u67e5\u8be2\u6d88\u606f\u65f6\uff0c\u6700\u5e95\u5c42\u90fd\u662f mappedFile \u652f\u6301\u7684\u67e5\u8be2\uff0c\u67e5\u8be2\u65f6\u8fd4\u56de\u7ed9\u5916\u5c42\u4e00\u4e2a SelectMappedBufferResult\uff0c\n    // mappedFile \u6bcf\u67e5\u8be2\u4e00\u6b21\u90fd\u4f1a refCount++ \uff0c\u901a\u8fc7SelectMappedBufferResult\u6301\u6709mappedFile\uff0c\u5b8c\u6210\u8d44\u6e90\u91ca\u653e\u7684\u53e5\u67c4\n    private final List<SelectMappedBufferResult> messageMapedList =\n        new ArrayList<SelectMappedBufferResult>(100);\n\n    // \u8be5List\u5185\u5b58\u50a8\u6d88\u606f\uff0c\u6bcf\u4e00\u6761\u6d88\u606f\u90fd\u88ab\u8f6c\u6210 ByteBuffer \u8868\u793a\u4e86\n    private final List<ByteBuffer> messageBufferList = new ArrayList<ByteBuffer>(100);\n    // \u67e5\u8be2\u7ed3\u679c\u72b6\u6001\n    private GetMessageStatus status;\n    // \u5ba2\u6237\u7aef\u4e0b\u6b21\u518d\u5411\u5f53\u524dQueue\u62c9\u6d88\u606f\u65f6\uff0c\u4f7f\u7528\u7684 offset\n    private long nextBeginOffset;\n    // \u5f53\u524dqueue\u6700\u5c0foffset\n    private long minOffset;\n    // \u5f53\u524dqueue\u6700\u5927offset\n    private long maxOffset;\n    // \u6d88\u606f\u603bbyte\u5927\u5c0f\n    private int bufferTotalSize = 0;\n    // \u670d\u52a1\u5668\u5efa\u8bae\u5ba2\u6237\u7aef\u4e0b\u6b21\u5230\u8be5 queue \u62c9\u6d88\u606f\u65f6\u662f\u5426\u4f7f\u7528 \u3010\u4ece\u8282\u70b9\u3011\n    private boolean suggestPullingFromSlave = false;\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u961f\u5217\u5feb\u7167",children:"\u961f\u5217\u5feb\u7167"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-10",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"ProcessQueue \u7c7b\u662f\u6d88\u8d39\u961f\u5217\u7684\u5feb\u7167"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5c5e\u6027\u5b57\u6bb5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final AtomicLong msgCount = new AtomicLong();\t// \u961f\u5217\u4e2d\u6d88\u606f\u6570\u91cf\nprivate final AtomicLong msgSize = new AtomicLong();\t// \u6d88\u606f\u603b\u5927\u5c0f\nprivate volatile long queueOffsetMax = 0L;\t\t\t\t// \u5feb\u7167\u4e2d\u6700\u5927 offset\nprivate volatile boolean dropped = false;\t\t\t\t// \u5feb\u7167\u662f\u5426\u79fb\u9664\nprivate volatile long lastPullTimestamp = current;\t\t// \u4e0a\u4e00\u6b21\u62c9\u6d88\u606f\u7684\u65f6\u95f4\nprivate volatile long lastConsumeTimestamp = current;\t// \u4e0a\u4e00\u6b21\u6d88\u8d39\u6d88\u606f\u7684\u65f6\u95f4\nprivate volatile long lastLockTimestamp = current;\t\t// \u4e0a\u4e00\u6b21\u83b7\u53d6\u9501\u7684\u65f6\u95f4\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u5bb9\u5668"}),"\uff1akey \u662f\u6d88\u606f\u504f\u79fb\u91cf\uff0cval \u662f\u6d88\u606f"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final TreeMap<Long, MessageExt> msgTreeMap = new TreeMap<Long, MessageExt>();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u987a\u5e8f\u6d88\u8d39\u4e34\u65f6\u5bb9\u5668"}),"\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final TreeMap<Long, MessageExt> consumingMsgOrderlyTreeMap = new TreeMap<Long, MessageExt>();\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u9501\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ReadWriteLock lockTreeMap;\t\t// \u8bfb\u5199\u9501\nprivate final Lock lockConsume;\t\t\t\t\t// \u91cd\u5165\u9501\uff0c\u3010\u987a\u5e8f\u6d88\u8d39\u4f7f\u7528\u3011\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u987a\u5e8f\u6d88\u8d39\u72b6\u6001\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private volatile boolean locked = false;\t\t// \u662f\u5426\u662f\u9501\u5b9a\u72b6\u6001\nprivate volatile boolean consuming = false;\t\t// \u662f\u5426\u662f\u6d88\u8d39\u4e2d\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-9",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"putMessage()\uff1a\u5c06 Broker \u62c9\u53d6\u4e0b\u6765\u7684 msgs \u5b58\u50a8\u5230\u5feb\u7167\u961f\u5217\u5185\uff0c\u8fd4\u56de\u4e3a true \u8868\u793a\u63d0\u4ea4\u987a\u5e8f\u6d88\u8d39\u4efb\u52a1\uff0cfalse \u8868\u793a\u4e0d\u63d0\u4ea4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public boolean putMessage(final List<MessageExt> msgs)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().lockInterruptibly()"}),"\uff1a\u83b7\u53d6\u5199\u9501"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (MessageExt msg : msgs)"}),"\uff1a\u904d\u5386 msgs \u5168\u90e8\u52a0\u5165 msgTreeMap\uff0ckey \u662f\u6d88\u606f\u7684 queueOffset"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!msgTreeMap.isEmpty() && !this.consuming)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u5bb9\u5668\u4e2d\u5b58\u5728\u672a\u5904\u7406\u7684\u6d88\u606f\uff0c\u5e76\u4e14\u4e0d\u662f\u6d88\u8d39\u4e2d\u7684\u72b6\u6001"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"dispatchToConsume = true"}),"\uff1a\u4ee3\u8868\u9700\u8981\u63d0\u4ea4\u987a\u5e8f\u6d88\u8d39\u4efb\u52a1"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.consuming = true"}),"\uff1a\u8bbe\u7f6e\u4e3a\u987a\u5e8f\u6d88\u8d39\u6267\u884c\u4e2d\u7684\u72b6\u6001"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().unlock()"}),"\uff1a\u91ca\u653e\u5199\u9501"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"removeMessage()\uff1a\u79fb\u9664\u5df2\u7ecf\u6d88\u8d39\u7684\u6d88\u606f\uff0c\u53c2\u6570\u662f\u5df2\u7ecf\u6d88\u8d39\u7684\u6d88\u606f\u96c6\u5408\uff0c\u5e76\u53d1\u6d88\u8d39\u4f7f\u7528"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public long removeMessage(final List<MessageExt> msgs)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long result = -1"}),"\uff1a\u7ed3\u679c\u521d\u59cb\u5316\u4e3a -1"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().lockInterruptibly()"}),"\uff1a\u83b7\u53d6\u5199\u9501"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lastConsumeTimestamp = now"}),"\uff1a\u66f4\u65b0\u4e0a\u4e00\u6b21\u6d88\u8d39\u6d88\u606f\u7684\u65f6\u95f4\u4e3a\u73b0\u5728"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (!msgTreeMap.isEmpty())"}),"\uff1a\u5224\u65ad\u6d88\u606f\u5bb9\u5668\u662f\u5426\u662f\u7a7a\uff0c",(0,l.jsx)(n.strong,{children:"\u662f\u7a7a\u76f4\u63a5\u8fd4\u56de -1"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"result = this.queueOffsetMax + 1"}),"\uff1a\u8bbe\u7f6e\u7ed3\u679c\uff0c",(0,l.jsx)(n.strong,{children:"\u5220\u9664\u5b8c\u540e\u6d88\u606f\u5bb9\u5668\u4e3a\u7a7a\u65f6\u8fd4\u56de"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (MessageExt msg : msgs)"}),"\uff1a\u5c06\u5df2\u7ecf\u6d88\u8d39\u7684\u6d88\u606f\u5168\u90e8\u4ece msgTreeMap \u79fb\u9664"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (!msgTreeMap.isEmpty())"}),"\uff1a\u79fb\u9664\u540e\u5bb9\u5668\u5185\u8fd8\u6709\u5f85\u6d88\u8d39\u7684\u6d88\u606f\uff0c",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6\u7b2c\u4e00\u6761\u6d88\u606f offset \u8fd4\u56de"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().unlock()"}),"\uff1a\u91ca\u653e\u5199\u9501"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"takeMessages()\uff1a\u83b7\u53d6\u4e00\u6279\u6d88\u606f\uff0c\u987a\u5e8f\u6d88\u8d39\u4f7f\u7528"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public List<MessageExt> takeMessages(final int batchSize)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().lockInterruptibly()"}),"\uff1a\u83b7\u53d6\u5199\u9501"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lastConsumeTimestamp = now"}),"\uff1a\u66f4\u65b0\u4e0a\u4e00\u6b21\u6d88\u8d39\u6d88\u606f\u7684\u65f6\u95f4\u4e3a\u73b0\u5728"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (int i = 0; i < batchSize; i++)"}),"\uff1a\u4ece\u5934\u8282\u70b9\u5f00\u59cb\u83b7\u53d6\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"result.add(entry.getValue())"}),"\uff1a\u5c06\u6d88\u606f\u653e\u5165\u7ed3\u679c\u96c6\u5408"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"consumingMsgOrderlyTreeMap.put()"}),"\uff1a\u5c06\u6d88\u606f\u52a0\u5165\u987a\u5e8f\u6d88\u8d39\u5bb9\u5668\u4e2d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (result.isEmpty())"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u987a\u5e8f\u6d88\u8d39\u5bb9\u5668\u672c\u5730\u5feb\u7167\u5185\u7684\u6d88\u606f\u5168\u90e8\u5904\u7406\u5b8c\u4e86\uff0c",(0,l.jsx)(n.strong,{children:"\u5f53\u524d\u987a\u5e8f\u6d88\u8d39\u4efb\u52a1\u9700\u8981\u505c\u6b62"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"consuming = false"}),"\uff1a\u6d88\u8d39\u72b6\u6001\u7f6e\u4e3a false"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().unlock()"}),"\uff1a\u91ca\u653e\u5199\u9501"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"commit()\uff1a\u5904\u7406\u5b8c\u4e00\u6279\u6d88\u606f\u540e\u8c03\u7528\uff0c\u987a\u5e8f\u6d88\u8d39\u4f7f\u7528"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public long commit()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().lockInterruptibly()"}),"\uff1a\u83b7\u53d6\u5199\u9501"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Long offset = this.consumingMsgOrderlyTreeMap.lastKey()"}),"\uff1a\u83b7\u53d6\u987a\u5e8f\u6d88\u8d39\u4e34\u65f6\u5bb9\u5668\u6700\u540e\u4e00\u6761\u6570\u636e\u7684 key"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msgCount, msgSize"}),"\uff1a\u66f4\u65b0\u987a\u5e8f\u6d88\u8d39\u76f8\u5173\u7684\u5b57\u6bb5"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.consumingMsgOrderlyTreeMap.clear()"}),"\uff1a\u6e05\u7a7a\u987a\u5e8f\u6d88\u8d39\u5bb9\u5668\u7684\u6570\u636e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"return offset + 1"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u8d39\u8005\u4e0b\u4e00\u6761\u6d88\u8d39\u7684\u4f4d\u70b9"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.lockTreeMap.writeLock().unlock()"}),"\uff1a\u91ca\u653e\u5199\u9501"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"cleanExpiredMsg()\uff1a\u6e05\u9664\u8fc7\u671f\u6d88\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void cleanExpiredMsg(DefaultMQPushConsumer pushConsumer)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) "}),"\uff1a\u987a\u5e8f\u6d88\u8d39\u4e0d\u6267\u884c\u8fc7\u671f\u6e05\u7406\u903b\u8f91"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"int loop = msgTreeMap.size() < 16 ? msgTreeMap.size() : 16"}),"\uff1a\u6700\u591a\u5faa\u73af 16 \u6b21"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (!msgTreeMap.isEmpty() &&)"}),"\uff1a\u5982\u679c\u5bb9\u5668\u4e2d\u7b2c\u4e00\u6761\u6d88\u606f\u7684\u6d88\u8d39\u5f00\u59cb\u65f6\u95f4\u4e0e\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u5dee\u503c > 15min\uff0c\u5219\u53d6\u51fa\u8be5\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u76f4\u63a5\u8df3\u51fa\u5faa\u73af\uff0c\u56e0\u4e3a",(0,l.jsx)(n.strong,{children:"\u5feb\u7167\u961f\u5217\u5185\u7684\u6d88\u606f\u662f\u6709\u987a\u5e8f\u7684"}),"\uff0c\u7b2c\u4e00\u6761\u6d88\u606f\u4e0d\u8fc7\u671f\uff0c\u5176\u4ed6\u6d88\u606f\u90fd\u4e0d\u8fc7\u671f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"pushConsumer.sendMessageBack(msg, 3)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u56de\u9000"}),"\u5230\u670d\u52a1\u5668\uff0c\u8bbe\u7f6e\u8be5\u6d88\u606f\u7684\u5ef6\u8fdf\u7ea7\u522b\u4e3a 3"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (!msgTreeMap.isEmpty() && msg.getQueueOffset() == msgTreeMap.firstKey())"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u6d88\u606f\u56de\u9000\u671f\u95f4\uff0c\u8be5\u76ee\u6807\u6d88\u606f\u5e76\u6ca1\u6709\u88ab\u6d88\u8d39\u4efb\u52a1\u6210\u529f\u6d88\u8d39"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"removeMessage(Collections.singletonList(msg))"}),"\uff1a\u4ece treeMap \u5c06\u8be5\u56de\u9000\u6210\u529f\u7684 msg \u5220\u9664"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5e76\u53d1\u6d88\u8d39",children:"\u5e76\u53d1\u6d88\u8d39"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-11",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"ConsumeMessageConcurrentlyService \u8d1f\u8d23\u5e76\u53d1\u6d88\u8d39\u670d\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u76d1\u542c\u5668\uff1a\u5c01\u88c5\u5904\u7406\u6d88\u606f\u7684\u903b\u8f91\uff0c\u8be5\u76d1\u542c\u5668\u7531\u5f00\u53d1\u8005\u5b9e\u73b0\uff0c\u5e76\u6ce8\u518c\u5230 defaultMQPushConsumer"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final MessageListenerConcurrently messageListener;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final BlockingQueue<Runnable> consumeRequestQueue;\t// \u6d88\u8d39\u4efb\u52a1\u961f\u5217\nprivate final String consumerGroup;\t\t\t\t\t\t\t// \u6d88\u8d39\u8005\u7ec4\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ebf\u7a0b\u6c60\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ThreadPoolExecutor consumeExecutor;\t\t\t\t// \u6d88\u8d39\u4efb\u52a1\u7ebf\u7a0b\u6c60\uff0c\u9ed8\u8ba4 20\nprivate final ScheduledExecutorService scheduledExecutorService;// \u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff0c\u5ef6\u8fdf\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\nprivate final ScheduledExecutorService cleanExpireMsgExecutors;\t// \u6e05\u7406\u8fc7\u671f\u6d88\u606f\u4efb\u52a1\u7ebf\u7a0b\u6c60\uff0c15min \u4e00\u6b21\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-10",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"ConsumeMessageConcurrentlyService \u5e76\u53d1\u6d88\u8d39\u6838\u5fc3\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u6d88\u8d39\u670d\u52a1\uff0cDefaultMQPushConsumerImpl \u542f\u52a8\u65f6\u4f1a\u8c03\u7528\u8be5\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start() {\n    // \u63d0\u4ea4\u201c\u6e05\u7406\u8fc7\u671f\u6d88\u606f\u4efb\u52a1\u201d\u4efb\u52a1\uff0c\u5ef6\u8fdf15min\u4e4b\u540e\u6267\u884c\uff0c\u4e4b\u540e\u6bcf15min\u6267\u884c\u4e00\u6b21\n    this.cleanExpireMsgExecutors.scheduleAtFixedRate(() ->  cleanExpireMsg()}, \n                                                     15, 15, TimeUnit.MINUTES);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"cleanExpireMsg()\uff1a\u6e05\u7406\u8fc7\u671f\u6d88\u606f\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void cleanExpireMsg()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Iterator<Map.Entry<MessageQueue, ProcessQueue>> it "}),"\uff1a\u83b7\u53d6\u5206\u914d\u7ed9\u5f53\u524d\u6d88\u8d39\u8005\u7684\u961f\u5217"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"while (it.hasNext())"}),"\uff1a\u904d\u5386\u6240\u6709\u7684\u961f\u5217"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"pq.cleanExpiredMsg(this.defaultMQPushConsumer)"}),"\uff1a\u8c03\u7528\u961f\u5217\u5feb\u7167 ProcessQueue \u6e05\u7406\u8fc7\u671f\u6d88\u606f\u7684\u65b9\u6cd5"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"submitConsumeRequest()\uff1a\u63d0\u4ea4\u6d88\u8d39\u8bf7\u6c42"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u4ece\u670d\u52a1\u5668 pull \u4e0b\u6765\u7684\u8fd9\u6279\u6d88\u606f\n// \u53c2\u6570\u4e8c\uff1a\u6d88\u606f\u5f52\u5c5e mq \u5728\u6d88\u8d39\u8005\u7aef\u7684 processQueue\uff0c\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\u4e4b\u524d\uff0cmsgs\u5df2\u7ecf\u52a0\u5165\u5230\u8be5pq\u5185\u4e86\n// \u53c2\u6570\u4e09\uff1a\u6d88\u606f\u5f52\u5c5e\u961f\u5217\n// \u53c2\u6570\u56db\uff1a\u5e76\u53d1\u6d88\u606f\u6b64\u53c2\u6570\u65e0\u6548\npublic void submitConsumeRequest(List<MessageExt> msgs, ProcessQueue processQueue, MessageQueue messageQueue, boolean dispatchToConsume)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final int consumeBatchSize"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u4e00\u4e2a\u6d88\u8d39\u4efb\u52a1\u53ef\u6d88\u8d39\u7684\u6d88\u606f\u6570\u91cf"}),"\uff0c\u9ed8\u8ba4\u4e3a 1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (msgs.size() <= consumeBatchSize)"}),"\uff1a\u5224\u65ad\u4e00\u4e2a\u6d88\u8d39\u4efb\u52a1\u662f\u5426\u53ef\u4ee5\u63d0\u4ea4"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ConsumeRequest consumeRequest"}),"\uff1a\u5c01\u88c5\u4e3a\u6d88\u8d39\u8bf7\u6c42"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.consumeExecutor.submit(consumeRequest)"}),"\uff1a\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\uff0c\u5f02\u6b65\u6267\u884c\u6d88\u606f\u7684\u5904\u7406"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u8bf4\u660e\u6d88\u606f\u8f83\u591a\uff0c\u9700\u8981\u591a\u4e2a\u6d88\u8d39\u4efb\u52a1"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (int total = 0; total < msgs.size(); )"}),"\uff1a\u5c06\u6d88\u606f\u62c6\u5206\u6210\u591a\u4e2a\u6d88\u8d39\u4efb\u52a1"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"processConsumeResult()\uff1a\u5904\u7406\u6d88\u8d39\u7ed3\u679c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\u4e00\uff1a\u6d88\u8d39\u7ed3\u679c\u72b6\u6001\uff1b  \u53c2\u6570\u4e8c\uff1a\u6d88\u8d39\u4e0a\u4e0b\u6587\uff1b  \u53c2\u6570\u4e09\uff1a\u5f53\u524d\u6d88\u8d39\u4efb\u52a1\npublic void processConsumeResult(status, context, consumeRequest)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (status)"}),"\uff1a\u6839\u636e\u6d88\u8d39\u7ed3\u679c\u72b6\u6001\u8fdb\u884c\u5904\u7406"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case CONSUME_SUCCESS"}),"\uff1a\u6d88\u8d39\u6210\u529f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (ackIndex >= consumeRequest.getMsgs().size())"}),"\uff1a\u6d88\u8d39\u6210\u529f\u7684\u8bdd\uff0cackIndex \u8bbe\u7f6e\u6210 ",(0,l.jsx)(n.code,{children:"\u6d88\u8d39\u6d88\u606f\u6570 - 1"})," \u7684\u503c\uff0c\u6bd4\u5982\u6709 5 \u6761\u6d88\u606f\uff0c\u8fd9\u91cc\u5c31\u8bbe\u7f6e\u4e3a 4"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ok, failed"}),"\uff1aok \u8bbe\u7f6e\u4e3a\u6d88\u606f\u6570\u91cf\uff0cfailed \u8bbe\u7f6e\u4e3a 0"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case RECONSUME_LATER"}),"\uff1a\u6d88\u8d39\u5931\u8d25"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ackIndex = -1"}),"\uff1a\u8bbe\u7f6e\u4e3a -1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (this.defaultMQPushConsumer.getMessageModel())"}),"\uff1a\u5224\u65ad\u6d88\u8d39\u6a21\u5f0f\uff0c\u9ed8\u8ba4\u662f",(0,l.jsx)(n.strong,{children:"\u96c6\u7fa4\u6a21\u5f0f"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (int i = ackIndex + 1; i < msgs.size(); i++)"}),"\uff1a\u5f53\u6d88\u8d39\u5931\u8d25\u65f6 ackIndex \u4e3a -1\uff0ci \u7684\u8d77\u59cb\u503c\u4e3a 0\uff0c\u8be5\u6d88\u8d39\u4efb\u52a1\u5185\u7684",(0,l.jsx)(n.strong,{children:"\u5168\u90e8\u6d88\u606f"}),"\u90fd\u4f1a\u5c1d\u8bd5\u56de\u9000\u7ed9\u670d\u52a1\u5668"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"MessageExt msg"}),"\uff1a\u63d0\u53d6\u4e00\u6761\u6d88\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"boolean result = this.sendMessageBack(msg, context)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u53d1\u9001\u6d88\u606f\u56de\u9000\uff0c\u540c\u6b65\u53d1\u9001"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!result)"}),"\uff1a\u56de\u9000\u5931\u8d25\u7684\u6d88\u606f\uff0c\u5c06",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u7684\u91cd\u8bd5\u5c5e\u6027\u52a0 1"}),"\uff0c\u5e76\u52a0\u5165\u5230\u56de\u9000\u5931\u8d25\u7684\u96c6\u5408"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!msgBackFailed.isEmpty())"}),"\uff1a\u56de\u9000\u5931\u8d25\u96c6\u5408\u4e0d\u4e3a\u7a7a"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"consumeRequest.getMsgs().removeAll(msgBackFailed)"}),"\uff1a\u5c06\u56de\u9000\u5931\u8d25\u7684\u6d88\u606f\u4ece\u5f53\u524d\u6d88\u8d39\u4efb\u52a1\u7684 msgs \u96c6\u5408\u5185\u79fb\u9664"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.submitConsumeRequestLater()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u56de\u9000\u5931\u8d25\u7684\u6d88\u606f\u4f1a\u518d\u6b21\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1"}),"\uff0c\u5ef6\u8fdf 5 \u79d2\u949f\u540e\u518d\u6b21\u5c1d\u8bd5\u6d88\u8d39"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"long offset = ...removeMessage(msgs)"}),"\uff1a\u4ece pq \u4e2d\u5220\u9664\u5df2\u7ecf\u6d88\u8d39\u6210\u529f\u7684\u6d88\u606f\uff0c\u8fd4\u56de offset"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this...getOffsetStore().updateOffset()"}),"\uff1a\u66f4\u65b0\u6d88\u8d39\u8005\u672c\u5730\u8be5 mq \u7684",(0,l.jsx)(n.strong,{children:"\u6d88\u8d39\u8fdb\u5ea6"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6d88\u8d39\u8bf7\u6c42",children:"\u6d88\u8d39\u8bf7\u6c42"}),"\n",(0,l.jsx)(n.p,{children:"ConsumeRequest \u662f ConsumeMessageConcurrentlyService \u7684\u5185\u90e8\u7c7b\uff0c\u662f\u4e00\u4e2a Runnable \u4efb\u52a1\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5206\u914d\u5230\u8be5\u6d88\u8d39\u4efb\u52a1\u7684\u6d88\u606f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final List<MessageExt> msgs;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u961f\u5217\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ProcessQueue processQueue;\t// \u6d88\u606f\u5904\u7406\u961f\u5217\nprivate final MessageQueue messageQueue;\t// \u6d88\u606f\u961f\u5217\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u6267\u884c\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (this.processQueue.isDropped())"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u8be5 queue \u7ecf\u8fc7 rbl \u7b97\u6cd5\u5206\u914d\u5230\u5176\u4ed6\u7684 consumer"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"MessageListenerConcurrently listener"}),"\uff1a\u83b7\u53d6\u6d88\u606f\u76d1\u542c\u5668"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ConsumeConcurrentlyContext context"}),"\uff1a\u521b\u5efa\u6d88\u8d39\u4e0a\u4e0b\u6587\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"defaultMQPushConsumerImpl.resetRetryAndNamespace()"}),"\uff1a\u91cd\u7f6e\u91cd\u8bd5\u6807\u8bb0\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"final String groupTopic"}),"\uff1a\u83b7\u53d6\u5f53\u524d\u6d88\u8d39\u8005\u7ec4\u7684\u91cd\u8bd5\u4e3b\u9898 ",(0,l.jsx)(n.code,{children:"%RETRY%GroupName"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (MessageExt msg : msgs)"}),"\uff1a\u904d\u5386\u6240\u6709\u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"String retryTopic = msg.getProperty(...)"}),"\uff1a\u539f\u4e3b\u9898\uff0c\u4e00\u822c\u6d88\u606f\u6ca1\u6709\u8be5\u5c5e\u6027\uff0c\u53ea\u6709\u88ab\u91cd\u590d\u6d88\u8d39\u7684\u6d88\u606f\u624d\u6709"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (retryTopic != null && groupTopic.equals(...))"}),"\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u8be5\u6d88\u606f\u662f\u88ab\u91cd\u590d\u6d88\u8d39\u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"msg.setTopic(retryTopic)"}),"\uff1a\u5c06\u88ab",(0,l.jsx)(n.strong,{children:"\u91cd\u590d\u6d88\u8d39\u7684\u6d88\u606f\u4e3b\u9898\u4fee\u6539\u56de\u539f\u4e3b\u9898"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (ConsumeMessageConcurrentlyService...hasHook())"}),"\uff1a\u524d\u7f6e\u5904\u7406"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"boolean hasException = false"}),"\uff1a\u6d88\u8d39\u8fc7\u7a0b\u4e2d\uff0c\u662f\u5426\u5411\u5916\u629b\u51fa\u5f02\u5e38"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"MessageAccessor.setConsumeStartTimeStamp()"}),"\uff1a\u7ed9\u6bcf\u6761\u6d88\u606f\u8bbe\u7f6e\u6d88\u8d39\u5f00\u59cb\u65f6\u95f4"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"status = listener.consumeMessage(Collections.unmodifiableList(msgs), context)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6d88\u8d39\u6d88\u606f"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (ConsumeMessageConcurrentlyService...hasHook())"}),"\uff1a\u540e\u7f6e\u5904\u7406"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"...processConsumeResult(status, context, this)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u6d88\u8d39\u7ed3\u679c"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u987a\u5e8f\u6d88\u8d39",children:"\u987a\u5e8f\u6d88\u8d39"}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u5c5e\u6027-12",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,l.jsx)(n.p,{children:"ConsumeMessageOrderlyService \u8d1f\u8d23\u987a\u5e8f\u6d88\u8d39\u670d\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u76d1\u542c\u5668\uff1a\u5c01\u88c5\u5904\u7406\u6d88\u606f\u7684\u903b\u8f91\uff0c\u8be5\u76d1\u542c\u5668\u7531\u5f00\u53d1\u8005\u5b9e\u73b0\uff0c\u5e76\u6ce8\u518c\u5230 defaultMQPushConsumer"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final MessageListenerOrderly messageListener;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u5c5e\u6027\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final BlockingQueue<Runnable> consumeRequestQueue;\t// \u6d88\u8d39\u4efb\u52a1\u961f\u5217\nprivate final String consumerGroup;\t\t\t\t\t\t\t// \u6d88\u8d39\u8005\u7ec4\nprivate volatile boolean stopped = false;\t\t\t\t\t// \u6d88\u8d39\u505c\u6b62\u72b6\u6001\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ebf\u7a0b\u6c60\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final ThreadPoolExecutor consumeExecutor;\t\t\t\t// \u6d88\u8d39\u4efb\u52a1\u7ebf\u7a0b\u6c60\nprivate final ScheduledExecutorService scheduledExecutorService;// \u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff0c\u5ef6\u8fdf\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u961f\u5217\u9501\uff1a\u6d88\u8d39\u8005\u672c\u5730 MQ \u9501\uff0c",(0,l.jsx)(n.strong,{children:"\u786e\u4fdd\u672c\u5730\u5bf9\u4e8e\u9700\u8981\u987a\u5e8f\u6d88\u8d39\u7684 MQ \u540c\u4e00\u65f6\u95f4\u53ea\u6709\u4e00\u4e2a\u4efb\u52a1\u5728\u6267\u884c"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private final MessageQueueLock messageQueueLock = new MessageQueueLock();\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class MessageQueueLock {\n    private ConcurrentMap<MessageQueue, Object> mqLockTable = new ConcurrentHashMap<MessageQueue, Object>();\n    // \u83b7\u53d6\u672c\u5730\u961f\u5217\u9501\u5bf9\u8c61\n    public Object fetchLockObject(final MessageQueue mq) {\n        Object objLock = this.mqLockTable.get(mq);\n        if (null == objLock) {\n            objLock = new Object();\n            Object prevLock = this.mqLockTable.putIfAbsent(mq, objLock);\n            if (prevLock != null) {\n                objLock = prevLock;\n            }\n        }\n        return objLock;\n    }\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5df2\u7ecf\u83b7\u53d6\u4e86 Broker \u7aef\u8be5 Queue \u7684\u72ec\u5360\u9501\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u83b7\u53d6\u672c\u5730\u961f\u5217\u9501\u5bf9\u8c61\uff1f\uff08\u8fd9\u91cc\u6211\u4e5f\u6ca1\u592a\u61c2\uff0c\u5148\u8bb0\u5f55\u4e0b\u6765\uff0c\u672c\u5730\u591a\u7ebf\u7a0b\uff1f\uff09"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Broker queue \u5360\u7528\u9501\u7684\u89d2\u5ea6\u662f Client \u5360\u7528\uff0cClient \u4ece Broker \u7684\u67d0\u4e2a\u5360\u7528\u4e86\u9501\u7684 queue \u62c9\u53d6\u4e0b\u6765\u6d88\u606f\u4ee5\u540e\uff0c\u5c06\u6d88\u606f\u5b58\u50a8\u5230\u6d88\u8d39\u8005\u672c\u5730\u7684 ProcessQueue \u4e2d\uff0c\u5feb\u7167\u5bf9\u8c61\u7684 consuming \u5c5e\u6027\u7f6e\u4e3a true\uff0c\u8868\u793a\u672c\u5730\u7684\u961f\u5217\u6b63\u5728\u6d88\u8d39\u5904\u7406\u4e2d"}),"\n",(0,l.jsxs)(n.li,{children:["ProcessQueue  \u8c03\u7528 takeMessages \u65b9\u6cd5\u65f6\u4f1a\u83b7\u53d6\u4e0b\u4e00\u6279\u5f85\u5904\u7406\u7684\u6d88\u606f\uff0c\u83b7\u53d6\u4e0d\u5230\u4f1a\u4fee\u6539 ",(0,l.jsx)(n.code,{children:"consuming = false"}),"\uff0c\u672c\u6d88\u8d39\u4efb\u52a1\u9a6c\u4e0a\u505c\u6b62\u3002"]}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u6b64\u65f6 Pull \u518d\u6b21\u62c9\u53d6\u4e00\u6279\u5f53\u524d ProcessQueue  \u7684 msg\uff0c\u4f1a\u518d\u6b21\u5411\u987a\u5e8f\u6d88\u8d39\u670d\u52a1\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\uff0c\u6b64\u65f6\u9700\u8981\u672c\u5730\u961f\u5217\u9501\u5bf9\u8c61\u540c\u6b65\u672c\u5730\u7ebf\u7a0b"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6210\u5458\u65b9\u6cd5-11",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"start()\uff1a\u542f\u52a8\u6d88\u8d39\u670d\u52a1\uff0cDefaultMQPushConsumerImpl \u542f\u52a8\u65f6\u4f1a\u8c03\u7528\u8be5\u65b9\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void start()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.scheduledExecutorService.scheduleAtFixedRate()"}),"\uff1a\u63d0\u4ea4\u9501\u7eed\u7ea6\u4efb\u52a1\uff0c\u5ef6\u8fdf 1 \u79d2\u6267\u884c\uff0c\u5468\u671f\u4e3a 20 \u79d2\u949f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ConsumeMessageOrderlyService.this.lockMQPeriodically()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u9501\u7eed\u7ea6\u4efb\u52a1"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.defaultMQPushConsumerImpl.getRebalanceImpl().lockAll()"}),"\uff1a\u5bf9\u6d88\u8d39\u8005\u7684\u6240\u6709\u961f\u5217\u8fdb\u884c\u7eed\u7ea6"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["submitConsumeRequest()\uff1a",(0,l.jsx)(n.strong,{children:"\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\u8bf7\u6c42"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u6570\uff1atrue \u8868\u793a\u521b\u5efa\u6d88\u8d39\u4efb\u52a1\u5e76\u63d0\u4ea4\uff0cfalse\u4e0d\u521b\u5efa\u6d88\u8d39\u4efb\u52a1\uff0c\u8bf4\u660e\u6d88\u8d39\u8005\u672c\u5730\u5df2\u7ecf\u6709\u6d88\u8d39\u4efb\u52a1\u5728\u6267\u884c\u4e86\npublic void submitConsumeRequest(...., final boolean dispathToConsume) {\n    if (dispathToConsume) {\n        // \u5f53\u524d\u8fdb\u7a0b\u5185\u4e0d\u5b58\u5728 \u987a\u5e8f\u6d88\u8d39\u4efb\u52a1\uff0c\u521b\u5efa\u65b0\u7684\u6d88\u8d39\u4efb\u52a1\uff0c\u3010\u63d0\u4ea4\u5230\u6d88\u8d39\u4efb\u52a1\u7ebf\u7a0b\u6c60\u3011\n        ConsumeRequest consumeRequest = new ConsumeRequest(processQueue, messageQueue);\n        this.consumeExecutor.submit(consumeRequest);\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"processConsumeResult()\uff1a\u6d88\u8d39\u7ed3\u679c\u5904\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53c2\u65701\uff1amsgs \u672c\u8f6e\u5faa\u73af\u6d88\u8d39\u7684\u6d88\u606f\u96c6\u5408    \t\t\t\t\t\u53c2\u65702\uff1astatus  \u6d88\u8d39\u72b6\u6001\n// \u53c2\u65703\uff1acontext \u6d88\u8d39\u4e0a\u4e0b\u6587 \t\t\t\t\t\t\t\u53c2\u65704\uff1a\u6d88\u8d39\u4efb\u52a1\n// \u8fd4\u56de\u503c\uff1aboolean \u51b3\u5b9a\u662f\u5426\u7ee7\u7eed\u5faa\u73af\u5904\u7406pq\u5185\u7684\u6d88\u606f\npublic boolean processConsumeResult(final List<MessageExt> msgs, final ConsumeOrderlyStatus status, final ConsumeOrderlyContext context, final ConsumeRequest consumeRequest)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (context.isAutoCommit()) "}),"\uff1a\u9ed8\u8ba4\u81ea\u52a8\u63d0\u4ea4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"switch (status)"}),"\uff1a\u6839\u636e\u6d88\u8d39\u72b6\u6001\u8fdb\u884c\u4e0d\u540c\u7684\u5904\u7406"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case SUCCESS"}),"\uff1a\u6d88\u8d39\u6210\u529f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"commitOffset = ...commit()"}),"\uff1a\u8c03\u7528 pq \u63d0\u4ea4\u65b9\u6cd5\uff0c\u4f1a\u5c06\u672c\u6b21\u5faa\u73af\u5904\u7406\u7684\u6d88\u606f\u4ece\u987a\u5e8f\u6d88\u8d39 map \u5220\u9664\uff0c\u5e76\u4e14\u8fd4\u56de\u6d88\u606f\u8fdb\u5ea6"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"case SUSPEND_CURRENT_QUEUE_A_MOMENT"}),"\uff1a\u6302\u8d77\u5f53\u524d\u961f\u5217"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"consumeRequest.getProcessQueue().makeMessageToConsumeAgain(msgs)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u56de\u6eda\u6d88\u606f"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"for (MessageExt msg : msgs)"}),"\uff1a\u904d\u5386\u6240\u6709\u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.consumingMsgOrderlyTreeMap.remove(msg.getQueueOffset())"}),"\uff1a\u4ece\u987a\u5e8f\u6d88\u8d39\u4e34\u65f6\u5bb9\u5668\u4e2d\u79fb\u9664"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"this.msgTreeMap.put(msg.getQueueOffset(), msg)"}),"\uff1a\u6dfb\u52a0\u5230\u6d88\u606f\u5bb9\u5668"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.submitConsumeRequestLater()"}),"\uff1a\u518d\u6b21\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\uff0c1 \u79d2\u540e\u6267\u884c"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"continueConsume = false"}),"\uff1a\u8bbe\u7f6e\u4e3a false\uff0c",(0,l.jsx)(n.strong,{children:"\u5916\u5c42\u4f1a\u9000\u51fa\u672c\u6b21\u7684\u6d88\u8d39\u4efb\u52a1"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(...)"}),"\uff1a\u66f4\u65b0\u672c\u5730\u6d88\u8d39\u8fdb\u5ea6"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h5,{id:"\u6d88\u8d39\u8bf7\u6c42-1",children:"\u6d88\u8d39\u8bf7\u6c42"}),"\n",(0,l.jsx)(n.p,{children:"ConsumeRequest \u662f ConsumeMessageOrderlyService \u7684\u5185\u90e8\u7c7b\uff0c\u662f\u4e00\u4e2a Runnable \u4efb\u52a1\u5bf9\u8c61"}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u65b9\u6cd5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"run()\uff1a\u6267\u884c\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run()\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final Object objLock"}),"\uff1a\u83b7\u53d6\u672c\u5730\u9501\u5bf9\u8c61"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"synchronized (objLock)"}),"\uff1a\u672c\u5730\u961f\u5217\u9501\uff0c\u786e\u4fdd\u6bcf\u4e2a MQ \u7684\u6d88\u8d39\u4efb\u52a1\u53ea\u6709\u4e00\u4e2a\u5728\u6267\u884c\uff0c",(0,l.jsx)(n.strong,{children:"\u786e\u4fdd\u987a\u5e8f\u6d88\u8d39"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if(.. || (this.processQueue.isLocked() && !this.processQueue.isLockExpired())))"}),"\uff1a\u5f53\u524d\u961f\u5217\u6301\u6709\u5206\u5e03\u5f0f\u9501\uff0c\u5e76\u4e14\u9501\u672a\u8fc7\u671f\uff0c\u6301\u9501\u65f6\u95f4\u8d85\u8fc7 30 \u79d2\u7b97\u8fc7\u671f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final long beginTime"}),"\uff1a\u6d88\u8d39\u5f00\u59cb\u65f6\u95f4"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"for (boolean continueConsume = true; continueConsume; )"}),"\uff1a\u6839\u636e\u662f\u5426\u7ee7\u7eed\u6d88\u8d39\u7684\u6807\u8bb0\u5224\u65ad\u662f\u5426\u7ee7\u7eed"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final int consumeBatchSize"}),"\uff1a\u83b7\u53d6\u6bcf\u6b21\u5faa\u73af\u5904\u7406\u7684\u6d88\u606f\u6570\u91cf\uff0c\u4e00\u822c\u662f 1"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"List<MessageExt> msgs = this...takeMessages(consumeBatchSize)"}),"\uff1a\u5230",(0,l.jsx)(n.strong,{children:"\u5904\u7406\u961f\u5217\u83b7\u53d6\u4e00\u6279\u6d88\u606f"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (!msgs.isEmpty())"}),"\uff1a\u83b7\u53d6\u5230\u4e86\u5f85\u6d88\u8d39\u7684\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"final ConsumeOrderlyContext context"}),"\uff1a\u521b\u5efa\u6d88\u8d39\u4e0a\u4e0b\u6587\u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.processQueue.getLockConsume().lock()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6 lockConsume \u9501"}),"\uff0c\u4e0e RBL \u7ebf\u7a0b\u540c\u6b65\u4f7f\u7528"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"status = messageListener.consumeMessage(...)"}),"\uff1a\u76d1\u542c\u5668\u5904\u7406\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"this.processQueue.getLockConsume().unlock()"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u91ca\u653e lockConsume \u9501"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (null == status)"}),"\uff1a\u5904\u7406\u6d88\u606f\u72b6\u6001\u8fd4\u56de null\uff0c\u8bbe\u7f6e\u72b6\u6001\u4e3a\u6302\u8d77\u5f53\u524d\u961f\u5217"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"continueConsume = ...processConsumeResult()"}),"\uff1a\u6d88\u8d39\u7ed3\u679c\u5904\u7406"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u83b7\u53d6\u5230\u7684\u6d88\u606f\u662f\u7a7a"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"continueConsume = false"}),"\uff1a\u7ed3\u675f\u4efb\u52a1\u5faa\u73af"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u5f53\u524d\u961f\u5217\u672a\u6301\u6709\u5206\u5e03\u5f0f\u9501\uff0c\u6216\u8005\u9501\u8fc7\u671f"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume()"}),"\uff1a\u91cd\u65b0\u63d0\u4ea4\u4efb\u52a1\uff0c\u6839\u636e\u662f\u5426\u83b7\u53d6\u5230\u961f\u5217\u9501\uff0c\u9009\u62e9\u5ef6\u8fdf 10 \u6beb\u79d2\u6216\u8005 300 \u6beb\u79d2"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u751f\u4ea7\u6d88\u8d39-1",children:"\u751f\u4ea7\u6d88\u8d39"}),"\n",(0,l.jsx)(n.p,{children:"\u751f\u4ea7\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u9996\u5148\u83b7\u53d6\u5f53\u524d\u6d88\u606f\u4e3b\u9898\u7684\u53d1\u5e03\u4fe1\u606f\uff0c\u83b7\u53d6\u4e0d\u5230\u53bb Namesrv \u83b7\u53d6\uff08\u9ed8\u8ba4\u6709 TBW102\uff09\uff0c\u5e76\u5c06\u83b7\u53d6\u7684\u5230\u7684\u8def\u7531\u6570\u636e\u8f6c\u5316\u4e3a\u53d1\u5e03\u6570\u636e\uff0c",(0,l.jsx)(n.strong,{children:"\u521b\u5efa MQ \u961f\u5217\u5728\u591a\u4e2a Broker \u7ec4"}),"\uff08\u4e00\u7ec4\u4ee3\u8868\u4e00\u4e3b\u591a\u4ece\u7684 Broker \u67b6\u6784\uff09\uff0c\u5ba2\u6237\u7aef\u5b9e\u4f8b\u540c\u6837\u66f4\u65b0\u8ba2\u9605\u6570\u636e\uff0c\u521b\u5efa MQ \u961f\u5217\uff0c\u653e\u5165\u8d1f\u8f7d\u5747\u8861\u670d\u52a1 topicSubscribeInfoTable \u4e2d"]}),"\n",(0,l.jsx)(n.li,{children:"\u7136\u540e\u4ece\u53d1\u5e03\u6570\u636e\u4e2d\u9009\u62e9\u4e00\u4e2a MQ \u961f\u5217\u53d1\u9001\u6d88\u606f"}),"\n",(0,l.jsxs)(n.li,{children:["Broker \u7aef\u901a\u8fc7 SendMessageProcessor \u5bf9\u53d1\u9001\u7684\u6d88\u606f\u8fdb\u884c\u6301\u4e45\u5316\u5904\u7406\uff0c\u5b58\u50a8\u5230 CommitLog\u3002\u5c06\u91cd\u8bd5\u6b21\u6570\u8fc7\u591a\u7684\u6d88\u606f\u52a0\u5165",(0,l.jsx)(n.strong,{children:"\u6b7b\u4fe1\u961f\u5217"}),"\uff0c\u5c06\u5ef6\u8fdf\u6d88\u606f\u7684\u4e3b\u9898\u548c\u961f\u5217\u4fee\u6539\u4e3a\u8c03\u5ea6\u4e3b\u9898\u548c\u8c03\u5ea6\u961f\u5217 ID"]}),"\n",(0,l.jsx)(n.li,{children:"Broker \u542f\u52a8 ScheduleMessageService \u670d\u52a1\u4f1a\u4e3a\u6bcf\u4e2a\u5ef6\u8fdf\u7ea7\u522b\u521b\u5efa\u4e00\u4e2a\u5ef6\u8fdf\u4efb\u52a1\uff0c\u8ba9\u5ef6\u8fdf\u6d88\u606f\u5f97\u5230\u6709\u6548\u7684\u5904\u7406\uff0c\u5c06\u5230\u8fbe\u4ea4\u4ed8\u65f6\u95f4\u7684\u6d88\u606f\u4fee\u6539\u4e3a\u539f\u59cb\u4e3b\u9898\u7684\u539f\u59cb ID \u5b58\u5165 CommitLog\uff0c\u6d88\u8d39\u8005\u5c31\u53ef\u4ee5\u8fdb\u884c\u6d88\u8d39\u4e86"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u8d39\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6d88\u606f\u6d88\u8d39\u961f\u5217 ConsumerQueue \u5b58\u50a8\u6d88\u606f\u5728 CommitLog \u7684\u7d22\u5f15\uff0c\u6d88\u8d39\u8005\u901a\u8fc7\u8be5\u961f\u5217\u6765\u8bfb\u53d6\u6d88\u606f\u5b9e\u4f53\u5185\u5bb9\uff0c\u4e00\u4e2a MQ \u5c31\u5bf9\u5e94\u4e00\u4e2a CQ"}),"\n",(0,l.jsx)(n.li,{children:"\u9996\u5148\u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u670d\u52a1\uff0c\u5c06\u5206\u914d\u5230\u5f53\u524d\u6d88\u8d39\u8005\u5b9e\u4f8b\u7684 MQ \u521b\u5efa PullRequest\uff0c\u5e76\u653e\u5165 PullMessageService \u7684\u672c\u5730\u963b\u585e\u961f\u5217\u5185"}),"\n",(0,l.jsxs)(n.li,{children:["PullMessageService \u5faa\u73af\u4ece\u963b\u585e\u961f\u5217\u83b7\u53d6\u8bf7\u6c42\u5bf9\u8c61\uff0c\u53d1\u8d77\u62c9\u6d88\u606f\u8bf7\u6c42\uff0c\u5e76\u521b\u5efa PullCallback \u56de\u8c03\u5bf9\u8c61\uff0c\u5c06\u6b63\u5e38\u62c9\u53d6\u7684\u6d88\u606f",(0,l.jsx)(n.strong,{children:"\u63d0\u4ea4\u5230\u6d88\u8d39\u4efb\u52a1\u7ebf\u7a0b\u6c60"}),"\uff0c\u5e76\u8bbe\u7f6e\u8bf7\u6c42\u7684\u4e0b\u4e00\u6b21\u62c9\u53d6\u4f4d\u70b9\uff0c\u91cd\u65b0\u653e\u5165\u963b\u585e\u961f\u5217\uff0c\u5f62\u6210\u95ed\u73af"]}),"\n",(0,l.jsx)(n.li,{children:"\u6d88\u8d39\u4efb\u52a1\u670d\u52a1\u5bf9\u6d88\u8d39\u5931\u8d25\u7684\u6d88\u606f\u8fdb\u884c\u56de\u9000\uff0c\u901a\u8fc7\u5185\u90e8\u751f\u4ea7\u8005\u5b9e\u4f8b\u53d1\u9001\u56de\u9000\u6d88\u606f\uff0c\u56de\u9000\u5931\u8d25\u7684\u6d88\u606f\u4f1a\u518d\u6b21\u63d0\u4ea4\u6d88\u8d39\u4efb\u52a1\u91cd\u65b0\u6d88\u8d39"}),"\n",(0,l.jsxs)(n.li,{children:["Broker \u7aef\u5bf9\u62c9\u53d6\u6d88\u606f\u7684\u8bf7\u6c42\u8fdb\u884c\u5904\u7406\uff08processRequestCommand\uff09\uff0c\u67e5\u8be2\u6210\u529f\u5c06\u6d88\u606f\u653e\u5165\u54cd\u5e94\u4f53\uff0c\u901a\u8fc7 Netty \u5199\u56de\u5ba2\u6237\u7aef\uff0c\u5f53 ",(0,l.jsx)(n.code,{children:"pullRequest.offset == queue.maxOffset"})," \u8bf4\u660e\u8be5\u961f\u5217\u5df2\u7ecf\u6ca1\u6709\u9700\u8981\u83b7\u53d6\u7684\u6d88\u606f\uff0c\u5c06\u8bf7\u6c42\u653e\u5165\u957f\u8f6e\u8be2\u96c6\u5408\u7b49\u5f85\u6709\u65b0\u6d88\u606f"]}),"\n",(0,l.jsx)(n.li,{children:"PullRequestHoldService \u8d1f\u8d23\u957f\u8f6e\u8be2\uff0c\u6bcf 5 \u79d2\u904d\u5386\u4e00\u6b21\u957f\u8f6e\u8be2\u96c6\u5408\uff0c\u5c06\u6ee1\u8db3\u6761\u4ef6\u7684 PullRequest \u518d\u6b21\u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\u5185\u5904\u7406"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h1,{id:"zookeeper",children:"Zookeeper"}),"\n",(0,l.jsx)(n.h2,{id:"\u57fa\u672c\u4ecb\u7ecd-7",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.h3,{id:"\u6846\u67b6\u7279\u5f81",children:"\u6846\u67b6\u7279\u5f81"}),"\n",(0,l.jsx)(n.p,{children:"Zookeeper \u662f Apache Hadoop \u9879\u76ee\u5b50\u9879\u76ee\uff0c\u4e3a\u5206\u5e03\u5f0f\u6846\u67b6\u63d0\u4f9b\u534f\u8c03\u670d\u52a1\uff0c\u662f\u4e00\u4e2a\u6811\u5f62\u76ee\u5f55\u670d\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"Zookeeper \u662f\u57fa\u4e8e\u89c2\u5bdf\u8005\u6a21\u5f0f\u8bbe\u8ba1\u7684\u5206\u5e03\u5f0f\u670d\u52a1\u7ba1\u7406\u6846\u67b6\uff0c\u8d1f\u8d23\u5b58\u50a8\u548c\u7ba1\u7406\u5171\u4eab\u6570\u636e\uff0c\u63a5\u53d7\u89c2\u5bdf\u8005\u7684\u6ce8\u518c\u76d1\u63a7\uff0c\u4e00\u65e6\u8fd9\u4e9b\u6570\u636e\u7684\u72b6\u6001\u53d1\u751f\u53d8\u5316\uff0cZookeeper \u4f1a\u901a\u77e5\u89c2\u5bdf\u8005"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Zookeeper \u662f\u4e00\u4e2a\u9886\u5bfc\u8005\uff08Leader\uff09\uff0c\u591a\u4e2a\u8ddf\u968f\u8005\uff08Follower\uff09\u7ec4\u6210\u7684\u96c6\u7fa4"}),"\n",(0,l.jsx)(n.li,{children:"\u96c6\u7fa4\u4e2d\u53ea\u8981\u6709\u534a\u6570\u4ee5\u4e0a\u8282\u70b9\u5b58\u6d3b\u5c31\u80fd\u6b63\u5e38\u670d\u52a1\uff0c\u6240\u4ee5 Zookeeper \u9002\u5408\u90e8\u7f72\u5947\u6570\u53f0\u670d\u52a1\u5668"}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u5168\u5c40\u6570\u636e\u4e00\u81f4"}),"\uff0c\u6bcf\u4e2a Server \u4fdd\u5b58\u4e00\u4efd\u76f8\u540c\u7684\u6570\u636e\u526f\u672c\uff0cClient \u65e0\u8bba\u8fde\u63a5\u5230\u54ea\u4e2a Server\uff0c\u6570\u636e\u90fd\u662f\u4e00\u81f4"]}),"\n",(0,l.jsx)(n.li,{children:"\u66f4\u65b0\u7684\u8bf7\u6c42\u987a\u5e8f\u6267\u884c\uff0c\u6765\u81ea\u540c\u4e00\u4e2a Client \u7684\u8bf7\u6c42\u6309\u5176\u53d1\u9001\u987a\u5e8f\u4f9d\u6b21\u6267\u884c"}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u6570\u636e\u66f4\u65b0\u539f\u5b50\u6027"}),"\uff0c\u4e00\u6b21\u6570\u636e\u66f4\u65b0\u8981\u4e48\u6210\u529f\uff0c\u8981\u4e48\u5931\u8d25"]}),"\n",(0,l.jsx)(n.li,{children:"\u5b9e\u65f6\u6027\uff0c\u5728\u4e00\u5b9a\u7684\u65f6\u95f4\u8303\u56f4\u5185\uff0cClient \u80fd\u8bfb\u5230\u6700\u65b0\u6570\u636e"}),"\n",(0,l.jsx)(n.li,{children:"\u5fc3\u8df3\u68c0\u6d4b\uff0c\u4f1a\u5b9a\u65f6\u5411\u5404\u4e2a\u670d\u52a1\u63d0\u4f9b\u8005\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff08\u5b9e\u9645\u4e0a\u5efa\u7acb\u7684\u662f\u4e00\u4e2a Socket \u957f\u8fde\u63a5\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(13794).A+"",width:"1011",height:"296"})}),"\n",(0,l.jsxs)(n.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,l.jsx)(n.a,{href:"https://www.bilibili.com/video/BV1to4y1C7gw",children:"https://www.bilibili.com/video/BV1to4y1C7gw"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5e94\u7528\u573a\u666f-1",children:"\u5e94\u7528\u573a\u666f"}),"\n",(0,l.jsx)(n.p,{children:"Zookeeper \u63d0\u4f9b\u7684\u4e3b\u8981\u529f\u80fd\u5305\u62ec\uff1a\u7edf\u4e00\u547d\u540d\u670d\u52a1\u3001\u7edf\u4e00\u914d\u7f6e\u7ba1\u7406\u3001\u7edf\u4e00\u96c6\u7fa4\u7ba1\u7406\u3001\u670d\u52a1\u5668\u8282\u70b9\u52a8\u6001\u4e0a\u4e0b\u7ebf\u3001\u8f6f\u8d1f\u8f7d\u5747\u8861\u3001\u5206\u5e03\u5f0f\u9501\u7b49"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5728\u5206\u5e03\u5f0f\u73af\u5883\u4e2d\uff0c\u7ecf\u5e38\u5bf9\u5e94\u7528/\u670d\u52a1\u8fdb\u884c\u7edf\u4e00\u547d\u540d\uff0c\u4fbf\u4e8e\u8bc6\u522b\uff0c\u4f8b\u5982\u57df\u540d\u76f8\u5bf9\u4e8e IP \u5730\u5740\u66f4\u5bb9\u6613\u88ab\u63a5\u6536"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"/service/www.baidu.com \t\t# \u8282\u70b9\u8def\u5f84\n192.168.1.1  192.168.1.2\t# \u8282\u70b9\u503c\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u5728\u8282\u70b9\u4e2d\u8bb0\u5f55\u6bcf\u53f0\u670d\u52a1\u5668\u7684\u8bbf\u95ee\u6570\uff0c\u8ba9\u8bbf\u95ee\u6570\u6700\u5c11\u7684\u670d\u52a1\u5668\u53bb\u5904\u7406\u6700\u65b0\u7684\u5ba2\u6237\u7aef\u8bf7\u6c42\uff0c\u53ef\u4ee5\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"192.168.1.1  10\t# \u6b21\u6570\n192.168.1.1  15\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u6587\u4ef6\u540c\u6b65\u53ef\u4ee5\u901a\u8fc7 Zookeeper \u5b9e\u73b0\uff0c\u5c06\u914d\u7f6e\u4fe1\u606f\u5199\u5165\u67d0\u4e2a ZNode\uff0c\u5176\u4ed6\u5ba2\u6237\u7aef\u76d1\u89c6\u8be5\u8282\u70b9\uff0c\u5f53\u8282\u70b9\u6570\u636e\u88ab\u4fee\u6539\uff0c\u901a\u77e5\u5404\u4e2a\u5ba2\u6237\u7aef\u670d\u52a1\u5668"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u96c6\u7fa4\u73af\u5883\u4e2d\uff0c\u9700\u8981\u5b9e\u65f6\u638c\u63e1\u6bcf\u4e2a\u96c6\u7fa4\u8282\u70b9\u7684\u72b6\u6001\uff0c\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u4fe1\u606f\u653e\u5165 ZNode\uff0c\u901a\u8fc7\u76d1\u63a7\u901a\u77e5\u7684\u673a\u5236\u5b9e\u73b0"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b9e\u73b0\u5ba2\u6237\u7aef\u5b9e\u65f6\u89c2\u5bdf\u670d\u52a1\u5668\u4e0a\u4e0b\u7ebf\u7684\u53d8\u5316\uff0c\u901a\u8fc7\u5fc3\u8df3\u68c0\u6d4b\u5b9e\u73b0"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u57fa\u672c\u64cd\u4f5c",children:"\u57fa\u672c\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h3,{id:"\u5b89\u88c5\u642d\u5efa",children:"\u5b89\u88c5\u642d\u5efa"}),"\n",(0,l.jsx)(n.p,{children:"\u5b89\u88c5\u6b65\u9aa4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5b89\u88c5 JDK"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u62f7\u8d1d apache-zookeeper-3.5.7-bin.tar.gz \u5b89\u88c5\u5305\u5230 Linux \u7cfb\u7edf\u4e0b\uff0c\u5e76\u89e3\u538b\u5230\u6307\u5b9a\u76ee\u5f55"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"conf \u76ee\u5f55\u4e0b\u7684\u914d\u7f6e\u6587\u4ef6\u91cd\u547d\u540d\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"mv zoo_sample.cfg zoo.cfg\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"vim zoo.cfg\n# \u4fee\u6539\u5185\u5bb9\ndataDir=/home/seazean/SoftWare/zookeeper-3.5.7/zkData \n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5728\u5bf9\u5e94\u76ee\u5f55\u521b\u5efa zkData \u6587\u4ef6\u5939\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"mkdir zkData\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Zookeeper \u4e2d\u7684\u914d\u7f6e\u6587\u4ef6 zoo.cfg \u4e2d\u53c2\u6570\u542b\u4e49\u89e3\u8bfb\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["tickTime = 2000\uff1a\u901a\u4fe1\u5fc3\u8df3\u65f6\u95f4\uff0c",(0,l.jsx)(n.strong,{children:"Zookeeper \u670d\u52a1\u5668\u4e0e\u5ba2\u6237\u7aef\u5fc3\u8df3"}),"\u65f6\u95f4\uff0c\u5355\u4f4d\u6beb\u79d2"]}),"\n",(0,l.jsx)(n.li,{children:"initLimit = 10\uff1aLeader \u4e0e Follower \u521d\u59cb\u901a\u4fe1\u65f6\u9650\uff0c\u521d\u59cb\u8fde\u63a5\u65f6\u80fd\u5bb9\u5fcd\u7684\u6700\u591a\u5fc3\u8df3\u6b21\u6570"}),"\n",(0,l.jsxs)(n.li,{children:["syncLimit = 5\uff1aLeader \u4e0e Follower \u540c\u6b65\u901a\u4fe1\u65f6\u9650\uff0cLF \u901a\u4fe1\u65f6\u95f4\u8d85\u8fc7 ",(0,l.jsx)(n.code,{children:"syncLimit * tickTime"}),"\uff0cLeader \u8ba4\u4e3a Follwer \u4e0b\u7ebf"]}),"\n",(0,l.jsx)(n.li,{children:"dataDir\uff1a\u4fdd\u5b58 Zookeeper \u4e2d\u7684\u6570\u636e\u76ee\u5f55\uff0c\u9ed8\u8ba4\u662f tmp\u76ee\u5f55\uff0c\u5bb9\u6613\u88ab Linux \u7cfb\u7edf\u5b9a\u671f\u5220\u9664\uff0c\u6240\u4ee5\u5efa\u8bae\u4fee\u6539"}),"\n",(0,l.jsx)(n.li,{children:"clientPort = 2181\uff1a\u5ba2\u6237\u7aef\u8fde\u63a5\u7aef\u53e3\uff0c\u901a\u5e38\u4e0d\u505a\u4fee\u6539"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u64cd\u4f5c\u547d\u4ee4",children:"\u64cd\u4f5c\u547d\u4ee4"}),"\n",(0,l.jsx)(n.h4,{id:"\u670d\u52a1\u7aef",children:"\u670d\u52a1\u7aef"}),"\n",(0,l.jsx)(n.p,{children:"Linux \u547d\u4ee4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u542f\u52a8 ZooKeeper \u670d\u52a1\uff1a",(0,l.jsx)(n.code,{children:"./zkServer.sh start"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u67e5\u770b ZooKeeper \u670d\u52a1\uff1a",(0,l.jsx)(n.code,{children:"./zkServer.sh status"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u505c\u6b62 ZooKeeper \u670d\u52a1\uff1a",(0,l.jsx)(n.code,{children:"./zkServer.sh stop"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u91cd\u542f ZooKeeper \u670d\u52a1\uff1a",(0,l.jsx)(n.code,{children:"./zkServer.sh restart "})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u67e5\u770b\u8fdb\u7a0b\u662f\u5426\u542f\u52a8\uff1a",(0,l.jsx)(n.code,{children:"jps"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5ba2\u6237\u7aef",children:"\u5ba2\u6237\u7aef"}),"\n",(0,l.jsx)(n.p,{children:"Linux \u547d\u4ee4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u8fde\u63a5 ZooKeeper \u670d\u52a1\u7aef\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"./zkCli.sh\t\t\t\t\t# \u76f4\u63a5\u542f\u52a8\n./zkCli.sh \u2013server ip:port\t# \u6307\u5b9a host \u542f\u52a8\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u547d\u4ee4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u57fa\u7840\u64cd\u4f5c\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"quit\t\t\t\t\t\t# \u505c\u6b62\u8fde\u63a5\nhelp\t\t\t\t\t\t# \u67e5\u770b\u547d\u4ee4\u5e2e\u52a9\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u521b\u5efa\u547d\u4ee4\uff1a",(0,l.jsxs)(n.strong,{children:[(0,l.jsx)(n.code,{children:"/"})," \u4ee3\u8868\u6839\u76ee\u5f55"]})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"create /path value\t\t\t# \u521b\u5efa\u8282\u70b9\uff0cvalue \u53ef\u9009\ncreate -e /path value\t\t# \u521b\u5efa\u4e34\u65f6\u8282\u70b9\ncreate -s /path value\t\t# \u521b\u5efa\u987a\u5e8f\u8282\u70b9\ncreate -es /path value  \t# \u521b\u5efa\u4e34\u65f6\u987a\u5e8f\u8282\u70b9\uff0c\u6bd4\u5982node10000012 \u5220\u966412\u540e\u4e5f\u4f1a\u7ee7\u7eed\u4ece13\u5f00\u59cb\uff0c\u53ea\u4f1a\u589e\u52a0\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u67e5\u8be2\u547d\u4ee4\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"ls /path\t\t\t\t\t# \u663e\u793a\u6307\u5b9a\u76ee\u5f55\u4e0b\u5b50\u8282\u70b9\nls \u2013s /path\t\t\t\t\t# \u67e5\u8be2\u8282\u70b9\u8be6\u7ec6\u4fe1\u606f\nls \u2013w /path\t\t\t\t\t# \u76d1\u542c\u5b50\u8282\u70b9\u6570\u91cf\u7684\u53d8\u5316\nstat /path\t\t\t\t\t# \u67e5\u770b\u8282\u70b9\u72b6\u6001\nget \u2013s /path\t\t\t\t# \u67e5\u8be2\u8282\u70b9\u8be6\u7ec6\u4fe1\u606f\nget \u2013w /path\t\t\t\t# \u76d1\u542c\u8282\u70b9\u6570\u636e\u7684\u53d8\u5316\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"# \u5c5e\u6027\uff0c\u5206\u4e3a\u5f53\u524d\u8282\u70b9\u7684\u5c5e\u6027\u548c\u5b50\u8282\u70b9\u5c5e\u6027\nczxid: \u8282\u70b9\u88ab\u521b\u5efa\u7684\u4e8b\u52a1ID, \u662fZooKeeper\u4e2d\u6240\u6709\u4fee\u6539\u603b\u7684\u6b21\u5e8f\uff0c\u6bcf\u6b21\u4fee\u6539\u90fd\u6709\u552f\u4e00\u7684 zxid\uff0c\u8c01\u5c0f\u8c01\u5148\u53d1\u751f\nctime: \u88ab\u521b\u5efa\u7684\u65f6\u95f4\u6233\nmzxid: \u6700\u540e\u4e00\u6b21\u88ab\u66f4\u65b0\u7684\u4e8b\u52a1ID \nmtime: \u6700\u540e\u4fee\u6539\u7684\u65f6\u95f4\u6233\npzxid: \u5b50\u8282\u70b9\u5217\u8868\u6700\u540e\u4e00\u6b21\u88ab\u66f4\u65b0\u7684\u4e8b\u52a1ID\ncversion: \u5b50\u8282\u70b9\u7684\u53d8\u5316\u53f7\uff0c\u4fee\u6539\u6b21\u6570\ndataversion: \u8282\u70b9\u7684\u6570\u636e\u53d8\u5316\u53f7\uff0c\u6570\u636e\u7684\u53d8\u5316\u6b21\u6570\naclversion: \u8282\u70b9\u7684\u8bbf\u95ee\u63a7\u5236\u5217\u8868\u53d8\u5316\u53f7\nephemeralOwner: \u7528\u4e8e\u4e34\u65f6\u8282\u70b9\uff0c\u4ee3\u8868\u8282\u70b9\u62e5\u6709\u8005\u7684 session id\uff0c\u5982\u679c\u4e3a\u6301\u4e45\u8282\u70b9\u5219\u4e3a0 \ndataLength: \u8282\u70b9\u5b58\u50a8\u7684\u6570\u636e\u7684\u957f\u5ea6 \nnumChildren: \u5f53\u524d\u8282\u70b9\u7684\u5b50\u8282\u70b9\u6570\u91cf\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5220\u9664\u547d\u4ee4\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"delete /path\t\t\t\t# \u5220\u9664\u8282\u70b9\ndeleteall /path\t\t\t\t# \u9012\u5f52\u5220\u9664\u8282\u70b9\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6570\u636e\u7ed3\u6784",children:"\u6570\u636e\u7ed3\u6784"}),"\n",(0,l.jsx)(n.p,{children:"ZooKeeper \u662f\u4e00\u4e2a\u6811\u5f62\u76ee\u5f55\u670d\u52a1\uff0c\u7c7b\u4f3c Unix \u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u88ab\u79f0\u4e3a ZNode\uff0c\u6bcf\u4e2a ZNode \u9ed8\u8ba4\u5b58\u50a8 1MB \u7684\u6570\u636e\uff0c\u8282\u70b9\u4e0a\u4f1a\u4fdd\u5b58\u6570\u636e\u548c\u8282\u70b9\u4fe1\u606f\uff0c\u6bcf\u4e2a ZNode \u90fd\u53ef\u4ee5\u901a\u8fc7\u5176\u8def\u5f84\u552f\u4e00\u6807\u8bc6"}),"\n",(0,l.jsx)(n.p,{children:"\u8282\u70b9\u53ef\u4ee5\u5206\u4e3a\u56db\u5927\u7c7b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"PERSISTENT\uff1a\u6301\u4e45\u5316\u8282\u70b9"}),"\n",(0,l.jsxs)(n.li,{children:["EPHEMERAL\uff1a\u4e34\u65f6\u8282\u70b9\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7aef",(0,l.jsx)(n.strong,{children:"\u65ad\u5f00\u8fde\u63a5"}),"\u540e\uff0c\u521b\u5efa\u7684\u8282\u70b9\u5220\u9664"]}),"\n",(0,l.jsxs)(n.li,{children:["PERSISTENT_SEQUENTIAL\uff1a\u6301\u4e45\u5316\u987a\u5e8f\u8282\u70b9\uff0c\u521b\u5efa znode \u65f6\u8bbe\u7f6e\u987a\u5e8f\u6807\u8bc6\uff0c\u8282\u70b9\u540d\u79f0\u540e\u4f1a\u9644\u52a0\u4e00\u4e2a\u503c\uff0c",(0,l.jsx)(n.strong,{children:"\u987a\u5e8f\u53f7\u662f\u4e00\u4e2a\u5355\u8c03\u9012\u589e\u7684\u8ba1\u6570\u5668"}),"\uff0c\u7531\u7236\u8282\u70b9\u7ef4\u62a4"]}),"\n",(0,l.jsx)(n.li,{children:"EPHEMERAL_SEQUENTIAL\uff1a\u4e34\u65f6\u987a\u5e8f\u8282\u70b9"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0c\u987a\u5e8f\u53f7\u53ef\u4ee5\u88ab\u7528\u4e8e\u4e3a\u6240\u6709\u7684\u4e8b\u4ef6\u8fdb\u884c\u5168\u5c40\u6392\u5e8f\uff0c\u8fd9\u6837\u5ba2\u6237\u7aef\u53ef\u4ee5\u901a\u8fc7\u987a\u5e8f\u53f7\u63a8\u65ad\u4e8b\u4ef6\u7684\u987a\u5e8f"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(63860).A+"",width:"1302",height:"410"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u4ee3\u7801\u5b9e\u73b0-5",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u6dfb\u52a0 Maven \u4f9d\u8d56\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.apache.zookeeper</groupId>\n    <artifactId>zookeeper</artifactId>\n    <version>3.5.7</version>\n</dependency>\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5b9e\u73b0\u4ee3\u7801\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public static void main(String[] args) {\n    // \u53c2\u6570\u4e00\uff1a\u8fde\u63a5\u5730\u5740\n    // \u53c2\u6570\u4e8c\uff1a\u4f1a\u8bdd\u8d85\u65f6\u65f6\u95f4\n    // \u53c2\u6570\u4e09\uff1a\u76d1\u542c\u5668\n    ZooKeeper zkClient = new ZooKeeper("192.168.3.128:2181", 20000, new Watcher() {\n        @Override\n        public void process(WatchedEvent event) {\n            System.out.println("\u76d1\u542c\u5904\u7406\u51fd\u6570");\n        }\n    });\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u96c6\u7fa4\u4ecb\u7ecd",children:"\u96c6\u7fa4\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.h3,{id:"\u76f8\u5173\u6982\u5ff5-1",children:"\u76f8\u5173\u6982\u5ff5"}),"\n",(0,l.jsx)(n.p,{children:"Zookeepe \u96c6\u7fa4\u4e09\u4e2a\u89d2\u8272\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Leader \u9886\u5bfc\u8005\uff1a\u5904\u7406\u5ba2\u6237\u7aef",(0,l.jsx)(n.strong,{children:"\u4e8b\u52a1\u8bf7\u6c42"}),"\uff0c\u8d1f\u8d23\u96c6\u7fa4\u5185\u90e8\u5404\u670d\u52a1\u5668\u7684\u8c03\u5ea6"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Follower \u8ddf\u968f\u8005\uff1a\u5904\u7406\u5ba2\u6237\u7aef\u975e\u4e8b\u52a1\u8bf7\u6c42\uff0c\u8f6c\u53d1\u4e8b\u52a1\u8bf7\u6c42\u7ed9 Leader \u670d\u52a1\u5668\uff0c\u53c2\u4e0e Leader \u9009\u4e3e\u6295\u7968"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Observer \u89c2\u5bdf\u8005\uff1a\u89c2\u5bdf\u96c6\u7fa4\u7684\u6700\u65b0\u72b6\u6001\u7684\u53d8\u5316\uff0c\u5e76\u5c06\u8fd9\u4e9b\u72b6\u6001\u8fdb\u884c\u540c\u6b65\uff1b\u5904\u7406\u975e\u4e8b\u52a1\u6027\u8bf7\u6c42\uff0c\u4e8b\u52a1\u6027\u8bf7\u6c42\u4f1a\u8f6c\u53d1\u7ed9 Leader \u670d\u52a1\u5668\u8fdb\u884c\u5904\u7406\uff1b\u4e0d\u4f1a\u53c2\u4e0e\u4efb\u4f55\u5f62\u5f0f\u7684\u6295\u7968\u3002\u53ea\u63d0\u4f9b\u975e\u4e8b\u52a1\u6027\u7684\u670d\u52a1\uff0c\u901a\u5e38\u7528\u4e8e\u5728\u4e0d\u5f71\u54cd\u96c6\u7fa4\u4e8b\u52a1\u5904\u7406\u80fd\u529b\u7684\u524d\u63d0\u4e0b\uff0c\u63d0\u5347\u96c6\u7fa4\u7684\u975e\u4e8b\u52a1\u5904\u7406\u80fd\u529b\uff08\u63d0\u9ad8\u96c6\u7fa4\u8bfb\u7684\u80fd\u529b\uff0c\u4f46\u662f\u4e5f\u964d\u4f4e\u4e86\u96c6\u7fa4\u9009\u4e3b\u7684\u590d\u6742\u7a0b\u5ea6\uff09"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u76f8\u5173\u5c5e\u6027\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"SID\uff1a\u670d\u52a1\u5668 ID\uff0c\u7528\u6765\u552f\u4e00\u6807\u8bc6\u4e00\u53f0\u96c6\u7fa4\u4e2d\u7684\u673a\u5668\uff0c\u548c myid \u4e00\u81f4"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ZXID\uff1a\u4e8b\u52a1 ID\uff0c\u7528\u6765\u6807\u8bc6\u4e00\u6b21\u670d\u52a1\u5668\u72b6\u6001\u7684\u53d8\u66f4\uff0c\u5728\u67d0\u4e00\u65f6\u523b\u96c6\u7fa4\u4e2d\u6bcf\u53f0\u673a\u5668\u7684 ZXID \u503c\u4e0d\u4e00\u5b9a\u5b8c\u5168\u4e00\u81f4\uff0c\u8fd9\u548c ZooKeeper \u670d\u52a1\u5668\u5bf9\u4e8e\u5ba2\u6237\u7aef\u66f4\u65b0\u8bf7\u6c42\u7684\u5904\u7406\u903b\u8f91\u6709\u5173"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Epoch\uff1a\u6bcf\u4e2a Leader \u4efb\u671f\u7684\u4ee3\u53f7\uff0c\u540c\u4e00\u8f6e\u9009\u4e3e\u6295\u7968\u8fc7\u7a0b\u4e2d\u7684\u8be5\u503c\u662f\u76f8\u540c\u7684\uff0c\u6295\u5b8c\u4e00\u6b21\u7968\u5c31\u589e\u52a0"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u9009\u4e3e\u673a\u5236\uff1a\u534a\u6570\u673a\u5236\uff0c\u8d85\u8fc7\u534a\u6570\u7684\u6295\u7968\u5c31\u901a\u8fc7"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7b2c\u4e00\u6b21\u542f\u52a8\u9009\u4e3e\u89c4\u5219\uff1a\u6295\u7968\u8fc7\u534a\u6570\u65f6\uff0c\u670d\u52a1\u5668 ID \u5927\u7684\u80dc\u51fa"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u7b2c\u4e8c\u6b21\u542f\u52a8\u9009\u4e3e\u89c4\u5219\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"EPOCH \u5927\u7684\u76f4\u63a5\u80dc\u51fa"}),"\n",(0,l.jsx)(n.li,{children:"EPOCH \u76f8\u540c\uff0c\u4e8b\u52a1 ID \u5927\u7684\u80dc\u51fa\uff08\u4e8b\u52a1 ID \u8d8a\u5927\uff0c\u6570\u636e\u8d8a\u65b0\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u4e8b\u52a1 ID \u76f8\u540c\uff0c\u670d\u52a1\u5668 ID \u5927\u7684\u80dc\u51fa"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u521d\u6b21\u9009\u4e3e",children:"\u521d\u6b21\u9009\u4e3e"}),"\n",(0,l.jsx)(n.p,{children:"\u9009\u4e3e\u8fc7\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u670d\u52a1\u5668 1 \u542f\u52a8\uff0c\u53d1\u8d77\u4e00\u6b21\u9009\u4e3e\uff0c\u670d\u52a1\u5668 1 \u6295\u81ea\u5df1\u4e00\u7968\uff0c\u7968\u6570\u4e0d\u8d85\u8fc7\u534a\u6570\uff0c\u9009\u4e3e\u65e0\u6cd5\u5b8c\u6210\uff0c\u670d\u52a1\u5668 1 \u72b6\u6001\u4fdd\u6301\u4e3a LOOKING"}),"\n",(0,l.jsxs)(n.li,{children:["\u670d\u52a1\u5668 2 \u542f\u52a8\uff0c\u518d\u53d1\u8d77\u4e00\u6b21\u9009\u4e3e\uff0c\u670d\u52a1\u5668 1 \u548c 2 \u5206\u522b\u6295\u81ea\u5df1\u4e00\u7968\u5e76",(0,l.jsx)(n.strong,{children:"\u4ea4\u6362\u9009\u7968\u4fe1\u606f"}),"\uff0c\u6b64\u65f6\u670d\u52a1\u5668 1 \u4f1a\u53d1\u73b0\u670d\u52a1\u5668 2 \u7684 SID \u6bd4\u81ea\u5df1\u6295\u7968\u63a8\u4e3e\u7684\uff08\u670d\u52a1\u5668 1\uff09\u5927\uff0c\u66f4\u6539\u9009\u7968\u4e3a\u63a8\u4e3e\u670d\u52a1\u5668 2\u3002\u6295\u7968\u7ed3\u679c\u4e3a\u670d\u52a1\u5668 1 \u7968\u6570 0 \u7968\uff0c\u670d\u52a1\u5668 2 \u7968\u6570 2 \u7968\uff0c\u7968\u6570\u4e0d\u8d85\u8fc7\u534a\u6570\uff0c\u9009\u4e3e\u65e0\u6cd5\u5b8c\u6210\uff0c\u670d\u52a1\u5668 1\u30012 \u72b6\u6001\u4fdd\u6301 LOOKING"]}),"\n",(0,l.jsx)(n.li,{children:"\u670d\u52a1\u5668 3 \u542f\u52a8\uff0c\u53d1\u8d77\u4e00\u6b21\u9009\u4e3e\uff0c\u6b64\u65f6\u670d\u52a1\u5668 1 \u548c 2 \u90fd\u4f1a\u66f4\u6539\u9009\u7968\u4e3a\u670d\u52a1\u5668 3\uff0c\u6295\u7968\u7ed3\u679c\u4e3a\u670d\u52a1\u5668 3 \u7968\u6570 3 \u7968\uff0c\u6b64\u65f6\u670d\u52a1\u5668 3 \u7684\u7968\u6570\u5df2\u7ecf\u8d85\u8fc7\u534a\u6570\uff0c\u670d\u52a1\u5668 3 \u5f53\u9009 Leader\uff0c\u670d\u52a1\u5668 1\u30012 \u66f4\u6539\u72b6\u6001\u4e3a FOLLOWING\uff0c\u670d\u52a1\u5668 3 \u66f4\u6539\u72b6\u6001\u4e3a LEADING"}),"\n",(0,l.jsx)(n.li,{children:"\u670d\u52a1\u5668 4 \u542f\u52a8\uff0c\u53d1\u8d77\u4e00\u6b21\u9009\u4e3e\uff0c\u6b64\u65f6\u670d\u52a1\u5668 1\u30012\u30013 \u5df2\u7ecf\u4e0d\u662f LOOKING \u72b6\u6001\uff0c\u4e0d\u4f1a\u66f4\u6539\u9009\u7968\u4fe1\u606f\uff0c\u4ea4\u6362\u9009\u7968\u4fe1\u606f\u7ed3\u679c\u540e\u670d\u52a1\u5668 3 \u4e3a 3 \u7968\uff0c\u670d\u52a1\u5668 4 \u4e3a 1 \u7968\uff0c\u6b64\u65f6\u670d\u52a1\u5668 4 \u66f4\u6539\u9009\u7968\u4fe1\u606f\u4e3a\u670d\u52a1\u5668 3\uff0c\u5e76\u66f4\u6539\u72b6\u6001\u4e3a FOLLOWING"}),"\n",(0,l.jsx)(n.li,{children:"\u670d\u52a1\u5668 5 \u542f\u52a8\uff0c\u540c 4 \u4e00\u6837"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(2280).A+"",width:"1147",height:"310"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u518d\u6b21\u9009\u4e3e",children:"\u518d\u6b21\u9009\u4e3e"}),"\n",(0,l.jsx)(n.p,{children:"ZooKeeper \u96c6\u7fa4\u4e2d\u7684\u4e00\u53f0\u670d\u52a1\u5668\u51fa\u73b0\u4ee5\u4e0b\u60c5\u51b5\u4e4b\u4e00\u65f6\uff0c\u5c31\u4f1a\u5f00\u59cb\u8fdb\u5165 Leader \u9009\u4e3e\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u670d\u52a1\u5668\u521d\u59cb\u5316\u542f\u52a8"}),"\n",(0,l.jsx)(n.li,{children:"\u670d\u52a1\u5668\u8fd0\u884c\u671f\u95f4\u65e0\u6cd5\u548c Leader \u4fdd\u6301\u8fde\u63a5"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5f53\u4e00\u53f0\u670d\u52a1\u5668\u8fdb\u5165 Leader \u9009\u4e3e\u6d41\u7a0b\u65f6\uff0c\u5f53\u524d\u96c6\u7fa4\u53ef\u80fd\u4f1a\u5904\u4e8e\u4ee5\u4e0b\u4e24\u79cd\u72b6\u6001\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u96c6\u7fa4\u4e2d\u672c\u6765\u5c31\u5df2\u7ecf\u5b58\u5728\u4e00\u4e2a Leader\uff0c\u670d\u52a1\u5668\u8bd5\u56fe\u53bb\u9009\u4e3e Leader \u65f6\u4f1a\u88ab\u544a\u77e5\u5f53\u524d\u670d\u52a1\u5668\u7684 Leader \u4fe1\u606f\uff0c\u5bf9\u4e8e\u8be5\u670d\u52a1\u5668\u6765\u8bf4\uff0c\u53ea\u9700\u8981\u548c Leader \u670d\u52a1\u5668\u5efa\u7acb\u8fde\u63a5\uff0c\u5e76\u8fdb\u884c\u72b6\u6001\u540c\u6b65\u5373\u53ef"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u96c6\u7fa4\u4e2d\u786e\u5b9e\u4e0d\u5b58\u5728 Leader\uff0c\u5047\u8bbe\u670d\u52a1\u5668 3 \u548c 5 \u51fa\u73b0\u6545\u969c\uff0c\u5f00\u59cb\u8fdb\u884c Leader \u9009\u4e3e\uff0cSID \u4e3a 1\u30012\u30014 \u7684\u673a\u5668\u6295\u7968\u60c5\u51b5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"(EPOCH\uff0cZXID\uff0cSID): (1, 8, 1), (1, 8, 2), (1, 7, 4)\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u6839\u636e\u9009\u4e3e\u89c4\u5219\uff0c\u670d\u52a1\u5668 2 \u80dc\u51fa"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u6570\u636e\u5199\u5165",children:"\u6570\u636e\u5199\u5165"}),"\n",(0,l.jsxs)(n.p,{children:["\u5199\u64cd\u4f5c\u5c31\u662f\u4e8b\u52a1\u8bf7\u6c42\uff0c\u5199\u5165\u8bf7\u6c42\u76f4\u63a5\u53d1\u9001\u7ed9 Leader \u8282\u70b9\uff1aLeader \u4f1a\u5148\u5c06\u6570\u636e\u5199\u5165\u81ea\u8eab\uff0c\u540c\u65f6\u901a\u77e5\u5176\u4ed6 Follower \u5199\u5165\uff0c",(0,l.jsx)(n.strong,{children:"\u5f53\u96c6\u7fa4\u4e2d\u6709\u534a\u6570\u4ee5\u4e0a\u8282\u70b9\u5199\u5165\u5b8c\u6210"}),"\uff0cLeader \u8282\u70b9\u5c31\u4f1a\u54cd\u5e94\u5ba2\u6237\u7aef\u6570\u636e\u5199\u5165\u5b8c\u6210"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(42797).A+"",width:"1237",height:"616"})}),"\n",(0,l.jsxs)(n.p,{children:["\u5199\u5165\u8bf7\u6c42\u76f4\u63a5\u53d1\u9001\u7ed9 Follower \u8282\u70b9\uff1aFollower \u6ca1\u6709\u5199\u5165\u6743\u9650\uff0c\u4f1a\u5c06\u5199\u8bf7\u6c42\u8f6c\u53d1\u7ed9 Leader\uff0cLeader \u5c06\u6570\u636e\u5199\u5165\u81ea\u8eab\uff0c\u901a\u77e5\u5176\u4ed6 Follower \u5199\u5165\uff0c\u5f53\u96c6\u7fa4\u4e2d\u6709\u534a\u6570\u4ee5\u4e0a\u8282\u70b9\u5199\u5165\u5b8c\u6210\uff0cLeader \u4f1a\u901a\u77e5 Follower \u5199\u5165\u5b8c\u6210\uff0c",(0,l.jsx)(n.strong,{children:"\u7531 Follower \u54cd\u5e94\u5ba2\u6237\u7aef\u6570\u636e\u5199\u5165\u5b8c\u6210"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(19732).A+"",width:"1463",height:"548"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u5e95\u5c42\u534f\u8bae",children:"\u5e95\u5c42\u534f\u8bae"}),"\n",(0,l.jsx)(n.h3,{id:"paxos",children:"Paxos"}),"\n",(0,l.jsx)(n.p,{children:"Paxos \u7b97\u6cd5\uff1a\u57fa\u4e8e\u6d88\u606f\u4f20\u9012\u4e14\u5177\u6709\u9ad8\u5ea6\u5bb9\u9519\u7279\u6027\u7684\u4e00\u81f4\u6027\u7b97\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"\u4f18\u70b9\uff1a\u5feb\u901f\u6b63\u786e\u7684\u5728\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u5bf9\u67d0\u4e2a\u6570\u636e\u503c\u8fbe\u6210\u4e00\u81f4\uff0c\u5e76\u4e14\u4fdd\u8bc1\u4e0d\u8bba\u53d1\u751f\u4efb\u4f55\u5f02\u5e38\uff0c\u90fd\u4e0d\u4f1a\u7834\u574f\u6574\u4e2a\u7cfb\u7edf\u7684\u4e00\u81f4\u6027"}),"\n",(0,l.jsx)(n.p,{children:"\u7f3a\u9677\uff1a\u5728\u7f51\u7edc\u590d\u6742\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u5f88\u4e45\u65e0\u6cd5\u6536\u655b\uff0c\u751a\u81f3\u9677\u5165\u6d3b\u9501\u7684\u60c5\u51b5"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"zab",children:"ZAB"}),"\n",(0,l.jsx)(n.h4,{id:"\u7b97\u6cd5\u4ecb\u7ecd",children:"\u7b97\u6cd5\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"ZAB \u534f\u8bae\u501f\u9274\u4e86 Paxos \u7b97\u6cd5\uff0c\u662f\u4e3a Zookeeper \u8bbe\u8ba1\u7684\u652f\u6301\u5d29\u6e83\u6062\u590d\u7684\u539f\u5b50\u5e7f\u64ad\u534f\u8bae\uff0c\u57fa\u4e8e\u8be5\u534f\u8bae Zookeeper \u8bbe\u8ba1\u4e3a\u53ea\u6709\u4e00\u53f0\u5ba2\u6237\u7aef\uff08Leader\uff09\u8d1f\u8d23\u5904\u7406\u5916\u90e8\u7684\u5199\u4e8b\u52a1\u8bf7\u6c42\uff0c\u7136\u540e Leader \u5c06\u6570\u636e\u540c\u6b65\u5230\u5176\u4ed6 Follower \u8282\u70b9"}),"\n",(0,l.jsx)(n.p,{children:"Zab \u534f\u8bae\u5305\u62ec\u4e24\u79cd\u57fa\u672c\u7684\u6a21\u5f0f\uff1a\u6d88\u606f\u5e7f\u64ad\u3001\u5d29\u6e83\u6062\u590d"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u6d88\u606f\u5e7f\u64ad",children:"\u6d88\u606f\u5e7f\u64ad"}),"\n",(0,l.jsxs)(n.p,{children:["ZAB \u534f\u8bae\u9488\u5bf9\u4e8b\u52a1\u8bf7\u6c42\u7684\u5904\u7406\u8fc7\u7a0b\u7c7b\u4f3c\u4e8e\u4e00\u4e2a",(0,l.jsx)(n.strong,{children:"\u4e24\u9636\u6bb5\u63d0\u4ea4"}),"\u8fc7\u7a0b\uff1a\u5e7f\u64ad\u4e8b\u52a1\u9636\u6bb5\u3001\u5e7f\u64ad\u63d0\u4ea4\u64cd\u4f5c"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5ba2\u6237\u7aef\u53d1\u8d77\u5199\u64cd\u4f5c\u8bf7\u6c42\uff0cLeader \u670d\u52a1\u5668\u5c06\u8bf7\u6c42\u8f6c\u5316\u4e3a\u4e8b\u52a1 Proposal \u63d0\u6848\uff0c\u540c\u65f6\u4e3a Proposal \u5206\u914d\u4e00\u4e2a\u5168\u5c40\u7684 ID\uff0c\u5373 ZXID"}),"\n",(0,l.jsxs)(n.li,{children:["Leader \u670d\u52a1\u5668\u4e3a\u6bcf\u4e2a Follower \u5206\u914d\u4e00\u4e2a\u5355\u72ec\u7684\u961f\u5217\uff0c\u5c06\u5e7f\u64ad\u7684 Proposal ",(0,l.jsx)(n.strong,{children:"\u4f9d\u6b21\u653e\u5230\u961f\u5217"}),"\u4e2d\u53bb\uff0c\u6839\u636e FIFO \u7b56\u7565\u8fdb\u884c\u6d88\u606f\u53d1\u9001"]}),"\n",(0,l.jsx)(n.li,{children:"Follower \u63a5\u6536\u5230 Proposal \u540e\uff0c\u5c06\u5176\u4ee5\u4e8b\u52a1\u65e5\u5fd7\u7684\u65b9\u5f0f\u5199\u5165\u672c\u5730\u78c1\u76d8\u4e2d\uff0c\u5199\u5165\u6210\u529f\u540e\u5411 Leader \u53cd\u9988\u4e00\u4e2a ACK \u54cd\u5e94\u6d88\u606f"}),"\n",(0,l.jsx)(n.li,{children:"Leader \u63a5\u6536\u5230\u8d85\u8fc7\u534a\u6570\u4ee5\u4e0a Follower \u7684 ACK \u54cd\u5e94\u6d88\u606f\u540e\uff0c\u5373\u8ba4\u4e3a\u6d88\u606f\u53d1\u9001\u6210\u529f\uff0c\u53ef\u4ee5\u53d1\u9001 Commit \u6d88\u606f"}),"\n",(0,l.jsx)(n.li,{children:"Leader \u5411\u6240\u6709 Follower \u5e7f\u64ad commit \u6d88\u606f\uff0c\u540c\u65f6\u81ea\u8eab\u4e5f\u4f1a\u5b8c\u6210\u4e8b\u52a1\u63d0\u4ea4\uff0cFollower \u63a5\u6536\u5230 Commit \u540e\uff0c\u5c06\u4e0a\u4e00\u6761\u4e8b\u52a1\u63d0\u4ea4"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(25592).A+"",width:"1251",height:"522"})}),"\n",(0,l.jsx)(n.p,{children:"\u4e24\u9636\u6bb5\u63d0\u4ea4\u6a21\u578b\u53ef\u80fd\u56e0\u4e3a Leader \u5b95\u673a\u5e26\u6765\u6570\u636e\u4e0d\u4e00\u81f4\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Leader \u53d1\u8d77\u4e00\u4e2a\u4e8b\u52a1 Proposal \u540e\u5c31\u5b95\u673a\uff0cFollower \u90fd\u6ca1\u6709 Proposal"}),"\n",(0,l.jsx)(n.li,{children:"Leader \u6536\u5230\u534a\u6570 ACK \u5b95\u673a\uff0c\u6ca1\u6765\u5f97\u53ca\u5411 Follower \u53d1\u9001 Commit"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5d29\u6e83\u6062\u590d",children:"\u5d29\u6e83\u6062\u590d"}),"\n",(0,l.jsxs)(n.p,{children:["Leader \u670d\u52a1\u5668\u51fa\u73b0\u5d29\u6e83\u6216\u8005\u7531\u4e8e\u7f51\u7edc\u539f\u56e0\u5bfc\u81f4 Leader \u670d\u52a1\u5668\u5931\u53bb\u4e86\u4e0e",(0,l.jsx)(n.strong,{children:"\u8fc7\u534a Follower\u7684\u8054\u7cfb"}),"\uff0c\u90a3\u4e48\u5c31\u4f1a\u8fdb\u5165\u5d29\u6e83\u6062\u590d\u6a21\u5f0f\uff0c\u5d29\u6e83\u6062\u590d\u4e3b\u8981\u5305\u62ec\u4e24\u90e8\u5206\uff1aLeader \u9009\u4e3e\u548c\u6570\u636e\u6062\u590d"]}),"\n",(0,l.jsx)(n.p,{children:"Zab \u534f\u8bae\u5d29\u6e83\u6062\u590d\u8981\u6c42\u6ee1\u8db3\u4ee5\u4e0b\u4e24\u4e2a\u8981\u6c42\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5df2\u7ecf\u88ab Leader \u63d0\u4ea4\u7684\u63d0\u6848 Proposal\uff0c\u5fc5\u987b\u6700\u7ec8\u88ab\u6240\u6709\u7684 Follower \u670d\u52a1\u5668\u6b63\u786e\u63d0\u4ea4"}),"\n",(0,l.jsx)(n.li,{children:"\u4e22\u5f03\u5df2\u7ecf\u88ab Leader \u63d0\u51fa\u7684\uff0c\u4f46\u662f\u6ca1\u6709\u88ab\u63d0\u4ea4\u7684 Proposal"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Zab \u534f\u8bae\u9700\u8981\u4fdd\u8bc1\u9009\u4e3e\u51fa\u6765\u7684 Leader \u9700\u8981\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u65b0\u9009\u4e3e\u7684 Leader \u4e0d\u80fd\u5305\u542b\u672a\u63d0\u4ea4\u7684 Proposal\uff0c\u5373\u65b0 Leader \u5fc5\u987b\u90fd\u662f\u5df2\u7ecf\u63d0\u4ea4\u4e86 Proposal \u7684 Follower \u8282\u70b9"}),"\n",(0,l.jsxs)(n.li,{children:["\u65b0\u9009\u4e3e\u7684 Leader \u8282\u70b9\u542b\u6709",(0,l.jsx)(n.strong,{children:"\u6700\u5927\u7684 ZXID"}),"\uff0c\u53ef\u4ee5\u907f\u514d Leader \u670d\u52a1\u5668\u68c0\u67e5 Proposal \u7684\u63d0\u4ea4\u548c\u4e22\u5f03\u5de5\u4f5c"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(15229).A+"",width:"1442",height:"512"})}),"\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u6062\u590d\u9636\u6bb5\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5b8c\u6210 Leader \u9009\u4e3e\u540e\uff0c\u5728\u6b63\u5f0f\u5f00\u59cb\u5de5\u4f5c\u4e4b\u524d\uff08\u63a5\u6536\u4e8b\u52a1\u8bf7\u6c42\u63d0\u51fa\u65b0\u7684 Proposal\uff09\uff0cLeader \u670d\u52a1\u5668\u4f1a\u9996\u5148\u786e\u8ba4\u4e8b\u52a1\u65e5\u5fd7\u4e2d\u7684\u6240\u6709 Proposal \u662f\u5426\u5df2\u7ecf\u88ab\u96c6\u7fa4\u4e2d\u8fc7\u534a\u7684\u670d\u52a1\u5668 Commit"}),"\n",(0,l.jsxs)(n.li,{children:["Leader \u670d\u52a1\u5668\u9700\u8981\u786e\u4fdd\u6240\u6709\u7684 Follower \u670d\u52a1\u5668\u80fd\u591f\u63a5\u6536\u5230\u6bcf\u4e00\u6761\u4e8b\u52a1\u7684 Proposal\uff0c\u5e76\u4e14\u80fd\u5c06\u6240\u6709\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1 Proposal \u5e94\u7528\u5230\u5185\u5b58\u6570\u636e\u4e2d\uff0c\u6240\u4ee5\u53ea\u6709\u5f53 Follower \u5c06\u6240\u6709\u5c1a\u672a\u540c\u6b65\u7684\u4e8b\u52a1 Proposal \u90fd",(0,l.jsx)(n.strong,{children:"\u4ece Leader \u670d\u52a1\u5668\u4e0a\u540c\u6b65"}),"\uff0c\u5e76\u4e14\u5e94\u7528\u5230\u5185\u5b58\u6570\u636e\u540e\uff0cLeader \u624d\u4f1a\u628a\u8be5 Follower \u52a0\u5165\u5230\u771f\u6b63\u53ef\u7528\u7684 Follower \u5217\u8868\u4e2d"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u5f02\u5e38\u5904\u7406",children:"\u5f02\u5e38\u5904\u7406"}),"\n",(0,l.jsx)(n.p,{children:"Zab \u7684\u4e8b\u52a1\u7f16\u53f7 zxid \u8bbe\u8ba1\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"zxid \u662f\u4e00\u4e2a 64 \u4f4d\u7684\u6570\u5b57\uff0c\u4f4e 32 \u4f4d\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5355\u589e\u8ba1\u6570\u5668\uff0c\u9488\u5bf9\u5ba2\u6237\u7aef\u6bcf\u4e00\u4e2a\u4e8b\u52a1\u8bf7\u6c42\uff0cLeader \u5728\u4ea7\u751f\u65b0\u7684 Proposal \u4e8b\u52a1\u65f6\uff0c\u90fd\u4f1a\u5bf9\u8be5\u8ba1\u6570\u5668\u52a0 1\uff0c\u800c\u9ad8 32 \u4f4d\u5219\u4ee3\u8868\u4e86 Leader \u5468\u671f\u7684 epoch \u7f16\u53f7"}),"\n",(0,l.jsx)(n.li,{children:"epoch \u4e3a\u5f53\u524d\u96c6\u7fa4\u6240\u5904\u7684\u4ee3\u6216\u8005\u5468\u671f\uff0c\u6bcf\u6b21 Leader \u53d8\u66f4\u540e\u90fd\u4f1a\u5728 epoch \u7684\u57fa\u7840\u4e0a\u52a0 1\uff0cFollower \u53ea\u670d\u4ece epoch \u6700\u9ad8\u7684 Leader \u547d\u4ee4\uff0c\u6240\u4ee5\u65e7\u7684 Leader \u5d29\u6e83\u6062\u590d\u4e4b\u540e\uff0c\u5176\u4ed6 Follower \u5c31\u4e0d\u4f1a\u7ee7\u7eed\u8ffd\u968f"}),"\n",(0,l.jsx)(n.li,{children:"\u6bcf\u6b21\u9009\u4e3e\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684 Leader\uff0c\u5c31\u4f1a\u4ece\u65b0 Leader \u670d\u52a1\u5668\u4e0a\u53d6\u51fa\u672c\u5730\u4e8b\u52a1\u65e5\u5fd7\u4e2d\u6700\u5927\u7f16\u53f7 Proposal \u7684 zxid\uff0c\u4ece zxid \u4e2d\u89e3\u6790\u5f97\u5230\u5bf9\u5e94\u7684 epoch \u7f16\u53f7\uff0c\u7136\u540e\u518d\u5bf9\u5176\u52a0 1 \u540e\u4f5c\u4e3a\u65b0\u7684 epoch \u503c\uff0c\u5e76\u5c06\u4f4e 32 \u4f4d\u6570\u5b57\u5f52\u96f6\uff0c\u7531 0 \u5f00\u59cb\u91cd\u65b0\u751f\u6210 zxid"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Zab \u534f\u8bae\u901a\u8fc7 epoch \u7f16\u53f7\u6765\u533a\u5206 Leader \u53d8\u5316\u5468\u671f\uff0c\u80fd\u591f\u6709\u6548\u907f\u514d\u4e0d\u540c\u7684 Leader \u9519\u8bef\u7684\u4f7f\u7528\u4e86\u76f8\u540c\u7684 zxid \u7f16\u53f7\u63d0\u51fa\u4e86\u4e0d\u4e00\u6837\u7684 Proposal \u7684\u5f02\u5e38\u60c5\u51b5"}),"\n",(0,l.jsxs)(n.p,{children:["Zab \u6570\u636e\u540c\u6b65\u8fc7\u7a0b\uff1a",(0,l.jsx)(n.strong,{children:"\u6570\u636e\u540c\u6b65\u9636\u6bb5\u8981\u4ee5 Leader \u670d\u52a1\u5668\u4e3a\u51c6"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e00\u4e2a\u5305\u542b\u4e86\u4e0a\u4e2a Leader \u5468\u671f\u4e2d\u5c1a\u672a\u63d0\u4ea4\u8fc7\u7684\u4e8b\u52a1 Proposal \u7684\u670d\u52a1\u5668\u542f\u52a8\u65f6\uff0c\u8fd9\u53f0\u673a\u5668\u52a0\u5165\u96c6\u7fa4\u4e2d\u4f1a\u4ee5 Follower \u89d2\u8272\u8fde\u4e0a Leader"}),"\n",(0,l.jsxs)(n.li,{children:["Leader \u4f1a\u6839\u636e\u81ea\u5df1\u670d\u52a1\u5668\u4e0a\u6700\u540e\u63d0\u4ea4\u7684 Proposal \u548c Follower \u670d\u52a1\u5668\u7684 Proposal \u8fdb\u884c\u6bd4\u5bf9\uff0c\u8ba9 Follower \u8fdb\u884c\u4e00\u4e2a",(0,l.jsx)(n.strong,{children:"\u56de\u9000\u6216\u8005\u524d\u8fdb\u64cd\u4f5c"}),"\uff0c\u5230\u4e00\u4e2a\u5df2\u7ecf\u88ab\u96c6\u7fa4\u4e2d\u8fc7\u534a\u673a\u5668 Commit \u7684\u6700\u65b0 Proposal\uff08\u6e90\u7801\u89e3\u6790\u90e8\u5206\u8be6\u89e3\uff09"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"cap",children:"CAP"}),"\n",(0,l.jsx)(n.p,{children:"CAP \u7406\u8bba\u6307\u7684\u662f\u5728\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0cConsistency\uff08\u4e00\u81f4\u6027\uff09\u3001Availability\uff08\u53ef\u7528\u6027\uff09\u3001Partition Tolerance\uff08\u5206\u533a\u5bb9\u9519\u6027\uff09\u4e0d\u80fd\u540c\u65f6\u6210\u7acb\uff0cZooKeeper \u4fdd\u8bc1\u7684\u662f CP"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"ZooKeeper \u4e0d\u80fd\u4fdd\u8bc1\u6bcf\u6b21\u670d\u52a1\u8bf7\u6c42\u7684\u53ef\u7528\u6027\uff0c\u5728\u6781\u7aef\u73af\u5883\u4e0b\u53ef\u80fd\u4f1a\u4e22\u5f03\u4e00\u4e9b\u8bf7\u6c42\uff0c\u6d88\u8d39\u8005\u7a0b\u5e8f\u9700\u8981\u91cd\u65b0\u8bf7\u6c42\u624d\u80fd\u83b7\u5f97\u7ed3\u679c"}),"\n",(0,l.jsxs)(n.li,{children:["\u8fdb\u884c Leader \u9009\u4e3e\u65f6",(0,l.jsx)(n.strong,{children:"\u96c6\u7fa4\u90fd\u662f\u4e0d\u53ef\u7528"})]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"CAP \u4e09\u4e2a\u57fa\u672c\u9700\u6c42\uff0c\u56e0\u4e3a P \u662f\u5fc5\u987b\u7684\uff0c\u56e0\u6b64\u5206\u5e03\u5f0f\u7cfb\u7edf\u9009\u62e9\u5c31\u5728 CP \u6216\u8005 AP \u4e2d\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e00\u81f4\u6027\uff1a\u6307\u6570\u636e\u5728\u591a\u4e2a\u526f\u672c\u4e4b\u95f4\u662f\u5426\u80fd\u591f\u4fdd\u6301\u6570\u636e\u4e00\u81f4\u7684\u7279\u6027\uff0c\u5f53\u4e00\u4e2a\u7cfb\u7edf\u5728\u6570\u636e\u4e00\u81f4\u7684\u72b6\u6001\u4e0b\u6267\u884c\u66f4\u65b0\u64cd\u4f5c\u540e\uff0c\u4e5f\u80fd\u4fdd\u8bc1\u7cfb\u7edf\u7684\u6570\u636e\u4ecd\u7136\u5904\u4e8e\u4e00\u81f4\u7684\u72b6\u6001"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u7528\u6027\uff1a\u6307\u7cfb\u7edf\u63d0\u4f9b\u7684\u670d\u52a1\u5fc5\u987b\u4e00\u76f4\u5904\u4e8e\u53ef\u7528\u7684\u72b6\u6001\uff0c\u5373\u4f7f\u96c6\u7fa4\u4e2d\u4e00\u90e8\u5206\u8282\u70b9\u6545\u969c\uff0c\u5bf9\u4e8e\u7528\u6237\u7684\u6bcf\u4e00\u4e2a\u64cd\u4f5c\u8bf7\u6c42\u603b\u662f\u80fd\u591f\u5728\u6709\u9650\u7684\u65f6\u95f4\u5185\u8fd4\u56de\u7ed3\u679c"}),"\n",(0,l.jsx)(n.li,{children:"\u5206\u533a\u5bb9\u9519\u6027\uff1a\u5206\u5e03\u5f0f\u7cfb\u7edf\u5728\u9047\u5230\u4efb\u4f55\u7f51\u7edc\u5206\u533a\u6545\u969c\u65f6\uff0c\u4ecd\u7136\u80fd\u591f\u4fdd\u8bc1\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u4e0d\u4f1a\u5b95\u673a\uff0c\u9664\u975e\u662f\u6574\u4e2a\u7f51\u7edc\u73af\u5883\u90fd\u53d1\u751f\u4e86\u6545\u969c"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u76d1\u542c\u673a\u5236",children:"\u76d1\u542c\u673a\u5236"}),"\n",(0,l.jsx)(n.h3,{id:"\u5b9e\u73b0\u539f\u7406",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,l.jsx)(n.p,{children:"ZooKeeper \u4e2d\u5f15\u5165\u4e86 Watcher \u673a\u5236\u6765\u5b9e\u73b0\u4e86\u53d1\u5e03/\u8ba2\u9605\u529f\u80fd\uff0c\u5ba2\u6237\u7aef\u6ce8\u518c\u76d1\u542c\u76ee\u5f55\u8282\u70b9\uff0c\u5728\u7279\u5b9a\u4e8b\u4ef6\u89e6\u53d1\u65f6\uff0cZooKeeper \u4f1a\u901a\u77e5\u6240\u6709\u5173\u6ce8\u8be5\u4e8b\u4ef6\u7684\u5ba2\u6237\u7aef\uff0c\u4fdd\u8bc1 ZooKeeper \u4fdd\u5b58\u7684\u4efb\u4f55\u7684\u6570\u636e\u7684\u4efb\u4f55\u6539\u53d8\u90fd\u80fd\u5feb\u901f\u7684\u54cd\u5e94\u5230\u76d1\u542c\u5e94\u7528\u7a0b\u5e8f"}),"\n",(0,l.jsxs)(n.p,{children:["\u76d1\u542c\u547d\u4ee4\uff1a",(0,l.jsx)(n.strong,{children:"\u53ea\u80fd\u751f\u6548\u4e00\u6b21"}),"\uff0c\u63a5\u6536\u4e00\u6b21\u901a\u77e5\uff0c\u518d\u6b21\u76d1\u542c\u9700\u8981\u91cd\u65b0\u6ce8\u518c"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sh",children:"ls \u2013w /path\t\t\t\t\t# \u76d1\u542c\u3010\u5b50\u8282\u70b9\u6570\u91cf\u3011\u7684\u53d8\u5316\nget \u2013w /path\t\t\t\t# \u76d1\u542c\u3010\u8282\u70b9\u6570\u636e\u3011\u7684\u53d8\u5316\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5de5\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5728\u4e3b\u7ebf\u7a0b\u4e2d\u521b\u5efa Zookeeper \u5ba2\u6237\u7aef\uff0c\u8fd9\u65f6\u5c31\u4f1a\u521b\u5efa",(0,l.jsx)(n.strong,{children:"\u4e24\u4e2a\u7ebf\u7a0b"}),"\uff0c\u4e00\u4e2a\u8d1f\u8d23\u7f51\u7edc\u8fde\u63a5\u901a\u4fe1\uff08connet\uff09\uff0c\u4e00\u4e2a\u8d1f\u8d23\u76d1\u542c\uff08listener\uff09"]}),"\n",(0,l.jsx)(n.li,{children:"\u901a\u8fc7 connect \u7ebf\u7a0b\u5c06\u6ce8\u518c\u7684\u76d1\u542c\u4e8b\u4ef6\u53d1\u9001\u7ed9 Zookeeper"}),"\n",(0,l.jsxs)(n.li,{children:["\u5728 Zookeeper \u7684\u6ce8\u518c\u76d1\u542c\u5668\u5217\u8868\u4e2d\u5c06\u6ce8\u518c\u7684",(0,l.jsx)(n.strong,{children:"\u76d1\u542c\u4e8b\u4ef6\u6dfb\u52a0\u5230\u5217\u8868"}),"\u4e2d"]}),"\n",(0,l.jsx)(n.li,{children:"Zookeeper \u76d1\u542c\u5230\u6709\u6570\u636e\u6216\u8def\u5f84\u53d8\u5316\uff0c\u5c06\u6d88\u606f\u53d1\u9001\u7ed9 listener \u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.li,{children:"listener \u7ebf\u7a0b\u5185\u90e8\u8c03\u7528 process() \u65b9\u6cd5"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Curator \u6846\u67b6\u5f15\u5165\u4e86 Cache \u6765\u5b9e\u73b0\u5bf9 ZooKeeper \u670d\u52a1\u7aef\u4e8b\u4ef6\u7684\u76d1\u542c\uff0c\u4e09\u79cd Watcher\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"NodeCache\uff1a\u53ea\u662f\u76d1\u542c\u67d0\u4e00\u4e2a\u7279\u5b9a\u7684\u8282\u70b9"}),"\n",(0,l.jsx)(n.li,{children:"PathChildrenCache\uff1a\u76d1\u63a7\u4e00\u4e2a ZNode \u7684\u5b50\u8282\u70b9"}),"\n",(0,l.jsx)(n.li,{children:"TreeCache\uff1a\u53ef\u4ee5\u76d1\u63a7\u6574\u4e2a\u6811\u4e0a\u7684\u6240\u6709\u8282\u70b9\uff0c\u7c7b\u4f3c\u4e8e PathChildrenCache \u548c NodeCache \u7684\u7ec4\u5408"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u76d1\u542c\u6848\u4f8b",children:"\u76d1\u542c\u6848\u4f8b"}),"\n",(0,l.jsx)(n.h4,{id:"\u6574\u4f53\u67b6\u6784",children:"\u6574\u4f53\u67b6\u6784"}),"\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u5b9e\u65f6\u76d1\u542c\u670d\u52a1\u5668\u52a8\u6001\u4e0a\u4e0b\u7ebf"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(69735).A+"",width:"1590",height:"800"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4ee3\u7801\u5b9e\u73b0-6",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\uff1a\u5148\u542f\u52a8\u5ba2\u6237\u7aef\u8fdb\u884c\u76d1\u542c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class DistributeClient {\n    private String connectString = "192.168.3.128:2181";\n    private int sessionTimeout = 20000;\n    private ZooKeeper zk;\n\n    public static void main(String[] args) throws Exception {\n        DistributeClient client = new DistributeClient();\n        \n        // 1 \u83b7\u53d6zk\u8fde\u63a5\n        client.getConnect();\n\n        // 2 \u76d1\u542c/servers\u4e0b\u9762\u5b50\u8282\u70b9\u7684\u589e\u52a0\u548c\u5220\u9664\n        client.getServerList();\n\n        // 3 \u4e1a\u52a1\u903b\u8f91\n        client.business();\n    }\n\n    private void business() throws InterruptedException {\n        Thread.sleep(Long.MAX_VALUE);\n    }\n\n    private void getServerList() throws KeeperException, InterruptedException {\n        ArrayList<String> servers = new ArrayList<>();\n        // \u83b7\u53d6\u6240\u6709\u5b50\u8282\u70b9\uff0ctrue \u4ee3\u8868\u89e6\u53d1\u76d1\u542c\u64cd\u4f5c\n        List<String> children = zk.getChildren("/servers", true);\n\n        for (String child : children) {\n            // \u83b7\u53d6\u5b50\u8282\u70b9\u7684\u6570\u636e\n            byte[] data = zk.getData("/servers/" + child, false, null);\n            servers.add(new String(data));\n        }\n        System.out.println(servers);\n    }\n\n    private void getConnect() throws IOException {\n        zk = new ZooKeeper(connectString, sessionTimeout, new Watcher() {\n            @Override\n            public void process(WatchedEvent event) {\n                getServerList();\n            }\n        });\n    }\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\uff1a\u542f\u52a8\u65f6\u9700\u8981 Program arguments"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class DistributeServer {\n    private String connectString = "192.168.3.128:2181";\n    private int sessionTimeout = 20000;\n    private ZooKeeper zk;\n\n    public static void main(String[] args) throws Exception {\n        DistributeServer server = new DistributeServer();\n\n        // 1 \u83b7\u53d6 zookeeper \u8fde\u63a5\n        server.getConnect();\n\n        // 2  \u6ce8\u518c\u670d\u52a1\u5668\u5230 zk \u96c6\u7fa4\uff0c\u6ce8\u610f\u53c2\u6570\n        server.register(args[0]);\n\n        // 3 \u542f\u52a8\u4e1a\u52a1\u903b\u8f91\n        server.business();\n    }\n\n    private void business() throws InterruptedException {\n        Thread.sleep(Long.MAX_VALUE);\n    }\n\n    private void register(String hostname) throws KeeperException, InterruptedException {\n        // OPEN_ACL_UNSAFE: ACL \u5f00\u653e\n        // EPHEMERAL_SEQUENTIAL: \u4e34\u65f6\u987a\u5e8f\u8282\u70b9\n        String create = zk.create("/servers/" + hostname, hostname.getBytes(),\n                                  ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);\n        System.out.println(hostname + " is online");\n    }\n\n    private void getConnect() throws IOException {\n        zk = new ZooKeeper(connectString, sessionTimeout, new Watcher() {\n            @Override\n            public void process(WatchedEvent event) {\n            }\n        });\n    }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u5206\u5e03\u5f0f\u9501",children:"\u5206\u5e03\u5f0f\u9501"}),"\n",(0,l.jsx)(n.h3,{id:"\u5b9e\u73b0\u539f\u7406-1",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,l.jsx)(n.p,{children:"\u5206\u5e03\u5f0f\u9501\u53ef\u4ee5\u5b9e\u73b0\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u591a\u4e2a\u8fdb\u7a0b\u6709\u5e8f\u7684\u8bbf\u95ee\u8be5\u4e34\u754c\u8d44\u6e90\uff0c\u591a\u4e2a\u8fdb\u7a0b\u4e4b\u95f4\u4e0d\u4f1a\u76f8\u4e92\u5e72\u6270"}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u601d\u60f3\uff1a\u5f53\u5ba2\u6237\u7aef\u8981\u83b7\u53d6\u9501\uff0c\u5219\u521b\u5efa\u8282\u70b9\uff0c\u4f7f\u7528\u5b8c\u9501\uff0c\u5219\u5220\u9664\u8be5\u8282\u70b9"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u5ba2\u6237\u7aef\u83b7\u53d6\u9501\u65f6\uff0c\u5728 /locks \u8282\u70b9\u4e0b\u521b\u5efa",(0,l.jsx)(n.strong,{children:"\u4e34\u65f6\u987a\u5e8f"}),"\u8282\u70b9"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4f7f\u7528\u4e34\u65f6\u8282\u70b9\u662f\u4e3a\u4e86\u9632\u6b62\u5f53\u670d\u52a1\u5668\u6216\u5ba2\u6237\u7aef\u5b95\u673a\u4ee5\u540e\u8282\u70b9\u65e0\u6cd5\u5220\u9664\uff08\u6301\u4e45\u8282\u70b9\uff09\uff0c\u5bfc\u81f4\u9501\u65e0\u6cd5\u91ca\u653e"}),"\n",(0,l.jsx)(n.li,{children:"\u4f7f\u7528\u987a\u5e8f\u8282\u70b9\u662f\u4e3a\u4e86\u7cfb\u7edf\u81ea\u52a8\u7f16\u53f7\u6392\u5e8f\uff0c\u627e\u6700\u5c0f\u7684\u8282\u70b9\uff0c\u9632\u6b62\u5ba2\u6237\u7aef\u9965\u997f\u73b0\u8c61\uff0c\u4fdd\u8bc1\u516c\u5e73"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u83b7\u53d6 /locks \u76ee\u5f55\u7684\u6240\u6709\u5b50\u8282\u70b9\uff0c\u5224\u65ad\u81ea\u5df1\u7684",(0,l.jsx)(n.strong,{children:"\u5b50\u8282\u70b9\u5e8f\u53f7\u662f\u5426\u6700\u5c0f"}),"\uff0c\u6210\u7acb\u5219\u5ba2\u6237\u7aef\u83b7\u53d6\u5230\u9501\uff0c\u4f7f\u7528\u5b8c\u9501\u540e\u5c06\u8be5\u8282\u70b9\u5220\u9664"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["\u53cd\u4e4b\u5ba2\u6237\u7aef\u9700\u8981\u627e\u5230\u6bd4\u81ea\u5df1\u5c0f\u7684\u8282\u70b9\uff0c",(0,l.jsx)(n.strong,{children:"\u5bf9\u5176\u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c\u5668\uff0c\u76d1\u542c\u5220\u9664\u4e8b\u4ef6"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u7684 Watcher \u6536\u5230\u5220\u9664\u4e8b\u4ef6\u901a\u77e5\uff0c\u5c31\u4f1a\u91cd\u65b0\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u662f\u5b50\u8282\u70b9\u4e2d\u5e8f\u53f7\u6700\u5c0f\uff0c\u5982\u679c\u662f\u5219\u83b7\u53d6\u5230\u4e86\u9501\uff0c \u5982\u679c\u4e0d\u662f\u5219\u91cd\u590d\u4ee5\u4e0a\u6b65\u9aa4\u7ee7\u7eed\u83b7\u53d6\u5230\u6bd4\u81ea\u5df1\u5c0f\u7684\u4e00\u4e2a\u8282\u70b9\u5e76\u6ce8\u518c\u76d1\u542c"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(14069).A+"",width:"1060",height:"334"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"curator",children:"Curator"}),"\n",(0,l.jsx)(n.p,{children:"Curator \u5b9e\u73b0\u5206\u5e03\u5f0f\u9501 API\uff0c\u5728 Curator \u4e2d\u6709\u4e94\u79cd\u9501\u65b9\u6848\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"InterProcessSemaphoreMutex\uff1a\u5206\u5e03\u5f0f\u6392\u5b83\u9501\uff08\u975e\u53ef\u91cd\u5165\u9501\uff09"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"InterProcessMutex\uff1a\u5206\u5e03\u5f0f\u53ef\u91cd\u5165\u6392\u5b83\u9501"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"InterProcessReadWriteLock\uff1a\u5206\u5e03\u5f0f\u8bfb\u5199\u9501"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"InterProcessMultiLock\uff1a\u5c06\u591a\u4e2a\u9501\u4f5c\u4e3a\u5355\u4e2a\u5b9e\u4f53\u7ba1\u7406\u7684\u5bb9\u5668"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"InterProcessSemaphoreV2\uff1a\u5171\u4eab\u4fe1\u53f7\u91cf"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class CuratorLock {\n    \n    public static CuratorFramework getCuratorFramework() {\n        // \u91cd\u8bd5\u7b56\u7565\u5bf9\u8c61\n        ExponentialBackoffRetry policy = new ExponentialBackoffRetry(3000, 3);\n        // \u6784\u5efa\u5ba2\u6237\u7aef\n        CuratorFramework client = CuratorFrameworkFactory.builder()\n                .connectString("192.168.3.128:2181")\n                .connectionTimeoutMs(2000)\t// \u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\n                .sessionTimeoutMs(20000)\t// \u4f1a\u8bdd\u8d85\u65f6\u65f6\u95f4 \u5355\u4f4dms\n                .retryPolicy(policy)\t\t// \u91cd\u8bd5\u7b56\u7565\n                .build();\n\n        // \u542f\u52a8\u5ba2\u6237\u7aef\n        client.start();\n        System.out.println("zookeeper \u542f\u52a8\u6210\u529f");\n        return client;\n    }\n    \n    public static void main(String[] args) {\n        // \u521b\u5efa\u5206\u5e03\u5f0f\u95011\n        InterProcessMutex lock1 = new InterProcessMutex(getCuratorFramework(), "/locks");\n\n        // \u521b\u5efa\u5206\u5e03\u5f0f\u95012\n        InterProcessMutex lock2 = new InterProcessMutex(getCuratorFramework(), "/locks");\n\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                lock1.acquire();\n                System.out.println("\u7ebf\u7a0b1 \u83b7\u53d6\u5230\u9501");\n\n                Thread.sleep(5 * 1000);\n\n                lock1.release();\n                System.out.println("\u7ebf\u7a0b1 \u91ca\u653e\u9501");\n            }\n        }).start();\n\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                lock2.acquire();\n                System.out.println("\u7ebf\u7a0b2 \u83b7\u53d6\u5230\u9501");\n\n                Thread.sleep(5 * 1000);\n\n                lock2.release();\n                System.out.println("\u7ebf\u7a0b2 \u91ca\u653e\u9501");\n\n            }\n        }).start();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.apache.curator</groupId>\n    <artifactId>curator-framework</artifactId>\n    <version>4.3.0</version>\n</dependency>\n<dependency>\n    <groupId>org.apache.curator</groupId>\n    <artifactId>curator-recipes</artifactId>\n    <version>4.3.0</version>\n</dependency>\n<dependency>\n    <groupId>org.apache.curator</groupId>\n    <artifactId>curator-client</artifactId>\n    <version>4.3.0</version>\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\u6e90\u7801\u89e3\u6790",children:"\u6e90\u7801\u89e3\u6790"}),"\n",(0,l.jsx)(n.h3,{id:"\u670d\u52a1\u7aef-1",children:"\u670d\u52a1\u7aef"}),"\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u7a0b\u5e8f\u7684\u5165\u53e3 QuorumPeerMain"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public static void main(String[] args) {\n    QuorumPeerMain main = new QuorumPeerMain();\n    main.initializeAndRun(args);\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"initializeAndRun \u7684\u5de5\u4f5c\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u89e3\u6790\u542f\u52a8\u53c2\u6570"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u63d0\u4ea4\u5468\u671f\u4efb\u52a1\uff0c\u5b9a\u65f6\u5220\u9664\u8fc7\u671f\u7684\u5feb\u7167"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u521d\u59cb\u5316\u901a\u4fe1\u6a21\u578b\uff0c\u9ed8\u8ba4\u662f NIO \u901a\u4fe1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// QuorumPeerMain#runFromConfig\npublic void runFromConfig(QuorumPeerConfig config) {\n    // \u901a\u4fe1\u4fe1\u7ec4\u4ef6\u521d\u59cb\u5316\uff0c\u9ed8\u8ba4\u662f NIO \u901a\u4fe1\n    ServerCnxnFactory cnxnFactory = ServerCnxnFactory.createFactory();\n    // \u521d\u59cb\u5316NIO \u670d\u52a1\u7aefsocket\uff0c\u7ed1\u5b9a2181 \u7aef\u53e3\uff0c\u53ef\u4ee5\u63a5\u6536\u5ba2\u6237\u7aef\u8bf7\u6c42\n    cnxnFactory.configure(config.getClientPortAddress(), config.getMaxClientCnxns(), false);\n    // \u542f\u52a8 zk\n    quorumPeer.start();\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"\u542f\u52a8 zookeeper"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// QuorumPeer#start\npublic synchronized void start() {\n    if (!getView().containsKey(myid)) {\n        throw new RuntimeException("My id " + myid + " not in the peer list");\n    }\n    // \u51b7\u542f\u52a8\u6570\u636e\u6062\u590d\uff0c\u5c06\u5feb\u7167\u4e2d\u6570\u636e\u6062\u590d\u5230 DataTree\n    loadDataBase();\n    // \u542f\u52a8\u901a\u4fe1\u5de5\u5382\u5b9e\u4f8b\u5bf9\u8c61\n    startServerCnxnFactory();\n    try {\n        adminServer.start();\n    } catch (AdminServerException e) {\n        LOG.warn("Problem starting AdminServer", e);\n        System.out.println(e);\n    }\n    // \u51c6\u5907\u9009\u4e3e\u73af\u5883\n    startLeaderElection();\n    // \u6267\u884c\u9009\u4e3e\n    super.start();\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u9009\u4e3e\u673a\u5236",children:"\u9009\u4e3e\u673a\u5236"}),"\n",(0,l.jsx)(n.h4,{id:"\u73af\u5883\u51c6\u5907",children:"\u73af\u5883\u51c6\u5907"}),"\n",(0,l.jsx)(n.p,{children:"QuorumPeer#startLeaderElection \u521d\u59cb\u5316\u9009\u4e3e\u73af\u5883\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"synchronized public void startLeaderElection() {\n    try {\n        // Looking \u72b6\u6001\uff0c\u9700\u8981\u9009\u4e3e\n        if (getPeerState() == ServerState.LOOKING) {\n            // \u9009\u7968\u7ec4\u4ef6: myid (serverid), zxid, epoch\n            // \u5f00\u59cb\u9009\u7968\u65f6\uff0cserverid \u662f\u81ea\u5df1\uff0c\u3010\u5148\u6295\u81ea\u5df1\u3011\n            currentVote = new Vote(myid, getLastLoggedZxid(), getCurrentEpoch());\n        }\n    }\n    if (electionType == 0) {\n        try {\n            udpSocket = new DatagramSocket(getQuorumAddress().getPort());\n            // \u54cd\u5e94\u6295\u7968\u7ed3\u679c\u7ebf\u7a0b\n            responder = new ResponderThread();\n            responder.start();\n        } catch (SocketException e) {\n            throw new RuntimeException(e);\n        }\n    }\n    // \u521b\u5efa\u9009\u4e3e\u7b97\u6cd5\u5b9e\u4f8b\n    this.electionAlg = createElectionAlgorithm(electionType);\n}\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// zk\u603b\u7684\u53d1\u9001\u548c\u63a5\u6536\u961f\u5217\u51c6\u5907\u597d\nprotected Election createElectionAlgorithm(int electionAlgorithm){\n    // \u8d1f\u8d23\u9009\u4e3e\u8fc7\u7a0b\u4e2d\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\uff0c\u521b\u5efa\u5404\u79cd\u961f\u5217\u548c\u96c6\u5408\n    QuorumCnxManager qcm = createCnxnManager();\n    QuorumCnxManager.Listener listener = qcm.listener;\n    if(listener != null){\n        // \u542f\u52a8\u76d1\u542c\u7ebf\u7a0b, \u8c03\u7528 client = ss.accept()\u963b\u585e\uff0c\u7b49\u5f85\u5904\u7406\u8bf7\u6c42\n        listener.start();\n        // \u51c6\u5907\u597d\u53d1\u9001\u548c\u63a5\u6536\u961f\u5217\u51c6\u5907\n        FastLeaderElection fle = new FastLeaderElection(this, qcm);\n        // \u542f\u52a8\u9009\u4e3e\u7ebf\u7a0b\uff0c\u3010WorkerSender \u548c WorkerReceiver\u3011\n        fle.start();\n        le = fle;\n    }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u9009\u4e3e\u6e90\u7801",children:"\u9009\u4e3e\u6e90\u7801"}),"\n",(0,l.jsx)(n.p,{children:"\u5f53 Zookeeper \u542f\u52a8\u540e\uff0c\u9996\u5148\u90fd\u662f Looking \u72b6\u6001\uff0c\u901a\u8fc7\u9009\u4e3e\u8ba9\u5176\u4e2d\u4e00\u53f0\u670d\u52a1\u5668\u6210\u4e3a Leader"}),"\n",(0,l.jsxs)(n.p,{children:["\u6267\u884c ",(0,l.jsx)(n.code,{children:"super.start()"})," \u76f8\u5f53\u4e8e\u6267\u884c ",(0,l.jsx)(n.code,{children:"QuorumPeer#run()"})," \u65b9\u6cd5"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public void run() {\n    case LOOKING:\n        // \u8fdb\u884c\u9009\u4e3e\uff0c\u9009\u4e3e\u7ed3\u675f\u8fd4\u56de\u6700\u7ec8\u6210\u4e3a Leader \u80dc\u9009\u7684\u90a3\u5f20\u9009\u7968\n        setCurrentVote(makeLEStrategy().lookForLeader());\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"FastLeaderElection \u7c7b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"lookForLeader\uff1a\u9009\u4e3e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public Vote lookForLeader() {\n    // \u6b63\u5e38\u542f\u52a8\u4e2d\u5176\u4ed6\u670d\u52a1\u5668\u90fd\u4f1a\u5411\u6211\u53d1\u9001\u4e00\u4e2a\u6295\u7968\uff0c\u4fdd\u5b58\u6bcf\u4e2a\u670d\u52a1\u5668\u7684\u6700\u65b0\u5408\u6cd5\u6709\u6548\u7684\u6295\u7968\n    HashMap<Long, Vote> recvset = new HashMap<Long, Vote>();\n\t// \u5b58\u50a8\u5408\u6cd5\u9009\u4e3e\u4e4b\u5916\u7684\u6295\u7968\u7ed3\u679c\n    HashMap<Long, Vote> outofelection = new HashMap<Long, Vote>();\n\t// \u4e00\u6b21\u9009\u4e3e\u7684\u6700\u5927\u7b49\u5f85\u65f6\u95f4\uff0c\u9ed8\u8ba4\u503c\u662f0.2s\n    int notTimeout = finalizeWait;\n\t// \u6bcf\u53d1\u8d77\u4e00\u8f6e\u9009\u4e3e\uff0clogicalclock++,\u5728\u6ca1\u6709\u5408\u6cd5\u7684epoch \u6570\u636e\u4e4b\u524d\uff0c\u90fd\u4f7f\u7528\u903b\u8f91\u65f6\u949f\u4ee3\u66ff\n    synchronized(this){\n        // \u66f4\u65b0\u903b\u8f91\u65f6\u949f\uff0c\u6bcf\u8fdb\u884c\u4e00\u6b21\u9009\u4e3e\uff0c\u90fd\u9700\u8981\u66f4\u65b0\u903b\u8f91\u65f6\u949f\n        logicalclock.incrementAndGet();\n        // \u66f4\u65b0\u9009\u7968(serverid\uff0c zxid, epoch\uff09\n        updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());\n    }\n    // \u5e7f\u64ad\u9009\u7968\uff0c\u628a\u81ea\u5df1\u7684\u9009\u7968\u53d1\u7ed9\u5176\u4ed6\u670d\u52a1\u5668\n    sendNotifications();\n    // \u4e00\u8f6e\u4e00\u8f6e\u7684\u9009\u4e3e\u76f4\u5230\u9009\u4e3e\u6210\u529f\n    while ((self.getPeerState() == ServerState.LOOKING) && (!stop)){ }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"sendNotifications\uff1a\u5e7f\u64ad\u9009\u7968"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"private void sendNotifications() {\n    // \u904d\u5386\u6295\u7968\u53c2\u4e0e\u8005\uff0c\u7ed9\u6bcf\u53f0\u670d\u52a1\u5668\u53d1\u9001\u9009\u7968\n    for (long sid : self.getCurrentAndNextConfigVoters()) {\n\t\t// \u521b\u5efa\u53d1\u9001\u9009\u7968\n        ToSend notmsg = new ToSend(...);\n        // \u628a\u53d1\u9001\u9009\u7968\u653e\u5165\u53d1\u9001\u961f\u5217\n        sendqueue.offer(notmsg);\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"FastLeaderElection \u4e2d\u6709 WorkerSender \u7ebf\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"ToSend m = sendqueue.poll(3000, TimeUnit.MILLISECONDS)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u963b\u585e\u83b7\u53d6\u8981\u53d1\u9001\u7684\u9009\u7968"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"process(m)"}),"\uff1a\u5904\u7406\u8981\u53d1\u9001\u7684\u9009\u7968"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"manager.toSend(m.sid, requestBuffer)"}),"\uff1a\u53d1\u9001\u9009\u7968"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"if (this.mySid == sid)"}),"\uff1a\u5982\u679c",(0,l.jsx)(n.strong,{children:"\u6d88\u606f\u7684\u63a5\u6536\u8005 sid \u662f\u81ea\u5df1"}),"\uff0c\u76f4\u63a5\u8fdb\u5165\u81ea\u5df1\u7684 RecvQueue\uff08\u81ea\u5df1\u6295\u81ea\u5df1\uff09"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"else"}),"\uff1a\u5982\u679c\u63a5\u6536\u8005\u662f\u5176\u4ed6\u670d\u52a1\u5668\uff0c\u521b\u5efa\u5bf9\u5e94\u7684\u53d1\u9001\u961f\u5217\u6216\u8005\u590d\u7528\u5df2\u7ecf\u5b58\u5728\u7684\u53d1\u9001\u961f\u5217\uff0c\u628a\u6d88\u606f\u653e\u5165\u8be5\u961f\u5217"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"connectOne(sid)"}),"\uff1a\u5efa\u7acb\u8fde\u63a5"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"sock.connect(electionAddr, cnxTO)"}),"\uff1a\u5efa\u7acb\u4e0e sid \u670d\u52a1\u5668\u7684\u8fde\u63a5"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"initiateConnection(sock, sid)"}),"\uff1a\u521d\u59cb\u5316\u8fde\u63a5"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"startConnection(sock, sid)"}),"\uff1a\u521b\u5efa\u5e76\u542f\u52a8\u53d1\u9001\u5668\u7ebf\u7a0b\u548c\u63a5\u6536\u5668\u7ebf\u7a0b"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"dout = new DataOutputStream(buf)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u83b7\u53d6 Socket \u8f93\u51fa\u6d41"}),"\uff0c\u5411\u670d\u52a1\u5668\u53d1\u9001\u6570\u636e"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"din = new DataInputStream(new BIS(sock.getInputStream())))"}),"\uff1a\u901a\u8fc7\u8f93\u5165\u6d41\u8bfb\u53d6\u5bf9\u65b9\u53d1\u9001\u8fc7\u6765\u7684\u9009\u7968"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"if (sid > self.getId())"}),"\uff1a\u63a5\u6536\u8005 sid \u6bd4\u6211\u7684\u5927\uff0c\u6ca1\u6709\u8d44\u683c\u7ed9\u5bf9\u65b9\u53d1\u9001\u8fde\u63a5\u8bf7\u6c42\u7684\uff0c\u76f4\u63a5\u5173\u95ed\u81ea\u5df1\u7684\u5ba2\u6237\u7aef"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SendWorker sw"}),"\uff1a\u521d\u59cb\u5316\u53d1\u9001\u5668\uff0c\u5e76\u542f\u52a8\u53d1\u9001\u5668\u7ebf\u7a0b\uff0c\u7ebf\u7a0b run \u65b9\u6cd5\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"while (running && !shutdown && sock != null)"}),"\uff1a\u8fde\u63a5\u6ca1\u6709\u65ad\u5f00\u5c31\u4e00\u76f4\u8fd0\u884c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ByteBuffer b = pollSendQueue()"}),"\uff1a\u4ece\u53d1\u9001\u961f\u5217 SendQueue \u4e2d\u83b7\u53d6\u53d1\u9001\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"lastMessageSent.put(sid, b)"}),"\uff1a\u66f4\u65b0\u5bf9\u4e8e sid \u8fd9\u53f0\u670d\u52a1\u5668\u7684\u6700\u8fd1\u4e00\u6761\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"send(b)"}),"\uff1a",(0,l.jsx)(n.strong,{children:"\u6267\u884c\u53d1\u9001"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"RecvWorker rw"}),"\uff1a\u521d\u59cb\u5316\u63a5\u6536\u5668\uff0c\u5e76\u542f\u52a8\u63a5\u6536\u5668\u7ebf\u7a0b\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"din.readFully(msgArray, 0, length)"}),"\uff1a\u8f93\u5165\u6d41\u63a5\u6536\u6d88\u606f"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"addToRecvQueue(new Message(messagg, sid))"}),"\uff1a\u5c06\u6d88\u606f\u653e\u5165\u63a5\u6536\u6d88\u606f recvQueue \u961f\u5217"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"FastLeaderElection \u4e2d\u6709 WorkerReceiver \u7ebf\u7a0b"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"response = manager.pollRecvQueue()"}),"\uff1a\u4ece RecvQueue \u4e2d",(0,l.jsx)(n.strong,{children:"\u963b\u585e\u83b7\u53d6\u51fa\u9009\u4e3e\u6295\u7968\u6d88\u606f"}),"\uff08\u5176\u4ed6\u670d\u52a1\u5668\u53d1\u9001\u8fc7\u6765\u7684\uff09"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(42039).A+"",width:"1645",height:"846"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u72b6\u6001\u540c\u6b65",children:"\u72b6\u6001\u540c\u6b65"}),"\n",(0,l.jsx)(n.p,{children:"\u9009\u4e3e\u7ed3\u675f\u540e\uff0c\u6bcf\u4e2a\u8282\u70b9\u90fd\u9700\u8981\u6839\u636e\u89d2\u8272\u66f4\u65b0\u81ea\u5df1\u7684\u72b6\u6001\uff0cLeader \u66f4\u65b0\u72b6\u6001\u4e3a Leader\uff0c\u5176\u4ed6\u8282\u70b9\u66f4\u65b0\u72b6\u6001\u4e3a Follower\uff0c\u6574\u4f53\u6d41\u7a0b\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Follower \u9700\u8981\u8ba9 Leader \u77e5\u9053\u81ea\u5df1\u7684\u72b6\u6001 (sid, epoch, zxid)"}),"\n",(0,l.jsxs)(n.li,{children:["Leader \u63a5\u6536\u5230\u4fe1\u606f\uff0c",(0,l.jsx)(n.strong,{children:"\u6839\u636e\u4fe1\u606f\u6784\u5efa\u65b0\u7684 epoch"}),"\uff0c\u8981\u8fd4\u56de\u5bf9\u5e94\u7684\u4fe1\u606f\u7ed9 Follower\uff0cFollower \u66f4\u65b0\u81ea\u5df1\u7684 epoch"]}),"\n",(0,l.jsxs)(n.li,{children:["Leader \u9700\u8981\u6839\u636e Follower \u7684\u72b6\u6001\uff0c\u786e\u5b9a\u4f55\u79cd\u65b9\u5f0f\u7684\u6570\u636e\u540c\u6b65 DIFF\u3001TRUNC\u3001SNAP\uff0c\u5c31\u662f\u8981",(0,l.jsx)(n.strong,{children:"\u4ee5 Leader \u670d\u52a1\u5668\u6570\u636e\u4e3a\u51c6"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"DIFF\uff1aLeader \u63d0\u4ea4\u7684 zxid \u6bd4 Follower \u7684 zxid \u5927\uff0c\u53d1\u9001 Proposal \u7ed9 Follower \u63d0\u4ea4\u6267\u884c"}),"\n",(0,l.jsx)(n.li,{children:"TRUNC\uff1aFollower \u7684 zxid \u6bd4leader \u7684 zxid \u5927\uff0cFollower \u8981\u8fdb\u884c\u56de\u6eda"}),"\n",(0,l.jsx)(n.li,{children:"SNAP\uff1aFollower \u6ca1\u6709\u4efb\u4f55\u6570\u636e\uff0c\u76f4\u63a5\u5168\u91cf\u540c\u6b65"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"\u6267\u884c\u6570\u636e\u540c\u6b65\uff0c\u5f53 Leader \u63a5\u6536\u5230\u8d85\u8fc7\u534a\u6570 Follower \u7684 Ack \u4e4b\u540e\uff0c\u8fdb\u5165\u6b63\u5e38\u5de5\u4f5c\u72b6\u6001\uff0c\u96c6\u7fa4\u542f\u52a8\u5b8c\u6210"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(15987).A+"",width:"1683",height:"811"})}),"\n",(0,l.jsx)(n.p,{children:"\u6838\u5fc3\u51fd\u6570\u89e3\u6790\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Leader \u66f4\u65b0\u72b6\u6001\u5165\u53e3\uff1a",(0,l.jsx)(n.code,{children:"Leader.lead()"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"zk.loadData()"}),"\uff1a\u6062\u590d\u6570\u636e\u5230\u5185\u5b58"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"cnxAcceptor = new LearnerCnxAcceptor()"}),"\uff1a\u542f\u52a8\u901a\u4fe1\u7ec4\u4ef6\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"s = ss.accept()"}),"\uff1a\u7b49\u5f85\u5176\u4ed6 Follower \u8282\u70b9\u5411 Leader \u8282\u70b9\u53d1\u9001\u540c\u6b65\u72b6\u6001"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"LearnerHandler fh "}),"\uff1a\u63a5\u6536\u5230 Follower \u7684\u8bf7\u6c42\uff0c\u5c31\u521b\u5efa LearnerHandler \u5bf9\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"fh.start()"}),"\uff1a\u542f\u52a8\u7ebf\u7a0b\uff0c\u901a\u8fc7 switch-case \u8bed\u6cd5\u5224\u65ad\u63a5\u6536\u7684\u547d\u4ee4\uff0c\u6267\u884c\u76f8\u5e94\u7684\u64cd\u4f5c"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Follower \u66f4\u65b0\u72b6\u6001\u5165\u53e3\uff1a",(0,l.jsx)(n.code,{children:"Follower.followerLeader()"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"QuorumServer leaderServer = findLeader()"}),"\uff1a\u67e5\u627e Leader"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"connectToLeader(addr, hostname) "}),"\uff1a\u4e0e Leader \u5efa\u7acb\u8fde\u63a5"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"long newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO)"}),"\uff1a\u5411 Leader \u6ce8\u518c"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h4,{id:"\u4e3b\u4ece\u5de5\u4f5c",children:"\u4e3b\u4ece\u5de5\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:"Leader\uff1a\u4e3b\u670d\u52a1\u7684\u5de5\u4f5c\u6d41\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(34833).A+"",width:"1527",height:"617"})}),"\n",(0,l.jsxs)(n.p,{children:["Follower\uff1a\u4ece\u670d\u52a1\u7684\u5de5\u4f5c\u6d41\u7a0b\uff0c\u6838\u5fc3\u51fd\u6570\u4e3a ",(0,l.jsx)(n.code,{children:"Follower#followLeader()"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"readPacket(qp)"}),"\uff1a\u8bfb\u53d6\u4fe1\u606f"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"processPacket(qp)"}),"\uff1a\u5904\u7406\u4fe1\u606f"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"protected void processPacket(QuorumPacket qp) throws Exception{\n    switch (qp.getType()) {\n        case Leader.PING:\n            break;\n        case Leader.PROPOSAL:\n            break;\n        case Leader.COMMIT:\n            break;\n        case Leader.COMMITANDACTIVATE:\n            break;\n        case Leader.UPTODATE:\n            break;\n        case Leader.REVALIDATE:\n            break;\n        case Leader.SYNC:\n            break;\n        default:\n            break;\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"\u5ba2\u6237\u7aef-1",children:"\u5ba2\u6237\u7aef"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:s(58869).A+"",width:"1626",height:"861"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},40404:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA-Maven\u751f\u547d\u5468\u671f-c9c959946e83c167bb7b364f8345891a.png"},51091:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA\u4f7f\u7528\u754c\u9762\u64cd\u4f5c\u8df3\u8fc7\u6d4b\u8bd5-971a79e2d048feff5d9a1a6b8c23360c.png"},18307:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA\u521b\u5efaMaven-quickstart-c05bb9f68e0de69a1c90e9370461bde5.png"},75787:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA\u521b\u5efaMaven-webapp-ffff4afa9cdb1b19f7c7246e90f5caed.png"},5543:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA\u521b\u5efaMaven\u76ee\u5f55\u7ed3\u6784-c6a82118cc802bbf5e5a9734d081c3f6.png"},43448:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA\u73af\u5883\u4e2d\u8d44\u6e90\u4e0a\u4f20\u4e0e\u4e0b\u8f7d-ba6a7e13b09cb7cde253ca222d862bea.png"},42335:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA\u914d\u7f6eMaven-b2a17a89d79adc771c38e99d55a7848c.png"},28836:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/IDEA\u914d\u7f6eMaven\u547d\u4ee4-f128da09ec0825097e4a59719785f8d3.png"},14988:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven-default\u751f\u547d\u5468\u671f-425fccb9f1d90e7282834c427b7ba8c1.png"},43943:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u4ecb\u7ecd-3f3707184bb539e641098c8e50b25d72.png"},41679:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u4f9d\u8d56\u8303\u56f4-a38fe7a445e94651af1048197522a696.png"},9250:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u4f9d\u8d56\u8303\u56f4\u7684\u4f20\u9012\u6027-23086e9c0e6f2278d2d22af335e0848a.png"},60345:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u6807\u51c6\u7ed3\u6784-b786be7519196f4e0f01f3d1baa07a93.png"},33103:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u6a21\u5757\u5212\u5206-71ee1f38c12c0a7fe9168cdf6f1375a6.png"},33135:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u7248\u672c\u7edf\u4e00\u7684\u91cd\u8981\u6027-b1bd7709abec3770ad39ee9e2fa62773.png"},82534:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u79c1\u670d\u8d44\u6e90\u83b7\u53d6-f58782f3edd3d960602f5114e18ab804.png"},18955:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Maven\u914d\u7f6e\u73af\u5883\u53d8\u91cf-cade8a157a607cf5ad44250ce99358bf.png"},95796:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-ByteBuf\u7ec4\u6210-1602873c05c606e94dead4a6dfa8f12e.png"},86918:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-ChannelPipeline-29ba572c97a5cdb51b30f4ea83cf4811.png"},40741:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-Channel\u4e0ePipeline-068508adeda1f7821e2ddd02dab264a4.png"},24465:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-Proactor\u6a21\u578b-a71152914622bbe2e723611d855aecfb.png"},47420:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-Protobuf\u7f16\u8bd1\u6587\u4ef6-c61e7ba621e4aa83bd4c7fe43630f9e1.png"},68323:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-Reactor\u6a21\u578b-d9dfd7d0c0ddb913a610eeffc491c60d.png"},47418:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-TCP\u4e09\u6b21\u63e1\u624b-9d0e284225e9ea947b65598f4de86714.png"},55228:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u4e3b\u4eceReactor\u591a\u7ebf\u7a0b-5bd9d3ce0c1a183d40a18f2e7f8e02af.png"},17451:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u4f20\u7edf\u963b\u585eIO\u670d\u52a1\u6a21\u578b-88e70e91289e4bd340147349aa6d321b.png"},27261:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u529f\u80fd\u7279\u6027-e3e81a770dc339e4ef8eeb5ec7b3c9a3.png"},2509:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u5355Reactor\u5355\u7ebf\u7a0b-2e3888145e98523743c77c6ec7fecfa6.png"},64073:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u5355Reactor\u591a\u7ebf\u7a0b-ae0459f5969278850588a0b56a45decf.png"},94770:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u5de5\u4f5c\u6a21\u578b-592eca0794bf1a838bdd4e4deacd0fe7.png"},88410:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u7f16\u7801\u89e3\u7801-2567d6d3dbcbc233d06aff831c360935.png"},7415:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Netty-\u81ea\u5b9a\u4e49\u534f\u8bae-b783f887f11bed6ada5d8d7e7565526e.png"},45301:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-Broker\u5de5\u4f5c\u6d41\u7a0b-671057277a73bc6e907419658a9576b9.png"},95119:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-IndexFile\u7d22\u5f15\u6587\u4ef6-e2674f31b0b56c0d59652312cfdb16f6.png"},78131:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-OP\u6d88\u606f-6695db5f3ab579eae4dba101eb25dd9c.png"},76324:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-Reactor\u8bbe\u8ba1-324c47410375b05949449abd1dcf718c.png"},8811:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-producer\u8d1f\u8f7d\u5747\u8861-c8fbd6a7287f3fd83ad3179bcaf1b91a.png"},53629:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u4e8b\u52a1\u5de5\u4f5c\u6d41\u7a0b-8c3ea721dfc90140685c007e5d230eec.png"},97726:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u4e8b\u52a1\u6d88\u606f-e931f6cca191b5ab2766e4ee6d1626c6.png"},17656:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u5237\u76d8\u673a\u5236-ac422214f456e86aaa6201b7a725f74a.png"},15813:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u5e73\u5747\u961f\u5217\u5206\u914d-c1ea99c95b767f680816d190248510a1.png"},96765:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u5e73\u5747\u961f\u5217\u8f6e\u6d41\u5206\u914d-decd7d1f3a28df7c4c3f5891c1d1f972.png"},97081:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u5f02\u6b65\u901a\u4fe1\u6d41\u7a0b-e1ec8aa2d08ec0cb8113287c85f29319.png"},8712:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u6570\u636e\u5206\u53d1-4fe5d9ca0e245d631ba19da166578cb8.png"},29242:(e,n,s)=>{s.d(n,{A:()=>r});const r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA6sAAAB9CAYAAABEbfUqAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAABdpSURBVHhe7d0HeFNV48fxg4CCqIAKCsIfceBAfeVBHCCCuHChqCigDMG9caGiAq8DF+IeIEPABYiKiAtxb8tQeRTUFxSxoKjIkCX2f38n97ZpSNKkbXJP2u/nefI0SZO0zT059/zOapUCjwEAAAAAwCGb+V8BAAAAAHAGYRUAAAAA4BzCKgAAAADAOYRVAAAAAIBzCKsAAAAAAOcQVgEAAAAAziGsAgAAAACcQ1gFAAAAADiHsAoAAAAAcA5hFQAAAADgHMIqAAAAAMA5hFUAAAAAgHOqFHj86zEm+l8rp/z8DaZBg+7+LQAAAACVG/ko2/mIkdUE8vO/8i5P+7cAAAAAoPIKIx8RVpMgsAIAAABARLbzEWG1BARWAAAAAIjIZj4irKaAwAoAAAAAEdnKR4TVFBFYAQAAACAiG/mIsJoGAisAAAAARGQ6HxFW00RgBQAAAICITOYjwmopEFgBAAAAICJT+YiwWkoEVgAAAACIyEQ+IqyWAYEVAAAAACLKOx8RVsuIwAoAAAAAEeWZjwir5YDACgAAAAAR5ZWPCKvlhMAKAAAAABHlkY+qFHj86zEm+l8rp5kzZ/rX0tOgwb7epbt/C+no2bOnmTt3rn8LLmjZsqUZPny4fwupoiy7pzKXZcqje6hbE6O8uofyGo18VBplyUeMrJYzRlhLj5OTe/Ly8vxrSAdl2T2VuSxTHt1D3ZoY5dU9lFeUVVnyESOrGdPF/4pUqedOqBTdwPEoPd47t1T240F5dAvHIzneH7dwPGKRj8om/XzEyCoAAAAAwDmEVQAAAACAcwirAAAAAADnEFYBAAAAAM4hrAIAAAAAnENYBQAAAAA4h7AKAAAAAHAOYRUAAAAA4BzCKgAAAADAOYRVAAAAAIBzCKsAAAAAAOcQVgEAAAAAziGsAgAAAACcQ1gFAAAAADiHsAoAAAAAcA5hFQAAAADgHMIqAAAAAMA5hFUAAAAAgHMIqwAAAAAA5xBWAQAAAADOIawCAAAAAJxDWAUAAAAAOIewCgAAAABwDmEVAAAAAOAcwioAAAAAwDmEVQAAAACAc3IirK5du8G/BmRPQUGBWbhwoX8rs/766y//GpDbKMuV24YNG8w///zj34pYtGiRrU9dks36HQAyobLkIyfC6tKlK83ixcvt9XbthtmvP/zwm1m2bJX5++/1pn37+8z69cVPfoEPPvjBv4aw5efn+9cqBjW6Tj31VP9WYo899ph/rYgaa08//bR9jVQcf/zx/jW4YOnSpebff//1b1VOa9euNRdddJH55Zdf/HtSQ1kuf7lUHqdMmWJuuukm/5bxzt3rzfnnn29Wr17t35M5eo9uueWWlN6rbNbvlQ31Z3IrV640p59+un8L2bZkyZKcKZ/ko4gqBQm7Oyf6XzNv0qRZ5s03vzWPP97NHox33uln+vYdby6++DDvpPCvGTp0upkw4Rz/0cXp8e++28+ccspwr/AVmM02q+J/p8jy5WvMjBmX+7eypYv/tfJo166d2WmnnUyHDh3MEUccYZo2bep/JzUtW7a0X/Py8uzXsKmRdcghh5T4+xx66KFepfCBf6vI4MGDTcOGDc25557r3xOfGj7HHnus9xl407/HDa4dj2y6/fbbzdtvv23Lsi4HHHCAqVq1qv/dkoX93gVld6uttvLviVi1alWx+3T7s88+S/i3PfDAA/bErvcjFZTlzAijPKpe23zzzf1biamsRdd/3bp1M1dffXXhz3zppZfMHXfcYerXr29vB5577jnz8ssvm1GjRtnb6hw54YQTzFVXXWXLUDxHHXWU6d27t+ncubN/T5F3333Xlr+DDjrIfP75515bIHlffLbq93gqet2a6/VnMqX9XERbvny5bSPlyvGvaOX12muvNV999VVh+WzRokWJ9UVx5KOyST8fORFW9SZedtkEM2BAR9O16yjzyCNdzeTJs81NNx3rHYi3zJo1G8yNN3b0H11c9MEYNaqHqVOnpv+dIh063E9YzYKgQgvssssutiJQpbz77rubKlU2/aBEC7tCVMMllk44sScm3VbDKBA0Zv7888/C3lI9T2Kfq0Z8bENMj9XJq27duqZ69er+vRGtW7cuNkqRTRW9QZWMGlvPP/+8f8uYbbbZxrRv396W5QMPPLDExkrY753KVJs2bWyjPbBx40b7u0f/Tvo9o8NqvICrU0T0Z1cB98MPP7Qnd8pydoRRHhOFtFjRj/v000/N8OHDzciRI73G1MXm0ksvNdddd51p3ry5ue222+xjJk6caF599VX7GJUrhVn9HVOnTrXlp2fPnqZVq1bm9ddfNzVq1DBbbLGFLbsqyyqfyRqVer7K2RdffOHfUyRb9XsqKnrdmuv1ZzKl+VzECsJqzZqbtldvvfVW+165pKKVV4XVt956y79lzLbbbmsOP/xwe0z0t1arVs3/TiLko7LJ0bCqNzKwaNGfpnHjuvb61Vcf6R2Ql72KrZrXmNrMrF69zmzYsNFcddURZty4z2yPwIoVa7yKsKY9CDrxVa26aSBatmw1YTUL1EhYt26df6u4Ro0a2YpAl7333jtucA27QtTP//jjjwtPpL/++qvp0qVLsYaLpu8cffTR9nFBQ/23334z9erVM/fcc49tlGnNnp736KOPml133dWemGrXrh33b5aBAwfax4heI7aRH5aKdoJKR2xjK1qtWrVM27ZtbVlWmVeDOlbY750a06UJq7G340n2GMpyZoRRHtXYvuaaa+yMmTp16niNpEfMMcccYzshVZe999579uv1119f2ChX0Lzyyivt/QqnnTp1Mt9995293HDDDfZ1NDKq12rWrJl9jkZLNcKq8KrXVr2qsNq3b19bZhV633nnHRtyH374YfucWN9++605++yz7fXoAKrr06ZNMzvssIN9D8Ko3+PJ9fJYklyvP5MpzeciVhBWc+X4V7TyGhtWo6ljRcdWx0ezNOJ3rJCPyib9fOTEmtXJk88zw4adZrbffiv7pnfsuLcZP763WbDgd/uGjx3by0ydeqHp3r2VOfXUFqZz5/3tc/QG16q1ReEbPXLkWXY4XJcWLRoXXj/00F3t95FZyRqmP//8s3nyySdtY0Zr2nTinzVrltPrBhYsWGCnNSei0YFhw4bZk62uqyEj9957r52mpoaM+oI0rU2NsVha73T33Xfbn6PX0eiz1nYtXrzYfwRcpLV3r732mm2w6ISmE59uZ2NNXjr02dLMhuCiUCDR95UXynJ4MlkedVw1Ffzvv/+2I59ff/114RrO8ePH28Z6QOHvm2++MXfddZet8xQyFSIvv/xyM2DAADuqftlll5lLLrmkMKgqTKqOVB36xx9/2FAY6NWrlx1d/fHHH82zzz5rpxcnsueee9qA+cYbb5gtt9zSXtdFITLReSnT9Tviy5X6M5l0PhfILStWrLCf5yuuuMKWT9VdCrZr1qzxH5Fd5KOI0EdW16/faB5//H0ze/bPZuDA402PHmPMoEHHm9GjPzb/+U8jM3/+r+bssw82Bx/c1Fx33YumdetdTKdO+/nPTjzMHc7QdrRIz0HQI4X4NF1QFYIuF154ob0vrN672J73QYMG2UpKo0VHHnmkvS+6510efPBBu/ZKU9m22247u7mIpsGpZ1lrsD755BM7JW306NGFI1FaVzV9+nT7uK233to2pjS9TK+rE59Ogvp52vxDDaKwUHbTF4wYqOxIWGU5WyOrlGW3laU8agRJo0RnnnmmDYMaEVMA7dq1qw2gWmuqhnn0dEeNOqrhro5JlYmAyojqRDXy+/fvb4477jg7nVe7BOu2Nivq16+fbSA2adLEjqyq7GpUVHWnRgVUz+qrRj0kCLqaJizB988666zC6biHHXaYLYcaLVEZyEb9norKWh5L4kr9mUy6nwuVD02HjxU9AyBWUP5cQXmNUAevymfbtr97xz3+sStPFT0fpSP0kdXq1auavfba0YwYcaZ3Usiz87APP7yZefjhM+xwdocOzcz77//gNbT+9T70P3kfmv+zz9PC4m++WWLWrfvH9Oo11ixZssL07PmkOemkx+xl5cq1hdd1mTVrkX0e3KRGhkvUuNIGEffdd5+deqYe9thRYPW0ffTRRzYE9OnTx0yaNMk2bNQw0pQ2rT1RD51GGrTGb8aMGbY3X9PL1DjTTqtjxoyxP0M/L9hgRK+htSznnXeeufHGG/2fhlygcuxCWVaZTHcKroKEaAQ2GHmNdwlQlt1X1vKoQKmRUIU0jWzqWKqu0zpUTeeNpYa7Oii0wZLMmTPHjqZqNFKbLN1///1e4+tx75x8ki0v2jU2KEcKfionasQHdL8CpL4Gf4em7eqy77772p1/g9s77rijnbKr9WcBlekgzEbLVP2OsnGl/ixJOp8LbS6l8Bl9UYhVqI29P7jATUH5zFYRJR8VcWbNqhYRaz52kyZFJxr1BGhL5m7dRplzz21jpk2ba4e8dSD0nD322MH7YP/PPPNMH+8k97QdCtcwueRiz0GuU4+3Nl8pidYPqXdKl/32269ww4yg9y7MkVU1etT4HjdunJ2qrDULGi1Qj6k2ntFUtpNPPtmeUJ544gnbsNLj1bOuhk2PHj1sZabn66L1LOpxP+ecc+w0Sf0MTWtTg0ojUeqxb9y4sZk7d659bkDTptUo0nPVAAxD2McjTMnWXEXTFEH1oCvEaVRAUxAl7PdOa6I0WqSZC9E01TK6Ma/bwSipnnPiiSd6J7/3/e/Gp7VYWo+ozy1lOTvCKI/ByNALL7xgf76OuUYdtYumGuSq/7SLZvA4URhdtmyZbcD//vvvdmRSv4vKQ3Dsta+BQp++r9HUgJoiwWtpBoBGVjXyqUCpOlVhMRiJ0hISjb5NnjzZDB061E7FVfnSe6SRrCFDhtjX0+to0yeVVb0H2ajfU5Hr5bEkuV5/JlOaz0Us1bXqFNTU4b322qvw73ZVRSuvydasRtNx0ewMtVVbF1tfTT4qmxxdszpmTE/7BmuetS633dbJVKtW1Wvg1DD162/tfeh39U4E070TQhv7+GrVNjNTplzg3dfZvvmNGtW1B03XTz/9CXtRz0FwvV+/SfZ5yKxgZCYeNWJVkY8dO9a88sortnGx//77FwZVV6iHXb3uOuGoISNa96RGiXrY1UgSXVfjSVN/RGv0tMZK/5My6HFVz6kqO00B0r83CCp89difccYZtjGl3nkFdjXM1NATjTTotdVLG29UAOFSo1sjPWrs6oR355132g02XGpwaN3NHnvsYadDBhetC5Po+6JpfalGp0qiIBB8binL4ctkedTxVVBTo/yhhx6y4U115GmnnVZ4jKNpIyR1YCjIaZRToXTEiBG2E0SBRBf9rgqxCqrff/+9faymUaoBGYxciMqwRmQ1cqlN+RQaRSOg+h00kqWgqPCrkU3R9EwFVNHvrtkF0eeYbNTvSC4X6s+SpPu5SESbhmkPD802UHlH+NSxqo3hdBxVPtUZoXqrKKhmF/kowomksGrVOrPPPg3MwIFTzYsvzjE33PCSdznGO8lUsT0K+r4k+se3S5b8ZerV29pe185WWjT8+ef97dfhw8/0Tp5/2O8hs2J3AtYaNZ3EtTmGeiF1UtcmFUFjxEXqYX/mmWdsQz+aTqTa/VHrAEWNJFVm0aNU+r52idT/3lMo1+YL2tFSvazRm4No6ljHjh0L3wdtk64pcurR13PU+Ne0Sv0MBQCETw1aTV3UFEc1dnVctNV9WCewkih4Jts8Jh6tNVQoSAdlORzZKo+q0zSqoFEghUCNYmrKo0bXdaz1s6Opnlfdpw4NNcK1pllhUVNkoy8BjTxpNo72K1Boif6XEQqpmkqukSedO5566ikbEjT1V6P1qnvV8annaAMkdYwobOr3FZW/2ACUjfodm8q1+rMk6X4uElFdqTXQ8+fPtwFJnSgq48gufc7V0aBOK3Xiah27RsYTrSnOJvJRhBNhtWHD2ua//z3BCzIN7P8NWrVqvZk3b6ntTRg8eJrd8Wro0FPMoEGvGP1/oVhz5iz2gtH2/i2ERdOo1AhQ41RTgCZMmGAuuOCClP7Hqit08lRDJZp68jVtRw0v9awHawFjGzzaIVInHp2w1POuqWFqsGlamnpQRVPOtOGHGj2iE5tOTmosaWMRTSXSV1WS6tHTph76uci+4ASmholOYDfffLNtzLpwAivJ7NmzC3cvTZV2Xg0a66mgLGdXGOVRo2Da1Vm05ljHT/+CRjQyGr3rqcKbRkn1eym8aSaN/jdpMnqMguo+++zjNaqWFBt912ZLwc9Wx4vOJwoE2klYf7eCqV5fM3RUFyvEdu/e3b6GZvloZ+LosCmZrt9RJJfrz5Kk87koidpHCrvqHJk5c6atV5F5Wo6mmROa+aFznz7Xmm0R3WHmAvJRROhrVtUroCHsvLyfTLt2u5m+fdt4J6DV5sMP/2c++OAH7+RU3QwZcpLXANrcfPLJAtO//4teZdDBDn3rfwpp0XDz5g3tc7Vlc6tWd5qmTbfzX13TeQrsFDUNn2dX5Vuzmp+fbxo0aODfSl/Y6yL087VWKfZkqsaM1tNo0xg1ZNQg0qYhgei1KVofpWlBOuEMHjzY9rr/9NNPtkGmNYR63sKFCwt3RlUjXr2wQQWpk56mSGtEIWwVbZ1KOrTxi/6NRmmnqYf53qkMaWRT5XDnnXf27y3aDViNa11XQ1+7sqrMap2qRsM0Uprqxkz6XGg0i7KceWGUx2Rr7tQpoXKidacaPdf0X5UpjQxp4yNNB1fnpehnx4ZGhcNgp2qNLqnciTZY0nTbeM+R3XbbzYafWJpWrL9NDU9NCVa5UznURk9BZ4peM9P1uwJ2Kh2zuV4eS5LL9WdJ0v1cxBOsWQ0+A66raOW1rOWTfFRW6ecjJzZYeu+9771GVBNTo0bxRtLMmYu8k0Fjr/L37/AsXbrC1K1by/TuPdb88stfXoXQ0msU6aAcZGrXrrnJwmH1OvTpM46wmgPCrhDVq66wnaixoUaNvhf7/eDkNW/ePPu/4zSdRxtxRI8SKMhrMxCNOufKKHNFb1BlUpjv3ZdffmmnMwX/9y+g8qvNIrTJjEY4FCZVdrWBjTZF0sY4wb8FqWgqe1kuzd+frFGuNXZa3qHGnuo7Ta9NROu9YnfKjb0vUd2aKm0UpnCq9Waisq3fLbox6lL9Tt2anMvvT3l8LgiruY58VDY5GlbLSn9BCueHLCOsposK0S0cj9IL+73TOsBgZCseVftq0Kc6iprrKntZ5rPsFo5Hcrw/buF4xCIflU36+ai0Y+BOce9AAEB4kgVV0ehPZQmqAABURhUlH1WIsAoAAAAAqFgIqwAAAAAA5xBWAQAAAADOIawCAAAAAJxDWAUAAAAAOIewCgAAAABwDmEVAAAAAOAcwioAAAAAwDmEVQAAAACAcwirAAAAAADnEFYBAAAAAM4hrAIAAAAAnENYBQAAAAA4h7AKAAAAAHAOYRUAAAAA4BzCKgAAAADAOYRVAAAAAIBzCKsAAAAAAOcQVgEAAAAAziGsAgAAAACcQ1gFAAAAADiHsAoAAAAAcA5hFQAAAADgHMIqAAAAAMA5hFUAAAAAgHOqFHj86zEm+l9ROl38r0hVy5Yt/WtwSV5enn8NqaIsu6mylmXKo5uoW+OjvLqJ8hogH5VN+vmIkVU4gxOUe5o3b+5fQzooy+6pzGWZ8uge6tbEKK/uobwiTIysZgwjqwAAAEDFQT4qG0ZWAQAAAAAVAGEVAAAAAOAcwioAAAAAwDmEVQAAAACAcwirAAAAAADnEFYBAAAAAM4hrAIAAAAAnENYBQAAAAA4h7AKAAAAAHAOYRUAAAAA4BzCKgAAAADAOYRVAAAAAIBzCKsAAAAAAOdUKfD41wEAAAAAcAIjqwAAAAAA5xBWAQAAAADOIawCAAAAAJxDWAUAAAAAOIewCgAAAABwDmEVAAAAAOAcwioAAAAAwDmEVQAAAACAcwirAAAAAADnEFYBAAAAAM4hrAIAAAAAHGPM/wM3IMrNd/MzjAAAAABJRU5ErkJggg=="},16875:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u6d41\u91cf\u524a\u5cf0-94aab774d1c38e91a6fe78bc25bc4d4a.png"},14313:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u6d88\u606f\u534f\u8bae-e72b7214b8cc73642e83939d91fda871.png"},90703:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u6d88\u606f\u5b58\u50a8\u7ed3\u6784-7453fb8b16dfe9abb085b5e722a99f30.png"},55820:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u6d88\u606f\u5b58\u53d6-d00b38374eee5556cd812802ae3d153a.png"},62759:(e,n,s)=>{s.d(n,{A:()=>r});const r="data:image/png;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QAiRXhpZgAATU0AKgAAAAgAAQESAAMAAAABAAEAAAAAAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCABMAb0DASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9/KKRztXPTHJrI8F6rNrGkSTT7d8d7d24wMfLFcyxr/46goA2KKKKACiiigAooooAKKKju22wMfSgCTNGa+Avgx4M8Y2X/BX7xh4nuNH15tN1ibUrGeO48H3toulWUdjpsdrcnX2/0TULWWS1LRafGfMt5L6duTHME5W68D/Ge7/bk8XzeA5tQ0jVLrUPEttDeXngnV9PtNNWTTzJp9/eapcyNYaxai7gt4UtLWKOSJb1nEmYZKVN8yi31jf08ieb87H6T5or87r/AONHx0+JNr8P/jJ4am+I0M3jj4feLNZ8KeCo9FiudEW+lhsLnQ7DV3hgcxSSxRSyGaWeIJJvgSdfNKy/Qn/BNjx544+IHwm1q68ca54m166h1cRWM3iHwzdaFqUcH2O1Zo5Un0rTFmImMzCSG22AOIi7vEzGoq8bv5+X9f10NJRsrn0bRRRSJCiiigAooooAKKKRjgUALRXK6T4ourr4za5orsn2Gx0fTr2JdvzeZPNfI/P+7bpXVUAFFFNnGYjQA7NGa+T/ANnn44fE7xZ+3n430Hxl4f8AFegeHZNCe80TT7gaY2m2EFrqM1rHP58NxJPLcXqHzzuCpGiJGVV4y8vzJ8OT8XPhP8SfiV4w0L/hINPg8I6X4l1rVYrvwXqug2t0LXxJFfRWc9xqcr22rTXmnxXkEN5ZiJbOJt33ZYVWaT51F7Xv+F/8g5XzuHa342/K5+peaK/PTxv4n/aC8Hat4n8ZWesfEu88R+KvhvZano3hu28Px3ujaVcHUr+a6hLw2c6x39jYXdokalme9eD/AFV2YxGv0/8AsE+L/FPjr9n6y1Lxdq2ta1qU99eNBcavoVzouofZvPfyo7i3uNP0996LhfMFnCJFVXAbduautv66hLT8PxSf62PbKKKKACio7t2jtZGXbuVSRnpXPfB7xFdeLvhR4X1W9Ia81TSLW7nIGAZJIUdv1JoA6WiiigAooooAKKKKACiio7w4t2+96cDrQ9FcCTNGa/P/AP4JGeC/G3hv4q/E/UvEuha9p58UadaX17He+Fr3w+dL1I3+qSSafNNcKI9ZuYo7hIjq9sAtxFbwFhny3fyD9kPXvjB+zL+z/wCLfiPDa+Kriz8G+DfCOoa1o934J1fww9/JYfaDrVilrqzu99qk9rNu/tC2EUc01taxEgB6qNpf1/X37dt0PT+v6/L59bfq/mivzv8AHniH9or4JW3jqabxV8S/E3i2+s/DF7ewWPhU3Gi6PZyG3h1ebSZbfS7jfcxulwRbbbmYJJ5ptpTtNfYH7HmteJPEH7OHhG98Xandaz4hurMtdX1zpM+l3Fz87+W01vNa2jxy+Xt3k2turPuZYYlYIsrVXIcrS5T1CiiigoKKKKACiiigAoopHO1c9McmgBaKx/BeqzaxpEk0+3fHe3duMDHyxXMsa/8AjqCtigBHG5a+F/22/i9+2V4BtLWH9nf4W/DHxX4em1y6GoajqWvO2sQQnUJRKy2cq20SADJDLNcE/wDPPOK+6T0rn/hr/wAi7cf9hTUf/S2egCNNR8TNL8ulaGdvrq8vzYzn/l245PuPbvUn9oeKP+gPoP8A4OJf/kWugooA5/8AtDxR/wBAfQf/AAcS/wDyLR/aHij/AKA+g/8Ag4l/+Ra6CigDn/7Q8Uf9AfQf/BxL/wDItH9oeKP+gPoP/g4l/wDkWugooA5/+0PFH/QH0H/wcS//ACLQ2o+KAP8AkD6D/wCDiX/5FroKKAObF/4oI/5A+g/+DeX/AORqy/G3hzUPiP4R1Tw/4g8KeEda0LW7WSx1DT76/e5tb23kUpJFLE1rtkRlJBU8EEg9a7ijFTGNkkHU5LTpvEWmxQ29voPh23t7dBHDHFqsqoigYCgC1woUADHToO1W11PxQT/yB9B/8HEv/wAi10VFFne4PU5/+0PFH/QH0H/wcS//ACLR/aHij/oD6D/4OJf/AJFroKKoDn/7Q8Uf9AfQf/BxL/8AItH9oeKP+gPoP/g4l/8AkWugooA5/wDtDxR/0B9B/wDBxL/8i0f2h4o/6A+g/wDg4l/+Ra6CigDnZdQ8UGNv+JNoLcdBrEvP/ktXzz/wUX+JH7UXgH4TeG7v9nnwB4L8YeM7jxNbW2oWGq6lvs20xre4ad5DJ9m2BXWHDpIWycCN84r6ooPSgD4Y+KvxS/bG0bwzrWq+BfhL8F9S+LbeGtKbUNIn8aXkljEBcap5Rg8yztxLK/zbo5J41j2qN8mcj3z9j/xh8ZvFH7NHgnUPil4X8P6T8Q7zS45PENmmomBLW8P30CRxSoADnlZGHTlutdroH/JxPin/ALFvRv8A0p1Wu2oA5/8AtDxR/wBAfQf/AAcS/wDyLSPf+KGXH9j6B/4OJef/ACVroaKAOVA8QLqX2waD4dF00flmb+1ZfM25ztz9lztrO8d+DLr4peG5tF8S+DfBniDR7iWGaSx1K9N3bSSQypNE7RyWhUlJY0dSR8rIpHIFd3RRsCunc5eC+8TJt26P4fAwOBq823HbH+jY7dhVgaj4oB/5A+g/+DiX/wCRa6CigDn/AO0PFH/QH0H/AMHEv/yLQdQ8UY/5A+gnntrEv/yNXQUUAfFUPxg/bUm/b98ceH4fhT8L7j9nyzey/szX9S8QzWGobWsbdrryWijne4KztOVR7SIEjYZQORzHw5+Lf7aWn/tAfBXRLH4U/CyP4AXemwJq+vWHiGW+1FIhprND5okjheDfMIwVjt5wCQvm4Jc/e1//AMeM3+4f5Vyv7PX/ACQLwP8A9gCw/wDSeOgC8NR8UCT5dH0HHQf8TeUY6/8ATrTv7Q8Uf9AfQf8AwcS//ItdBRQBz/8AaHij/oD6D/4OJf8A5Fo/tDxR/wBAfQf/AAcS/wDyLXQUUAc//aHij/oD6D/4OJf/AJFo/tDxR/0B9B/8HEv/AMi10FFAHP8A9oeKP+gPoP8A4OJf/kWg6h4ox/yB9B/8HEv/AMi10FFAHOPfeJ2X5tI0HB/6jEv/AMjVieN/Bd18StNtrXxF4O8G63a2l7BqMEN9eNdx29zBIssE6K9rgSRyIrq3VWVWHIFd9RQBzMd/4nWUf8SbQskf9BiU8+n/AB656Z5Pc4qX+0PFAP8AyB9B/wDBxL/8i10OKKOoHP8A9oeKP+gPoP8A4OJf/kWj+0PFH/QH0H/wcS//ACLXQUUAc/8A2h4o/wCgPoP/AIOJf/kWj+0PFH/QH0H/AMHEv/yLXQUUAc//AGh4o/6A+g/+DiX/AORaP7Q8Uf8AQH0H/wAHEv8A8i10FFAHPPqPijYc6PoPPH/IYl/+RhXy1+2l8Wv2xvB37R3w6sfgf8Mfhx4u8F39rdHxbLrutNb29gwkiELJcfJKrFfNBCW9wec7DX2NQelAHF/Ai51W6+H8MuuWmn6fq819fte21jeveWtvN9sm3JFM8UTyIDu+Zo0P+yvSu0rn/hr/AMi7cf8AYU1H/wBLZ66CgBsnKH17VR8P6HD4etJIIWZkkuZ7k7v70sryt/485rQbpXD+C/h74f1fTru5utD0i6uJNU1DdLNZxyM3+mT9yCaAO4orn/8AhVfhj/oW9B/8F8X/AMTR/wAKr8Mf9C3oP/gvi/8AiaAOgorn/wDhVfhj/oW9B/8ABfF/8TR/wqvwx/0Leg/+C+L/AOJoA6CjNc+fhX4X/wChb0H/AMF8X/xNNPwr8L/9C5oP/gvi/wDiaOlwOizRmubPwp8MsP8AkXdCHP8Az4Rf/E04fCrwzn/kXNB5/wCofF/8TRo1dCTvY6LNGa5tvhZ4ZLf8i5oX/gvi/wDiaF+FPhkMf+Kd0Lt/y4Rf/E0Joev9ep0lFc9/wqzwvn/kW9B/8F8X/wATQPhX4X/6FzQf/BfF/wDE0uZdQOhozXP/APCrPC5/5lvQf/BfF/8AE0g+FfhfP/IuaD/4L4v/AImmGh0NFc//AMKr8Mf9C3oP/gvi/wDiaP8AhVfhj/oW9B/8F8X/AMTQB0FFc/8A8Kr8Mf8AQt6D/wCC+L/4mj/hVfhj/oW9B/8ABfF/8TQB0FNk5Q4zk8ZHasH/AIVX4Y/6FvQf/BfF/wDE0f8ACq/DH/Qt6D/4L4v/AImgCaw8IwWnj3UdeWRmuNRsLTT3T+BUt5Ll1I9yblx/wEVtV53pfww8Mt8WtZT/AIR3QfLXR9PYD+z4v+e19/s10n/Cq/DH/Qt6D/4L4v8A4mgDoKK5/wD4VX4Y/wChb0H/AMF8X/xNB+Ffhg/8y3oP/gvi/wDiaAOgornf+FWeGc/8i3oP/gvh/wDiaUfCvwwR/wAi3oP/AIL4v/iaV9LgdDRXP/8ACrPC4/5lzQf/AAXxf/E0f8Kr8Lj/AJlvQf8AwXxf/E0J3A6Ciuf/AOFV+GP+hb0H/wAF8X/xNH/Cq/DH/Qt6D/4L4v8A4mmBu3EfnQMu5l3AjcOq+4rL8DeFbfwJ4N0fQ7VpJLfR7OGxiZ/vMkUYjUt9QoqhqHws8Miwmx4b0H7jf8w+L0/3ayPhf8LPDLfDXw6x8N6Dk6Xa/wDMPi/55L/s0Ad7RXP/APCq/DH/AELeg/8Agvi/+Jo/4VZ4X/6FvQf/AAXxf/E0AdBRXP8A/Cq/DH/Qt6D/AOC+L/4mkHwr8Mf9C3oP/gvi/wDiaAOhorn/APhVfhj/AKFvQf8AwXxf/E0f8Ks8Ln/mW9B/8F8X/wATQB0GaM1zo+FPhn/oXNC/8F8X/wATQvwp8Mf9C5oX/gvi/wDiaAOizRmudHwr8MHn/hG9B/8ABfF/8TQPhb4XJ/5FvQf/AAXxf/E07MDoqM1zp+Ffhcf8y3oP/gvi/wDiad/wqvwv/wBC3oP/AIL4v/iaQHQUVzw+FXhj/oW9B/8ABfF/8TR/wqrwz/0Leg/+C+L/AOJqeYDoc4ornj8LPC4/5lzQf/BfF/8AE0f8Ks8L5/5FvQf/AAXxf/E1XWweh0NFc/8A8Kr8Mf8AQt6D/wCC+L/4mj/hVfhj/oW9B/8ABfF/8TQB0FNk5Q+vasH/AIVX4Y/6FvQf/BfF/wDE0N8K/C+P+Rb0H/wXxf8AxNAGh4f0OHw9aSQQszJJcz3J3f3pZXlb/wAec1oVzPwm0y30jwpJb2sENtbxanqIWKJAir/ps/YcV01AAelc/wDDX/kXbj/sKaj/AOls9dAelc/8Nf8AkXbj/sKaj/6Wz0AdBRRRQAUUUdaAIr6QR2cjMdoCkk46Cvmn4Xftu654o/Z90H4t614dt5PDvxGisJfBHhjQgbvXL4Xz5s1nnmeG1WaSFo5HU7Yrc+aDPIqCVvpe5z5DbR83QfX8x/OvB5P+Ccfwnj0nVtPh0/xdYaVq10t8mn2XjLWbSw0i6W5S5WfT7aO6WHT5hOm8PaJEcvIOkrq2b5udW2Hf3Wupxdz/AMFUtFgMa2/wn+MV88LWsGrpDa6SreH7y51i70ZLO5Et+rPJ9vs5It9t50JR0lSRod0iTXP/AAVD0230iC6j+EfxenkXzl1e3ii0bzfDskWqT6XLHcZ1ILKwuoCP9FM4KyIwJBYr6b4S/Yr+G3g7Q/7O07w7JFautl5pl1O6mnuntNRl1SGaeZ5WkmnN9PNO8rsXmaVjK0mcVop+yn4DM2qH+wsDWpJJb3F7Pid5L99Qc/6zjN1I78Addn+rAQaT1T5RytbTyPB/GH/BTXWNJsFv9K+FPjS6ure/0zRb7wpd/wBmQa1ZXN1r40qRzcJfyWjqoO9QjlHaSEGZQZTD6ldftd2vhT4ReLPF3iDR9Q26D4nPhqy03TQs19qlzJfR2VlbIrOqCae4niiG+RYlZ9zuiAldjxr+xb8N/H2na9b6poV1u8TSx3N9PaaveWVyJo70XscsM0MqSQTR3QWVJISkiuqlWBArF8R/8E+vhn4pvvEs1/aeMLqLxZL5+oWbeONc+wiffBIt3Dai8EFtdpLbQyR3MCJNFIm9HVizGIyfK299fzT/AM/vB/Gmtr/pY8/+JX/BV/wz8NdDaO78DeOB4shluba88N3cul2d7YTxXdpaKGeS7EVwJJL60KfYmuWKTphC7Ijdl8Uvj58QtT+OOreAfhvo/hJtb8KeE7PxVqsviO8nWC6a8nvYbOwhWBS6F20+68y5bKwjycQ3BkbyvN/j5/wSuh8c65ps3gvxRrXhFtP0rULaz1QeI9aTWNH1K8uY55NWNzFeI+oSMYYcwXxkixbxKpRPMjk9w+Mn7H3gX4++INP1rxFa+IF1jTrJ9MN7o/iHUNEuL2zc7mtbtrKeE3UBYl/JmDoGZiFBZs3aPJdr+v8AIiErXT9T5P8AFf8AwVW+KHjjwTq3ijwD8LfEC6DqHhHwZqPh43em6ddTG78RXKIs7E6zbedHDHIqC3KQF5kbdcRxsrV6pqP/AAVv8A+HPDOu3F5oviNb7Q/FX/CDpY3F3o2n3F/qqLdySx7J9QQWSLDZzXAa/a2WSFomhMxkQN7Jq37J/wAPdUtriD/hF7eOC8m0S5e3tZ5rWBW0aeO40xVSJ1VI4JIkIVRsYJtcOuFPP65/wT9+FnivVtW1LUNN8TXmtaxe2+ovrL+LdY/tW0lglu5IRaXv2oT2cafbr1FjtnjjEV1LFt8tyhctlb+rtMtOLWqI/wBlH9tD/hqnxtrlrp/gPxdofh3T9N03VLDXtUe1SLUVvbOG6ELQLKZ4ZoxNsYPHtzE+Hxt3e7V598Nf2c/DPwv8Ytr2k/8ACRf2rJo9roNxNfeJNS1AXsFtkRS3CXE7pNdhcBruRWuHXCtKy4A9AC4NGhF2LRRRSGFFFFAHNaT/AMld1z/sD6d/6Ovq6Wua0n/kruuf9gfTv/R19XS0AFNkOEp1NlG6Nh6+1AHlv7Wfxg8Q/A34L3fiLwzoN14gvLW6tYp1g0+51N7G2eZEnu/slqDc3Xkxs0hhhHmOEwOa8T1//gpgnw98K6h4ifS7v4qeHbLw1oOrCTwDY2pkml1CfVLdXhW9v4zcCaayitY7SJTci4kVAJTMPK+kvix8LrD4u+FG0fU7rxHZ2rzx3BfRtfvdEusxsGH+kWcsUwQkAMu8Bl3KwZSVPleuf8E2vhD4s0nR7WbRvFFnNoK2xsr/AE/xnrem6kkkAv8AypXvILpLiSfOqagzSyO0jtcuzljtIIWSsxh4D/4KEeDfH37Vl78JdP0/xA2uafLNZ3d8ZLGS1t76G2iupbWSNLhrpGWKYfvmtxbF42jWYuFVvoBORXmng39lnwj4J+Mt5460mPxNY61qiYvrdPE2pjS72QRJD9pm083BtJLkxxxqZ3iMrBVLMWUGvTaqTT2IjF3uFFFFSUQ6j/yD5/8Arm38qx/hb/yTPw7/ANgu2/8ARS1saj/yD5/+ubfyrH+Fv/JM/Dv/AGC7b/0UtAG9SP8AdpaKAGuTs/nxXh/7X/7VF7+zNrHw7kt9Ns9R0nxF4ji0/wAQTSSusmkaa5EL3yKowyxXE1sZd2AkTSOfu17hL9w1wfxZ/Z/8J/HayvLHxZosetWGo6JqXhy5hnnlVJbDUBGt3AyK4DCRYUG7G5QuEIDMalxu0NHzPpf/AAV40rwx4M8T614u8M3EMn/CbXXh7wjp+lajZx3HiPTV0yDVLe/MuoS2ttGZbWUSLGZ85dIxlyUHVax/wVw+G+iaR461I6P4qk074fwaVc6nM8mmWkqR6k1v9nlkt7i8juLSDbcB3ub2K3tlWGY+aRGa9G8bfsK/DTx7BcR3Gk6xpc89/b6nHe6H4i1LRb6xngsY9PRre5s54pbcfZI1hZY3VXXcGDZJput/sPeAfEfiy+164Xx1Jrl9Ypp39oDxzri3VpbCW3maC3lW8D20UklrbmaOEoJvLHmBwWzcndilq9Dz34lf8FW/AnwW8ax6P4t0LxHpMc3hmXxN9sj1HRdQRUi02XU5Ld4LW/mu0dba3nPnNCLVmjIWdw0bPjeJP+Cw3g/wNoOp6jrHgvxdZy2ms3ejWunHVdDNzqLWllDeXc0Up1AWbxxi5hiCpcNK0r+WIyyuqa3xO/4JNfDDWvhnr2k+C7K+8G6td6O+m6a39t6tNo+nyf2OdGWZ9OS8jhkk/s7Fs0g2TGMZWVHAkB8Kf+CZOi2Pgm50vxdrXjK6httZOp+HE0nx34jtr3wnG9rHBNbW+qm9/tB4p3V5ZIzKsJLovkgxCRlJa3Xn+af5aDVkdv8AHX4z+OtC8U/DeLwU3hNtJ+IGojShJrNndedbE2F7e+eFjdMrttUjEbBGzISWGAG4of8ABVfwTF4y8ceHrzQfEFtrPgfU7DS3tzqeh3C6o97fy2NuY5bfUZYrfM0L5jvWtpQCo8veRHXv/iL4WaH4wvvDF1qNvcXlx4Nv/wC09IdrubdbXP2W4s97EPmU+TdTqfMDDLhvvorD57+MH/BLTwb4g8FXVj4QOraS2oanZX2oWuoeKtbuLO6tbe9lvfsduy3gk06P7TKZg1p5Y3RxqyvGDHSlJqcWtr6j09nrul+Ke/6G7b/t9Wuqfs1+AvigvhfXrTQfHGuxWC2K2kmt6ktrLJOkcyQ6cLgzF9iuBAZYwj7g7IC1c1/w9W8OeGPDnhHVvEXhrxBDZ+NPGOp+F7KdZLLTZrAW+tf2VBLc2Go3NtqLF2eJmS3tZmjy+5VUpv8AVvgP+zKvw1+DPhjwv4p1rVPGV14V1SfVdPvb7ULyaa0LzzvbwiaeaS4nFtDOIFa4lkd1jVmO44FTxh+wZ8MPHeu2usXWia1BeWd1cXuNP8Sapp8d682oDUpFuYobiNLhDeKJBFMGRcugAR3RlGPLeP8AXT/IneKb/rf/ADX3HmV1/wAFPH8UeItPj8CfD3xV4vjsvGGpeEdZ0uxu9EbVnls7G7uGZEk1OMWu1rZMpemGZkmQrDhgw6bwz/wUt8HeM/Cuo+JNF8M+O9V8H6Lodpqup+IIrKCO2sZ7uxtL+100wSTi7kvJLe9tWAhgkiVpwjSo4dV7zwd+xx8PvAnxLvPGVrpuq3Piq9uBcSatqeu6hqV0u2K5iWNZLmdysKJeXXlwj93H57lVGcjnF/4JzfCGC0uLWHw3q9rp2oaDD4av9LtPEmqQabqNpDafY4ftFotwsE88dukcaXUqNOoiixJ+6Qrpoo+Yb6HFeO/+CnMWjeH/ABBpemfDL4kSfFDS4NXkl8I3MWlrd6elhZWt3JeTT/blspLTbqOmgGC6eRjeBdgeKfyug+Cf/BRvwn8XP2gbX4Z21pqNxr8cHlXeo2r2jacl8llDdy2/lC4N7GBHMSJZbdYC0bR+aZNita1b/gmd8Ide8NLp91pPit5pZr6WfWY/Getx67em9gitrlLjUkuxeXEbwW9tGYp5XjAtLYADyI9vceAv2TfBfw1+LV14y0G38QaXql9CIbq1t/EepJo9yyxRw+e+nef9je4McUSmdojMQi5c4qadr80iaybsofPzPTqKKKCgoPSig9KAOf8Ahr/yLtx/2FNR/wDS2eugrn/hr/yLtx/2FNR/9LZ66CgBH+73/DtXJaLYeIPDMU1ra6fot1C15c3EckmoyQttmmeUAqIGAxvx1/hrrqKAOf8A7Q8Uf9AfQf8AwcS//ItH9oeKP+gPoP8A4OJf/kWugooA5/8AtDxR/wBAfQf/AAcS/wDyLR/aHij/AKA+g/8Ag4l/+Ra6CigDn/7Q8Uf9AfQf/BxL/wDItH2/xQP+YPoP/g4l/wDkWugopagc+b/xQf8AmD6D/wCDiX/5Fo/tDxR/0B9B/wDBxL/8i10FFHQDn/7S8UD/AJg+g/8Ag4l/+RaBqPijP/IH0H/wcTf/ACLXQUUwOf8A7R8Uf9AfQf8AwcS//ItB1DxR/wBAfQf/AAcS/wDyLXQUUAc+L/xQP+YPoP8A4OJf/kWj+0vFBP8AyB9B/wDBxL/8i10FFAHP/wBoeKP+gPoP/g4l/wDkWj+0PFH/AEB9B/8ABxL/APItdBRQBz/9oeKP+gPoP/g4l/8AkWj+0PFH/QH0H/wcS/8AyLXQUUAc/wD2h4o/6A+g/wDg4l/+RaG1DxRj/kD6Afb+2Jf/AJFroKKAOJsrLxTb+NtQ1T+zdAZLuytrQR/2vL8vlPO+7/j1/i87H/AK1v7Q8Uf9AfQf/BxL/wDItdBRQBz/APaHij/oD6D/AODiX/5Fo/tDxR/0B9B/8HEv/wAi10FFAHP/ANoeKP8AoD6D/wCDiX/5FoOo+KQP+QPoP/g4l/8AkWugooA53+0/FH/QH0H/AMHEv/yNSjU/FBP/ACB9B/8ABxL/APItdDRQBz/9oeKP+gPoP/g4l/8AkWj+0PFH/QH0H/wcS/8AyLXQUUAc3dXXim5tZI/7J0FfMUrn+2JTjPf/AI9apeErfxT4e8L6ZYHSdAkaxtYrcv8A2vKN+xFXP/Hr7V2NFAHP/wBoeKP+gPoP/g4l/wDkWj+0PFH/AEB9B/8ABxL/APItdBRQBz/9oeKP+gPoP/g4l/8AkWj+0PFH/QH0H/wcS/8AyLXQUUAc+dS8UD/mD6D/AODiX/5FoOo+KAP+QPoP/g4l/wDkWugoo6Ac7/afij/oD6D/AODiX/5GpRqXign/AJA+g/8Ag4l/+Ra6Gip5QOfOoeKD/wAwfQf/AAcS/wDyLR9v8UL/AMwfQf8AwcS//ItdBRVbAc7/AGl4ob/mD6D/AODiX/5Gpwv/ABQP+YPoP/g4l/8AkWugooA5/wDtDxR/0B9B/wDBxL/8i0f2h4o/6A+g/wDg4l/+Ra6CipswOf8A7Q8Uf9AfQf8AwcS//ItH9oeKP+gPoP8A4OJf/kWugoqgOf8A7Q8Uf9AfQf8AwcS//ItH9oeKP+gPoP8A4OJf/kWugooA5/8AtDxR/wBAfQf/AAcS/wDyLQ2oeKCvzaPoOO//ABOJf/kWugooAw/Amk3Wi6IYb77Ot1Jd3Ny6wSGSNDLM8oUMVUnAf0rcoooA/9k="},22870:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u89e3\u8026-f99f14b87a417242c3b30440348c96fc.png"},62850:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u8d1f\u8f7d\u5747\u8861\u91cd\u65b0\u5e73\u8861\u7b97\u6cd5-a7b2f0352f75787d33e7a88b1d774cc6.png"},26525:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u96c6\u7fa4\u67b6\u6784-b1c5bbcf9912f5ea59546f238f27403a.png"},3688:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/RocketMQ-\u9ad8\u53ef\u7528-acb6d52dfedfe80460ea5f86a8b00002.png"},34833:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-Leader\u542f\u52a8-862114ecd2f8027e5bca4a2eba882874.png"},15229:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-Leader\u9009\u4e3e-7057e11452f990f2dbf467eb8ed5d0f6.png"},19732:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u5199\u5165\u8bf7\u6c42Follower-2434361d548e4e0933be9618c9048c5d.png"},42797:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u5199\u5165\u8bf7\u6c42Leader-57aabbc6245cb2ec0623eb7489cc6c4c.png"},14069:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u5206\u5e03\u5f0f\u9501\u539f\u7406-d7666ed297830c87984094606f7b5bcf.png"},2280:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u521d\u6b21\u9009\u4e3e\u673a\u5236-d0d94a452bfd28e64fa7a424e91fab52.png"},15987:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u540c\u6b65\u6e90\u7801-d1efa664a78727e1043cf51273ee47dd.png"},58869:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u5ba2\u6237\u7aef\u521d\u59cb\u5316-a04d31ef02147c23e3571fb9bf0aaaef.png"},13794:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u6846\u67b6\u7ed3\u6784-9edb3aaa6006386e6dcb0fa95274989c.png"},25592:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u6d88\u606f\u5e7f\u64ad-9f274ec755c5a954b047676547d442d3.png"},69735:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u76d1\u542c\u670d\u52a1\u5668\u72b6\u6001-93c7a250912ca2e500c80175e7c272da.png"},63860:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u8282\u70b9\u6811\u5f62\u7ed3\u6784-1d4f45545c57bfbc849f4ae41645fffb.png"},42039:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Zookeeper-\u9009\u4e3e\u6e90\u7801-ece305106c3f5e9b21df452bb17cc875.png"},69062:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/\u65e5\u5fd7-PatternLayout\u5e38\u7528\u7684\u9009\u9879-9ffdcba7685fa65796b0a9b74242da40.png"},78676:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/\u65e5\u5fd7\u4f53\u7cfb\u7ed3\u6784-d7144989ef25b6dc096856d7a06cdeb7.png"},28453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>d});var r=s(96540);const l={},i=r.createContext(l);function c(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);