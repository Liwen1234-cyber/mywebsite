"use strict";(self.webpackChunkmybase=self.webpackChunkmybase||[]).push([[74546],{86829:(n,e,l)=>{l.r(e),l.d(e,{assets:()=>c,contentTitle:()=>a,default:()=>o,frontMatter:()=>t,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"\u7801\u519c/JavaNote/Prog","title":"JUC","description":"\u8fdb\u7a0b","source":"@site/docs/\u7801\u519c/JavaNote/Prog.md","sourceDirName":"\u7801\u519c/JavaNote","slug":"/\u7801\u519c/JavaNote/Prog","permalink":"/\u7801\u519c/JavaNote/Prog","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{}}');var r=l(74848),s=l(28453);const t={},a="JUC",c={},d=[{value:"\u8fdb\u7a0b",id:"\u8fdb\u7a0b",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:3},{value:"\u5bf9\u6bd4",id:"\u5bf9\u6bd4",level:3},{value:"\u7ebf\u7a0b",id:"\u7ebf\u7a0b",level:2},{value:"\u521b\u5efa\u7ebf\u7a0b",id:"\u521b\u5efa\u7ebf\u7a0b",level:3},{value:"Thread",id:"thread",level:4},{value:"Runnable",id:"runnable",level:4},{value:"Callable",id:"callable",level:4},{value:"\u7ebf\u7a0b\u65b9\u6cd5",id:"\u7ebf\u7a0b\u65b9\u6cd5",level:3},{value:"API",id:"api",level:4},{value:"run start",id:"run-start",level:4},{value:"sleep yield",id:"sleep-yield",level:4},{value:"join",id:"join",level:4},{value:"interrupt",id:"interrupt",level:4},{value:"\u6253\u65ad\u7ebf\u7a0b",id:"\u6253\u65ad\u7ebf\u7a0b",level:5},{value:"\u6253\u65ad park",id:"\u6253\u65ad-park",level:5},{value:"\u7ec8\u6b62\u6a21\u5f0f",id:"\u7ec8\u6b62\u6a21\u5f0f",level:5},{value:"daemon",id:"daemon",level:4},{value:"\u4e0d\u63a8\u8350",id:"\u4e0d\u63a8\u8350",level:4},{value:"\u7ebf\u7a0b\u539f\u7406",id:"\u7ebf\u7a0b\u539f\u7406",level:3},{value:"\u8fd0\u884c\u673a\u5236",id:"\u8fd0\u884c\u673a\u5236",level:4},{value:"\u7ebf\u7a0b\u8c03\u5ea6",id:"\u7ebf\u7a0b\u8c03\u5ea6",level:4},{value:"\u672a\u6765\u4f18\u5316",id:"\u672a\u6765\u4f18\u5316",level:4},{value:"\u7ebf\u7a0b\u72b6\u6001",id:"\u7ebf\u7a0b\u72b6\u6001",level:3},{value:"\u67e5\u770b\u7ebf\u7a0b",id:"\u67e5\u770b\u7ebf\u7a0b",level:3},{value:"\u540c\u6b65",id:"\u540c\u6b65",level:2},{value:"\u4e34\u754c\u533a",id:"\u4e34\u754c\u533a",level:3},{value:"syn-ed",id:"syn-ed",level:3},{value:"\u4f7f\u7528\u9501",id:"\u4f7f\u7528\u9501",level:4},{value:"\u540c\u6b65\u5757",id:"\u540c\u6b65\u5757",level:5},{value:"\u540c\u6b65\u65b9\u6cd5",id:"\u540c\u6b65\u65b9\u6cd5",level:5},{value:"\u7ebf\u7a0b\u516b\u9501",id:"\u7ebf\u7a0b\u516b\u9501",level:5},{value:"\u9501\u539f\u7406",id:"\u9501\u539f\u7406",level:4},{value:"Monitor",id:"monitor",level:5},{value:"\u5b57\u8282\u7801",id:"\u5b57\u8282\u7801",level:5},{value:"\u9501\u5347\u7ea7",id:"\u9501\u5347\u7ea7",level:4},{value:"\u5347\u7ea7\u8fc7\u7a0b",id:"\u5347\u7ea7\u8fc7\u7a0b",level:5},{value:"\u504f\u5411\u9501",id:"\u504f\u5411\u9501",level:5},{value:"\u8f7b\u91cf\u7ea7\u9501",id:"\u8f7b\u91cf\u7ea7\u9501",level:5},{value:"\u9501\u81a8\u80c0",id:"\u9501\u81a8\u80c0",level:5},{value:"\u9501\u4f18\u5316",id:"\u9501\u4f18\u5316",level:4},{value:"\u81ea\u65cb\u9501",id:"\u81ea\u65cb\u9501",level:5},{value:"\u9501\u6d88\u9664",id:"\u9501\u6d88\u9664",level:5},{value:"\u9501\u7c97\u5316",id:"\u9501\u7c97\u5316",level:5},{value:"\u591a\u628a\u9501",id:"\u591a\u628a\u9501",level:4},{value:"\u6d3b\u8dc3\u6027",id:"\u6d3b\u8dc3\u6027",level:4},{value:"\u6b7b\u9501",id:"\u6b7b\u9501",level:5},{value:"\u5f62\u6210",id:"\u5f62\u6210",level:6},{value:"\u5b9a\u4f4d",id:"\u5b9a\u4f4d",level:6},{value:"\u6d3b\u9501",id:"\u6d3b\u9501",level:5},{value:"\u9965\u997f",id:"\u9965\u997f",level:5},{value:"wait-ify",id:"wait-ify",level:3},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528",level:4},{value:"\u4ee3\u7801\u4f18\u5316",id:"\u4ee3\u7801\u4f18\u5316",level:4},{value:"park-un",id:"park-un",level:3},{value:"\u5b89\u5168\u5206\u6790",id:"\u5b89\u5168\u5206\u6790",level:3},{value:"\u540c\u6b65\u6a21\u5f0f",id:"\u540c\u6b65\u6a21\u5f0f",level:3},{value:"\u4fdd\u62a4\u6027\u6682\u505c",id:"\u4fdd\u62a4\u6027\u6682\u505c",level:4},{value:"\u5355\u4efb\u52a1\u7248",id:"\u5355\u4efb\u52a1\u7248",level:5},{value:"\u591a\u4efb\u52a1\u7248",id:"\u591a\u4efb\u52a1\u7248",level:5},{value:"\u987a\u5e8f\u8f93\u51fa",id:"\u987a\u5e8f\u8f93\u51fa",level:4},{value:"\u4ea4\u66ff\u8f93\u51fa",id:"\u4ea4\u66ff\u8f93\u51fa",level:4},{value:"\u5f02\u6b65\u6a21\u5f0f",id:"\u5f02\u6b65\u6a21\u5f0f",level:3},{value:"\u4f20\u7edf\u7248",id:"\u4f20\u7edf\u7248",level:4},{value:"\u6539\u8fdb\u7248",id:"\u6539\u8fdb\u7248",level:4},{value:"\u963b\u585e\u961f\u5217",id:"\u963b\u585e\u961f\u5217",level:4},{value:"\u5185\u5b58",id:"\u5185\u5b58",level:2},{value:"JMM",id:"jmm",level:3},{value:"\u5185\u5b58\u6a21\u578b",id:"\u5185\u5b58\u6a21\u578b",level:4},{value:"\u5185\u5b58\u4ea4\u4e92",id:"\u5185\u5b58\u4ea4\u4e92",level:4},{value:"\u4e09\u5927\u7279\u6027",id:"\u4e09\u5927\u7279\u6027",level:4},{value:"\u53ef\u89c1\u6027",id:"\u53ef\u89c1\u6027",level:5},{value:"\u539f\u5b50\u6027",id:"\u539f\u5b50\u6027",level:5},{value:"\u6709\u5e8f\u6027",id:"\u6709\u5e8f\u6027",level:5},{value:"cache",id:"cache",level:3},{value:"\u7f13\u5b58\u673a\u5236",id:"\u7f13\u5b58\u673a\u5236",level:4},{value:"\u7f13\u5b58\u7ed3\u6784",id:"\u7f13\u5b58\u7ed3\u6784",level:5},{value:"\u7f13\u5b58\u4f7f\u7528",id:"\u7f13\u5b58\u4f7f\u7528",level:5},{value:"\u4f2a\u5171\u4eab",id:"\u4f2a\u5171\u4eab",level:4},{value:"\u7f13\u5b58\u4e00\u81f4",id:"\u7f13\u5b58\u4e00\u81f4",level:4},{value:"\u5904\u7406\u673a\u5236",id:"\u5904\u7406\u673a\u5236",level:4},{value:"volatile",id:"volatile",level:3},{value:"\u540c\u6b65\u673a\u5236",id:"\u540c\u6b65\u673a\u5236",level:4},{value:"\u6307\u4ee4\u91cd\u6392",id:"\u6307\u4ee4\u91cd\u6392",level:4},{value:"\u5e95\u5c42\u539f\u7406",id:"\u5e95\u5c42\u539f\u7406",level:4},{value:"\u7f13\u5b58\u4e00\u81f4",id:"\u7f13\u5b58\u4e00\u81f4-1",level:5},{value:"\u5185\u5b58\u5c4f\u969c",id:"\u5185\u5b58\u5c4f\u969c",level:5},{value:"\u4ea4\u4e92\u89c4\u5219",id:"\u4ea4\u4e92\u89c4\u5219",level:5},{value:"\u53cc\u7aef\u68c0\u9501",id:"\u53cc\u7aef\u68c0\u9501",level:4},{value:"\u68c0\u9501\u673a\u5236",id:"\u68c0\u9501\u673a\u5236",level:5},{value:"DCL\u95ee\u9898",id:"dcl\u95ee\u9898",level:5},{value:"\u89e3\u51b3\u65b9\u6cd5",id:"\u89e3\u51b3\u65b9\u6cd5",level:5},{value:"ha-be",id:"ha-be",level:3},{value:"\u8bbe\u8ba1\u6a21\u5f0f",id:"\u8bbe\u8ba1\u6a21\u5f0f",level:3},{value:"\u7ec8\u6b62\u6a21\u5f0f",id:"\u7ec8\u6b62\u6a21\u5f0f-1",level:4},{value:"Balking",id:"balking",level:4},{value:"\u65e0\u9501",id:"\u65e0\u9501",level:2},{value:"CAS",id:"cas",level:3},{value:"\u539f\u7406",id:"\u539f\u7406",level:4},{value:"\u4e50\u89c2\u9501",id:"\u4e50\u89c2\u9501",level:4},{value:"Atomic",id:"atomic",level:3},{value:"\u5e38\u7528API",id:"\u5e38\u7528api",level:4},{value:"\u539f\u7406\u5206\u6790",id:"\u539f\u7406\u5206\u6790",level:4},{value:"\u539f\u5b50\u5f15\u7528",id:"\u539f\u5b50\u5f15\u7528",level:4},{value:"\u539f\u5b50\u6570\u7ec4",id:"\u539f\u5b50\u6570\u7ec4",level:4},{value:"\u539f\u5b50\u66f4\u65b0\u5668",id:"\u539f\u5b50\u66f4\u65b0\u5668",level:4},{value:"\u539f\u5b50\u7d2f\u52a0\u5668",id:"\u539f\u5b50\u7d2f\u52a0\u5668",level:4},{value:"Adder",id:"adder",level:3},{value:"\u4f18\u5316\u673a\u5236",id:"\u4f18\u5316\u673a\u5236",level:4},{value:"\u4f2a\u5171\u4eab",id:"\u4f2a\u5171\u4eab-1",level:4},{value:"\u6e90\u7801\u89e3\u6790",id:"\u6e90\u7801\u89e3\u6790",level:4},{value:"ABA",id:"aba",level:3},{value:"Unsafe",id:"unsafe",level:3},{value:"final",id:"final",level:3},{value:"\u539f\u7406",id:"\u539f\u7406-1",level:4},{value:"\u4e0d\u53ef\u53d8",id:"\u4e0d\u53ef\u53d8",level:4},{value:"State",id:"state",level:3},{value:"Local",id:"local",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd",level:4},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-1",level:4},{value:"\u5e38\u7528\u65b9\u6cd5",id:"\u5e38\u7528\u65b9\u6cd5",level:5},{value:"\u5e94\u7528\u573a\u666f",id:"\u5e94\u7528\u573a\u666f",level:5},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406",level:4},{value:"\u5e95\u5c42\u7ed3\u6784",id:"\u5e95\u5c42\u7ed3\u6784",level:5},{value:"\u6210\u5458\u53d8\u91cf",id:"\u6210\u5458\u53d8\u91cf",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5",level:5},{value:"LocalMap",id:"localmap",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-1",level:5},{value:"\u6e05\u7406\u65b9\u6cd5",id:"\u6e05\u7406\u65b9\u6cd5",level:5},{value:"\u5185\u5b58\u6cc4\u6f0f",id:"\u5185\u5b58\u6cc4\u6f0f",level:4},{value:"\u53d8\u91cf\u4f20\u9012",id:"\u53d8\u91cf\u4f20\u9012",level:4},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-2",level:5},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-1",level:5},{value:"\u7ebf\u7a0b\u6c60",id:"\u7ebf\u7a0b\u6c60",level:2},{value:"\u57fa\u672c\u6982\u8ff0",id:"\u57fa\u672c\u6982\u8ff0",level:3},{value:"\u963b\u585e\u961f\u5217",id:"\u963b\u585e\u961f\u5217-1",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-1",level:4},{value:"\u6838\u5fc3\u65b9\u6cd5",id:"\u6838\u5fc3\u65b9\u6cd5",level:4},{value:"\u94fe\u8868\u961f\u5217",id:"\u94fe\u8868\u961f\u5217",level:4},{value:"\u5165\u961f\u51fa\u961f",id:"\u5165\u961f\u51fa\u961f",level:5},{value:"\u52a0\u9501\u5206\u6790",id:"\u52a0\u9501\u5206\u6790",level:5},{value:"\u6027\u80fd\u6bd4\u8f83",id:"\u6027\u80fd\u6bd4\u8f83",level:5},{value:"\u540c\u6b65\u961f\u5217",id:"\u540c\u6b65\u961f\u5217",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-1",level:5},{value:"\u975e\u516c\u5b9e\u73b0",id:"\u975e\u516c\u5b9e\u73b0",level:5},{value:"\u516c\u5e73\u5b9e\u73b0",id:"\u516c\u5e73\u5b9e\u73b0",level:5},{value:"\u64cd\u4f5cPool",id:"\u64cd\u4f5cpool",level:3},{value:"\u521b\u5efa\u65b9\u5f0f",id:"\u521b\u5efa\u65b9\u5f0f",level:4},{value:"Executor",id:"executor",level:5},{value:"Executors",id:"executors",level:5},{value:"\u5f00\u53d1\u8981\u6c42",id:"\u5f00\u53d1\u8981\u6c42",level:5},{value:"\u63d0\u4ea4\u65b9\u6cd5",id:"\u63d0\u4ea4\u65b9\u6cd5",level:4},{value:"\u5173\u95ed\u65b9\u6cd5",id:"\u5173\u95ed\u65b9\u6cd5",level:4},{value:"\u5904\u7406\u5f02\u5e38",id:"\u5904\u7406\u5f02\u5e38",level:4},{value:"\u5de5\u4f5c\u539f\u7406",id:"\u5de5\u4f5c\u539f\u7406",level:3},{value:"\u72b6\u6001\u4fe1\u606f",id:"\u72b6\u6001\u4fe1\u606f",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-2",level:4},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-2",level:4},{value:"\u63d0\u4ea4\u65b9\u6cd5",id:"\u63d0\u4ea4\u65b9\u6cd5-1",level:5},{value:"\u6dfb\u52a0\u7ebf\u7a0b",id:"\u6dfb\u52a0\u7ebf\u7a0b",level:5},{value:"\u8fd0\u884c\u65b9\u6cd5",id:"\u8fd0\u884c\u65b9\u6cd5",level:5},{value:"\u505c\u6b62\u65b9\u6cd5",id:"\u505c\u6b62\u65b9\u6cd5",level:5},{value:"Future",id:"future",level:4},{value:"\u7ebf\u7a0b\u4f7f\u7528",id:"\u7ebf\u7a0b\u4f7f\u7528",level:5},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-3",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-3",level:5},{value:"\u4efb\u52a1\u8c03\u5ea6",id:"\u4efb\u52a1\u8c03\u5ea6",level:3},{value:"Timer",id:"timer",level:4},{value:"Scheduled",id:"scheduled",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-4",level:4},{value:"\u6210\u5458\u53d8\u91cf",id:"\u6210\u5458\u53d8\u91cf-1",level:5},{value:"\u5ef6\u8fdf\u4efb\u52a1",id:"\u5ef6\u8fdf\u4efb\u52a1",level:5},{value:"\u5ef6\u8fdf\u961f\u5217",id:"\u5ef6\u8fdf\u961f\u5217",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-4",level:4},{value:"\u63d0\u4ea4\u4efb\u52a1",id:"\u63d0\u4ea4\u4efb\u52a1",level:5},{value:"\u8fd0\u884c\u4efb\u52a1",id:"\u8fd0\u884c\u4efb\u52a1",level:5},{value:"ForkJoin",id:"forkjoin",level:3},{value:"\u4eab\u5143\u6a21\u5f0f",id:"\u4eab\u5143\u6a21\u5f0f",level:3},{value:"\u540c\u6b65\u5668",id:"\u540c\u6b65\u5668",level:2},{value:"AQS",id:"aqs",level:3},{value:"\u6838\u5fc3\u601d\u60f3",id:"\u6838\u5fc3\u601d\u60f3",level:4},{value:"\u8bbe\u8ba1\u539f\u7406",id:"\u8bbe\u8ba1\u539f\u7406",level:4},{value:"\u6a21\u677f\u5bf9\u8c61",id:"\u6a21\u677f\u5bf9\u8c61",level:4},{value:"\u81ea\u5b9a\u4e49",id:"\u81ea\u5b9a\u4e49",level:4},{value:"Re-Lock",id:"re-lock",level:3},{value:"\u9501\u5bf9\u6bd4",id:"\u9501\u5bf9\u6bd4",level:4},{value:"\u4f7f\u7528\u9501",id:"\u4f7f\u7528\u9501-1",level:4},{value:"\u516c\u5e73\u9501",id:"\u516c\u5e73\u9501",level:4},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-3",level:5},{value:"\u975e\u516c\u539f\u7406",id:"\u975e\u516c\u539f\u7406",level:5},{value:"\u52a0\u9501",id:"\u52a0\u9501",level:6},{value:"\u89e3\u9501",id:"\u89e3\u9501",level:6},{value:"\u516c\u5e73\u539f\u7406",id:"\u516c\u5e73\u539f\u7406",level:5},{value:"\u53ef\u91cd\u5165",id:"\u53ef\u91cd\u5165",level:4},{value:"\u53ef\u6253\u65ad",id:"\u53ef\u6253\u65ad",level:4},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-4",level:5},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-2",level:5},{value:"\u9501\u8d85\u65f6",id:"\u9501\u8d85\u65f6",level:4},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-5",level:5},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-3",level:5},{value:"\u54f2\u5b66\u5bb6\u5c31\u9910",id:"\u54f2\u5b66\u5bb6\u5c31\u9910",level:5},{value:"\u6761\u4ef6\u53d8\u91cf",id:"\u6761\u4ef6\u53d8\u91cf",level:4},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-6",level:5},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-4",level:5},{value:"await",id:"await",level:6},{value:"signal",id:"signal",level:6},{value:"ReadWrite",id:"readwrite",level:3},{value:"\u8bfb\u5199\u9501",id:"\u8bfb\u5199\u9501",level:4},{value:"\u7f13\u5b58\u5e94\u7528",id:"\u7f13\u5b58\u5e94\u7528",level:4},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-5",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-5",level:5},{value:"\u52a0\u9501\u539f\u7406",id:"\u52a0\u9501\u539f\u7406",level:5},{value:"\u89e3\u9501\u539f\u7406",id:"\u89e3\u9501\u539f\u7406",level:5},{value:"Stamped",id:"stamped",level:4},{value:"CountDown",id:"countdown",level:3},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-7",level:4},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-6",level:4},{value:"CyclicBarrier",id:"cyclicbarrier",level:3},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-8",level:4},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-7",level:4},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-6",level:5},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-5",level:5},{value:"Semaphore",id:"semaphore",level:3},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528-9",level:4},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-8",level:4},{value:"PROPAGATE",id:"propagate",level:4},{value:"Exchanger",id:"exchanger",level:3},{value:"\u5e76\u53d1\u5305",id:"\u5e76\u53d1\u5305",level:2},{value:"ConHashMap",id:"conhashmap",level:3},{value:"\u5e76\u53d1\u96c6\u5408",id:"\u5e76\u53d1\u96c6\u5408",level:4},{value:"\u96c6\u5408\u5bf9\u6bd4",id:"\u96c6\u5408\u5bf9\u6bd4",level:5},{value:"\u5e76\u53d1\u6b7b\u94fe",id:"\u5e76\u53d1\u6b7b\u94fe",level:5},{value:"\u6210\u5458\u5c5e\u6027",id:"\u6210\u5458\u5c5e\u6027-7",level:4},{value:"\u53d8\u91cf",id:"\u53d8\u91cf",level:5},{value:"\u5185\u90e8\u7c7b",id:"\u5185\u90e8\u7c7b",level:5},{value:"\u4ee3\u7801\u5757",id:"\u4ee3\u7801\u5757",level:5},{value:"\u6784\u9020\u65b9\u6cd5",id:"\u6784\u9020\u65b9\u6cd5",level:4},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-6",level:4},{value:"\u6570\u636e\u8bbf\u5b58",id:"\u6570\u636e\u8bbf\u5b58",level:5},{value:"\u6dfb\u52a0\u65b9\u6cd5",id:"\u6dfb\u52a0\u65b9\u6cd5",level:5},{value:"\u6269\u5bb9\u65b9\u6cd5",id:"\u6269\u5bb9\u65b9\u6cd5",level:5},{value:"\u83b7\u53d6\u65b9\u6cd5",id:"\u83b7\u53d6\u65b9\u6cd5",level:5},{value:"\u5220\u9664\u65b9\u6cd5",id:"\u5220\u9664\u65b9\u6cd5",level:5},{value:"JDK7\u539f\u7406",id:"jdk7\u539f\u7406",level:4},{value:"CopyOnWrite",id:"copyonwrite",level:3},{value:"\u539f\u7406\u5206\u6790",id:"\u539f\u7406\u5206\u6790-1",level:4},{value:"\u5f31\u4e00\u81f4\u6027",id:"\u5f31\u4e00\u81f4\u6027",level:4},{value:"\u5b89\u5168\u5931\u8d25",id:"\u5b89\u5168\u5931\u8d25",level:4},{value:"Collections",id:"collections",level:3},{value:"SkipListMap",id:"skiplistmap",level:3},{value:"\u5e95\u5c42\u7ed3\u6784",id:"\u5e95\u5c42\u7ed3\u6784-1",level:4},{value:"\u6210\u5458\u53d8\u91cf",id:"\u6210\u5458\u53d8\u91cf-2",level:4},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-7",level:4},{value:"\u5176\u4ed6\u65b9\u6cd5",id:"\u5176\u4ed6\u65b9\u6cd5",level:5},{value:"\u6dfb\u52a0\u65b9\u6cd5",id:"\u6dfb\u52a0\u65b9\u6cd5-1",level:5},{value:"\u83b7\u53d6\u65b9\u6cd5",id:"\u83b7\u53d6\u65b9\u6cd5-1",level:5},{value:"\u5220\u9664\u65b9\u6cd5",id:"\u5220\u9664\u65b9\u6cd5-1",level:5},{value:"NoBlocking",id:"noblocking",level:3},{value:"\u975e\u963b\u585e\u961f\u5217",id:"\u975e\u963b\u585e\u961f\u5217",level:4},{value:"\u6784\u9020\u65b9\u6cd5",id:"\u6784\u9020\u65b9\u6cd5-1",level:4},{value:"\u5165\u961f\u65b9\u6cd5",id:"\u5165\u961f\u65b9\u6cd5",level:4},{value:"\u51fa\u961f\u65b9\u6cd5",id:"\u51fa\u961f\u65b9\u6cd5",level:4},{value:"\u6210\u5458\u65b9\u6cd5",id:"\u6210\u5458\u65b9\u6cd5-8",level:4},{value:"DES",id:"des",level:2},{value:"\u7f51\u7edc\u7f16\u7a0b",id:"\u7f51\u7edc\u7f16\u7a0b",level:3},{value:"\u901a\u4fe1\u534f\u8bae",id:"\u901a\u4fe1\u534f\u8bae",level:3},{value:"Java\u6a21\u578b",id:"java\u6a21\u578b",level:3},{value:"I/O",id:"io",level:2},{value:"IO\u6a21\u578b",id:"io\u6a21\u578b",level:3},{value:"\u4e94\u79cd\u6a21\u578b",id:"\u4e94\u79cd\u6a21\u578b",level:4},{value:"\u963b\u585e\u5f0fIO",id:"\u963b\u585e\u5f0fio",level:4},{value:"\u975e\u963b\u585e\u5f0f",id:"\u975e\u963b\u585e\u5f0f",level:4},{value:"\u4fe1\u53f7\u9a71\u52a8",id:"\u4fe1\u53f7\u9a71\u52a8",level:4},{value:"IO \u590d\u7528",id:"io-\u590d\u7528",level:4},{value:"\u5f02\u6b65 IO",id:"\u5f02\u6b65-io",level:4},{value:"\u591a\u8def\u590d\u7528",id:"\u591a\u8def\u590d\u7528",level:3},{value:"select",id:"select",level:4},{value:"\u51fd\u6570",id:"\u51fd\u6570",level:5},{value:"\u6d41\u7a0b",id:"\u6d41\u7a0b",level:5},{value:"poll",id:"poll",level:4},{value:"epoll",id:"epoll",level:4},{value:"\u51fd\u6570",id:"\u51fd\u6570-1",level:5},{value:"\u7279\u70b9",id:"\u7279\u70b9",level:5},{value:"\u5e94\u7528",id:"\u5e94\u7528",level:4},{value:"\u7cfb\u7edf\u8c03\u7528",id:"\u7cfb\u7edf\u8c03\u7528",level:3},{value:"\u5185\u6838\u6001",id:"\u5185\u6838\u6001",level:4},{value:"80\u4e2d\u65ad",id:"80\u4e2d\u65ad",level:4},{value:"\u96f6\u62f7\u8d1d",id:"\u96f6\u62f7\u8d1d",level:3},{value:"DMA",id:"dma",level:4},{value:"BIO",id:"bio",level:4},{value:"mmap",id:"mmap",level:4},{value:"sendfile",id:"sendfile",level:4},{value:"BIO",id:"bio-1",level:2},{value:"Inet",id:"inet",level:3},{value:"UDP",id:"udp",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-2",level:4},{value:"\u5b9e\u73b0UDP",id:"\u5b9e\u73b0udp",level:4},{value:"\u901a\u8baf\u65b9\u5f0f",id:"\u901a\u8baf\u65b9\u5f0f",level:4},{value:"TCP",id:"tcp",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-3",level:4},{value:"Socket",id:"socket",level:4},{value:"\u5b9e\u73b0TCP",id:"\u5b9e\u73b0tcp",level:4},{value:"\u5f00\u53d1\u6d41\u7a0b",id:"\u5f00\u53d1\u6d41\u7a0b",level:5},{value:"\u5b9e\u73b0\u901a\u4fe1",id:"\u5b9e\u73b0\u901a\u4fe1",level:5},{value:"\u4f2a\u5f02\u6b65",id:"\u4f2a\u5f02\u6b65",level:5},{value:"\u6587\u4ef6\u4f20\u8f93",id:"\u6587\u4ef6\u4f20\u8f93",level:4},{value:"\u5b57\u8282\u6d41",id:"\u5b57\u8282\u6d41",level:5},{value:"\u6570\u636e\u6d41",id:"\u6570\u636e\u6d41",level:5},{value:"NIO",id:"nio",level:2},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-4",level:3},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406-9",level:3},{value:"\u7f13\u51b2\u533a",id:"\u7f13\u51b2\u533a",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-5",level:4},{value:"\u57fa\u672c\u5c5e\u6027",id:"\u57fa\u672c\u5c5e\u6027",level:4},{value:"\u5e38\u7528API",id:"\u5e38\u7528api-1",level:4},{value:"\u8bfb\u5199\u6570\u636e",id:"\u8bfb\u5199\u6570\u636e",level:4},{value:"\u7c98\u5305\u62c6\u5305",id:"\u7c98\u5305\u62c6\u5305",level:4},{value:"\u76f4\u63a5\u5185\u5b58",id:"\u76f4\u63a5\u5185\u5b58",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-6",level:4},{value:"\u901a\u4fe1\u539f\u7406",id:"\u901a\u4fe1\u539f\u7406",level:4},{value:"\u5206\u914d\u56de\u6536",id:"\u5206\u914d\u56de\u6536",level:4},{value:"\u5171\u4eab\u5185\u5b58",id:"\u5171\u4eab\u5185\u5b58",level:4},{value:"\u901a\u9053",id:"\u901a\u9053",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-7",level:4},{value:"\u5e38\u7528API",id:"\u5e38\u7528api-2",level:4},{value:"\u6587\u4ef6\u8bfb\u5199",id:"\u6587\u4ef6\u8bfb\u5199",level:4},{value:"\u6587\u4ef6\u590d\u5236",id:"\u6587\u4ef6\u590d\u5236",level:4},{value:"\u5206\u6563\u805a\u96c6",id:"\u5206\u6563\u805a\u96c6",level:4},{value:"\u9009\u62e9\u5668",id:"\u9009\u62e9\u5668",level:3},{value:"\u57fa\u672c\u4ecb\u7ecd",id:"\u57fa\u672c\u4ecb\u7ecd-8",level:4},{value:"\u5e38\u7528API",id:"\u5e38\u7528api-3",level:4},{value:"NIO\u5b9e\u73b0",id:"nio\u5b9e\u73b0",level:3},{value:"\u5e38\u7528API",id:"\u5e38\u7528api-4",level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0",level:4},{value:"AIO",id:"aio",level:2}];function h(n){const e={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",h6:"h6",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pid:"pid",pre:"pre",runnable:"runnable",selectionkey:"selectionkey",strong:"strong",t:"t",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"juc",children:"JUC"})}),"\n",(0,r.jsx)(e.h2,{id:"\u8fdb\u7a0b",children:"\u8fdb\u7a0b"}),"\n",(0,r.jsx)(e.h3,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,r.jsxs)(e.p,{children:["\u8fdb\u7a0b\uff1a\u7a0b\u5e8f\u662f\u9759\u6b62\u7684\uff0c\u8fdb\u7a0b\u5b9e\u4f53\u7684\u8fd0\u884c\u8fc7\u7a0b\u5c31\u662f\u8fdb\u7a0b\uff0c\u662f\u7cfb\u7edf\u8fdb\u884c",(0,r.jsx)(e.strong,{children:"\u8d44\u6e90\u5206\u914d\u7684\u57fa\u672c\u5355\u4f4d"})]}),"\n",(0,r.jsx)(e.p,{children:"\u8fdb\u7a0b\u7684\u7279\u5f81\uff1a\u5e76\u53d1\u6027\u3001\u5f02\u6b65\u6027\u3001\u52a8\u6001\u6027\u3001\u72ec\u7acb\u6027\u3001\u7ed3\u6784\u6027"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b"}),"\uff1a\u7ebf\u7a0b\u662f\u5c5e\u4e8e\u8fdb\u7a0b\u7684\uff0c\u662f\u4e00\u4e2a\u57fa\u672c\u7684 CPU \u6267\u884c\u5355\u5143\uff0c\u662f\u7a0b\u5e8f\u6267\u884c\u6d41\u7684\u6700\u5c0f\u5355\u5143\u3002\u7ebf\u7a0b\u662f\u8fdb\u7a0b\u4e2d\u7684\u4e00\u4e2a\u5b9e\u4f53\uff0c\u662f\u7cfb\u7edf",(0,r.jsx)(e.strong,{children:"\u72ec\u7acb\u8c03\u5ea6\u7684\u57fa\u672c\u5355\u4f4d"}),"\uff0c\u7ebf\u7a0b\u672c\u8eab\u4e0d\u62e5\u6709\u7cfb\u7edf\u8d44\u6e90\uff0c\u53ea\u62e5\u6709\u4e00\u70b9\u5728\u8fd0\u884c\u4e2d\u5fc5\u4e0d\u53ef\u5c11\u7684\u8d44\u6e90\uff0c\u4e0e\u540c\u5c5e\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5176\u4ed6\u7ebf\u7a0b\u5171\u4eab\u8fdb\u7a0b\u6240\u62e5\u6709\u7684\u5168\u90e8\u8d44\u6e90"]}),"\n",(0,r.jsx)(e.p,{children:"\u5173\u7cfb\uff1a\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u7ebf\u7a0b\uff0c\u8fd9\u5c31\u662f\u591a\u7ebf\u7a0b\uff0c\u6bd4\u5982\u770b\u89c6\u9891\u662f\u8fdb\u7a0b\uff0c\u56fe\u753b\u3001\u58f0\u97f3\u3001\u5e7f\u544a\u7b49\u5c31\u662f\u591a\u4e2a\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u7684\u4f5c\u7528\uff1a\u4f7f\u591a\u9053\u7a0b\u5e8f\u66f4\u597d\u7684\u5e76\u53d1\u6267\u884c\uff0c\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\u548c\u7cfb\u7edf\u541e\u5410\u91cf\uff0c\u589e\u5f3a\u64cd\u4f5c\u7cfb\u7edf\u7684\u5e76\u53d1\u6027\u80fd"}),"\n",(0,r.jsx)(e.p,{children:"\u5e76\u53d1\u5e76\u884c\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5e76\u884c\uff1a\u5728\u540c\u4e00\u65f6\u523b\uff0c\u6709\u591a\u4e2a\u6307\u4ee4\u5728\u591a\u4e2a CPU \u4e0a\u540c\u65f6\u6267\u884c"}),"\n",(0,r.jsx)(e.li,{children:"\u5e76\u53d1\uff1a\u5728\u540c\u4e00\u65f6\u523b\uff0c\u6709\u591a\u4e2a\u6307\u4ee4\u5728\u5355\u4e2a CPU \u4e0a\u4ea4\u66ff\u6267\u884c"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u6b65\u5f02\u6b65\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9700\u8981\u7b49\u5f85\u7ed3\u679c\u8fd4\u56de\uff0c\u624d\u80fd\u7ee7\u7eed\u8fd0\u884c\u5c31\u662f\u540c\u6b65"}),"\n",(0,r.jsx)(e.li,{children:"\u4e0d\u9700\u8981\u7b49\u5f85\u7ed3\u679c\u8fd4\u56de\uff0c\u5c31\u80fd\u7ee7\u7eed\u8fd0\u884c\u5c31\u662f\u5f02\u6b65"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://www.bilibili.com/video/BV16J411h7Rd",children:"https://www.bilibili.com/video/BV16J411h7Rd"})]}),"\n",(0,r.jsx)(e.p,{children:"\u7b14\u8bb0\u7684\u6574\u4f53\u7ed3\u6784\u4f9d\u636e\u89c6\u9891\u7f16\u5199\uff0c\u5e76\u968f\u7740\u5b66\u4e60\u7684\u6df1\u5165\u8865\u5145\u4e86\u5f88\u591a\u77e5\u8bc6"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u5bf9\u6bd4",children:"\u5bf9\u6bd4"}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u8fdb\u7a0b\u5bf9\u6bd4\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fdb\u7a0b\u57fa\u672c\u4e0a\u76f8\u4e92\u72ec\u7acb\u7684\uff0c\u800c\u7ebf\u7a0b\u5b58\u5728\u4e8e\u8fdb\u7a0b\u5185\uff0c\u662f\u8fdb\u7a0b\u7684\u4e00\u4e2a\u5b50\u96c6"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u8fdb\u7a0b\u62e5\u6709\u5171\u4eab\u7684\u8d44\u6e90\uff0c\u5982\u5185\u5b58\u7a7a\u95f4\u7b49\uff0c\u4f9b\u5176",(0,r.jsx)(e.strong,{children:"\u5185\u90e8\u7684\u7ebf\u7a0b\u5171\u4eab"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fdb\u7a0b\u95f4\u901a\u4fe1\u8f83\u4e3a\u590d\u6742"}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u4e00\u53f0\u8ba1\u7b97\u673a\u7684\u8fdb\u7a0b\u901a\u4fe1\u79f0\u4e3a IPC\uff08Inter-process communication\uff09"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4fe1\u53f7\u91cf\uff1a\u4fe1\u53f7\u91cf\u662f\u4e00\u4e2a\u8ba1\u6570\u5668\uff0c\u7528\u4e8e\u591a\u8fdb\u7a0b\u5bf9\u5171\u4eab\u6570\u636e\u7684\u8bbf\u95ee\uff0c\u89e3\u51b3\u540c\u6b65\u76f8\u5173\u7684\u95ee\u9898\u5e76\u907f\u514d\u7ade\u4e89\u6761\u4ef6"}),"\n",(0,r.jsx)(e.li,{children:"\u5171\u4eab\u5b58\u50a8\uff1a\u591a\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u540c\u4e00\u5757\u5185\u5b58\u7a7a\u95f4\uff0c\u9700\u8981\u4f7f\u7528\u4fe1\u53f7\u91cf\u7528\u6765\u540c\u6b65\u5bf9\u5171\u4eab\u5b58\u50a8\u7684\u8bbf\u95ee"}),"\n",(0,r.jsxs)(e.li,{children:["\u7ba1\u9053\u901a\u4fe1\uff1a\u7ba1\u9053\u662f\u7528\u4e8e\u8fde\u63a5\u4e00\u4e2a\u8bfb\u8fdb\u7a0b\u548c\u4e00\u4e2a\u5199\u8fdb\u7a0b\u4ee5\u5b9e\u73b0\u5b83\u4eec\u4e4b\u95f4\u901a\u4fe1\u7684\u4e00\u4e2a\u5171\u4eab\u6587\u4ef6 pipe \u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u540c\u4e00\u65f6\u95f4\u53ea\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u8bbf\u95ee\uff0c\u6240\u4ee5\u53ea\u652f\u6301",(0,r.jsx)(e.strong,{children:"\u534a\u53cc\u5de5\u901a\u4fe1"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u533f\u540d\u7ba1\u9053\uff08Pipes\uff09\uff1a\u7528\u4e8e\u5177\u6709\u4eb2\u7f18\u5173\u7cfb\u7684\u7236\u5b50\u8fdb\u7a0b\u95f4\u6216\u8005\u5144\u5f1f\u8fdb\u7a0b\u4e4b\u95f4\u7684\u901a\u4fe1"}),"\n",(0,r.jsx)(e.li,{children:"\u547d\u540d\u7ba1\u9053\uff08Names Pipes\uff09\uff1a\u4ee5\u78c1\u76d8\u6587\u4ef6\u7684\u65b9\u5f0f\u5b58\u5728\uff0c\u53ef\u4ee5\u5b9e\u73b0\u672c\u673a\u4efb\u610f\u4e24\u4e2a\u8fdb\u7a0b\u901a\u4fe1\uff0c\u9075\u5faa FIFO"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u6d88\u606f\u961f\u5217\uff1a\u5185\u6838\u4e2d\u5b58\u50a8\u6d88\u606f\u7684\u94fe\u8868\uff0c\u7531\u6d88\u606f\u961f\u5217\u6807\u8bc6\u7b26\u6807\u8bc6\uff0c\u80fd\u5728\u4e0d\u540c\u8fdb\u7a0b\u4e4b\u95f4\u63d0\u4f9b",(0,r.jsx)(e.strong,{children:"\u5168\u53cc\u5de5\u901a\u4fe1"}),"\uff0c\u5bf9\u6bd4\u7ba1\u9053\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u533f\u540d\u7ba1\u9053\u5b58\u5728\u4e8e\u5185\u5b58\u4e2d\u7684\u6587\u4ef6\uff1b\u547d\u540d\u7ba1\u9053\u5b58\u5728\u4e8e\u5b9e\u9645\u7684\u78c1\u76d8\u4ecb\u8d28\u6216\u8005\u6587\u4ef6\u7cfb\u7edf\uff1b\u6d88\u606f\u961f\u5217\u5b58\u653e\u5728\u5185\u6838\u4e2d\uff0c\u53ea\u6709\u5728\u5185\u6838\u91cd\u542f\uff08\u64cd\u4f5c\u7cfb\u7edf\u91cd\u542f\uff09\u6216\u8005\u663e\u793a\u5730\u5220\u9664\u4e00\u4e2a\u6d88\u606f\u961f\u5217\u65f6\uff0c\u8be5\u6d88\u606f\u961f\u5217\u624d\u88ab\u771f\u6b63\u5220\u9664"}),"\n",(0,r.jsx)(e.li,{children:"\u8bfb\u8fdb\u7a0b\u53ef\u4ee5\u6839\u636e\u6d88\u606f\u7c7b\u578b\u6709\u9009\u62e9\u5730\u63a5\u6536\u6d88\u606f\uff0c\u800c\u4e0d\u50cf FIFO \u90a3\u6837\u53ea\u80fd\u9ed8\u8ba4\u5730\u63a5\u6536"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u4e0d\u540c\u8ba1\u7b97\u673a\u4e4b\u95f4\u7684",(0,r.jsx)(e.strong,{children:"\u8fdb\u7a0b\u901a\u4fe1"}),"\uff0c\u9700\u8981\u901a\u8fc7\u7f51\u7edc\uff0c\u5e76\u9075\u5b88\u5171\u540c\u7684\u534f\u8bae\uff0c\u4f8b\u5982 HTTP"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5957\u63a5\u5b57\uff1a\u4e0e\u5176\u5b83\u901a\u4fe1\u673a\u5236\u4e0d\u540c\u7684\u662f\uff0c\u53ef\u7528\u4e8e\u4e0d\u540c\u673a\u5668\u95f4\u7684\u4e92\u76f8\u901a\u4fe1"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u901a\u4fe1\u76f8\u5bf9\u7b80\u5355\uff0c\u56e0\u4e3a\u7ebf\u7a0b\u4e4b\u95f4\u5171\u4eab\u8fdb\u7a0b\u5185\u7684\u5185\u5b58\uff0c\u4e00\u4e2a\u4f8b\u5b50\u662f\u591a\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u540c\u4e00\u4e2a\u5171\u4eab\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Java \u4e2d\u7684\u901a\u4fe1\u673a\u5236"}),"\uff1avolatile\u3001\u7b49\u5f85/\u901a\u77e5\u673a\u5236\u3001join \u65b9\u5f0f\u3001InheritableThreadLocal\u3001MappedByteBuffer"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u66f4\u8f7b\u91cf\uff0c\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362\u6210\u672c\u4e00\u822c\u4e0a\u8981\u6bd4\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362\u4f4e"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u7ebf\u7a0b",children:"\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.h3,{id:"\u521b\u5efa\u7ebf\u7a0b",children:"\u521b\u5efa\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.h4,{id:"thread",children:"Thread"}),"\n",(0,r.jsx)(e.p,{children:"Thread \u521b\u5efa\u7ebf\u7a0b\u65b9\u5f0f\uff1a\u521b\u5efa\u7ebf\u7a0b\u7c7b\uff0c\u533f\u540d\u5185\u90e8\u7c7b\u65b9\u5f0f"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"start() \u65b9\u6cd5\u5e95\u5c42\u5176\u5b9e\u662f\u7ed9 CPU \u6ce8\u518c\u5f53\u524d\u7ebf\u7a0b\uff0c\u5e76\u4e14\u89e6\u53d1 run() \u65b9\u6cd5\u6267\u884c"})}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u7684\u542f\u52a8\u5fc5\u987b\u8c03\u7528 start() \u65b9\u6cd5\uff0c\u5982\u679c\u7ebf\u7a0b\u76f4\u63a5\u8c03\u7528 run() \u65b9\u6cd5\uff0c\u76f8\u5f53\u4e8e\u53d8\u6210\u4e86\u666e\u901a\u7c7b\u7684\u6267\u884c\uff0c\u6b64\u65f6\u4e3b\u7ebf\u7a0b\u5c06\u53ea\u6709\u6267\u884c\u8be5\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"\u5efa\u8bae\u7ebf\u7a0b\u5148\u521b\u5efa\u5b50\u7ebf\u7a0b\uff0c\u4e3b\u7ebf\u7a0b\u7684\u4efb\u52a1\u653e\u5728\u4e4b\u540e\uff0c\u5426\u5219\u4e3b\u7ebf\u7a0b\uff08main\uff09\u6c38\u8fdc\u662f\u5148\u6267\u884c\u5b8c"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Thread \u6784\u9020\u5668\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"public Thread()"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"public Thread(String name)"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ThreadDemo {\n    public static void main(String[] args) {\n        Thread t = new MyThread();\n        t.start();\n       \tfor(int i = 0 ; i < 100 ; i++ ){\n            System.out.println("main\u7ebf\u7a0b" + i)\n        }\n        // main\u7ebf\u7a0b\u8f93\u51fa\u653e\u5728\u4e0a\u9762 \u5c31\u53d8\u6210\u6709\u5148\u540e\u987a\u5e8f\u4e86\uff0c\u56e0\u4e3a\u662f main \u7ebf\u7a0b\u9a71\u52a8\u7684\u5b50\u7ebf\u7a0b\u8fd0\u884c\n    }\n}\nclass MyThread extends Thread {\n    @Override\n    public void run() {\n        for(int i = 0 ; i < 100 ; i++ ) {\n            System.out.println("\u5b50\u7ebf\u7a0b\u8f93\u51fa\uff1a"+i)\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u7ee7\u627f Thread \u7c7b\u7684\u4f18\u7f3a\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f18\u70b9\uff1a\u7f16\u7801\u7b80\u5355"}),"\n",(0,r.jsx)(e.li,{children:"\u7f3a\u70b9\uff1a\u7ebf\u7a0b\u7c7b\u5df2\u7ecf\u7ee7\u627f\u4e86 Thread \u7c7b\u65e0\u6cd5\u7ee7\u627f\u5176\u4ed6\u7c7b\u4e86\uff0c\u529f\u80fd\u4e0d\u80fd\u901a\u8fc7\u7ee7\u627f\u62d3\u5c55\uff08\u5355\u7ee7\u627f\u7684\u5c40\u9650\u6027\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"runnable",children:"Runnable"}),"\n",(0,r.jsx)(e.p,{children:"Runnable \u521b\u5efa\u7ebf\u7a0b\u65b9\u5f0f\uff1a\u521b\u5efa\u7ebf\u7a0b\u7c7b\uff0c\u533f\u540d\u5185\u90e8\u7c7b\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"Thread \u7684\u6784\u9020\u5668\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"public Thread(Runnable target)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"public Thread(Runnable target, String name)"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ThreadDemo {\n    public static void main(String[] args) {\n        Runnable target = new MyRunnable();\n        Thread t1 = new Thread(target,"1\u53f7\u7ebf\u7a0b");\n\t\tt1.start();\n        Thread t2 = new Thread(target);//Thread-0\n    }\n}\n\npublic class MyRunnable implements Runnable{\n    @Override\n    public void run() {\n        for(int i = 0 ; i < 10 ; i++ ){\n            System.out.println(Thread.currentThread().getName() + "->" + i);\n        }\n    }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Thread \u7c7b\u672c\u8eab\u4e5f\u662f\u5b9e\u73b0\u4e86 Runnable \u63a5\u53e3"}),"\uff0cThread \u7c7b\u4e2d\u6301\u6709 Runnable \u7684\u5c5e\u6027\uff0c\u6267\u884c\u7ebf\u7a0b run \u65b9\u6cd5\u5e95\u5c42\u662f\u8c03\u7528 Runnable#run\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class Thread implements Runnable {\n    private Runnable target;\n    \n    public void run() {\n        if (target != null) {\n          \t// \u5e95\u5c42\u8c03\u7528\u7684\u662f Runnable \u7684 run \u65b9\u6cd5\n            target.run();\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"Runnable \u65b9\u5f0f\u7684\u4f18\u7f3a\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7f3a\u70b9\uff1a\u4ee3\u7801\u590d\u6742\u4e00\u70b9\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4f18\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u4efb\u52a1\u7c7b\u53ea\u662f\u5b9e\u73b0\u4e86 Runnable \u63a5\u53e3\uff0c\u53ef\u4ee5\u7ee7\u7eed\u7ee7\u627f\u5176\u4ed6\u7c7b\uff0c\u907f\u514d\u4e86\u5355\u7ee7\u627f\u7684\u5c40\u9650\u6027"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u540c\u4e00\u4e2a\u7ebf\u7a0b\u4efb\u52a1\u5bf9\u8c61\u53ef\u4ee5\u88ab\u5305\u88c5\u6210\u591a\u4e2a\u7ebf\u7a0b\u5bf9\u8c61"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u9002\u5408\u591a\u4e2a\u591a\u4e2a\u7ebf\u7a0b\u53bb\u5171\u4eab\u540c\u4e00\u4e2a\u8d44\u6e90"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5b9e\u73b0\u89e3\u8026\u64cd\u4f5c\uff0c\u7ebf\u7a0b\u4efb\u52a1\u4ee3\u7801\u53ef\u4ee5\u88ab\u591a\u4e2a\u7ebf\u7a0b\u5171\u4eab\uff0c\u7ebf\u7a0b\u4efb\u52a1\u4ee3\u7801\u548c\u7ebf\u7a0b\u72ec\u7acb"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u6c60\u53ef\u4ee5\u653e\u5165\u5b9e\u73b0 Runnable \u6216 Callable \u7ebf\u7a0b\u4efb\u52a1\u5bf9\u8c61"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u200b"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"callable",children:"Callable"}),"\n",(0,r.jsx)(e.p,{children:"\u5b9e\u73b0 Callable \u63a5\u53e3\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u5b9a\u4e49\u4e00\u4e2a\u7ebf\u7a0b\u4efb\u52a1\u7c7b\u5b9e\u73b0 Callable \u63a5\u53e3\uff0c\u7533\u660e\u7ebf\u7a0b\u6267\u884c\u7684\u7ed3\u679c\u7c7b\u578b"}),"\n",(0,r.jsx)(e.li,{children:"\u91cd\u5199\u7ebf\u7a0b\u4efb\u52a1\u7c7b\u7684 call \u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u6267\u884c\u7684\u7ed3\u679c"}),"\n",(0,r.jsx)(e.li,{children:"\u521b\u5efa\u4e00\u4e2a Callable \u7684\u7ebf\u7a0b\u4efb\u52a1\u5bf9\u8c61"}),"\n",(0,r.jsxs)(e.li,{children:["\u628a Callable \u7684\u7ebf\u7a0b\u4efb\u52a1\u5bf9\u8c61",(0,r.jsx)(e.strong,{children:"\u5305\u88c5\u6210\u4e00\u4e2a\u672a\u6765\u4efb\u52a1\u5bf9\u8c61"})]}),"\n",(0,r.jsx)(e.li,{children:"\u628a\u672a\u6765\u4efb\u52a1\u5bf9\u8c61\u5305\u88c5\u6210\u7ebf\u7a0b\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528\u7ebf\u7a0b\u7684 start() \u65b9\u6cd5\u542f\u52a8\u7ebf\u7a0b"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public FutureTask(Callable<V> callable)"}),"\uff1a\u672a\u6765\u4efb\u52a1\u5bf9\u8c61\uff0c\u5728\u7ebf\u7a0b\u6267\u884c\u5b8c\u540e\u5f97\u5230\u7ebf\u7a0b\u7684\u6267\u884c\u7ed3\u679c"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["FutureTask \u5c31\u662f Runnable \u5bf9\u8c61\uff0c\u56e0\u4e3a ",(0,r.jsx)(e.strong,{children:"Thread \u7c7b\u53ea\u80fd\u6267\u884c Runnable \u5b9e\u4f8b\u7684\u4efb\u52a1\u5bf9\u8c61"}),"\uff0c\u6240\u4ee5\u628a Callable \u5305\u88c5\u6210\u672a\u6765\u4efb\u52a1\u5bf9\u8c61"]}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u6c60\u90e8\u5206\u8be6\u89e3\u4e86 FutureTask \u7684\u6e90\u7801"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public V get()"}),"\uff1a\u540c\u6b65\u7b49\u5f85 task \u6267\u884c\u5b8c\u6bd5\u7684\u7ed3\u679c\uff0c\u5982\u679c\u5728\u7ebf\u7a0b\u4e2d\u83b7\u53d6\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u7ed3\u679c\uff0c\u4f1a\u963b\u585e\u7b49\u5f85\uff0c\u7528\u4e8e\u7ebf\u7a0b\u540c\u6b65"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"get() \u7ebf\u7a0b\u4f1a\u963b\u585e\u7b49\u5f85\u4efb\u52a1\u6267\u884c\u5b8c\u6210"}),"\n",(0,r.jsx)(e.li,{children:"run() \u6267\u884c\u5b8c\u540e\u4f1a\u628a\u7ed3\u679c\u8bbe\u7f6e\u5230 FutureTask  \u7684\u4e00\u4e2a\u6210\u5458\u53d8\u91cf\uff0cget() \u7ebf\u7a0b\u53ef\u4ee5\u83b7\u53d6\u5230\u8be5\u53d8\u91cf\u7684\u503c"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4f18\u7f3a\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f18\u70b9\uff1a\u540c Runnable\uff0c\u5e76\u4e14\u80fd\u5f97\u5230\u7ebf\u7a0b\u6267\u884c\u7684\u7ed3\u679c"}),"\n",(0,r.jsx)(e.li,{children:"\u7f3a\u70b9\uff1a\u7f16\u7801\u590d\u6742"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ThreadDemo {\n    public static void main(String[] args) {\n        Callable call = new MyCallable();\n        FutureTask<String> task = new FutureTask<>(call);\n        Thread t = new Thread(task);\n        t.start();\n        try {\n            String s = task.get(); // \u83b7\u53d6call\u65b9\u6cd5\u8fd4\u56de\u7684\u7ed3\u679c\uff08\u6b63\u5e38/\u5f02\u5e38\u7ed3\u679c\uff09\n            System.out.println(s);\n        }  catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\npublic class MyCallable implements Callable<String> {\n    @Override//\u91cd\u5199\u7ebf\u7a0b\u4efb\u52a1\u7c7b\u65b9\u6cd5\n    public String call() throws Exception {\n        return Thread.currentThread().getName() + "->" + "Hello World";\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u7ebf\u7a0b\u65b9\u6cd5",children:"\u7ebf\u7a0b\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.h4,{id:"api",children:"API"}),"\n",(0,r.jsx)(e.p,{children:"Thread \u7c7b API\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public void start()"}),(0,r.jsx)(e.td,{children:"\u542f\u52a8\u4e00\u4e2a\u65b0\u7ebf\u7a0b\uff0cJava\u865a\u62df\u673a\u8c03\u7528\u6b64\u7ebf\u7a0b\u7684 run \u65b9\u6cd5"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public void run()"}),(0,r.jsx)(e.td,{children:"\u7ebf\u7a0b\u542f\u52a8\u540e\u8c03\u7528\u8be5\u65b9\u6cd5"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public void setName(String name)"}),(0,r.jsx)(e.td,{children:"\u7ed9\u5f53\u524d\u7ebf\u7a0b\u53d6\u540d\u5b57"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public void getName()"}),(0,r.jsxs)(e.td,{children:["\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u7684\u540d\u5b57",(0,r.jsx)(e.br,{}),"\u7ebf\u7a0b\u5b58\u5728\u9ed8\u8ba4\u540d\u79f0\uff1a\u5b50\u7ebf\u7a0b\u662f Thread-\u7d22\u5f15\uff0c\u4e3b\u7ebf\u7a0b\u662f main"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public static Thread currentThread()"}),(0,r.jsx)(e.td,{children:"\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u5bf9\u8c61\uff0c\u4ee3\u7801\u5728\u54ea\u4e2a\u7ebf\u7a0b\u4e2d\u6267\u884c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public static void sleep(long time)"}),(0,r.jsxs)(e.td,{children:["\u8ba9\u5f53\u524d\u7ebf\u7a0b\u4f11\u7720\u591a\u5c11\u6beb\u79d2\u518d\u7ee7\u7eed\u6267\u884c",(0,r.jsx)(e.br,{}),(0,r.jsx)(e.strong,{children:"Thread.sleep(0)"})," : \u8ba9\u64cd\u4f5c\u7cfb\u7edf\u7acb\u523b\u91cd\u65b0\u8fdb\u884c\u4e00\u6b21 CPU \u7ade\u4e89"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public static native void yield()"}),(0,r.jsx)(e.td,{children:"\u63d0\u793a\u7ebf\u7a0b\u8c03\u5ea6\u5668\u8ba9\u51fa\u5f53\u524d\u7ebf\u7a0b\u5bf9 CPU \u7684\u4f7f\u7528"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int getPriority()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u6b64\u7ebf\u7a0b\u7684\u4f18\u5148\u7ea7"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final void setPriority(int priority)"}),(0,r.jsx)(e.td,{children:"\u66f4\u6539\u6b64\u7ebf\u7a0b\u7684\u4f18\u5148\u7ea7\uff0c\u5e38\u7528 1 5 10"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public void interrupt()"}),(0,r.jsx)(e.td,{children:"\u4e2d\u65ad\u8fd9\u4e2a\u7ebf\u7a0b\uff0c\u5f02\u5e38\u5904\u7406\u673a\u5236"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public static boolean interrupted()"}),(0,r.jsx)(e.td,{children:"\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u6e05\u9664\u6253\u65ad\u6807\u8bb0"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public boolean isInterrupted()"}),(0,r.jsx)(e.td,{children:"\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u4e0d\u6e05\u9664\u6253\u65ad\u6807\u8bb0"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final void join()"}),(0,r.jsx)(e.td,{children:"\u7b49\u5f85\u8fd9\u4e2a\u7ebf\u7a0b\u7ed3\u675f"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final void join(long millis)"}),(0,r.jsx)(e.td,{children:"\u7b49\u5f85\u8fd9\u4e2a\u7ebf\u7a0b\u6b7b\u4ea1 millis \u6beb\u79d2\uff0c0 \u610f\u5473\u7740\u6c38\u8fdc\u7b49\u5f85"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final native boolean isAlive()"}),(0,r.jsx)(e.td,{children:"\u7ebf\u7a0b\u662f\u5426\u5b58\u6d3b\uff08\u8fd8\u6ca1\u6709\u8fd0\u884c\u5b8c\u6bd5\uff09"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final void setDaemon(boolean on)"}),(0,r.jsx)(e.td,{children:"\u5c06\u6b64\u7ebf\u7a0b\u6807\u8bb0\u4e3a\u5b88\u62a4\u7ebf\u7a0b\u6216\u7528\u6237\u7ebf\u7a0b"})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"run-start",children:"run start"}),"\n",(0,r.jsx)(e.p,{children:"run\uff1a\u79f0\u4e3a\u7ebf\u7a0b\u4f53\uff0c\u5305\u542b\u4e86\u8981\u6267\u884c\u7684\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u5185\u5bb9\uff0c\u65b9\u6cd5\u8fd0\u884c\u7ed3\u675f\uff0c\u6b64\u7ebf\u7a0b\u968f\u5373\u7ec8\u6b62\u3002\u76f4\u63a5\u8c03\u7528 run \u662f\u5728\u4e3b\u7ebf\u7a0b\u4e2d\u6267\u884c\u4e86 run\uff0c\u6ca1\u6709\u542f\u52a8\u65b0\u7684\u7ebf\u7a0b\uff0c\u9700\u8981\u987a\u5e8f\u6267\u884c"}),"\n",(0,r.jsx)(e.p,{children:"start\uff1a\u4f7f\u7528 start \u662f\u542f\u52a8\u65b0\u7684\u7ebf\u7a0b\uff0c\u6b64\u7ebf\u7a0b\u5904\u4e8e\u5c31\u7eea\uff08\u53ef\u8fd0\u884c\uff09\u72b6\u6001\uff0c\u901a\u8fc7\u65b0\u7684\u7ebf\u7a0b\u95f4\u63a5\u6267\u884c run \u4e2d\u7684\u4ee3\u7801"}),"\n",(0,r.jsxs)(e.p,{children:["\u8bf4\u660e\uff1a",(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u63a7\u5236\u8d44\u6e90\u7c7b"})]}),"\n",(0,r.jsx)(e.p,{children:"run() \u65b9\u6cd5\u4e2d\u7684\u5f02\u5e38\u4e0d\u80fd\u629b\u51fa\uff0c\u53ea\u80fd try/catch"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u56e0\u4e3a\u7236\u7c7b\u4e2d\u6ca1\u6709\u629b\u51fa\u4efb\u4f55\u5f02\u5e38\uff0c\u5b50\u7c7b\u4e0d\u80fd\u6bd4\u7236\u7c7b\u629b\u51fa\u66f4\u591a\u7684\u5f02\u5e38"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u5f02\u5e38\u4e0d\u80fd\u8de8\u7ebf\u7a0b\u4f20\u64ad\u56de main() \u4e2d"}),"\uff0c\u56e0\u6b64\u5fc5\u987b\u5728\u672c\u5730\u8fdb\u884c\u5904\u7406"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"sleep-yield",children:"sleep yield"}),"\n",(0,r.jsx)(e.p,{children:"sleep\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u8c03\u7528 sleep \u4f1a\u8ba9\u5f53\u524d\u7ebf\u7a0b\u4ece ",(0,r.jsx)(e.code,{children:"Running"})," \u8fdb\u5165 ",(0,r.jsx)(e.code,{children:"Timed Waiting"})," \u72b6\u6001\uff08\u963b\u585e\uff09"]}),"\n",(0,r.jsxs)(e.li,{children:["sleep() \u65b9\u6cd5\u7684\u8fc7\u7a0b\u4e2d\uff0c",(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u4e0d\u4f1a\u91ca\u653e\u5bf9\u8c61\u9501"})]}),"\n",(0,r.jsx)(e.li,{children:"\u5176\u5b83\u7ebf\u7a0b\u53ef\u4ee5\u4f7f\u7528 interrupt \u65b9\u6cd5\u6253\u65ad\u6b63\u5728\u7761\u7720\u7684\u7ebf\u7a0b\uff0c\u8fd9\u65f6 sleep \u65b9\u6cd5\u4f1a\u629b\u51fa InterruptedException"}),"\n",(0,r.jsx)(e.li,{children:"\u7761\u7720\u7ed3\u675f\u540e\u7684\u7ebf\u7a0b\u672a\u5fc5\u4f1a\u7acb\u523b\u5f97\u5230\u6267\u884c\uff0c\u9700\u8981\u62a2\u5360 CPU"}),"\n",(0,r.jsx)(e.li,{children:"\u5efa\u8bae\u7528 TimeUnit \u7684 sleep \u4ee3\u66ff Thread \u7684 sleep \u6765\u83b7\u5f97\u66f4\u597d\u7684\u53ef\u8bfb\u6027"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"yield\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528 yield \u4f1a\u8ba9\u63d0\u793a\u7ebf\u7a0b\u8c03\u5ea6\u5668\u8ba9\u51fa\u5f53\u524d\u7ebf\u7a0b\u5bf9 CPU \u7684\u4f7f\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u5177\u4f53\u7684\u5b9e\u73b0\u4f9d\u8d56\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u7684\u4efb\u52a1\u8c03\u5ea6\u5668"}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"\u4f1a\u653e\u5f03 CPU \u8d44\u6e90\uff0c\u9501\u8d44\u6e90\u4e0d\u4f1a\u91ca\u653e"})}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"join",children:"join"}),"\n",(0,r.jsx)(e.p,{children:"public final void join()\uff1a\u7b49\u5f85\u8fd9\u4e2a\u7ebf\u7a0b\u7ed3\u675f"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u7406\uff1a\u8c03\u7528\u8005\u8f6e\u8be2\u68c0\u67e5\u7ebf\u7a0b alive \u72b6\u6001\uff0ct1.join() \u7b49\u4ef7\u4e8e\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final synchronized void join(long millis) throws InterruptedException {\n    // \u8c03\u7528\u8005\u7ebf\u7a0b\u8fdb\u5165 thread \u7684 waitSet \u7b49\u5f85, \u76f4\u5230\u5f53\u524d\u7ebf\u7a0b\u8fd0\u884c\u7ed3\u675f\n    while (isAlive()) {\n        wait(0);\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["join \u65b9\u6cd5\u662f\u88ab synchronized \u4fee\u9970\u7684\uff0c\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u5bf9\u8c61\u9501\uff0c\u5176\u5185\u90e8\u7684 wait \u65b9\u6cd5\u8c03\u7528\u4e5f\u662f\u91ca\u653e\u9501\u7684\uff0c\u4f46\u662f",(0,r.jsx)(e.strong,{children:"\u91ca\u653e\u7684\u662f\u5f53\u524d\u7684\u7ebf\u7a0b\u5bf9\u8c61\u9501\uff0c\u800c\u4e0d\u662f\u5916\u9762\u7684\u9501"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u8c03\u7528\u67d0\u4e2a\u7ebf\u7a0b\uff08t1\uff09\u7684 join \u65b9\u6cd5\u540e\uff0c\u8be5\u7ebf\u7a0b\uff08t1\uff09\u62a2\u5360\u5230 CPU \u8d44\u6e90\uff0c\u5c31\u4e0d\u518d\u91ca\u653e\uff0c\u76f4\u5230\u7ebf\u7a0b\u6267\u884c\u5b8c\u6bd5"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u540c\u6b65\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["join \u5b9e\u73b0\u7ebf\u7a0b\u540c\u6b65\uff0c\u56e0\u4e3a\u4f1a\u963b\u585e\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u7684\u7ed3\u675f\uff0c\u624d\u80fd\u7ee7\u7eed\u5411\u4e0b\u8fd0\u884c\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9700\u8981\u5916\u90e8\u5171\u4eab\u53d8\u91cf\uff0c\u4e0d\u7b26\u5408\u9762\u5411\u5bf9\u8c61\u5c01\u88c5\u7684\u601d\u60f3"}),"\n",(0,r.jsx)(e.li,{children:"\u5fc5\u987b\u7b49\u5f85\u7ebf\u7a0b\u7ed3\u675f\uff0c\u4e0d\u80fd\u914d\u5408\u7ebf\u7a0b\u6c60\u4f7f\u7528"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Future \u5b9e\u73b0\uff08\u540c\u6b65\uff09\uff1aget() \u65b9\u6cd5\u963b\u585e\u7b49\u5f85\u6267\u884c\u7ed3\u679c\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"main \u7ebf\u7a0b\u63a5\u6536\u7ed3\u679c"}),"\n",(0,r.jsx)(e.li,{children:"get \u65b9\u6cd5\u662f\u8ba9\u8c03\u7528\u7ebf\u7a0b\u540c\u6b65\u7b49\u5f85"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class Test {\n    static int r = 0;\n    public static void main(String[] args) throws InterruptedException {\n        test1();\n    }\n    private static void test1() throws InterruptedException {\n        Thread t1 = new Thread(() -> {\n            try {\n                Thread.sleep(1000);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            r = 10;\n        });\n        t1.start();\n        t1.join();//\u4e0d\u7b49\u5f85\u7ebf\u7a0b\u6267\u884c\u7ed3\u675f\uff0c\u8f93\u51fa\u768410\n        System.out.println(r);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"interrupt",children:"interrupt"}),"\n",(0,r.jsx)(e.h5,{id:"\u6253\u65ad\u7ebf\u7a0b",children:"\u6253\u65ad\u7ebf\u7a0b"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public void interrupt()"}),"\uff1a\u6253\u65ad\u8fd9\u4e2a\u7ebf\u7a0b\uff0c\u5f02\u5e38\u5904\u7406\u673a\u5236"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public static boolean interrupted()"}),"\uff1a\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u6253\u65ad\u8fd4\u56de true\uff0c",(0,r.jsx)(e.strong,{children:"\u6e05\u9664\u6253\u65ad\u6807\u8bb0"}),"\uff0c\u8fde\u7eed\u8c03\u7528\u4e24\u6b21\u4e00\u5b9a\u8fd4\u56de false"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public boolean isInterrupted()"}),"\uff1a\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u4e0d\u6e05\u9664\u6253\u65ad\u6807\u8bb0"]}),"\n",(0,r.jsx)(e.p,{children:"\u6253\u65ad\u7684\u7ebf\u7a0b\u4f1a\u53d1\u751f\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u4fdd\u5b58\u7ebf\u7a0b\u4fe1\u606f\uff0c\u62a2\u5360\u5230 CPU \u540e\u4f1a\u4ece\u4e2d\u65ad\u7684\u5730\u65b9\u63a5\u7740\u8fd0\u884c\uff08\u6253\u65ad\u4e0d\u662f\u505c\u6b62\uff09"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["sleep\u3001wait\u3001join \u65b9\u6cd5\u90fd\u4f1a\u8ba9\u7ebf\u7a0b\u8fdb\u5165\u963b\u585e\u72b6\u6001\uff0c\u6253\u65ad\u7ebf\u7a0b",(0,r.jsx)(e.strong,{children:"\u4f1a\u6e05\u7a7a\u6253\u65ad\u72b6\u6001"}),"\uff08false\uff09"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws InterruptedException {\n    Thread t1 = new Thread(()->{\n        try {\n            Thread.sleep(1000);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }, "t1");\n    t1.start();\n    Thread.sleep(500);\n    t1.interrupt();\n    System.out.println(" \u6253\u65ad\u72b6\u6001: {}" + t1.isInterrupted());// \u6253\u65ad\u72b6\u6001: {}false\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6253\u65ad\u6b63\u5e38\u8fd0\u884c\u7684\u7ebf\u7a0b\uff1a\u4e0d\u4f1a\u6e05\u7a7a\u6253\u65ad\u72b6\u6001\uff08true\uff09"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws Exception {\n    Thread t2 = new Thread(()->{\n        while(true) {\n            Thread current = Thread.currentThread();\n            boolean interrupted = current.isInterrupted();\n            if(interrupted) {\n                System.out.println(" \u6253\u65ad\u72b6\u6001: {}" + interrupted);//\u6253\u65ad\u72b6\u6001: {}true\n                break;\n            }\n        }\n    }, "t2");\n    t2.start();\n    Thread.sleep(500);\n    t2.interrupt();\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6253\u65ad-park",children:"\u6253\u65ad park"}),"\n",(0,r.jsx)(e.p,{children:"park \u4f5c\u7528\u7c7b\u4f3c sleep\uff0c\u6253\u65ad park \u7ebf\u7a0b\uff0c\u4e0d\u4f1a\u6e05\u7a7a\u6253\u65ad\u72b6\u6001\uff08true\uff09"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws Exception {\n    Thread t1 = new Thread(() -> {\n        System.out.println("park...");\n        LockSupport.park();\n        System.out.println("unpark...");\n        System.out.println("\u6253\u65ad\u72b6\u6001\uff1a" + Thread.currentThread().isInterrupted());//\u6253\u65ad\u72b6\u6001\uff1atrue\n    }, "t1");\n    t1.start();\n    Thread.sleep(2000);\n    t1.interrupt();\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u6253\u65ad\u6807\u8bb0\u5df2\u7ecf\u662f true, \u5219 park \u4f1a\u5931\u6548"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'LockSupport.park();\nSystem.out.println("unpark...");\nLockSupport.park();//\u5931\u6548\uff0c\u4e0d\u4f1a\u963b\u585e\nSystem.out.println("unpark...");//\u548c\u4e0a\u4e00\u4e2aunpark\u540c\u65f6\u6267\u884c\n'})}),"\n",(0,r.jsxs)(e.p,{children:["\u53ef\u4ee5\u4fee\u6539\u83b7\u53d6\u6253\u65ad\u72b6\u6001\u65b9\u6cd5\uff0c\u4f7f\u7528 ",(0,r.jsx)(e.code,{children:"Thread.interrupted()"}),"\uff0c\u6e05\u9664\u6253\u65ad\u6807\u8bb0"]}),"\n",(0,r.jsx)(e.p,{children:"LockSupport \u7c7b\u5728 \u540c\u6b65 \u2192 park-un \u8be6\u89e3"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u7ec8\u6b62\u6a21\u5f0f",children:"\u7ec8\u6b62\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"\u7ec8\u6b62\u6a21\u5f0f\u4e4b\u4e24\u9636\u6bb5\u7ec8\u6b62\u6a21\u5f0f\uff1aTwo Phase Termination"}),"\n",(0,r.jsx)(e.p,{children:"\u76ee\u6807\uff1a\u5728\u4e00\u4e2a\u7ebf\u7a0b T1 \u4e2d\u5982\u4f55\u4f18\u96c5\u7ec8\u6b62\u7ebf\u7a0b T2\uff1f\u4f18\u96c5\u6307\u7684\u662f\u7ed9 T2 \u4e00\u4e2a\u540e\u7f6e\u5904\u7406\u5668"}),"\n",(0,r.jsx)(e.p,{children:"\u9519\u8bef\u601d\u60f3\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u7ebf\u7a0b\u5bf9\u8c61\u7684 stop() \u65b9\u6cd5\u505c\u6b62\u7ebf\u7a0b\uff1astop \u65b9\u6cd5\u4f1a\u771f\u6b63\u6740\u6b7b\u7ebf\u7a0b\uff0c\u5982\u679c\u8fd9\u65f6\u7ebf\u7a0b\u9501\u4f4f\u4e86\u5171\u4eab\u8d44\u6e90\uff0c\u5f53\u5b83\u88ab\u6740\u6b7b\u540e\u5c31\u518d\u4e5f\u6ca1\u6709\u673a\u4f1a\u91ca\u653e\u9501\uff0c\u5176\u5b83\u7ebf\u7a0b\u5c06\u6c38\u8fdc\u65e0\u6cd5\u83b7\u53d6\u9501"}),"\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528 System.exit(int) \u65b9\u6cd5\u505c\u6b62\u7ebf\u7a0b\uff1a\u76ee\u7684\u4ec5\u662f\u505c\u6b62\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4f46\u8fd9\u79cd\u505a\u6cd5\u4f1a\u8ba9\u6574\u4e2a\u7a0b\u5e8f\u90fd\u505c\u6b62"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e24\u9636\u6bb5\u7ec8\u6b62\u6a21\u5f0f\u56fe\u793a\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(16086).A+"",width:"826",height:"600"})}),"\n",(0,r.jsx)(e.p,{children:"\u6253\u65ad\u7ebf\u7a0b\u53ef\u80fd\u5728\u4efb\u4f55\u65f6\u95f4\uff0c\u6240\u4ee5\u9700\u8981\u8003\u8651\u5728\u4efb\u4f55\u65f6\u523b\u88ab\u6253\u65ad\u7684\u5904\u7406\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class Test {\n    public static void main(String[] args) throws InterruptedException {\n        TwoPhaseTermination tpt = new TwoPhaseTermination();\n        tpt.start();\n        Thread.sleep(3500);\n        tpt.stop();\n    }\n}\nclass TwoPhaseTermination {\n    private Thread monitor;\n    // \u542f\u52a8\u76d1\u63a7\u7ebf\u7a0b\n    public void start() {\n        monitor = new Thread(new Runnable() {\n            @Override\n            public void run() {\n                while (true) {\n                    Thread thread = Thread.currentThread();\n                    if (thread.isInterrupted()) {\n                        System.out.println("\u540e\u7f6e\u5904\u7406");\n                        break;\n                    }\n                    try {\n                        Thread.sleep(1000);\t\t\t\t\t// \u7761\u7720\n                        System.out.println("\u6267\u884c\u76d1\u63a7\u8bb0\u5f55");\t// \u5728\u6b64\u88ab\u6253\u65ad\u4e0d\u4f1a\u5f02\u5e38\n                    } catch (InterruptedException e) {\t\t// \u5728\u7761\u7720\u671f\u95f4\u88ab\u6253\u65ad\uff0c\u8fdb\u5165\u5f02\u5e38\u5904\u7406\u7684\u903b\u8f91\n                        e.printStackTrace();\n                        // \u91cd\u65b0\u8bbe\u7f6e\u6253\u65ad\u6807\u8bb0\uff0c\u6253\u65ad sleep \u4f1a\u6e05\u9664\u6253\u65ad\u72b6\u6001\n                        thread.interrupt();\n                    }\n                }\n            }\n        });\n        monitor.start();\n    }\n    // \u505c\u6b62\u76d1\u63a7\u7ebf\u7a0b\n    public void stop() {\n        monitor.interrupt();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"daemon",children:"daemon"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public final void setDaemon(boolean on)"}),"\uff1a\u5982\u679c\u662f true \uff0c\u5c06\u6b64\u7ebf\u7a0b\u6807\u8bb0\u4e3a\u5b88\u62a4\u7ebf\u7a0b"]}),"\n",(0,r.jsxs)(e.p,{children:["\u7ebf\u7a0b",(0,r.jsx)(e.strong,{children:"\u542f\u52a8\u524d"}),"\u8c03\u7528\u6b64\u65b9\u6cd5\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'Thread t = new Thread() {\n    @Override\n    public void run() {\n        System.out.println("running");\n    }\n};\n// \u8bbe\u7f6e\u8be5\u7ebf\u7a0b\u4e3a\u5b88\u62a4\u7ebf\u7a0b\nt.setDaemon(true);\nt.start();\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u6237\u7ebf\u7a0b\uff1a\u5e73\u5e38\u521b\u5efa\u7684\u666e\u901a\u7ebf\u7a0b"}),"\n",(0,r.jsxs)(e.p,{children:["\u5b88\u62a4\u7ebf\u7a0b\uff1a\u670d\u52a1\u4e8e\u7528\u6237\u7ebf\u7a0b\uff0c\u53ea\u8981\u5176\u5b83\u975e\u5b88\u62a4\u7ebf\u7a0b\u8fd0\u884c\u7ed3\u675f\u4e86\uff0c\u5373\u4f7f\u5b88\u62a4\u7ebf\u7a0b\u4ee3\u7801\u6ca1\u6709\u6267\u884c\u5b8c\uff0c\u4e5f\u4f1a\u5f3a\u5236\u7ed3\u675f\u3002\u5b88\u62a4\u8fdb\u7a0b\u662f",(0,r.jsx)(e.strong,{children:"\u8131\u79bb\u4e8e\u7ec8\u7aef\u5e76\u4e14\u5728\u540e\u53f0\u8fd0\u884c\u7684\u8fdb\u7a0b"}),"\uff0c\u8131\u79bb\u7ec8\u7aef\u662f\u4e3a\u4e86\u907f\u514d\u5728\u6267\u884c\u7684\u8fc7\u7a0b\u4e2d\u7684\u4fe1\u606f\u5728\u7ec8\u7aef\u4e0a\u663e\u793a"]}),"\n",(0,r.jsx)(e.p,{children:"\u8bf4\u660e\uff1a\u5f53\u8fd0\u884c\u7684\u7ebf\u7a0b\u90fd\u662f\u5b88\u62a4\u7ebf\u7a0b\uff0cJava \u865a\u62df\u673a\u5c06\u9000\u51fa\uff0c\u56e0\u4e3a\u666e\u901a\u7ebf\u7a0b\u6267\u884c\u5b8c\u540e\uff0cJVM \u662f\u5b88\u62a4\u7ebf\u7a0b\uff0c\u4e0d\u4f1a\u7ee7\u7eed\u8fd0\u884c\u4e0b\u53bb"}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u89c1\u7684\u5b88\u62a4\u7ebf\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5783\u573e\u56de\u6536\u5668\u7ebf\u7a0b\u5c31\u662f\u4e00\u79cd\u5b88\u62a4\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"Tomcat \u4e2d\u7684 Acceptor \u548c Poller \u7ebf\u7a0b\u90fd\u662f\u5b88\u62a4\u7ebf\u7a0b\uff0c\u6240\u4ee5 Tomcat \u63a5\u6536\u5230 shutdown \u547d\u4ee4\u540e\uff0c\u4e0d\u4f1a\u7b49\u5f85\u5b83\u4eec\u5904\u7406\u5b8c\u5f53\u524d\u8bf7\u6c42"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4e0d\u63a8\u8350",children:"\u4e0d\u63a8\u8350"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u63a8\u8350\u4f7f\u7528\u7684\u65b9\u6cd5\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u5df2\u8fc7\u65f6\uff0c\u5bb9\u6613\u7834\u574f\u540c\u6b65\u4ee3\u7801\u5757\uff0c\u9020\u6210\u7ebf\u7a0b\u6b7b\u9501\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public final void stop()"}),"\uff1a\u505c\u6b62\u7ebf\u7a0b\u8fd0\u884c"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e9f\u5f03\u539f\u56e0\uff1a\u65b9\u6cd5\u7c97\u66b4\uff0c\u9664\u975e\u53ef\u80fd\u6267\u884c finally \u4ee3\u7801\u5757\u4ee5\u53ca\u91ca\u653e synchronized \u5916\uff0c\u7ebf\u7a0b\u5c06\u76f4\u63a5\u88ab\u7ec8\u6b62\uff0c\u5982\u679c\u7ebf\u7a0b\u6301\u6709 JUC \u7684\u4e92\u65a5\u9501\u53ef\u80fd\u5bfc\u81f4\u9501\u6765\u4e0d\u53ca\u91ca\u653e\uff0c\u9020\u6210\u5176\u4ed6\u7ebf\u7a0b\u6c38\u8fdc\u7b49\u5f85\u7684\u5c40\u9762"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public final void suspend()"}),"\uff1a",(0,r.jsx)(e.strong,{children:"\u6302\u8d77\uff08\u6682\u505c\uff09\u7ebf\u7a0b\u8fd0\u884c"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u5e9f\u5f03\u539f\u56e0\uff1a\u5982\u679c\u76ee\u6807\u7ebf\u7a0b\u5728\u6682\u505c\u65f6\u5bf9\u7cfb\u7edf\u8d44\u6e90\u6301\u6709\u9501\uff0c\u5219\u5728\u76ee\u6807\u7ebf\u7a0b\u6062\u590d\u4e4b\u524d\u6ca1\u6709\u7ebf\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8d44\u6e90\uff0c\u5982\u679c",(0,r.jsx)(e.strong,{children:"\u6062\u590d\u76ee\u6807\u7ebf\u7a0b\u7684\u7ebf\u7a0b"}),"\u5728\u8c03\u7528 resume \u4e4b\u524d\u4f1a\u5c1d\u8bd5\u8bbf\u95ee\u6b64\u5171\u4eab\u8d44\u6e90\uff0c\u5219\u4f1a\u5bfc\u81f4\u6b7b\u9501"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public final void resume()"}),"\uff1a\u6062\u590d\u7ebf\u7a0b\u8fd0\u884c"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u7ebf\u7a0b\u539f\u7406",children:"\u7ebf\u7a0b\u539f\u7406"}),"\n",(0,r.jsx)(e.h4,{id:"\u8fd0\u884c\u673a\u5236",children:"\u8fd0\u884c\u673a\u5236"}),"\n",(0,r.jsx)(e.p,{children:"Java Virtual Machine Stacks\uff08Java \u865a\u62df\u673a\u6808\uff09\uff1a\u6bcf\u4e2a\u7ebf\u7a0b\u542f\u52a8\u540e\uff0c\u865a\u62df\u673a\u5c31\u4f1a\u4e3a\u5176\u5206\u914d\u4e00\u5757\u6808\u5185\u5b58"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6bcf\u4e2a\u6808\u7531\u591a\u4e2a\u6808\u5e27\uff08Frame\uff09\u7ec4\u6210\uff0c\u5bf9\u5e94\u7740\u6bcf\u6b21\u65b9\u6cd5\u8c03\u7528\u65f6\u6240\u5360\u7528\u7684\u5185\u5b58"}),"\n",(0,r.jsx)(e.li,{children:"\u6bcf\u4e2a\u7ebf\u7a0b\u53ea\u80fd\u6709\u4e00\u4e2a\u6d3b\u52a8\u6808\u5e27\uff0c\u5bf9\u5e94\u7740\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u90a3\u4e2a\u65b9\u6cd5"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362\uff08Thread Context Switch\uff09\uff1a\u4e00\u4e9b\u539f\u56e0\u5bfc\u81f4 CPU \u4e0d\u518d\u6267\u884c\u5f53\u524d\u7ebf\u7a0b\uff0c\u8f6c\u800c\u6267\u884c\u53e6\u4e00\u4e2a\u7ebf\u7a0b"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u7684 CPU \u65f6\u95f4\u7247\u7528\u5b8c"}),"\n",(0,r.jsx)(e.li,{children:"\u5783\u573e\u56de\u6536"}),"\n",(0,r.jsx)(e.li,{children:"\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u7ebf\u7a0b\u9700\u8981\u8fd0\u884c"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u81ea\u5df1\u8c03\u7528\u4e86 sleep\u3001yield\u3001wait\u3001join\u3001park \u7b49\u65b9\u6cd5"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7a0b\u5e8f\u8ba1\u6570\u5668\uff08Program Counter Register\uff09\uff1a\u8bb0\u4f4f\u4e0b\u4e00\u6761 JVM \u6307\u4ee4\u7684\u6267\u884c\u5730\u5740\uff0c\u662f\u7ebf\u7a0b\u79c1\u6709\u7684"}),"\n",(0,r.jsx)(e.p,{children:"\u5f53 Context Switch \u53d1\u751f\u65f6\uff0c\u9700\u8981\u7531\u64cd\u4f5c\u7cfb\u7edf\u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u7684\u72b6\u6001\uff08PCB \u4e2d\uff09\uff0c\u5e76\u6062\u590d\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u7684\u72b6\u6001\uff0c\u5305\u62ec\u7a0b\u5e8f\u8ba1\u6570\u5668\u3001\u865a\u62df\u673a\u6808\u4e2d\u6bcf\u4e2a\u6808\u5e27\u7684\u4fe1\u606f\uff0c\u5982\u5c40\u90e8\u53d8\u91cf\u3001\u64cd\u4f5c\u6570\u6808\u3001\u8fd4\u56de\u5730\u5740\u7b49"}),"\n",(0,r.jsx)(e.p,{children:"JVM \u89c4\u8303\u5e76\u6ca1\u6709\u9650\u5b9a\u7ebf\u7a0b\u6a21\u578b\uff0c\u4ee5 HotSopot \u4e3a\u4f8b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Java \u7684\u7ebf\u7a0b\u662f\u5185\u6838\u7ea7\u7ebf\u7a0b\uff081:1 \u7ebf\u7a0b\u6a21\u578b\uff09\uff0c\u6bcf\u4e2a Java \u7ebf\u7a0b\u90fd\u6620\u5c04\u5230\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u539f\u751f\u7ebf\u7a0b\uff0c\u9700\u8981\u6d88\u8017\u4e00\u5b9a\u7684\u5185\u6838\u8d44\u6e90\uff08\u5806\u6808\uff09"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u7684\u8c03\u5ea6\u662f\u5728\u5185\u6838\u6001\u8fd0\u884c\u7684\uff0c\u800c\u7ebf\u7a0b\u4e2d\u7684\u4ee3\u7801\u662f\u5728\u7528\u6237\u6001\u8fd0\u884c"}),"\uff0c\u6240\u4ee5\u7ebf\u7a0b\u5207\u6362\uff08\u72b6\u6001\u6539\u53d8\uff09\u4f1a\u5bfc\u81f4\u7528\u6237\u4e0e\u5185\u6838\u6001\u8f6c\u6362\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\uff0c\u8fd9\u662f\u975e\u5e38\u6d88\u8017\u6027\u80fd"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Java \u4e2d main \u65b9\u6cd5\u542f\u52a8\u7684\u662f\u4e00\u4e2a\u8fdb\u7a0b\u4e5f\u662f\u4e00\u4e2a\u4e3b\u7ebf\u7a0b\uff0cmain \u65b9\u6cd5\u91cc\u9762\u7684\u5176\u4ed6\u7ebf\u7a0b\u5747\u4e3a\u5b50\u7ebf\u7a0b\uff0cmain \u7ebf\u7a0b\u662f\u8fd9\u4e9b\u7ebf\u7a0b\u7684\u7236\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u7ebf\u7a0b\u8c03\u5ea6",children:"\u7ebf\u7a0b\u8c03\u5ea6"}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u8c03\u5ea6\u6307\u7cfb\u7edf\u4e3a\u7ebf\u7a0b\u5206\u914d\u5904\u7406\u5668\u4f7f\u7528\u6743\u7684\u8fc7\u7a0b\uff0c\u65b9\u5f0f\u6709\u4e24\u79cd\uff1a\u534f\u540c\u5f0f\u7ebf\u7a0b\u8c03\u5ea6\u3001\u62a2\u5360\u5f0f\u7ebf\u7a0b\u8c03\u5ea6\uff08Java \u9009\u62e9\uff09"}),"\n",(0,r.jsx)(e.p,{children:"\u534f\u540c\u5f0f\u7ebf\u7a0b\u8c03\u5ea6\uff1a\u7ebf\u7a0b\u7684\u6267\u884c\u65f6\u95f4\u7531\u7ebf\u7a0b\u672c\u8eab\u63a7\u5236"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f18\u70b9\uff1a\u7ebf\u7a0b\u505a\u5b8c\u4efb\u52a1\u624d\u901a\u77e5\u7cfb\u7edf\u5207\u6362\u5230\u5176\u4ed6\u7ebf\u7a0b\uff0c\u76f8\u5f53\u4e8e\u6240\u6709\u7ebf\u7a0b\u4e32\u884c\u6267\u884c\uff0c\u4e0d\u4f1a\u51fa\u73b0\u7ebf\u7a0b\u540c\u6b65\u95ee\u9898"}),"\n",(0,r.jsx)(e.li,{children:"\u7f3a\u70b9\uff1a\u7ebf\u7a0b\u6267\u884c\u65f6\u95f4\u4e0d\u53ef\u63a7\uff0c\u5982\u679c\u4ee3\u7801\u7f16\u5199\u51fa\u73b0\u95ee\u9898\uff0c\u53ef\u80fd\u5bfc\u81f4\u7a0b\u5e8f\u4e00\u76f4\u963b\u585e\uff0c\u5f15\u8d77\u7cfb\u7edf\u7684\u5954\u6e83"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u62a2\u5360\u5f0f\u7ebf\u7a0b\u8c03\u5ea6\uff1a\u7ebf\u7a0b\u7684\u6267\u884c\u65f6\u95f4\u7531\u7cfb\u7edf\u5206\u914d"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f18\u70b9\uff1a\u7ebf\u7a0b\u6267\u884c\u65f6\u95f4\u53ef\u63a7\uff0c\u4e0d\u4f1a\u56e0\u4e3a\u4e00\u4e2a\u7ebf\u7a0b\u7684\u95ee\u9898\u800c\u5bfc\u81f4\u6574\u4f53\u7cfb\u7edf\u4e0d\u53ef\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u7f3a\u70b9\uff1a\u65e0\u6cd5\u4e3b\u52a8\u4e3a\u67d0\u4e2a\u7ebf\u7a0b\u591a\u5206\u914d\u65f6\u95f4"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Java \u63d0\u4f9b\u4e86\u7ebf\u7a0b\u4f18\u5148\u7ea7\u7684\u673a\u5236\uff0c\u4f18\u5148\u7ea7\u4f1a\u63d0\u793a\uff08hint\uff09\u8c03\u5ea6\u5668\u4f18\u5148\u8c03\u5ea6\u8be5\u7ebf\u7a0b\uff0c\u4f46\u8fd9\u4ec5\u4ec5\u662f\u4e00\u4e2a\u63d0\u793a\uff0c\u8c03\u5ea6\u5668\u53ef\u4ee5\u5ffd\u7565\u5b83\u3002\u5728\u7ebf\u7a0b\u7684\u5c31\u7eea\u72b6\u6001\u65f6\uff0c\u5982\u679c CPU \u6bd4\u8f83\u5fd9\uff0c\u90a3\u4e48\u4f18\u5148\u7ea7\u9ad8\u7684\u7ebf\u7a0b\u4f1a\u83b7\u5f97\u66f4\u591a\u7684\u65f6\u95f4\u7247\uff0c\u4f46 CPU \u95f2\u65f6\uff0c\u4f18\u5148\u7ea7\u51e0\u4e4e\u6ca1\u4f5c\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u8bf4\u660e\uff1a\u5e76\u4e0d\u80fd\u901a\u8fc7\u4f18\u5148\u7ea7\u6765\u5224\u65ad\u7ebf\u7a0b\u6267\u884c\u7684\u5148\u540e\u987a\u5e8f"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u672a\u6765\u4f18\u5316",children:"\u672a\u6765\u4f18\u5316"}),"\n",(0,r.jsxs)(e.p,{children:["\u5185\u6838\u7ea7\u7ebf\u7a0b\u8c03\u5ea6\u7684\u6210\u672c\u8f83\u5927\uff0c\u6240\u4ee5\u5f15\u5165\u4e86\u66f4\u8f7b\u91cf\u7ea7\u7684\u534f\u7a0b\u3002\u7528\u6237\u7ebf\u7a0b\u7684\u8c03\u5ea6\u7531\u7528\u6237\u81ea\u5df1\u5b9e\u73b0\uff08\u591a\u5bf9\u4e00\u7684\u7ebf\u7a0b\u6a21\u578b\uff0c\u591a",(0,r.jsx)(e.strong,{children:"\u4e2a\u7528\u6237\u7ebf\u7a0b\u6620\u5c04\u5230\u4e00\u4e2a\u5185\u6838\u7ea7\u7ebf\u7a0b"}),"\uff09\uff0c\u88ab\u8bbe\u8ba1\u4e3a\u534f\u540c\u5f0f\u8c03\u5ea6\uff0c\u6240\u4ee5\u53eb\u534f\u7a0b"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6709\u6808\u534f\u7a0b\uff1a\u534f\u7a0b\u4f1a\u5b8c\u6574\u7684\u505a\u8c03\u7528\u6808\u7684\u4fdd\u62a4\u3001\u6062\u590d\u5de5\u4f5c\uff0c\u6240\u4ee5\u53eb\u6709\u6808\u534f\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"\u65e0\u6808\u534f\u7a0b\uff1a\u672c\u8d28\u4e0a\u662f\u4e00\u79cd\u6709\u9650\u72b6\u6001\u673a\uff0c\u72b6\u6001\u4fdd\u5b58\u5728\u95ed\u5305\u91cc\uff0c\u6bd4\u6709\u6808\u534f\u7a0b\u66f4\u8f7b\u91cf\uff0c\u4f46\u662f\u529f\u80fd\u6709\u9650"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6709\u6808\u534f\u7a0b\u4e2d\u6709\u4e00\u79cd\u7279\u4f8b\u53eb\u7ea4\u7a0b\uff0c\u5728\u65b0\u5e76\u53d1\u6a21\u578b\u4e2d\uff0c\u4e00\u6bb5\u7ea4\u7a0b\u7684\u4ee3\u7801\u88ab\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u6267\u884c\u8fc7\u7a0b\u548c\u8c03\u5ea6\u5668\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6267\u884c\u8fc7\u7a0b\uff1a\u7528\u4e8e\u7ef4\u62a4\u6267\u884c\u73b0\u573a\uff0c\u4fdd\u62a4\u3001\u6062\u590d\u4e0a\u4e0b\u6587\u72b6\u6001"}),"\n",(0,r.jsx)(e.li,{children:"\u8c03\u5ea6\u5668\uff1a\u8d1f\u8d23\u7f16\u6392\u6240\u6709\u8981\u6267\u884c\u7684\u4ee3\u7801\u987a\u5e8f"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u7ebf\u7a0b\u72b6\u6001",children:"\u7ebf\u7a0b\u72b6\u6001"}),"\n",(0,r.jsx)(e.p,{children:"\u8fdb\u7a0b\u7684\u72b6\u6001\u53c2\u8003\u64cd\u4f5c\u7cfb\u7edf\uff1a\u521b\u5efa\u6001\u3001\u5c31\u7eea\u6001\u3001\u8fd0\u884c\u6001\u3001\u963b\u585e\u6001\u3001\u7ec8\u6b62\u6001"}),"\n",(0,r.jsxs)(e.p,{children:["\u7ebf\u7a0b\u7531\u751f\u5230\u6b7b\u7684\u5b8c\u6574\u8fc7\u7a0b\uff08\u751f\u547d\u5468\u671f\uff09\uff1a\u5f53\u7ebf\u7a0b\u88ab\u521b\u5efa\u5e76\u542f\u52a8\u4ee5\u540e\uff0c\u65e2\u4e0d\u662f\u4e00\u542f\u52a8\u5c31\u8fdb\u5165\u4e86\u6267\u884c\u72b6\u6001\uff0c\u4e5f\u4e0d\u662f\u4e00\u76f4\u5904\u4e8e\u6267\u884c\u72b6\u6001\uff0c\u5728 API \u4e2d ",(0,r.jsx)(e.code,{children:"java.lang.Thread.State"})," \u8fd9\u4e2a\u679a\u4e3e\u4e2d\u7ed9\u51fa\u4e86\u516d\u79cd\u7ebf\u7a0b\u72b6\u6001\uff1a"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u7ebf\u7a0b\u72b6\u6001"}),(0,r.jsx)(e.th,{children:"\u5bfc\u81f4\u72b6\u6001\u53d1\u751f\u6761\u4ef6"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"NEW\uff08\u65b0\u5efa\uff09"}),(0,r.jsx)(e.td,{children:"\u7ebf\u7a0b\u521a\u88ab\u521b\u5efa\uff0c\u4f46\u662f\u5e76\u672a\u542f\u52a8\uff0c\u8fd8\u6ca1\u8c03\u7528 start \u65b9\u6cd5\uff0c\u53ea\u6709\u7ebf\u7a0b\u5bf9\u8c61\uff0c\u6ca1\u6709\u7ebf\u7a0b\u7279\u5f81"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Runnable\uff08\u53ef\u8fd0\u884c\uff09"}),(0,r.jsx)(e.td,{children:"\u7ebf\u7a0b\u53ef\u4ee5\u5728 Java \u865a\u62df\u673a\u4e2d\u8fd0\u884c\u7684\u72b6\u6001\uff0c\u53ef\u80fd\u6b63\u5728\u8fd0\u884c\u81ea\u5df1\u4ee3\u7801\uff0c\u4e5f\u53ef\u80fd\u6ca1\u6709\uff0c\u8fd9\u53d6\u51b3\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u5904\u7406\u5668\uff0c\u8c03\u7528\u4e86 t.start() \u65b9\u6cd5\uff1a\u5c31\u7eea\uff08\u7ecf\u5178\u53eb\u6cd5\uff09"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Blocked\uff08\u963b\u585e\uff09"}),(0,r.jsx)(e.td,{children:"\u5f53\u4e00\u4e2a\u7ebf\u7a0b\u8bd5\u56fe\u83b7\u53d6\u4e00\u4e2a\u5bf9\u8c61\u9501\uff0c\u800c\u8be5\u5bf9\u8c61\u9501\u88ab\u5176\u4ed6\u7684\u7ebf\u7a0b\u6301\u6709\uff0c\u5219\u8be5\u7ebf\u7a0b\u8fdb\u5165 Blocked \u72b6\u6001\uff1b\u5f53\u8be5\u7ebf\u7a0b\u6301\u6709\u9501\u65f6\uff0c\u8be5\u7ebf\u7a0b\u5c06\u53d8\u6210 Runnable \u72b6\u6001"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Waiting\uff08\u65e0\u9650\u7b49\u5f85\uff09"}),(0,r.jsx)(e.td,{children:"\u4e00\u4e2a\u7ebf\u7a0b\u5728\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u4e00\u4e2a\uff08\u5524\u9192\uff09\u52a8\u4f5c\u65f6\uff0c\u8be5\u7ebf\u7a0b\u8fdb\u5165 Waiting \u72b6\u6001\uff0c\u8fdb\u5165\u8fd9\u4e2a\u72b6\u6001\u540e\u4e0d\u80fd\u81ea\u52a8\u5524\u9192\uff0c\u5fc5\u987b\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u8c03\u7528 notify \u6216\u8005 notifyAll \u65b9\u6cd5\u624d\u80fd\u5524\u9192"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Timed Waiting \uff08\u9650\u671f\u7b49\u5f85\uff09"}),(0,r.jsx)(e.td,{children:"\u6709\u51e0\u4e2a\u65b9\u6cd5\u6709\u8d85\u65f6\u53c2\u6570\uff0c\u8c03\u7528\u5c06\u8fdb\u5165 Timed Waiting \u72b6\u6001\uff0c\u8fd9\u4e00\u72b6\u6001\u5c06\u4e00\u76f4\u4fdd\u6301\u5230\u8d85\u65f6\u671f\u6ee1\u6216\u8005\u63a5\u6536\u5230\u5524\u9192\u901a\u77e5\u3002\u5e26\u6709\u8d85\u65f6\u53c2\u6570\u7684\u5e38\u7528\u65b9\u6cd5\u6709 Thread.sleep \u3001Object.wait"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Teminated\uff08\u7ed3\u675f\uff09"}),(0,r.jsx)(e.td,{children:"run \u65b9\u6cd5\u6b63\u5e38\u9000\u51fa\u800c\u6b7b\u4ea1\uff0c\u6216\u8005\u56e0\u4e3a\u6ca1\u6709\u6355\u83b7\u7684\u5f02\u5e38\u7ec8\u6b62\u4e86 run \u65b9\u6cd5\u800c\u6b7b\u4ea1"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(5649).A+"",width:"729",height:"528"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"NEW \u2192 RUNNABLE\uff1a\u5f53\u8c03\u7528 t.start() \u65b9\u6cd5\u65f6\uff0c\u7531 NEW \u2192 RUNNABLE"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"RUNNABLE <--\x3e WAITING\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8c03\u7528 obj.wait() \u65b9\u6cd5\u65f6"}),"\n",(0,r.jsx)(e.p,{children:"\u8c03\u7528 obj.notify()\u3001obj.notifyAll()\u3001t.interrupt()\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7ade\u4e89\u9501\u6210\u529f\uff0ct \u7ebf\u7a0b\u4ece WAITING \u2192 RUNNABLE"}),"\n",(0,r.jsx)(e.li,{children:"\u7ade\u4e89\u9501\u5931\u8d25\uff0ct \u7ebf\u7a0b\u4ece WAITING \u2192 BLOCKED"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u524d\u7ebf\u7a0b\u8c03\u7528 t.join() \u65b9\u6cd5\uff0c\u6ce8\u610f\u662f\u5f53\u524d\u7ebf\u7a0b\u5728 t \u7ebf\u7a0b\u5bf9\u8c61\u7684\u76d1\u89c6\u5668\u4e0a\u7b49\u5f85"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u524d\u7ebf\u7a0b\u8c03\u7528 LockSupport.park() \u65b9\u6cd5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"RUNNABLE <--\x3e TIMED_WAITING\uff1a\u8c03\u7528 obj.wait(long n) \u65b9\u6cd5\u3001\u5f53\u524d\u7ebf\u7a0b\u8c03\u7528 t.join(long n) \u65b9\u6cd5\u3001\u5f53\u524d\u7ebf\u7a0b\u8c03\u7528 Thread.sleep(long n)"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"RUNNABLE <--\x3e BLOCKED\uff1at \u7ebf\u7a0b\u7528 synchronized(obj) \u83b7\u53d6\u4e86\u5bf9\u8c61\u9501\u65f6\u7ade\u4e89\u5931\u8d25"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u67e5\u770b\u7ebf\u7a0b",children:"\u67e5\u770b\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:"Windows\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4efb\u52a1\u7ba1\u7406\u5668\u53ef\u4ee5\u67e5\u770b\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u6570\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u6740\u6b7b\u8fdb\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"tasklist \u67e5\u770b\u8fdb\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"taskkill \u6740\u6b7b\u8fdb\u7a0b"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Linux\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"ps -ef \u67e5\u770b\u6240\u6709\u8fdb\u7a0b"}),"\n",(0,r.jsxs)(e.li,{children:["ps -fT -p ",(0,r.jsx)(e.pid,{children:" \u67e5\u770b\u67d0\u4e2a\u8fdb\u7a0b\uff08PID\uff09\u7684\u6240\u6709\u7ebf\u7a0b"})]}),"\n",(0,r.jsx)(e.li,{children:"kill \u6740\u6b7b\u8fdb\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"top \u6309\u5927\u5199 H \u5207\u6362\u662f\u5426\u663e\u793a\u7ebf\u7a0b"}),"\n",(0,r.jsxs)(e.li,{children:["top -H -p ",(0,r.jsx)(e.pid,{children:" \u67e5\u770b\u67d0\u4e2a\u8fdb\u7a0b\uff08PID\uff09\u7684\u6240\u6709\u7ebf\u7a0b"})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Java\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"jps \u547d\u4ee4\u67e5\u770b\u6240\u6709 Java \u8fdb\u7a0b"}),"\n",(0,r.jsxs)(e.li,{children:["jstack ",(0,r.jsx)(e.pid,{children:" \u67e5\u770b\u67d0\u4e2a Java \u8fdb\u7a0b\uff08PID\uff09\u7684\u6240\u6709\u7ebf\u7a0b\u72b6\u6001"})]}),"\n",(0,r.jsx)(e.li,{children:"jconsole \u6765\u67e5\u770b\u67d0\u4e2a Java \u8fdb\u7a0b\u4e2d\u7ebf\u7a0b\u7684\u8fd0\u884c\u60c5\u51b5\uff08\u56fe\u5f62\u754c\u9762\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u540c\u6b65",children:"\u540c\u6b65"}),"\n",(0,r.jsx)(e.h3,{id:"\u4e34\u754c\u533a",children:"\u4e34\u754c\u533a"}),"\n",(0,r.jsx)(e.p,{children:"\u4e34\u754c\u8d44\u6e90\uff1a\u4e00\u6b21\u4ec5\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u7684\u8d44\u6e90\u6210\u4e3a\u4e34\u754c\u8d44\u6e90"}),"\n",(0,r.jsx)(e.p,{children:"\u4e34\u754c\u533a\uff1a\u8bbf\u95ee\u4e34\u754c\u8d44\u6e90\u7684\u4ee3\u7801\u5757"}),"\n",(0,r.jsx)(e.p,{children:"\u7ade\u6001\u6761\u4ef6\uff1a\u591a\u4e2a\u7ebf\u7a0b\u5728\u4e34\u754c\u533a\u5185\u6267\u884c\uff0c\u7531\u4e8e\u4ee3\u7801\u7684\u6267\u884c\u5e8f\u5217\u4e0d\u540c\u800c\u5bfc\u81f4\u7ed3\u679c\u65e0\u6cd5\u9884\u6d4b\uff0c\u79f0\u4e4b\u4e3a\u53d1\u751f\u4e86\u7ade\u6001\u6761\u4ef6"}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e2a\u7a0b\u5e8f\u8fd0\u884c\u591a\u4e2a\u7ebf\u7a0b\u662f\u6ca1\u6709\u95ee\u9898\uff0c\u591a\u4e2a\u7ebf\u7a0b\u8bfb\u5171\u4eab\u8d44\u6e90\u4e5f\u6ca1\u6709\u95ee\u9898\uff0c\u5728\u591a\u4e2a\u7ebf\u7a0b\u5bf9\u5171\u4eab\u8d44\u6e90\u8bfb\u5199\u64cd\u4f5c\u65f6\u53d1\u751f\u6307\u4ee4\u4ea4\u9519\uff0c\u5c31\u4f1a\u51fa\u73b0\u95ee\u9898"}),"\n",(0,r.jsx)(e.p,{children:"\u4e3a\u4e86\u907f\u514d\u4e34\u754c\u533a\u7684\u7ade\u6001\u6761\u4ef6\u53d1\u751f\uff08\u89e3\u51b3\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898\uff09\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u963b\u585e\u5f0f\u7684\u89e3\u51b3\u65b9\u6848\uff1asynchronized\uff0clock"}),"\n",(0,r.jsx)(e.li,{children:"\u975e\u963b\u585e\u5f0f\u7684\u89e3\u51b3\u65b9\u6848\uff1a\u539f\u5b50\u53d8\u91cf"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7ba1\u7a0b\uff08monitor\uff09\uff1a\u7531\u5c40\u90e8\u4e8e\u81ea\u5df1\u7684\u82e5\u5e72\u516c\u5171\u53d8\u91cf\u548c\u6240\u6709\u8bbf\u95ee\u8fd9\u4e9b\u516c\u5171\u53d8\u91cf\u7684\u8fc7\u7a0b\u6240\u7ec4\u6210\u7684\u8f6f\u4ef6\u6a21\u5757\uff0c\u4fdd\u8bc1\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\u5728\u7ba1\u7a0b\u5185\u6d3b\u52a8\uff0c\u5373\u7ba1\u7a0b\u5185\u5b9a\u4e49\u7684\u64cd\u4f5c\u5728\u540c\u4e00\u65f6\u523b\u53ea\u88ab\u4e00\u4e2a\u8fdb\u7a0b\u8c03\u7528\uff08\u7531\u7f16\u8bd1\u5668\u5b9e\u73b0\uff09"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"synchronized\uff1a\u5bf9\u8c61\u9501\uff0c\u4fdd\u8bc1\u4e86\u4e34\u754c\u533a\u5185\u4ee3\u7801\u7684\u539f\u5b50\u6027"}),"\uff0c\u91c7\u7528\u4e92\u65a5\u7684\u65b9\u5f0f\u8ba9\u540c\u4e00\u65f6\u523b\u81f3\u591a\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u80fd\u6301\u6709\u5bf9\u8c61\u9501\uff0c\u5176\u5b83\u7ebf\u7a0b\u83b7\u53d6\u8fd9\u4e2a\u5bf9\u8c61\u9501\u65f6\u4f1a\u963b\u585e\uff0c\u4fdd\u8bc1\u62e5\u6709\u9501\u7684\u7ebf\u7a0b\u53ef\u4ee5\u5b89\u5168\u7684\u6267\u884c\u4e34\u754c\u533a\u5185\u7684\u4ee3\u7801\uff0c\u4e0d\u7528\u62c5\u5fc3\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e92\u65a5\u548c\u540c\u6b65\u90fd\u53ef\u4ee5\u91c7\u7528 synchronized \u5173\u952e\u5b57\u6765\u5b8c\u6210\uff0c\u533a\u522b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e92\u65a5\u662f\u4fdd\u8bc1\u4e34\u754c\u533a\u7684\u7ade\u6001\u6761\u4ef6\u53d1\u751f\uff0c\u540c\u4e00\u65f6\u523b\u53ea\u80fd\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u4e34\u754c\u533a\u4ee3\u7801"}),"\n",(0,r.jsx)(e.li,{children:"\u540c\u6b65\u662f\u7531\u4e8e\u7ebf\u7a0b\u6267\u884c\u7684\u5148\u540e\u3001\u987a\u5e8f\u4e0d\u540c\u3001\u9700\u8981\u4e00\u4e2a\u7ebf\u7a0b\u7b49\u5f85\u5176\u5b83\u7ebf\u7a0b\u8fd0\u884c\u5230\u67d0\u4e2a\u70b9"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6027\u80fd\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u5b89\u5168\uff0c\u6027\u80fd\u5dee"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u4e0d\u5b89\u5168\u6027\u80fd\u597d\uff0c\u5047\u5982\u5f00\u53d1\u4e2d\u4e0d\u4f1a\u5b58\u5728\u591a\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898\uff0c\u5efa\u8bae\u4f7f\u7528\u7ebf\u7a0b\u4e0d\u5b89\u5168\u7684\u8bbe\u8ba1\u7c7b"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"syn-ed",children:"syn-ed"}),"\n",(0,r.jsx)(e.h4,{id:"\u4f7f\u7528\u9501",children:"\u4f7f\u7528\u9501"}),"\n",(0,r.jsx)(e.h5,{id:"\u540c\u6b65\u5757",children:"\u540c\u6b65\u5757"}),"\n",(0,r.jsxs)(e.p,{children:["\u9501\u5bf9\u8c61\uff1a\u7406\u8bba\u4e0a\u53ef\u4ee5\u662f",(0,r.jsx)(e.strong,{children:"\u4efb\u610f\u7684\u552f\u4e00\u5bf9\u8c61"})]}),"\n",(0,r.jsx)(e.p,{children:"synchronized \u662f\u53ef\u91cd\u5165\u3001\u4e0d\u516c\u5e73\u7684\u91cd\u91cf\u7ea7\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u5219\u4e0a\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9501\u5bf9\u8c61\u5efa\u8bae\u4f7f\u7528\u5171\u4eab\u8d44\u6e90"}),"\n",(0,r.jsx)(e.li,{children:"\u5728\u5b9e\u4f8b\u65b9\u6cd5\u4e2d\u4f7f\u7528 this \u4f5c\u4e3a\u9501\u5bf9\u8c61\uff0c\u9501\u4f4f\u7684 this \u6b63\u597d\u662f\u5171\u4eab\u8d44\u6e90"}),"\n",(0,r.jsx)(e.li,{children:"\u5728\u9759\u6001\u65b9\u6cd5\u4e2d\u4f7f\u7528\u7c7b\u540d .class \u5b57\u8282\u7801\u4f5c\u4e3a\u9501\u5bf9\u8c61\uff0c\u56e0\u4e3a\u9759\u6001\u6210\u5458\u5c5e\u4e8e\u7c7b\uff0c\u88ab\u6240\u6709\u5b9e\u4f8b\u5bf9\u8c61\u5171\u4eab\uff0c\u6240\u4ee5\u9700\u8981\u9501\u4f4f\u7c7b"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u6b65\u4ee3\u7801\u5757\u683c\u5f0f\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"synchronized(\u9501\u5bf9\u8c61){\n\t// \u8bbf\u95ee\u5171\u4eab\u8d44\u6e90\u7684\u6838\u5fc3\u4ee3\u7801\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5b9e\u4f8b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class demo {\n    static int counter = 0;\n    //static\u4fee\u9970\uff0c\u5219\u5143\u7d20\u662f\u5c5e\u4e8e\u7c7b\u672c\u8eab\u7684\uff0c\u4e0d\u5c5e\u4e8e\u5bf9\u8c61  \uff0c\u4e0e\u7c7b\u4e00\u8d77\u52a0\u8f7d\u4e00\u6b21\uff0c\u53ea\u6709\u4e00\u4e2a\n    static final Object room = new Object();\n    public static void main(String[] args) throws InterruptedException {\n        Thread t1 = new Thread(() -> {\n            for (int i = 0; i < 5000; i++) {\n                synchronized (room) {\n                    counter++;\n                }\n            }\n        }, "t1");\n        Thread t2 = new Thread(() -> {\n            for (int i = 0; i < 5000; i++) {\n                synchronized (room) {\n                    counter--;\n                }\n            }\n        }, "t2");\n        t1.start();\n        t2.start();\n        t1.join();\n        t2.join();\n        System.out.println(counter);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u540c\u6b65\u65b9\u6cd5",children:"\u540c\u6b65\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u628a\u51fa\u73b0\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898\u7684\u6838\u5fc3\u65b9\u6cd5\u9501\u8d77\u6765\uff0c\u6bcf\u6b21\u53ea\u80fd\u4e00\u4e2a\u7ebf\u7a0b\u8fdb\u5165\u8bbf\u95ee"}),"\n",(0,r.jsxs)(e.p,{children:["synchronized \u4fee\u9970\u7684\u65b9\u6cd5\u7684\u4e0d\u5177\u5907\u7ee7\u627f\u6027\uff0c\u6240\u4ee5\u5b50\u7c7b\u662f\u7ebf\u7a0b\u4e0d\u5b89\u5168\u7684\uff0c\u5982\u679c\u5b50\u7c7b\u7684\u65b9\u6cd5\u4e5f\u88ab synchronized \u4fee\u9970\uff0c\u4e24\u4e2a\u9501\u5bf9\u8c61\u5176\u5b9e\u662f\u4e00\u628a\u9501\uff0c\u800c\u4e14\u662f",(0,r.jsx)(e.strong,{children:"\u5b50\u7c7b\u5bf9\u8c61\u4f5c\u4e3a\u9501"})]}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u6cd5\uff1a\u76f4\u63a5\u7ed9\u65b9\u6cd5\u52a0\u4e0a\u4e00\u4e2a\u4fee\u9970\u7b26 synchronized"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"//\u540c\u6b65\u65b9\u6cd5\n\u4fee\u9970\u7b26 synchronized \u8fd4\u56de\u503c\u7c7b\u578b \u65b9\u6cd5\u540d(\u65b9\u6cd5\u53c2\u6570) { \n\t\u65b9\u6cd5\u4f53\uff1b\n}\n//\u540c\u6b65\u9759\u6001\u65b9\u6cd5\n\u4fee\u9970\u7b26 static synchronized \u8fd4\u56de\u503c\u7c7b\u578b \u65b9\u6cd5\u540d(\u65b9\u6cd5\u53c2\u6570) { \n\t\u65b9\u6cd5\u4f53\uff1b\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u6b65\u65b9\u6cd5\u5e95\u5c42\u4e5f\u662f\u6709\u9501\u5bf9\u8c61\u7684\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u65b9\u6cd5\u662f\u5b9e\u4f8b\u65b9\u6cd5\uff1a\u540c\u6b65\u65b9\u6cd5\u9ed8\u8ba4\u7528 this \u4f5c\u4e3a\u7684\u9501\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public synchronized void test() {} //\u7b49\u4ef7\u4e8e\npublic void test() {\n    synchronized(this) {}\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u65b9\u6cd5\u662f\u9759\u6001\u65b9\u6cd5\uff1a\u540c\u6b65\u65b9\u6cd5\u9ed8\u8ba4\u7528\u7c7b\u540d .class \u4f5c\u4e3a\u7684\u9501\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"class Test{\n\tpublic synchronized static void test() {}\n}\n//\u7b49\u4ef7\u4e8e\nclass Test{\n    public void test() {\n        synchronized(Test.class) {}\n\t}\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u7ebf\u7a0b\u516b\u9501",children:"\u7ebf\u7a0b\u516b\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u516b\u9501\u5c31\u662f\u8003\u5bdf synchronized \u9501\u4f4f\u7684\u662f\u54ea\u4e2a\u5bf9\u8c61\uff0c\u76f4\u63a5\u767e\u5ea6\u641c\u7d22\u76f8\u5173\u7684\u5b9e\u4f8b"}),"\n",(0,r.jsx)(e.p,{children:"\u8bf4\u660e\uff1a\u4e3b\u8981\u5173\u6ce8\u9501\u4f4f\u7684\u5bf9\u8c61\u662f\u4e0d\u662f\u540c\u4e00\u4e2a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9501\u4f4f\u7c7b\u5bf9\u8c61\uff0c\u6240\u6709\u7c7b\u7684\u5b9e\u4f8b\u7684\u65b9\u6cd5\u90fd\u662f\u5b89\u5168\u7684\uff0c\u7c7b\u7684\u6240\u6709\u5b9e\u4f8b\u90fd\u76f8\u5f53\u4e8e\u540c\u4e00\u628a\u9501"}),"\n",(0,r.jsx)(e.li,{children:"\u9501\u4f4f this \u5bf9\u8c61\uff0c\u53ea\u6709\u5728\u5f53\u524d\u5b9e\u4f8b\u5bf9\u8c61\u7684\u7ebf\u7a0b\u5185\u662f\u5b89\u5168\u7684\uff0c\u5982\u679c\u6709\u591a\u4e2a\u5b9e\u4f8b\u5c31\u4e0d\u5b89\u5168"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u4e0d\u5b89\u5168\uff1a\u56e0\u4e3a\u9501\u4f4f\u7684\u4e0d\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\uff0c\u7ebf\u7a0b 1 \u8c03\u7528 a \u65b9\u6cd5\u9501\u4f4f\u7684\u7c7b\u5bf9\u8c61\uff0c\u7ebf\u7a0b 2 \u8c03\u7528 b \u65b9\u6cd5\u9501\u4f4f\u7684 n2 \u5bf9\u8c61\uff0c\u4e0d\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'class Number{\n    public static synchronized void a(){\n\t\tThread.sleep(1000);\n        System.out.println("1");\n    }\n    public synchronized void b() {\n        System.out.println("2");\n    }\n}\npublic static void main(String[] args) {\n    Number n1 = new Number();\n    Number n2 = new Number();\n    new Thread(()->{ n1.a(); }).start();\n    new Thread(()->{ n2.b(); }).start();\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u5b89\u5168\uff1a\u56e0\u4e3a n1 \u8c03\u7528 a() \u65b9\u6cd5\uff0c\u9501\u4f4f\u7684\u662f\u7c7b\u5bf9\u8c61\uff0cn2 \u8c03\u7528 b() \u65b9\u6cd5\uff0c\u9501\u4f4f\u7684\u4e5f\u662f\u7c7b\u5bf9\u8c61\uff0c\u6240\u4ee5\u7ebf\u7a0b\u5b89\u5168"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'class Number{\n    public static synchronized void a(){\n\t\tThread.sleep(1000);\n        System.out.println("1");\n    }\n    public static synchronized void b() {\n        System.out.println("2");\n    }\n}\npublic static void main(String[] args) {\n    Number n1 = new Number();\n    Number n2 = new Number();\n    new Thread(()->{ n1.a(); }).start();\n    new Thread(()->{ n2.b(); }).start();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u9501\u539f\u7406",children:"\u9501\u539f\u7406"}),"\n",(0,r.jsx)(e.h5,{id:"monitor",children:"Monitor"}),"\n",(0,r.jsx)(e.p,{children:"Monitor \u88ab\u7ffb\u8bd1\u4e3a\u76d1\u89c6\u5668\u6216\u7ba1\u7a0b"}),"\n",(0,r.jsxs)(e.p,{children:["\u6bcf\u4e2a Java \u5bf9\u8c61\u90fd\u53ef\u4ee5\u5173\u8054\u4e00\u4e2a Monitor \u5bf9\u8c61\uff0cMonitor \u4e5f\u662f class\uff0c\u5176",(0,r.jsx)(e.strong,{children:"\u5b9e\u4f8b\u5b58\u50a8\u5728\u5806\u4e2d"}),"\uff0c\u5982\u679c\u4f7f\u7528 synchronized \u7ed9\u5bf9\u8c61\u4e0a\u9501\uff08\u91cd\u91cf\u7ea7\uff09\u4e4b\u540e\uff0c\u8be5\u5bf9\u8c61\u5934\u7684 Mark Word \u4e2d\u5c31\u88ab\u8bbe\u7f6e\u6307\u5411 Monitor \u5bf9\u8c61\u7684\u6307\u9488\uff0c\u8fd9\u5c31\u662f\u91cd\u91cf\u7ea7\u9501"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Mark Word \u7ed3\u6784\uff1a\u6700\u540e\u4e24\u4f4d\u662f",(0,r.jsx)(e.strong,{children:"\u9501\u6807\u5fd7\u4f4d"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(96740).A+"",width:"921",height:"366"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"64 \u4f4d\u865a\u62df\u673a Mark Word\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(83835).A+"",width:"898",height:"359"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5de5\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f00\u59cb\u65f6 Monitor \u4e2d Owner \u4e3a null"}),"\n",(0,r.jsxs)(e.li,{children:["\u5f53 Thread-2 \u6267\u884c synchronized(obj) \u5c31\u4f1a\u5c06 Monitor \u7684\u6240\u6709\u8005 Owner \u7f6e\u4e3a Thread-2\uff0cMonitor \u4e2d\u53ea\u80fd\u6709\u4e00\u4e2a Owner\uff0c",(0,r.jsx)(e.strong,{children:"obj \u5bf9\u8c61\u7684 Mark Word \u6307\u5411 Monitor"}),"\uff0c\u628a",(0,r.jsx)(e.strong,{children:"\u5bf9\u8c61\u539f\u6709\u7684 MarkWord \u5b58\u5165\u7ebf\u7a0b\u6808\u4e2d\u7684\u9501\u8bb0\u5f55"}),"\u4e2d\uff08\u8f7b\u91cf\u7ea7\u9501\u90e8\u5206\u8be6\u89e3\uff09\n",(0,r.jsx)(e.img,{src:l(17156).A+"",width:"991",height:"527"})]}),"\n",(0,r.jsx)(e.li,{children:"\u5728 Thread-2 \u4e0a\u9501\u7684\u8fc7\u7a0b\uff0cThread-3\u3001Thread-4\u3001Thread-5 \u4e5f\u6267\u884c synchronized(obj)\uff0c\u5c31\u4f1a\u8fdb\u5165 EntryList BLOCKED\uff08\u53cc\u5411\u94fe\u8868\uff09"}),"\n",(0,r.jsx)(e.li,{children:"Thread-2 \u6267\u884c\u5b8c\u540c\u6b65\u4ee3\u7801\u5757\u7684\u5185\u5bb9\uff0c\u6839\u636e obj \u5bf9\u8c61\u5934\u4e2d Monitor \u5730\u5740\u5bfb\u627e\uff0c\u8bbe\u7f6e Owner \u4e3a\u7a7a\uff0c\u628a\u7ebf\u7a0b\u6808\u7684\u9501\u8bb0\u5f55\u4e2d\u7684\u5bf9\u8c61\u5934\u7684\u503c\u8bbe\u7f6e\u56de MarkWord"}),"\n",(0,r.jsxs)(e.li,{children:["\u5524\u9192 EntryList \u4e2d\u7b49\u5f85\u7684\u7ebf\u7a0b\u6765\u7ade\u4e89\u9501\uff0c\u7ade\u4e89\u662f",(0,r.jsx)(e.strong,{children:"\u975e\u516c\u5e73\u7684"}),"\uff0c\u5982\u679c\u8fd9\u65f6\u6709\u65b0\u7684\u7ebf\u7a0b\u60f3\u8981\u83b7\u53d6\u9501\uff0c\u53ef\u80fd\u76f4\u63a5\u5c31\u62a2\u5360\u5230\u4e86\uff0c\u963b\u585e\u961f\u5217\u7684\u7ebf\u7a0b\u5c31\u4f1a\u7ee7\u7eed\u963b\u585e"]}),"\n",(0,r.jsx)(e.li,{children:"WaitSet \u4e2d\u7684 Thread-0\uff0c\u662f\u4ee5\u524d\u83b7\u5f97\u8fc7\u9501\uff0c\u4f46\u6761\u4ef6\u4e0d\u6ee1\u8db3\u8fdb\u5165 WAITING \u72b6\u6001\u7684\u7ebf\u7a0b\uff08wait-notify \u673a\u5236\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(2431).A+"",width:"939",height:"386"})}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"synchronized \u5fc5\u987b\u662f\u8fdb\u5165\u540c\u4e00\u4e2a\u5bf9\u8c61\u7684 Monitor \u624d\u6709\u4e0a\u8ff0\u7684\u6548\u679c"}),"\n",(0,r.jsx)(e.li,{children:"\u4e0d\u52a0 synchronized \u7684\u5bf9\u8c61\u4e0d\u4f1a\u5173\u8054\u76d1\u89c6\u5668\uff0c\u4e0d\u9075\u4ece\u4ee5\u4e0a\u89c4\u5219"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5b57\u8282\u7801",children:"\u5b57\u8282\u7801"}),"\n",(0,r.jsx)(e.p,{children:"\u4ee3\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    Object lock = new Object();\n    synchronized (lock) {\n        System.out.println("ok");\n    }\n}\n'})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'0: \tnew\t\t\t\t#2\t\t// new Object\n3: \tdup\n4: \tinvokespecial \t#1 \t\t// invokespecial <init>:()V\uff0c\u975e\u865a\u65b9\u6cd5\n7: \tastore_1 \t\t\t\t// lock\u5f15\u7528 -> lock\n8: \taload_1\t\t\t\t\t// lock \uff08synchronized\u5f00\u59cb\uff09\n9: \tdup\t\t\t\t\t\t// \u4e00\u4efd\u7528\u6765\u521d\u59cb\u5316\uff0c\u4e00\u4efd\u7528\u6765\u5f15\u7528\n10: astore_2 \t\t\t\t// lock\u5f15\u7528 -> slot 2\n11: monitorenter \t\t\t// \u3010\u5c06 lock\u5bf9\u8c61 MarkWord \u7f6e\u4e3a Monitor \u6307\u9488\u3011\n12: getstatic \t\t#3\t\t// System.out\n15: ldc \t\t\t#4\t\t// "ok"\n17: invokevirtual \t#5 \t\t// invokevirtual println:(Ljava/lang/String;)V\n20: aload_2 \t\t\t\t// slot 2(lock\u5f15\u7528)\n21: monitorexit \t\t\t// \u3010\u5c06 lock\u5bf9\u8c61 MarkWord \u91cd\u7f6e, \u5524\u9192 EntryList\u3011\n22: goto 30\n25: astore_3 \t\t\t\t// any -> slot 3\n26: aload_2 \t\t\t\t// slot 2(lock\u5f15\u7528)\n27: monitorexit \t\t\t// \u3010\u5c06 lock\u5bf9\u8c61 MarkWord \u91cd\u7f6e, \u5524\u9192 EntryList\u3011\n28: aload_3\n29: athrow\n30: return\nException table:\n    from to target type\n      12 22 25 \t\tany\n      25 28 25 \t\tany\nLineNumberTable: ...\nLocalVariableTable:\n    Start Length Slot Name Signature\n    \t0 \t31 \t\t0 args [Ljava/lang/String;\n    \t8 \t23 \t\t1 lock Ljava/lang/Object;\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u8bf4\u660e\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u901a\u8fc7\u5f02\u5e38 ",(0,r.jsx)(e.strong,{children:"try-catch \u673a\u5236"}),"\uff0c\u786e\u4fdd\u4e00\u5b9a\u4f1a\u88ab\u89e3\u9501"]}),"\n",(0,r.jsx)(e.li,{children:"\u65b9\u6cd5\u7ea7\u522b\u7684 synchronized \u4e0d\u4f1a\u5728\u5b57\u8282\u7801\u6307\u4ee4\u4e2d\u6709\u6240\u4f53\u73b0"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u9501\u5347\u7ea7",children:"\u9501\u5347\u7ea7"}),"\n",(0,r.jsx)(e.h5,{id:"\u5347\u7ea7\u8fc7\u7a0b",children:"\u5347\u7ea7\u8fc7\u7a0b"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"synchronized \u662f\u53ef\u91cd\u5165\u3001\u4e0d\u516c\u5e73\u7684\u91cd\u91cf\u7ea7\u9501"}),"\uff0c\u6240\u4ee5\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u4f18\u5316"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\u65e0\u9501 -> \u504f\u5411\u9501 -> \u8f7b\u91cf\u7ea7\u9501 -> \u91cd\u91cf\u7ea7\u9501\t// \u968f\u7740\u7ade\u4e89\u7684\u589e\u52a0\uff0c\u53ea\u80fd\u9501\u5347\u7ea7\uff0c\u4e0d\u80fd\u964d\u7ea7\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(11326).A+"",width:"852",height:"303"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u504f\u5411\u9501",children:"\u504f\u5411\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u504f\u5411\u9501\u7684\u601d\u60f3\u662f\u504f\u5411\u4e8e\u8ba9\u7b2c\u4e00\u4e2a\u83b7\u53d6\u9501\u5bf9\u8c61\u7684\u7ebf\u7a0b\uff0c\u8fd9\u4e2a\u7ebf\u7a0b\u4e4b\u540e\u91cd\u65b0\u83b7\u53d6\u8be5\u9501\u4e0d\u518d\u9700\u8981\u540c\u6b65\u64cd\u4f5c\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5f53\u9501\u5bf9\u8c61\u7b2c\u4e00\u6b21\u88ab\u7ebf\u7a0b\u83b7\u5f97\u7684\u65f6\u5019\u8fdb\u5165\u504f\u5411\u72b6\u6001\uff0c\u6807\u8bb0\u4e3a 101\uff0c\u540c\u65f6",(0,r.jsx)(e.strong,{children:"\u4f7f\u7528 CAS \u64cd\u4f5c\u5c06\u7ebf\u7a0b ID \u8bb0\u5f55\u5230 Mark Word"}),"\u3002\u5982\u679c CAS \u64cd\u4f5c\u6210\u529f\uff0c\u8fd9\u4e2a\u7ebf\u7a0b\u4ee5\u540e\u8fdb\u5165\u8fd9\u4e2a\u9501\u76f8\u5173\u7684\u540c\u6b65\u5757\uff0c\u67e5\u770b\u8fd9\u4e2a\u7ebf\u7a0b ID \u662f\u81ea\u5df1\u7684\u5c31\u8868\u793a\u6ca1\u6709\u7ade\u4e89\uff0c\u5c31\u4e0d\u9700\u8981\u518d\u8fdb\u884c\u4efb\u4f55\u540c\u6b65\u64cd\u4f5c"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u6709\u53e6\u5916\u4e00\u4e2a\u7ebf\u7a0b\u53bb\u5c1d\u8bd5\u83b7\u53d6\u8fd9\u4e2a\u9501\u5bf9\u8c61\u65f6\uff0c\u504f\u5411\u72b6\u6001\u5c31\u5ba3\u544a\u7ed3\u675f\uff0c\u6b64\u65f6\u64a4\u9500\u504f\u5411\uff08Revoke Bias\uff09\u540e\u6062\u590d\u5230\u672a\u9501\u5b9a\u6216\u8f7b\u91cf\u7ea7\u9501\u72b6\u6001"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(83835).A+"",width:"898",height:"359"})}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e2a\u5bf9\u8c61\u521b\u5efa\u65f6\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u5f00\u542f\u4e86\u504f\u5411\u9501\uff08\u9ed8\u8ba4\u5f00\u542f\uff09\uff0c\u90a3\u4e48\u5bf9\u8c61\u521b\u5efa\u540e\uff0cMarkWord \u503c\u4e3a 0x05 \u5373\u6700\u540e 3 \u4f4d\u4e3a 101\uff0cthread\u3001epoch\u3001age \u90fd\u4e3a 0"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u504f\u5411\u9501\u662f\u9ed8\u8ba4\u662f\u5ef6\u8fdf\u7684\uff0c\u4e0d\u4f1a\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u7acb\u5373\u751f\u6548\uff0c\u5982\u679c\u60f3\u907f\u514d\u5ef6\u8fdf\uff0c\u53ef\u4ee5\u52a0 VM \u53c2\u6570 ",(0,r.jsx)(e.code,{children:"-XX:BiasedLockingStartupDelay=0"})," \u6765\u7981\u7528\u5ef6\u8fdf\u3002JDK 8 \u5ef6\u8fdf 4s \u5f00\u542f\u504f\u5411\u9501\u539f\u56e0\uff1a\u5728\u521a\u5f00\u59cb\u6267\u884c\u4ee3\u7801\u65f6\uff0c\u4f1a\u6709\u597d\u591a\u7ebf\u7a0b\u6765\u62a2\u9501\uff0c\u5982\u679c\u5f00\u504f\u5411\u9501\u6548\u7387\u53cd\u800c\u964d\u4f4e"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u4e00\u4e2a\u5bf9\u8c61\u5df2\u7ecf\u8ba1\u7b97\u8fc7 hashCode\uff0c\u5c31\u518d\u4e5f\u65e0\u6cd5\u8fdb\u5165\u504f\u5411\u72b6\u6001\u4e86"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6dfb\u52a0 VM \u53c2\u6570 ",(0,r.jsx)(e.code,{children:"-XX:-UseBiasedLocking"})," \u7981\u7528\u504f\u5411\u9501"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u64a4\u9500\u504f\u5411\u9501\u7684\u72b6\u6001\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528\u5bf9\u8c61\u7684 hashCode\uff1a\u504f\u5411\u9501\u7684\u5bf9\u8c61 MarkWord \u4e2d\u5b58\u50a8\u7684\u662f\u7ebf\u7a0b id\uff0c\u8c03\u7528 hashCode \u5bfc\u81f4\u504f\u5411\u9501\u88ab\u64a4\u9500"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53\u6709\u5176\u5b83\u7ebf\u7a0b\u4f7f\u7528\u504f\u5411\u9501\u5bf9\u8c61\u65f6\uff0c\u4f1a\u5c06\u504f\u5411\u9501\u5347\u7ea7\u4e3a\u8f7b\u91cf\u7ea7\u9501"}),"\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528 wait/notify\uff0c\u9700\u8981\u7533\u8bf7 Monitor\uff0c\u8fdb\u5165 WaitSet"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u6279\u91cf\u64a4\u9500"}),"\uff1a\u5982\u679c\u5bf9\u8c61\u88ab\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95ee\uff0c\u4f46\u6ca1\u6709\u7ade\u4e89\uff0c\u8fd9\u65f6\u504f\u5411\u4e86\u7ebf\u7a0b T1 \u7684\u5bf9\u8c61\u4ecd\u6709\u673a\u4f1a\u91cd\u65b0\u504f\u5411 T2\uff0c\u91cd\u504f\u5411\u4f1a\u91cd\u7f6e\u5bf9\u8c61\u7684 Thread ID"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6279\u91cf\u91cd\u504f\u5411\uff1a\u5f53\u64a4\u9500\u504f\u5411\u9501\u9608\u503c\u8d85\u8fc7 20 \u6b21\u540e\uff0cJVM \u4f1a\u89c9\u5f97\u662f\u4e0d\u662f\u504f\u5411\u9519\u4e86\uff0c\u4e8e\u662f\u5728\u7ed9\u8fd9\u4e9b\u5bf9\u8c61\u52a0\u9501\u65f6\u91cd\u65b0\u504f\u5411\u81f3\u52a0\u9501\u7ebf\u7a0b"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6279\u91cf\u64a4\u9500\uff1a\u5f53\u64a4\u9500\u504f\u5411\u9501\u9608\u503c\u8d85\u8fc7 40 \u6b21\u540e\uff0cJVM \u4f1a\u89c9\u5f97\u81ea\u5df1\u786e\u5b9e\u504f\u5411\u9519\u4e86\uff0c\u6839\u672c\u5c31\u4e0d\u8be5\u504f\u5411\uff0c\u4e8e\u662f\u6574\u4e2a\u7c7b\u7684\u6240\u6709\u5bf9\u8c61\u90fd\u4f1a\u53d8\u4e3a\u4e0d\u53ef\u504f\u5411\u7684\uff0c\u65b0\u5efa\u7684\u5bf9\u8c61\u4e5f\u662f\u4e0d\u53ef\u504f\u5411\u7684"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u8f7b\u91cf\u7ea7\u9501",children:"\u8f7b\u91cf\u7ea7\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e2a\u5bf9\u8c61\u6709\u591a\u4e2a\u7ebf\u7a0b\u8981\u52a0\u9501\uff0c\u4f46\u52a0\u9501\u7684\u65f6\u95f4\u662f\u9519\u5f00\u7684\uff08\u6ca1\u6709\u7ade\u4e89\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528\u8f7b\u91cf\u7ea7\u9501\u6765\u4f18\u5316\uff0c\u8f7b\u91cf\u7ea7\u9501\u5bf9\u4f7f\u7528\u8005\u662f\u900f\u660e\u7684\uff08\u4e0d\u53ef\u89c1\uff09"}),"\n",(0,r.jsxs)(e.p,{children:["\u53ef\u91cd\u5165\u9501\uff1a\u7ebf\u7a0b\u53ef\u4ee5\u8fdb\u5165\u4efb\u4f55\u4e00\u4e2a\u5b83\u5df2\u7ecf\u62e5\u6709\u7684\u9501\u6240\u540c\u6b65\u7740\u7684\u4ee3\u7801\u5757\uff0c\u53ef\u91cd\u5165\u9501\u6700\u5927\u7684\u4f5c\u7528\u662f",(0,r.jsx)(e.strong,{children:"\u907f\u514d\u6b7b\u9501"})]}),"\n",(0,r.jsx)(e.p,{children:"\u8f7b\u91cf\u7ea7\u9501\u5728\u6ca1\u6709\u7ade\u4e89\u65f6\uff08\u9501\u91cd\u5165\u65f6\uff09\uff0c\u6bcf\u6b21\u91cd\u5165\u4ecd\u7136\u9700\u8981\u6267\u884c CAS \u64cd\u4f5c\uff0cJava 6 \u624d\u5f15\u5165\u7684\u504f\u5411\u9501\u6765\u4f18\u5316"}),"\n",(0,r.jsx)(e.p,{children:"\u9501\u91cd\u5165\u5b9e\u4f8b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final Object obj = new Object();\npublic static void method1() {\n    synchronized( obj ) {\n        // \u540c\u6b65\u5757 A\n        method2();\n    }\n}\npublic static void method2() {\n    synchronized( obj ) {\n    \t// \u540c\u6b65\u5757 B\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u521b\u5efa\u9501\u8bb0\u5f55\uff08Lock Record\uff09\u5bf9\u8c61\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u7684",(0,r.jsx)(e.strong,{children:"\u6808\u5e27"}),"\u90fd\u4f1a\u5305\u542b\u4e00\u4e2a\u9501\u8bb0\u5f55\u7684\u7ed3\u6784\uff0c\u5b58\u50a8\u9501\u5b9a\u5bf9\u8c61\u7684 Mark Word"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(21309).A+"",width:"655",height:"301"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8ba9\u9501\u8bb0\u5f55\u4e2d Object reference \u6307\u5411\u9501\u4f4f\u7684\u5bf9\u8c61\uff0c\u5e76\u5c1d\u8bd5\u7528 CAS \u66ff\u6362 Object \u7684 Mark Word\uff0c\u5c06 Mark Word \u7684\u503c\u5b58\u5165\u9501\u8bb0\u5f55"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5982\u679c CAS \u66ff\u6362\u6210\u529f\uff0c\u5bf9\u8c61\u5934\u4e2d\u5b58\u50a8\u4e86\u9501\u8bb0\u5f55\u5730\u5740\u548c\u72b6\u6001 00\uff08\u8f7b\u91cf\u7ea7\u9501\uff09 \uff0c\u8868\u793a\u7531\u8be5\u7ebf\u7a0b\u7ed9\u5bf9\u8c61\u52a0\u9501\n",(0,r.jsx)(e.img,{src:l(40102).A+"",width:"702",height:"335"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c CAS \u5931\u8d25\uff0c\u6709\u4e24\u79cd\u60c5\u51b5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u662f\u5176\u5b83\u7ebf\u7a0b\u5df2\u7ecf\u6301\u6709\u4e86\u8be5 Object \u7684\u8f7b\u91cf\u7ea7\u9501\uff0c\u8fd9\u65f6\u8868\u660e\u6709\u7ade\u4e89\uff0c\u8fdb\u5165\u9501\u81a8\u80c0\u8fc7\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u662f\u7ebf\u7a0b\u81ea\u5df1\u6267\u884c\u4e86 synchronized \u9501\u91cd\u5165\uff0c\u5c31\u6dfb\u52a0\u4e00\u6761 Lock Record \u4f5c\u4e3a\u91cd\u5165\u7684\u8ba1\u6570"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(5295).A+"",width:"782",height:"373"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u9000\u51fa synchronized \u4ee3\u7801\u5757\uff08\u89e3\u9501\u65f6\uff09"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u6709\u53d6\u503c\u4e3a null \u7684\u9501\u8bb0\u5f55\uff0c\u8868\u793a\u6709\u91cd\u5165\uff0c\u8fd9\u65f6\u91cd\u7f6e\u9501\u8bb0\u5f55\uff0c\u8868\u793a\u91cd\u5165\u8ba1\u6570\u51cf 1"}),"\n",(0,r.jsxs)(e.li,{children:["\u5982\u679c\u9501\u8bb0\u5f55\u7684\u503c\u4e0d\u4e3a null\uff0c\u8fd9\u65f6\u4f7f\u7528 CAS ",(0,r.jsx)(e.strong,{children:"\u5c06 Mark Word \u7684\u503c\u6062\u590d\u7ed9\u5bf9\u8c61\u5934"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6210\u529f\uff0c\u5219\u89e3\u9501\u6210\u529f"}),"\n",(0,r.jsx)(e.li,{children:"\u5931\u8d25\uff0c\u8bf4\u660e\u8f7b\u91cf\u7ea7\u9501\u8fdb\u884c\u4e86\u9501\u81a8\u80c0\u6216\u5df2\u7ecf\u5347\u7ea7\u4e3a\u91cd\u91cf\u7ea7\u9501\uff0c\u8fdb\u5165\u91cd\u91cf\u7ea7\u9501\u89e3\u9501\u6d41\u7a0b"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u9501\u81a8\u80c0",children:"\u9501\u81a8\u80c0"}),"\n",(0,r.jsxs)(e.p,{children:["\u5728\u5c1d\u8bd5\u52a0\u8f7b\u91cf\u7ea7\u9501\u7684\u8fc7\u7a0b\u4e2d\uff0cCAS \u64cd\u4f5c\u65e0\u6cd5\u6210\u529f\uff0c\u53ef\u80fd\u662f\u5176\u5b83\u7ebf\u7a0b\u4e3a\u6b64\u5bf9\u8c61\u52a0\u4e0a\u4e86\u8f7b\u91cf\u7ea7\u9501\uff08\u6709\u7ade\u4e89\uff09\uff0c\u8fd9\u65f6\u9700\u8981\u8fdb\u884c\u9501\u81a8\u80c0\uff0c\u5c06\u8f7b\u91cf\u7ea7\u9501\u53d8\u4e3a",(0,r.jsx)(e.strong,{children:"\u91cd\u91cf\u7ea7\u9501"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53 Thread-1 \u8fdb\u884c\u8f7b\u91cf\u7ea7\u52a0\u9501\u65f6\uff0cThread-0 \u5df2\u7ecf\u5bf9\u8be5\u5bf9\u8c61\u52a0\u4e86\u8f7b\u91cf\u7ea7\u9501"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(15115).A+"",width:"859",height:"348"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Thread-1 \u52a0\u8f7b\u91cf\u7ea7\u9501\u5931\u8d25\uff0c\u8fdb\u5165\u9501\u81a8\u80c0\u6d41\u7a0b\uff1a\u4e3a Object \u5bf9\u8c61\u7533\u8bf7 Monitor \u9501\uff0c",(0,r.jsx)(e.strong,{children:"\u901a\u8fc7 Object \u5bf9\u8c61\u5934\u83b7\u53d6\u5230\u6301\u9501\u7ebf\u7a0b"}),"\uff0c\u5c06 Monitor \u7684 Owner \u7f6e\u4e3a Thread-0\uff0c\u5c06 Object \u7684\u5bf9\u8c61\u5934\u6307\u5411\u91cd\u91cf\u7ea7\u9501\u5730\u5740\uff0c\u7136\u540e\u81ea\u5df1\u8fdb\u5165 Monitor \u7684 EntryList BLOCKED"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(27472).A+"",width:"857",height:"311"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53 Thread-0 \u9000\u51fa\u540c\u6b65\u5757\u89e3\u9501\u65f6\uff0c\u4f7f\u7528 CAS \u5c06 Mark Word \u7684\u503c\u6062\u590d\u7ed9\u5bf9\u8c61\u5934\u5931\u8d25\uff0c\u8fd9\u65f6\u8fdb\u5165\u91cd\u91cf\u7ea7\u89e3\u9501\u6d41\u7a0b\uff0c\u5373\u6309\u7167 Monitor \u5730\u5740\u627e\u5230 Monitor \u5bf9\u8c61\uff0c\u8bbe\u7f6e Owner \u4e3a null\uff0c\u5524\u9192 EntryList \u4e2d BLOCKED \u7ebf\u7a0b"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u9501\u4f18\u5316",children:"\u9501\u4f18\u5316"}),"\n",(0,r.jsx)(e.h5,{id:"\u81ea\u65cb\u9501",children:"\u81ea\u65cb\u9501"}),"\n",(0,r.jsxs)(e.p,{children:["\u91cd\u91cf\u7ea7\u9501\u7ade\u4e89\u65f6\uff0c\u5c1d\u8bd5\u83b7\u53d6\u9501\u7684\u7ebf\u7a0b\u4e0d\u4f1a\u7acb\u5373\u963b\u585e\uff0c\u53ef\u4ee5\u4f7f\u7528",(0,r.jsx)(e.strong,{children:"\u81ea\u65cb"}),"\uff08\u9ed8\u8ba4 10 \u6b21\uff09\u6765\u8fdb\u884c\u4f18\u5316\uff0c\u91c7\u7528\u5faa\u73af\u7684\u65b9\u5f0f\u53bb\u5c1d\u8bd5\u83b7\u53d6\u9501"]}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u81ea\u65cb\u5360\u7528 CPU \u65f6\u95f4\uff0c\u5355\u6838 CPU \u81ea\u65cb\u5c31\u662f\u6d6a\u8d39\u65f6\u95f4\uff0c\u56e0\u4e3a\u540c\u4e00\u65f6\u523b\u53ea\u80fd\u8fd0\u884c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u591a\u6838 CPU \u81ea\u65cb\u624d\u80fd\u53d1\u6325\u4f18\u52bf"}),"\n",(0,r.jsx)(e.li,{children:"\u81ea\u65cb\u5931\u8d25\u7684\u7ebf\u7a0b\u4f1a\u8fdb\u5165\u963b\u585e\u72b6\u6001"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u4f18\u70b9\uff1a\u4e0d\u4f1a\u8fdb\u5165\u963b\u585e\u72b6\u6001\uff0c",(0,r.jsx)(e.strong,{children:"\u51cf\u5c11\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u6d88\u8017"})]}),"\n",(0,r.jsx)(e.p,{children:"\u7f3a\u70b9\uff1a\u5f53\u81ea\u65cb\u7684\u7ebf\u7a0b\u8d8a\u6765\u8d8a\u591a\u65f6\uff0c\u4f1a\u4e0d\u65ad\u7684\u6d88\u8017 CPU \u8d44\u6e90"}),"\n",(0,r.jsx)(e.p,{children:"\u81ea\u65cb\u9501\u60c5\u51b5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u81ea\u65cb\u6210\u529f\u7684\u60c5\u51b5\uff1a\n",(0,r.jsx)(e.img,{src:l(32973).A+"",width:"836",height:"500"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u81ea\u65cb\u5931\u8d25\u7684\u60c5\u51b5\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(7912).A+"",width:"852",height:"480"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u81ea\u65cb\u9501\u8bf4\u660e\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5728 Java 6 \u4e4b\u540e\u81ea\u65cb\u9501\u662f\u81ea\u9002\u5e94\u7684\uff0c\u6bd4\u5982\u5bf9\u8c61\u521a\u521a\u7684\u4e00\u6b21\u81ea\u65cb\u64cd\u4f5c\u6210\u529f\u8fc7\uff0c\u90a3\u4e48\u8ba4\u4e3a\u8fd9\u6b21\u81ea\u65cb\u6210\u529f\u7684\u53ef\u80fd\u6027\u4f1a\u9ad8\uff0c\u5c31\u591a\u81ea\u65cb\u51e0\u6b21\uff1b\u53cd\u4e4b\uff0c\u5c31\u5c11\u81ea\u65cb\u751a\u81f3\u4e0d\u81ea\u65cb\uff0c\u6bd4\u8f83\u667a\u80fd"}),"\n",(0,r.jsx)(e.li,{children:"Java 7 \u4e4b\u540e\u4e0d\u80fd\u63a7\u5236\u662f\u5426\u5f00\u542f\u81ea\u65cb\u529f\u80fd\uff0c\u7531 JVM \u63a7\u5236"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'//\u624b\u5199\u81ea\u65cb\u9501\npublic class SpinLock {\n    // \u6cdb\u578b\u88c5\u7684\u662fThread\uff0c\u539f\u5b50\u5f15\u7528\u7ebf\u7a0b\n    AtomicReference<Thread> atomicReference = new AtomicReference<>();\n\n    public void lock() {\n        Thread thread = Thread.currentThread();\n        System.out.println(thread.getName() + " come in");\n\n        //\u5f00\u59cb\u81ea\u65cb\uff0c\u671f\u671b\u503c\u4e3anull\uff0c\u66f4\u65b0\u503c\u662f\u5f53\u524d\u7ebf\u7a0b\n        while (!atomicReference.compareAndSet(null, thread)) {\n            Thread.sleep(1000);\n            System.out.println(thread.getName() + " \u6b63\u5728\u81ea\u65cb");\n        }\n        System.out.println(thread.getName() + " \u81ea\u65cb\u6210\u529f");\n    }\n\n    public void unlock() {\n        Thread thread = Thread.currentThread();\n\n        //\u7ebf\u7a0b\u4f7f\u7528\u5b8c\u9501\u628a\u5f15\u7528\u53d8\u4e3anull\n\t\tatomicReference.compareAndSet(thread, null);\n        System.out.println(thread.getName() + " invoke unlock");\n    }\n\n    public static void main(String[] args) throws InterruptedException {\n        SpinLock lock = new SpinLock();\n        new Thread(() -> {\n            //\u5360\u6709\u9501\n            lock.lock();\n            Thread.sleep(10000); \n\n            //\u91ca\u653e\u9501\n            lock.unlock();\n        },"t1").start();\n\n        // \u8ba9main\u7ebf\u7a0b\u6682\u505c1\u79d2\uff0c\u4f7f\u5f97t1\u7ebf\u7a0b\uff0c\u5148\u6267\u884c\n        Thread.sleep(1000);\n\n        new Thread(() -> {\n            lock.lock();\n            lock.unlock();\n        },"t2").start();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u9501\u6d88\u9664",children:"\u9501\u6d88\u9664"}),"\n",(0,r.jsxs)(e.p,{children:["\u9501\u6d88\u9664\u662f\u6307\u5bf9\u4e8e\u88ab\u68c0\u6d4b\u51fa\u4e0d\u53ef\u80fd\u5b58\u5728\u7ade\u4e89\u7684\u5171\u4eab\u6570\u636e\u7684\u9501\u8fdb\u884c\u6d88\u9664\uff0c\u8fd9\u662f JVM ",(0,r.jsx)(e.strong,{children:"\u5373\u65f6\u7f16\u8bd1\u5668\u7684\u4f18\u5316"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u9501\u6d88\u9664\u4e3b\u8981\u662f\u901a\u8fc7",(0,r.jsx)(e.strong,{children:"\u9003\u9038\u5206\u6790"}),"\u6765\u652f\u6301\uff0c\u5982\u679c\u5806\u4e0a\u7684\u5171\u4eab\u6570\u636e\u4e0d\u53ef\u80fd\u9003\u9038\u51fa\u53bb\u88ab\u5176\u5b83\u7ebf\u7a0b\u8bbf\u95ee\u5230\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u628a\u5b83\u4eec\u5f53\u6210\u79c1\u6709\u6570\u636e\u5bf9\u5f85\uff0c\u4e5f\u5c31\u53ef\u4ee5\u5c06\u5b83\u4eec\u7684\u9501\u8fdb\u884c\u6d88\u9664\uff08\u540c\u6b65\u6d88\u9664\uff1aJVM \u9003\u9038\u5206\u6790\uff09"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u9501\u7c97\u5316",children:"\u9501\u7c97\u5316"}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u76f8\u540c\u5bf9\u8c61\u591a\u6b21\u52a0\u9501\uff0c\u5bfc\u81f4\u7ebf\u7a0b\u53d1\u751f\u591a\u6b21\u91cd\u5165\uff0c\u9891\u7e41\u7684\u52a0\u9501\u64cd\u4f5c\u5c31\u4f1a\u5bfc\u81f4\u6027\u80fd\u635f\u8017\uff0c\u53ef\u4ee5\u4f7f\u7528\u9501\u7c97\u5316\u65b9\u5f0f\u4f18\u5316"}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u865a\u62df\u673a\u63a2\u6d4b\u5230\u4e00\u4e32\u7684\u64cd\u4f5c\u90fd\u5bf9\u540c\u4e00\u4e2a\u5bf9\u8c61\u52a0\u9501\uff0c\u5c06\u4f1a\u628a\u52a0\u9501\u7684\u8303\u56f4\u6269\u5c55\uff08\u7c97\u5316\uff09\u5230\u6574\u4e2a\u64cd\u4f5c\u5e8f\u5217\u7684\u5916\u90e8"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e9b\u770b\u8d77\u6765\u6ca1\u6709\u52a0\u9501\u7684\u4ee3\u7801\uff0c\u5176\u5b9e\u9690\u5f0f\u7684\u52a0\u4e86\u5f88\u591a\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public static String concatString(String s1, String s2, String s3) {\n    return s1 + s2 + s3;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"String \u662f\u4e00\u4e2a\u4e0d\u53ef\u53d8\u7684\u7c7b\uff0c\u7f16\u8bd1\u5668\u4f1a\u5bf9 String \u7684\u62fc\u63a5\u81ea\u52a8\u4f18\u5316\u3002\u5728 JDK 1.5 \u4e4b\u524d\uff0c\u8f6c\u5316\u4e3a StringBuffer \u5bf9\u8c61\u7684\u8fde\u7eed append() \u64cd\u4f5c\uff0c\u6bcf\u4e2a append() \u65b9\u6cd5\u4e2d\u90fd\u6709\u4e00\u4e2a\u540c\u6b65\u5757"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public static String concatString(String s1, String s2, String s3) {\n    StringBuffer sb = new StringBuffer();\n    sb.append(s1);\n    sb.append(s2);\n    sb.append(s3);\n    return sb.toString();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6269\u5c55\u5230\u7b2c\u4e00\u4e2a append() \u64cd\u4f5c\u4e4b\u524d\u76f4\u81f3\u6700\u540e\u4e00\u4e2a append() \u64cd\u4f5c\u4e4b\u540e\uff0c\u53ea\u9700\u8981\u52a0\u9501\u4e00\u6b21\u5c31\u53ef\u4ee5"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u591a\u628a\u9501",children:"\u591a\u628a\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u591a\u628a\u4e0d\u76f8\u5e72\u7684\u9501\uff1a\u4e00\u95f4\u5927\u5c4b\u5b50\u6709\u4e24\u4e2a\u529f\u80fd\u7761\u89c9\u3001\u5b66\u4e60\uff0c\u4e92\u4e0d\u76f8\u5e72\u3002\u73b0\u5728\u4e00\u4eba\u8981\u5b66\u4e60\uff0c\u4e00\u4eba\u8981\u7761\u89c9\uff0c\u5982\u679c\u53ea\u7528\u4e00\u95f4\u5c4b\u5b50\uff08\u4e00\u4e2a\u5bf9\u8c61\u9501\uff09\u7684\u8bdd\uff0c\u90a3\u4e48\u5e76\u53d1\u5ea6\u5f88\u4f4e"}),"\n",(0,r.jsx)(e.p,{children:"\u5c06\u9501\u7684\u7c92\u5ea6\u7ec6\u5206\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u597d\u5904\uff0c\u662f\u53ef\u4ee5\u589e\u5f3a\u5e76\u53d1\u5ea6"}),"\n",(0,r.jsx)(e.li,{children:"\u574f\u5904\uff0c\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u9700\u8981\u540c\u65f6\u83b7\u5f97\u591a\u628a\u9501\uff0c\u5c31\u5bb9\u6613\u53d1\u751f\u6b7b\u9501"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u89e3\u51b3\u65b9\u6cd5\uff1a\u51c6\u5907\u591a\u4e2a\u5bf9\u8c61\u9501"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    BigRoom bigRoom = new BigRoom();\n    new Thread(() -> { bigRoom.study(); }).start();\n    new Thread(() -> { bigRoom.sleep(); }).start();\n}\nclass BigRoom {\n    private final Object studyRoom = new Object();\n    private final Object sleepRoom = new Object();\n\n    public void sleep() throws InterruptedException {\n        synchronized (sleepRoom) {\n            System.out.println("sleeping 2 \u5c0f\u65f6");\n            Thread.sleep(2000);\n        }\n    }\n\n    public void study() throws InterruptedException {\n        synchronized (studyRoom) {\n            System.out.println("study 1 \u5c0f\u65f6");\n            Thread.sleep(1000);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6d3b\u8dc3\u6027",children:"\u6d3b\u8dc3\u6027"}),"\n",(0,r.jsx)(e.h5,{id:"\u6b7b\u9501",children:"\u6b7b\u9501"}),"\n",(0,r.jsx)(e.h6,{id:"\u5f62\u6210",children:"\u5f62\u6210"}),"\n",(0,r.jsx)(e.p,{children:"\u6b7b\u9501\uff1a\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u88ab\u963b\u585e\uff0c\u5b83\u4eec\u4e2d\u7684\u4e00\u4e2a\u6216\u8005\u5168\u90e8\u90fd\u5728\u7b49\u5f85\u67d0\u4e2a\u8d44\u6e90\u88ab\u91ca\u653e\uff0c\u7531\u4e8e\u7ebf\u7a0b\u88ab\u65e0\u9650\u671f\u5730\u963b\u585e\uff0c\u56e0\u6b64\u7a0b\u5e8f\u4e0d\u53ef\u80fd\u6b63\u5e38\u7ec8\u6b62"}),"\n",(0,r.jsx)(e.p,{children:"Java \u6b7b\u9501\u4ea7\u751f\u7684\u56db\u4e2a\u5fc5\u8981\u6761\u4ef6\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e92\u65a5\u6761\u4ef6\uff0c\u5373\u5f53\u8d44\u6e90\u88ab\u4e00\u4e2a\u7ebf\u7a0b\u4f7f\u7528\uff08\u5360\u6709\uff09\u65f6\uff0c\u522b\u7684\u7ebf\u7a0b\u4e0d\u80fd\u4f7f\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u4e0d\u53ef\u5265\u593a\u6761\u4ef6\uff0c\u8d44\u6e90\u8bf7\u6c42\u8005\u4e0d\u80fd\u5f3a\u5236\u4ece\u8d44\u6e90\u5360\u6709\u8005\u624b\u4e2d\u593a\u53d6\u8d44\u6e90\uff0c\u8d44\u6e90\u53ea\u80fd\u7531\u8d44\u6e90\u5360\u6709\u8005\u4e3b\u52a8\u91ca\u653e"}),"\n",(0,r.jsx)(e.li,{children:"\u8bf7\u6c42\u548c\u4fdd\u6301\u6761\u4ef6\uff0c\u5373\u5f53\u8d44\u6e90\u8bf7\u6c42\u8005\u5728\u8bf7\u6c42\u5176\u4ed6\u7684\u8d44\u6e90\u7684\u540c\u65f6\u4fdd\u6301\u5bf9\u539f\u6709\u8d44\u6e90\u7684\u5360\u6709"}),"\n",(0,r.jsx)(e.li,{children:"\u5faa\u73af\u7b49\u5f85\u6761\u4ef6\uff0c\u5373\u5b58\u5728\u4e00\u4e2a\u7b49\u5f85\u5faa\u73af\u961f\u5217\uff1ap1 \u8981 p2 \u7684\u8d44\u6e90\uff0cp2 \u8981 p1 \u7684\u8d44\u6e90\uff0c\u5f62\u6210\u4e86\u4e00\u4e2a\u7b49\u5f85\u73af\u8def"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u56db\u4e2a\u6761\u4ef6\u90fd\u6210\u7acb\u7684\u65f6\u5019\uff0c\u4fbf\u5f62\u6210\u6b7b\u9501\u3002\u6b7b\u9501\u60c5\u51b5\u4e0b\u6253\u7834\u4e0a\u8ff0\u4efb\u4f55\u4e00\u4e2a\u6761\u4ef6\uff0c\u4fbf\u53ef\u8ba9\u6b7b\u9501\u6d88\u5931"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class Dead {\n    public static Object resources1 = new Object();\n    public static Object resources2 = new Object();\n    public static void main(String[] args) {\n        new Thread(() -> {\n            // \u7ebf\u7a0b1\uff1a\u5360\u7528\u8d44\u6e901 \uff0c\u8bf7\u6c42\u8d44\u6e902\n            synchronized(resources1){\n                System.out.println("\u7ebf\u7a0b1\u5df2\u7ecf\u5360\u7528\u4e86\u8d44\u6e901\uff0c\u5f00\u59cb\u8bf7\u6c42\u8d44\u6e902");\n                Thread.sleep(2000);//\u4f11\u606f\u4e24\u79d2\uff0c\u9632\u6b62\u7ebf\u7a0b1\u76f4\u63a5\u8fd0\u884c\u5b8c\u6210\u3002\n                //2\u79d2\u5185\u7ebf\u7a0b2\u80af\u5b9a\u53ef\u4ee5\u9501\u4f4f\u8d44\u6e902\n                synchronized (resources2){\n                    System.out.println("\u7ebf\u7a0b1\u5df2\u7ecf\u5360\u7528\u4e86\u8d44\u6e902");\n                }\n        }).start();\n        new Thread(() -> {\n            // \u7ebf\u7a0b2\uff1a\u5360\u7528\u8d44\u6e902 \uff0c\u8bf7\u6c42\u8d44\u6e901\n            synchronized(resources2){\n                System.out.println("\u7ebf\u7a0b2\u5df2\u7ecf\u5360\u7528\u4e86\u8d44\u6e902\uff0c\u5f00\u59cb\u8bf7\u6c42\u8d44\u6e901");\n                Thread.sleep(2000);\n                synchronized (resources1){\n                    System.out.println("\u7ebf\u7a0b2\u5df2\u7ecf\u5360\u7528\u4e86\u8d44\u6e901");\n                }\n            }}\n        }).start();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h6,{id:"\u5b9a\u4f4d",children:"\u5b9a\u4f4d"}),"\n",(0,r.jsx)(e.p,{children:"\u5b9a\u4f4d\u6b7b\u9501\u7684\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4f7f\u7528 jps \u5b9a\u4f4d\u8fdb\u7a0b id\uff0c\u518d\u7528 ",(0,r.jsx)(e.code,{children:"jstack id"})," \u5b9a\u4f4d\u6b7b\u9501\uff0c\u627e\u5230\u6b7b\u9501\u7684\u7ebf\u7a0b\u53bb\u67e5\u770b\u6e90\u7801\uff0c\u89e3\u51b3\u4f18\u5316"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sh",children:'"Thread-1" #12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting formonitor entry [0x000000001f54f000]\n\tjava.lang.Thread.State: BLOCKED (on object monitor)\n#\u7701\u7565    \n"Thread-1" #12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting for monitor entry [0x000000001f54f000]\n\tjava.lang.Thread.State: BLOCKED (on object monitor)\n#\u7701\u7565\n\nFound one Java-level deadlock:\n===================================================\n"Thread-1":\n    waiting to lock monitor 0x000000000361d378 (object 0x000000076b5bf1c0, a java.lang.Object),\n    which is held by "Thread-0"\n"Thread-0":\n    waiting to lock monitor 0x000000000361e768 (object 0x000000076b5bf1d0, a java.lang.Object),\n    which is held by "Thread-1"\n    \nJava stack information for the threads listed above:\n===================================================\n"Thread-1":\n    at thread.TestDeadLock.lambda$main$1(TestDeadLock.java:28)\n    - waiting to lock <0x000000076b5bf1c0> (a java.lang.Object)\n    - locked <0x000000076b5bf1d0> (a java.lang.Object)\n    at thread.TestDeadLock$$Lambda$2/883049899.run(Unknown Source)\n    at java.lang.Thread.run(Thread.java:745)\n"Thread-0":\n    at thread.TestDeadLock.lambda$main$0(TestDeadLock.java:15)\n    - waiting to lock <0x000000076b5bf1d0> (a java.lang.Object)\n    - locked <0x000000076b5bf1c0> (a java.lang.Object)\n    at thread.TestDeadLock$$Lambda$1/495053715\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Linux \u4e0b\u53ef\u4ee5\u901a\u8fc7 top \u5148\u5b9a\u4f4d\u5230 CPU \u5360\u7528\u9ad8\u7684 Java \u8fdb\u7a0b\uff0c\u518d\u5229\u7528 ",(0,r.jsx)(e.code,{children:"top -Hp \u8fdb\u7a0bid"})," \u6765\u5b9a\u4f4d\u662f\u54ea\u4e2a\u7ebf\u7a0b\uff0c\u6700\u540e\u518d\u7528 jstack ",(0,r.jsx)(e.pid,{children:"\u7684\u8f93\u51fa\u6765\u770b\u5404\u4e2a\u7ebf\u7a0b\u6808"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u907f\u514d\u6b7b\u9501\uff1a\u907f\u514d\u6b7b\u9501\u8981\u6ce8\u610f\u52a0\u9501\u987a\u5e8f"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u53ef\u4ee5\u4f7f\u7528 jconsole \u5de5\u5177\uff0c\u5728 ",(0,r.jsx)(e.code,{children:"jdk\\bin"})," \u76ee\u5f55\u4e0b"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6d3b\u9501",children:"\u6d3b\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u6d3b\u9501\uff1a\u6307\u7684\u662f\u4efb\u52a1\u6216\u8005\u6267\u884c\u8005\u6ca1\u6709\u88ab\u963b\u585e\uff0c\u7531\u4e8e\u67d0\u4e9b\u6761\u4ef6\u6ca1\u6709\u6ee1\u8db3\uff0c\u5bfc\u81f4\u4e00\u76f4\u91cd\u590d\u5c1d\u8bd5\u2014\u5931\u8d25\u2014\u5c1d\u8bd5\u2014\u5931\u8d25\u7684\u8fc7\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:"\u4e24\u4e2a\u7ebf\u7a0b\u4e92\u76f8\u6539\u53d8\u5bf9\u65b9\u7684\u7ed3\u675f\u6761\u4ef6\uff0c\u6700\u540e\u8c01\u4e5f\u65e0\u6cd5\u7ed3\u675f\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'class TestLiveLock {\n    static volatile int count = 10;\n    static final Object lock = new Object();\n    public static void main(String[] args) {\n        new Thread(() -> {\n            // \u671f\u671b\u51cf\u5230 0 \u9000\u51fa\u5faa\u73af\n            while (count > 0) {\n                Thread.sleep(200);\n                count--;\n                System.out.println("\u7ebf\u7a0b\u4e00count:" + count);\n            }\n        }, "t1").start();\n        new Thread(() -> {\n            // \u671f\u671b\u8d85\u8fc7 20 \u9000\u51fa\u5faa\u73af\n            while (count < 20) {\n                Thread.sleep(200);\n                count++;\n                System.out.println("\u7ebf\u7a0b\u4e8ccount:"+ count);\n            }\n        }, "t2").start();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u9965\u997f",children:"\u9965\u997f"}),"\n",(0,r.jsx)(e.p,{children:"\u9965\u997f\uff1a\u4e00\u4e2a\u7ebf\u7a0b\u7531\u4e8e\u4f18\u5148\u7ea7\u592a\u4f4e\uff0c\u59cb\u7ec8\u5f97\u4e0d\u5230 CPU \u8c03\u5ea6\u6267\u884c\uff0c\u4e5f\u4e0d\u80fd\u591f\u7ed3\u675f"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"wait-ify",children:"wait-ify"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4f7f\u7528",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsxs)(e.p,{children:["\u9700\u8981\u83b7\u53d6\u5bf9\u8c61\u9501\u540e\u624d\u53ef\u4ee5\u8c03\u7528 ",(0,r.jsx)(e.code,{children:"\u9501\u5bf9\u8c61.wait()"}),"\uff0cnotify \u968f\u673a\u5524\u9192\u4e00\u4e2a\u7ebf\u7a0b\uff0cnotifyAll \u5524\u9192\u6240\u6709\u7ebf\u7a0b\u53bb\u7ade\u4e89 CPU"]}),"\n",(0,r.jsx)(e.p,{children:"Object \u7c7b API\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final void notify():\u5524\u9192\u6b63\u5728\u7b49\u5f85\u5bf9\u8c61\u76d1\u89c6\u5668\u7684\u5355\u4e2a\u7ebf\u7a0b\u3002\npublic final void notifyAll():\u5524\u9192\u6b63\u5728\u7b49\u5f85\u5bf9\u8c61\u76d1\u89c6\u5668\u7684\u6240\u6709\u7ebf\u7a0b\u3002\npublic final void wait():\u5bfc\u81f4\u5f53\u524d\u7ebf\u7a0b\u7b49\u5f85\uff0c\u76f4\u5230\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u8c03\u7528\u8be5\u5bf9\u8c61\u7684 notify() \u65b9\u6cd5\u6216 notifyAll()\u65b9\u6cd5\u3002\npublic final native void wait(long timeout):\u6709\u65f6\u9650\u7684\u7b49\u5f85, \u5230n\u6beb\u79d2\u540e\u7ed3\u675f\u7b49\u5f85\uff0c\u6216\u662f\u88ab\u5524\u9192\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u8bf4\u660e\uff1a",(0,r.jsx)(e.strong,{children:"wait \u662f\u6302\u8d77\u7ebf\u7a0b\uff0c\u9700\u8981\u5524\u9192\u7684\u90fd\u662f\u6302\u8d77\u64cd\u4f5c"}),"\uff0c\u963b\u585e\u7ebf\u7a0b\u53ef\u4ee5\u81ea\u5df1\u53bb\u4e89\u62a2\u9501\uff0c\u6302\u8d77\u7684\u7ebf\u7a0b\u9700\u8981\u5524\u9192\u540e\u53bb\u4e89\u62a2\u9501"]}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u6bd4 sleep()\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u539f\u7406\u4e0d\u540c\uff1asleep() \u65b9\u6cd5\u662f\u5c5e\u4e8e Thread \u7c7b\uff0c\u662f\u7ebf\u7a0b\u7528\u6765\u63a7\u5236\u81ea\u8eab\u6d41\u7a0b\u7684\uff0c\u4f7f\u6b64\u7ebf\u7a0b\u6682\u505c\u6267\u884c\u4e00\u6bb5\u65f6\u95f4\u800c\u628a\u6267\u884c\u673a\u4f1a\u8ba9\u7ed9\u5176\u4ed6\u7ebf\u7a0b\uff1bwait() \u65b9\u6cd5\u5c5e\u4e8e Object \u7c7b\uff0c\u7528\u4e8e\u7ebf\u7a0b\u95f4\u901a\u4fe1"}),"\n",(0,r.jsxs)(e.li,{children:["\u5bf9",(0,r.jsx)(e.strong,{children:"\u9501\u7684\u5904\u7406\u673a\u5236"}),"\u4e0d\u540c\uff1a\u8c03\u7528 sleep() \u65b9\u6cd5\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7ebf\u7a0b\u4e0d\u4f1a\u91ca\u653e\u5bf9\u8c61\u9501\uff0c\u5f53\u8c03\u7528 wait() \u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u7ebf\u7a0b\u4f1a\u653e\u5f03\u5bf9\u8c61\u9501\uff0c\u8fdb\u5165\u7b49\u5f85\u6b64\u5bf9\u8c61\u7684\u7b49\u5f85\u9501\u5b9a\u6c60\uff08\u4e0d\u91ca\u653e\u9501\u5176\u4ed6\u7ebf\u7a0b\u600e\u4e48\u62a2\u5360\u5230\u9501\u6267\u884c\u5524\u9192\u64cd\u4f5c\uff09\uff0c\u4f46\u662f\u90fd\u4f1a\u91ca\u653e CPU"]}),"\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u533a\u57df\u4e0d\u540c\uff1await() \u65b9\u6cd5\u5fc5\u987b\u653e\u5728**\u540c\u6b65\u63a7\u5236\u65b9\u6cd5\u548c\u540c\u6b65\u4ee3\u7801\u5757\uff08\u5148\u83b7\u53d6\u9501\uff09**\u4e2d\u4f7f\u7528\uff0csleep() \u65b9\u6cd5\u5219\u53ef\u4ee5\u653e\u5728\u4efb\u4f55\u5730\u65b9\u4f7f\u7528"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e95\u5c42\u539f\u7406\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Owner \u7ebf\u7a0b\u53d1\u73b0\u6761\u4ef6\u4e0d\u6ee1\u8db3\uff0c\u8c03\u7528 wait \u65b9\u6cd5\uff0c\u5373\u53ef\u8fdb\u5165 WaitSet \u53d8\u4e3a WAITING \u72b6\u6001"}),"\n",(0,r.jsx)(e.li,{children:"BLOCKED \u548c WAITING \u7684\u7ebf\u7a0b\u90fd\u5904\u4e8e\u963b\u585e\u72b6\u6001\uff0c\u4e0d\u5360\u7528 CPU \u65f6\u95f4\u7247"}),"\n",(0,r.jsx)(e.li,{children:"BLOCKED \u7ebf\u7a0b\u4f1a\u5728 Owner \u7ebf\u7a0b\u91ca\u653e\u9501\u65f6\u5524\u9192"}),"\n",(0,r.jsxs)(e.li,{children:["WAITING \u7ebf\u7a0b\u4f1a\u5728 Owner \u7ebf\u7a0b\u8c03\u7528 notify \u6216 notifyAll \u65f6\u5524\u9192\uff0c\u5524\u9192\u540e\u5e76\u4e0d\u610f\u5473\u8005\u7acb\u523b\u83b7\u5f97\u9501\uff0c",(0,r.jsx)(e.strong,{children:"\u9700\u8981\u8fdb\u5165 EntryList \u91cd\u65b0\u7ade\u4e89"})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(2431).A+"",width:"939",height:"386"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4ee3\u7801\u4f18\u5316",children:"\u4ee3\u7801\u4f18\u5316"}),"\n",(0,r.jsx)(e.p,{children:"\u865a\u5047\u5524\u9192\uff1anotify \u53ea\u80fd\u968f\u673a\u5524\u9192\u4e00\u4e2a WaitSet \u4e2d\u7684\u7ebf\u7a0b\uff0c\u8fd9\u65f6\u5982\u679c\u6709\u5176\u5b83\u7ebf\u7a0b\u4e5f\u5728\u7b49\u5f85\uff0c\u90a3\u4e48\u5c31\u53ef\u80fd\u5524\u9192\u4e0d\u4e86\u6b63\u786e\u7684\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:"\u89e3\u51b3\u65b9\u6cd5\uff1a\u91c7\u7528 notifyAll"}),"\n",(0,r.jsx)(e.p,{children:"notifyAll \u4ec5\u89e3\u51b3\u67d0\u4e2a\u7ebf\u7a0b\u7684\u5524\u9192\u95ee\u9898\uff0c\u4f7f\u7528 if + wait \u5224\u65ad\u4ec5\u6709\u4e00\u6b21\u673a\u4f1a\uff0c\u4e00\u65e6\u6761\u4ef6\u4e0d\u6210\u7acb\uff0c\u65e0\u6cd5\u91cd\u65b0\u5224\u65ad"}),"\n",(0,r.jsx)(e.p,{children:"\u89e3\u51b3\u65b9\u6cd5\uff1a\u7528 while + wait\uff0c\u5f53\u6761\u4ef6\u4e0d\u6210\u7acb\uff0c\u518d\u6b21 wait"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Slf4j(topic = "c.demo")\npublic class demo {\n    static final Object room = new Object();\n    static boolean hasCigarette = false;    //\u6709\u6ca1\u6709\u70df\n    static boolean hasTakeout = false;\n\n    public static void main(String[] args) throws InterruptedException {\n        new Thread(() -> {\n            synchronized (room) {\n                log.debug("\u6709\u70df\u6ca1\uff1f[{}]", hasCigarette);\n                while (!hasCigarette) {//while\u9632\u6b62\u865a\u5047\u5524\u9192\n                    log.debug("\u6ca1\u70df\uff0c\u5148\u6b47\u4f1a\uff01");\n                    try {\n                        room.wait();\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                }\n                log.debug("\u6709\u70df\u6ca1\uff1f[{}]", hasCigarette);\n                if (hasCigarette) {\n                    log.debug("\u53ef\u4ee5\u5f00\u59cb\u5e72\u6d3b\u4e86");\n                } else {\n                    log.debug("\u6ca1\u5e72\u6210\u6d3b...");\n                }\n            }\n        }, "\u5c0f\u5357").start();\n\n        new Thread(() -> {\n            synchronized (room) {\n                Thread thread = Thread.currentThread();\n                log.debug("\u5916\u5356\u9001\u5230\u6ca1\uff1f[{}]", hasTakeout);\n                if (!hasTakeout) {\n                    log.debug("\u6ca1\u5916\u5356\uff0c\u5148\u6b47\u4f1a\uff01");\n                    try {\n                        room.wait();\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                }\n                log.debug("\u5916\u5356\u9001\u5230\u6ca1\uff1f[{}]", hasTakeout);\n                if (hasTakeout) {\n                    log.debug("\u53ef\u4ee5\u5f00\u59cb\u5e72\u6d3b\u4e86");\n                } else {\n                    log.debug("\u6ca1\u5e72\u6210\u6d3b...");\n                }\n            }\n        }, "\u5c0f\u5973").start();\n\n\n        Thread.sleep(1000);\n        new Thread(() -> {\n        // \u8fd9\u91cc\u80fd\u4e0d\u80fd\u52a0 synchronized (room)\uff1f\n            synchronized (room) {\n                hasTakeout = true;\n\t\t\t\t//log.debug("\u70df\u5230\u4e86\u5662\uff01");\n                log.debug("\u5916\u5356\u5230\u4e86\u5662\uff01");\n                room.notifyAll();\n            }\n        }, "\u9001\u5916\u5356\u7684").start();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"park-un",children:"park-un"}),"\n",(0,r.jsxs)(e.p,{children:["LockSupport \u662f\u7528\u6765\u521b\u5efa\u9501\u548c\u5176\u4ed6\u540c\u6b65\u7c7b\u7684",(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u539f\u8bed"})]}),"\n",(0,r.jsx)(e.p,{children:"LockSupport \u7c7b\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"LockSupport.park()"}),"\uff1a\u6682\u505c\u5f53\u524d\u7ebf\u7a0b\uff0c\u6302\u8d77\u539f\u8bed"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"LockSupport.unpark(\u6682\u505c\u7684\u7ebf\u7a0b\u5bf9\u8c61)"}),"\uff1a\u6062\u590d\u67d0\u4e2a\u7ebf\u7a0b\u7684\u8fd0\u884c"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    Thread t1 = new Thread(() -> {\n        System.out.println("start...");\t//1\n\t\tThread.sleep(1000);// Thread.sleep(3000)\n        // \u5148 park \u518d unpark \u548c\u5148 unpark \u518d park \u6548\u679c\u4e00\u6837\uff0c\u90fd\u4f1a\u76f4\u63a5\u6062\u590d\u7ebf\u7a0b\u7684\u8fd0\u884c\n        System.out.println("park...");\t//2\n        LockSupport.park();\n        System.out.println("resume...");//4\n    },"t1");\n    t1.start();\n   \tThread.sleep(2000);\n    System.out.println("unpark...");\t//3\n    LockSupport.unpark(t1);\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"LockSupport \u51fa\u73b0\u5c31\u662f\u4e3a\u4e86\u589e\u5f3a wait & notify \u7684\u529f\u80fd\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"wait\uff0cnotify \u548c notifyAll \u5fc5\u987b\u914d\u5408 Object Monitor \u4e00\u8d77\u4f7f\u7528\uff0c\u800c park\u3001unpark \u4e0d\u9700\u8981"}),"\n",(0,r.jsxs)(e.li,{children:["park & unpark ",(0,r.jsx)(e.strong,{children:"\u4ee5\u7ebf\u7a0b\u4e3a\u5355\u4f4d"}),"\u6765\u963b\u585e\u548c\u5524\u9192\u7ebf\u7a0b\uff0c\u800c notify \u53ea\u80fd\u968f\u673a\u5524\u9192\u4e00\u4e2a\u7b49\u5f85\u7ebf\u7a0b\uff0cnotifyAll \u662f\u5524\u9192\u6240\u6709\u7b49\u5f85\u7ebf\u7a0b"]}),"\n",(0,r.jsx)(e.li,{children:"park & unpark \u53ef\u4ee5\u5148 unpark\uff0c\u800c wait & notify \u4e0d\u80fd\u5148 notify\u3002\u7c7b\u6bd4\u751f\u4ea7\u6d88\u8d39\uff0c\u5148\u6d88\u8d39\u53d1\u73b0\u6709\u4ea7\u54c1\u5c31\u6d88\u8d39\uff0c\u6ca1\u6709\u5c31\u7b49\u5f85\uff1b\u5148\u751f\u4ea7\u5c31\u76f4\u63a5\u4ea7\u751f\u5546\u54c1\uff0c\u7136\u540e\u7ebf\u7a0b\u76f4\u63a5\u6d88\u8d39"}),"\n",(0,r.jsxs)(e.li,{children:["wait \u4f1a\u91ca\u653e\u9501\u8d44\u6e90\u8fdb\u5165\u7b49\u5f85\u961f\u5217\uff0c",(0,r.jsx)(e.strong,{children:"park \u4e0d\u4f1a\u91ca\u653e\u9501\u8d44\u6e90"}),"\uff0c\u53ea\u8d1f\u8d23\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\uff0c\u4f1a\u91ca\u653e CPU"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u7406\uff1a\u7c7b\u4f3c\u751f\u4ea7\u8005\u6d88\u8d39\u8005"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u5148 park\uff1a\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53\u524d\u7ebf\u7a0b\u8c03\u7528 Unsafe.park() \u65b9\u6cd5"}),"\n",(0,r.jsx)(e.li,{children:"\u68c0\u67e5 _counter \uff0c\u672c\u60c5\u51b5\u4e3a 0\uff0c\u8fd9\u65f6\u83b7\u5f97 _mutex \u4e92\u65a5\u9501"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u8fdb\u5165 _cond \u6761\u4ef6\u53d8\u91cf\u6302\u8d77"}),"\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528 Unsafe.unpark(Thread_0) \u65b9\u6cd5\uff0c\u8bbe\u7f6e _counter \u4e3a 1"}),"\n",(0,r.jsx)(e.li,{children:"\u5524\u9192 _cond \u6761\u4ef6\u53d8\u91cf\u4e2d\u7684 Thread_0\uff0cThread_0 \u6062\u590d\u8fd0\u884c\uff0c\u8bbe\u7f6e _counter \u4e3a 0"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(65463).A+"",width:"492",height:"280"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5148 unpark\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528 Unsafe.unpark(Thread_0) \u65b9\u6cd5\uff0c\u8bbe\u7f6e _counter \u4e3a 1"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53\u524d\u7ebf\u7a0b\u8c03\u7528 Unsafe.park() \u65b9\u6cd5"}),"\n",(0,r.jsx)(e.li,{children:"\u68c0\u67e5 _counter \uff0c\u672c\u60c5\u51b5\u4e3a 1\uff0c\u8fd9\u65f6\u7ebf\u7a0b\u65e0\u9700\u6302\u8d77\uff0c\u7ee7\u7eed\u8fd0\u884c\uff0c\u8bbe\u7f6e _counter \u4e3a 0"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(64828).A+"",width:"492",height:"254"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u5b89\u5168\u5206\u6790",children:"\u5b89\u5168\u5206\u6790"}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u53d8\u91cf\u548c\u9759\u6001\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u5b83\u4eec\u6ca1\u6709\u5171\u4eab\uff0c\u5219\u7ebf\u7a0b\u5b89\u5168"}),"\n",(0,r.jsxs)(e.li,{children:["\u5982\u679c\u5b83\u4eec\u88ab\u5171\u4eab\u4e86\uff0c\u6839\u636e\u5b83\u4eec\u7684\u72b6\u6001\u662f\u5426\u80fd\u591f\u6539\u53d8\uff0c\u5206\u4e24\u79cd\u60c5\u51b5\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u53ea\u6709\u8bfb\u64cd\u4f5c\uff0c\u5219\u7ebf\u7a0b\u5b89\u5168"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u6709\u8bfb\u5199\u64cd\u4f5c\uff0c\u5219\u8fd9\u6bb5\u4ee3\u7801\u662f\u4e34\u754c\u533a\uff0c\u9700\u8981\u8003\u8651\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5c40\u90e8\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5c40\u90e8\u53d8\u91cf\u662f\u7ebf\u7a0b\u5b89\u5168\u7684"}),"\n",(0,r.jsxs)(e.li,{children:["\u5c40\u90e8\u53d8\u91cf\u5f15\u7528\u7684\u5bf9\u8c61\u4e0d\u4e00\u5b9a\u7ebf\u7a0b\u5b89\u5168\uff08\u9003\u9038\u5206\u6790\uff09\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u8be5\u5bf9\u8c61\u6ca1\u6709\u9003\u79bb\u65b9\u6cd5\u7684\u4f5c\u7528\u8bbf\u95ee\uff0c\u5b83\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff08\u6bcf\u4e00\u4e2a\u65b9\u6cd5\u6709\u4e00\u4e2a\u6808\u5e27\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u8be5\u5bf9\u8c61\u9003\u79bb\u65b9\u6cd5\u7684\u4f5c\u7528\u8303\u56f4\uff0c\u9700\u8981\u8003\u8651\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898\uff08\u66b4\u9732\u5f15\u7528\uff09"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u89c1\u7ebf\u7a0b\u5b89\u5168\u7c7b\uff1aString\u3001Integer\u3001StringBuffer\u3001Random\u3001Vector\u3001Hashtable\u3001java.util.concurrent \u5305"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u5b89\u5168\u7684\u662f\u6307\uff0c\u591a\u4e2a\u7ebf\u7a0b\u8c03\u7528\u5b83\u4eec\u540c\u4e00\u4e2a\u5b9e\u4f8b\u7684\u67d0\u4e2a\u65b9\u6cd5\u65f6\uff0c\u662f\u7ebf\u7a0b\u5b89\u5168\u7684"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u6bcf\u4e2a\u65b9\u6cd5\u662f\u539f\u5b50\u7684\uff0c\u4f46\u591a\u4e2a\u65b9\u6cd5\u7684\u7ec4\u5408\u4e0d\u662f\u539f\u5b50\u7684"}),"\uff0c\u53ea\u80fd\u4fdd\u8bc1\u8c03\u7528\u7684\u65b9\u6cd5\u5185\u90e8\u5b89\u5168\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'Hashtable table = new Hashtable();\n// \u7ebf\u7a0b1\uff0c\u7ebf\u7a0b2\nif(table.get("key") == null) {\n\ttable.put("key", value);\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u65e0\u72b6\u6001\u7c7b\u7ebf\u7a0b\u5b89\u5168\uff0c\u5c31\u662f\u6ca1\u6709\u6210\u5458\u53d8\u91cf\u7684\u7c7b"}),"\n",(0,r.jsxs)(e.p,{children:["\u4e0d\u53ef\u53d8\u7c7b\u7ebf\u7a0b\u5b89\u5168\uff1aString\u3001Integer \u7b49\u90fd\u662f\u4e0d\u53ef\u53d8\u7c7b\uff0c",(0,r.jsx)(e.strong,{children:"\u5185\u90e8\u7684\u72b6\u6001\u4e0d\u53ef\u4ee5\u6539\u53d8"}),"\uff0c\u6240\u4ee5\u65b9\u6cd5\u662f\u7ebf\u7a0b\u5b89\u5168"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"replace \u7b49\u65b9\u6cd5\u5e95\u5c42\u662f\u65b0\u5efa\u4e00\u4e2a\u5bf9\u8c61\uff0c\u590d\u5236\u8fc7\u53bb"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'Map<String,Object> map = new HashMap<>();\t// \u7ebf\u7a0b\u4e0d\u5b89\u5168\nString S1 = "...";\t\t\t\t\t\t\t// \u7ebf\u7a0b\u5b89\u5168\nfinal String S2 = "...";\t\t\t\t\t// \u7ebf\u7a0b\u5b89\u5168\nDate D1 = new Date();\t\t\t\t\t\t// \u7ebf\u7a0b\u4e0d\u5b89\u5168\nfinal Date D2 = new Date();\t\t\t\t\t// \u7ebf\u7a0b\u4e0d\u5b89\u5168\uff0cfinal\u8ba9D2\u5f15\u7528\u7684\u5bf9\u8c61\u4e0d\u80fd\u53d8\uff0c\u4f46\u5bf9\u8c61\u7684\u5185\u5bb9\u53ef\u4ee5\u53d8\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u62bd\u8c61\u65b9\u6cd5\u5982\u679c\u6709\u53c2\u6570\uff0c\u88ab\u91cd\u5199\u540e\u884c\u4e3a\u4e0d\u786e\u5b9a\u53ef\u80fd\u9020\u6210\u7ebf\u7a0b\u4e0d\u5b89\u5168\uff0c\u88ab\u79f0\u4e4b\u4e3a\u5916\u661f\u65b9\u6cd5\uff1a",(0,r.jsx)(e.code,{children:"public abstract foo(Student s);"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u540c\u6b65\u6a21\u5f0f",children:"\u540c\u6b65\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.h4,{id:"\u4fdd\u62a4\u6027\u6682\u505c",children:"\u4fdd\u62a4\u6027\u6682\u505c"}),"\n",(0,r.jsx)(e.h5,{id:"\u5355\u4efb\u52a1\u7248",children:"\u5355\u4efb\u52a1\u7248"}),"\n",(0,r.jsx)(e.p,{children:"Guarded Suspension\uff0c\u7528\u5728\u4e00\u4e2a\u7ebf\u7a0b\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u7684\u6267\u884c\u7ed3\u679c"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6709\u4e00\u4e2a\u7ed3\u679c\u9700\u8981\u4ece\u4e00\u4e2a\u7ebf\u7a0b\u4f20\u9012\u5230\u53e6\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u8ba9\u5b83\u4eec\u5173\u8054\u540c\u4e00\u4e2a GuardedObject"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u6709\u7ed3\u679c\u4e0d\u65ad\u4ece\u4e00\u4e2a\u7ebf\u7a0b\u5230\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u6d88\u606f\u961f\u5217\uff08\u89c1\u751f\u4ea7\u8005/\u6d88\u8d39\u8005\uff09"}),"\n",(0,r.jsx)(e.li,{children:"JDK \u4e2d\uff0cjoin \u7684\u5b9e\u73b0\u3001Future \u7684\u5b9e\u73b0\uff0c\u91c7\u7528\u7684\u5c31\u662f\u6b64\u6a21\u5f0f"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(74427).A+"",width:"972",height:"354"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    GuardedObject object = new GuardedObjectV2();\n    new Thread(() -> {\n        sleep(1);\n        object.complete(Arrays.asList("a", "b", "c"));\n    }).start();\n    \n    Object response = object.get(2500);\n    if (response != null) {\n        log.debug("get response: [{}] lines", ((List<String>) response).size());\n    } else {\n        log.debug("can\'t get response");\n    }\n}\n\nclass GuardedObject {\n    private Object response;\n    private final Object lock = new Object();\n\n    //\u83b7\u53d6\u7ed3\u679c\n    //timeout :\u6700\u5927\u7b49\u5f85\u65f6\u95f4\n    public Object get(long millis) {\n        synchronized (lock) {\n            // 1) \u8bb0\u5f55\u6700\u521d\u65f6\u95f4\n            long begin = System.currentTimeMillis();\n            // 2) \u5df2\u7ecf\u7ecf\u5386\u7684\u65f6\u95f4\n            long timePassed = 0;\n            while (response == null) {\n                // 4) \u5047\u8bbe millis \u662f 1000\uff0c\u7ed3\u679c\u5728 400 \u65f6\u5524\u9192\u4e86\uff0c\u90a3\u4e48\u8fd8\u6709 600 \u8981\u7b49\n                long waitTime = millis - timePassed;\n                log.debug("waitTime: {}", waitTime);\n                //\u7ecf\u5386\u65f6\u95f4\u8d85\u8fc7\u6700\u5927\u7b49\u5f85\u65f6\u95f4\u9000\u51fa\u5faa\u73af\n                if (waitTime <= 0) {\n                    log.debug("break...");\n                    break;\n                }\n                try {\n                    lock.wait(waitTime);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                // 3) \u5982\u679c\u63d0\u524d\u88ab\u5524\u9192\uff0c\u8fd9\u65f6\u5df2\u7ecf\u7ecf\u5386\u7684\u65f6\u95f4\u5047\u8bbe\u4e3a 400\n                timePassed = System.currentTimeMillis() - begin;\n                log.debug("timePassed: {}, object is null {}",\n                        timePassed, response == null);\n            }\n            return response;\n        }\n    }\n\n    //\u4ea7\u751f\u7ed3\u679c\n    public void complete(Object response) {\n        synchronized (lock) {\n            // \u6761\u4ef6\u6ee1\u8db3\uff0c\u901a\u77e5\u7b49\u5f85\u7ebf\u7a0b\n            this.response = response;\n            log.debug("notify...");\n            lock.notifyAll();\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h5,{id:"\u591a\u4efb\u52a1\u7248",children:"\u591a\u4efb\u52a1\u7248"}),"\n",(0,r.jsx)(e.p,{children:"\u591a\u4efb\u52a1\u7248\u4fdd\u62a4\u6027\u6682\u505c\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(66633).A+"",width:"973",height:"401"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws InterruptedException {\n    for (int i = 0; i < 3; i++) {\n        new People().start();\n    }\n    Thread.sleep(1000);\n    for (Integer id : Mailboxes.getIds()) {\n        new Postman(id, id + "\u53f7\u5feb\u9012\u5230\u4e86").start();\n    }\n}\n\n@Slf4j(topic = "c.People")\nclass People extends Thread{\n    @Override\n    public void run() {\n        // \u6536\u4fe1\n        GuardedObject guardedObject = Mailboxes.createGuardedObject();\n        log.debug("\u5f00\u59cb\u6536\u4fe1i d:{}", guardedObject.getId());\n        Object mail = guardedObject.get(5000);\n        log.debug("\u6536\u5230\u4fe1id:{}\uff0c\u5185\u5bb9:{}", guardedObject.getId(),mail);\n    }\n}\n\nclass Postman extends Thread{\n    private int id;\n    private String mail;\n    //\u6784\u9020\u65b9\u6cd5\n    @Override\n    public void run() {\n        GuardedObject guardedObject = Mailboxes.getGuardedObject(id);\n        log.debug("\u5f00\u59cb\u9001\u4fe1i d:{}\uff0c\u5185\u5bb9:{}", guardedObject.getId(),mail);\n        guardedObject.complete(mail);\n    }\n}\n\nclass  Mailboxes {\n    private static Map<Integer, GuardedObject> boxes = new Hashtable<>();\n    private static int id = 1;\n\n    //\u4ea7\u751f\u552f\u4e00\u7684id\n    private static synchronized int generateId() {\n        return id++;\n    }\n\n    public static GuardedObject getGuardedObject(int id) {\n        return boxes.remove(id);\n    }\n\n    public static GuardedObject createGuardedObject() {\n        GuardedObject go = new GuardedObject(generateId());\n        boxes.put(go.getId(), go);\n        return go;\n    }\n\n    public static Set<Integer> getIds() {\n        return boxes.keySet();\n    }\n}\nclass GuardedObject {\n    //\u6807\u8bc6\uff0cGuarded Object\n    private int id;//\u6dfb\u52a0get set\u65b9\u6cd5\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u987a\u5e8f\u8f93\u51fa",children:"\u987a\u5e8f\u8f93\u51fa"}),"\n",(0,r.jsx)(e.p,{children:"\u987a\u5e8f\u8f93\u51fa 2  1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws InterruptedException {\n    Thread t1 = new Thread(() -> {\n        while (true) {\n            //try { Thread.sleep(1000); } catch (InterruptedException e) { }\n            // \u5f53\u6ca1\u6709\u8bb8\u53ef\u65f6\uff0c\u5f53\u524d\u7ebf\u7a0b\u6682\u505c\u8fd0\u884c\uff1b\u6709\u8bb8\u53ef\u65f6\uff0c\u7528\u6389\u8fd9\u4e2a\u8bb8\u53ef\uff0c\u5f53\u524d\u7ebf\u7a0b\u6062\u590d\u8fd0\u884c\n            LockSupport.park();\n            System.out.println("1");\n        }\n    });\n    Thread t2 = new Thread(() -> {\n        while (true) {\n            System.out.println("2");\n            // \u7ed9\u7ebf\u7a0b t1 \u53d1\u653e\u300e\u8bb8\u53ef\u300f\uff08\u591a\u6b21\u8fde\u7eed\u8c03\u7528 unpark \u53ea\u4f1a\u53d1\u653e\u4e00\u4e2a\u300e\u8bb8\u53ef\u300f\uff09\n            LockSupport.unpark(t1);\n            try { Thread.sleep(500); } catch (InterruptedException e) { }\n        }\n    });\n    t1.start();\n    t2.start();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4ea4\u66ff\u8f93\u51fa",children:"\u4ea4\u66ff\u8f93\u51fa"}),"\n",(0,r.jsx)(e.p,{children:"\u8fde\u7eed\u8f93\u51fa 5 \u6b21 abc"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class day2_14 {\n    public static void main(String[] args) throws InterruptedException {\n        AwaitSignal awaitSignal = new AwaitSignal(5);\n        Condition a = awaitSignal.newCondition();\n        Condition b = awaitSignal.newCondition();\n        Condition c = awaitSignal.newCondition();\n        new Thread(() -> {\n            awaitSignal.print("a", a, b);\n        }).start();\n        new Thread(() -> {\n            awaitSignal.print("b", b, c);\n        }).start();\n        new Thread(() -> {\n            awaitSignal.print("c", c, a);\n        }).start();\n\n        Thread.sleep(1000);\n        awaitSignal.lock();\n        try {\n            a.signal();\n        } finally {\n            awaitSignal.unlock();\n        }\n    }\n}\n\nclass AwaitSignal extends ReentrantLock {\n    private int loopNumber;\n\n    public AwaitSignal(int loopNumber) {\n        this.loopNumber = loopNumber;\n    }\n    //\u53c2\u65701\uff1a\u6253\u5370\u5185\u5bb9  \u53c2\u6570\u4e8c\uff1a\u6761\u4ef6\u53d8\u91cf  \u53c2\u6570\u4e8c\uff1a\u5524\u9192\u4e0b\u4e00\u4e2a\n    public void print(String str, Condition condition, Condition next) {\n        for (int i = 0; i < loopNumber; i++) {\n            lock();\n            try {\n                condition.await();\n                System.out.print(str);\n                next.signal();\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            } finally {\n                unlock();\n            }\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u5f02\u6b65\u6a21\u5f0f",children:"\u5f02\u6b65\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.h4,{id:"\u4f20\u7edf\u7248",children:"\u4f20\u7edf\u7248"}),"\n",(0,r.jsx)(e.p,{children:"\u5f02\u6b65\u6a21\u5f0f\u4e4b\u751f\u4ea7\u8005/\u6d88\u8d39\u8005\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'class ShareData {\n    private int number = 0;\n    private Lock lock = new ReentrantLock();\n    private Condition condition = lock.newCondition();\n\n    public void increment() throws Exception{\n        // \u540c\u6b65\u4ee3\u7801\u5757\uff0c\u52a0\u9501\n        lock.lock();\n        try {\n            // \u5224\u65ad  \u9632\u6b62\u865a\u5047\u5524\u9192\n            while(number != 0) {\n                // \u7b49\u5f85\u4e0d\u80fd\u751f\u4ea7\n                condition.await();\n            }\n            // \u5e72\u6d3b\n            number++;\n            System.out.println(Thread.currentThread().getName() + "\\t " + number);\n            // \u901a\u77e5 \u5524\u9192\n            condition.signalAll();\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            lock.unlock();\n        }\n    }\n\n    public void decrement() throws Exception{\n        // \u540c\u6b65\u4ee3\u7801\u5757\uff0c\u52a0\u9501\n        lock.lock();\n        try {\n            // \u5224\u65ad \u9632\u6b62\u865a\u5047\u5524\u9192\n            while(number == 0) {\n                // \u7b49\u5f85\u4e0d\u80fd\u6d88\u8d39\n                condition.await();\n            }\n            // \u5e72\u6d3b\n            number--;\n            System.out.println(Thread.currentThread().getName() + "\\t " + number);\n            // \u901a\u77e5 \u5524\u9192\n            condition.signalAll();\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            lock.unlock();\n        }\n    }\n}\n\npublic class TraditionalProducerConsumer {\n\tpublic static void main(String[] args) {\n        ShareData shareData = new ShareData();\n        // t1\u7ebf\u7a0b\uff0c\u751f\u4ea7\n        new Thread(() -> {\n            for (int i = 0; i < 5; i++) {\n            \tshareData.increment();\n            }\n        }, "t1").start();\n\n        // t2\u7ebf\u7a0b\uff0c\u6d88\u8d39\n        new Thread(() -> {\n            for (int i = 0; i < 5; i++) {\n\t\t\t\tshareData.decrement();\n            }\n        }, "t2").start(); \n    }\n}\n'})}),"\n",(0,r.jsx)(e.h4,{id:"\u6539\u8fdb\u7248",children:"\u6539\u8fdb\u7248"}),"\n",(0,r.jsx)(e.p,{children:"\u5f02\u6b65\u6a21\u5f0f\u4e4b\u751f\u4ea7\u8005/\u6d88\u8d39\u8005\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6d88\u8d39\u961f\u5217\u53ef\u4ee5\u7528\u6765\u5e73\u8861\u751f\u4ea7\u548c\u6d88\u8d39\u7684\u7ebf\u7a0b\u8d44\u6e90\uff0c\u4e0d\u9700\u8981\u4ea7\u751f\u7ed3\u679c\u548c\u6d88\u8d39\u7ed3\u679c\u7684\u7ebf\u7a0b\u4e00\u4e00\u5bf9\u5e94"}),"\n",(0,r.jsx)(e.li,{children:"\u751f\u4ea7\u8005\u4ec5\u8d1f\u8d23\u4ea7\u751f\u7ed3\u679c\u6570\u636e\uff0c\u4e0d\u5173\u5fc3\u6570\u636e\u8be5\u5982\u4f55\u5904\u7406\uff0c\u800c\u6d88\u8d39\u8005\u4e13\u5fc3\u5904\u7406\u7ed3\u679c\u6570\u636e"}),"\n",(0,r.jsx)(e.li,{children:"\u6d88\u606f\u961f\u5217\u662f\u6709\u5bb9\u91cf\u9650\u5236\u7684\uff0c\u6ee1\u65f6\u4e0d\u4f1a\u518d\u52a0\u5165\u6570\u636e\uff0c\u7a7a\u65f6\u4e0d\u4f1a\u518d\u6d88\u8017\u6570\u636e"}),"\n",(0,r.jsx)(e.li,{children:"JDK \u4e2d\u5404\u79cd\u963b\u585e\u961f\u5217\uff0c\u91c7\u7528\u7684\u5c31\u662f\u8fd9\u79cd\u6a21\u5f0f"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(42624).A+"",width:"973",height:"241"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class demo {\n    public static void main(String[] args) {\n        MessageQueue queue = new MessageQueue(2);\n        for (int i = 0; i < 3; i++) {\n            int id = i;\n            new Thread(() -> {\n                queue.put(new Message(id,"\u503c"+id));\n            }, "\u751f\u4ea7\u8005" + i).start();\n        }\n        \n        new Thread(() -> {\n            while (true) {\n                try {\n                    Thread.sleep(1000);\n                    Message message = queue.take();\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n        },"\u6d88\u8d39\u8005").start();\n    }\n}\n\n//\u6d88\u606f\u961f\u5217\u7c7b\uff0cJava\u95f4\u7ebf\u7a0b\u4e4b\u95f4\u901a\u4fe1\nclass MessageQueue {\n    private LinkedList<Message> list = new LinkedList<>();//\u6d88\u606f\u7684\u961f\u5217\u96c6\u5408\n    private int capacity;//\u961f\u5217\u5bb9\u91cf\n    public MessageQueue(int capacity) {\n        this.capacity = capacity;\n    }\n\n    //\u83b7\u53d6\u6d88\u606f\n    public Message take() {\n        //\u68c0\u67e5\u961f\u5217\u662f\u5426\u4e3a\u7a7a\n        synchronized (list) {\n            while (list.isEmpty()) {\n                try {\n                    sout(Thread.currentThread().getName() + ":\u961f\u5217\u4e3a\u7a7a\uff0c\u6d88\u8d39\u8005\u7ebf\u7a0b\u7b49\u5f85");\n                    list.wait();\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n            //\u4ece\u961f\u5217\u7684\u5934\u90e8\u83b7\u53d6\u6d88\u606f\u8fd4\u56de\n            Message message = list.removeFirst();\n            sout(Thread.currentThread().getName() + "\uff1a\u5df2\u6d88\u8d39\u6d88\u606f--" + message);\n            list.notifyAll();\n            return message;\n        }\n    }\n\n    //\u5b58\u5165\u6d88\u606f\n    public void put(Message message) {\n        synchronized (list) {\n            //\u68c0\u67e5\u961f\u5217\u662f\u5426\u6ee1\n            while (list.size() == capacity) {\n                try {\n                    sout(Thread.currentThread().getName()+":\u961f\u5217\u4e3a\u5df2\u6ee1\uff0c\u751f\u4ea7\u8005\u7ebf\u7a0b\u7b49\u5f85");\n                    list.wait();\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n            //\u5c06\u6d88\u606f\u52a0\u5165\u961f\u5217\u5c3e\u90e8\n            list.addLast(message);\n            sout(Thread.currentThread().getName() + ":\u5df2\u751f\u4ea7\u6d88\u606f--" + message);\n            list.notifyAll();\n        }\n    }\n}\n\nfinal class Message {\n    private int id;\n    private Object value;\n\t//get set\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u963b\u585e\u961f\u5217",children:"\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ExecutorService consumer = Executors.newFixedThreadPool(1);\n    ExecutorService producer = Executors.newFixedThreadPool(1);\n    BlockingQueue<Integer> queue = new SynchronousQueue<>();\n    producer.submit(() -> {\n        try {\n            System.out.println("\u751f\u4ea7...");\n            Thread.sleep(1000);\n            queue.put(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    });\n    consumer.submit(() -> {\n        try {\n            System.out.println("\u7b49\u5f85\u6d88\u8d39...");\n            Integer result = queue.take();\n            System.out.println("\u7ed3\u679c\u4e3a:" + result);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    });\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u5185\u5b58",children:"\u5185\u5b58"}),"\n",(0,r.jsx)(e.h3,{id:"jmm",children:"JMM"}),"\n",(0,r.jsx)(e.h4,{id:"\u5185\u5b58\u6a21\u578b",children:"\u5185\u5b58\u6a21\u578b"}),"\n",(0,r.jsxs)(e.p,{children:["Java \u5185\u5b58\u6a21\u578b\u662f Java Memory Model\uff08JMM\uff09\uff0c\u672c\u8eab\u662f\u4e00\u79cd",(0,r.jsx)(e.strong,{children:"\u62bd\u8c61\u7684\u6982\u5ff5"}),"\uff0c\u5b9e\u9645\u4e0a\u5e76\u4e0d\u5b58\u5728\uff0c\u63cf\u8ff0\u7684\u662f\u4e00\u7ec4\u89c4\u5219\u6216\u89c4\u8303\uff0c\u901a\u8fc7\u8fd9\u7ec4\u89c4\u8303\u5b9a\u4e49\u4e86\u7a0b\u5e8f\u4e2d\u5404\u4e2a\u53d8\u91cf\uff08\u5305\u62ec\u5b9e\u4f8b\u5b57\u6bb5\uff0c\u9759\u6001\u5b57\u6bb5\u548c\u6784\u6210\u6570\u7ec4\u5bf9\u8c61\u7684\u5143\u7d20\uff09\u7684\u8bbf\u95ee\u65b9\u5f0f"]}),"\n",(0,r.jsx)(e.p,{children:"JMM \u4f5c\u7528\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5c4f\u853d\u5404\u79cd\u786c\u4ef6\u548c\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u5b58\u8bbf\u95ee\u5dee\u5f02\uff0c\u5b9e\u73b0\u8ba9 Java \u7a0b\u5e8f\u5728\u5404\u79cd\u5e73\u53f0\u4e0b\u90fd\u80fd\u8fbe\u5230\u4e00\u81f4\u7684\u5185\u5b58\u8bbf\u95ee\u6548\u679c"}),"\n",(0,r.jsx)(e.li,{children:"\u89c4\u5b9a\u4e86\u7ebf\u7a0b\u548c\u5185\u5b58\u4e4b\u95f4\u7684\u4e00\u4e9b\u5173\u7cfb"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u6839\u636e JMM \u7684\u8bbe\u8ba1\uff0c\u7cfb\u7edf\u5b58\u5728\u4e00\u4e2a\u4e3b\u5185\u5b58\uff08Main Memory\uff09\uff0cJava \u4e2d\u6240\u6709\u53d8\u91cf\u90fd\u5b58\u50a8\u5728\u4e3b\u5b58\u4e2d\uff0c\u5bf9\u4e8e\u6240\u6709\u7ebf\u7a0b\u90fd\u662f\u5171\u4eab\u7684\uff1b\u6bcf\u6761\u7ebf\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u5de5\u4f5c\u5185\u5b58\uff08Working Memory\uff09\uff0c\u5de5\u4f5c\u5185\u5b58\u4e2d\u4fdd\u5b58\u7684\u662f\u4e3b\u5b58\u4e2d\u67d0\u4e9b",(0,r.jsx)(e.strong,{children:"\u53d8\u91cf\u7684\u62f7\u8d1d"}),"\uff0c\u7ebf\u7a0b\u5bf9\u6240\u6709\u53d8\u91cf\u7684\u64cd\u4f5c\u90fd\u662f\u5148\u5bf9\u53d8\u91cf\u8fdb\u884c\u62f7\u8d1d\uff0c\u7136\u540e\u5728\u5de5\u4f5c\u5185\u5b58\u4e2d\u8fdb\u884c\uff0c\u4e0d\u80fd\u76f4\u63a5\u64cd\u4f5c\u4e3b\u5185\u5b58\u4e2d\u7684\u53d8\u91cf\uff1b\u7ebf\u7a0b\u4e4b\u95f4\u65e0\u6cd5\u76f8\u4e92\u76f4\u63a5\u8bbf\u95ee\uff0c\u7ebf\u7a0b\u95f4\u7684\u901a\u4fe1\uff08\u4f20\u9012\uff09\u5fc5\u987b\u901a\u8fc7\u4e3b\u5185\u5b58\u6765\u5b8c\u6210"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(65265).A+"",width:"423",height:"377"})}),"\n",(0,r.jsx)(e.p,{children:"\u4e3b\u5185\u5b58\u548c\u5de5\u4f5c\u5185\u5b58\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e3b\u5185\u5b58\uff1a\u8ba1\u7b97\u673a\u7684\u5185\u5b58\uff0c\u4e5f\u5c31\u662f\u7ecf\u5e38\u63d0\u5230\u7684 8G \u5185\u5b58\uff0c16G \u5185\u5b58\uff0c\u5b58\u50a8\u6240\u6709\u5171\u4eab\u53d8\u91cf\u7684\u503c"}),"\n",(0,r.jsx)(e.li,{children:"\u5de5\u4f5c\u5185\u5b58\uff1a\u5b58\u50a8\u8be5\u7ebf\u7a0b\u4f7f\u7528\u5230\u7684\u5171\u4eab\u53d8\u91cf\u5728\u4e3b\u5185\u5b58\u7684\u7684\u503c\u7684\u526f\u672c\u62f7\u8d1d"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"JVM \u548c JMM \u4e4b\u95f4\u7684\u5173\u7cfb"}),"\uff1aJMM \u4e2d\u7684\u4e3b\u5185\u5b58\u3001\u5de5\u4f5c\u5185\u5b58\u4e0e JVM \u4e2d\u7684 Java \u5806\u3001\u6808\u3001\u65b9\u6cd5\u533a\u7b49\u5e76\u4e0d\u662f\u540c\u4e00\u4e2a\u5c42\u6b21\u7684\u5185\u5b58\u5212\u5206\uff0c\u8fd9\u4e24\u8005\u57fa\u672c\u4e0a\u662f\u6ca1\u6709\u5173\u7cfb\u7684\uff0c\u5982\u679c\u4e24\u8005\u4e00\u5b9a\u8981\u52c9\u5f3a\u5bf9\u5e94\u8d77\u6765\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e3b\u5185\u5b58\u4e3b\u8981\u5bf9\u5e94\u4e8e Java \u5806\u4e2d\u7684\u5bf9\u8c61\u5b9e\u4f8b\u6570\u636e\u90e8\u5206\uff0c\u800c\u5de5\u4f5c\u5185\u5b58\u5219\u5bf9\u5e94\u4e8e\u865a\u62df\u673a\u6808\u4e2d\u7684\u90e8\u5206\u533a\u57df"}),"\n",(0,r.jsx)(e.li,{children:"\u4ece\u66f4\u4f4e\u5c42\u6b21\u4e0a\u8bf4\uff0c\u4e3b\u5185\u5b58\u76f4\u63a5\u5bf9\u5e94\u4e8e\u7269\u7406\u786c\u4ef6\u7684\u5185\u5b58\uff0c\u5de5\u4f5c\u5185\u5b58\u5bf9\u5e94\u5bc4\u5b58\u5668\u548c\u9ad8\u901f\u7f13\u5b58"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5185\u5b58\u4ea4\u4e92",children:"\u5185\u5b58\u4ea4\u4e92"}),"\n",(0,r.jsxs)(e.p,{children:["Java \u5185\u5b58\u6a21\u578b\u5b9a\u4e49\u4e86 8 \u4e2a\u64cd\u4f5c\u6765\u5b8c\u6210\u4e3b\u5185\u5b58\u548c\u5de5\u4f5c\u5185\u5b58\u7684\u4ea4\u4e92\u64cd\u4f5c\uff0c\u6bcf\u4e2a\u64cd\u4f5c\u90fd\u662f",(0,r.jsx)(e.strong,{children:"\u539f\u5b50"}),"\u7684"]}),"\n",(0,r.jsx)(e.p,{children:"\u975e\u539f\u5b50\u534f\u5b9a\uff1a\u6ca1\u6709\u88ab volatile \u4fee\u9970\u7684 long\u3001double \u5916\uff0c\u9ed8\u8ba4\u6309\u7167\u4e24\u6b21 32 \u4f4d\u7684\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(27500).A+"",width:"741",height:"224"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"lock\uff1a\u4f5c\u7528\u4e8e\u4e3b\u5185\u5b58\uff0c\u5c06\u4e00\u4e2a\u53d8\u91cf\u6807\u8bc6\u4e3a\u88ab\u4e00\u4e2a\u7ebf\u7a0b\u72ec\u5360\u72b6\u6001\uff08\u5bf9\u5e94 monitorenter\uff09"}),"\n",(0,r.jsx)(e.li,{children:"unclock\uff1a\u4f5c\u7528\u4e8e\u4e3b\u5185\u5b58\uff0c\u5c06\u4e00\u4e2a\u53d8\u91cf\u4ece\u72ec\u5360\u72b6\u6001\u91ca\u653e\u51fa\u6765\uff0c\u91ca\u653e\u540e\u7684\u53d8\u91cf\u624d\u53ef\u4ee5\u88ab\u5176\u4ed6\u7ebf\u7a0b\u9501\u5b9a\uff08\u5bf9\u5e94 monitorexit\uff09"}),"\n",(0,r.jsx)(e.li,{children:"read\uff1a\u4f5c\u7528\u4e8e\u4e3b\u5185\u5b58\uff0c\u628a\u4e00\u4e2a\u53d8\u91cf\u7684\u503c\u4ece\u4e3b\u5185\u5b58\u4f20\u8f93\u5230\u5de5\u4f5c\u5185\u5b58\u4e2d"}),"\n",(0,r.jsx)(e.li,{children:"load\uff1a\u4f5c\u7528\u4e8e\u5de5\u4f5c\u5185\u5b58\uff0c\u5728 read \u4e4b\u540e\u6267\u884c\uff0c\u628a read \u5f97\u5230\u7684\u503c\u653e\u5165\u5de5\u4f5c\u5185\u5b58\u7684\u53d8\u91cf\u526f\u672c\u4e2d"}),"\n",(0,r.jsxs)(e.li,{children:["use\uff1a\u4f5c\u7528\u4e8e\u5de5\u4f5c\u5185\u5b58\uff0c\u628a\u5de5\u4f5c\u5185\u5b58\u4e2d\u4e00\u4e2a\u53d8\u91cf\u7684\u503c\u4f20\u9012\u7ed9",(0,r.jsx)(e.strong,{children:"\u6267\u884c\u5f15\u64ce"}),"\uff0c\u6bcf\u5f53\u9047\u5230\u4e00\u4e2a\u4f7f\u7528\u5230\u53d8\u91cf\u7684\u64cd\u4f5c\u65f6\u90fd\u8981\u4f7f\u7528\u8be5\u6307\u4ee4"]}),"\n",(0,r.jsx)(e.li,{children:"assign\uff1a\u4f5c\u7528\u4e8e\u5de5\u4f5c\u5185\u5b58\uff0c\u628a\u4ece\u6267\u884c\u5f15\u64ce\u63a5\u6536\u5230\u7684\u4e00\u4e2a\u503c\u8d4b\u7ed9\u5de5\u4f5c\u5185\u5b58\u7684\u53d8\u91cf"}),"\n",(0,r.jsx)(e.li,{children:"store\uff1a\u4f5c\u7528\u4e8e\u5de5\u4f5c\u5185\u5b58\uff0c\u628a\u5de5\u4f5c\u5185\u5b58\u7684\u4e00\u4e2a\u53d8\u91cf\u7684\u503c\u4f20\u9001\u5230\u4e3b\u5185\u5b58\u4e2d"}),"\n",(0,r.jsx)(e.li,{children:"write\uff1a\u4f5c\u7528\u4e8e\u4e3b\u5185\u5b58\uff0c\u5728 store \u4e4b\u540e\u6267\u884c\uff0c\u628a store \u5f97\u5230\u7684\u503c\u653e\u5165\u4e3b\u5185\u5b58\u7684\u53d8\u91cf\u4e2d"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20%E5%B9%B6%E5%8F%91.md",children:"https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20%E5%B9%B6%E5%8F%91.md"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4e09\u5927\u7279\u6027",children:"\u4e09\u5927\u7279\u6027"}),"\n",(0,r.jsx)(e.h5,{id:"\u53ef\u89c1\u6027",children:"\u53ef\u89c1\u6027"}),"\n",(0,r.jsx)(e.p,{children:"\u53ef\u89c1\u6027\uff1a\u662f\u6307\u5f53\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95ee\u540c\u4e00\u4e2a\u53d8\u91cf\u65f6\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u4fee\u6539\u4e86\u8fd9\u4e2a\u53d8\u91cf\u7684\u503c\uff0c\u5176\u4ed6\u7ebf\u7a0b\u80fd\u591f\u7acb\u5373\u770b\u5f97\u5230\u4fee\u6539\u7684\u503c"}),"\n",(0,r.jsxs)(e.p,{children:["\u5b58\u5728\u4e0d\u53ef\u89c1\u95ee\u9898\u7684\u6839\u672c\u539f\u56e0\u662f\u7531\u4e8e\u7f13\u5b58\u7684\u5b58\u5728\uff0c\u7ebf\u7a0b\u6301\u6709\u7684\u662f\u5171\u4eab\u53d8\u91cf\u7684\u526f\u672c\uff0c\u65e0\u6cd5\u611f\u77e5\u5176\u4ed6\u7ebf\u7a0b\u5bf9\u4e8e\u5171\u4eab\u53d8\u91cf\u7684\u66f4\u6539\uff0c\u5bfc\u81f4\u8bfb\u53d6\u7684\u503c\u4e0d\u662f\u6700\u65b0\u7684\u3002\u4f46\u662f final \u4fee\u9970\u7684\u53d8\u91cf\u662f",(0,r.jsx)(e.strong,{children:"\u4e0d\u53ef\u53d8"}),"\u7684\uff0c\u5c31\u7b97\u6709\u7f13\u5b58\uff0c\u4e5f\u4e0d\u4f1a\u5b58\u5728\u4e0d\u53ef\u89c1\u7684\u95ee\u9898"]}),"\n",(0,r.jsx)(e.p,{children:"main \u7ebf\u7a0b\u5bf9 run \u53d8\u91cf\u7684\u4fee\u6539\u5bf9\u4e8e t \u7ebf\u7a0b\u4e0d\u53ef\u89c1\uff0c\u5bfc\u81f4\u4e86 t \u7ebf\u7a0b\u65e0\u6cd5\u505c\u6b62\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static boolean run = true;\t//\u6dfb\u52a0volatile\npublic static void main(String[] args) throws InterruptedException {\n    Thread t = new Thread(()->{\n        while(run){\n        // ....\n        }\n\t});\n    t.start();\n    sleep(1);\n    run = false; // \u7ebf\u7a0bt\u4e0d\u4f1a\u5982\u9884\u60f3\u7684\u505c\u4e0b\u6765\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u56e0\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u521d\u59cb\u72b6\u6001\uff0c t \u7ebf\u7a0b\u521a\u5f00\u59cb\u4ece\u4e3b\u5185\u5b58\u8bfb\u53d6\u4e86 run \u7684\u503c\u5230\u5de5\u4f5c\u5185\u5b58"}),"\n",(0,r.jsx)(e.li,{children:"\u56e0\u4e3a t \u7ebf\u7a0b\u8981\u9891\u7e41\u4ece\u4e3b\u5185\u5b58\u4e2d\u8bfb\u53d6 run \u7684\u503c\uff0cJIT \u7f16\u8bd1\u5668\u4f1a\u5c06 run \u7684\u503c\u7f13\u5b58\u81f3\u81ea\u5df1\u5de5\u4f5c\u5185\u5b58\u4e2d\u7684\u9ad8\u901f\u7f13\u5b58\u4e2d\uff0c\u51cf\u5c11\u5bf9\u4e3b\u5b58\u4e2d run \u7684\u8bbf\u95ee\uff0c\u63d0\u9ad8\u6548\u7387"}),"\n",(0,r.jsx)(e.li,{children:"1 \u79d2\u4e4b\u540e\uff0cmain \u7ebf\u7a0b\u4fee\u6539\u4e86 run \u7684\u503c\uff0c\u5e76\u540c\u6b65\u81f3\u4e3b\u5b58\uff0c\u800c t \u662f\u4ece\u81ea\u5df1\u5de5\u4f5c\u5185\u5b58\u4e2d\u7684\u9ad8\u901f\u7f13\u5b58\u4e2d\u8bfb\u53d6\u8fd9\u4e2a\u53d8\u91cf\u7684\u503c\uff0c\u7ed3\u679c\u6c38\u8fdc\u662f\u65e7\u503c"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(26595).A+"",width:"902",height:"353"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u539f\u5b50\u6027",children:"\u539f\u5b50\u6027"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u5b50\u6027\uff1a\u4e0d\u53ef\u5206\u5272\uff0c\u5b8c\u6574\u6027\uff0c\u4e5f\u5c31\u662f\u8bf4\u67d0\u4e2a\u7ebf\u7a0b\u6b63\u5728\u505a\u67d0\u4e2a\u5177\u4f53\u4e1a\u52a1\u65f6\uff0c\u4e2d\u95f4\u4e0d\u53ef\u4ee5\u88ab\u5206\u5272\uff0c\u9700\u8981\u5177\u4f53\u5b8c\u6210\uff0c\u8981\u4e48\u540c\u65f6\u6210\u529f\uff0c\u8981\u4e48\u540c\u65f6\u5931\u8d25\uff0c\u4fdd\u8bc1\u6307\u4ee4\u4e0d\u4f1a\u53d7\u5230\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u5f71\u54cd"}),"\n",(0,r.jsx)(e.p,{children:"\u5b9a\u4e49\u539f\u5b50\u64cd\u4f5c\u7684\u4f7f\u7528\u89c4\u5219\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e0d\u5141\u8bb8 read \u548c load\u3001store \u548c write \u64cd\u4f5c\u4e4b\u4e00\u5355\u72ec\u51fa\u73b0\uff0c\u5fc5\u987b\u987a\u5e8f\u6267\u884c\uff0c\u4f46\u662f\u4e0d\u8981\u6c42\u8fde\u7eed"}),"\n",(0,r.jsx)(e.li,{children:"\u4e0d\u5141\u8bb8\u4e00\u4e2a\u7ebf\u7a0b\u4e22\u5f03 assign \u64cd\u4f5c\uff0c\u5fc5\u987b\u540c\u6b65\u56de\u4e3b\u5b58"}),"\n",(0,r.jsx)(e.li,{children:"\u4e0d\u5141\u8bb8\u4e00\u4e2a\u7ebf\u7a0b\u65e0\u539f\u56e0\u5730\uff08\u6ca1\u6709\u53d1\u751f\u8fc7\u4efb\u4f55 assign \u64cd\u4f5c\uff09\u628a\u6570\u636e\u4ece\u5de5\u4f5c\u5185\u5b58\u540c\u6b65\u4f1a\u4e3b\u5185\u5b58\u4e2d"}),"\n",(0,r.jsx)(e.li,{children:"\u4e00\u4e2a\u65b0\u7684\u53d8\u91cf\u53ea\u80fd\u5728\u4e3b\u5185\u5b58\u4e2d\u8bde\u751f\uff0c\u4e0d\u5141\u8bb8\u5728\u5de5\u4f5c\u5185\u5b58\u4e2d\u76f4\u63a5\u4f7f\u7528\u4e00\u4e2a\u672a\u88ab\u521d\u59cb\u5316\uff08assign \u6216\u8005 load\uff09\u7684\u53d8\u91cf\uff0c\u5373\u5bf9\u4e00\u4e2a\u53d8\u91cf\u5b9e\u65bd use \u548c store \u64cd\u4f5c\u4e4b\u524d\uff0c\u5fc5\u987b\u5148\u81ea\u884c assign \u548c load \u64cd\u4f5c"}),"\n",(0,r.jsxs)(e.li,{children:["\u4e00\u4e2a\u53d8\u91cf\u5728\u540c\u4e00\u65f6\u523b\u53ea\u5141\u8bb8\u4e00\u6761\u7ebf\u7a0b\u5bf9\u5176\u8fdb\u884c lock \u64cd\u4f5c\uff0c\u4f46 lock \u64cd\u4f5c\u53ef\u4ee5\u88ab\u540c\u4e00\u7ebf\u7a0b\u91cd\u590d\u6267\u884c\u591a\u6b21\uff0c\u591a\u6b21\u6267\u884c lock \u540e\uff0c\u53ea\u6709",(0,r.jsx)(e.strong,{children:"\u6267\u884c\u76f8\u540c\u6b21\u6570\u7684 unlock"})," \u64cd\u4f5c\uff0c\u53d8\u91cf\u624d\u4f1a\u88ab\u89e3\u9501\uff0c",(0,r.jsx)(e.strong,{children:"lock \u548c unlock \u5fc5\u987b\u6210\u5bf9\u51fa\u73b0"})]}),"\n",(0,r.jsxs)(e.li,{children:["\u5982\u679c\u5bf9\u4e00\u4e2a\u53d8\u91cf\u6267\u884c lock \u64cd\u4f5c\uff0c\u5c06\u4f1a",(0,r.jsx)(e.strong,{children:"\u6e05\u7a7a\u5de5\u4f5c\u5185\u5b58\u4e2d\u6b64\u53d8\u91cf\u7684\u503c"}),"\uff0c\u5728\u6267\u884c\u5f15\u64ce\u4f7f\u7528\u8fd9\u4e2a\u53d8\u91cf\u4e4b\u524d\u9700\u8981\u91cd\u65b0\u4ece\u4e3b\u5b58\u52a0\u8f7d"]}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u4e00\u4e2a\u53d8\u91cf\u4e8b\u5148\u6ca1\u6709\u88ab lock \u64cd\u4f5c\u9501\u5b9a\uff0c\u5219\u4e0d\u5141\u8bb8\u6267\u884c unlock \u64cd\u4f5c\uff0c\u4e5f\u4e0d\u5141\u8bb8\u53bb unlock \u4e00\u4e2a\u88ab\u5176\u4ed6\u7ebf\u7a0b\u9501\u5b9a\u7684\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.li,{children:["\u5bf9\u4e00\u4e2a\u53d8\u91cf\u6267\u884c unlock \u64cd\u4f5c\u4e4b\u524d\uff0c\u5fc5\u987b",(0,r.jsx)(e.strong,{children:"\u5148\u628a\u6b64\u53d8\u91cf\u540c\u6b65\u5230\u4e3b\u5185\u5b58"}),"\u4e2d\uff08\u6267\u884c store \u548c write \u64cd\u4f5c\uff09"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6709\u5e8f\u6027",children:"\u6709\u5e8f\u6027"}),"\n",(0,r.jsx)(e.p,{children:"\u6709\u5e8f\u6027\uff1a\u5728\u672c\u7ebf\u7a0b\u5185\u89c2\u5bdf\uff0c\u6240\u6709\u64cd\u4f5c\u90fd\u662f\u6709\u5e8f\u7684\uff1b\u5728\u4e00\u4e2a\u7ebf\u7a0b\u89c2\u5bdf\u53e6\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u6240\u6709\u64cd\u4f5c\u90fd\u662f\u65e0\u5e8f\u7684\uff0c\u65e0\u5e8f\u662f\u56e0\u4e3a\u53d1\u751f\u4e86\u6307\u4ee4\u91cd\u6392\u5e8f"}),"\n",(0,r.jsx)(e.p,{children:"CPU \u7684\u57fa\u672c\u5de5\u4f5c\u662f\u6267\u884c\u5b58\u50a8\u7684\u6307\u4ee4\u5e8f\u5217\uff0c\u5373\u7a0b\u5e8f\uff0c\u7a0b\u5e8f\u7684\u6267\u884c\u8fc7\u7a0b\u5b9e\u9645\u4e0a\u662f\u4e0d\u65ad\u5730\u53d6\u51fa\u6307\u4ee4\u3001\u5206\u6790\u6307\u4ee4\u3001\u6267\u884c\u6307\u4ee4\u7684\u8fc7\u7a0b\uff0c\u4e3a\u4e86\u63d0\u9ad8\u6027\u80fd\uff0c\u7f16\u8bd1\u5668\u548c\u5904\u7406\u5668\u4f1a\u5bf9\u6307\u4ee4\u91cd\u6392\uff0c\u4e00\u822c\u5206\u4e3a\u4ee5\u4e0b\u4e09\u79cd\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\u6e90\u4ee3\u7801 -> \u7f16\u8bd1\u5668\u4f18\u5316\u7684\u91cd\u6392 -> \u6307\u4ee4\u5e76\u884c\u7684\u91cd\u6392 -> \u5185\u5b58\u7cfb\u7edf\u7684\u91cd\u6392 -> \u6700\u7ec8\u6267\u884c\u6307\u4ee4\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u73b0\u4ee3 CPU \u652f\u6301\u591a\u7ea7\u6307\u4ee4\u6d41\u6c34\u7ebf\uff0c\u51e0\u4e4e\u6240\u6709\u7684\u51af\u2022\u8bfa\u4f0a\u66fc\u578b\u8ba1\u7b97\u673a\u7684 CPU\uff0c\u5176\u5de5\u4f5c\u90fd\u53ef\u4ee5\u5206\u4e3a 5 \u4e2a\u9636\u6bb5\uff1a\u53d6\u6307\u4ee4\u3001\u6307\u4ee4\u8bd1\u7801\u3001\u6267\u884c\u6307\u4ee4\u3001\u8bbf\u5b58\u53d6\u6570\u548c\u7ed3\u679c\u5199\u56de\uff0c\u53ef\u4ee5\u79f0\u4e4b\u4e3a",(0,r.jsx)(e.strong,{children:"\u4e94\u7ea7\u6307\u4ee4\u6d41\u6c34\u7ebf"}),"\u3002CPU \u53ef\u4ee5\u5728\u4e00\u4e2a\u65f6\u949f\u5468\u671f\u5185\uff0c\u540c\u65f6\u8fd0\u884c\u4e94\u6761\u6307\u4ee4\u7684",(0,r.jsx)(e.strong,{children:"\u4e0d\u540c\u9636\u6bb5"}),"\uff08\u6bcf\u4e2a\u7ebf\u7a0b\u4e0d\u540c\u7684\u9636\u6bb5\uff09\uff0c\u672c\u8d28\u4e0a\u6d41\u6c34\u7ebf\u6280\u672f\u5e76\u4e0d\u80fd\u7f29\u77ed\u5355\u6761\u6307\u4ee4\u7684\u6267\u884c\u65f6\u95f4\uff0c\u4f46\u53d8\u76f8\u5730\u63d0\u9ad8\u4e86\u6307\u4ee4\u5730\u541e\u5410\u7387"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5904\u7406\u5668\u5728\u8fdb\u884c\u91cd\u6392\u5e8f\u65f6\uff0c\u5fc5\u987b\u8981\u8003\u8651",(0,r.jsx)(e.strong,{children:"\u6307\u4ee4\u4e4b\u95f4\u7684\u6570\u636e\u4f9d\u8d56\u6027"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5355\u7ebf\u7a0b\u73af\u5883\u4e5f\u5b58\u5728\u6307\u4ee4\u91cd\u6392\uff0c\u7531\u4e8e\u5b58\u5728\u4f9d\u8d56\u6027\uff0c\u6700\u7ec8\u6267\u884c\u7ed3\u679c\u548c\u4ee3\u7801\u987a\u5e8f\u7684\u7ed3\u679c\u4e00\u81f4"}),"\n",(0,r.jsx)(e.li,{children:"\u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\u7ebf\u7a0b\u4ea4\u66ff\u6267\u884c\uff0c\u7531\u4e8e\u7f16\u8bd1\u5668\u4f18\u5316\u91cd\u6392\uff0c\u4f1a\u83b7\u53d6\u5176\u4ed6\u7ebf\u7a0b\u5904\u5728\u4e0d\u540c\u9636\u6bb5\u7684\u6307\u4ee4\u540c\u65f6\u6267\u884c"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u8865\u5145\u77e5\u8bc6\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6307\u4ee4\u5468\u671f\u662f\u53d6\u51fa\u4e00\u6761\u6307\u4ee4\u5e76\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u7684\u65f6\u95f4\uff0c\u4e00\u822c\u7531\u82e5\u5e72\u4e2a\u673a\u5668\u5468\u671f\u7ec4\u6210"}),"\n",(0,r.jsx)(e.li,{children:"\u673a\u5668\u5468\u671f\u4e5f\u79f0\u4e3a CPU \u5468\u671f\uff0c\u4e00\u6761\u6307\u4ee4\u7684\u6267\u884c\u8fc7\u7a0b\u5212\u5206\u4e3a\u82e5\u5e72\u4e2a\u9636\u6bb5\uff08\u5982\u53d6\u6307\u3001\u8bd1\u7801\u3001\u6267\u884c\u7b49\uff09\uff0c\u6bcf\u4e00\u9636\u6bb5\u5b8c\u6210\u4e00\u4e2a\u57fa\u672c\u64cd\u4f5c\uff0c\u5b8c\u6210\u4e00\u4e2a\u57fa\u672c\u64cd\u4f5c\u6240\u9700\u8981\u7684\u65f6\u95f4\u79f0\u4e3a\u673a\u5668\u5468\u671f"}),"\n",(0,r.jsx)(e.li,{children:"\u632f\u8361\u5468\u671f\u6307\u5468\u671f\u6027\u4fe1\u53f7\u4f5c\u5468\u671f\u6027\u91cd\u590d\u53d8\u5316\u7684\u65f6\u95f4\u95f4\u9694"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"cache",children:"cache"}),"\n",(0,r.jsx)(e.h4,{id:"\u7f13\u5b58\u673a\u5236",children:"\u7f13\u5b58\u673a\u5236"}),"\n",(0,r.jsx)(e.h5,{id:"\u7f13\u5b58\u7ed3\u6784",children:"\u7f13\u5b58\u7ed3\u6784"}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\uff0cCPU \u9ad8\u901f\u7f13\u5b58\uff08CPU Cache\uff0c\u7b80\u79f0\u7f13\u5b58\uff09\u662f\u7528\u4e8e\u51cf\u5c11\u5904\u7406\u5668\u8bbf\u95ee\u5185\u5b58\u6240\u9700\u5e73\u5747\u65f6\u95f4\u7684\u90e8\u4ef6\uff1b\u5728\u5b58\u50a8\u4f53\u7cfb\u4e2d\u4f4d\u4e8e\u81ea\u9876\u5411\u4e0b\u7684\u7b2c\u4e8c\u5c42\uff0c\u4ec5\u6b21\u4e8e CPU \u5bc4\u5b58\u5668\uff1b\u5176\u5bb9\u91cf\u8fdc\u5c0f\u4e8e\u5185\u5b58\uff0c\u4f46\u901f\u5ea6\u5374\u53ef\u4ee5\u63a5\u8fd1\u5904\u7406\u5668\u7684\u9891\u7387"}),"\n",(0,r.jsx)(e.p,{children:"CPU \u5904\u7406\u5668\u901f\u5ea6\u8fdc\u8fdc\u5927\u4e8e\u5728\u4e3b\u5185\u5b58\u4e2d\u7684\uff0c\u4e3a\u4e86\u89e3\u51b3\u901f\u5ea6\u5dee\u5f02\uff0c\u5728\u5b83\u4eec\u4e4b\u95f4\u67b6\u8bbe\u4e86\u591a\u7ea7\u7f13\u5b58\uff0c\u5982 L1\u3001L2\u3001L3 \u7ea7\u522b\u7684\u7f13\u5b58\uff0c\u8fd9\u4e9b\u7f13\u5b58\u79bb CPU \u8d8a\u8fd1\u5c31\u8d8a\u5feb\uff0c\u5c06\u9891\u7e41\u64cd\u4f5c\u7684\u6570\u636e\u7f13\u5b58\u5230\u8fd9\u91cc\uff0c\u52a0\u5feb\u8bbf\u95ee\u901f\u5ea6"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(2055).A+"",width:"929",height:"546"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u4ece CPU \u5230"}),(0,r.jsx)(e.th,{children:"\u5927\u7ea6\u9700\u8981\u7684\u65f6\u949f\u5468\u671f"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u5bc4\u5b58\u5668"}),(0,r.jsx)(e.td,{children:"1 cycle (4GHz \u7684 CPU \u7ea6\u4e3a 0.25ns)"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"L1"}),(0,r.jsx)(e.td,{children:"3~4 cycle"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"L2"}),(0,r.jsx)(e.td,{children:"10~20 cycle"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"L3"}),(0,r.jsx)(e.td,{children:"40~45 cycle"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u5185\u5b58"}),(0,r.jsx)(e.td,{children:"120~240 cycle"})]})]})]}),"\n",(0,r.jsx)(e.h5,{id:"\u7f13\u5b58\u4f7f\u7528",children:"\u7f13\u5b58\u4f7f\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u5f53\u5904\u7406\u5668\u53d1\u51fa\u5185\u5b58\u8bbf\u95ee\u8bf7\u6c42\u65f6\uff0c\u4f1a\u5148\u67e5\u770b\u7f13\u5b58\u5185\u662f\u5426\u6709\u8bf7\u6c42\u6570\u636e\uff0c\u5982\u679c\u5b58\u5728\uff08\u547d\u4e2d\uff09\uff0c\u5219\u4e0d\u7528\u8bbf\u95ee\u5185\u5b58\u76f4\u63a5\u8fd4\u56de\u8be5\u6570\u636e\uff1b\u5982\u679c\u4e0d\u5b58\u5728\uff08\u5931\u6548\uff09\uff0c\u5219\u8981\u5148\u628a\u5185\u5b58\u4e2d\u7684\u76f8\u5e94\u6570\u636e\u8f7d\u5165\u7f13\u5b58\uff0c\u518d\u5c06\u5176\u8fd4\u56de\u5904\u7406\u5668"}),"\n",(0,r.jsx)(e.p,{children:"\u7f13\u5b58\u4e4b\u6240\u4ee5\u6709\u6548\uff0c\u4e3b\u8981\u56e0\u4e3a\u7a0b\u5e8f\u8fd0\u884c\u65f6\u5bf9\u5185\u5b58\u7684\u8bbf\u95ee\u5448\u73b0\u5c40\u90e8\u6027\uff08Locality\uff09\u7279\u5f81\u3002\u65e2\u5305\u62ec\u7a7a\u95f4\u5c40\u90e8\u6027\uff08Spatial Locality\uff09\uff0c\u4e5f\u5305\u62ec\u65f6\u95f4\u5c40\u90e8\u6027\uff08Temporal Locality\uff09\uff0c\u6709\u6548\u5229\u7528\u8fd9\u79cd\u5c40\u90e8\u6027\uff0c\u7f13\u5b58\u53ef\u4ee5\u8fbe\u5230\u6781\u9ad8\u7684\u547d\u4e2d\u7387"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4f2a\u5171\u4eab",children:"\u4f2a\u5171\u4eab"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u7f13\u5b58\u4ee5\u7f13\u5b58\u884c cache line \u4e3a\u5355\u4f4d"}),"\uff0c\u6bcf\u4e2a\u7f13\u5b58\u884c\u5bf9\u5e94\u7740\u4e00\u5757\u5185\u5b58\uff0c\u4e00\u822c\u662f 64 byte\uff088 \u4e2a long\uff09\uff0c\u5728 CPU \u4ece\u4e3b\u5b58\u83b7\u53d6\u6570\u636e\u65f6\uff0c\u4ee5 cache line \u4e3a\u5355\u4f4d\u52a0\u8f7d\uff0c\u4e8e\u662f\u76f8\u90bb\u7684\u6570\u636e\u4f1a\u4e00\u5e76\u52a0\u8f7d\u5230\u7f13\u5b58\u4e2d"]}),"\n",(0,r.jsxs)(e.p,{children:["\u7f13\u5b58\u4f1a\u9020\u6210\u6570\u636e\u526f\u672c\u7684\u4ea7\u751f\uff0c\u5373\u540c\u4e00\u4efd\u6570\u636e\u4f1a\u7f13\u5b58\u5728\u4e0d\u540c\u6838\u5fc3\u7684\u7f13\u5b58\u884c\u4e2d\uff0cCPU \u8981\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\uff0c\u9700\u8981\u505a\u5230\u67d0\u4e2a CPU \u6838\u5fc3\u66f4\u6539\u4e86\u6570\u636e\uff0c\u5176\u5b83 CPU \u6838\u5fc3\u5bf9\u5e94\u7684",(0,r.jsx)(e.strong,{children:"\u6574\u4e2a\u7f13\u5b58\u884c\u5fc5\u987b\u5931\u6548"}),"\uff0c\u8fd9\u5c31\u662f\u4f2a\u5171\u4eab"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(15736).A+"",width:"810",height:"529"})}),"\n",(0,r.jsx)(e.p,{children:"\u89e3\u51b3\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"padding\uff1a\u901a\u8fc7\u586b\u5145\uff0c\u8ba9\u6570\u636e\u843d\u5728\u4e0d\u540c\u7684 cache line \u4e2d"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"@Contended\uff1a\u539f\u7406\u53c2\u8003 \u65e0\u9501 \u2192 Adder \u2192 \u4f18\u5316\u673a\u5236 \u2192 \u4f2a\u5171\u4eab"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Linux \u67e5\u770b CPU \u7f13\u5b58\u884c\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u547d\u4ee4\uff1a",(0,r.jsx)(e.code,{children:"cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size64"})]}),"\n",(0,r.jsx)(e.li,{children:"\u5185\u5b58\u5730\u5740\u683c\u5f0f\uff1a[\u9ad8\u4f4d\u7ec4\u6807\u8bb0] [\u4f4e\u4f4d\u7d22\u5f15] [\u504f\u79fb\u91cf]"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u7f13\u5b58\u4e00\u81f4",children:"\u7f13\u5b58\u4e00\u81f4"}),"\n",(0,r.jsx)(e.p,{children:"\u7f13\u5b58\u4e00\u81f4\u6027\uff1a\u5f53\u591a\u4e2a\u5904\u7406\u5668\u8fd0\u7b97\u4efb\u52a1\u90fd\u6d89\u53ca\u5230\u540c\u4e00\u5757\u4e3b\u5185\u5b58\u533a\u57df\u7684\u65f6\u5019\uff0c\u5c06\u53ef\u80fd\u5bfc\u81f4\u5404\u81ea\u7684\u7f13\u5b58\u6570\u636e\u4e0d\u4e00\u6837"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(77183).A+"",width:"858",height:"291"})}),"\n",(0,r.jsxs)(e.p,{children:["MESI\uff08Modified Exclusive Shared Or Invalid\uff09\u662f\u4e00\u79cd\u5e7f\u6cdb\u4f7f\u7528\u7684",(0,r.jsx)(e.strong,{children:"\u652f\u6301\u5199\u56de\u7b56\u7565\u7684\u7f13\u5b58\u4e00\u81f4\u6027\u534f\u8bae"}),"\uff0cCPU \u4e2d\u6bcf\u4e2a\u7f13\u5b58\u884c\uff08caceh line\uff09\u4f7f\u7528 4 \u79cd\u72b6\u6001\u8fdb\u884c\u6807\u8bb0\uff08\u4f7f\u7528\u989d\u5916\u7684\u4e24\u4f4d bit \u8868\u793a)\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"M\uff1a\u88ab\u4fee\u6539\uff08Modified\uff09"}),"\n",(0,r.jsx)(e.p,{children:"\u8be5\u7f13\u5b58\u884c\u53ea\u88ab\u7f13\u5b58\u5728\u8be5 CPU \u7684\u7f13\u5b58\u4e2d\uff0c\u5e76\u4e14\u662f\u88ab\u4fee\u6539\u8fc7\u7684\uff0c\u4e0e\u4e3b\u5b58\u4e2d\u7684\u6570\u636e\u4e0d\u4e00\u81f4 (dirty)\uff0c\u8be5\u7f13\u5b58\u884c\u4e2d\u7684\u5185\u5b58\u9700\u8981\u5199\u56de (write back) \u4e3b\u5b58\u3002\u8be5\u72b6\u6001\u7684\u6570\u636e\u518d\u6b21\u88ab\u4fee\u6539\u4e0d\u4f1a\u53d1\u9001\u5e7f\u64ad\uff0c\u56e0\u4e3a\u5176\u4ed6\u6838\u5fc3\u7684\u6570\u636e\u5df2\u7ecf\u5728\u7b2c\u4e00\u6b21\u4fee\u6539\u65f6\u5931\u6548\u4e00\u6b21"}),"\n",(0,r.jsx)(e.p,{children:"\u5f53\u88ab\u5199\u56de\u4e3b\u5b58\u4e4b\u540e\uff0c\u8be5\u7f13\u5b58\u884c\u7684\u72b6\u6001\u4f1a\u53d8\u6210\u72ec\u4eab (exclusive) \u72b6\u6001"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"E\uff1a\u72ec\u4eab\u7684\uff08Exclusive\uff09"}),"\n",(0,r.jsx)(e.p,{children:"\u8be5\u7f13\u5b58\u884c\u53ea\u88ab\u7f13\u5b58\u5728\u8be5 CPU \u7684\u7f13\u5b58\u4e2d\uff0c\u662f\u672a\u88ab\u4fee\u6539\u8fc7\u7684 (clear)\uff0c\u4e0e\u4e3b\u5b58\u4e2d\u6570\u636e\u4e00\u81f4\uff0c\u4fee\u6539\u6570\u636e\u4e0d\u9700\u8981\u901a\u77e5\u5176\u4ed6 CPU \u6838\u5fc3\uff0c\u8be5\u72b6\u6001\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u523b\u6709\u5176\u5b83 CPU \u8bfb\u53d6\u8be5\u5185\u5b58\u65f6\u53d8\u6210\u5171\u4eab\u72b6\u6001 (shared)"}),"\n",(0,r.jsx)(e.p,{children:"\u5f53 CPU \u4fee\u6539\u8be5\u7f13\u5b58\u884c\u4e2d\u5185\u5bb9\u65f6\uff0c\u8be5\u72b6\u6001\u53ef\u4ee5\u53d8\u6210 Modified \u72b6\u6001"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"S\uff1a\u5171\u4eab\u7684\uff08Shared\uff09"}),"\n",(0,r.jsx)(e.p,{children:"\u8be5\u72b6\u6001\u610f\u5473\u7740\u8be5\u7f13\u5b58\u884c\u53ef\u80fd\u88ab\u591a\u4e2a CPU \u7f13\u5b58\uff0c\u5e76\u4e14\u5404\u4e2a\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u4e0e\u4e3b\u5b58\u6570\u636e\u4e00\u81f4\uff0c\u5f53 CPU \u4fee\u6539\u8be5\u7f13\u5b58\u884c\u4e2d\uff0c\u4f1a\u5411\u5176\u5b83 CPU \u6838\u5fc3\u5e7f\u64ad\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f7f\u8be5\u7f13\u5b58\u884c\u53d8\u6210\u65e0\u6548\u72b6\u6001 (Invalid)\uff0c\u7136\u540e\u518d\u66f4\u65b0\u5f53\u524d Cache \u91cc\u7684\u6570\u636e"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"I\uff1a\u65e0\u6548\u7684\uff08Invalid\uff09"}),"\n",(0,r.jsx)(e.p,{children:"\u8be5\u7f13\u5b58\u662f\u65e0\u6548\u7684\uff0c\u53ef\u80fd\u6709\u5176\u5b83 CPU \u4fee\u6539\u4e86\u8be5\u7f13\u5b58\u884c"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u89e3\u51b3\u65b9\u6cd5\uff1a\u5404\u4e2a\u5904\u7406\u5668\u8bbf\u95ee\u7f13\u5b58\u65f6\u90fd\u9075\u5faa\u4e00\u4e9b\u534f\u8bae\uff0c\u5728\u8bfb\u5199\u65f6\u8981\u6839\u636e\u534f\u8bae\u8fdb\u884c\u64cd\u4f5c\uff0c\u534f\u8bae\u4e3b\u8981\u6709 MSI\u3001MESI \u7b49"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5904\u7406\u673a\u5236",children:"\u5904\u7406\u673a\u5236"}),"\n",(0,r.jsx)(e.p,{children:"\u5355\u6838 CPU \u5904\u7406\u5668\u4f1a\u81ea\u52a8\u4fdd\u8bc1\u57fa\u672c\u5185\u5b58\u64cd\u4f5c\u7684\u539f\u5b50\u6027"}),"\n",(0,r.jsx)(e.p,{children:"\u591a\u6838 CPU \u5904\u7406\u5668\uff0c\u6bcf\u4e2a CPU \u5904\u7406\u5668\u5185\u7ef4\u62a4\u4e86\u4e00\u5757\u5185\u5b58\uff0c\u6bcf\u4e2a\u5185\u6838\u5185\u90e8\u7ef4\u62a4\u7740\u4e00\u5757\u7f13\u5b58\uff0c\u5f53\u591a\u7ebf\u7a0b\u5e76\u53d1\u8bfb\u5199\u65f6\uff0c\u5c31\u4f1a\u51fa\u73b0\u7f13\u5b58\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u5904\u7406\u5668\u63d0\u4f9b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u603b\u7ebf\u9501\u5b9a\uff1a\u5f53\u5904\u7406\u5668\u8981\u64cd\u4f5c\u5171\u4eab\u53d8\u91cf\u65f6\uff0c\u5728 BUS \u603b\u7ebf\u4e0a\u53d1\u51fa\u4e00\u4e2a LOCK \u4fe1\u53f7\uff0c\u5176\u4ed6\u5904\u7406\u5668\u5c31\u65e0\u6cd5\u64cd\u4f5c\u8fd9\u4e2a\u5171\u4eab\u53d8\u91cf\uff0c\u8be5\u64cd\u4f5c\u4f1a\u5bfc\u81f4\u5927\u91cf\u963b\u585e\uff0c\u4ece\u800c\u589e\u52a0\u7cfb\u7edf\u7684\u6027\u80fd\u5f00\u9500\uff08",(0,r.jsx)(e.strong,{children:"\u5e73\u53f0\u7ea7\u522b\u7684\u52a0\u9501"}),"\uff09"]}),"\n",(0,r.jsx)(e.li,{children:"\u7f13\u5b58\u9501\u5b9a\uff1a\u5f53\u5904\u7406\u5668\u5bf9\u7f13\u5b58\u4e2d\u7684\u5171\u4eab\u53d8\u91cf\u8fdb\u884c\u4e86\u64cd\u4f5c\uff0c\u5176\u4ed6\u5904\u7406\u5668\u6709\u55c5\u63a2\u673a\u5236\uff0c\u5c06\u5404\u81ea\u7f13\u5b58\u4e2d\u7684\u8be5\u5171\u4eab\u53d8\u91cf\u7684\u5931\u6548\uff0c\u8bfb\u53d6\u65f6\u4f1a\u91cd\u65b0\u4ece\u4e3b\u5185\u5b58\u4e2d\u8bfb\u53d6\u6700\u65b0\u7684\u6570\u636e\uff0c\u57fa\u4e8e MESI \u7f13\u5b58\u4e00\u81f4\u6027\u534f\u8bae\u6765\u5b9e\u73b0"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6709\u5982\u4e0b\u4e24\u79cd\u60c5\u51b5\u5904\u7406\u5668\u4e0d\u4f1a\u4f7f\u7528\u7f13\u5b58\u9501\u5b9a\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u64cd\u4f5c\u7684\u6570\u636e\u8de8\u591a\u4e2a\u7f13\u5b58\u884c\uff0c\u6216\u6ca1\u88ab\u7f13\u5b58\u5728\u5904\u7406\u5668\u5185\u90e8\uff0c\u5219\u5904\u7406\u5668\u4f1a\u4f7f\u7528\u603b\u7ebf\u9501\u5b9a"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6709\u4e9b\u5904\u7406\u5668\u4e0d\u652f\u6301\u7f13\u5b58\u9501\u5b9a\uff0c\u6bd4\u5982\uff1aIntel 486 \u548c Pentium \u5904\u7406\u5668\u4e5f\u4f1a\u8c03\u7528\u603b\u7ebf\u9501\u5b9a"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u603b\u7ebf\u673a\u5236\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u603b\u7ebf\u55c5\u63a2\uff1a\u6bcf\u4e2a\u5904\u7406\u5668\u901a\u8fc7\u55c5\u63a2\u5728\u603b\u7ebf\u4e0a\u4f20\u64ad\u7684\u6570\u636e\u6765\u68c0\u67e5\u81ea\u5df1\u7f13\u5b58\u503c\u662f\u5426\u8fc7\u671f\u4e86\uff0c\u5f53\u5904\u7406\u5668\u53d1\u73b0\u81ea\u5df1\u7684\u7f13\u5b58\u5bf9\u5e94\u7684\u5185\u5b58\u5730\u5740\u7684\u6570\u636e\u88ab\u4fee\u6539\uff0c\u5c31",(0,r.jsx)(e.strong,{children:"\u5c06\u5f53\u524d\u5904\u7406\u5668\u7684\u7f13\u5b58\u884c\u8bbe\u7f6e\u4e3a\u65e0\u6548\u72b6\u6001"}),"\uff0c\u5f53\u5904\u7406\u5668\u5bf9\u8fd9\u4e2a\u6570\u636e\u8fdb\u884c\u64cd\u4f5c\u65f6\uff0c\u4f1a\u91cd\u65b0\u4ece\u5185\u5b58\u4e2d\u628a\u6570\u636e\u8bfb\u53d6\u5230\u5904\u7406\u5668\u7f13\u5b58\u4e2d"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u603b\u7ebf\u98ce\u66b4\uff1a\u5f53\u67d0\u4e2a CPU \u6838\u5fc3\u66f4\u65b0\u4e86 Cache \u4e2d\u7684\u6570\u636e\uff0c\u8981\u628a\u8be5\u4e8b\u4ef6\u5e7f\u64ad\u901a\u77e5\u5230\u5176\u4ed6\u6838\u5fc3\uff08",(0,r.jsx)(e.strong,{children:"\u5199\u4f20\u64ad"}),"\uff09\uff0cCPU \u9700\u8981\u6bcf\u65f6\u6bcf\u523b\u76d1\u542c\u603b\u7ebf\u4e0a\u7684\u4e00\u5207\u6d3b\u52a8\uff0c\u4f46\u662f\u4e0d\u7ba1\u522b\u7684\u6838\u5fc3\u7684 Cache \u662f\u5426\u7f13\u5b58\u76f8\u540c\u7684\u6570\u636e\uff0c\u90fd\u9700\u8981\u53d1\u51fa\u4e00\u4e2a\u5e7f\u64ad\u4e8b\u4ef6\uff0c\u4e0d\u65ad\u7684\u4ece\u4e3b\u5185\u5b58\u55c5\u63a2\u548c CAS \u5faa\u73af\uff0c\u65e0\u6548\u7684\u4ea4\u4e92\u4f1a\u5bfc\u81f4\u603b\u7ebf\u5e26\u5bbd\u8fbe\u5230\u5cf0\u503c\uff1b\u56e0\u6b64\u4e0d\u8981\u5927\u91cf\u4f7f\u7528 volatile \u5173\u952e\u5b57\uff0c\u4f7f\u7528 volatile\u3001syschonized \u90fd\u9700\u8981\u6839\u636e\u5b9e\u9645\u573a\u666f"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"volatile",children:"volatile"}),"\n",(0,r.jsx)(e.h4,{id:"\u540c\u6b65\u673a\u5236",children:"\u540c\u6b65\u673a\u5236"}),"\n",(0,r.jsxs)(e.p,{children:["volatile \u662f Java \u865a\u62df\u673a\u63d0\u4f9b\u7684",(0,r.jsx)(e.strong,{children:"\u8f7b\u91cf\u7ea7"}),"\u7684\u540c\u6b65\u673a\u5236\uff08\u4e09\u5927\u7279\u6027\uff09"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4fdd\u8bc1\u53ef\u89c1\u6027"}),"\n",(0,r.jsx)(e.li,{children:"\u4e0d\u4fdd\u8bc1\u539f\u5b50\u6027"}),"\n",(0,r.jsx)(e.li,{children:"\u4fdd\u8bc1\u6709\u5e8f\u6027\uff08\u7981\u6b62\u6307\u4ee4\u91cd\u6392\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6027\u80fd\uff1avolatile \u4fee\u9970\u7684\u53d8\u91cf\u8fdb\u884c\u8bfb\u64cd\u4f5c\u4e0e\u666e\u901a\u53d8\u91cf\u51e0\u4e4e\u6ca1\u4ec0\u4e48\u5dee\u522b\uff0c\u4f46\u662f\u5199\u64cd\u4f5c\u76f8\u5bf9\u6162\u4e00\u4e9b\uff0c\u56e0\u4e3a\u9700\u8981\u5728\u672c\u5730\u4ee3\u7801\u4e2d\u63d2\u5165\u5f88\u591a\u5185\u5b58\u5c4f\u969c\u6765\u4fdd\u8bc1\u6307\u4ee4\u4e0d\u4f1a\u53d1\u751f\u4e71\u5e8f\u6267\u884c\uff0c\u4f46\u662f\u5f00\u9500\u6bd4\u9501\u8981\u5c0f"}),"\n",(0,r.jsx)(e.p,{children:"synchronized \u65e0\u6cd5\u7981\u6b62\u6307\u4ee4\u91cd\u6392\u548c\u5904\u7406\u5668\u4f18\u5316\uff0c\u4e3a\u4ec0\u4e48\u53ef\u4ee5\u4fdd\u8bc1\u6709\u5e8f\u6027\u53ef\u89c1\u6027"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u52a0\u4e86\u9501\u4e4b\u540e\uff0c\u53ea\u80fd\u6709\u4e00\u4e2a\u7ebf\u7a0b\u83b7\u5f97\u5230\u4e86\u9501\uff0c\u83b7\u5f97\u4e0d\u5230\u9501\u7684\u7ebf\u7a0b\u5c31\u8981\u963b\u585e\uff0c\u6240\u4ee5\u540c\u4e00\u65f6\u95f4\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\uff0c\u76f8\u5f53\u4e8e\u5355\u7ebf\u7a0b\uff0c\u7531\u4e8e\u6570\u636e\u4f9d\u8d56\u6027\u7684\u5b58\u5728\uff0c\u5355\u7ebf\u7a0b\u7684\u6307\u4ee4\u91cd\u6392\u662f\u6ca1\u6709\u95ee\u9898\u7684"}),"\n",(0,r.jsxs)(e.li,{children:["\u7ebf\u7a0b\u52a0\u9501\u524d\uff0c\u5c06",(0,r.jsx)(e.strong,{children:"\u6e05\u7a7a\u5de5\u4f5c\u5185\u5b58"}),"\u4e2d\u5171\u4eab\u53d8\u91cf\u7684\u503c\uff0c\u4f7f\u7528\u5171\u4eab\u53d8\u91cf\u65f6\u9700\u8981\u4ece\u4e3b\u5185\u5b58\u4e2d\u91cd\u65b0\u8bfb\u53d6\u6700\u65b0\u7684\u503c\uff1b\u7ebf\u7a0b\u89e3\u9501\u524d\uff0c\u5fc5\u987b\u628a\u5171\u4eab\u53d8\u91cf\u7684\u6700\u65b0\u503c",(0,r.jsx)(e.strong,{children:"\u5237\u65b0\u5230\u4e3b\u5185\u5b58"}),"\u4e2d\uff08JMM \u5185\u5b58\u4ea4\u4e92\u7ae0\u8282\u6709\u8bb2\uff09"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6307\u4ee4\u91cd\u6392",children:"\u6307\u4ee4\u91cd\u6392"}),"\n",(0,r.jsx)(e.p,{children:"volatile \u4fee\u9970\u7684\u53d8\u91cf\uff0c\u53ef\u4ee5\u7981\u7528\u6307\u4ee4\u91cd\u6392"}),"\n",(0,r.jsx)(e.p,{children:"\u6307\u4ee4\u91cd\u6392\u5b9e\u4f8b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"example 1\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void mySort() {\n\tint x = 11;\t//\u8bed\u53e51\n\tint y = 12;\t//\u8bed\u53e52  \u8c01\u5148\u6267\u884c\u6548\u679c\u4e00\u6837\n\tx = x + 5;\t//\u8bed\u53e53\n\ty = x * x;\t//\u8bed\u53e54\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u6267\u884c\u987a\u5e8f\u662f\uff1a1 2 3 4\u30012 1 3 4\u30011 3 2 4"}),"\n",(0,r.jsx)(e.p,{children:"\u6307\u4ee4\u91cd\u6392\u4e5f\u6709\u9650\u5236\u4e0d\u4f1a\u51fa\u73b0\uff1a4321\uff0c\u8bed\u53e5 4 \u9700\u8981\u4f9d\u8d56\u4e8e y \u4ee5\u53ca x \u7684\u7533\u660e\uff0c\u56e0\u4e3a\u5b58\u5728\u6570\u636e\u4f9d\u8d56\uff0c\u65e0\u6cd5\u9996\u5148\u6267\u884c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"example 2\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"int num = 0;\nboolean ready = false;\n// \u7ebf\u7a0b1 \u6267\u884c\u6b64\u65b9\u6cd5\npublic void actor1(I_Result r) {\n    if(ready) {\n    \tr.r1 = num + num;\n    } else {\n    \tr.r1 = 1;\n    }\n}\n// \u7ebf\u7a0b2 \u6267\u884c\u6b64\u65b9\u6cd5\npublic void actor2(I_Result r) {\n\tnum = 2;\n\tready = true;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u60c5\u51b5\u4e00\uff1a\u7ebf\u7a0b 1 \u5148\u6267\u884c\uff0cready = false\uff0c\u7ed3\u679c\u4e3a r.r1 = 1"}),"\n",(0,r.jsx)(e.p,{children:"\u60c5\u51b5\u4e8c\uff1a\u7ebf\u7a0b 2 \u5148\u6267\u884c num = 2\uff0c\u4f46\u8fd8\u6ca1\u6267\u884c ready = true\uff0c\u7ebf\u7a0b 1 \u6267\u884c\uff0c\u7ed3\u679c\u4e3a r.r1 = 1"}),"\n",(0,r.jsx)(e.p,{children:"\u60c5\u51b5\u4e09\uff1a\u7ebf\u7a0b 2 \u5148\u6267\u884c ready = true\uff0c\u7ebf\u7a0b 1 \u6267\u884c\uff0c\u8fdb\u5165 if \u5206\u652f\u7ed3\u679c\u4e3a r.r1 = 4"}),"\n",(0,r.jsx)(e.p,{children:"\u60c5\u51b5\u56db\uff1a\u7ebf\u7a0b 2 \u6267\u884c ready = true\uff0c\u5207\u6362\u5230\u7ebf\u7a0b 1\uff0c\u8fdb\u5165 if \u5206\u652f\u4e3a r.r1 = 0\uff0c\u518d\u5207\u56de\u7ebf\u7a0b 2 \u6267\u884c num = 2\uff0c\u53d1\u751f\u6307\u4ee4\u91cd\u6392"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5e95\u5c42\u539f\u7406",children:"\u5e95\u5c42\u539f\u7406"}),"\n",(0,r.jsx)(e.h5,{id:"\u7f13\u5b58\u4e00\u81f4-1",children:"\u7f13\u5b58\u4e00\u81f4"}),"\n",(0,r.jsx)(e.p,{children:"\u4f7f\u7528 volatile \u4fee\u9970\u7684\u5171\u4eab\u53d8\u91cf\uff0c\u5e95\u5c42\u901a\u8fc7\u6c47\u7f16 lock \u524d\u7f00\u6307\u4ee4\u8fdb\u884c\u7f13\u5b58\u9501\u5b9a\uff0c\u5728\u7ebf\u7a0b\u4fee\u6539\u5b8c\u5171\u4eab\u53d8\u91cf\u540e\u5199\u56de\u4e3b\u5b58\uff0c\u5176\u4ed6\u7684 CPU \u6838\u5fc3\u4e0a\u8fd0\u884c\u7684\u7ebf\u7a0b\u901a\u8fc7 CPU \u603b\u7ebf\u55c5\u63a2\u673a\u5236\u4f1a\u4fee\u6539\u5176\u5171\u4eab\u53d8\u91cf\u4e3a\u5931\u6548\u72b6\u6001\uff0c\u8bfb\u53d6\u65f6\u4f1a\u91cd\u65b0\u4ece\u4e3b\u5185\u5b58\u4e2d\u8bfb\u53d6\u6700\u65b0\u7684\u6570\u636e"}),"\n",(0,r.jsx)(e.p,{children:"lock \u524d\u7f00\u6307\u4ee4\u5c31\u76f8\u5f53\u4e8e\u5185\u5b58\u5c4f\u969c\uff0cMemory Barrier\uff08Memory Fence\uff09"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5bf9 volatile \u53d8\u91cf\u7684\u5199\u6307\u4ee4\u540e\u4f1a\u52a0\u5165\u5199\u5c4f\u969c"}),"\n",(0,r.jsx)(e.li,{children:"\u5bf9 volatile \u53d8\u91cf\u7684\u8bfb\u6307\u4ee4\u524d\u4f1a\u52a0\u5165\u8bfb\u5c4f\u969c"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5185\u5b58\u5c4f\u969c\u6709\u4e09\u4e2a\u4f5c\u7528\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u786e\u4fdd\u5bf9\u5185\u5b58\u7684\u8bfb-\u6539-\u5199\u64cd\u4f5c\u539f\u5b50\u6267\u884c"}),"\n",(0,r.jsx)(e.li,{children:"\u963b\u6b62\u5c4f\u969c\u4e24\u4fa7\u7684\u6307\u4ee4\u91cd\u6392\u5e8f"}),"\n",(0,r.jsx)(e.li,{children:"\u5f3a\u5236\u628a\u7f13\u5b58\u4e2d\u7684\u810f\u6570\u636e\u5199\u56de\u4e3b\u5185\u5b58\uff0c\u8ba9\u7f13\u5b58\u884c\u4e2d\u76f8\u5e94\u7684\u6570\u636e\u5931\u6548"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5185\u5b58\u5c4f\u969c",children:"\u5185\u5b58\u5c4f\u969c"}),"\n",(0,r.jsxs)(e.p,{children:["\u4fdd\u8bc1",(0,r.jsx)(e.strong,{children:"\u53ef\u89c1\u6027"}),"\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5199\u5c4f\u969c\uff08sfence\uff0cStore Barrier\uff09\u4fdd\u8bc1\u5728\u8be5\u5c4f\u969c\u4e4b\u524d\u7684\uff0c\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u6539\u52a8\uff0c\u90fd\u540c\u6b65\u5230\u4e3b\u5b58\u5f53\u4e2d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void actor2(I_Result r) {\n    num = 2;\n    ready = true; // ready \u662f volatile \u8d4b\u503c\u5e26\u5199\u5c4f\u969c\n    // \u5199\u5c4f\u969c\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bfb\u5c4f\u969c\uff08lfence\uff0cLoad Barrier\uff09\u4fdd\u8bc1\u5728\u8be5\u5c4f\u969c\u4e4b\u540e\u7684\uff0c\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u8bfb\u53d6\uff0c\u4ece\u4e3b\u5b58\u5237\u65b0\u53d8\u91cf\u503c\uff0c\u52a0\u8f7d\u7684\u662f\u4e3b\u5b58\u4e2d\u6700\u65b0\u6570\u636e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void actor1(I_Result r) {\n    // \u8bfb\u5c4f\u969c\n    // ready \u662f volatile \u8bfb\u53d6\u503c\u5e26\u8bfb\u5c4f\u969c\n    if(ready) {\n    \tr.r1 = num + num;\n    } else {\n    \tr.r1 = 1;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(2316).A+"",width:"889",height:"509"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5168\u80fd\u5c4f\u969c\uff1amfence\uff08modify/mix Barrier\uff09\uff0c\u517c\u5177 sfence \u548c lfence \u7684\u529f\u80fd"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u4fdd\u8bc1",(0,r.jsx)(e.strong,{children:"\u6709\u5e8f\u6027"}),"\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5199\u5c4f\u969c\u4f1a\u786e\u4fdd\u6307\u4ee4\u91cd\u6392\u5e8f\u65f6\uff0c\u4e0d\u4f1a\u5c06\u5199\u5c4f\u969c\u4e4b\u524d\u7684\u4ee3\u7801\u6392\u5728\u5199\u5c4f\u969c\u4e4b\u540e"}),"\n",(0,r.jsx)(e.li,{children:"\u8bfb\u5c4f\u969c\u4f1a\u786e\u4fdd\u6307\u4ee4\u91cd\u6392\u5e8f\u65f6\uff0c\u4e0d\u4f1a\u5c06\u8bfb\u5c4f\u969c\u4e4b\u540e\u7684\u4ee3\u7801\u6392\u5728\u8bfb\u5c4f\u969c\u4e4b\u524d"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u80fd\u89e3\u51b3\u6307\u4ee4\u4ea4\u9519\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5199\u5c4f\u969c\u4ec5\u4ec5\u662f\u4fdd\u8bc1\u4e4b\u540e\u7684\u8bfb\u80fd\u591f\u8bfb\u5230\u6700\u65b0\u7684\u7ed3\u679c\uff0c\u4f46\u4e0d\u80fd\u4fdd\u8bc1\u5176\u4ed6\u7ebf\u7a0b\u7684\u8bfb\u8dd1\u5230\u5199\u5c4f\u969c\u4e4b\u524d"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6709\u5e8f\u6027\u7684\u4fdd\u8bc1\u4e5f\u53ea\u662f\u4fdd\u8bc1\u4e86\u672c\u7ebf\u7a0b\u5185\u76f8\u5173\u4ee3\u7801\u4e0d\u88ab\u91cd\u6392\u5e8f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"volatile i = 0;\nnew Thread(() -> {i++});\nnew Thread(() -> {i--});\n"})}),"\n",(0,r.jsx)(e.p,{children:"i++ \u53cd\u7f16\u8bd1\u540e\u7684\u6307\u4ee4\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"0: iconst_1\t\t\t// \u5f53int\u53d6\u503c -1~5 \u65f6\uff0cJVM\u91c7\u7528iconst\u6307\u4ee4\u5c06\u5e38\u91cf\u538b\u5165\u6808\u4e2d\n1: istore_1\t\t\t// \u5c06\u64cd\u4f5c\u6570\u6808\u9876\u6570\u636e\u5f39\u51fa\uff0c\u5b58\u5165\u5c40\u90e8\u53d8\u91cf\u8868\u7684 slot 1\n2: iinc\t\t1, 1\t\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(37609).A+"",width:"948",height:"573"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u4ea4\u4e92\u89c4\u5219",children:"\u4ea4\u4e92\u89c4\u5219"}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u4e8e volatile \u4fee\u9970\u7684\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u5bf9\u53d8\u91cf\u7684 use \u4e0e load\u3001read \u64cd\u4f5c\u662f\u76f8\u5173\u8054\u7684\uff0c\u6240\u4ee5\u53d8\u91cf\u4f7f\u7528\u524d\u5fc5\u987b\u5148\u4ece\u4e3b\u5b58\u52a0\u8f7d"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u5bf9\u53d8\u91cf\u7684 assign \u4e0e store\u3001write \u64cd\u4f5c\u662f\u76f8\u5173\u8054\u7684\uff0c\u6240\u4ee5\u53d8\u91cf\u4f7f\u7528\u540e\u5fc5\u987b\u540c\u6b65\u81f3\u4e3b\u5b58"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b 1 \u548c\u7ebf\u7a0b 2 \u8c01\u5148\u5bf9\u53d8\u91cf\u6267\u884c read \u64cd\u4f5c\uff0c\u5c31\u4f1a\u5148\u8fdb\u884c write \u64cd\u4f5c\uff0c\u9632\u6b62\u6307\u4ee4\u91cd\u6392"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u53cc\u7aef\u68c0\u9501",children:"\u53cc\u7aef\u68c0\u9501"}),"\n",(0,r.jsx)(e.h5,{id:"\u68c0\u9501\u673a\u5236",children:"\u68c0\u9501\u673a\u5236"}),"\n",(0,r.jsx)(e.p,{children:"Double-Checked Locking\uff1a\u53cc\u7aef\u68c0\u9501\u673a\u5236"}),"\n",(0,r.jsx)(e.p,{children:"DCL\uff08\u53cc\u7aef\u68c0\u9501\uff09\u673a\u5236\u4e0d\u4e00\u5b9a\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u539f\u56e0\u662f\u6709\u6307\u4ee4\u91cd\u6392\u7684\u5b58\u5728\uff0c\u52a0\u5165 volatile \u53ef\u4ee5\u7981\u6b62\u6307\u4ee4\u91cd\u6392"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final class Singleton {\n    private Singleton() { }\n    private static Singleton INSTANCE = null;\n    \n    public static Singleton getInstance() {\n        if(INSTANCE == null) { // t2\uff0c\u8fd9\u91cc\u7684\u5224\u65ad\u4e0d\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\n            // \u9996\u6b21\u8bbf\u95ee\u4f1a\u540c\u6b65\uff0c\u800c\u4e4b\u540e\u7684\u4f7f\u7528\u6ca1\u6709 synchronized\n            synchronized(Singleton.class) {\n                // \u8fd9\u91cc\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u5224\u65ad\uff0c\u9632\u6b62\u5176\u4ed6\u7ebf\u7a0b\u5728\u5f53\u524d\u7ebf\u7a0b\u7b49\u5f85\u9501\u7684\u671f\u95f4\u5b8c\u6210\u4e86\u521d\u59cb\u5316\n                if (INSTANCE == null) { \n                    INSTANCE = new Singleton();\n                }\n            }\n        }\n        return INSTANCE;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u9501 INSTANCE \u7684\u539f\u56e0\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"INSTANCE \u8981\u91cd\u65b0\u8d4b\u503c"}),"\n",(0,r.jsx)(e.li,{children:"INSTANCE \u662f null\uff0c\u7ebf\u7a0b\u52a0\u9501\u4e4b\u524d\u9700\u8981\u83b7\u53d6\u5bf9\u8c61\u7684\u5f15\u7528\uff0c\u8bbe\u7f6e\u5bf9\u8c61\u5934\uff0cnull \u6ca1\u6709\u5f15\u7528"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5b9e\u73b0\u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u61d2\u60f0\u521d\u59cb\u5316"}),"\n",(0,r.jsx)(e.li,{children:"\u9996\u6b21\u4f7f\u7528 getInstance() \u624d\u4f7f\u7528 synchronized \u52a0\u9501\uff0c\u540e\u7eed\u4f7f\u7528\u65f6\u65e0\u9700\u52a0\u9501"}),"\n",(0,r.jsx)(e.li,{children:"\u7b2c\u4e00\u4e2a if \u4f7f\u7528\u4e86 INSTANCE \u53d8\u91cf\uff0c\u662f\u5728\u540c\u6b65\u5757\u4e4b\u5916\uff0c\u4f46\u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u4f1a\u4ea7\u751f\u95ee\u9898"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"dcl\u95ee\u9898",children:"DCL\u95ee\u9898"}),"\n",(0,r.jsx)(e.p,{children:"getInstance \u65b9\u6cd5\u5bf9\u5e94\u7684\u5b57\u8282\u7801\u4e3a\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'0: \tgetstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\n3: \tifnonnull \t\t37\n6: \tldc \t\t\t#3 \t\t// class test/Singleton\n8: \tdup\n9: \tastore_0\n10: monitorenter\n11: getstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\n14: ifnonnull 27\n17: new \t\t\t#3 \t\t// class test/Singleton\n20: dup\n21: invokespecial \t#4 \t\t// Method "<init>":()V\n24: putstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\n27: aload_0\n28: monitorexit\n29: goto 37\n32: astore_1\n33: aload_0\n34: monitorexit\n35: aload_1\n36: athrow\n37: getstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\n40: areturn\n'})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"17 \u8868\u793a\u521b\u5efa\u5bf9\u8c61\uff0c\u5c06\u5bf9\u8c61\u5f15\u7528\u5165\u6808"}),"\n",(0,r.jsx)(e.li,{children:"20 \u8868\u793a\u590d\u5236\u4e00\u4efd\u5bf9\u8c61\u5f15\u7528\uff0c\u5f15\u7528\u5730\u5740"}),"\n",(0,r.jsx)(e.li,{children:"21 \u8868\u793a\u5229\u7528\u4e00\u4e2a\u5bf9\u8c61\u5f15\u7528\uff0c\u8c03\u7528\u6784\u9020\u65b9\u6cd5\u521d\u59cb\u5316\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.li,{children:"24 \u8868\u793a\u5229\u7528\u4e00\u4e2a\u5bf9\u8c61\u5f15\u7528\uff0c\u8d4b\u503c\u7ed9 static INSTANCE"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u6b65\u9aa4 21 \u548c 24 \u4e4b\u95f4\u4e0d\u5b58\u5728\u6570\u636e\u4f9d\u8d56\u5173\u7cfb"}),"\uff0c\u800c\u4e14\u65e0\u8bba\u91cd\u6392\u524d\u540e\uff0c\u7a0b\u5e8f\u7684\u6267\u884c\u7ed3\u679c\u5728\u5355\u7ebf\u7a0b\u4e2d\u5e76\u6ca1\u6709\u6539\u53d8\uff0c\u56e0\u6b64\u8fd9\u79cd\u91cd\u6392\u4f18\u5316\u662f\u5141\u8bb8\u7684"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5173\u952e\u5728\u4e8e 0:getstatic \u8fd9\u884c\u4ee3\u7801\u5728 monitor \u63a7\u5236\u4e4b\u5916\uff0c\u53ef\u4ee5\u8d8a\u8fc7 monitor \u8bfb\u53d6 INSTANCE \u53d8\u91cf\u7684\u503c"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53\u5176\u4ed6\u7ebf\u7a0b\u8bbf\u95ee INSTANCE \u4e0d\u4e3a null \u65f6\uff0c\u7531\u4e8e INSTANCE \u5b9e\u4f8b\u672a\u5fc5\u5df2\u521d\u59cb\u5316\uff0c\u90a3\u4e48 t2 \u62ff\u5230\u7684\u662f\u5c06\u662f\u4e00\u4e2a\u672a\u521d\u59cb\u5316\u5b8c\u6bd5\u7684\u5355\u4f8b\u8fd4\u56de\uff0c\u8fd9\u5c31\u9020\u6210\u4e86\u7ebf\u7a0b\u5b89\u5168\u7684\u95ee\u9898"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(42018).A+"",width:"1213",height:"656"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u89e3\u51b3\u65b9\u6cd5",children:"\u89e3\u51b3\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u6307\u4ee4\u91cd\u6392\u53ea\u4f1a\u4fdd\u8bc1\u4e32\u884c\u8bed\u4e49\u7684\u6267\u884c\u4e00\u81f4\u6027\uff08\u5355\u7ebf\u7a0b\uff09\uff0c\u4f46\u5e76\u4e0d\u4f1a\u5173\u7cfb\u591a\u7ebf\u7a0b\u95f4\u7684\u8bed\u4e49\u4e00\u81f4\u6027"}),"\n",(0,r.jsx)(e.p,{children:"\u5f15\u5165 volatile\uff0c\u6765\u4fdd\u8bc1\u51fa\u73b0\u6307\u4ee4\u91cd\u6392\u7684\u95ee\u9898\uff0c\u4ece\u800c\u4fdd\u8bc1\u5355\u4f8b\u6a21\u5f0f\u7684\u7ebf\u7a0b\u5b89\u5168\u6027\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static volatile SingletonDemo INSTANCE = null;\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"ha-be",children:"ha-be"}),"\n",(0,r.jsx)(e.p,{children:"happens-before \u5148\u884c\u53d1\u751f"}),"\n",(0,r.jsx)(e.p,{children:"Java \u5185\u5b58\u6a21\u578b\u5177\u5907\u4e00\u4e9b\u5148\u5929\u7684\u201c\u6709\u5e8f\u6027\u201d\uff0c\u5373\u4e0d\u9700\u8981\u901a\u8fc7\u4efb\u4f55\u540c\u6b65\u624b\u6bb5\uff08volatile\u3001synchronized \u7b49\uff09\u5c31\u80fd\u591f\u5f97\u5230\u4fdd\u8bc1\u7684\u5b89\u5168\uff0c\u8fd9\u4e2a\u901a\u5e38\u4e5f\u79f0\u4e3a happens-before \u539f\u5219\uff0c\u5b83\u662f\u53ef\u89c1\u6027\u4e0e\u6709\u5e8f\u6027\u7684\u4e00\u5957\u89c4\u5219\u603b\u7ed3"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u7b26\u5408 happens-before \u89c4\u5219\uff0cJMM \u5e76\u4e0d\u80fd\u4fdd\u8bc1\u4e00\u4e2a\u7ebf\u7a0b\u7684\u53ef\u89c1\u6027\u548c\u6709\u5e8f\u6027"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7a0b\u5e8f\u6b21\u5e8f\u89c4\u5219 (Program Order Rule)\uff1a\u4e00\u4e2a\u7ebf\u7a0b\u5185\uff0c\u903b\u8f91\u4e0a\u4e66\u5199\u5728\u524d\u9762\u7684\u64cd\u4f5c\u5148\u884c\u53d1\u751f\u4e8e\u4e66\u5199\u5728\u540e\u9762\u7684\u64cd\u4f5c \uff0c\u56e0\u4e3a\u591a\u4e2a\u64cd\u4f5c\u4e4b\u95f4\u6709\u5148\u540e\u4f9d\u8d56\u5173\u7cfb\uff0c\u5219\u4e0d\u5141\u8bb8\u5bf9\u8fd9\u4e9b\u64cd\u4f5c\u8fdb\u884c\u91cd\u6392\u5e8f"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u9501\u5b9a\u89c4\u5219 (Monitor Lock Rule)\uff1a\u4e00\u4e2a unlock \u64cd\u4f5c\u5148\u884c\u53d1\u751f\u4e8e\u540e\u9762\uff08\u65f6\u95f4\u7684\u5148\u540e\uff09\u5bf9\u540c\u4e00\u4e2a\u9501\u7684 lock \u64cd\u4f5c\uff0c\u6240\u4ee5\u7ebf\u7a0b\u89e3\u9501 m \u4e4b\u524d\u5bf9\u53d8\u91cf\u7684\u5199\uff08\u89e3\u9501\u524d\u4f1a\u5237\u65b0\u5230\u4e3b\u5185\u5b58\u4e2d\uff09\uff0c\u5bf9\u4e8e\u63a5\u4e0b\u6765\u5bf9 m \u52a0\u9501\u7684\u5176\u5b83\u7ebf\u7a0b\u5bf9\u8be5\u53d8\u91cf\u7684\u8bfb\u53ef\u89c1"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"volatile \u53d8\u91cf\u89c4\u5219"}),"  (Volatile Variable Rule)\uff1a\u5bf9 volatile \u53d8\u91cf\u7684\u5199\u64cd\u4f5c\u5148\u884c\u53d1\u751f\u4e8e\u540e\u9762\u5bf9\u8fd9\u4e2a\u53d8\u91cf\u7684\u8bfb"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4f20\u9012\u89c4\u5219 (Transitivity)\uff1a\u5177\u6709\u4f20\u9012\u6027\uff0c\u5982\u679c\u64cd\u4f5c A \u5148\u884c\u53d1\u751f\u4e8e\u64cd\u4f5c B\uff0c\u800c\u64cd\u4f5c B \u53c8\u5148\u884c\u53d1\u751f\u4e8e\u64cd\u4f5c C\uff0c\u5219\u53ef\u4ee5\u5f97\u51fa\u64cd\u4f5c A \u5148\u884c\u53d1\u751f\u4e8e\u64cd\u4f5c C"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u542f\u52a8\u89c4\u5219 (Thread Start Rule)\uff1aThread \u5bf9\u8c61\u7684 start()\u65b9 \u6cd5\u5148\u884c\u53d1\u751f\u4e8e\u6b64\u7ebf\u7a0b\u4e2d\u7684\u6bcf\u4e00\u4e2a\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'static int x = 10;//\u7ebf\u7a0b start \u524d\u5bf9\u53d8\u91cf\u7684\u5199\uff0c\u5bf9\u8be5\u7ebf\u7a0b\u5f00\u59cb\u540e\u5bf9\u8be5\u53d8\u91cf\u7684\u8bfb\u53ef\u89c1\nnew Thread(()->{\tSystem.out.println(x);\t},"t1").start();\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u4e2d\u65ad\u89c4\u5219 (Thread Interruption Rule)\uff1a\u5bf9\u7ebf\u7a0b interrupt() \u65b9\u6cd5\u7684\u8c03\u7528\u5148\u884c\u53d1\u751f\u4e8e\u88ab\u4e2d\u65ad\u7ebf\u7a0b\u7684\u4ee3\u7801\u68c0\u6d4b\u5230\u4e2d\u65ad\u4e8b\u4ef6\u7684\u53d1\u751f"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u7ec8\u6b62\u89c4\u5219 (Thread Termination Rule)\uff1a\u7ebf\u7a0b\u4e2d\u6240\u6709\u7684\u64cd\u4f5c\u90fd\u5148\u884c\u53d1\u751f\u4e8e\u7ebf\u7a0b\u7684\u7ec8\u6b62\u68c0\u6d4b\uff0c\u53ef\u4ee5\u901a\u8fc7 Thread.join() \u65b9\u6cd5\u7ed3\u675f\u3001Thread.isAlive() \u7684\u8fd4\u56de\u503c\u624b\u6bb5\u68c0\u6d4b\u5230\u7ebf\u7a0b\u5df2\u7ecf\u7ec8\u6b62\u6267\u884c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5bf9\u8c61\u7ec8\u7ed3\u89c4\u5219\uff08Finaizer Rule\uff09\uff1a\u4e00\u4e2a\u5bf9\u8c61\u7684\u521d\u59cb\u5316\u5b8c\u6210\uff08\u6784\u9020\u51fd\u6570\u6267\u884c\u7ed3\u675f\uff09\u5148\u884c\u53d1\u751f\u4e8e\u5b83\u7684 finalize() \u65b9\u6cd5\u7684\u5f00\u59cb"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u8bbe\u8ba1\u6a21\u5f0f",children:"\u8bbe\u8ba1\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.h4,{id:"\u7ec8\u6b62\u6a21\u5f0f-1",children:"\u7ec8\u6b62\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"\u7ec8\u6b62\u6a21\u5f0f\u4e4b\u4e24\u9636\u6bb5\u7ec8\u6b62\u6a21\u5f0f\uff1a\u505c\u6b62\u6807\u8bb0\u7528 volatile \u662f\u4e3a\u4e86\u4fdd\u8bc1\u8be5\u53d8\u91cf\u5728\u591a\u4e2a\u7ebf\u7a0b\u4e4b\u95f4\u7684\u53ef\u89c1\u6027"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'class TwoPhaseTermination {\n    // \u76d1\u63a7\u7ebf\u7a0b\n    private Thread monitor;\n    // \u505c\u6b62\u6807\u8bb0\n    private volatile boolean stop = false;;\n\n    // \u542f\u52a8\u76d1\u63a7\u7ebf\u7a0b\n    public void start() {\n        monitor = new Thread(() -> {\n            while (true) {\n                Thread thread = Thread.currentThread();\n                if (stop) {\n                    System.out.println("\u540e\u7f6e\u5904\u7406");\n                    break;\n                }\n                try {\n                    Thread.sleep(1000);// \u7761\u7720\n                    System.out.println(thread.getName() + "\u6267\u884c\u76d1\u63a7\u8bb0\u5f55");\n                } catch (InterruptedException e) {\n                   \tSystem.out.println("\u88ab\u6253\u65ad\uff0c\u9000\u51fa\u7761\u7720");\n                }\n            }\n        });\n        monitor.start();\n    }\n\n    // \u505c\u6b62\u76d1\u63a7\u7ebf\u7a0b\n    public void stop() {\n        stop = true;\n        monitor.interrupt();// \u8ba9\u7ebf\u7a0b\u5c3d\u5feb\u9000\u51faTimed Waiting\n    }\n}\n// \u6d4b\u8bd5\npublic static void main(String[] args) throws InterruptedException {\n    TwoPhaseTermination tpt = new TwoPhaseTermination();\n    tpt.start();\n    Thread.sleep(3500);\n    System.out.println("\u505c\u6b62\u76d1\u63a7");\n    tpt.stop();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"balking",children:"Balking"}),"\n",(0,r.jsx)(e.p,{children:"Balking \uff08\u72b9\u8c6b\uff09\u6a21\u5f0f\u7528\u5728\u4e00\u4e2a\u7ebf\u7a0b\u53d1\u73b0\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u6216\u672c\u7ebf\u7a0b\u5df2\u7ecf\u505a\u4e86\u67d0\u4e00\u4ef6\u76f8\u540c\u7684\u4e8b\uff0c\u90a3\u4e48\u672c\u7ebf\u7a0b\u5c31\u65e0\u9700\u518d\u505a\u4e86\uff0c\u76f4\u63a5\u7ed3\u675f\u8fd4\u56de"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class MonitorService {\n    // \u7528\u6765\u8868\u793a\u662f\u5426\u5df2\u7ecf\u6709\u7ebf\u7a0b\u5df2\u7ecf\u5728\u6267\u884c\u542f\u52a8\u4e86\n    private volatile boolean starting = false;\n    public void start() {\n        System.out.println("\u5c1d\u8bd5\u542f\u52a8\u76d1\u63a7\u7ebf\u7a0b...");\n        synchronized (this) {\n            if (starting) {\n            \treturn;\n            }\n            starting = true;\n        }\n        // \u771f\u6b63\u542f\u52a8\u76d1\u63a7\u7ebf\u7a0b...\n    }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u6bd4\u4fdd\u62a4\u6027\u6682\u505c\u6a21\u5f0f\uff1a\u4fdd\u62a4\u6027\u6682\u505c\u6a21\u5f0f\u7528\u5728\u4e00\u4e2a\u7ebf\u7a0b\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u7684\u6267\u884c\u7ed3\u679c\uff0c\u5f53\u6761\u4ef6\u4e0d\u6ee1\u8db3\u65f6\u7ebf\u7a0b\u7b49\u5f85"}),"\n",(0,r.jsx)(e.p,{children:"\u4f8b\u5b50\uff1a\u5e0c\u671b doInit() \u65b9\u6cd5\u4ec5\u88ab\u8c03\u7528\u4e00\u6b21\uff0c\u4e0b\u9762\u7684\u5b9e\u73b0\u51fa\u73b0\u7684\u95ee\u9898\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53 t1 \u7ebf\u7a0b\u8fdb\u5165 init() \u51c6\u5907 doInit()\uff0ct2 \u7ebf\u7a0b\u8fdb\u6765\uff0cinitialized \u8fd8\u4e3af alse\uff0c\u5219 t2 \u5c31\u53c8\u521d\u59cb\u5316\u4e00\u6b21"}),"\n",(0,r.jsx)(e.li,{children:"volatile \u9002\u5408\u4e00\u4e2a\u7ebf\u7a0b\u5199\uff0c\u5176\u4ed6\u7ebf\u7a0b\u8bfb\u7684\u60c5\u51b5\uff0c\u8fd9\u4e2a\u4ee3\u7801\u9700\u8981\u52a0\u9501"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class TestVolatile {\n    volatile boolean initialized = false;\n    \n    void init() {\n        if (initialized) {\n            return;\n        }\n    \tdoInit();\n    \tinitialized = true;\n    }\n    private void doInit() {\n    }\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u65e0\u9501",children:"\u65e0\u9501"}),"\n",(0,r.jsx)(e.h3,{id:"cas",children:"CAS"}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u7406",children:"\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"\u65e0\u9501\u7f16\u7a0b\uff1aLock Free"}),"\n",(0,r.jsxs)(e.p,{children:["CAS \u7684\u5168\u79f0\u662f Compare-And-Swap\uff0c\u662f ",(0,r.jsx)(e.strong,{children:"CPU \u5e76\u53d1\u539f\u8bed"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"CAS \u5e76\u53d1\u539f\u8bed\u4f53\u73b0\u5728 Java \u8bed\u8a00\u4e2d\u5c31\u662f sun.misc.Unsafe \u7c7b\u7684\u5404\u4e2a\u65b9\u6cd5\uff0c\u8c03\u7528 UnSafe \u7c7b\u4e2d\u7684 CAS \u65b9\u6cd5\uff0cJVM \u4f1a\u5b9e\u73b0\u51fa CAS \u6c47\u7f16\u6307\u4ee4\uff0c\u8fd9\u662f\u4e00\u79cd\u5b8c\u5168\u4f9d\u8d56\u4e8e\u786c\u4ef6\u7684\u529f\u80fd\uff0c\u5b9e\u73b0\u4e86\u539f\u5b50\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.li,{children:"CAS \u662f\u4e00\u79cd\u7cfb\u7edf\u539f\u8bed\uff0c\u539f\u8bed\u5c5e\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u8303\u7574\uff0c\u662f\u7531\u82e5\u5e72\u6761\u6307\u4ee4\u7ec4\u6210 \uff0c\u7528\u4e8e\u5b8c\u6210\u67d0\u4e2a\u529f\u80fd\u7684\u4e00\u4e2a\u8fc7\u7a0b\uff0c\u5e76\u4e14\u539f\u8bed\u7684\u6267\u884c\u5fc5\u987b\u662f\u8fde\u7eed\u7684\uff0c\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u5141\u8bb8\u88ab\u4e2d\u65ad\uff0c\u6240\u4ee5 CAS \u662f\u4e00\u6761 CPU \u7684\u539f\u5b50\u6307\u4ee4\uff0c\u4e0d\u4f1a\u9020\u6210\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\uff0c\u662f\u7ebf\u7a0b\u5b89\u5168\u7684"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5e95\u5c42\u539f\u7406\uff1aCAS \u7684\u5e95\u5c42\u662f ",(0,r.jsx)(e.code,{children:"lock cmpxchg"})," \u6307\u4ee4\uff08X86 \u67b6\u6784\uff09\uff0c\u5728\u5355\u6838\u548c\u591a\u6838 CPU \u4e0b\u90fd\u80fd\u591f\u4fdd\u8bc1\u6bd4\u8f83\u4ea4\u6362\u7684\u539f\u5b50\u6027"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7a0b\u5e8f\u662f\u5728\u5355\u6838\u5904\u7406\u5668\u4e0a\u8fd0\u884c\uff0c\u4f1a\u7701\u7565 lock \u524d\u7f00\uff0c\u5355\u5904\u7406\u5668\u81ea\u8eab\u4f1a\u7ef4\u62a4\u5904\u7406\u5668\u5185\u7684\u987a\u5e8f\u4e00\u81f4\u6027\uff0c\u4e0d\u9700\u8981 lock \u524d\u7f00\u7684\u5185\u5b58\u5c4f\u969c\u6548\u679c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u7a0b\u5e8f\u662f\u5728\u591a\u6838\u5904\u7406\u5668\u4e0a\u8fd0\u884c\uff0c\u4f1a\u4e3a cmpxchg \u6307\u4ee4\u52a0\u4e0a lock \u524d\u7f00\u3002\u5f53\u67d0\u4e2a\u6838\u6267\u884c\u5230\u5e26 lock \u7684\u6307\u4ee4\u65f6\uff0cCPU \u4f1a\u6267\u884c",(0,r.jsx)(e.strong,{children:"\u603b\u7ebf\u9501\u5b9a\u6216\u7f13\u5b58\u9501\u5b9a"}),"\uff0c\u5c06\u4fee\u6539\u7684\u53d8\u91cf\u5199\u5165\u5230\u4e3b\u5b58\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u4f1a\u88ab\u7ebf\u7a0b\u7684\u8c03\u5ea6\u673a\u5236\u6240\u6253\u65ad\uff0c\u4fdd\u8bc1\u4e86\u591a\u4e2a\u7ebf\u7a0b\u5bf9\u5185\u5b58\u64cd\u4f5c\u7684\u539f\u5b50\u6027"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4f5c\u7528\uff1a\u6bd4\u8f83\u5f53\u524d\u5de5\u4f5c\u5185\u5b58\u4e2d\u7684\u503c\u548c\u4e3b\u7269\u7406\u5185\u5b58\u4e2d\u7684\u503c\uff0c\u5982\u679c\u76f8\u540c\u5219\u6267\u884c\u89c4\u5b9a\u64cd\u4f5c\uff0c\u5426\u5219\u7ee7\u7eed\u6bd4\u8f83\u76f4\u5230\u4e3b\u5185\u5b58\u548c\u5de5\u4f5c\u5185\u5b58\u7684\u503c\u4e00\u81f4\u4e3a\u6b62"}),"\n",(0,r.jsx)(e.p,{children:"CAS \u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["CAS \u4f53\u73b0\u7684\u662f",(0,r.jsx)(e.strong,{children:"\u65e0\u9501\u5e76\u53d1\u3001\u65e0\u963b\u585e\u5e76\u53d1"}),"\uff0c\u7ebf\u7a0b\u4e0d\u4f1a\u9677\u5165\u963b\u585e\uff0c\u7ebf\u7a0b\u4e0d\u9700\u8981\u9891\u7e41\u5207\u6362\u72b6\u6001\uff08\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u7cfb\u7edf\u8c03\u7528\uff09"]}),"\n",(0,r.jsx)(e.li,{children:"CAS \u662f\u57fa\u4e8e\u4e50\u89c2\u9501\u7684\u601d\u60f3"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"CAS \u7f3a\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u6267\u884c\u7684\u662f\u5faa\u73af\u64cd\u4f5c\uff0c\u5982\u679c\u6bd4\u8f83\u4e0d\u6210\u529f\u4e00\u76f4\u5728\u5faa\u73af\uff0c\u6700\u5dee\u7684\u60c5\u51b5\u67d0\u4e2a\u7ebf\u7a0b\u4e00\u76f4\u53d6\u5230\u7684\u503c\u548c\u9884\u671f\u503c\u90fd\u4e0d\u4e00\u6837\uff0c\u5c31\u4f1a\u65e0\u9650\u5faa\u73af\u5bfc\u81f4\u9965\u997f\uff0c",(0,r.jsx)(e.strong,{children:"\u4f7f\u7528 CAS \u7ebf\u7a0b\u6570\u4e0d\u8981\u8d85\u8fc7 CPU \u7684\u6838\u5fc3\u6570"}),"\uff0c\u91c7\u7528\u5206\u6bb5 CAS \u548c\u81ea\u52a8\u8fc1\u79fb\u673a\u5236"]}),"\n",(0,r.jsxs)(e.li,{children:["\u53ea\u80fd\u4fdd\u8bc1\u4e00\u4e2a\u5171\u4eab\u53d8\u91cf\u7684\u539f\u5b50\u64cd\u4f5c\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5bf9\u4e8e\u4e00\u4e2a\u5171\u4eab\u53d8\u91cf\u6267\u884c\u64cd\u4f5c\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u5faa\u73af CAS \u7684\u65b9\u5f0f\u6765\u4fdd\u8bc1\u539f\u5b50\u64cd\u4f5c"}),"\n",(0,r.jsxs)(e.li,{children:["\u5bf9\u4e8e\u591a\u4e2a\u5171\u4eab\u53d8\u91cf\u64cd\u4f5c\u65f6\uff0c\u5faa\u73af CAS \u5c31\u65e0\u6cd5\u4fdd\u8bc1\u64cd\u4f5c\u7684\u539f\u5b50\u6027\uff0c\u8fd9\u4e2a\u65f6\u5019",(0,r.jsx)(e.strong,{children:"\u53ea\u80fd\u7528\u9501\u6765\u4fdd\u8bc1\u539f\u5b50\u6027"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u5f15\u51fa\u6765 ABA \u95ee\u9898"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4e50\u89c2\u9501",children:"\u4e50\u89c2\u9501"}),"\n",(0,r.jsx)(e.p,{children:"CAS \u4e0e synchronized \u603b\u7ed3\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"synchronized \u662f\u4ece\u60b2\u89c2\u7684\u89d2\u5ea6\u51fa\u53d1\uff1a\u603b\u662f\u5047\u8bbe\u6700\u574f\u7684\u60c5\u51b5\uff0c\u6bcf\u6b21\u53bb\u62ff\u6570\u636e\u7684\u65f6\u5019\u90fd\u8ba4\u4e3a\u522b\u4eba\u4f1a\u4fee\u6539\uff0c\u6240\u4ee5\u6bcf\u6b21\u5728\u62ff\u6570\u636e\u7684\u65f6\u5019\u90fd\u4f1a\u4e0a\u9501\uff0c\u8fd9\u6837\u522b\u4eba\u60f3\u62ff\u8fd9\u4e2a\u6570\u636e\u5c31\u4f1a\u963b\u585e\uff08\u5171\u4eab\u8d44\u6e90\u6bcf\u6b21\u53ea\u7ed9\u4e00\u4e2a\u7ebf\u7a0b\u4f7f\u7528\uff0c\u5176\u5b83\u7ebf\u7a0b\u963b\u585e\uff0c\u7528\u5b8c\u540e\u518d\u628a\u8d44\u6e90\u8f6c\u8ba9\u7ed9\u5176\u5b83\u7ebf\u7a0b\uff09\uff0c\u56e0\u6b64 synchronized \u4e5f\u79f0\u4e4b\u4e3a\u60b2\u89c2\u9501\uff0cReentrantLock \u4e5f\u662f\u4e00\u79cd\u60b2\u89c2\u9501\uff0c\u6027\u80fd\u8f83\u5dee"}),"\n",(0,r.jsxs)(e.li,{children:["CAS \u662f\u4ece\u4e50\u89c2\u7684\u89d2\u5ea6\u51fa\u53d1\uff1a\u603b\u662f\u5047\u8bbe\u6700\u597d\u7684\u60c5\u51b5\uff0c\u6bcf\u6b21\u53bb\u62ff\u6570\u636e\u7684\u65f6\u5019\u90fd\u8ba4\u4e3a\u522b\u4eba\u4e0d\u4f1a\u4fee\u6539\uff0c\u6240\u4ee5\u4e0d\u4f1a\u4e0a\u9501\uff0c\u4f46\u662f\u5728\u66f4\u65b0\u7684\u65f6\u5019\u4f1a\u5224\u65ad\u4e00\u4e0b\u5728\u6b64\u671f\u95f4\u522b\u4eba\u6709\u6ca1\u6709\u53bb\u66f4\u65b0\u8fd9\u4e2a\u6570\u636e\u3002",(0,r.jsx)(e.strong,{children:"\u5982\u679c\u522b\u4eba\u4fee\u6539\u8fc7\uff0c\u5219\u83b7\u53d6\u73b0\u5728\u6700\u65b0\u7684\u503c\uff0c\u5982\u679c\u522b\u4eba\u6ca1\u4fee\u6539\u8fc7\uff0c\u76f4\u63a5\u4fee\u6539\u5171\u4eab\u6570\u636e\u7684\u503c"}),"\uff0cCAS \u8fd9\u79cd\u673a\u5236\u4e5f\u79f0\u4e4b\u4e3a\u4e50\u89c2\u9501\uff0c\u7efc\u5408\u6027\u80fd\u8f83\u597d"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"atomic",children:"Atomic"}),"\n",(0,r.jsx)(e.h4,{id:"\u5e38\u7528api",children:"\u5e38\u7528API"}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u89c1\u539f\u5b50\u7c7b\uff1aAtomicInteger\u3001AtomicBoolean\u3001AtomicLong"}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public AtomicInteger()"}),"\uff1a\u521d\u59cb\u5316\u4e00\u4e2a\u9ed8\u8ba4\u503c\u4e3a 0 \u7684\u539f\u5b50\u578b Integer"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public AtomicInteger(int initialValue)"}),"\uff1a\u521d\u59cb\u5316\u4e00\u4e2a\u6307\u5b9a\u503c\u7684\u539f\u5b50\u578b Integer"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528API\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u4f5c\u7528"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int get()"}),(0,r.jsx)(e.td,{children:"\u83b7\u53d6 AtomicInteger \u7684\u503c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int getAndIncrement()"}),(0,r.jsx)(e.td,{children:"\u4ee5\u539f\u5b50\u65b9\u5f0f\u5c06\u5f53\u524d\u503c\u52a0 1\uff0c\u8fd4\u56de\u7684\u662f\u81ea\u589e\u524d\u7684\u503c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int incrementAndGet()"}),(0,r.jsx)(e.td,{children:"\u4ee5\u539f\u5b50\u65b9\u5f0f\u5c06\u5f53\u524d\u503c\u52a0 1\uff0c\u8fd4\u56de\u7684\u662f\u81ea\u589e\u540e\u7684\u503c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int getAndSet(int value)"}),(0,r.jsx)(e.td,{children:"\u4ee5\u539f\u5b50\u65b9\u5f0f\u8bbe\u7f6e\u4e3a newValue \u7684\u503c\uff0c\u8fd4\u56de\u65e7\u503c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int addAndGet(int data)"}),(0,r.jsxs)(e.td,{children:["\u4ee5\u539f\u5b50\u65b9\u5f0f\u5c06\u8f93\u5165\u7684\u6570\u503c\u4e0e\u5b9e\u4f8b\u4e2d\u7684\u503c\u76f8\u52a0\u5e76\u8fd4\u56de",(0,r.jsx)(e.br,{}),"\u5b9e\u4f8b\uff1aAtomicInteger \u91cc\u7684 value"]})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u7406\u5206\u6790",children:"\u539f\u7406\u5206\u6790"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"AtomicInteger \u539f\u7406"}),"\uff1a\u81ea\u65cb\u9501  + CAS \u7b97\u6cd5"]}),"\n",(0,r.jsx)(e.p,{children:"CAS \u7b97\u6cd5\uff1a\u6709 3 \u4e2a\u64cd\u4f5c\u6570\uff08\u5185\u5b58\u503c V\uff0c \u65e7\u7684\u9884\u671f\u503c A\uff0c\u8981\u4fee\u6539\u7684\u503c B\uff09"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53\u65e7\u7684\u9884\u671f\u503c A == \u5185\u5b58\u503c V   \u6b64\u65f6\u53ef\u4ee5\u4fee\u6539\uff0c\u5c06 V \u6539\u4e3a B"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53\u65e7\u7684\u9884\u671f\u503c A !=  \u5185\u5b58\u503c V   \u6b64\u65f6\u4e0d\u80fd\u4fee\u6539\uff0c\u5e76\u91cd\u65b0\u83b7\u53d6\u73b0\u5728\u7684\u6700\u65b0\u503c\uff0c\u91cd\u65b0\u83b7\u53d6\u7684\u52a8\u4f5c\u5c31\u662f\u81ea\u65cb"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5206\u6790 getAndSet \u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"AtomicInteger\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final int getAndSet(int newValue) {\n    /**\n    * this: \t\t\u5f53\u524d\u5bf9\u8c61\n    * valueOffset:\t\u5185\u5b58\u504f\u79fb\u91cf\uff0c\u5185\u5b58\u5730\u5740\n    */\n    return unsafe.getAndSetInt(this, valueOffset, newValue);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"valueOffset\uff1a\u504f\u79fb\u91cf\u8868\u793a\u8be5\u53d8\u91cf\u503c\u76f8\u5bf9\u4e8e\u5f53\u524d\u5bf9\u8c61\u5730\u5740\u7684\u504f\u79fb\uff0cUnsafe \u5c31\u662f\u6839\u636e\u5185\u5b58\u504f\u79fb\u5730\u5740\u83b7\u53d6\u6570\u636e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'valueOffset = unsafe.objectFieldOffset\n                (AtomicInteger.class.getDeclaredField("value"));\n//\u8c03\u7528\u672c\u5730\u65b9\u6cd5   --\x3e\npublic native long objectFieldOffset(Field var1);\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"unsafe \u7c7b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// val1: AtomicInteger\u5bf9\u8c61\u672c\u8eab\uff0cvar2: \u8be5\u5bf9\u8c61\u503c\u5f97\u5f15\u7528\u5730\u5740\uff0cvar4: \u9700\u8981\u53d8\u52a8\u7684\u6570\npublic final int getAndSetInt(Object var1, long var2, int var4) {\n    int var5;\n    do {\n        // var5: \u7528 var1 \u548c var2 \u627e\u5230\u7684\u5185\u5b58\u4e2d\u7684\u771f\u5b9e\u503c\n        var5 = this.getIntVolatile(var1, var2);\n    } while(!this.compareAndSwapInt(var1, var2, var5, var4));\n\n    return var5;\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["var5\uff1a\u4ece\u4e3b\u5185\u5b58\u4e2d\u62f7\u8d1d\u5230\u5de5\u4f5c\u5185\u5b58\u4e2d\u7684\u503c\uff08\u6bcf\u6b21\u90fd\u8981\u4ece\u4e3b\u5185\u5b58\u62ff\u5230\u6700\u65b0\u7684\u503c\u5230\u672c\u5730\u5185\u5b58\uff09\uff0c\u7136\u540e\u6267\u884c ",(0,r.jsx)(e.code,{children:"compareAndSwapInt()"})," \u518d\u548c\u4e3b\u5185\u5b58\u7684\u503c\u8fdb\u884c\u6bd4\u8f83\uff0c\u5047\u8bbe\u65b9\u6cd5\u8fd4\u56de false\uff0c\u90a3\u4e48\u5c31\u4e00\u76f4\u6267\u884c while \u65b9\u6cd5\uff0c\u76f4\u5230\u671f\u671b\u7684\u503c\u548c\u771f\u5b9e\u503c\u4e00\u6837\uff0c\u4fee\u6539\u6570\u636e"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u53d8\u91cf value \u7528 volatile \u4fee\u9970\uff0c\u4fdd\u8bc1\u4e86\u591a\u7ebf\u7a0b\u4e4b\u95f4\u7684\u5185\u5b58\u53ef\u89c1\u6027\uff0c\u907f\u514d\u7ebf\u7a0b\u4ece\u5de5\u4f5c\u7f13\u5b58\u4e2d\u83b7\u53d6\u5931\u6548\u7684\u53d8\u91cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private volatile int value\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"CAS \u5fc5\u987b\u501f\u52a9 volatile \u624d\u80fd\u8bfb\u53d6\u5230\u5171\u4eab\u53d8\u91cf\u7684\u6700\u65b0\u503c\u6765\u5b9e\u73b0\u6bd4\u8f83\u5e76\u4ea4\u6362\u7684\u6548\u679c"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5206\u6790 getAndUpdate \u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"getAndUpdate\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final int getAndUpdate(IntUnaryOperator updateFunction) {\n    int prev, next;\n    do {\n        prev = get();\t//\u5f53\u524d\u503c\uff0ccas\u7684\u671f\u671b\u503c\n        next = updateFunction.applyAsInt(prev);//\u671f\u671b\u503c\u66f4\u65b0\u5230\u8be5\u503c\n    } while (!compareAndSet(prev, next));//\u81ea\u65cb\n    return prev;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u51fd\u6570\u5f0f\u63a5\u53e3\uff1a\u53ef\u4ee5\u81ea\u5b9a\u4e49\u64cd\u4f5c\u903b\u8f91"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"AtomicInteger a = new AtomicInteger();\na.getAndUpdate(i -> i + 10);\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"compareAndSet\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final boolean compareAndSet(int expect, int update) {\n    /**\n    * this: \t\t\u5f53\u524d\u5bf9\u8c61\n    * valueOffset:\t\u5185\u5b58\u504f\u79fb\u91cf\uff0c\u5185\u5b58\u5730\u5740\n    * expect:\t\t\u671f\u671b\u7684\u503c\n    * update: \t\t\u66f4\u65b0\u7684\u503c\n    */\n    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u5b50\u5f15\u7528",children:"\u539f\u5b50\u5f15\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u5b50\u5f15\u7528\uff1a\u5bf9 Object \u8fdb\u884c\u539f\u5b50\u64cd\u4f5c\uff0c\u63d0\u4f9b\u4e00\u79cd\u8bfb\u548c\u5199\u90fd\u662f\u539f\u5b50\u6027\u7684\u5bf9\u8c61\u5f15\u7528\u53d8\u91cf"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u5b50\u5f15\u7528\u7c7b\uff1aAtomicReference\u3001AtomicStampedReference\u3001AtomicMarkableReference"}),"\n",(0,r.jsx)(e.p,{children:"AtomicReference \u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6784\u9020\u65b9\u6cd5\uff1a",(0,r.jsx)(e.code,{children:"AtomicReference<T> atomicReference = new AtomicReference<T>()"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528 API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public final boolean compareAndSet(V expectedValue, V newValue)"}),"\uff1aCAS \u64cd\u4f5c"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public final void set(V newValue)"}),"\uff1a\u5c06\u503c\u8bbe\u7f6e\u4e3a newValue"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public final V get()"}),"\uff1a\u8fd4\u56de\u5f53\u524d\u503c"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class AtomicReferenceDemo {\n    public static void main(String[] args) {\n        Student s1 = new Student(33, "z3");\n        \n        // \u521b\u5efa\u539f\u5b50\u5f15\u7528\u5305\u88c5\u7c7b\n        AtomicReference<Student> atomicReference = new AtomicReference<>();\n        // \u8bbe\u7f6e\u4e3b\u5185\u5b58\u5171\u4eab\u53d8\u91cf\u4e3as1\n        atomicReference.set(s1);\n\n        // \u6bd4\u8f83\u5e76\u4ea4\u6362\uff0c\u5982\u679c\u73b0\u5728\u4e3b\u7269\u7406\u5185\u5b58\u7684\u503c\u4e3a z3\uff0c\u90a3\u4e48\u4ea4\u6362\u6210 l4\n        while (true) {\n            Student s2 = new Student(44, "l4");\n            if (atomicReference.compareAndSet(s1, s2)) {\n                break;\n            }\n        }\n        System.out.println(atomicReference.get());\n    }\n}\n\nclass Student {\n    private int id;\n    private String name;\n    //\u3002\u3002\u3002\u3002\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u5b50\u6570\u7ec4",children:"\u539f\u5b50\u6570\u7ec4"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u5b50\u6570\u7ec4\u7c7b\uff1aAtomicIntegerArray\u3001AtomicLongArray\u3001AtomicReferenceArray"}),"\n",(0,r.jsx)(e.p,{children:"AtomicIntegerArray \u7c7b\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"/**\n*   i\t\tthe index\n* expect \tthe expected value\n* update \tthe new value\n*/\npublic final boolean compareAndSet(int i, int expect, int update) {\n    return compareAndSetRaw(checkedByteOffset(i), expect, update);\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u5b50\u66f4\u65b0\u5668",children:"\u539f\u5b50\u66f4\u65b0\u5668"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u5b50\u66f4\u65b0\u5668\u7c7b\uff1aAtomicReferenceFieldUpdater\u3001AtomicIntegerFieldUpdater\u3001AtomicLongFieldUpdater"}),"\n",(0,r.jsxs)(e.p,{children:["\u5229\u7528\u5b57\u6bb5\u66f4\u65b0\u5668\uff0c\u53ef\u4ee5\u9488\u5bf9\u5bf9\u8c61\u7684\u67d0\u4e2a\u57df\uff08Field\uff09\u8fdb\u884c\u539f\u5b50\u64cd\u4f5c\uff0c\u53ea\u80fd\u914d\u5408 volatile \u4fee\u9970\u7684\u5b57\u6bb5\u4f7f\u7528\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u5f02\u5e38 ",(0,r.jsx)(e.code,{children:"IllegalArgumentException: Must be volatile type"})]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528 API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"static <U> AtomicIntegerFieldUpdater<U> newUpdater(Class<U> c, String fieldName)"}),"\uff1a\u6784\u9020\u65b9\u6cd5"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"abstract boolean compareAndSet(T obj, int expect, int update)"}),"\uff1aCAS"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class UpdateDemo {\n    private volatile int field;\n    \n    public static void main(String[] args) {\n        AtomicIntegerFieldUpdater fieldUpdater = AtomicIntegerFieldUpdater\n            \t\t.newUpdater(UpdateDemo.class, "field");\n        UpdateDemo updateDemo = new UpdateDemo();\n        fieldUpdater.compareAndSet(updateDemo, 0, 10);\n        System.out.println(updateDemo.field);//10\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u5b50\u7d2f\u52a0\u5668",children:"\u539f\u5b50\u7d2f\u52a0\u5668"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u5b50\u7d2f\u52a0\u5668\u7c7b\uff1aLongAdder\u3001DoubleAdder\u3001LongAccumulator\u3001DoubleAccumulator"}),"\n",(0,r.jsx)(e.p,{children:"LongAdder \u548c LongAccumulator \u533a\u522b\uff1a"}),"\n",(0,r.jsx)(e.p,{children:"\u76f8\u540c\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"LongAddr \u4e0e LongAccumulator \u7c7b\u90fd\u662f\u4f7f\u7528\u975e\u963b\u585e\u7b97\u6cd5 CAS \u5b9e\u73b0\u7684"}),"\n",(0,r.jsx)(e.li,{children:"LongAddr \u7c7b\u662f LongAccumulator \u7c7b\u7684\u4e00\u4e2a\u7279\u4f8b\uff0c\u53ea\u662f LongAccumulator \u63d0\u4f9b\u4e86\u66f4\u5f3a\u5927\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7d2f\u52a0\u89c4\u5219\uff0c\u5f53accumulatorFunction \u4e3a null \u65f6\u5c31\u7b49\u4ef7\u4e8e LongAddr"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u540c\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8c03\u7528 casBase \u65f6\uff0cLongAccumulator \u4f7f\u7528 function.applyAsLong(b = base, x) \u6765\u8ba1\u7b97\uff0cLongAddr \u4f7f\u7528 casBase(b = base, b + x)"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"LongAccumulator \u7c7b\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\uff0c\u6784\u9020\u65b9\u6cd5\u53c2\u6570\u4e2d"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"accumulatorFunction \u662f\u4e00\u4e2a\u53cc\u76ee\u8fd0\u7b97\u5668\u63a5\u53e3\uff0c\u53ef\u4ee5\u6307\u5b9a\u7d2f\u52a0\u89c4\u5219\uff0c\u6bd4\u5982\u7d2f\u52a0\u6216\u8005\u76f8\u4e58\uff0c\u5176\u6839\u636e\u8f93\u5165\u7684\u4e24\u4e2a\u53c2\u6570\u8fd4\u56de\u4e00\u4e2a\u8ba1\u7b97\u503c\uff0cLongAdder \u5185\u7f6e\u7d2f\u52a0\u89c4\u5219"}),"\n",(0,r.jsx)(e.li,{children:"identity \u5219\u662f LongAccumulator \u7d2f\u52a0\u5668\u7684\u521d\u59cb\u503c\uff0cLongAccumulator \u53ef\u4ee5\u4e3a\u7d2f\u52a0\u5668\u63d0\u4f9b\u975e0\u7684\u521d\u59cb\u503c\uff0c\u800c LongAdder \u53ea\u80fd\u63d0\u4f9b\u9ed8\u8ba4\u7684 0"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"adder",children:"Adder"}),"\n",(0,r.jsx)(e.h4,{id:"\u4f18\u5316\u673a\u5236",children:"\u4f18\u5316\u673a\u5236"}),"\n",(0,r.jsx)(e.p,{children:"LongAdder \u662f Java8 \u63d0\u4f9b\u7684\u7c7b\uff0c\u8ddf AtomicLong \u6709\u76f8\u540c\u7684\u6548\u679c\uff0c\u4f46\u5bf9 CAS \u673a\u5236\u8fdb\u884c\u4e86\u4f18\u5316\uff0c\u5c1d\u8bd5\u4f7f\u7528\u5206\u6bb5 CAS \u4ee5\u53ca\u81ea\u52a8\u5206\u6bb5\u8fc1\u79fb\u7684\u65b9\u5f0f\u6765\u5927\u5e45\u5ea6\u63d0\u5347\u591a\u7ebf\u7a0b\u9ad8\u5e76\u53d1\u6267\u884c CAS \u64cd\u4f5c\u7684\u6027\u80fd"}),"\n",(0,r.jsxs)(e.p,{children:["CAS \u5e95\u5c42\u5b9e\u73b0\u662f\u5728\u4e00\u4e2a\u5faa\u73af\u4e2d\u4e0d\u65ad\u5730\u5c1d\u8bd5\u4fee\u6539\u76ee\u6807\u503c\uff0c\u76f4\u5230\u4fee\u6539\u6210\u529f\u3002\u5982\u679c\u7ade\u4e89\u4e0d\u6fc0\u70c8\u4fee\u6539\u6210\u529f\u7387\u5f88\u9ad8\uff0c\u5426\u5219\u5931\u8d25\u7387\u5f88\u9ad8\uff0c\u5931\u8d25\u540e\u8fd9\u4e9b\u91cd\u590d\u7684\u539f\u5b50\u6027\u64cd\u4f5c\u4f1a\u8017\u8d39\u6027\u80fd\uff08\u5bfc\u81f4\u5927\u91cf\u7ebf\u7a0b",(0,r.jsx)(e.strong,{children:"\u7a7a\u5faa\u73af\uff0c\u81ea\u65cb\u8f6c"}),"\uff09"]}),"\n",(0,r.jsxs)(e.p,{children:["\u4f18\u5316\u6838\u5fc3\u601d\u60f3\uff1a\u6570\u636e\u5206\u79bb\uff0c\u5c06 AtomicLong \u7684",(0,r.jsx)(e.strong,{children:"\u5355\u70b9\u7684\u66f4\u65b0\u538b\u529b\u5206\u62c5\u5230\u5404\u4e2a\u8282\u70b9\uff0c\u7a7a\u95f4\u6362\u65f6\u95f4"}),"\uff0c\u5728\u4f4e\u5e76\u53d1\u7684\u65f6\u5019\u76f4\u63a5\u66f4\u65b0\uff0c\u53ef\u4ee5\u4fdd\u969c\u548c AtomicLong \u7684\u6027\u80fd\u57fa\u672c\u4e00\u81f4\uff0c\u800c\u5728\u9ad8\u5e76\u53d1\u7684\u65f6\u5019\u901a\u8fc7\u5206\u6563\u51cf\u5c11\u7ade\u4e89\uff0c\u63d0\u9ad8\u4e86\u6027\u80fd"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u5206\u6bb5 CAS \u673a\u5236"}),"\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5728\u53d1\u751f\u7ade\u4e89\u65f6\uff0c\u521b\u5efa Cell \u6570\u7ec4\u7528\u4e8e\u5c06\u4e0d\u540c\u7ebf\u7a0b\u7684\u64cd\u4f5c\u79bb\u6563\uff08\u901a\u8fc7 hash \u7b49\u7b97\u6cd5\u6620\u5c04\uff09\u5230\u4e0d\u540c\u7684\u8282\u70b9\u4e0a"}),"\n",(0,r.jsx)(e.li,{children:"\u8bbe\u7f6e\u591a\u4e2a\u7d2f\u52a0\u5355\u5143\uff08\u4f1a\u6839\u636e\u9700\u8981\u6269\u5bb9\uff0c\u6700\u5927\u4e3a CPU \u6838\u6570\uff09\uff0cTherad-0 \u7d2f\u52a0 Cell[0]\uff0c\u800c Thread-1 \u7d2f\u52a0 Cell[1] \u7b49\uff0c\u6700\u540e\u5c06\u7ed3\u679c\u6c47\u603b"}),"\n",(0,r.jsx)(e.li,{children:"\u5728\u7d2f\u52a0\u65f6\u64cd\u4f5c\u7684\u4e0d\u540c\u7684 Cell \u53d8\u91cf\uff0c\u56e0\u6b64\u51cf\u5c11\u4e86 CAS \u91cd\u8bd5\u5931\u8d25\uff0c\u4ece\u800c\u63d0\u9ad8\u6027\u80fd"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u81ea\u52a8\u5206\u6bb5\u8fc1\u79fb\u673a\u5236"}),"\uff1a\u67d0\u4e2a Cell \u7684 value \u6267\u884c CAS \u5931\u8d25\uff0c\u5c31\u4f1a\u81ea\u52a8\u5bfb\u627e\u53e6\u4e00\u4e2a Cell \u5206\u6bb5\u5185\u7684 value \u503c\u8fdb\u884c CAS \u64cd\u4f5c"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4f2a\u5171\u4eab-1",children:"\u4f2a\u5171\u4eab"}),"\n",(0,r.jsx)(e.p,{children:"Cell \u4e3a\u7d2f\u52a0\u5355\u5143\uff1a\u6570\u7ec4\u8bbf\u95ee\u7d22\u5f15\u662f\u901a\u8fc7 Thread \u91cc\u7684 threadLocalRandomProbe \u57df\u53d6\u6a21\u5b9e\u73b0\u7684\uff0c\u8fd9\u4e2a\u57df\u662f ThreadLocalRandom \u66f4\u65b0\u7684"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// Striped64.Cell\n@sun.misc.Contended static final class Cell {\n    volatile long value;\n    Cell(long x) { value = x; }\n    // \u7528 cas \u65b9\u5f0f\u8fdb\u884c\u7d2f\u52a0, prev \u8868\u793a\u65e7\u503c, next \u8868\u793a\u65b0\u503c\n    final boolean cas(long prev, long next) {\n    \treturn UNSAFE.compareAndSwapLong(this, valueOffset, prev, next);\n    }\n    // \u7701\u7565\u4e0d\u91cd\u8981\u4ee3\u7801\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["Cell \u662f\u6570\u7ec4\u5f62\u5f0f\uff0c",(0,r.jsx)(e.strong,{children:"\u5728\u5185\u5b58\u4e2d\u662f\u8fde\u7eed\u5b58\u50a8\u7684"}),"\uff0c64 \u4f4d\u7cfb\u7edf\u4e2d\uff0c\u4e00\u4e2a Cell \u4e3a 24 \u5b57\u8282\uff0816 \u5b57\u8282\u7684\u5bf9\u8c61\u5934\u548c 8 \u5b57\u8282\u7684 value\uff09\uff0c\u6bcf\u4e00\u4e2a cache line \u4e3a 64 \u5b57\u8282\uff0c\u56e0\u6b64\u7f13\u5b58\u884c\u53ef\u4ee5\u5b58\u4e0b 2 \u4e2a\u7684 Cell \u5bf9\u8c61\uff0c\u5f53 Core-0 \u8981\u4fee\u6539 Cell[0]\u3001Core-1 \u8981\u4fee\u6539 Cell[1]\uff0c\u65e0\u8bba\u8c01\u4fee\u6539\u6210\u529f\u90fd\u4f1a\u5bfc\u81f4\u5f53\u524d\u7f13\u5b58\u884c\u5931\u6548\uff0c\u4ece\u800c\u5bfc\u81f4\u5bf9\u65b9\u7684\u6570\u636e\u5931\u6548\uff0c\u9700\u8981\u91cd\u65b0\u53bb\u4e3b\u5b58\u83b7\u53d6\uff0c\u5f71\u54cd\u6548\u7387"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(21668).A+"",width:"884",height:"370"})}),"\n",(0,r.jsxs)(e.p,{children:["@sun.misc.Contended\uff1a\u9632\u6b62\u7f13\u5b58\u884c\u4f2a\u5171\u4eab\uff0c\u5728\u4f7f\u7528\u6b64\u6ce8\u89e3\u7684\u5bf9\u8c61\u6216\u5b57\u6bb5\u7684\u524d\u540e\u5404\u589e\u52a0 128 \u5b57\u8282\u5927\u5c0f\u7684 padding\uff0c\u4f7f\u7528 2 \u500d\u4e8e\u5927\u591a\u6570\u786c\u4ef6\u7f13\u5b58\u884c\u8ba9 CPU \u5c06\u5bf9\u8c61\u9884\u8bfb\u81f3\u7f13\u5b58\u65f6",(0,r.jsx)(e.strong,{children:"\u5360\u7528\u4e0d\u540c\u7684\u7f13\u5b58\u884c"}),"\uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u9020\u6210\u5bf9\u65b9\u7f13\u5b58\u884c\u7684\u5931\u6548"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(58527).A+"",width:"853",height:"341"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6e90\u7801\u89e3\u6790",children:"\u6e90\u7801\u89e3\u6790"}),"\n",(0,r.jsx)(e.p,{children:"Striped64 \u7c7b\u6210\u5458\u5c5e\u6027\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8868\u793a\u5f53\u524d\u8ba1\u7b97\u673aCPU\u6570\u91cf\nstatic final int NCPU = Runtime.getRuntime().availableProcessors()\n// \u7d2f\u52a0\u5355\u5143\u6570\u7ec4, \u61d2\u60f0\u521d\u59cb\u5316\ntransient volatile Cell[] cells;\n// \u57fa\u7840\u503c, \u5982\u679c\u6ca1\u6709\u7ade\u4e89, \u5219\u7528 cas \u7d2f\u52a0\u8fd9\u4e2a\u57df\uff0c\u5f53 cells \u6269\u5bb9\u65f6\uff0c\u4e5f\u4f1a\u5c06\u6570\u636e\u5199\u5230 base \u4e2d\ntransient volatile long base;\n// \u5728 cells \u521d\u59cb\u5316\u6216\u6269\u5bb9\u65f6\u53ea\u80fd\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c, \u901a\u8fc7 CAS \u66f4\u65b0 cellsBusy \u7f6e\u4e3a 1 \u6765\u5b9e\u73b0\u4e00\u4e2a\u9501\ntransient volatile int cellsBusy;\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5de5\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"cells \u5360\u7528\u5185\u5b58\u662f\u76f8\u5bf9\u6bd4\u8f83\u5927\u7684\uff0c\u662f\u60f0\u6027\u52a0\u8f7d\u7684\uff0c\u5728\u65e0\u7ade\u4e89\u6216\u8005\u5176\u4ed6\u7ebf\u7a0b\u6b63\u5728\u521d\u59cb\u5316 cells \u6570\u7ec4\u7684\u60c5\u51b5\u4e0b\uff0c\u76f4\u63a5\u66f4\u65b0 base \u57df"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5728\u7b2c\u4e00\u6b21\u53d1\u751f\u7ade\u4e89\u65f6\uff08casBase \u5931\u8d25\uff09\u4f1a\u521b\u5efa\u4e00\u4e2a\u5927\u5c0f\u4e3a 2 \u7684 cells \u6570\u7ec4\uff0c\u5c06\u5f53\u524d\u7d2f\u52a0\u7684\u503c\u5305\u88c5\u4e3a Cell \u5bf9\u8c61\uff0c\u653e\u5165\u6620\u5c04\u7684\u69fd\u4f4d\u4e0a"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5206\u6bb5\u7d2f\u52a0\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u7684 cells \u69fd\u4f4d\u4e3a\u7a7a\uff0c\u5c31\u4f1a\u65b0\u5efa Cell \u586b\u5145\uff0c\u5982\u679c\u51fa\u73b0\u7ade\u4e89\uff0c\u5c31\u4f1a\u91cd\u65b0\u8ba1\u7b97\u7ebf\u7a0b\u5bf9\u5e94\u7684\u69fd\u4f4d\uff0c\u7ee7\u7eed\u81ea\u65cb\u5c1d\u8bd5\u4fee\u6539"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5206\u6bb5\u8fc1\u79fb\u540e\u8fd8\u51fa\u73b0\u7ade\u4e89\u5c31\u4f1a\u6269\u5bb9 cells \u6570\u7ec4\u957f\u5ea6\u4e3a\u539f\u6765\u7684\u4e24\u500d\uff0c\u7136\u540e rehash\uff0c",(0,r.jsx)(e.strong,{children:"\u6570\u7ec4\u957f\u5ea6\u603b\u662f 2 \u7684 n \u6b21\u5e42"}),"\uff0c\u9ed8\u8ba4\u6700\u5927\u4e3a CPU \u6838\u6570\uff0c\u4f46\u662f\u53ef\u4ee5\u8d85\u8fc7\uff0c\u5982\u679c\u6838\u6570\u662f 6 \u6838\uff0c\u6570\u7ec4\u6700\u957f\u662f 8"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u65b9\u6cd5\u5206\u6790\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"LongAdder#add\uff1a\u7d2f\u52a0\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void add(long x) {\n    // as \u4e3a\u7d2f\u52a0\u5355\u5143\u6570\u7ec4\u7684\u5f15\u7528\uff0cb \u4e3a\u57fa\u7840\u503c\uff0cv \u8868\u793a\u671f\u671b\u503c\n    // m \u8868\u793a cells \u6570\u7ec4\u7684\u957f\u5ea6 - 1\uff0ca \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u547d\u4e2d\u7684 cell \u5355\u5143\u683c\n    Cell[] as; long b, v; int m; Cell a;\n    \n    // cells \u4e0d\u4e3a\u7a7a\u8bf4\u660e cells \u5df2\u7ecf\u88ab\u521d\u59cb\u5316\uff0c\u7ebf\u7a0b\u53d1\u751f\u4e86\u7ade\u4e89\uff0c\u53bb\u66f4\u65b0\u5bf9\u5e94\u7684 cell \u69fd\u4f4d\n    // \u8fdb\u5165 || \u540e\u7684\u903b\u8f91\u53bb\u66f4\u65b0 base \u57df\uff0c\u66f4\u65b0\u5931\u8d25\u8868\u793a\u53d1\u751f\u7ade\u4e89\u8fdb\u5165\u6761\u4ef6\n    if ((as = cells) != null || !casBase(b = base, b + x)) {\n        // uncontended \u4e3a true \u8868\u793a cell \u6ca1\u6709\u7ade\u4e89\n        boolean uncontended = true;\n        \n        // \u6761\u4ef6\u4e00: true \u8bf4\u660e cells \u672a\u521d\u59cb\u5316\uff0c\u591a\u7ebf\u7a0b\u5199 base \u53d1\u751f\u7ade\u4e89\u9700\u8981\u8fdb\u884c\u521d\u59cb\u5316 cells \u6570\u7ec4\n        //\t\t  fasle \u8bf4\u660e cells \u5df2\u7ecf\u521d\u59cb\u5316\uff0c\u8fdb\u884c\u4e0b\u4e00\u4e2a\u6761\u4ef6\u5bfb\u627e\u81ea\u5df1\u7684 cell \u53bb\u7d2f\u52a0\n        // \u6761\u4ef6\u4e8c: getProbe() \u83b7\u53d6 hash \u503c\uff0c& m \u7684\u903b\u8f91\u548c HashMap \u7684\u903b\u8f91\u76f8\u540c\uff0c\u4fdd\u8bc1\u6563\u5217\u7684\u5747\u5300\u6027\n        // \t\t  true \u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u4e0b\u6807\u7684 cell \u4e3a\u7a7a\uff0c\u9700\u8981\u521b\u5efa cell\n        //        false \u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u7684 cell \u4e0d\u4e3a\u7a7a\uff0c\u8fdb\u884c\u4e0b\u4e00\u4e2a\u6761\u4ef6\u3010\u5c06 x \u503c\u7d2f\u52a0\u5230\u5bf9\u5e94\u7684 cell \u4e2d\u3011\n        // \u6761\u4ef6\u4e09: \u6709\u53d6\u53cd\u7b26\u53f7\uff0cfalse \u8bf4\u660e cas \u6210\u529f\uff0c\u76f4\u63a5\u8fd4\u56de\uff0ctrue \u8bf4\u660e\u5931\u8d25\uff0c\u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u7684 cell \u6709\u7ade\u4e89\n        if (as == null || (m = as.length - 1) < 0 ||\n            (a = as[getProbe() & m]) == null ||\n            !(uncontended = a.cas(v = a.value, v + x)))\n            longAccumulate(x, null, uncontended);\n        \t// \u3010uncontended \u5728\u5bf9\u5e94\u7684 cell \u4e0a\u7d2f\u52a0\u5931\u8d25\u7684\u65f6\u5019\u624d\u4e3a false\uff0c\u5176\u4f59\u60c5\u51b5\u5747\u4e3a true\u3011\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Striped64#longAccumulate\uff1acell \u6570\u7ec4\u521b\u5efa"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\t\t\t\t\t\t\t// x  \t\t\tnull \t\t\tfalse | true\nfinal void longAccumulate(long x, LongBinaryOperator fn, boolean wasUncontended) {\n    int h;\n    // \u5f53\u524d\u7ebf\u7a0b\u8fd8\u6ca1\u6709\u5bf9\u5e94\u7684 cell, \u9700\u8981\u968f\u673a\u751f\u6210\u4e00\u4e2a hash \u503c\u7528\u6765\u5c06\u5f53\u524d\u7ebf\u7a0b\u7ed1\u5b9a\u5230 cell\n    if ((h = getProbe()) == 0) {\n        // \u521d\u59cb\u5316 probe\uff0c\u83b7\u53d6 hash \u503c\n        ThreadLocalRandom.current(); \n        h = getProbe();\t\n        // \u9ed8\u8ba4\u60c5\u51b5\u4e0b \u5f53\u524d\u7ebf\u7a0b\u80af\u5b9a\u662f\u5199\u5165\u5230\u4e86 cells[0] \u4f4d\u7f6e\uff0c\u4e0d\u628a\u5b83\u5f53\u505a\u4e00\u6b21\u771f\u6b63\u7684\u7ade\u4e89\n        wasUncontended = true;\n    }\n    // \u8868\u793a\u3010\u6269\u5bb9\u610f\u5411\u3011\uff0cfalse \u4e00\u5b9a\u4e0d\u4f1a\u6269\u5bb9\uff0ctrue \u53ef\u80fd\u4f1a\u6269\u5bb9\n    boolean collide = false; \n    //\u81ea\u65cb\n    for (;;) {\n        // as \u8868\u793acells\u5f15\u7528\uff0ca \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u547d\u4e2d\u7684 cell\uff0cn \u8868\u793a cells \u6570\u7ec4\u957f\u5ea6\uff0cv \u8868\u793a \u671f\u671b\u503c\n        Cell[] as; Cell a; int n; long v;\n        // \u3010CASE1\u3011: \u8868\u793a cells \u5df2\u7ecf\u521d\u59cb\u5316\u4e86\uff0c\u5f53\u524d\u7ebf\u7a0b\u5e94\u8be5\u5c06\u6570\u636e\u5199\u5165\u5230\u5bf9\u5e94\u7684 cell \u4e2d\n        if ((as = cells) != null && (n = as.length) > 0) {\n            // CASE1.1: true \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u7684\u7d22\u5f15\u4e0b\u6807\u7684 Cell \u4e3a null\uff0c\u9700\u8981\u521b\u5efa new Cell\n            if ((a = as[(n - 1) & h]) == null) {\n                // \u5224\u65ad cellsBusy \u662f\u5426\u88ab\u9501\n                if (cellsBusy == 0) {   \n                    // \u521b\u5efa cell, \u521d\u59cb\u7d2f\u52a0\u503c\u4e3a x\n                    Cell r = new Cell(x);  \n                    // \u52a0\u9501\n                    if (cellsBusy == 0 && casCellsBusy()) {\n                        // \u521b\u5efa\u6210\u529f\u6807\u8bb0\uff0c\u8fdb\u5165\u3010\u521b\u5efa cell \u903b\u8f91\u3011\n                        boolean created = false;\t\n                        try {\n                            Cell[] rs; int m, j;\n                            // \u628a\u5f53\u524d cells \u6570\u7ec4\u8d4b\u503c\u7ed9 rs\uff0c\u5e76\u4e14\u4e0d\u4e3a null\n                            if ((rs = cells) != null &&\n                                (m = rs.length) > 0 &&\n                                // \u518d\u6b21\u5224\u65ad\u9632\u6b62\u5176\u5b83\u7ebf\u7a0b\u521d\u59cb\u5316\u8fc7\u8be5\u4f4d\u7f6e\uff0c\u5f53\u524d\u7ebf\u7a0b\u518d\u6b21\u521d\u59cb\u5316\u8be5\u4f4d\u7f6e\u4f1a\u9020\u6210\u6570\u636e\u4e22\u5931\n                                // \u56e0\u4e3a\u8fd9\u91cc\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u5224\u65ad\uff0c\u8fdb\u884c\u7684\u903b\u8f91\u4e0d\u4f1a\u88ab\u5176\u4ed6\u7ebf\u7a0b\u5f71\u54cd\n                                rs[j = (m - 1) & h] == null) {\n                                // \u628a\u65b0\u521b\u5efa\u7684 cell \u586b\u5145\u81f3\u5f53\u524d\u4f4d\u7f6e\n                                rs[j] = r;\n                                created = true;\t// \u8868\u793a\u521b\u5efa\u5b8c\u6210\n                            }\n                        } finally {\n                            cellsBusy = 0;\t\t// \u89e3\u9501\n                        }\n                        if (created)\t\t\t// true \u8868\u793a\u521b\u5efa\u5b8c\u6210\uff0c\u53ef\u4ee5\u63a8\u51fa\u5faa\u73af\u4e86\n                            break;\n                        continue;\n                    }\n                }\n                collide = false;\n            }\n            // CASE1.2: \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u7ebf\u7a0b\u5bf9\u5e94\u7684 cell \u6709\u7ade\u4e89, \u6539\u53d8\u7ebf\u7a0b\u5bf9\u5e94\u7684 cell \u6765\u91cd\u8bd5 cas\n            else if (!wasUncontended)\n                wasUncontended = true;\n            // CASE 1.3: \u5f53\u524d\u7ebf\u7a0b rehash \u8fc7\uff0c\u5982\u679c\u65b0\u547d\u4e2d\u7684 cell \u4e0d\u4e3a\u7a7a\uff0c\u5c31\u5c1d\u8bd5\u7d2f\u52a0\uff0cfalse \u8bf4\u660e\u65b0\u547d\u4e2d\u4e5f\u6709\u7ade\u4e89\n            else if (a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x))))\n                break;\n            // CASE 1.4: cells \u957f\u5ea6\u5df2\u7ecf\u8d85\u8fc7\u4e86\u6700\u5927\u957f\u5ea6 CPU \u5185\u6838\u7684\u6570\u91cf\u6216\u8005\u5df2\u7ecf\u6269\u5bb9\n            else if (n >= NCPU || cells != as)\n                collide = false; \t\t// \u6269\u5bb9\u610f\u5411\u6539\u4e3afalse\uff0c\u3010\u8868\u793a\u4e0d\u80fd\u6269\u5bb9\u4e86\u3011\n            // CASE 1.5: \u66f4\u6539\u6269\u5bb9\u610f\u5411\uff0c\u5982\u679c n >= NCPU\uff0c\u8fd9\u91cc\u5c31\u6c38\u8fdc\u4e0d\u4f1a\u6267\u884c\u5230\uff0ccase1.4 \u6c38\u8fdc\u5148\u4e8e 1.5 \u6267\u884c\n            else if (!collide)\n                collide = true;\n            // CASE 1.6: \u3010\u6269\u5bb9\u903b\u8f91\u3011\uff0c\u8fdb\u884c\u52a0\u9501\n            else if (cellsBusy == 0 && casCellsBusy()) {\n                try {\n                    // \u7ebf\u7a0b\u5b89\u5168\u7684\u68c0\u67e5\uff0c\u9632\u6b62\u671f\u95f4\u88ab\u5176\u4ed6\u7ebf\u7a0b\u6269\u5bb9\u4e86\n                    if (cells == as) {     \n                        // \u6269\u5bb9\u4e3a\u4ee5\u524d\u7684 2 \u500d\n                        Cell[] rs = new Cell[n << 1];\n                        // \u904d\u5386\u79fb\u52a8\u503c\n                        for (int i = 0; i < n; ++i)\n                            rs[i] = as[i];\n                        // \u628a\u6269\u5bb9\u540e\u7684\u5f15\u7528\u7ed9 cells\n                        cells = rs;\n                    }\n                } finally {\n                    cellsBusy = 0;\t// \u89e3\u9501\n                }\n                collide = false;\t// \u6269\u5bb9\u610f\u5411\u6539\u4e3a false\uff0c\u8868\u793a\u4e0d\u6269\u5bb9\u4e86\n                continue;\n            }\n            // \u91cd\u7f6e\u5f53\u524d\u7ebf\u7a0b Hash \u503c\uff0c\u8fd9\u5c31\u662f\u3010\u5206\u6bb5\u8fc1\u79fb\u673a\u5236\u3011\n            h = advanceProbe(h);\n        }\n\n        // \u3010CASE2\u3011: \u8fd0\u884c\u5230\u8fd9\u8bf4\u660e cells \u8fd8\u672a\u521d\u59cb\u5316\uff0cas \u4e3anull\n        // \u5224\u65ad\u662f\u5426\u6ca1\u6709\u52a0\u9501\uff0c\u6ca1\u6709\u52a0\u9501\u5c31\u7528 CAS \u52a0\u9501\n        // \u6761\u4ef6\u4e8c\u5224\u65ad\u662f\u5426\u5176\u5b83\u7ebf\u7a0b\u5728\u5f53\u524d\u7ebf\u7a0b\u7ed9 as \u8d4b\u503c\u4e4b\u540e\u4fee\u6539\u4e86 cells\uff0c\u8fd9\u91cc\u4e0d\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u5224\u65ad\n        else if (cellsBusy == 0 && cells == as && casCellsBusy()) {\n            // \u521d\u59cb\u5316\u6807\u5fd7\uff0c\u5f00\u59cb \u3010\u521d\u59cb\u5316 cells \u6570\u7ec4\u3011\n            boolean init = false;\n            try { \n               \t// \u518d\u6b21\u5224\u65ad cells == as \u9632\u6b62\u5176\u5b83\u7ebf\u7a0b\u5df2\u7ecf\u63d0\u524d\u521d\u59cb\u5316\u4e86\uff0c\u5f53\u524d\u7ebf\u7a0b\u518d\u6b21\u521d\u59cb\u5316\u5bfc\u81f4\u4e22\u5931\u6570\u636e\n                // \u56e0\u4e3a\u8fd9\u91cc\u662f\u3010\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u91cd\u65b0\u68c0\u67e5\uff0c\u7ecf\u5178 DCL\u3011\n                if (cells == as) {\n                    Cell[] rs = new Cell[2];\t// \u521d\u59cb\u5316\u6570\u7ec4\u5927\u5c0f\u4e3a2\n                    rs[h & 1] = new Cell(x);\t// \u586b\u5145\u7ebf\u7a0b\u5bf9\u5e94\u7684cell\n                    cells = rs;\n                    init = true;\t\t\t\t// \u521d\u59cb\u5316\u6210\u529f\uff0c\u6807\u8bb0\u7f6e\u4e3a true\n                }\n            } finally {\n                cellsBusy = 0;\t\t\t\t\t// \u89e3\u9501\u554a\n            }\n            if (init)\n                break;\t\t\t\t\t\t\t// \u521d\u59cb\u5316\u6210\u529f\u76f4\u63a5\u8df3\u51fa\u81ea\u65cb\n        }\n        // \u3010CASE3\u3011: \u8fd0\u884c\u5230\u8fd9\u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u5728\u521d\u59cb\u5316 cells\uff0c\u5f53\u524d\u7ebf\u7a0b\u5c06\u503c\u7d2f\u52a0\u5230 base\uff0c\u7d2f\u52a0\u6210\u529f\u76f4\u63a5\u7ed3\u675f\u81ea\u65cb\n        else if (casBase(v = base, ((fn == null) ? v + x :\n                                    fn.applyAsLong(v, x))))\n            break; \n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["sum\uff1a\u83b7\u53d6\u6700\u7ec8\u7ed3\u679c\u901a\u8fc7 sum \u6574\u5408\uff0c",(0,r.jsx)(e.strong,{children:"\u4fdd\u8bc1\u6700\u7ec8\u4e00\u81f4\u6027\uff0c\u4e0d\u4fdd\u8bc1\u5f3a\u4e00\u81f4\u6027"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public long sum() {\n    Cell[] as = cells; Cell a;\n    long sum = base;\n    if (as != null) {\n        // \u904d\u5386 \u7d2f\u52a0\n        for (int i = 0; i < as.length; ++i) {\n            if ((a = as[i]) != null)\n                sum += a.value;\n        }\n    }\n    return sum;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"aba",children:"ABA"}),"\n",(0,r.jsx)(e.p,{children:"ABA \u95ee\u9898\uff1a\u5f53\u8fdb\u884c\u83b7\u53d6\u4e3b\u5185\u5b58\u503c\u65f6\uff0c\u8be5\u5185\u5b58\u503c\u5728\u5199\u5165\u4e3b\u5185\u5b58\u65f6\u5df2\u7ecf\u88ab\u4fee\u6539\u4e86 N \u6b21\uff0c\u4f46\u662f\u6700\u7ec8\u53c8\u6539\u6210\u539f\u6765\u7684\u503c"}),"\n",(0,r.jsxs)(e.p,{children:["\u5176\u4ed6\u7ebf\u7a0b\u5148\u628a A \u6539\u6210 B \u53c8\u6539\u56de A\uff0c\u4e3b\u7ebf\u7a0b",(0,r.jsx)(e.strong,{children:"\u4ec5\u80fd\u5224\u65ad\u51fa\u5171\u4eab\u53d8\u91cf\u7684\u503c\u4e0e\u6700\u521d\u503c A \u662f\u5426\u76f8\u540c"}),"\uff0c\u4e0d\u80fd\u611f\u77e5\u5230\u8fd9\u79cd\u4ece A \u6539\u4e3a B \u53c8 \u6539\u56de A \u7684\u60c5\u51b5\uff0c\u8fd9\u65f6 CAS \u867d\u7136\u6210\u529f\uff0c\u4f46\u662f\u8fc7\u7a0b\u5b58\u5728\u95ee\u9898"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public AtomicStampedReference(V initialRef, int initialStamp)"}),"\uff1a\u521d\u59cb\u503c\u548c\u521d\u59cb\u7248\u672c\u53f7"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:" public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)"}),"\uff1a",(0,r.jsx)(e.strong,{children:"\u671f\u671b\u5f15\u7528\u548c\u671f\u671b\u7248\u672c\u53f7\u90fd\u4e00\u81f4"}),"\u624d\u8fdb\u884c CAS \u4fee\u6539\u6570\u636e"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void set(V newReference, int newStamp)"}),"\uff1a\u8bbe\u7f6e\u503c\u548c\u7248\u672c\u53f7"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public V getReference()"}),"\uff1a\u8fd4\u56de\u5f15\u7528\u7684\u503c"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public int getStamp()"}),"\uff1a\u8fd4\u56de\u5f53\u524d\u7248\u672c\u53f7"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    AtomicStampedReference<Integer> atomicReference = new AtomicStampedReference<>(100,1);\n    int startStamp = atomicReference.getStamp();\n    new Thread(() ->{\n        int stamp = atomicReference.getStamp();\n        atomicReference.compareAndSet(100, 101, stamp, stamp + 1);\n        stamp = atomicReference.getStamp();\n        atomicReference.compareAndSet(101, 100, stamp, stamp + 1);\n    },"t1").start();\n\n    new Thread(() ->{\n        try {\n            Thread.sleep(1000);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        if (!atomicReference.compareAndSet(100, 200, startStamp, startStamp + 1)) {\n            System.out.println(atomicReference.getReference());//100\n            System.out.println(Thread.currentThread().getName() + "\u7ebf\u7a0b\u4fee\u6539\u5931\u8d25");\n        }\n    },"t2").start();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"unsafe",children:"Unsafe"}),"\n",(0,r.jsx)(e.p,{children:"Unsafe \u662f CAS \u7684\u6838\u5fc3\u7c7b\uff0c\u7531\u4e8e Java \u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u5e95\u5c42\u7cfb\u7edf\uff0c\u9700\u8981\u901a\u8fc7\u672c\u5730\uff08Native\uff09\u65b9\u6cd5\u6765\u8bbf\u95ee"}),"\n",(0,r.jsxs)(e.p,{children:["Unsafe \u7c7b\u5b58\u5728 sun.misc \u5305\uff0c\u5176\u4e2d\u6240\u6709\u65b9\u6cd5\u90fd\u662f native \u4fee\u9970\u7684\uff0c\u90fd\u662f\u76f4\u63a5\u8c03\u7528",(0,r.jsx)(e.strong,{children:"\u64cd\u4f5c\u7cfb\u7edf\u5e95\u5c42\u8d44\u6e90"}),"\u6267\u884c\u76f8\u5e94\u7684\u4efb\u52a1\uff0c\u57fa\u4e8e\u8be5\u7c7b\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5c\u7279\u5b9a\u7684\u5185\u5b58\u6570\u636e\uff0c\u5176\u5185\u90e8\u65b9\u6cd5\u64cd\u4f5c\u7c7b\u4f3c C \u7684\u6307\u9488"]}),"\n",(0,r.jsx)(e.p,{children:"\u6a21\u62df\u5b9e\u73b0\u539f\u5b50\u6574\u6570\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    MyAtomicInteger atomicInteger = new MyAtomicInteger(10);\n    if (atomicInteger.compareAndSwap(20)) {\n        System.out.println(atomicInteger.getValue());\n    }\n}\n\nclass MyAtomicInteger {\n    private static final Unsafe UNSAFE;\n    private static final long VALUE_OFFSET;\n    private volatile int value;\n\n    static {\n        try {\n            //Unsafe unsafe = Unsafe.getUnsafe()\u8fd9\u6837\u4f1a\u62a5\u9519\uff0c\u9700\u8981\u53cd\u5c04\u83b7\u53d6\n            Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");\n            theUnsafe.setAccessible(true);\n            UNSAFE = (Unsafe) theUnsafe.get(null);\n            // \u83b7\u53d6 value \u5c5e\u6027\u7684\u5185\u5b58\u5730\u5740\uff0cvalue \u5c5e\u6027\u6307\u5411\u8be5\u5730\u5740\uff0c\u76f4\u63a5\u8bbe\u7f6e\u8be5\u5730\u5740\u7684\u503c\u53ef\u4ee5\u4fee\u6539 value \u7684\u503c\n            VALUE_OFFSET = UNSAFE.objectFieldOffset(\n                \t\t   MyAtomicInteger.class.getDeclaredField("value"));\n        } catch (NoSuchFieldException | IllegalAccessException e) {\n            e.printStackTrace();\n            throw new RuntimeException();\n        }\n    }\n\n    public MyAtomicInteger(int value) {\n        this.value = value;\n    }\n    public int getValue() {\n        return value;\n    }\n\n    public boolean compareAndSwap(int update) {\n        while (true) {\n            int prev = this.value;\n            int next = update;\n            //\t\t\t\t\t\t\t\u5f53\u524d\u5bf9\u8c61  \u5185\u5b58\u504f\u79fb\u91cf    \u671f\u671b\u503c \u66f4\u65b0\u503c\n            if (UNSAFE.compareAndSwapInt(this, VALUE_OFFSET, prev, update)) {\n                System.out.println("CAS\u6210\u529f");\n                return true;\n            }\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"final",children:"final"}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u7406-1",children:"\u539f\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class TestFinal {\n\tfinal int a = 20;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5b57\u8282\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'0: aload_0\n1: invokespecial #1 // Method java/lang/Object."<init>":()V\n4: aload_0\n5: bipush 20\t\t// \u5c06\u503c\u76f4\u63a5\u653e\u5165\u6808\u4e2d\n7: putfield #2 \t\t// Field a:I\n<-- \u5199\u5c4f\u969c\n10: return\n'})}),"\n",(0,r.jsx)(e.p,{children:"final \u53d8\u91cf\u7684\u8d4b\u503c\u901a\u8fc7 putfield \u6307\u4ee4\u6765\u5b8c\u6210\uff0c\u5728\u8fd9\u6761\u6307\u4ee4\u4e4b\u540e\u4e5f\u4f1a\u52a0\u5165\u5199\u5c4f\u969c\uff0c\u4fdd\u8bc1\u5728\u5176\u5b83\u7ebf\u7a0b\u8bfb\u5230\u5b83\u7684\u503c\u65f6\u4e0d\u4f1a\u51fa\u73b0\u4e3a 0 \u7684\u60c5\u51b5"}),"\n",(0,r.jsx)(e.p,{children:"\u5176\u4ed6\u7ebf\u7a0b\u8bbf\u95ee final \u4fee\u9970\u7684\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u590d\u5236\u4e00\u4efd\u653e\u5165\u6808\u4e2d"}),"\u76f4\u63a5\u8bbf\u95ee\uff0c\u6548\u7387\u9ad8"]}),"\n",(0,r.jsx)(e.li,{children:"\u5927\u4e8e short \u6700\u5927\u503c\u4f1a\u5c06\u5176\u590d\u5236\u5230\u7c7b\u7684\u5e38\u91cf\u6c60\uff0c\u8bbf\u95ee\u65f6\u4ece\u5e38\u91cf\u6c60\u83b7\u53d6"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4e0d\u53ef\u53d8",children:"\u4e0d\u53ef\u53d8"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u53ef\u53d8\uff1a\u5982\u679c\u4e00\u4e2a\u5bf9\u8c61\u4e0d\u80fd\u591f\u4fee\u6539\u5176\u5185\u90e8\u72b6\u6001\uff08\u5c5e\u6027\uff09\uff0c\u90a3\u4e48\u5c31\u662f\u4e0d\u53ef\u53d8\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u53ef\u53d8\u5bf9\u8c61\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u4e0d\u5b58\u5728\u5e76\u53d1\u4fee\u6539\u548c\u53ef\u89c1\u6027\u95ee\u9898\uff0c\u662f\u53e6\u4e00\u79cd\u907f\u514d\u7ade\u4e89\u7684\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"String \u7c7b\u4e5f\u662f\u4e0d\u53ef\u53d8\u7684\uff0c\u8be5\u7c7b\u548c\u7c7b\u4e2d\u6240\u6709\u5c5e\u6027\u90fd\u662f final \u7684"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7c7b\u7528 final \u4fee\u9970\u4fdd\u8bc1\u4e86\u8be5\u7c7b\u4e2d\u7684\u65b9\u6cd5\u4e0d\u80fd\u88ab\u8986\u76d6\uff0c\u9632\u6b62\u5b50\u7c7b\u65e0\u610f\u95f4\u7834\u574f\u4e0d\u53ef\u53d8\u6027"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u65e0\u5199\u5165\u65b9\u6cd5\uff08set\uff09\u786e\u4fdd\u5916\u90e8\u4e0d\u80fd\u5bf9\u5185\u90e8\u5c5e\u6027\u8fdb\u884c\u4fee\u6539"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5c5e\u6027\u7528 final \u4fee\u9970\u4fdd\u8bc1\u4e86\u8be5\u5c5e\u6027\u662f\u53ea\u8bfb\u7684\uff0c\u4e0d\u80fd\u4fee\u6539"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final class String\n    implements java.io.Serializable, Comparable<String>, CharSequence {\n    /** The value is used for character storage. */\n    private final char value[];\n    //....\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u66f4\u6539 String \u7c7b\u6570\u636e\u65f6\uff0c\u4f1a\u6784\u9020\u65b0\u5b57\u7b26\u4e32\u5bf9\u8c61\uff0c\u751f\u6210\u65b0\u7684 char[] value\uff0c\u901a\u8fc7",(0,r.jsx)(e.strong,{children:"\u521b\u5efa\u526f\u672c\u5bf9\u8c61\u6765\u907f\u514d\u5171\u4eab\u7684\u65b9\u5f0f\u79f0\u4e4b\u4e3a\u4fdd\u62a4\u6027\u62f7\u8d1d"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"state",children:"State"}),"\n",(0,r.jsx)(e.p,{children:"\u65e0\u72b6\u6001\uff1a\u6210\u5458\u53d8\u91cf\u4fdd\u5b58\u7684\u6570\u636e\u4e5f\u53ef\u4ee5\u79f0\u4e3a\u72b6\u6001\u4fe1\u606f\uff0c\u65e0\u72b6\u6001\u5c31\u662f\u6ca1\u6709\u6210\u5458\u53d8\u91cf"}),"\n",(0,r.jsx)(e.p,{children:"Servlet \u4e3a\u4e86\u4fdd\u8bc1\u5176\u7ebf\u7a0b\u5b89\u5168\uff0c\u4e00\u822c\u4e0d\u4e3a Servlet \u8bbe\u7f6e\u6210\u5458\u53d8\u91cf\uff0c\u8fd9\u79cd\u6ca1\u6709\u4efb\u4f55\u6210\u5458\u53d8\u91cf\u7684\u7c7b\u662f\u7ebf\u7a0b\u5b89\u5168\u7684"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"local",children:"Local"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsxs)(e.p,{children:["ThreadLocal \u7c7b\u7528\u6765\u63d0\u4f9b\u7ebf\u7a0b\u5185\u90e8\u7684\u5c40\u90e8\u53d8\u91cf\uff0c\u8fd9\u79cd\u53d8\u91cf\u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u8bbf\u95ee\uff08\u901a\u8fc7 get \u548c set \u65b9\u6cd5\u8bbf\u95ee\uff09\u65f6\u80fd\u4fdd\u8bc1\u5404\u4e2a\u7ebf\u7a0b\u7684\u53d8\u91cf\u76f8\u5bf9\u72ec\u7acb\u4e8e\u5176\u4ed6\u7ebf\u7a0b\u5185\u7684\u53d8\u91cf\uff0c\u5206\u914d\u5728\u5806\u5185\u7684 ",(0,r.jsx)(e.strong,{children:"TLAB"})," \u4e2d"]}),"\n",(0,r.jsxs)(e.p,{children:["ThreadLocal \u5b9e\u4f8b\u901a\u5e38\u6765\u8bf4\u90fd\u662f ",(0,r.jsx)(e.code,{children:"private static"})," \u7c7b\u578b\u7684\uff0c\u5c5e\u4e8e\u4e00\u4e2a\u7ebf\u7a0b\u7684\u672c\u5730\u53d8\u91cf\uff0c\u7528\u4e8e\u5173\u8054\u7ebf\u7a0b\u548c\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u3002\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u4f1a\u5728 ThreadLocal \u4e2d\u4fdd\u5b58\u4e00\u4efd\u8be5\u7ebf\u7a0b\u72ec\u6709\u7684\u6570\u636e\uff0c\u6240\u4ee5\u662f\u7ebf\u7a0b\u5b89\u5168\u7684"]}),"\n",(0,r.jsx)(e.p,{children:"ThreadLocal \u4f5c\u7528\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u5e76\u53d1\uff1a\u5e94\u7528\u5728\u591a\u7ebf\u7a0b\u5e76\u53d1\u7684\u573a\u666f\u4e0b"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4f20\u9012\u6570\u636e\uff1a\u901a\u8fc7 ThreadLocal \u5b9e\u73b0\u5728\u540c\u4e00\u7ebf\u7a0b\u4e0d\u540c\u51fd\u6570\u6216\u7ec4\u4ef6\u4e2d\u4f20\u9012\u516c\u5171\u53d8\u91cf\uff0c\u51cf\u5c11\u4f20\u9012\u590d\u6742\u5ea6"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u9694\u79bb\uff1a\u6bcf\u4e2a\u7ebf\u7a0b\u7684\u53d8\u91cf\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u4e0d\u4f1a\u4e92\u76f8\u5f71\u54cd"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u6bd4 synchronized\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{}),(0,r.jsx)(e.th,{children:"synchronized"}),(0,r.jsx)(e.th,{children:"ThreadLocal"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u539f\u7406"}),(0,r.jsxs)(e.td,{children:["\u540c\u6b65\u673a\u5236\u91c7\u7528",(0,r.jsx)(e.strong,{children:"\u4ee5\u65f6\u95f4\u6362\u7a7a\u95f4"}),"\u7684\u65b9\u5f0f\uff0c\u53ea\u63d0\u4f9b\u4e86\u4e00\u4efd\u53d8\u91cf\uff0c\u8ba9\u4e0d\u540c\u7684\u7ebf\u7a0b\u6392\u961f\u8bbf\u95ee"]}),(0,r.jsxs)(e.td,{children:["ThreadLocal \u91c7\u7528",(0,r.jsx)(e.strong,{children:"\u4ee5\u7a7a\u95f4\u6362\u65f6\u95f4"}),"\u7684\u65b9\u5f0f\uff0c\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u63d0\u4f9b\u4e86\u4e00\u4efd\u53d8\u91cf\u7684\u526f\u672c\uff0c\u4ece\u800c\u5b9e\u73b0\u540c\u65f6\u8bbf\u95ee\u800c\u76f8\u4e0d\u5e72\u6270"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u4fa7\u91cd\u70b9"}),(0,r.jsx)(e.td,{children:"\u591a\u4e2a\u7ebf\u7a0b\u4e4b\u95f4\u8bbf\u95ee\u8d44\u6e90\u7684\u540c\u6b65"}),(0,r.jsx)(e.td,{children:"\u591a\u7ebf\u7a0b\u4e2d\u8ba9\u6bcf\u4e2a\u7ebf\u7a0b\u4e4b\u95f4\u7684\u6570\u636e\u76f8\u4e92\u9694\u79bb"})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4f7f\u7528-1",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsx)(e.h5,{id:"\u5e38\u7528\u65b9\u6cd5",children:"\u5e38\u7528\u65b9\u6cd5"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u63cf\u8ff0"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"ThreadLocal<>()"}),(0,r.jsx)(e.td,{children:"\u521b\u5efa ThreadLocal \u5bf9\u8c61"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"protected T initialValue()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u5f53\u524d\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf\u7684\u521d\u59cb\u503c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public void set( T value)"}),(0,r.jsx)(e.td,{children:"\u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u7ed1\u5b9a\u7684\u5c40\u90e8\u53d8\u91cf"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public T get()"}),(0,r.jsx)(e.td,{children:"\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u7ed1\u5b9a\u7684\u5c40\u90e8\u53d8\u91cf"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public void remove()"}),(0,r.jsx)(e.td,{children:"\u79fb\u9664\u5f53\u524d\u7ebf\u7a0b\u7ed1\u5b9a\u7684\u5c40\u90e8\u53d8\u91cf"})]})]})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class MyDemo {\n\n    private static ThreadLocal<String> tl = new ThreadLocal<>();\n\n    private String content;\n\n    private String getContent() {\n        // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u7ed1\u5b9a\u7684\u53d8\u91cf\n        return tl.get();\n    }\n\n    private void setContent(String content) {\n        // \u53d8\u91cfcontent\u7ed1\u5b9a\u5230\u5f53\u524d\u7ebf\u7a0b\n        tl.set(content);\n    }\n\n    public static void main(String[] args) {\n        MyDemo demo = new MyDemo();\n        for (int i = 0; i < 5; i++) {\n            Thread thread = new Thread(new Runnable() {\n                @Override\n                public void run() {\n                    // \u8bbe\u7f6e\u6570\u636e\n                    demo.setContent(Thread.currentThread().getName() + "\u7684\u6570\u636e");\n                    System.out.println("-----------------------");\n                    System.out.println(Thread.currentThread().getName() + "---\x3e" + demo.getContent());\n                }\n            });\n            thread.setName("\u7ebf\u7a0b" + i);\n            thread.start();\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5e94\u7528\u573a\u666f",children:"\u5e94\u7528\u573a\u666f"}),"\n",(0,r.jsx)(e.p,{children:"ThreadLocal \u9002\u7528\u4e8e\u4e0b\u9762\u4e24\u79cd\u573a\u666f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6bcf\u4e2a\u7ebf\u7a0b\u9700\u8981\u6709\u81ea\u5df1\u5355\u72ec\u7684\u5b9e\u4f8b"}),"\n",(0,r.jsx)(e.li,{children:"\u5b9e\u4f8b\u9700\u8981\u5728\u591a\u4e2a\u65b9\u6cd5\u4e2d\u5171\u4eab\uff0c\u4f46\u4e0d\u5e0c\u671b\u88ab\u591a\u7ebf\u7a0b\u5171\u4eab"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"ThreadLocal \u65b9\u6848\u6709\u4e24\u4e2a\u7a81\u51fa\u7684\u4f18\u52bf\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f20\u9012\u6570\u636e\uff1a\u4fdd\u5b58\u6bcf\u4e2a\u7ebf\u7a0b\u7ed1\u5b9a\u7684\u6570\u636e\uff0c\u5728\u9700\u8981\u7684\u5730\u65b9\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\uff0c\u907f\u514d\u53c2\u6570\u76f4\u63a5\u4f20\u9012\u5e26\u6765\u7684\u4ee3\u7801\u8026\u5408\u95ee\u9898"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u9694\u79bb\uff1a\u5404\u7ebf\u7a0b\u4e4b\u95f4\u7684\u6570\u636e\u76f8\u4e92\u9694\u79bb\u5374\u53c8\u5177\u5907\u5e76\u53d1\u6027\uff0c\u907f\u514d\u540c\u6b65\u65b9\u5f0f\u5e26\u6765\u7684\u6027\u80fd\u635f\u5931"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"ThreadLocal \u7528\u4e8e\u6570\u636e\u8fde\u63a5\u7684\u4e8b\u52a1\u7ba1\u7406\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class JdbcUtils {\n    // ThreadLocal\u5bf9\u8c61\uff0c\u5c06connection\u7ed1\u5b9a\u5728\u5f53\u524d\u7ebf\u7a0b\u4e2d\n    private static final ThreadLocal<Connection> tl = new ThreadLocal();\n    // c3p0 \u6570\u636e\u5e93\u8fde\u63a5\u6c60\u5bf9\u8c61\u5c5e\u6027\n    private static final ComboPooledDataSource ds = new ComboPooledDataSource();\n    // \u83b7\u53d6\u8fde\u63a5\n    public static Connection getConnection() throws SQLException {\n        //\u53d6\u51fa\u5f53\u524d\u7ebf\u7a0b\u7ed1\u5b9a\u7684connection\u5bf9\u8c61\n        Connection conn = tl.get();\n        if (conn == null) {\n            //\u5982\u679c\u6ca1\u6709\uff0c\u5219\u4ece\u8fde\u63a5\u6c60\u4e2d\u53d6\u51fa\n            conn = ds.getConnection();\n            //\u518d\u5c06connection\u5bf9\u8c61\u7ed1\u5b9a\u5230\u5f53\u524d\u7ebf\u7a0b\u4e2d\uff0c\u975e\u5e38\u91cd\u8981\u7684\u64cd\u4f5c\n            tl.set(conn);\n        }\n        return conn;\n    }\n\t// ...\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u7528 ThreadLocal \u4f7f SimpleDateFormat \u4ece\u72ec\u4eab\u53d8\u91cf\u53d8\u6210\u5355\u4e2a\u7ebf\u7a0b\u53d8\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ThreadLocalDateUtil {\n    private static ThreadLocal<DateFormat> threadLocal = new ThreadLocal<DateFormat>() {\n        @Override\n        protected DateFormat initialValue() {\n            return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");\n        }\n    };\n\n    public static Date parse(String dateStr) throws ParseException {\n        return threadLocal.get().parse(dateStr);\n    }\n\n    public static String format(Date date) {\n        return threadLocal.get().format(date);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b9e\u73b0\u539f\u7406",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.h5,{id:"\u5e95\u5c42\u7ed3\u6784",children:"\u5e95\u5c42\u7ed3\u6784"}),"\n",(0,r.jsx)(e.p,{children:"JDK8 \u4ee5\u524d\uff1a\u6bcf\u4e2a ThreadLocal \u90fd\u521b\u5efa\u4e00\u4e2a Map\uff0c\u7136\u540e\u7528\u7ebf\u7a0b\u4f5c\u4e3a Map \u7684 key\uff0c\u8981\u5b58\u50a8\u7684\u5c40\u90e8\u53d8\u91cf\u4f5c\u4e3a Map \u7684 value\uff0c\u8fbe\u5230\u5404\u4e2a\u7ebf\u7a0b\u7684\u5c40\u90e8\u53d8\u91cf\u9694\u79bb\u7684\u6548\u679c\u3002\u8fd9\u79cd\u7ed3\u6784\u4f1a\u9020\u6210 Map \u7ed3\u6784\u8fc7\u5927\u548c\u5185\u5b58\u6cc4\u9732\uff0c\u56e0\u4e3a Thread \u505c\u6b62\u540e\u65e0\u6cd5\u901a\u8fc7 key \u5220\u9664\u5bf9\u5e94\u7684\u6570\u636e"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(34053).A+"",width:"697",height:"314"})}),"\n",(0,r.jsx)(e.p,{children:"JDK8 \u4ee5\u540e\uff1a\u6bcf\u4e2a Thread \u7ef4\u62a4\u4e00\u4e2a ThreadLocalMap\uff0c\u8fd9\u4e2a Map \u7684 key \u662f ThreadLocal \u5b9e\u4f8b\u672c\u8eab\uff0cvalue \u662f\u771f\u6b63\u8981\u5b58\u50a8\u7684\u503c"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"\u6bcf\u4e2a Thread \u7ebf\u7a0b\u5185\u90e8\u90fd\u6709\u4e00\u4e2a Map (ThreadLocalMap)"})}),"\n",(0,r.jsx)(e.li,{children:"Map \u91cc\u9762\u5b58\u50a8 ThreadLocal \u5bf9\u8c61\uff08key\uff09\u548c\u7ebf\u7a0b\u7684\u79c1\u6709\u53d8\u91cf\uff08value\uff09"}),"\n",(0,r.jsx)(e.li,{children:"Thread \u5185\u90e8\u7684 Map \u662f\u7531 ThreadLocal \u7ef4\u62a4\u7684\uff0c\u7531 ThreadLocal \u8d1f\u8d23\u5411 map \u83b7\u53d6\u548c\u8bbe\u7f6e\u7ebf\u7a0b\u7684\u53d8\u91cf\u503c"}),"\n",(0,r.jsx)(e.li,{children:"\u5bf9\u4e8e\u4e0d\u540c\u7684\u7ebf\u7a0b\uff0c\u6bcf\u6b21\u83b7\u53d6\u526f\u672c\u503c\u65f6\uff0c\u522b\u7684\u7ebf\u7a0b\u5e76\u4e0d\u80fd\u83b7\u53d6\u5230\u5f53\u524d\u7ebf\u7a0b\u7684\u526f\u672c\u503c\uff0c\u5f62\u6210\u526f\u672c\u7684\u9694\u79bb\uff0c\u4e92\u4e0d\u5e72\u6270"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(85678).A+"",width:"672",height:"296"})}),"\n",(0,r.jsx)(e.p,{children:"JDK8 \u524d\u540e\u5bf9\u6bd4\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6bcf\u4e2a Map \u5b58\u50a8\u7684 Entry \u6570\u91cf\u4f1a\u53d8\u5c11\uff0c\u56e0\u4e3a\u4e4b\u524d\u7684\u5b58\u50a8\u6570\u91cf\u7531 Thread \u7684\u6570\u91cf\u51b3\u5b9a\uff0c\u73b0\u5728\u7531 ThreadLocal \u7684\u6570\u91cf\u51b3\u5b9a\uff0c\u5728\u5b9e\u9645\u7f16\u7a0b\u5f53\u4e2d\uff0c\u5f80\u5f80 ThreadLocal \u7684\u6570\u91cf\u8981\u5c11\u4e8e Thread \u7684\u6570\u91cf"}),"\n",(0,r.jsxs)(e.li,{children:["\u5f53 Thread \u9500\u6bc1\u4e4b\u540e\uff0c\u5bf9\u5e94\u7684 ThreadLocalMap \u4e5f\u4f1a\u968f\u4e4b\u9500\u6bc1\uff0c\u80fd\u51cf\u5c11\u5185\u5b58\u7684\u4f7f\u7528\uff0c",(0,r.jsx)(e.strong,{children:"\u9632\u6b62\u5185\u5b58\u6cc4\u9732"})]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u53d8\u91cf",children:"\u6210\u5458\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Thread \u7c7b\u7684\u76f8\u5173\u5c5e\u6027\uff1a",(0,r.jsx)(e.strong,{children:"\u6bcf\u4e00\u4e2a\u7ebf\u7a0b\u6301\u6709\u4e00\u4e2a ThreadLocalMap \u5bf9\u8c61"}),"\uff0c\u5b58\u653e\u7531 ThreadLocal \u548c\u6570\u636e\u7ec4\u6210\u7684 Entry \u952e\u503c\u5bf9"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"ThreadLocal.ThreadLocalMap threadLocals = null\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8ba1\u7b97 ThreadLocal \u5bf9\u8c61\u7684\u54c8\u5e0c\u503c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final int threadLocalHashCode = nextHashCode()\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u4f7f\u7528 ",(0,r.jsx)(e.code,{children:"threadLocalHashCode & (table.length - 1)"})," \u8ba1\u7b97\u5f53\u524d entry \u9700\u8981\u5b58\u653e\u7684\u4f4d\u7f6e"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6bcf\u521b\u5efa\u4e00\u4e2a ThreadLocal \u5bf9\u8c61\u5c31\u4f1a\u4f7f\u7528 nextHashCode \u5206\u914d\u4e00\u4e2a hash \u503c\u7ed9\u8fd9\u4e2a\u5bf9\u8c61\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static AtomicInteger nextHashCode = new AtomicInteger()\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6590\u6ce2\u90a3\u5951\u6570\u4e5f\u53eb\u9ec4\u91d1\u5206\u5272\u6570\uff0chash \u7684",(0,r.jsx)(e.strong,{children:"\u589e\u91cf"}),"\u5c31\u662f\u8fd9\u4e2a\u6570\u5b57\uff0c\u5e26\u6765\u7684\u597d\u5904\u662f hash \u5206\u5e03\u975e\u5e38\u5747\u5300\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final int HASH_INCREMENT = 0x61c88647\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u65b9\u6cd5",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u65b9\u6cd5\u90fd\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u56e0\u4e3a ThreadLocal \u5c5e\u4e8e\u4e00\u4e2a\u7ebf\u7a0b\u7684\uff0cThreadLocal \u4e2d\u7684\u65b9\u6cd5\uff0c\u903b\u8f91\u90fd\u662f\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u7ef4\u62a4\u7684 ThreadLocalMap \u5bf9\u8c61\uff0c\u7136\u540e\u8fdb\u884c\u6570\u636e\u7684\u589e\u5220\u6539\u67e5\uff0c\u6ca1\u6709\u6307\u5b9a\u521d\u59cb\u503c\u7684 threadlcoal \u5bf9\u8c61\u9ed8\u8ba4\u8d4b\u503c\u4e3a null"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initialValue()\uff1a\u8fd4\u56de\u8be5\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf\u7684\u521d\u59cb\u503c"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5ef6\u8fdf\u8c03\u7528\u7684\u65b9\u6cd5\uff0c\u5728\u6267\u884c get \u65b9\u6cd5\u65f6\u624d\u6267\u884c"}),"\n",(0,r.jsx)(e.li,{children:"\u8be5\u65b9\u6cd5\u7f3a\u7701\uff08\u9ed8\u8ba4\uff09\u5b9e\u73b0\u76f4\u63a5\u8fd4\u56de\u4e00\u4e2a null"}),"\n",(0,r.jsxs)(e.li,{children:["\u5982\u679c\u60f3\u8981\u4e00\u4e2a\u521d\u59cb\u503c\uff0c\u53ef\u4ee5\u91cd\u5199\u6b64\u65b9\u6cd5\uff0c \u8be5\u65b9\u6cd5\u662f\u4e00\u4e2a ",(0,r.jsx)(e.code,{children:"protected"})," \u7684\u65b9\u6cd5\uff0c\u4e3a\u4e86\u8ba9\u5b50\u7c7b\u8986\u76d6\u800c\u8bbe\u8ba1\u7684"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected T initialValue() {\n    return null;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["nextHashCode()\uff1a\u8ba1\u7b97\u54c8\u5e0c\u503c\uff0cThreadLocal \u7684\u6563\u5217\u65b9\u5f0f\u79f0\u4e4b\u4e3a",(0,r.jsx)(e.strong,{children:"\u6590\u6ce2\u90a3\u5951\u6563\u5217"}),"\uff0c\u6bcf\u6b21\u83b7\u53d6\u54c8\u5e0c\u503c\u90fd\u4f1a\u52a0\u4e0a HASH_INCREMENT\uff0c\u8fd9\u6837\u505a\u53ef\u4ee5\u5c3d\u91cf\u907f\u514d hash \u51b2\u7a81\uff0c\u8ba9\u54c8\u5e0c\u503c\u80fd\u5747\u5300\u7684\u5206\u5e03\u5728 2 \u7684 n \u6b21\u65b9\u7684\u6570\u7ec4\u4e2d"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static int nextHashCode() {\n    // \u54c8\u5e0c\u503c\u81ea\u589e\u4e00\u4e2a HASH_INCREMENT \u6570\u503c\n    return nextHashCode.getAndAdd(HASH_INCREMENT);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"set()\uff1a\u4fee\u6539\u5f53\u524d\u7ebf\u7a0b\u4e0e\u5f53\u524d threadlocal \u5bf9\u8c61\u76f8\u5173\u8054\u7684\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void set(T value) {\n    // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u5bf9\u8c61\n    Thread t = Thread.currentThread();\n    // \u83b7\u53d6\u6b64\u7ebf\u7a0b\u5bf9\u8c61\u4e2d\u7ef4\u62a4\u7684 ThreadLocalMap \u5bf9\u8c61\n    ThreadLocalMap map = getMap(t);\n    // \u5224\u65ad map \u662f\u5426\u5b58\u5728\n    if (map != null)\n        // \u8c03\u7528 threadLocalMap.set \u65b9\u6cd5\u8fdb\u884c\u91cd\u5199\u6216\u8005\u6dfb\u52a0\n        map.set(this, value);\n    else\n        // map \u4e3a\u7a7a\uff0c\u8c03\u7528 createMap \u8fdb\u884c ThreadLocalMap \u5bf9\u8c61\u7684\u521d\u59cb\u5316\u3002\u53c2\u65701\u662f\u5f53\u524d\u7ebf\u7a0b\uff0c\u53c2\u65702\u662f\u5c40\u90e8\u53d8\u91cf\n        createMap(t, value);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b Thread \u5bf9\u5e94\u7ef4\u62a4\u7684 ThreadLocalMap \nThreadLocalMap getMap(Thread t) {\n    return t.threadLocals;\n}\n// \u521b\u5efa\u5f53\u524d\u7ebf\u7a0bThread\u5bf9\u5e94\u7ef4\u62a4\u7684ThreadLocalMap \nvoid createMap(Thread t, T firstValue) {\n    // \u3010\u8fd9\u91cc\u7684 this \u662f\u8c03\u7528\u6b64\u65b9\u6cd5\u7684 threadLocal\u3011\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Map \u5e76\u8bbe\u7f6e\u7b2c\u4e00\u4e2a\u6570\u636e\n    t.threadLocals = new ThreadLocalMap(this, firstValue);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"get()\uff1a\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u4e0e\u5f53\u524d ThreadLocal \u5bf9\u8c61\u76f8\u5173\u8054\u7684\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public T get() {\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    // \u5982\u679c\u6b64map\u5b58\u5728\n    if (map != null) {\n        // \u4ee5\u5f53\u524d\u7684 ThreadLocal \u4e3a key\uff0c\u8c03\u7528 getEntry \u83b7\u53d6\u5bf9\u5e94\u7684\u5b58\u50a8\u5b9e\u4f53 e\n        ThreadLocalMap.Entry e = map.getEntry(this);\n        // \u5bf9 e \u8fdb\u884c\u5224\u7a7a \n        if (e != null) {\n            // \u83b7\u53d6\u5b58\u50a8\u5b9e\u4f53 e \u5bf9\u5e94\u7684 value\u503c\n            T result = (T)e.value;\n            return result;\n        }\n    }\n    /*\u6709\u4e24\u79cd\u60c5\u51b5\u6709\u6267\u884c\u5f53\u524d\u4ee3\u7801\n      \u7b2c\u4e00\u79cd\u60c5\u51b5: map \u4e0d\u5b58\u5728\uff0c\u8868\u793a\u6b64\u7ebf\u7a0b\u6ca1\u6709\u7ef4\u62a4\u7684 ThreadLocalMap \u5bf9\u8c61\n      \u7b2c\u4e8c\u79cd\u60c5\u51b5: map \u5b58\u5728, \u4f46\u662f\u3010\u6ca1\u6709\u4e0e\u5f53\u524d ThreadLocal \u5173\u8054\u7684 entry\u3011\uff0c\u5c31\u4f1a\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u503c */\n    // \u521d\u59cb\u5316\u5f53\u524d\u7ebf\u7a0b\u4e0e\u5f53\u524d threadLocal \u5bf9\u8c61\u76f8\u5173\u8054\u7684 value\n    return setInitialValue();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private T setInitialValue() {\n    // \u8c03\u7528initialValue\u83b7\u53d6\u521d\u59cb\u5316\u7684\u503c\uff0c\u6b64\u65b9\u6cd5\u53ef\u4ee5\u88ab\u5b50\u7c7b\u91cd\u5199, \u5982\u679c\u4e0d\u91cd\u5199\u9ed8\u8ba4\u8fd4\u56de null\n    T value = initialValue();\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    // \u5224\u65ad map \u662f\u5426\u521d\u59cb\u5316\u8fc7\n    if (map != null)\n        // \u5b58\u5728\u5219\u8c03\u7528 map.set \u8bbe\u7f6e\u6b64\u5b9e\u4f53 entry\uff0cvalue \u662f\u9ed8\u8ba4\u7684\u503c\n        map.set(this, value);\n    else\n        // \u8c03\u7528 createMap \u8fdb\u884c ThreadLocalMap \u5bf9\u8c61\u7684\u521d\u59cb\u5316\u4e2d\n        createMap(t, value);\n    // \u8fd4\u56de\u7ebf\u7a0b\u4e0e\u5f53\u524d threadLocal \u5173\u8054\u7684\u5c40\u90e8\u53d8\u91cf\n    return value;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"remove()\uff1a\u79fb\u9664\u5f53\u524d\u7ebf\u7a0b\u4e0e\u5f53\u524d threadLocal \u5bf9\u8c61\u76f8\u5173\u8054\u7684\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void remove() {\n    // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u5bf9\u8c61\u4e2d\u7ef4\u62a4\u7684 ThreadLocalMap \u5bf9\u8c61\n    ThreadLocalMap m = getMap(Thread.currentThread());\n    if (m != null)\n        // map \u5b58\u5728\u5219\u8c03\u7528 map.remove\uff0cthis\u65f6\u5f53\u524dThreadLocal\uff0c\u4ee5this\u4e3akey\u5220\u9664\u5bf9\u5e94\u7684\u5b9e\u4f53\n        m.remove(this);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"localmap",children:"LocalMap"}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u5c5e\u6027",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsx)(e.p,{children:"ThreadLocalMap \u662f ThreadLocal \u7684\u5185\u90e8\u7c7b\uff0c\u6ca1\u6709\u5b9e\u73b0 Map \u63a5\u53e3\uff0c\u7528\u72ec\u7acb\u7684\u65b9\u5f0f\u5b9e\u73b0\u4e86 Map \u7684\u529f\u80fd\uff0c\u5176\u5185\u90e8 Entry \u4e5f\u662f\u72ec\u7acb\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u521d\u59cb\u5316\u5f53\u524d map \u5185\u90e8\u6563\u5217\u8868\u6570\u7ec4\u7684\u521d\u59cb\u957f\u5ea6 16\nprivate static final int INITIAL_CAPACITY = 16;\n\n// \u5b58\u653e\u6570\u636e\u7684table\uff0c\u6570\u7ec4\u957f\u5ea6\u5fc5\u987b\u662f2\u7684\u6574\u6b21\u5e42\u3002\nprivate Entry[] table;\n\n// \u6570\u7ec4\u91cc\u9762 entrys \u7684\u4e2a\u6570\uff0c\u53ef\u4ee5\u7528\u4e8e\u5224\u65ad table \u5f53\u524d\u4f7f\u7528\u91cf\u662f\u5426\u8d85\u8fc7\u9608\u503c\nprivate int size = 0;\n\n// \u8fdb\u884c\u6269\u5bb9\u7684\u9608\u503c\uff0c\u8868\u4f7f\u7528\u91cf\u5927\u4e8e\u5b83\u7684\u65f6\u5019\u8fdb\u884c\u6269\u5bb9\u3002\nprivate int threshold;\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5b58\u50a8\u7ed3\u6784 Entry\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Entry \u7ee7\u627f WeakReference\uff0ckey \u662f\u5f31\u5f15\u7528\uff0c\u76ee\u7684\u662f\u5c06 ThreadLocal \u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f\u548c\u7ebf\u7a0b\u751f\u547d\u5468\u671f\u89e3\u7ed1"}),"\n",(0,r.jsx)(e.li,{children:"Entry \u9650\u5236\u53ea\u80fd\u7528 ThreadLocal \u4f5c\u4e3a key\uff0ckey \u4e3a null (entry.get() == null) \u610f\u5473\u7740 key \u4e0d\u518d\u88ab\u5f15\u7528\uff0centry \u4e5f\u53ef\u4ee5\u4ece table \u4e2d\u6e05\u9664"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static class Entry extends WeakReference<ThreadLocal<?>> {\n    Object value;\n    Entry(ThreadLocal<?> k, Object v) {\n        // this.referent = referent = key;\n        super(k);\n        value = v;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a\u5ef6\u8fdf\u521d\u59cb\u5316\u7684\uff0c\u7ebf\u7a0b\u7b2c\u4e00\u6b21\u5b58\u50a8 threadLocal - value \u65f6\u624d\u4f1a\u521b\u5efa threadLocalMap \u5bf9\u8c61"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n    // \u521d\u59cb\u5316table\uff0c\u521b\u5efa\u4e00\u4e2a\u957f\u5ea6\u4e3a16\u7684Entry\u6570\u7ec4\n    table = new Entry[INITIAL_CAPACITY];\n    // \u3010\u5bfb\u5740\u7b97\u6cd5\u3011\u8ba1\u7b97\u7d22\u5f15\n    int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n    // \u521b\u5efa entry \u5bf9\u8c61\uff0c\u5b58\u653e\u5230\u6307\u5b9a\u4f4d\u7f6e\u7684 slot \u4e2d\n    table[i] = new Entry(firstKey, firstValue);\n    // \u6570\u636e\u603b\u91cf\u662f 1\n    size = 1;\n    // \u5c06\u9608\u503c\u8bbe\u7f6e\u4e3a \uff08\u5f53\u524d\u6570\u7ec4\u957f\u5ea6 * 2\uff09/ 3\u3002\n    setThreshold(INITIAL_CAPACITY);\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u65b9\u6cd5-1",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["set()\uff1a\u6dfb\u52a0\u6570\u636e\uff0cThreadLocalMap \u4f7f\u7528",(0,r.jsx)(e.strong,{children:"\u7ebf\u6027\u63a2\u6d4b\u6cd5\u6765\u89e3\u51b3\u54c8\u5e0c\u51b2\u7a81"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8be5\u65b9\u6cd5\u4f1a\u4e00\u76f4\u63a2\u6d4b\u4e0b\u4e00\u4e2a\u5730\u5740\uff0c\u76f4\u5230\u6709\u7a7a\u7684\u5730\u5740\u540e\u63d2\u5165\uff0c\u82e5\u63d2\u5165\u540e Map \u6570\u91cf\u8d85\u8fc7\u9608\u503c\uff0c\u6570\u7ec4\u4f1a\u6269\u5bb9\u4e3a\u539f\u6765\u7684 2 \u500d"}),"\n",(0,r.jsxs)(e.p,{children:["\u5047\u8bbe\u5f53\u524d table \u957f\u5ea6\u4e3a16\uff0c\u8ba1\u7b97\u51fa\u6765 key \u7684 hash \u503c\u4e3a 14\uff0c\u5982\u679c table[14] \u4e0a\u5df2\u7ecf\u6709\u503c\uff0c\u5e76\u4e14\u5176 key \u4e0e\u5f53\u524d key \u4e0d\u4e00\u81f4\uff0c\u90a3\u4e48\u5c31\u53d1\u751f\u4e86 hash \u51b2\u7a81\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c06 14 \u52a0 1 \u5f97\u5230 15\uff0c\u53d6 table[15] \u8fdb\u884c\u5224\u65ad\uff0c\u5982\u679c\u8fd8\u662f\u51b2\u7a81\u4f1a\u56de\u5230 0\uff0c\u53d6 table[0]\uff0c\u4ee5\u6b64\u7c7b\u63a8\uff0c\u76f4\u5230\u53ef\u4ee5\u63d2\u5165\uff0c\u53ef\u4ee5\u628a Entry[]  table \u770b\u6210\u4e00\u4e2a",(0,r.jsx)(e.strong,{children:"\u73af\u5f62\u6570\u7ec4"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u7ebf\u6027\u63a2\u6d4b\u6cd5\u4f1a\u51fa\u73b0",(0,r.jsx)(e.strong,{children:"\u5806\u79ef\u95ee\u9898"}),"\uff0c\u53ef\u4ee5\u91c7\u53d6\u5e73\u65b9\u63a2\u6d4b\u6cd5\u89e3\u51b3"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5728\u63a2\u6d4b\u8fc7\u7a0b\u4e2d ThreadLocal \u4f1a\u590d\u7528 key \u4e3a null \u7684\u810f Entry \u5bf9\u8c61\uff0c\u5e76\u8fdb\u884c\u5783\u573e\u6e05\u7406\uff0c\u9632\u6b62\u51fa\u73b0\u5185\u5b58\u6cc4\u6f0f"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void set(ThreadLocal<?> key, Object value) {\n    // \u83b7\u53d6\u6563\u5217\u8868\n    ThreadLocal.ThreadLocalMap.Entry[] tab = table;\n    int len = tab.length;\n    // \u54c8\u5e0c\u5bfb\u5740\n    int i = key.threadLocalHashCode & (len-1);\n    // \u4f7f\u7528\u7ebf\u6027\u63a2\u6d4b\u6cd5\u5411\u540e\u67e5\u627e\u5143\u7d20\uff0c\u78b0\u5230 entry \u4e3a\u7a7a\u65f6\u505c\u6b62\u63a2\u6d4b\n    for (ThreadLocal.ThreadLocalMap.Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {\n        // \u83b7\u53d6\u5f53\u524d\u5143\u7d20 key\n        ThreadLocal<?> k = e.get();\n        // ThreadLocal \u5bf9\u5e94\u7684 key \u5b58\u5728\uff0c\u3010\u76f4\u63a5\u8986\u76d6\u4e4b\u524d\u7684\u503c\u3011\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n        // \u3010\u8fd9\u4e24\u4e2a\u6761\u4ef6\u8c01\u5148\u6210\u7acb\u4e0d\u4e00\u5b9a\uff0c\u6240\u4ee5 replaceStaleEntry \u4e2d\u8fd8\u9700\u8981\u5224\u65ad k == key \u7684\u60c5\u51b5\u3011\n        \n        // key \u4e3a null\uff0c\u4f46\u662f\u503c\u4e0d\u4e3a null\uff0c\u8bf4\u660e\u4e4b\u524d\u7684 ThreadLocal \u5bf9\u8c61\u5df2\u7ecf\u88ab\u56de\u6536\u4e86\uff0c\u5f53\u524d\u662f\u3010\u8fc7\u671f\u6570\u636e\u3011\n        if (k == null) {\n            // \u3010\u78b0\u5230\u4e00\u4e2a\u8fc7\u671f\u7684 slot\uff0c\u5f53\u524d\u6570\u636e\u590d\u7528\u8be5\u69fd\u4f4d\uff0c\u66ff\u6362\u8fc7\u671f\u6570\u636e\u3011\n            // \u8fd9\u4e2a\u65b9\u6cd5\u8fd8\u8fdb\u884c\u4e86\u5783\u573e\u6e05\u7406\u52a8\u4f5c\uff0c\u9632\u6b62\u5185\u5b58\u6cc4\u6f0f\n            replaceStaleEntry(key, value, i);\n            return;\n        }\n    }\n\t// \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u78b0\u5230 slot == null \u7684\u4f4d\u7f6e\uff0c\u5219\u5728\u7a7a\u5143\u7d20\u7684\u4f4d\u7f6e\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Entry\n    tab[i] = new Entry(key, value);\n    // \u6570\u91cf + 1\n    int sz = ++size;\n    \n    // \u3010\u505a\u4e00\u6b21\u542f\u53d1\u5f0f\u6e05\u7406\u3011\uff0c\u5982\u679c\u6ca1\u6709\u6e05\u9664\u4efb\u4f55 entry \u5e76\u4e14\u3010\u5f53\u524d\u4f7f\u7528\u91cf\u8fbe\u5230\u4e86\u8d1f\u8f7d\u56e0\u5b50\u6240\u5b9a\u4e49\uff0c\u90a3\u4e48\u8fdb\u884c rehash\n    if (!cleanSomeSlots(i, sz) && sz >= threshold)\n        // \u6269\u5bb9\n        rehash();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u83b7\u53d6\u3010\u73af\u5f62\u6570\u7ec4\u3011\u7684\u4e0b\u4e00\u4e2a\u7d22\u5f15\nprivate static int nextIndex(int i, int len) {\n    // \u7d22\u5f15\u8d8a\u754c\u540e\u4ece 0 \u5f00\u59cb\u7ee7\u7eed\u83b7\u53d6\n    return ((i + 1 < len) ? i + 1 : 0);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5728\u6307\u5b9a\u4f4d\u7f6e\u63d2\u5165\u6307\u5b9a\u7684\u6570\u636e\nprivate void replaceStaleEntry(ThreadLocal<?> key, Object value, int staleSlot) {\n    // \u83b7\u53d6\u6563\u5217\u8868\n    Entry[] tab = table;\n    int len = tab.length;\n    Entry e;\n\t// \u63a2\u6d4b\u5f0f\u6e05\u7406\u7684\u5f00\u59cb\u4e0b\u6807\uff0c\u9ed8\u8ba4\u4ece\u5f53\u524d staleSlot \u5f00\u59cb\n    int slotToExpunge = staleSlot;\n    // \u4ee5\u5f53\u524d staleSlot \u5f00\u59cb\u3010\u5411\u524d\u8fed\u4ee3\u67e5\u627e\u3011\uff0c\u627e\u5230\u7d22\u5f15\u9760\u524d\u8fc7\u671f\u6570\u636e\uff0c\u627e\u5230\u4ee5\u540e\u66ff\u6362 slotToExpunge \u503c\n    // \u3010\u4fdd\u8bc1\u5728\u4e00\u4e2a\u533a\u95f4\u6bb5\u5185\uff0c\u4ece\u6700\u524d\u9762\u7684\u8fc7\u671f\u6570\u636e\u5f00\u59cb\u6e05\u7406\u3011\n    for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len))\n        if (e.get() == null)\n            slotToExpunge = i;\n\n\t// \u4ee5 staleSlot \u3010\u5411\u540e\u53bb\u67e5\u627e\u3011\uff0c\u76f4\u5230\u78b0\u5230 null \u4e3a\u6b62\uff0c\u8fd8\u662f\u7ebf\u6027\u63a2\u6d4b\n    for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {\n        // \u83b7\u53d6\u5f53\u524d\u8282\u70b9\u7684 key\n        ThreadLocal<?> k = e.get();\n\t\t// \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u662f\u3010\u66ff\u6362\u903b\u8f91\u3011\n        if (k == key) {\n            e.value = value;\n            // \u56e0\u4e3a\u672c\u6765\u8981\u5728 staleSlot \u7d22\u5f15\u5904\u63d2\u5165\u8be5\u6570\u636e\uff0c\u73b0\u5728\u627e\u5230\u4e86i\u7d22\u5f15\u5904\u7684key\u4e0e\u6570\u636e\u4e00\u81f4\n            // \u4f46\u662f i \u4f4d\u7f6e\u8ddd\u79bb\u6b63\u786e\u7684\u4f4d\u7f6e\u66f4\u8fdc\uff0c\u56e0\u4e3a\u662f\u5411\u540e\u67e5\u627e\uff0c\u6240\u4ee5\u8fd8\u662f\u8981\u5728 staleSlot \u4f4d\u7f6e\u63d2\u5165\u5f53\u524d entry\n            // \u7136\u540e\u5c06 table[staleSlot] \u8fd9\u4e2a\u8fc7\u671f\u6570\u636e\u653e\u5230\u5f53\u524d\u5faa\u73af\u5230\u7684 table[i] \u8fd9\u4e2a\u4f4d\u7f6e\uff0c\n            tab[i] = tab[staleSlot];\n            tab[staleSlot] = e;\n\t\t\t\n            // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5411\u524d\u67e5\u627e\u8fc7\u671f\u6570\u636e\u5e76\u672a\u627e\u5230\u8fc7\u671f\u7684 entry\uff0c\u4f46 staleSlot \u4f4d\u7f6e\u5df2\u7ecf\u4e0d\u662f\u8fc7\u671f\u6570\u636e\u4e86\uff0ci \u4f4d\u7f6e\u624d\u662f\n            if (slotToExpunge == staleSlot)\n                slotToExpunge = i;\n            \n            // \u3010\u6e05\u7406\u8fc7\u671f\u6570\u636e\uff0cexpungeStaleEntry \u63a2\u6d4b\u5f0f\u6e05\u7406\uff0ccleanSomeSlots \u542f\u53d1\u5f0f\u6e05\u7406\u3011\n            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n            return;\n        }\n\t\t// \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u904d\u5386\u7684 entry \u662f\u4e00\u4e2a\u8fc7\u671f\u6570\u636e\uff0c\u5e76\u4e14\u8be5\u4f4d\u7f6e\u524d\u9762\u4e5f\u6ca1\u6709\u8fc7\u671f\u6570\u636e\n        if (k == null && slotToExpunge == staleSlot)\n            // \u63a2\u6d4b\u5f0f\u6e05\u7406\u8fc7\u671f\u6570\u636e\u7684\u5f00\u59cb\u4e0b\u6807\u4fee\u6539\u4e3a\u5f53\u524d\u5faa\u73af\u7684 index\uff0c\u56e0\u4e3a staleSlot \u4f1a\u653e\u5165\u8981\u6dfb\u52a0\u7684\u6570\u636e\n            slotToExpunge = i;\n    }\n\t// \u5411\u540e\u67e5\u627e\u8fc7\u7a0b\u4e2d\u5e76\u672a\u53d1\u73b0 k == key \u7684 entry\uff0c\u8bf4\u660e\u5f53\u524d\u662f\u4e00\u4e2a\u3010\u53d6\u4ee3\u8fc7\u671f\u6570\u636e\u903b\u8f91\u3011\n    // \u5220\u9664\u539f\u6709\u7684\u6570\u636e\u5f15\u7528\uff0c\u9632\u6b62\u5185\u5b58\u6cc4\u9732\n    tab[staleSlot].value = null;\n    // staleSlot \u4f4d\u7f6e\u6dfb\u52a0\u6570\u636e\uff0c\u3010\u4e0a\u9762\u7684\u6240\u6709\u903b\u8f91\u90fd\u4e0d\u4f1a\u66f4\u6539 staleSlot \u7684\u503c\u3011\n    tab[staleSlot] = new Entry(key, value);\n\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u9664\u4e86 staleSlot \u4ee5\u5916\uff0c\u8fd8\u53d1\u73b0\u5176\u5b83\u7684\u8fc7\u671f slot\uff0c\u6240\u4ee5\u8981\u3010\u5f00\u542f\u6e05\u7406\u6570\u636e\u7684\u903b\u8f91\u3011\n    if (slotToExpunge != staleSlot)\n        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(46202).A+"",width:"1817",height:"835"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static int prevIndex(int i, int len) {\n    // \u5f62\u6210\u4e00\u4e2a\u73af\u7ed5\u5f0f\u7684\u8bbf\u95ee\uff0c\u5934\u7d22\u5f15\u8d8a\u754c\u540e\u7f6e\u4e3a\u5c3e\u7d22\u5f15\n    return ((i - 1 >= 0) ? i - 1 : len - 1);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"getEntry()\uff1aThreadLocal \u7684 get \u65b9\u6cd5\u4ee5\u5f53\u524d\u7684 ThreadLocal \u4e3a key\uff0c\u8c03\u7528 getEntry \u83b7\u53d6\u5bf9\u5e94\u7684\u5b58\u50a8\u5b9e\u4f53 e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private Entry getEntry(ThreadLocal<?> key) {\n    // \u54c8\u5e0c\u5bfb\u5740\n    int i = key.threadLocalHashCode & (table.length - 1);\n    // \u8bbf\u95ee\u6563\u5217\u8868\u4e2d\u6307\u5b9a\u6307\u5b9a\u4f4d\u7f6e\u7684 slot \n    Entry e = table[i];\n    // \u6761\u4ef6\u6210\u7acb\uff0c\u8bf4\u660e slot \u6709\u503c\u5e76\u4e14 key \u5c31\u662f\u8981\u5bfb\u627e\u7684 key\uff0c\u76f4\u63a5\u8fd4\u56de\n    if (e != null && e.get() == key)\n        return e;\n    else\n        // \u8fdb\u884c\u7ebf\u6027\u63a2\u6d4b\n        return getEntryAfterMiss(key, i, e);\n}\n// \u7ebf\u6027\u63a2\u6d4b\u5bfb\u5740\nprivate Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {\n    // \u83b7\u53d6\u6563\u5217\u8868\n    Entry[] tab = table;\n    int len = tab.length;\n\n    // \u5f00\u59cb\u904d\u5386\uff0c\u78b0\u5230 slot == null \u7684\u60c5\u51b5\uff0c\u641c\u7d22\u7ed3\u675f\n    while (e != null) {\n\t\t// \u83b7\u53d6\u5f53\u524d slot \u4e2d entry \u5bf9\u8c61\u7684 key\n        ThreadLocal<?> k = e.get();\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u627e\u5230\u4e86\uff0c\u76f4\u63a5\u8fd4\u56de\n        if (k == key)\n            return e;\n        if (k == null)\n             // \u8fc7\u671f\u6570\u636e\uff0c\u3010\u63a2\u6d4b\u5f0f\u8fc7\u671f\u6570\u636e\u56de\u6536\u3011\n            expungeStaleEntry(i);\n        else\n            // \u66f4\u65b0 index \u7ee7\u7eed\u5411\u540e\u8d70\n            i = nextIndex(i, len);\n        // \u83b7\u53d6\u4e0b\u4e00\u4e2a\u69fd\u4f4d\u4e2d\u7684 entry\n        e = tab[i];\n    }\n    // \u8bf4\u660e\u5f53\u524d\u533a\u6bb5\u6ca1\u6709\u627e\u5230\u76f8\u5e94\u6570\u636e\n    // \u3010\u56e0\u4e3a\u5b58\u653e\u6570\u636e\u662f\u7ebf\u6027\u7684\u5411\u540e\u5bfb\u627e\u69fd\u4f4d\uff0c\u90fd\u662f\u7d27\u6328\u7740\u7684\uff0c\u4e0d\u53ef\u80fd\u8d8a\u8fc7\u4e00\u4e2a \u7a7a\u69fd\u4f4d \u5728\u540e\u9762\u653e\u3011\uff0c\u53ef\u4ee5\u51cf\u5c11\u904d\u5386\u7684\u6b21\u6570\n    return null;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["rehash()\uff1a\u89e6\u53d1\u4e00\u6b21\u5168\u91cf\u6e05\u7406\uff0c\u5982\u679c\u6570\u7ec4\u957f\u5ea6\u5927\u4e8e\u7b49\u4e8e\u957f\u5ea6\u7684 ",(0,r.jsx)(e.code,{children:"2/3 * 3/4 = 1/2"}),"\uff0c\u5219\u8fdb\u884c resize"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void rehash() {\n    // \u6e05\u695a\u5f53\u524d\u6563\u5217\u8868\u5185\u7684\u3010\u6240\u6709\u3011\u8fc7\u671f\u7684\u6570\u636e\n    expungeStaleEntries();\n    \n    // threshold = len * 2 / 3\uff0c\u5c31\u662f 2/3 * (1 - 1/4)\n    if (size >= threshold - threshold / 4)\n        resize();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void expungeStaleEntries() {\n    Entry[] tab = table;\n    int len = tab.length;\n    // \u3010\u904d\u5386\u6240\u6709\u7684\u69fd\u4f4d\uff0c\u6e05\u7406\u8fc7\u671f\u6570\u636e\u3011\n    for (int j = 0; j < len; j++) {\n        Entry e = tab[j];\n        if (e != null && e.get() == null)\n            expungeStaleEntry(j);\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["Entry ",(0,r.jsx)(e.strong,{children:"\u6570\u7ec4\u4e3a\u6269\u5bb9\u4e3a\u539f\u6765\u7684 2 \u500d"})," \uff0c\u91cd\u65b0\u8ba1\u7b97 key \u7684\u6563\u5217\u503c\uff0c\u5982\u679c\u9047\u5230 key \u4e3a null \u7684\u60c5\u51b5\uff0c\u4f1a\u5c06\u5176 value \u4e5f\u7f6e\u4e3a null\uff0c\u5e2e\u52a9 GC"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void resize() {\n    Entry[] oldTab = table;\n    int oldLen = oldTab.length;\n    // \u65b0\u6570\u7ec4\u7684\u957f\u5ea6\u662f\u8001\u6570\u7ec4\u7684\u4e8c\u500d\n    int newLen = oldLen * 2;\n    Entry[] newTab = new Entry[newLen];\n    // \u7edf\u8ba1\u65b0table\u4e2d\u7684entry\u6570\u91cf\n    int count = 0;\n\t// \u904d\u5386\u8001\u8868\uff0c\u8fdb\u884c\u3010\u6570\u636e\u8fc1\u79fb\u3011\n    for (int j = 0; j < oldLen; ++j) {\n        // \u8bbf\u95ee\u8001\u8868\u7684\u6307\u5b9a\u4f4d\u7f6e\u7684 entry\n        Entry e = oldTab[j];\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u8001\u8868\u4e2d\u8be5\u4f4d\u7f6e\u6709\u6570\u636e\uff0c\u53ef\u80fd\u662f\u8fc7\u671f\u6570\u636e\u4e5f\u53ef\u80fd\u4e0d\u662f\n        if (e != null) {\n            ThreadLocal<?> k = e.get();\n            // \u8fc7\u671f\u6570\u636e\n            if (k == null) {\n                e.value = null; // Help the GC\n            } else {\n                // \u975e\u8fc7\u671f\u6570\u636e\uff0c\u5728\u65b0\u8868\u4e2d\u8fdb\u884c\u54c8\u5e0c\u5bfb\u5740\n                int h = k.threadLocalHashCode & (newLen - 1);\n                // \u3010\u7ebf\u7a0b\u63a2\u6d4b\u3011\n                while (newTab[h] != null)\n                    h = nextIndex(h, newLen);\n                // \u5c06\u6570\u636e\u5b58\u653e\u5230\u65b0\u8868\u5408\u9002\u7684 slot \u4e2d\n                newTab[h] = e;\n                count++;\n            }\n        }\n    }\n\t// \u8bbe\u7f6e\u4e0b\u4e00\u6b21\u89e6\u53d1\u6269\u5bb9\u7684\u6307\u6807\uff1athreshold = len * 2 / 3;\n    setThreshold(newLen);\n    size = count;\n    // \u5c06\u6269\u5bb9\u540e\u7684\u65b0\u8868\u8d4b\u503c\u7ed9 threadLocalMap \u5185\u90e8\u6563\u5217\u8868\u6570\u7ec4\u5f15\u7528\n    table = newTab;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"remove()\uff1a\u5220\u9664 Entry"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void remove(ThreadLocal<?> key) {\n    Entry[] tab = table;\n    int len = tab.length;\n    // \u54c8\u5e0c\u5bfb\u5740\n    int i = key.threadLocalHashCode & (len-1);\n    for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {\n        // \u627e\u5230\u4e86\u5bf9\u5e94\u7684 key\n        if (e.get() == key) {\n            // \u8bbe\u7f6e key \u4e3a null\n            e.clear();\n            // \u63a2\u6d4b\u5f0f\u6e05\u7406\n            expungeStaleEntry(i);\n            return;\n        }\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6e05\u7406\u65b9\u6cd5",children:"\u6e05\u7406\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u63a2\u6d4b\u5f0f\u6e05\u7406\uff1a\u6cbf\u7740\u5f00\u59cb\u4f4d\u7f6e\u5411\u540e\u63a2\u6d4b\u6e05\u7406\u8fc7\u671f\u6570\u636e\uff0c\u6cbf\u9014\u4e2d\u78b0\u5230\u672a\u8fc7\u671f\u6570\u636e\u5219\u5c06\u6b64\u6570\u636e rehash \u5728 table \u6570\u7ec4\u4e2d\u7684\u5b9a\u4f4d\uff0c\u91cd\u5b9a\u4f4d\u540e\u7684\u5143\u7d20\u7406\u8bba\u4e0a\u66f4\u63a5\u8fd1 ",(0,r.jsx)(e.code,{children:"i = entry.key & (table.length - 1)"}),"\uff0c\u8ba9",(0,r.jsx)(e.strong,{children:"\u6570\u636e\u7684\u6392\u5217\u66f4\u7d27\u51d1"}),"\uff0c\u4f1a\u4f18\u5316\u6574\u4e2a\u6563\u5217\u8868\u67e5\u8be2\u6027\u80fd"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// table[staleSlot] \u662f\u4e00\u4e2a\u8fc7\u671f\u6570\u636e\uff0c\u4ee5\u8fd9\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u7ee7\u7eed\u5411\u540e\u67e5\u627e\u8fc7\u671f\u6570\u636e\nprivate int expungeStaleEntry(int staleSlot) {\n    // \u83b7\u53d6\u6563\u5217\u8868\u548c\u6570\u7ec4\u957f\u5ea6\n    Entry[] tab = table;\n    int len = tab.length;\n\n    // help gc\uff0c\u5148\u628a\u5f53\u524d\u8fc7\u671f\u7684 entry \u7f6e\u7a7a\uff0c\u5728\u53d6\u6d88\u5bf9 entry \u7684\u5f15\u7528\n    tab[staleSlot].value = null;\n    tab[staleSlot] = null;\n    // \u6570\u91cf-1\n    size--;\n\n    Entry e;\n    int i;\n    // \u4ece staleSlot \u5f00\u59cb\u5411\u540e\u904d\u5386\uff0c\u76f4\u5230\u78b0\u5230 slot == null \u7ed3\u675f\uff0c\u3010\u533a\u95f4\u5185\u6e05\u7406\u8fc7\u671f\u6570\u636e\u3011\n    for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {\n        ThreadLocal<?> k = e.get();\n        // \u5f53\u524d entry \u662f\u8fc7\u671f\u6570\u636e\n        if (k == null) {\n            // help gc\n            e.value = null;\n            tab[i] = null;\n            size--;\n        } else {\n            // \u5f53\u524d entry \u4e0d\u662f\u8fc7\u671f\u6570\u636e\u7684\u903b\u8f91\uff0c\u3010rehash\u3011\n            // \u91cd\u65b0\u8ba1\u7b97\u5f53\u524d entry \u5bf9\u5e94\u7684 index\n            int h = k.threadLocalHashCode & (len - 1);\n            // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d entry \u5b58\u50a8\u65f6\u53d1\u751f\u8fc7 hash \u51b2\u7a81\uff0c\u5411\u540e\u504f\u79fb\u8fc7\u4e86\n            if (h != i) {\n                // \u5f53\u524d\u4f4d\u7f6e\u7f6e\u7a7a\n                tab[i] = null;\n                // \u4ee5\u6b63\u786e\u4f4d\u7f6e h \u5f00\u59cb\uff0c\u5411\u540e\u67e5\u627e\u7b2c\u4e00\u4e2a\u53ef\u4ee5\u5b58\u653e entry \u7684\u4f4d\u7f6e\n                while (tab[h] != null)\n                    h = nextIndex(h, len);\n                // \u5c06\u5f53\u524d\u5143\u7d20\u653e\u5165\u5230\u3010\u8ddd\u79bb\u6b63\u786e\u4f4d\u7f6e\u66f4\u8fd1\u7684\u4f4d\u7f6e\uff0c\u6709\u53ef\u80fd\u5c31\u662f\u6b63\u786e\u4f4d\u7f6e\u3011\n                tab[h] = e;\n            }\n        }\n    }\n    // \u8fd4\u56de slot = null \u7684\u69fd\u4f4d\u7d22\u5f15\uff0c\u56fe\u4f8b\u662f 7\uff0c\u8fd9\u4e2a\u7d22\u5f15\u4ee3\u8868\u3010\u7d22\u5f15\u524d\u9762\u7684\u533a\u95f4\u5df2\u7ecf\u6e05\u7406\u5b8c\u6210\u5783\u573e\u4e86\u3011\n    return i;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(5676).A+"",width:"1089",height:"629"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(42087).A+"",width:"1163",height:"692"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u542f\u53d1\u5f0f\u6e05\u7406\uff1a\u5411\u540e\u5faa\u73af\u626b\u63cf\u8fc7\u671f\u6570\u636e\uff0c\u53d1\u73b0\u8fc7\u671f\u6570\u636e\u8c03\u7528\u63a2\u6d4b\u5f0f\u6e05\u7406\u65b9\u6cd5\uff0c\u5982\u679c\u8fde\u7eed\u51e0\u6b21\u7684\u5faa\u73af\u90fd\u6ca1\u6709\u53d1\u73b0\u8fc7\u671f\u6570\u636e\uff0c\u5c31\u505c\u6b62\u626b\u63cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"//  i \u8868\u793a\u542f\u53d1\u5f0f\u6e05\u7406\u5de5\u4f5c\u5f00\u59cb\u4f4d\u7f6e\uff0c\u4e00\u822c\u662f\u7a7a slot\uff0cn \u4e00\u822c\u4f20\u9012\u7684\u662f table.length \nprivate boolean cleanSomeSlots(int i, int n) {\n    // \u8868\u793a\u542f\u53d1\u5f0f\u6e05\u7406\u5de5\u4f5c\u662f\u5426\u6e05\u9664\u4e86\u8fc7\u671f\u6570\u636e\n    boolean removed = false;\n    // \u83b7\u53d6\u5f53\u524d map \u7684\u6563\u5217\u8868\u5f15\u7528\n    Entry[] tab = table;\n    int len = tab.length;\n    do {\n        // \u83b7\u53d6\u4e0b\u4e00\u4e2a\u7d22\u5f15\uff0c\u56e0\u4e3a\u63a2\u6d4b\u5f0f\u8fd4\u56de\u7684 slot \u4e3a null\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u662f\u8fc7\u671f\u7684\u6570\u636e\uff0ckey \u88ab gc \u4e86\n        if (e != null && e.get() == null) {\n            // \u3010\u53d1\u73b0\u8fc7\u671f\u6570\u636e\u91cd\u7f6e n \u4e3a\u6570\u7ec4\u7684\u957f\u5ea6\u3011\n            n = len;\n            // \u8868\u793a\u6e05\u7406\u8fc7\u8fc7\u671f\u6570\u636e\n            removed = true;\n            // \u4ee5\u5f53\u524d\u8fc7\u671f\u7684 slot \u4e3a\u5f00\u59cb\u8282\u70b9 \u505a\u4e00\u6b21\u63a2\u6d4b\u5f0f\u6e05\u7406\u5de5\u4f5c\n            i = expungeStaleEntry(i);\n        }\n        // \u5047\u8bbe table \u957f\u5ea6\u4e3a 16\n        // 16 >>> 1 ==> 8\uff0c8 >>> 1 ==> 4\uff0c4 >>> 1 ==> 2\uff0c2 >>> 1 ==> 1\uff0c1 >>> 1 ==> 0\n        // \u8fde\u7eed\u7ecf\u8fc7\u8fd9\u4e48\u591a\u6b21\u5faa\u73af\u3010\u6ca1\u6709\u626b\u63cf\u5230\u8fc7\u671f\u6570\u636e\u3011\uff0c\u5c31\u505c\u6b62\u5faa\u73af\uff0c\u626b\u63cf\u5230\u7a7a slot \u4e0d\u7b97\uff0c\u56e0\u4e3a\u4e0d\u662f\u8fc7\u671f\u6570\u636e\n    } while ((n >>>= 1) != 0);\n    \n    // \u8fd4\u56de\u6e05\u9664\u6807\u8bb0\n    return removed;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://space.bilibili.com/457326371/",children:"https://space.bilibili.com/457326371/"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5185\u5b58\u6cc4\u6f0f",children:"\u5185\u5b58\u6cc4\u6f0f"}),"\n",(0,r.jsx)(e.p,{children:"Memory leak\uff1a\u5185\u5b58\u6cc4\u6f0f\u662f\u6307\u7a0b\u5e8f\u4e2d\u52a8\u6001\u5206\u914d\u7684\u5806\u5185\u5b58\u7531\u4e8e\u67d0\u79cd\u539f\u56e0\u672a\u91ca\u653e\u6216\u65e0\u6cd5\u91ca\u653e\uff0c\u9020\u6210\u7cfb\u7edf\u5185\u5b58\u7684\u6d6a\u8d39\uff0c\u5bfc\u81f4\u7a0b\u5e8f\u8fd0\u884c\u901f\u5ea6\u51cf\u6162\u751a\u81f3\u7cfb\u7edf\u5d29\u6e83\u7b49\u4e25\u91cd\u540e\u679c\uff0c\u5185\u5b58\u6cc4\u6f0f\u7684\u5806\u79ef\u7ec8\u5c06\u5bfc\u81f4\u5185\u5b58\u6ea2\u51fa"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c key \u4f7f\u7528\u5f3a\u5f15\u7528\uff1a\u4f7f\u7528\u5b8c ThreadLocal \uff0cthreadLocal Ref \u88ab\u56de\u6536\uff0c\u4f46\u662f threadLocalMap \u7684 Entry \u5f3a\u5f15\u7528\u4e86 threadLocal\uff0c\u9020\u6210 threadLocal \u65e0\u6cd5\u88ab\u56de\u6536\uff0c\u65e0\u6cd5\u5b8c\u5168\u907f\u514d\u5185\u5b58\u6cc4\u6f0f"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(9525).A+"",width:"701",height:"375"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c key \u4f7f\u7528\u5f31\u5f15\u7528\uff1a\u4f7f\u7528\u5b8c ThreadLocal \uff0cthreadLocal Ref \u88ab\u56de\u6536\uff0cThreadLocalMap \u53ea\u6301\u6709 ThreadLocal \u7684\u5f31\u5f15\u7528\uff0c\u6240\u4ee5threadlocal \u4e5f\u53ef\u4ee5\u88ab\u56de\u6536\uff0c\u6b64\u65f6 Entry \u4e2d\u7684 key = null\u3002\u4f46\u6ca1\u6709\u624b\u52a8\u5220\u9664\u8fd9\u4e2a Entry \u6216\u8005 CurrentThread \u4f9d\u7136\u8fd0\u884c\uff0c\u4f9d\u7136\u5b58\u5728\u5f3a\u5f15\u7528\u94fe\uff0cvalue \u4e0d\u4f1a\u88ab\u56de\u6536\uff0c\u800c\u8fd9\u5757 value \u6c38\u8fdc\u4e0d\u4f1a\u88ab\u8bbf\u95ee\u5230\uff0c\u4e5f\u4f1a\u5bfc\u81f4 value \u5185\u5b58\u6cc4\u6f0f"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(89086).A+"",width:"743",height:"356"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4e24\u4e2a\u4e3b\u8981\u539f\u56e0\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6ca1\u6709\u624b\u52a8\u5220\u9664\u8fd9\u4e2a Entry"}),"\n",(0,r.jsx)(e.li,{children:"CurrentThread \u4f9d\u7136\u8fd0\u884c"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u6839\u672c\u539f\u56e0\uff1aThreadLocalMap \u662f Thread\u7684\u4e00\u4e2a\u5c5e\u6027\uff0c",(0,r.jsx)(e.strong,{children:"\u751f\u547d\u5468\u671f\u8ddf Thread \u4e00\u6837\u957f"}),"\uff0c\u5982\u679c\u6ca1\u6709\u624b\u52a8\u5220\u9664\u5bf9\u5e94 Entry \u5c31\u4f1a\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f"]}),"\n",(0,r.jsx)(e.p,{children:"\u89e3\u51b3\u65b9\u6cd5\uff1a\u4f7f\u7528\u5b8c ThreadLocal \u4e2d\u5b58\u50a8\u7684\u5185\u5bb9\u540e\u5c06\u5b83 remove \u6389\u5c31\u53ef\u4ee5"}),"\n",(0,r.jsxs)(e.p,{children:["ThreadLocal \u5185\u90e8\u89e3\u51b3\u65b9\u6cd5\uff1a\u5728 ThreadLocalMap \u4e2d\u7684 set/getEntry \u65b9\u6cd5\u4e2d\uff0c\u901a\u8fc7\u7ebf\u6027\u63a2\u6d4b\u6cd5\u5bf9 key \u8fdb\u884c\u5224\u65ad\uff0c\u5982\u679c key \u4e3a null\uff08ThreadLocal \u4e3a null\uff09\u4f1a\u5bf9 Entry \u8fdb\u884c\u5783\u573e\u56de\u6536\u3002\u6240\u4ee5",(0,r.jsx)(e.strong,{children:"\u4f7f\u7528\u5f31\u5f15\u7528\u6bd4\u5f3a\u5f15\u7528\u591a\u4e00\u5c42\u4fdd\u969c"}),"\uff0c\u5c31\u7b97\u4e0d\u8c03\u7528 remove\uff0c\u4e5f\u6709\u673a\u4f1a\u8fdb\u884c GC"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u53d8\u91cf\u4f20\u9012",children:"\u53d8\u91cf\u4f20\u9012"}),"\n",(0,r.jsx)(e.h5,{id:"\u57fa\u672c\u4f7f\u7528-2",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u7236\u5b50\u7ebf\u7a0b\uff1a\u521b\u5efa\u5b50\u7ebf\u7a0b\u7684\u7ebf\u7a0b\u662f\u7236\u7ebf\u7a0b\uff0c\u6bd4\u5982\u5b9e\u4f8b\u4e2d\u7684 main \u7ebf\u7a0b\u5c31\u662f\u7236\u7ebf\u7a0b"}),"\n",(0,r.jsxs)(e.p,{children:["ThreadLocal \u4e2d\u5b58\u50a8\u7684\u662f\u7ebf\u7a0b\u7684\u5c40\u90e8\u53d8\u91cf\uff0c\u5982\u679c\u60f3",(0,r.jsx)(e.strong,{children:"\u5b9e\u73b0\u7ebf\u7a0b\u95f4\u5c40\u90e8\u53d8\u91cf\u4f20\u9012"}),"\u53ef\u4ee5\u4f7f\u7528 InheritableThreadLocal \u7c7b"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ThreadLocal<String> threadLocal = new InheritableThreadLocal<>();\n    threadLocal.set("\u7236\u7ebf\u7a0b\u8bbe\u7f6e\u7684\u503c");\n\n    new Thread(() -> System.out.println("\u5b50\u7ebf\u7a0b\u8f93\u51fa\uff1a" + threadLocal.get())).start();\n}\n// \u5b50\u7ebf\u7a0b\u8f93\u51fa\uff1a\u7236\u7ebf\u7a0b\u8bbe\u7f6e\u7684\u503c\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5b9e\u73b0\u539f\u7406-1",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"InheritableThreadLocal \u6e90\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class InheritableThreadLocal<T> extends ThreadLocal<T> {\n    protected T childValue(T parentValue) {\n        return parentValue;\n    }\n    ThreadLocalMap getMap(Thread t) {\n       return t.inheritableThreadLocals;\n    }\n    void createMap(Thread t, T firstValue) {\n        t.inheritableThreadLocals = new ThreadLocalMap(this, firstValue);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5b9e\u73b0\u7236\u5b50\u7ebf\u7a0b\u95f4\u7684\u5c40\u90e8\u53d8\u91cf\u5171\u4eab\u9700\u8981\u8ffd\u6eaf\u5230 Thread \u5bf9\u8c61\u7684\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc,\n                  // \u8be5\u53c2\u6570\u9ed8\u8ba4\u662f true\n                  boolean inheritThreadLocals) {\n  \t// ...\n    Thread parent = currentThread();\n\n    // \u5224\u65ad\u7236\u7ebf\u7a0b\uff08\u521b\u5efa\u5b50\u7ebf\u7a0b\u7684\u7ebf\u7a0b\uff09\u7684 inheritableThreadLocals \u5c5e\u6027\u4e0d\u4e3a null\n    if (inheritThreadLocals && parent.inheritableThreadLocals != null) {\n        // \u590d\u5236\u7236\u7ebf\u7a0b\u7684 inheritableThreadLocals \u5c5e\u6027\uff0c\u5b9e\u73b0\u7236\u5b50\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf\u5171\u4eab\n        this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); \n    }\n    // ..\n}\n// \u3010\u672c\u8d28\u4e0a\u8fd8\u662f\u521b\u5efa ThreadLocalMap\uff0c\u53ea\u662f\u628a\u7236\u7c7b\u4e2d\u7684\u53ef\u7ee7\u627f\u6570\u636e\u8bbe\u7f6e\u8fdb\u53bb\u4e86\u3011\nstatic ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap) {\n    return new ThreadLocalMap(parentMap);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private ThreadLocalMap(ThreadLocalMap parentMap) {\n    // \u83b7\u53d6\u7236\u7ebf\u7a0b\u7684\u54c8\u5e0c\u8868\n    Entry[] parentTable = parentMap.table;\n    int len = parentTable.length;\n    setThreshold(len);\n    table = new Entry[len];\n\t// \u3010\u9010\u4e2a\u590d\u5236\u7236\u7ebf\u7a0b ThreadLocalMap \u4e2d\u7684\u6570\u636e\u3011\n    for (int j = 0; j < len; j++) {\n        Entry e = parentTable[j];\n        if (e != null) {\n            ThreadLocal<Object> key = (ThreadLocal<Object>) e.get();\n            if (key != null) {\n                // \u8c03\u7528\u7684\u662f InheritableThreadLocal#childValue(T parentValue)\n                Object value = key.childValue(e.value);\n                Entry c = new Entry(key, value);\n                int h = key.threadLocalHashCode & (len - 1);\n                // \u7ebf\u6027\u63a2\u6d4b\n                while (table[h] != null)\n                    h = nextIndex(h, len);\n                table[h] = c;\n                size++;\n            }\n        }\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://blog.csdn.net/feichitianxia/article/details/110495764",children:"https://blog.csdn.net/feichitianxia/article/details/110495764"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u7ebf\u7a0b\u6c60",children:"\u7ebf\u7a0b\u6c60"}),"\n",(0,r.jsx)(e.h3,{id:"\u57fa\u672c\u6982\u8ff0",children:"\u57fa\u672c\u6982\u8ff0"}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u6c60\uff1a\u4e00\u4e2a\u5bb9\u7eb3\u591a\u4e2a\u7ebf\u7a0b\u7684\u5bb9\u5668\uff0c\u5bb9\u5668\u4e2d\u7684\u7ebf\u7a0b\u53ef\u4ee5\u91cd\u590d\u4f7f\u7528\uff0c\u7701\u53bb\u4e86\u9891\u7e41\u521b\u5efa\u548c\u9500\u6bc1\u7ebf\u7a0b\u5bf9\u8c61\u7684\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u6c60\u4f5c\u7528\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u964d\u4f4e\u8d44\u6e90\u6d88\u8017\uff0c\u51cf\u5c11\u4e86\u521b\u5efa\u548c\u9500\u6bc1\u7ebf\u7a0b\u7684\u6b21\u6570\uff0c\u6bcf\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u90fd\u53ef\u4ee5\u88ab\u91cd\u590d\u5229\u7528\uff0c\u53ef\u6267\u884c\u591a\u4e2a\u4efb\u52a1"}),"\n",(0,r.jsx)(e.li,{children:"\u63d0\u9ad8\u54cd\u5e94\u901f\u5ea6\uff0c\u5f53\u4efb\u52a1\u5230\u8fbe\u65f6\uff0c\u5982\u679c\u6709\u7ebf\u7a0b\u53ef\u4ee5\u76f4\u63a5\u7528\uff0c\u4e0d\u4f1a\u51fa\u73b0\u7cfb\u7edf\u50f5\u6b7b"}),"\n",(0,r.jsx)(e.li,{children:"\u63d0\u9ad8\u7ebf\u7a0b\u7684\u53ef\u7ba1\u7406\u6027\uff0c\u5982\u679c\u65e0\u9650\u5236\u7684\u521b\u5efa\u7ebf\u7a0b\uff0c\u4e0d\u4ec5\u4f1a\u6d88\u8017\u7cfb\u7edf\u8d44\u6e90\uff0c\u8fd8\u4f1a\u964d\u4f4e\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\uff0c\u4f7f\u7528\u7ebf\u7a0b\u6c60\u53ef\u4ee5\u8fdb\u884c\u7edf\u4e00\u7684\u5206\u914d\uff0c\u8c03\u4f18\u548c\u76d1\u63a7"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u7ebf\u7a0b\u6c60\u7684\u6838\u5fc3\u601d\u60f3\uff1a",(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u590d\u7528"}),"\uff0c\u540c\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u88ab\u91cd\u590d\u4f7f\u7528\uff0c\u6765\u5904\u7406\u591a\u4e2a\u4efb\u52a1"]}),"\n",(0,r.jsx)(e.p,{children:"\u6c60\u5316\u6280\u672f (Pool) \uff1a\u4e00\u79cd\u7f16\u7a0b\u6280\u5de7\uff0c\u6838\u5fc3\u601d\u60f3\u662f\u8d44\u6e90\u590d\u7528\uff0c\u5728\u8bf7\u6c42\u91cf\u5927\u65f6\u80fd\u4f18\u5316\u5e94\u7528\u6027\u80fd\uff0c\u964d\u4f4e\u7cfb\u7edf\u9891\u7e41\u5efa\u8fde\u7684\u8d44\u6e90\u5f00\u9500"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u963b\u585e\u961f\u5217-1",children:"\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-1",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsx)(e.p,{children:"\u6709\u754c\u961f\u5217\u548c\u65e0\u754c\u961f\u5217\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6709\u754c\u961f\u5217\uff1a\u6709\u56fa\u5b9a\u5927\u5c0f\u7684\u961f\u5217\uff0c\u6bd4\u5982\u8bbe\u5b9a\u4e86\u56fa\u5b9a\u5927\u5c0f\u7684 LinkedBlockingQueue\uff0c\u53c8\u6216\u8005\u5927\u5c0f\u4e3a 0"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u65e0\u754c\u961f\u5217\uff1a\u6ca1\u6709\u8bbe\u7f6e\u56fa\u5b9a\u5927\u5c0f\u7684\u961f\u5217\uff0c\u8fd9\u4e9b\u961f\u5217\u53ef\u4ee5\u76f4\u63a5\u5165\u961f\uff0c\u76f4\u5230\u6ea2\u51fa\uff08\u8d85\u8fc7 Integer.MAX_VALUE\uff09\uff0c\u6240\u4ee5\u76f8\u5f53\u4e8e\u65e0\u754c"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["java.util.concurrent.BlockingQueue \u63a5\u53e3\u6709\u4ee5\u4e0b\u963b\u585e\u961f\u5217\u7684\u5b9e\u73b0\uff1a",(0,r.jsx)(e.strong,{children:"FIFO \u961f\u5217"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"ArrayBlockQueue\uff1a\u7531\u6570\u7ec4\u7ed3\u6784\u7ec4\u6210\u7684\u6709\u754c\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"LinkedBlockingQueue\uff1a\u7531\u94fe\u8868\u7ed3\u6784\u7ec4\u6210\u7684\u65e0\u754c\uff08\u9ed8\u8ba4\u5927\u5c0f Integer.MAX_VALUE\uff09\u7684\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"PriorityBlockQueue\uff1a\u652f\u6301\u4f18\u5148\u7ea7\u6392\u5e8f\u7684\u65e0\u754c\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"DelayedWorkQueue\uff1a\u4f7f\u7528\u4f18\u5148\u7ea7\u961f\u5217\u5b9e\u73b0\u7684\u5ef6\u8fdf\u65e0\u754c\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"SynchronousQueue\uff1a\u4e0d\u5b58\u50a8\u5143\u7d20\u7684\u963b\u585e\u961f\u5217\uff0c\u6bcf\u4e00\u4e2a\u751f\u4ea7\u7ebf\u7a0b\u4f1a\u963b\u585e\u5230\u6709\u4e00\u4e2a put \u7684\u7ebf\u7a0b\u653e\u5165\u5143\u7d20\u4e3a\u6b62"}),"\n",(0,r.jsx)(e.li,{children:"LinkedTransferQueue\uff1a\u7531\u94fe\u8868\u7ed3\u6784\u7ec4\u6210\u7684\u65e0\u754c\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsxs)(e.li,{children:["LinkedBlockingDeque\uff1a\u7531\u94fe\u8868\u7ed3\u6784\u7ec4\u6210\u7684",(0,r.jsx)(e.strong,{children:"\u53cc\u5411"}),"\u963b\u585e\u961f\u5217"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e0e\u666e\u901a\u961f\u5217\uff08LinkedList\u3001ArrayList\u7b49\uff09\u7684\u4e0d\u540c\u70b9\u5728\u4e8e\u963b\u585e\u961f\u5217\u4e2d\u963b\u585e\u6dfb\u52a0\u548c\u963b\u585e\u5220\u9664\u65b9\u6cd5\uff0c\u4ee5\u53ca\u7ebf\u7a0b\u5b89\u5168\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u963b\u585e\u6dfb\u52a0 put()\uff1a\u5f53\u963b\u585e\u961f\u5217\u5143\u7d20\u5df2\u6ee1\u65f6\uff0c\u6dfb\u52a0\u961f\u5217\u5143\u7d20\u7684\u7ebf\u7a0b\u4f1a\u88ab\u963b\u585e\uff0c\u76f4\u5230\u961f\u5217\u5143\u7d20\u4e0d\u6ee1\u65f6\u624d\u91cd\u65b0\u5524\u9192\u7ebf\u7a0b\u6267\u884c"}),"\n",(0,r.jsx)(e.li,{children:"\u963b\u585e\u5220\u9664 take()\uff1a\u5728\u961f\u5217\u5143\u7d20\u4e3a\u7a7a\u65f6\uff0c\u5220\u9664\u961f\u5217\u5143\u7d20\u7684\u7ebf\u7a0b\u5c06\u88ab\u963b\u585e\uff0c\u76f4\u5230\u961f\u5217\u4e0d\u4e3a\u7a7a\u518d\u6267\u884c\u5220\u9664\u64cd\u4f5c\uff08\u4e00\u822c\u4f1a\u8fd4\u56de\u88ab\u5220\u9664\u7684\u5143\u7d20)"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6838\u5fc3\u65b9\u6cd5",children:"\u6838\u5fc3\u65b9\u6cd5"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5\u7c7b\u578b"}),(0,r.jsx)(e.th,{children:"\u629b\u51fa\u5f02\u5e38"}),(0,r.jsx)(e.th,{children:"\u7279\u6b8a\u503c"}),(0,r.jsx)(e.th,{children:"\u963b\u585e"}),(0,r.jsx)(e.th,{children:"\u8d85\u65f6"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u63d2\u5165\uff08\u5c3e\uff09"}),(0,r.jsx)(e.td,{children:"add(e)"}),(0,r.jsx)(e.td,{children:"offer(e)"}),(0,r.jsx)(e.td,{children:"put(e)"}),(0,r.jsx)(e.td,{children:"offer(e,time,unit)"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u79fb\u9664\uff08\u5934\uff09"}),(0,r.jsx)(e.td,{children:"remove()"}),(0,r.jsx)(e.td,{children:"poll()"}),(0,r.jsx)(e.td,{children:"take()"}),(0,r.jsx)(e.td,{children:"poll(time,unit)"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u68c0\u67e5\uff08\u961f\u9996\u5143\u7d20\uff09"}),(0,r.jsx)(e.td,{children:"element()"}),(0,r.jsx)(e.td,{children:"peek()"}),(0,r.jsx)(e.td,{children:"\u4e0d\u53ef\u7528"}),(0,r.jsx)(e.td,{children:"\u4e0d\u53ef\u7528"})]})]})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u629b\u51fa\u5f02\u5e38\u7ec4\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53\u963b\u585e\u961f\u5217\u6ee1\u65f6\uff1a\u5728\u5f80\u961f\u5217\u4e2d add \u63d2\u5165\u5143\u7d20\u4f1a\u629b\u51fa IIIegalStateException: Queue full"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53\u963b\u585e\u961f\u5217\u7a7a\u65f6\uff1a\u518d\u5f80\u961f\u5217\u4e2d remove \u79fb\u9664\u5143\u7d20\uff0c\u4f1a\u629b\u51fa NoSuchException"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u7279\u6b8a\u503c\u7ec4\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u63d2\u5165\u65b9\u6cd5\uff1a\u6210\u529f true\uff0c\u5931\u8d25 false"}),"\n",(0,r.jsx)(e.li,{children:"\u79fb\u9664\u65b9\u6cd5\uff1a\u6210\u529f\u8fd4\u56de\u51fa\u961f\u5217\u5143\u7d20\uff0c\u961f\u5217\u6ca1\u6709\u5c31\u8fd4\u56de null"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u963b\u585e\u7ec4\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53\u963b\u585e\u961f\u5217\u6ee1\u65f6\uff0c\u751f\u4ea7\u8005\u7ee7\u7eed\u5f80\u961f\u5217\u91cc put \u5143\u7d20\uff0c\u961f\u5217\u4f1a\u4e00\u76f4\u963b\u585e\u751f\u4ea7\u7ebf\u7a0b\u76f4\u5230\u961f\u5217\u6709\u7a7a\u95f4 put \u6570\u636e\u6216\u54cd\u5e94\u4e2d\u65ad\u9000\u51fa"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53\u963b\u585e\u961f\u5217\u7a7a\u65f6\uff0c\u6d88\u8d39\u8005\u7ebf\u7a0b\u8bd5\u56fe\u4ece\u961f\u5217\u91cc take \u5143\u7d20\uff0c\u961f\u5217\u4f1a\u4e00\u76f4\u963b\u585e\u6d88\u8d39\u8005\u7ebf\u7a0b\u76f4\u5230\u961f\u5217\u4e2d\u6709\u53ef\u7528\u5143\u7d20"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u8d85\u65f6\u9000\u51fa\uff1a\u5f53\u963b\u585e\u961f\u5217\u6ee1\u65f6\uff0c\u961f\u91cc\u4f1a\u963b\u585e\u751f\u4ea7\u8005\u7ebf\u7a0b\u4e00\u5b9a\u65f6\u95f4\uff0c\u8d85\u8fc7\u9650\u65f6\u540e\u751f\u4ea7\u8005\u7ebf\u7a0b\u4f1a\u9000\u51fa"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u94fe\u8868\u961f\u5217",children:"\u94fe\u8868\u961f\u5217"}),"\n",(0,r.jsx)(e.h5,{id:"\u5165\u961f\u51fa\u961f",children:"\u5165\u961f\u51fa\u961f"}),"\n",(0,r.jsx)(e.p,{children:"LinkedBlockingQueue \u6e90\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class LinkedBlockingQueue<E> extends AbstractQueue<E>\n\t\t\timplements BlockingQueue<E>, java.io.Serializable {\n\tstatic class Node<E> {\n        E item;\n        /**\n        * \u4e0b\u5217\u4e09\u79cd\u60c5\u51b5\u4e4b\u4e00\n        * - \u771f\u6b63\u7684\u540e\u7ee7\u8282\u70b9\n        * - \u81ea\u5df1, \u53d1\u751f\u5728\u51fa\u961f\u65f6\n        * - null, \u8868\u793a\u662f\u6ca1\u6709\u540e\u7ee7\u8282\u70b9, \u662f\u5c3e\u8282\u70b9\u4e86\n        */\n        Node<E> next;\n\n        Node(E x) { item = x; }\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u5165\u961f\uff1a",(0,r.jsx)(e.strong,{children:"\u5c3e\u63d2\u6cd5"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u521d\u59cb\u5316\u94fe\u8868 ",(0,r.jsx)(e.code,{children:"last = head = new Node<E>(null)"}),"\uff0c",(0,r.jsx)(e.strong,{children:"Dummy \u8282\u70b9\u7528\u6765\u5360\u4f4d"}),"\uff0citem \u4e3a null"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public LinkedBlockingQueue(int capacity) {\n    // \u9ed8\u8ba4\u662f Integer.MAX_VALUE\n    if (capacity <= 0) throw new IllegalArgumentException();\n    this.capacity = capacity;\n    last = head = new Node<E>(null);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u4e00\u4e2a\u8282\u70b9\u5165\u961f\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void enqueue(Node<E> node) {\n    // \u4ece\u53f3\u5411\u5de6\u8ba1\u7b97\n    last = last.next = node;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(55072).A+"",width:"929",height:"225"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u518d\u6765\u4e00\u4e2a\u8282\u70b9\u5165\u961f ",(0,r.jsx)(e.code,{children:"last = last.next = node"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u51fa\u961f\uff1a",(0,r.jsx)(e.strong,{children:"\u51fa\u961f\u5934\u8282\u70b9"}),"\uff0cFIFO"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u51fa\u961f\u6e90\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private E dequeue() {\n    Node<E> h = head;\n    // \u83b7\u53d6\u4e34\u5934\u8282\u70b9\n    Node<E> first = h.next;\n    // \u81ea\u5df1\u6307\u5411\u81ea\u5df1\uff0chelp GC\n    h.next = h;\n    head = first;\n    // \u51fa\u961f\u7684\u5143\u7d20\n    E x = first.item;\n    // \u3010\u5f53\u524d\u8282\u70b9\u7f6e\u4e3a Dummy \u8282\u70b9\u3011\n    first.item = null;\n    return x;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"h = head"})," \u2192 ",(0,r.jsx)(e.code,{children:"first = h.next"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(38180).A+"",width:"671",height:"254"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"h.next = h"})," \u2192 ",(0,r.jsx)(e.code,{children:"head = first"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(92831).A+"",width:"615",height:"240"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"first.item = null"}),"\uff1a\u5f53\u524d\u8282\u70b9\u7f6e\u4e3a Dummy \u8282\u70b9"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u52a0\u9501\u5206\u6790",children:"\u52a0\u9501\u5206\u6790"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e86\u4e24\u628a\u9501\u548c dummy \u8282\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7528\u4e00\u628a\u9501\uff0c\u540c\u4e00\u65f6\u523b\uff0c\u6700\u591a\u53ea\u5141\u8bb8\u6709\u4e00\u4e2a\u7ebf\u7a0b\uff08\u751f\u4ea7\u8005\u6216\u6d88\u8d39\u8005\uff0c\u4e8c\u9009\u4e00\uff09\u6267\u884c"}),"\n",(0,r.jsxs)(e.li,{children:["\u7528\u4e24\u628a\u9501\uff0c\u540c\u4e00\u65f6\u523b\uff0c\u53ef\u4ee5\u5141\u8bb8\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6\uff08\u4e00\u4e2a\u751f\u4ea7\u8005\u4e0e\u4e00\u4e2a\u6d88\u8d39\u8005\uff09\u6267\u884c\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6d88\u8d39\u8005\u4e0e\u6d88\u8d39\u8005\u7ebf\u7a0b\u4ecd\u7136\u4e32\u884c"}),"\n",(0,r.jsx)(e.li,{children:"\u751f\u4ea7\u8005\u4e0e\u751f\u4ea7\u8005\u7ebf\u7a0b\u4ecd\u7136\u4e32\u884c"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u5b89\u5168\u5206\u6790\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5f53\u8282\u70b9\u603b\u6570\u5927\u4e8e 2 \u65f6\uff08\u5305\u62ec dummy \u8282\u70b9\uff09\uff0c",(0,r.jsx)(e.strong,{children:"putLock \u4fdd\u8bc1\u7684\u662f last \u8282\u70b9\u7684\u7ebf\u7a0b\u5b89\u5168\uff0ctakeLock \u4fdd\u8bc1\u7684\u662f head \u8282\u70b9\u7684\u7ebf\u7a0b\u5b89\u5168"}),"\uff0c\u4e24\u628a\u9501\u4fdd\u8bc1\u4e86\u5165\u961f\u548c\u51fa\u961f\u6ca1\u6709\u7ade\u4e89"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u8282\u70b9\u603b\u6570\u7b49\u4e8e 2 \u65f6\uff08\u5373\u4e00\u4e2a dummy \u8282\u70b9\uff0c\u4e00\u4e2a\u6b63\u5e38\u8282\u70b9\uff09\u8fd9\u65f6\u5019\uff0c\u4ecd\u7136\u662f\u4e24\u628a\u9501\u9501\u4e24\u4e2a\u5bf9\u8c61\uff0c\u4e0d\u4f1a\u7ade\u4e89"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u8282\u70b9\u603b\u6570\u7b49\u4e8e 1 \u65f6\uff08\u5c31\u4e00\u4e2a dummy \u8282\u70b9\uff09\u8fd9\u65f6 take \u7ebf\u7a0b\u4f1a\u88ab notEmpty \u6761\u4ef6\u963b\u585e\uff0c\u6709\u7ade\u4e89\uff0c\u4f1a\u963b\u585e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u7528\u4e8e put(\u963b\u585e) offer(\u975e\u963b\u585e)\nprivate final ReentrantLock putLock = new ReentrantLock();\nprivate final Condition notFull = putLock.newCondition();\t// \u963b\u585e\u7b49\u5f85\u4e0d\u6ee1\uff0c\u8bf4\u660e\u5df2\u7ecf\u6ee1\u4e86\n\n// \u7528\u4e8e take(\u963b\u585e) poll(\u975e\u963b\u585e)\nprivate final ReentrantLock takeLock = new ReentrantLock();\nprivate final Condition notEmpty = takeLock.newCondition();\t// \u963b\u585e\u7b49\u5f85\u4e0d\u7a7a\uff0c\u8bf4\u660e\u5df2\u7ecf\u662f\u7a7a\u7684\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5165\u961f\u51fa\u961f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"put \u64cd\u4f5c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void put(E e) throws InterruptedException {\n    // \u7a7a\u6307\u9488\u5f02\u5e38\n    if (e == null) throw new NullPointerException();\n    int c = -1;\n    // \u628a\u5f85\u6dfb\u52a0\u7684\u5143\u7d20\u5c01\u88c5\u4e3a node \u8282\u70b9\n    Node<E> node = new Node<E>(e);\n    // \u83b7\u53d6\u5168\u5c40\u751f\u4ea7\u9501\n    final ReentrantLock putLock = this.putLock;\n    // count \u7528\u6765\u7ef4\u62a4\u5143\u7d20\u8ba1\u6570\n    final AtomicInteger count = this.count;\n    // \u83b7\u53d6\u53ef\u6253\u65ad\u9501\uff0c\u4f1a\u629b\u51fa\u5f02\u5e38\n    putLock.lockInterruptibly();\n    try {\n    \t// \u961f\u5217\u6ee1\u4e86\u7b49\u5f85\n        while (count.get() == capacity) {\n            // \u3010\u7b49\u5f85\u961f\u5217\u4e0d\u6ee1\u65f6\uff0c\u5c31\u53ef\u4ee5\u751f\u4ea7\u6570\u636e\u3011\uff0c\u7ebf\u7a0b\u5904\u4e8e Waiting\n            notFull.await();\n        }\n        // \u6709\u7a7a\u4f4d, \u5165\u961f\u4e14\u8ba1\u6570\u52a0\u4e00\uff0c\u5c3e\u63d2\u6cd5\n        enqueue(node);\n        // \u8fd4\u56de\u81ea\u589e\u524d\u7684\u6570\u5b57\n        c = count.getAndIncrement();\n        // put \u5b8c\u961f\u5217\u8fd8\u6709\u7a7a\u4f4d, \u5524\u9192\u5176\u4ed6\u751f\u4ea7 put \u7ebf\u7a0b\uff0c\u5524\u9192\u4e00\u4e2a\u51cf\u5c11\u7ade\u4e89\n        if (c + 1 < capacity)\n            notFull.signal();\n    } finally {\n        // \u89e3\u9501\n        putLock.unlock();\n    }\n    // c\u81ea\u589e\u524d\u662f0\uff0c\u8bf4\u660e\u751f\u4ea7\u4e86\u4e00\u4e2a\u5143\u7d20\uff0c\u5524\u9192\u4e00\u4e2a take \u7ebf\u7a0b\n    if (c == 0)\n        signalNotEmpty();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void signalNotEmpty() {\n    final ReentrantLock takeLock = this.takeLock;\n    takeLock.lock();\n    try {\n        // \u8c03\u7528 notEmpty.signal()\uff0c\u800c\u4e0d\u662f notEmpty.signalAll() \u662f\u4e3a\u4e86\u51cf\u5c11\u7ade\u4e89\uff0c\u56e0\u4e3a\u53ea\u5269\u4e0b\u4e00\u4e2a\u5143\u7d20\n        notEmpty.signal();\n    } finally {\n        takeLock.unlock();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"take \u64cd\u4f5c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public E take() throws InterruptedException {\n    E x;\n    int c = -1;\n    // \u5143\u7d20\u4e2a\u6570\n    final AtomicInteger count = this.count;\n    // \u83b7\u53d6\u5168\u5c40\u6d88\u8d39\u9501\n    final ReentrantLock takeLock = this.takeLock;\n    // \u53ef\u6253\u65ad\u9501\n    takeLock.lockInterruptibly();\n    try {\n        // \u6ca1\u6709\u5143\u7d20\u53ef\u4ee5\u51fa\u961f\n        while (count.get() == 0) {\n            // \u3010\u963b\u585e\u7b49\u5f85\u961f\u5217\u4e0d\u7a7a\uff0c\u5c31\u53ef\u4ee5\u6d88\u8d39\u6570\u636e\u3011\uff0c\u7ebf\u7a0b\u5904\u4e8e Waiting\n            notEmpty.await();\n        }\n        // \u51fa\u961f\uff0c\u8ba1\u6570\u51cf\u4e00\uff0cFIFO\uff0c\u51fa\u961f\u5934\u8282\u70b9\n        x = dequeue();\n        // \u8fd4\u56de\u81ea\u51cf\u524d\u7684\u6570\u5b57\n        c = count.getAndDecrement();\n        // \u961f\u5217\u8fd8\u6709\u5143\u7d20\n        if (c > 1)\n            // \u5524\u9192\u4e00\u4e2a\u6d88\u8d39take\u7ebf\u7a0b\n            notEmpty.signal();\n    } finally {\n        takeLock.unlock();\n    }\n    // c \u662f\u6d88\u8d39\u524d\u7684\u6570\u636e\uff0c\u6d88\u8d39\u524d\u6ee1\u4e86\uff0c\u6d88\u8d39\u4e00\u4e2a\u540e\u8fd8\u5269\u4e00\u4e2a\u7a7a\u4f4d\uff0c\u5524\u9192\u751f\u4ea7\u7ebf\u7a0b\n    if (c == capacity)\n        // \u8c03\u7528\u7684\u662f notFull.signal() \u800c\u4e0d\u662f notFull.signalAll() \u662f\u4e3a\u4e86\u51cf\u5c11\u7ade\u4e89\n        signalNotFull();\n    return x;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6027\u80fd\u6bd4\u8f83",children:"\u6027\u80fd\u6bd4\u8f83"}),"\n",(0,r.jsx)(e.p,{children:"\u4e3b\u8981\u5217\u4e3e LinkedBlockingQueue \u4e0e ArrayBlockingQueue \u7684\u6027\u80fd\u6bd4\u8f83\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Linked \u652f\u6301\u6709\u754c\uff0cArray \u5f3a\u5236\u6709\u754c"}),"\n",(0,r.jsx)(e.li,{children:"Linked \u5b9e\u73b0\u662f\u94fe\u8868\uff0cArray \u5b9e\u73b0\u662f\u6570\u7ec4"}),"\n",(0,r.jsx)(e.li,{children:"Linked \u662f\u61d2\u60f0\u7684\uff0c\u800c Array \u9700\u8981\u63d0\u524d\u521d\u59cb\u5316 Node \u6570\u7ec4"}),"\n",(0,r.jsx)(e.li,{children:"Linked \u6bcf\u6b21\u5165\u961f\u4f1a\u751f\u6210\u65b0 Node\uff0c\u800c Array \u7684 Node \u662f\u63d0\u524d\u521b\u5efa\u597d\u7684"}),"\n",(0,r.jsx)(e.li,{children:"Linked \u4e24\u628a\u9501\uff0cArray \u4e00\u628a\u9501"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u540c\u6b65\u961f\u5217",children:"\u540c\u6b65\u961f\u5217"}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u5c5e\u6027-1",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsxs)(e.p,{children:["SynchronousQueue \u662f\u4e00\u4e2a\u4e0d\u5b58\u50a8\u5143\u7d20\u7684 BlockingQueue\uff0c",(0,r.jsx)(e.strong,{children:"\u6bcf\u4e00\u4e2a\u751f\u4ea7\u8005\u5fc5\u987b\u963b\u585e\u5339\u914d\u5230\u4e00\u4e2a\u6d88\u8d39\u8005"})]}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fd0\u884c\u5f53\u524d\u7a0b\u5e8f\u7684\u5e73\u53f0\u62e5\u6709 CPU \u7684\u6570\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final int NCPUS = Runtime.getRuntime().availableProcessors()\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6307\u5b9a\u8d85\u65f6\u65f6\u95f4\u540e\uff0c\u5f53\u524d\u7ebf\u7a0b\u6700\u5927\u81ea\u65cb\u6b21\u6570\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u53ea\u6709\u4e00\u4e2a CPU \u65f6\u81ea\u65cb\u6b21\u6570\u4e3a 0\uff0c\u6240\u6709\u7a0b\u5e8f\u90fd\u662f\u4e32\u884c\u6267\u884c\uff0c\u591a\u6838 CPU \u65f6\u81ea\u65cb 32 \u6b21\u662f\u4e00\u4e2a\u7ecf\u9a8c\u503c\nstatic final int maxTimedSpins = (NCPUS < 2) ? 0 : 32;\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u81ea\u65cb\u7684\u539f\u56e0\uff1a\u7ebf\u7a0b\u6302\u8d77\u5524\u9192\u9700\u8981\u8fdb\u884c\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u6d89\u53ca\u5230\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u7684\u8f6c\u53d8\uff0c\u662f\u975e\u5e38\u6d88\u8017\u8d44\u6e90\u7684\u3002\u81ea\u65cb\u671f\u95f4\u7ebf\u7a0b\u4f1a\u4e00\u76f4\u68c0\u67e5\u81ea\u5df1\u7684\u72b6\u6001\u662f\u5426\u88ab\u5339\u914d\u5230\uff0c\u5982\u679c\u81ea\u65cb\u671f\u95f4\u88ab\u5339\u914d\u5230\uff0c\u90a3\u4e48\u76f4\u63a5\u5c31\u8fd4\u56de\u4e86\uff0c\u5982\u679c\u81ea\u65cb\u6b21\u6570\u8fbe\u5230\u67d0\u4e2a\u6307\u6807\u540e\uff0c\u8fd8\u662f\u4f1a\u5c06\u5f53\u524d\u7ebf\u7a0b\u6302\u8d77"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u672a\u6307\u5b9a\u8d85\u65f6\u65f6\u95f4\uff0c\u5f53\u524d\u7ebf\u7a0b\u6700\u5927\u81ea\u65cb\u6b21\u6570\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final int maxUntimedSpins = maxTimedSpins * 16;\t// maxTimedSpins \u7684 16 \u500d\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6307\u5b9a\u8d85\u65f6\u9650\u5236\u7684\u9608\u503c\uff0c\u5c0f\u4e8e\u8be5\u503c\u7684\u7ebf\u7a0b\u4e0d\u4f1a\u88ab\u6302\u8d77\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final long spinForTimeoutThreshold = 1000L;\t// \u7eb3\u79d2\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u7684\u5c0f\u4e8e\u8be5\u503c\uff0c\u5c31\u4f1a\u88ab\u7981\u6b62\u6302\u8d77\uff0c\u963b\u585e\u518d\u5524\u9192\u7684\u6210\u672c\u592a\u9ad8\uff0c\u4e0d\u5982\u9009\u62e9\u81ea\u65cb\u7a7a\u8f6c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8f6c\u6362\u5668\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private transient volatile Transferer<E> transferer;\nabstract static class Transferer<E> {\n    /**\n    * \u53c2\u6570\u4e00\uff1a\u53ef\u4ee5\u4e3a null\uff0cnull \u65f6\u8868\u793a\u8fd9\u4e2a\u8bf7\u6c42\u662f\u4e00\u4e2a REQUEST \u7c7b\u578b\u7684\u8bf7\u6c42\uff0c\u53cd\u4e4b\u662f\u4e00\u4e2a DATA \u7c7b\u578b\u7684\u8bf7\u6c42\n    * \u53c2\u6570\u4e8c\uff1a\u5982\u679c\u4e3a true \u8868\u793a\u6307\u5b9a\u4e86\u8d85\u65f6\u65f6\u95f4\uff0c\u5982\u679c\u4e3a false \u8868\u793a\u4e0d\u652f\u6301\u8d85\u65f6\uff0c\u4f1a\u4e00\u76f4\u963b\u585e\u5230\u5339\u914d\u6216\u8005\u88ab\u6253\u65ad\n    * \u53c2\u6570\u4e09\uff1a\u8d85\u65f6\u65f6\u95f4\u9650\u5236\uff0c\u5355\u4f4d\u662f\u7eb3\u79d2\n    \n    * \u8fd4\u56de\u503c\uff1a\u8fd4\u56de\u503c\u5982\u679c\u4e0d\u4e3a null \u8868\u793a\u5339\u914d\u6210\u529f\uff0cDATA \u7c7b\u578b\u7684\u8bf7\u6c42\u8fd4\u56de\u5f53\u524d\u7ebf\u7a0b put \u7684\u6570\u636e\n    * \t     \u5982\u679c\u8fd4\u56de null\uff0c\u8868\u793a\u8bf7\u6c42\u8d85\u65f6\u6216\u88ab\u4e2d\u65ad\n    */\n    abstract E transfer(E e, boolean timed, long nanos);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public SynchronousQueue(boolean fair) {\n    // fair \u9ed8\u8ba4 false\n    // \u975e\u516c\u5e73\u6a21\u5f0f\u5b9e\u73b0\u7684\u6570\u636e\u7ed3\u6784\u662f\u6808\uff0c\u516c\u5e73\u6a21\u5f0f\u7684\u6570\u636e\u7ed3\u6784\u662f\u961f\u5217\n    transferer = fair ? new TransferQueue<E>() : new TransferStack<E>();\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean offer(E e) {\n    if (e == null) throw new NullPointerException();\n    return transferer.transfer(e, true, 0) != null;\n}\npublic E poll() {\n    return transferer.transfer(null, true, 0);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u975e\u516c\u5b9e\u73b0",children:"\u975e\u516c\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.p,{children:"TransferStack \u662f\u975e\u516c\u5e73\u7684\u540c\u6b65\u961f\u5217\uff0c\u56e0\u4e3a\u6240\u6709\u7684\u8bf7\u6c42\u90fd\u88ab\u538b\u5165\u6808\u4e2d\uff0c\u6808\u9876\u7684\u5143\u7d20\u4f1a\u6700\u5148\u5f97\u5230\u5339\u914d\uff0c\u9020\u6210\u6808\u5e95\u7684\u7b49\u5f85\u7ebf\u7a0b\u9965\u997f"}),"\n",(0,r.jsx)(e.p,{children:"TransferStack \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bf7\u6c42\u7c7b\u578b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8868\u793a Node \u7c7b\u578b\u4e3a\u8bf7\u6c42\u7c7b\u578b\nstatic final int REQUEST    = 0;\n// \u8868\u793a Node\u7c7b \u578b\u4e3a\u6570\u636e\u7c7b\u578b\nstatic final int DATA       = 1;\n// \u8868\u793a Node \u7c7b\u578b\u4e3a\u5339\u914d\u4e2d\u7c7b\u578b\n// \u5047\u8bbe\u6808\u9876\u5143\u7d20\u4e3a REQUEST-NODE\uff0c\u5f53\u524d\u8bf7\u6c42\u7c7b\u578b\u4e3a DATA\uff0c\u5165\u6808\u4f1a\u4fee\u6539\u7c7b\u578b\u4e3a FULFILLING \u3010\u6808\u9876 & \u6808\u9876\u4e4b\u4e0b\u7684\u4e00\u4e2anode\u3011\n// \u5047\u8bbe\u6808\u9876\u5143\u7d20\u4e3a DATA-NODE\uff0c\u5f53\u524d\u8bf7\u6c42\u7c7b\u578b\u4e3a REQUEST\uff0c\u5165\u6808\u4f1a\u4fee\u6539\u7c7b\u578b\u4e3a FULFILLING \u3010\u6808\u9876 & \u6808\u9876\u4e4b\u4e0b\u7684\u4e00\u4e2anode\u3011\nstatic final int FULFILLING = 2;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6808\u9876\u5143\u7d20\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"volatile SNode head;\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5185\u90e8\u7c7b SNode\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final class SNode {\n    // \u6307\u5411\u4e0b\u4e00\u4e2a\u6808\u5e27\n    volatile SNode next; \n    // \u4e0e\u5f53\u524d node \u5339\u914d\u7684\u8282\u70b9\n    volatile SNode match;\n    // \u5047\u8bbe\u5f53\u524dnode\u5bf9\u5e94\u7684\u7ebf\u7a0b\u81ea\u65cb\u671f\u95f4\u672a\u88ab\u5339\u914d\u6210\u529f\uff0c\u90a3\u4e48node\u5bf9\u5e94\u7684\u7ebf\u7a0b\u9700\u8981\u6302\u8d77\uff0c\n    // \u6302\u8d77\u524d waiter \u4fdd\u5b58\u5bf9\u5e94\u7684\u7ebf\u7a0b\u5f15\u7528\uff0c\u65b9\u4fbf\u5339\u914d\u6210\u529f\u540e\uff0c\u88ab\u5524\u9192\u3002\n    volatile Thread waiter;\n    \n    // \u6570\u636e\u57df\uff0c\u4e0d\u4e3a\u7a7a\u8868\u793a\u5f53\u524d Node \u5bf9\u5e94\u7684\u8bf7\u6c42\u7c7b\u578b\u4e3a DATA \u7c7b\u578b\uff0c\u53cd\u4e4b\u5219\u8868\u793a Node \u4e3a REQUEST \u7c7b\u578b\n    Object item; \n    // \u8868\u793a\u5f53\u524dNode\u7684\u6a21\u5f0f \u3010DATA/REQUEST/FULFILLING\u3011\n    int mode;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"SNode(Object item) {\n    this.item = item;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u8bbe\u7f6e\u65b9\u6cd5\uff1a\u8bbe\u7f6e Node \u5bf9\u8c61\u7684 next \u5b57\u6bb5\uff0c\u6b64\u5904",(0,r.jsx)(e.strong,{children:"\u5bf9 CAS \u8fdb\u884c\u4e86\u4f18\u5316"}),"\uff0c\u63d0\u5347\u4e86 CAS \u7684\u6548\u7387"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"boolean casNext(SNode cmp, SNode val) {\n    //\u3010\u4f18\u5316\uff1acmp == next\u3011\uff0c\u53ef\u4ee5\u63d0\u5347\u4e00\u90e8\u5206\u6027\u80fd\u3002 cmp == next \u4e0d\u76f8\u7b49\uff0c\u5c31\u6ca1\u5fc5\u8981\u8d70 cas\u6307\u4ee4\u3002\n    return cmp == next && UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5339\u914d\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"boolean tryMatch(SNode s) {\n    // \u5f53\u524d node \u5c1a\u672a\u4e0e\u4efb\u4f55\u8282\u70b9\u53d1\u751f\u8fc7\u5339\u914d\uff0cCAS \u8bbe\u7f6e match \u5b57\u6bb5\u4e3a s \u8282\u70b9\uff0c\u8868\u793a\u5f53\u524d node \u5df2\u7ecf\u88ab\u5339\u914d\n    if (match == null && UNSAFE.compareAndSwapObject(this, matchOffset, null, s)) {\n        // \u5f53\u524d node \u5982\u679c\u81ea\u65cb\u7ed3\u675f\uff0c\u4f1a park \u963b\u585e\uff0c\u963b\u585e\u524d\u5c06 node \u5bf9\u5e94\u7684 Thread \u4fdd\u7559\u5230 waiter \u5b57\u6bb5\n        // \u83b7\u53d6\u5f53\u524d node \u5bf9\u5e94\u7684\u963b\u585e\u7ebf\u7a0b\n        Thread w = waiter;\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e node \u5bf9\u5e94\u7684 Thread \u6b63\u5728\u963b\u585e\n        if (w != null) {\n            waiter = null;\n            // \u4f7f\u7528 unpark \u65b9\u5f0f\u5524\u9192\u7ebf\u7a0b\n            LockSupport.unpark(w);\n        }\n        return true;\n    }\n    // \u5339\u914d\u6210\u529f\u8fd4\u56de true\n    return match == s;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u53d6\u6d88\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u53d6\u6d88\u8282\u70b9\u7684\u65b9\u6cd5\nvoid tryCancel() {\n    // match \u5b57\u6bb5\u6307\u5411\u81ea\u5df1\uff0c\u8868\u793a\u8fd9\u4e2a node \u662f\u53d6\u6d88\u72b6\u6001\uff0c\u53d6\u6d88\u72b6\u6001\u7684 node\uff0c\u6700\u7ec8\u4f1a\u88ab\u5f3a\u5236\u79fb\u9664\u51fa\u6808\n    UNSAFE.compareAndSwapObject(this, matchOffset, null, this);\n}\n\nboolean isCancelled() {\n    return match == this;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"TransferStack \u7c7b\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"snode()\uff1a\u586b\u5145\u8282\u70b9\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static SNode snode(SNode s, Object e, SNode next, int mode) {\n    // \u5f15\u7528\u6307\u5411\u7a7a\u65f6\uff0csnode \u65b9\u6cd5\u4f1a\u521b\u5efa\u4e00\u4e2a SNode \u5bf9\u8c61 \n    if (s == null) s = new SNode(e);\n    // \u586b\u5145\u6570\u636e\n    s.mode = mode;\n    s.next = next;\n    return s;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"transfer()\uff1a\u6838\u5fc3\u65b9\u6cd5\uff0c\u8bf7\u6c42\u5339\u914d\u51fa\u6808\uff0c\u4e0d\u5339\u914d\u963b\u585e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"E transfer(E e, boolean timed, long nanos) {\n\t// \u5305\u88c5\u5f53\u524d\u7ebf\u7a0b\u7684 node\n    SNode s = null;\n    // \u6839\u636e\u5143\u7d20\u5224\u65ad\u5f53\u524d\u7684\u8bf7\u6c42\u7c7b\u578b\n    int mode = (e == null) ? REQUEST : DATA;\n\t// \u81ea\u65cb\n    for (;;) {\n        // \u83b7\u53d6\u6808\u9876\u6307\u9488\n        SNode h = head;\n       // \u3010CASE1\u3011\uff1a\u5f53\u524d\u6808\u4e3a\u7a7a\u6216\u8005\u6808\u9876 node \u6a21\u5f0f\u4e0e\u5f53\u524d\u8bf7\u6c42\u6a21\u5f0f\u4e00\u81f4\u65e0\u6cd5\u5339\u914d\uff0c\u505a\u5165\u6808\u64cd\u4f5c\n        if (h == null || h.mode == mode) {\n            // \u5f53\u524d\u8bf7\u6c42\u662f\u652f\u6301\u8d85\u65f6\u7684\uff0c\u4f46\u662f nanos <= 0 \u8bf4\u660e\u8fd9\u4e2a\u8bf7\u6c42\u4e0d\u652f\u6301 \u201c\u963b\u585e\u7b49\u5f85\u201d\n            if (timed && nanos <= 0) { \n                // \u6808\u9876\u5143\u7d20\u662f\u53d6\u6d88\u72b6\u6001\n                if (h != null && h.isCancelled())\n                    // \u6808\u9876\u51fa\u6808\uff0c\u8bbe\u7f6e\u65b0\u7684\u6808\u9876\n                    casHead(h, h.next);\n                else\n                    // \u8868\u793a\u3010\u5339\u914d\u5931\u8d25\u3011\n                    return null;\n            // \u5165\u6808\n            } else if (casHead(h, s = snode(s, e, h, mode))) {\n                // \u7b49\u5f85\u88ab\u5339\u914d\u7684\u903b\u8f91\uff0c\u6b63\u5e38\u60c5\u51b5\u8fd4\u56de\u5339\u914d\u7684\u8282\u70b9\uff1b\u53d6\u6d88\u60c5\u51b5\u8fd4\u56de\u5f53\u524d\u8282\u70b9\uff0c\u5c31\u662f s\n                SNode m = awaitFulfill(s, timed, nanos);\n                // \u8bf4\u660e\u5f53\u524d node \u662f\u3010\u53d6\u6d88\u72b6\u6001\u3011\n                if (m == s) { \n                    // \u5c06\u53d6\u6d88\u8282\u70b9\u51fa\u6808\n                    clean(s);\n                    return null;\n                }\n                // \u6267\u884c\u5230\u8fd9\u8bf4\u660e\u3010\u5339\u914d\u6210\u529f\u3011\u4e86\n                // \u6808\u9876\u6709\u8282\u70b9\u5e76\u4e14 \u5339\u914d\u8282\u70b9\u8fd8\u672a\u51fa\u6808\uff0c\u9700\u8981\u534f\u52a9\u51fa\u6808\n                if ((h = head) != null && h.next == s)\n                    casHead(h, s.next);\n                // \u5f53\u524d node \u6a21\u5f0f\u4e3a REQUEST \u7c7b\u578b\uff0c\u8fd4\u56de\u5339\u914d\u8282\u70b9\u7684 m.item \u6570\u636e\u57df\n                // \u5f53\u524d node \u6a21\u5f0f\u4e3a DATA \u7c7b\u578b\uff1a\u8fd4\u56de node.item \u6570\u636e\u57df\uff0c\u5f53\u524d\u8bf7\u6c42\u63d0\u4ea4\u7684\u6570\u636e e\n                return (E) ((mode == REQUEST) ? m.item : s.item);\n            }\n        // \u3010CASE2\u3011\uff1a\u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u8bf7\u6c42\u6a21\u5f0f\u4e0d\u4e00\u81f4\uff0c\u5982\u679c\u6808\u9876\u4e0d\u662f FULFILLING \u8bf4\u660e\u6ca1\u88ab\u5176\u4ed6\u8282\u70b9\u5339\u914d\uff0c\u3010\u5f53\u524d\u53ef\u4ee5\u5339\u914d\u3011\n        } else if (!isFulfilling(h.mode)) {\n            // \u5934\u8282\u70b9\u662f\u53d6\u6d88\u8282\u70b9\uff0cmatch \u6307\u5411\u81ea\u5df1\uff0c\u534f\u52a9\u51fa\u6808\n            if (h.isCancelled())\n                casHead(h, h.next);\n            // \u5165\u6808\u5f53\u524d\u8bf7\u6c42\u7684\u8282\u70b9\n            else if (casHead(h, s=snode(s, e, h, FULFILLING|mode))) {\n                for (;;) { \n                    // m \u662f s \u7684\u5339\u914d\u7684\u8282\u70b9\n                    SNode m = s.next;\n                    // m \u8282\u70b9\u5728 awaitFulfill \u65b9\u6cd5\u4e2d\u88ab\u4e2d\u65ad\uff0cclean \u4e86\u81ea\u5df1\n                    if (m == null) {\n                        // \u6e05\u7a7a\u6808\n                        casHead(s, null);\n                        s = null;\n                        // \u8fd4\u56de\u5230\u5916\u5c42\u81ea\u65cb\u4e2d\n                        break;\n                    }\n                    // \u83b7\u53d6\u5339\u914d\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\n                    SNode mn = m.next;\n                    // \u5c1d\u8bd5\u5339\u914d\uff0c\u3010\u5339\u914d\u6210\u529f\u3011\uff0c\u5219\u5c06 fulfilling \u548c m \u4e00\u8d77\u51fa\u6808\uff0c\u5e76\u4e14\u5524\u9192\u88ab\u5339\u914d\u7684\u8282\u70b9\u7684\u7ebf\u7a0b\n                    if (m.tryMatch(s)) {\n                        casHead(s, mn);\n                        return (E) ((mode == REQUEST) ? m.item : s.item);\n                    } else\n                        // \u5339\u914d\u5931\u8d25\uff0c\u51fa\u6808 m\n                        s.casNext(m, mn);\n                }\n            }\n        // \u3010CASE3\u3011\uff1a\u6808\u9876\u6a21\u5f0f\u4e3a FULFILLING \u6a21\u5f0f\uff0c\u8868\u793a\u3010\u6808\u9876\u548c\u6808\u9876\u4e0b\u9762\u7684\u8282\u70b9\u6b63\u5728\u53d1\u751f\u5339\u914d\u3011\uff0c\u5f53\u524d\u8bf7\u6c42\u9700\u8981\u505a\u534f\u52a9\u5de5\u4f5c\n        } else {\n            // h \u8868\u793a\u7684\u662f fulfilling \u8282\u70b9\uff0cm \u8868\u793a fulfilling \u5339\u914d\u7684\u8282\u70b9\n            SNode m = h.next;\n            if (m == null)\n                // \u6e05\u7a7a\u6808\n                casHead(h, null);\n            else {\n                SNode mn = m.next;\n                // m \u548c h \u5339\u914d\uff0c\u5524\u9192 m \u4e2d\u7684\u7ebf\u7a0b\n                if (m.tryMatch(h))\n                    casHead(h, mn);\n                else\n                    h.casNext(m, mn);\n            }\n        }\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"awaitFulfill()\uff1a\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\u7b49\u5f85\u88ab\u5339\u914d\uff0c\u8fd4\u56de\u5339\u914d\u7684\u8282\u70b9\uff0c\u6216\u8005\u88ab\u53d6\u6d88\u7684\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"SNode awaitFulfill(SNode s, boolean timed, long nanos) {\n    // \u7b49\u5f85\u7684\u622a\u6b62\u65f6\u95f4\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    // \u5f53\u524d\u7ebf\u7a0b\n    Thread w = Thread.currentThread();\n    // \u8868\u793a\u5f53\u524d\u8bf7\u6c42\u7ebf\u7a0b\u5728\u4e0b\u9762\u7684 for(;;) \u81ea\u65cb\u68c0\u67e5\u7684\u6b21\u6570\n    int spins = (shouldSpin(s) ? (timed ? maxTimedSpins : maxUntimedSpins) : 0);\n    // \u81ea\u65cb\u68c0\u67e5\u903b\u8f91\uff1a\u662f\u5426\u5339\u914d\u3001\u662f\u5426\u8d85\u65f6\u3001\u662f\u5426\u88ab\u4e2d\u65ad\n    for (;;) {\n        // \u5f53\u524d\u7ebf\u7a0b\u6536\u5230\u4e2d\u65ad\u4fe1\u53f7\uff0c\u9700\u8981\u8bbe\u7f6e node \u72b6\u6001\u4e3a\u53d6\u6d88\u72b6\u6001\n        if (w.isInterrupted())\n            s.tryCancel();\n        // \u83b7\u53d6\u4e0e\u5f53\u524d s \u5339\u914d\u7684\u8282\u70b9\n        SNode m = s.match;\n        if (m != null)\n            // \u53ef\u80fd\u662f\u6b63\u5e38\u7684\u5339\u914d\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u53d6\u6d88\u7684\n            return m;\n        // \u6267\u884c\u4e86\u8d85\u65f6\u9650\u5236\u5c31\u5224\u65ad\u662f\u5426\u8d85\u65f6\n        if (timed) {\n            nanos = deadline - System.nanoTime();\n            // \u3010\u8d85\u65f6\u4e86\uff0c\u53d6\u6d88\u8282\u70b9\u3011\n            if (nanos <= 0L) {\n                s.tryCancel();\n                continue;\n            }\n        }\n        // \u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u8fd8\u53ef\u4ee5\u8fdb\u884c\u81ea\u65cb\u68c0\u67e5\n        if (spins > 0)\n            // \u81ea\u65cb\u4e00\u6b21 \u9012\u51cf 1\n            spins = shouldSpin(s) ? (spins - 1) : 0;\n        // \u8bf4\u660e\u6ca1\u6709\u81ea\u65cb\u6b21\u6570\u4e86\n        else if (s.waiter == null)\n            //\u3010\u628a\u5f53\u524d node \u5bf9\u5e94\u7684 Thread \u4fdd\u5b58\u5230 node.waiter \u5b57\u6bb5\u4e2d\uff0c\u8981\u963b\u585e\u4e86\u3011\n            s.waiter = w;\n        // \u6ca1\u6709\u8d85\u65f6\u9650\u5236\u76f4\u63a5\u963b\u585e\n        else if (!timed)\n            LockSupport.park(this);\n        // nanos > 1000 \u7eb3\u79d2\u7684\u60c5\u51b5\u4e0b\uff0c\u624d\u5141\u8bb8\u6302\u8d77\u5f53\u524d\u7ebf\u7a0b\n        else if (nanos > spinForTimeoutThreshold)\n            LockSupport.parkNanos(this, nanos);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"boolean shouldSpin(SNode s) {\n    // \u83b7\u53d6\u6808\u9876\n    SNode h = head;\n    // \u6761\u4ef6\u4e00\u6210\u7acb\u8bf4\u660e\u5f53\u524d s \u5c31\u662f\u6808\u9876\uff0c\u5141\u8bb8\u81ea\u65cb\u68c0\u67e5\n    // \u6761\u4ef6\u4e8c\u6210\u7acb\u8bf4\u660e\u5f53\u524d s \u8282\u70b9\u81ea\u65cb\u68c0\u67e5\u671f\u95f4\uff0c\u53c8\u6765\u4e86\u4e00\u4e2a\u4e0e\u5f53\u524d s \u8282\u70b9\u5339\u914d\u7684\u8bf7\u6c42\uff0c\u53cc\u53cc\u51fa\u6808\u540e\u6761\u4ef6\u4f1a\u6210\u7acb\n    // \u6761\u4ef6\u4e09\u6210\u7acb\u524d\u63d0\u5f53\u524d s \u4e0d\u662f\u6808\u9876\u5143\u7d20\uff0c\u5e76\u4e14\u5f53\u524d\u6808\u9876\u6b63\u5728\u5339\u914d\u4e2d\uff0c\u8fd9\u79cd\u72b6\u6001\u6808\u9876\u4e0b\u9762\u7684\u5143\u7d20\uff0c\u90fd\u5141\u8bb8\u81ea\u65cb\u68c0\u67e5\n    return (h == s || h == null || isFulfilling(h.mode));\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"clear()\uff1a\u6307\u5b9a\u8282\u70b9\u51fa\u6808"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"void clean(SNode s) {\n    // \u6e05\u7a7a\u6570\u636e\u57df\u548c\u5173\u8054\u7ebf\u7a0b\n    s.item = null;\n    s.waiter = null;\n    \n\t// \u83b7\u53d6\u53d6\u6d88\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\n    SNode past = s.next;\n    // \u5224\u65ad\u540e\u7ee7\u8282\u70b9\u662f\u4e0d\u662f\u53d6\u6d88\u8282\u70b9\uff0c\u662f\u5c31\u66f4\u65b0 past\n    if (past != null && past.isCancelled())\n        past = past.next;\n\n    SNode p;\n    // \u4ece\u6808\u9876\u5f00\u59cb\u5411\u4e0b\u68c0\u67e5\uff0c\u3010\u5c06\u6808\u9876\u5f00\u59cb\u5411\u4e0b\u7684 \u53d6\u6d88\u72b6\u6001 \u7684\u8282\u70b9\u5168\u90e8\u6e05\u7406\u51fa\u53bb\u3011\uff0c\u76f4\u5230\u78b0\u5230 past \u6216\u8005\u4e0d\u662f\u53d6\u6d88\u72b6\u6001\u4e3a\u6b62\n    while ((p = head) != null && p != past && p.isCancelled())\n        // \u4fee\u6539\u7684\u662f\u5185\u5b58\u5730\u5740\u5bf9\u5e94\u7684\u503c\uff0cp \u6307\u5411\u8be5\u5185\u5b58\u5730\u5740\u6240\u4ee5\u6570\u636e\u4e00\u76f4\u5728\u53d8\u5316\n        casHead(p, p.next);\n\t// \u8bf4\u660e\u4e2d\u95f4\u9047\u5230\u4e86\u4e0d\u662f\u53d6\u6d88\u72b6\u6001\u7684\u8282\u70b9\uff0c\u7ee7\u7eed\u8fed\u4ee3\u4e0b\u53bb\n    while (p != null && p != past) {\n        SNode n = p.next;\n        if (n != null && n.isCancelled())\n            p.casNext(n, n.next);\n        else\n            p = n;\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u516c\u5e73\u5b9e\u73b0",children:"\u516c\u5e73\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.p,{children:"TransferQueue \u662f\u516c\u5e73\u7684\u540c\u6b65\u961f\u5217\uff0c\u91c7\u7528 FIFO \u7684\u961f\u5217\u5b9e\u73b0\uff0c\u8bf7\u6c42\u8282\u70b9\u4e0e\u961f\u5c3e\u6a21\u5f0f\u4e0d\u540c\uff0c\u9700\u8981\u4e0e\u961f\u5934\u53d1\u751f\u5339\u914d"}),"\n",(0,r.jsx)(e.p,{children:"TransferQueue \u7c7b\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6307\u5411\u961f\u5217\u7684 dummy \u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"transient volatile QNode head;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6307\u5411\u961f\u5217\u7684\u5c3e\u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"transient volatile QNode tail;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u88ab\u6e05\u7406\u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"transient volatile QNode cleanMe;\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5165\u961f\u64cd\u4f5c\u662f\u4e24\u6b65\u5b8c\u6210\u7684\uff0c\u7b2c\u4e00\u6b65\u662f t.next = newNode\uff0c\u7b2c\u4e8c\u6b65\u662f tail = newNode\uff0c\u6240\u4ee5\u961f\u5c3e\u8282\u70b9\u51fa\u961f\uff0c\u662f\u4e00\u79cd\u975e\u5e38\u7279\u6b8a\u7684\u60c5\u51b5"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"TransferQueue \u5185\u90e8\u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"QNode\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final class QNode {\n    // \u6307\u5411\u5f53\u524d\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\n    volatile QNode next;\n    // \u6570\u636e\u57df\uff0cNode \u4ee3\u8868\u7684\u662f DATA \u7c7b\u578b item \u8868\u793a\u6570\u636e\uff0c\u5426\u5219 Node \u4ee3\u8868\u7684 REQUEST \u7c7b\u578b\uff0citem == null\n    volatile Object item;\n    // \u5047\u8bbe\u5f53\u524d node \u5bf9\u5e94\u7684\u7ebf\u7a0b\u81ea\u65cb\u671f\u95f4\u672a\u88ab\u5339\u914d\u6210\u529f\uff0c\u90a3\u4e48 node \u5bf9\u5e94\u7684\u7ebf\u7a0b\u9700\u8981\u6302\u8d77\uff0c\n    // \u6302\u8d77\u524d waiter \u4fdd\u5b58\u5bf9\u5e94\u7684\u7ebf\u7a0b\u5f15\u7528\uff0c\u65b9\u4fbf\u5339\u914d\u6210\u529f\u540e\u88ab\u5524\u9192\u3002\n    volatile Thread waiter;\n    // true \u5f53\u524d Node \u662f\u4e00\u4e2a DATA \u7c7b\u578b\uff0cfalse \u8868\u793a\u5f53\u524d Node \u662f\u4e00\u4e2a REQUEST \u7c7b\u578b\n    final boolean isData;\n\n\t// \u6784\u5efa\u65b9\u6cd5\n    QNode(Object item, boolean isData) {\n        this.item = item;\n        this.isData = isData;\n    }\n\n    // \u5c1d\u8bd5\u53d6\u6d88\u5f53\u524d node\uff0c\u53d6\u6d88\u72b6\u6001\u7684 node \u7684 item \u57df\u6307\u5411\u81ea\u5df1\n    void tryCancel(Object cmp) {\n        UNSAFE.compareAndSwapObject(this, itemOffset, cmp, this);\n    }\n\n    // \u5224\u65ad\u5f53\u524d node \u662f\u5426\u4e3a\u53d6\u6d88\u72b6\u6001\n    boolean isCancelled() {\n        return item == this;\n    }\n\n    // \u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426 \u201c\u4e0d\u5728\u201d \u961f\u5217\u5185\uff0c\u5f53 next \u6307\u5411\u81ea\u5df1\u65f6\uff0c\u8bf4\u660e\u8282\u70b9\u5df2\u7ecf\u51fa\u961f\u3002\n    boolean isOffList() {\n        return next == this;\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"TransferQueue \u7c7b\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bbe\u7f6e\u5934\u5c3e\u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"void advanceHead(QNode h, QNode nh) {\n    // \u8bbe\u7f6e\u5934\u6307\u9488\u6307\u5411\u65b0\u7684\u8282\u70b9\uff0c\n    if (h == head && UNSAFE.compareAndSwapObject(this, headOffset, h, nh))\n        // \u8001\u7684\u5934\u8282\u70b9\u51fa\u961f\n        h.next = h;\n}\nvoid advanceTail(QNode t, QNode nt) {\n    if (tail == t)\n        // \u66f4\u65b0\u961f\u5c3e\u8282\u70b9\u4e3a\u65b0\u7684\u961f\u5c3e\n        UNSAFE.compareAndSwapObject(this, tailOffset, t, nt);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"transfer()\uff1a\u6838\u5fc3\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"E transfer(E e, boolean timed, long nanos) {\n    // s \u6307\u5411\u5f53\u524d\u8bf7\u6c42\u5bf9\u5e94\u7684 node\n    QNode s = null;\n    // \u662f\u5426\u662f DATA \u7c7b\u578b\u7684\u8bf7\u6c42\n    boolean isData = (e != null);\n\t// \u81ea\u65cb\n    for (;;) {\n        QNode t = tail;\n        QNode h = head;\n        if (t == null || h == null)\n            continue;\n\t\t// head \u548c tail \u540c\u65f6\u6307\u5411 dummy \u8282\u70b9\uff0c\u8bf4\u660e\u662f\u7a7a\u961f\u5217\n        // \u961f\u5c3e\u8282\u70b9\u4e0e\u5f53\u524d\u8bf7\u6c42\u7c7b\u578b\u662f\u4e00\u81f4\u7684\u60c5\u51b5\uff0c\u8bf4\u660e\u963b\u585e\u961f\u5217\u4e2d\u90fd\u65e0\u6cd5\u5339\u914d\uff0c\n        if (h == t || t.isData == isData) {\n            // \u83b7\u53d6\u961f\u5c3e t \u7684 next \u8282\u70b9\n            QNode tn = t.next;\n            // \u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\u5176\u4ed6\u7ebf\u7a0b\u53ef\u80fd\u4fee\u6539\u5c3e\u8282\u70b9\n            if (t != tail)\n                continue;\n            // \u5df2\u7ecf\u6709\u7ebf\u7a0b\u5165\u961f\u4e86\uff0c\u66f4\u65b0 tail\n            if (tn != null) {\n                advanceTail(t, tn);\n                continue;\n            }\n            // \u5141\u8bb8\u8d85\u65f6\uff0c\u8d85\u65f6\u65f6\u95f4\u5c0f\u4e8e 0\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4e0d\u652f\u6301\u963b\u585e\u7b49\u5f85\n            if (timed && nanos <= 0)\n                return null;\n            // \u521b\u5efa node \u7684\u903b\u8f91\n            if (s == null)\n                s = new QNode(e, isData);\n            // \u5c06 node \u6dfb\u52a0\u5230\u961f\u5c3e\n            if (!t.casNext(null, s))\n                continue;\n\t\t\t// \u66f4\u65b0\u961f\u5c3e\u6307\u9488\n            advanceTail(t, s);\n            \n            // \u5f53\u524d\u8282\u70b9 \u7b49\u5f85\u5339\u914d....\n            Object x = awaitFulfill(s, e, timed, nanos);\n            \n            // \u8bf4\u660e\u3010\u5f53\u524d node \u72b6\u6001\u4e3a \u53d6\u6d88\u72b6\u6001\u3011\uff0c\u9700\u8981\u505a\u51fa\u961f\u903b\u8f91\n            if (x == s) {\n                clean(t, s);\n                return null;\n            }\n\t\t\t// \u8bf4\u660e\u5f53\u524d node \u4ecd\u7136\u5728\u961f\u5217\u5185\uff0c\u5339\u914d\u6210\u529f\uff0c\u9700\u8981\u505a\u51fa\u961f\u903b\u8f91\n            if (!s.isOffList()) {\n                // t \u662f\u5f53\u524d s \u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\uff0c\u5224\u65ad t \u662f\u4e0d\u662f\u5934\u8282\u70b9\uff0c\u662f\u5c31\u66f4\u65b0 dummy \u8282\u70b9\u4e3a s \u8282\u70b9\n                advanceHead(t, s);\n                // s \u8282\u70b9\u5df2\u7ecf\u51fa\u961f\uff0c\u6240\u4ee5\u9700\u8981\u628a\u5b83\u7684 item \u57df\u8bbe\u7f6e\u4e3a\u5b83\u81ea\u5df1\uff0c\u8868\u793a\u5b83\u662f\u4e2a\u53d6\u6d88\u72b6\u6001\n                if (x != null)\n                    s.item = s;\n                s.waiter = null;\n            }\n            return (x != null) ? (E)x : e;\n\t\t// \u961f\u5c3e\u8282\u70b9\u4e0e\u5f53\u524d\u8bf7\u6c42\u8282\u70b9\u3010\u4e92\u8865\u5339\u914d\u3011\n        } else {\n            // h.next \u8282\u70b9\uff0c\u3010\u8bf7\u6c42\u8282\u70b9\u4e0e\u961f\u5c3e\u6a21\u5f0f\u4e0d\u540c\uff0c\u9700\u8981\u4e0e\u961f\u5934\u53d1\u751f\u5339\u914d\u3011\uff0cTransferQueue \u662f\u4e00\u4e2a\u3010\u516c\u5e73\u6a21\u5f0f\u3011\n            QNode m = h.next;\n            // \u5e76\u53d1\u5bfc\u81f4\u5176\u4ed6\u7ebf\u7a0b\u4fee\u6539\u4e86\u961f\u5c3e\u8282\u70b9\uff0c\u6216\u8005\u5df2\u7ecf\u628a head.next \u5339\u914d\u8d70\u4e86\n            if (t != tail || m == null || h != head)\n                continue;\n\t\t\t// \u83b7\u53d6\u5339\u914d\u8282\u70b9\u7684\u6570\u636e\u57df\u4fdd\u5b58\u5230 x\n            Object x = m.item;\n            // \u5224\u65ad\u662f\u5426\u5339\u914d\u6210\u529f\n            if (isData == (x != null) ||\n                x == m ||\n                !m.casItem(x, e)) {\n                advanceHead(h, m);\n                continue;\n            }\n\t\t\t// \u3010\u5339\u914d\u5b8c\u6210\u3011\uff0c\u5c06\u5934\u8282\u70b9\u51fa\u961f\uff0c\u8ba9\u8fd9\u4e2a\u65b0\u7684\u5934\u7ed3\u70b9\u6210\u4e3a dummy \u8282\u70b9\n            advanceHead(h, m);\n            // \u5524\u9192\u8be5\u5339\u914d\u8282\u70b9\u7684\u7ebf\u7a0b\n            LockSupport.unpark(m.waiter);\n            return (x != null) ? (E)x : e;\n        }\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"awaitFulfill()\uff1a\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\u7b49\u5f85\u88ab\u5339\u914d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"Object awaitFulfill(QNode s, E e, boolean timed, long nanos) {\n    // \u8868\u793a\u7b49\u5f85\u622a\u6b62\u65f6\u95f4\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    Thread w = Thread.currentThread();\n    // \u81ea\u9009\u68c0\u67e5\u7684\u6b21\u6570\n    int spins = ((head.next == s) ? (timed ? maxTimedSpins : maxUntimedSpins) : 0);\n    for (;;) {\n        // \u88ab\u6253\u65ad\u5c31\u53d6\u6d88\u8282\u70b9\n        if (w.isInterrupted())\n            s.tryCancel(e);\n        // \u83b7\u53d6\u5f53\u524d Node \u6570\u636e\u57df\n        Object x = s.item;\n        \n        // \u5f53\u524d\u8bf7\u6c42\u4e3a DATA \u6a21\u5f0f\u65f6\uff1ae \u8bf7\u6c42\u5e26\u6765\u7684\u6570\u636e\n        // s.item \u4fee\u6539\u4e3a this\uff0c\u8bf4\u660e\u5f53\u524d QNode \u5bf9\u5e94\u7684\u7ebf\u7a0b \u53d6\u6d88\u72b6\u6001\n        // s.item \u4fee\u6539\u4e3a null \u8868\u793a\u5df2\u7ecf\u6709\u5339\u914d\u8282\u70b9\u4e86\uff0c\u5e76\u4e14\u5339\u914d\u8282\u70b9\u62ff\u8d70\u4e86 item \u6570\u636e\n\n        // \u5f53\u524d\u8bf7\u6c42\u4e3a REQUEST \u6a21\u5f0f\u65f6\uff1ae == null\n        // s.item \u4fee\u6539\u4e3a this\uff0c\u8bf4\u660e\u5f53\u524d QNode \u5bf9\u5e94\u7684\u7ebf\u7a0b \u53d6\u6d88\u72b6\u6001\n        // s.item != null \u4e14 item != this  \u8868\u793a\u5f53\u524d REQUEST \u7c7b\u578b\u7684 Node \u5df2\u7ecf\u5339\u914d\u5230 DATA \u4e86 \n        if (x != e)\n            return x;\n        // \u8d85\u65f6\u68c0\u67e5\n        if (timed) {\n            nanos = deadline - System.nanoTime();\n            if (nanos <= 0L) {\n                s.tryCancel(e);\n                continue;\n            }\n        }\n        // \u81ea\u65cb\u6b21\u6570\u51cf\u4e00\n        if (spins > 0)\n            --spins;\n        // \u6ca1\u6709\u81ea\u65cb\u6b21\u6570\u4e86\uff0c\u628a\u5f53\u524d\u7ebf\u7a0b\u5c01\u88c5\u8fdb\u53bb waiter\n        else if (s.waiter == null)\n            s.waiter = w;\n        // \u963b\u585e\n        else if (!timed)\n            LockSupport.park(this);\n        else if (nanos > spinForTimeoutThreshold)\n            LockSupport.parkNanos(this, nanos);\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u64cd\u4f5cpool",children:"\u64cd\u4f5cPool"}),"\n",(0,r.jsx)(e.h4,{id:"\u521b\u5efa\u65b9\u5f0f",children:"\u521b\u5efa\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.h5,{id:"executor",children:"Executor"}),"\n",(0,r.jsx)(e.p,{children:"\u5b58\u653e\u7ebf\u7a0b\u7684\u5bb9\u5668\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final HashSet<Worker> workers = new HashSet<Worker>();\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ThreadPoolExecutor(int corePoolSize,\n                          int maximumPoolSize,\n                          long keepAliveTime,\n                          TimeUnit unit,\n                          BlockingQueue<Runnable> workQueue,\n                          ThreadFactory threadFactory,\n                          RejectedExecutionHandler handler)\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u53c2\u6570\u4ecb\u7ecd\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"corePoolSize\uff1a\u6838\u5fc3\u7ebf\u7a0b\u6570\uff0c\u5b9a\u4e49\u4e86\u6700\u5c0f\u53ef\u4ee5\u540c\u65f6\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u91cf"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"maximumPoolSize\uff1a\u6700\u5927\u7ebf\u7a0b\u6570\uff0c\u5f53\u961f\u5217\u4e2d\u5b58\u653e\u7684\u4efb\u52a1\u8fbe\u5230\u961f\u5217\u5bb9\u91cf\u65f6\uff0c\u5f53\u524d\u53ef\u4ee5\u540c\u65f6\u8fd0\u884c\u7684\u6570\u91cf\u53d8\u4e3a\u6700\u5927\u7ebf\u7a0b\u6570\uff0c\u521b\u5efa\u7ebf\u7a0b\u5e76\u7acb\u5373\u6267\u884c\u6700\u65b0\u7684\u4efb\u52a1\uff0c\u4e0e\u6838\u5fc3\u7ebf\u7a0b\u6570\u4e4b\u95f4\u7684\u5dee\u503c\u53c8\u53eb\u6551\u6025\u7ebf\u7a0b\u6570"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["keepAliveTime\uff1a\u6551\u6025\u7ebf\u7a0b\u6700\u5927\u5b58\u6d3b\u65f6\u95f4\uff0c\u5f53\u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\u5927\u4e8e ",(0,r.jsx)(e.code,{children:"corePoolSize"})," \u7684\u65f6\u5019\uff0c\u5982\u679c\u8fd9\u65f6\u6ca1\u6709\u65b0\u7684\u4efb\u52a1\u63d0\u4ea4\uff0c\u6838\u5fc3\u7ebf\u7a0b\u5916\u7684\u7ebf\u7a0b\u4e0d\u4f1a\u7acb\u5373\u9500\u6bc1\uff0c\u800c\u662f\u4f1a\u7b49\u5230 ",(0,r.jsx)(e.code,{children:"keepAliveTime"})," \u65f6\u95f4\u8d85\u8fc7\u9500\u6bc1"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["unit\uff1a",(0,r.jsx)(e.code,{children:"keepAliveTime"})," \u53c2\u6570\u7684\u65f6\u95f4\u5355\u4f4d"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"workQueue\uff1a\u963b\u585e\u961f\u5217\uff0c\u5b58\u653e\u88ab\u63d0\u4ea4\u4f46\u5c1a\u672a\u88ab\u6267\u884c\u7684\u4efb\u52a1"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"threadFactory\uff1a\u7ebf\u7a0b\u5de5\u5382\uff0c\u521b\u5efa\u65b0\u7ebf\u7a0b\u65f6\u7528\u5230\uff0c\u53ef\u4ee5\u4e3a\u7ebf\u7a0b\u521b\u5efa\u65f6\u8d77\u540d\u5b57"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"handler\uff1a\u62d2\u7edd\u7b56\u7565\uff0c\u7ebf\u7a0b\u5230\u8fbe\u6700\u5927\u7ebf\u7a0b\u6570\u4ecd\u6709\u65b0\u4efb\u52a1\u65f6\u4f1a\u6267\u884c\u62d2\u7edd\u7b56\u7565"}),"\n",(0,r.jsx)(e.p,{children:"RejectedExecutionHandler \u4e0b\u6709 4 \u4e2a\u5b9e\u73b0\u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["AbortPolicy\uff1a\u8ba9\u8c03\u7528\u8005\u629b\u51fa RejectedExecutionException \u5f02\u5e38\uff0c",(0,r.jsx)(e.strong,{children:"\u9ed8\u8ba4\u7b56\u7565"})]}),"\n",(0,r.jsx)(e.li,{children:"CallerRunsPolicy\uff1a\u8ba9\u8c03\u7528\u8005\u8fd0\u884c\u7684\u8c03\u8282\u673a\u5236\uff0c\u5c06\u67d0\u4e9b\u4efb\u52a1\u56de\u9000\u5230\u8c03\u7528\u8005\uff0c\u4ece\u800c\u964d\u4f4e\u65b0\u4efb\u52a1\u7684\u6d41\u91cf"}),"\n",(0,r.jsx)(e.li,{children:"DiscardPolicy\uff1a\u76f4\u63a5\u4e22\u5f03\u4efb\u52a1\uff0c\u4e0d\u4e88\u4efb\u4f55\u5904\u7406\u4e5f\u4e0d\u629b\u51fa\u5f02\u5e38"}),"\n",(0,r.jsx)(e.li,{children:"DiscardOldestPolicy\uff1a\u653e\u5f03\u961f\u5217\u4e2d\u6700\u65e9\u7684\u4efb\u52a1\uff0c\u628a\u5f53\u524d\u4efb\u52a1\u52a0\u5165\u961f\u5217\u4e2d\u5c1d\u8bd5\u518d\u6b21\u63d0\u4ea4\u5f53\u524d\u4efb\u52a1"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u8865\u5145\uff1a\u5176\u4ed6\u6846\u67b6\u62d2\u7edd\u7b56\u7565"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Dubbo\uff1a\u5728\u629b\u51fa RejectedExecutionException \u5f02\u5e38\u524d\u8bb0\u5f55\u65e5\u5fd7\uff0c\u5e76 dump \u7ebf\u7a0b\u6808\u4fe1\u606f\uff0c\u65b9\u4fbf\u5b9a\u4f4d\u95ee\u9898"}),"\n",(0,r.jsx)(e.li,{children:"Netty\uff1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7ebf\u7a0b\u6765\u6267\u884c\u4efb\u52a1"}),"\n",(0,r.jsx)(e.li,{children:"ActiveMQ\uff1a\u5e26\u8d85\u65f6\u7b49\u5f85\uff0860s\uff09\u5c1d\u8bd5\u653e\u5165\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"PinPoint\uff1a\u5b83\u4f7f\u7528\u4e86\u4e00\u4e2a\u62d2\u7edd\u7b56\u7565\u94fe\uff0c\u4f1a\u9010\u4e00\u5c1d\u8bd5\u7b56\u7565\u94fe\u4e2d\u6bcf\u79cd\u62d2\u7edd\u7b56\u7565"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5de5\u4f5c\u539f\u7406\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(62889).A+"",width:"1661",height:"795"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u521b\u5efa\u7ebf\u7a0b\u6c60\uff0c\u8fd9\u65f6\u6ca1\u6709\u521b\u5efa\u7ebf\u7a0b\uff08",(0,r.jsx)(e.strong,{children:"\u61d2\u60f0"}),"\uff09\uff0c\u7b49\u5f85\u63d0\u4ea4\u8fc7\u6765\u7684\u4efb\u52a1\u8bf7\u6c42\uff0c\u8c03\u7528 execute \u65b9\u6cd5\u624d\u4f1a\u521b\u5efa\u7ebf\u7a0b"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u8c03\u7528 execute() \u65b9\u6cd5\u6dfb\u52a0\u4e00\u4e2a\u8bf7\u6c42\u4efb\u52a1\u65f6\uff0c\u7ebf\u7a0b\u6c60\u4f1a\u505a\u5982\u4e0b\u5224\u65ad\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u91cf\u5c0f\u4e8e corePoolSize\uff0c\u90a3\u4e48\u9a6c\u4e0a\u521b\u5efa\u7ebf\u7a0b\u8fd0\u884c\u8fd9\u4e2a\u4efb\u52a1"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u91cf\u5927\u4e8e\u6216\u7b49\u4e8e corePoolSize\uff0c\u90a3\u4e48\u5c06\u8fd9\u4e2a\u4efb\u52a1\u653e\u5165\u961f\u5217"}),"\n",(0,r.jsxs)(e.li,{children:["\u5982\u679c\u8fd9\u65f6\u961f\u5217\u6ee1\u4e86\u4e14\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u91cf\u8fd8\u5c0f\u4e8e maximumPoolSize\uff0c\u90a3\u4e48\u4f1a\u521b\u5efa\u975e\u6838\u5fc3\u7ebf\u7a0b",(0,r.jsx)(e.strong,{children:"\u7acb\u523b\u8fd0\u884c\u8fd9\u4e2a\u4efb\u52a1"}),"\uff0c\u5bf9\u4e8e\u963b\u585e\u961f\u5217\u4e2d\u7684\u4efb\u52a1\u4e0d\u516c\u5e73\u3002\u8fd9\u662f\u56e0\u4e3a\u521b\u5efa\u6bcf\u4e2a Worker\uff08\u7ebf\u7a0b\uff09\u5bf9\u8c61\u4f1a\u7ed1\u5b9a\u4e00\u4e2a\u521d\u59cb\u4efb\u52a1\uff0c\u542f\u52a8 Worker \u65f6\u4f1a\u4f18\u5148\u6267\u884c"]}),"\n",(0,r.jsxs)(e.li,{children:["\u5982\u679c\u961f\u5217\u6ee1\u4e86\u4e14\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u91cf\u5927\u4e8e\u6216\u7b49\u4e8e maximumPoolSize\uff0c\u90a3\u4e48\u7ebf\u7a0b\u6c60\u4f1a\u542f\u52a8\u9971\u548c",(0,r.jsx)(e.strong,{children:"\u62d2\u7edd\u7b56\u7565"}),"\u6765\u6267\u884c"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u4e00\u4e2a\u7ebf\u7a0b\u5b8c\u6210\u4efb\u52a1\u65f6\uff0c\u4f1a\u4ece\u961f\u5217\u4e2d\u53d6\u4e0b\u4e00\u4e2a\u4efb\u52a1\u6765\u6267\u884c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u4e00\u4e2a\u7ebf\u7a0b\u7a7a\u95f2\u8d85\u8fc7\u4e00\u5b9a\u7684\u65f6\u95f4\uff08keepAliveTime\uff09\u65f6\uff0c\u7ebf\u7a0b\u6c60\u4f1a\u5224\u65ad\uff1a\u5982\u679c\u5f53\u524d\u8fd0\u884c\u7684\u7ebf\u7a0b\u6570\u5927\u4e8e corePoolSize\uff0c\u90a3\u4e48\u8fd9\u4e2a\u7ebf\u7a0b\u5c31\u88ab\u505c\u6389\uff0c\u6240\u4ee5\u7ebf\u7a0b\u6c60\u7684\u6240\u6709\u4efb\u52a1\u5b8c\u6210\u540e\u6700\u7ec8\u4f1a\u6536\u7f29\u5230 corePoolSize \u5927\u5c0f"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u56fe\u7247\u6765\u6e90\uff1a",(0,r.jsx)(e.a,{href:"https://space.bilibili.com/457326371/",children:"https://space.bilibili.com/457326371/"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"executors",children:"Executors"}),"\n",(0,r.jsx)(e.p,{children:"Executors \u63d0\u4f9b\u4e86\u56db\u79cd\u7ebf\u7a0b\u6c60\u7684\u521b\u5efa\uff1anewCachedThreadPool\u3001newFixedThreadPool\u3001newSingleThreadExecutor\u3001newScheduledThreadPool"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"newFixedThreadPool\uff1a\u521b\u5efa\u4e00\u4e2a\u62e5\u6709 n \u4e2a\u7ebf\u7a0b\u7684\u7ebf\u7a0b\u6c60"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public static ExecutorService newFixedThreadPool(int nThreads) {\n    return new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS,\n                                  new LinkedBlockingQueue<Runnable>());\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6838\u5fc3\u7ebf\u7a0b\u6570 == \u6700\u5927\u7ebf\u7a0b\u6570\uff08\u6ca1\u6709\u6551\u6025\u7ebf\u7a0b\u88ab\u521b\u5efa\uff09\uff0c\u56e0\u6b64\u4e5f\u65e0\u9700\u8d85\u65f6\u65f6\u95f4"}),"\n",(0,r.jsxs)(e.li,{children:["LinkedBlockingQueue \u662f\u4e00\u4e2a\u5355\u5411\u94fe\u8868\u5b9e\u73b0\u7684\u963b\u585e\u961f\u5217\uff0c\u9ed8\u8ba4\u5927\u5c0f\u4e3a ",(0,r.jsx)(e.code,{children:"Integer.MAX_VALUE"}),"\uff0c\u4e5f\u5c31\u662f\u65e0\u754c\u961f\u5217\uff0c\u53ef\u4ee5\u653e\u4efb\u610f\u6570\u91cf\u7684\u4efb\u52a1\uff0c\u5728\u4efb\u52a1\u6bd4\u8f83\u591a\u7684\u65f6\u5019\u4f1a\u5bfc\u81f4 OOM\uff08\u5185\u5b58\u6ea2\u51fa\uff09"]}),"\n",(0,r.jsx)(e.li,{children:"\u9002\u7528\u4e8e\u4efb\u52a1\u91cf\u5df2\u77e5\uff0c\u76f8\u5bf9\u8017\u65f6\u7684\u957f\u671f\u4efb\u52a1"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"newCachedThreadPool\uff1a\u521b\u5efa\u4e00\u4e2a\u53ef\u6269\u5bb9\u7684\u7ebf\u7a0b\u6c60"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public static ExecutorService newCachedThreadPool() {\n    return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS,\n                                  new SynchronousQueue<Runnable>());\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6838\u5fc3\u7ebf\u7a0b\u6570\u662f 0\uff0c \u6700\u5927\u7ebf\u7a0b\u6570\u662f 29 \u4e2a 1\uff0c\u5168\u90e8\u90fd\u662f\u6551\u6025\u7ebf\u7a0b\uff0860s \u540e\u53ef\u4ee5\u56de\u6536\uff09\uff0c\u53ef\u80fd\u4f1a\u521b\u5efa\u5927\u91cf\u7ebf\u7a0b\uff0c\u4ece\u800c\u5bfc\u81f4 ",(0,r.jsx)(e.strong,{children:"OOM"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"SynchronousQueue \u4f5c\u4e3a\u963b\u585e\u961f\u5217\uff0c\u6ca1\u6709\u5bb9\u91cf\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a take \u7684\u7ebf\u7a0b\u4f1a\u963b\u585e\u76f4\u5230\u6709\u4e00\u4e2a put \u7684\u7ebf\u7a0b\u653e\u5165\u5143\u7d20\u4e3a\u6b62\uff08\u7c7b\u4f3c\u4e00\u624b\u4ea4\u94b1\u3001\u4e00\u624b\u4ea4\u8d27\uff09"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u9002\u5408\u4efb\u52a1\u6570\u6bd4\u8f83\u5bc6\u96c6\uff0c\u4f46\u6bcf\u4e2a\u4efb\u52a1\u6267\u884c\u65f6\u95f4\u8f83\u77ed\u7684\u60c5\u51b5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"newSingleThreadExecutor\uff1a\u521b\u5efa\u4e00\u4e2a\u53ea\u6709 1 \u4e2a\u7ebf\u7a0b\u7684\u5355\u7ebf\u7a0b\u6c60"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public static ExecutorService newSingleThreadExecutor() {\n    return new FinalizableDelegatedExecutorService\n        (new ThreadPoolExecutor(1, 1,0L, TimeUnit.MILLISECONDS,\n                                new LinkedBlockingQueue<Runnable>()));\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u4fdd\u8bc1\u6240\u6709\u4efb\u52a1\u6309\u7167",(0,r.jsx)(e.strong,{children:"\u6307\u5b9a\u987a\u5e8f\u6267\u884c"}),"\uff0c\u7ebf\u7a0b\u6570\u56fa\u5b9a\u4e3a 1\uff0c\u4efb\u52a1\u6570\u591a\u4e8e 1 \u65f6\u4f1a\u653e\u5165\u65e0\u754c\u961f\u5217\u6392\u961f\uff0c\u4efb\u52a1\u6267\u884c\u5b8c\u6bd5\uff0c\u8fd9\u552f\u4e00\u7684\u7ebf\u7a0b\u4e5f\u4e0d\u4f1a\u88ab\u91ca\u653e"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u6bd4\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u521b\u5efa\u4e00\u4e2a\u5355\u7ebf\u7a0b\u4e32\u884c\u6267\u884c\u4efb\u52a1\uff0c\u5982\u679c\u4efb\u52a1\u6267\u884c\u5931\u8d25\u800c\u7ec8\u6b62\u90a3\u4e48\u6ca1\u6709\u4efb\u4f55\u8865\u6551\u63aa\u65bd\uff0c\u7ebf\u7a0b\u6c60\u4f1a\u65b0\u5efa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4fdd\u8bc1\u6c60\u7684\u6b63\u5e38\u5de5\u4f5c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Executors.newSingleThreadExecutor() \u7ebf\u7a0b\u4e2a\u6570\u59cb\u7ec8\u4e3a 1\uff0c\u4e0d\u80fd\u4fee\u6539\u3002FinalizableDelegatedExecutorService \u5e94\u7528\u7684\u662f\u88c5\u9970\u5668\u6a21\u5f0f\uff0c\u53ea\u5bf9\u5916\u66b4\u9732\u4e86 ExecutorService \u63a5\u53e3\uff0c\u56e0\u6b64\u4e0d\u80fd\u8c03\u7528 ThreadPoolExecutor \u4e2d\u7279\u6709\u7684\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u56e0\uff1a\u7236\u7c7b\u4e0d\u80fd\u76f4\u63a5\u8c03\u7528\u5b50\u7c7b\u4e2d\u7684\u65b9\u6cd5\uff0c\u9700\u8981\u53cd\u5c04\u6216\u8005\u521b\u5efa\u5bf9\u8c61\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u8c03\u7528\u5b50\u7c7b\u9759\u6001\u65b9\u6cd5"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Executors.newFixedThreadPool(1) \u521d\u59cb\u65f6\u4e3a 1\uff0c\u53ef\u4ee5\u4fee\u6539\u3002\u5bf9\u5916\u66b4\u9732\u7684\u662f ThreadPoolExecutor \u5bf9\u8c61\uff0c\u53ef\u4ee5\u5f3a\u8f6c\u540e\u8c03\u7528 setCorePoolSize \u7b49\u65b9\u6cd5\u8fdb\u884c\u4fee\u6539"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(3686).A+"",width:"729",height:"320"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5f00\u53d1\u8981\u6c42",children:"\u5f00\u53d1\u8981\u6c42"}),"\n",(0,r.jsx)(e.p,{children:"\u963f\u91cc\u5df4\u5df4 Java \u5f00\u53d1\u624b\u518c\u8981\u6c42\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u8d44\u6e90\u5fc5\u987b\u901a\u8fc7\u7ebf\u7a0b\u6c60\u63d0\u4f9b\uff0c\u4e0d\u5141\u8bb8\u5728\u5e94\u7528\u4e2d\u81ea\u884c\u663e\u5f0f\u521b\u5efa\u7ebf\u7a0b"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u7ebf\u7a0b\u6c60\u7684\u597d\u5904\u662f\u51cf\u5c11\u5728\u521b\u5efa\u548c\u9500\u6bc1\u7ebf\u7a0b\u4e0a\u6240\u6d88\u8017\u7684\u65f6\u95f4\u4ee5\u53ca\u7cfb\u7edf\u8d44\u6e90\u7684\u5f00\u9500\uff0c\u89e3\u51b3\u8d44\u6e90\u4e0d\u8db3\u7684\u95ee\u9898"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u4e0d\u4f7f\u7528\u7ebf\u7a0b\u6c60\uff0c\u6709\u53ef\u80fd\u9020\u6210\u7cfb\u7edf\u521b\u5efa\u5927\u91cf\u540c\u7c7b\u7ebf\u7a0b\u800c\u5bfc\u81f4\u6d88\u8017\u5b8c\u5185\u5b58\u6216\u8005\u8fc7\u5ea6\u5207\u6362\u7684\u95ee\u9898"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u6c60\u4e0d\u5141\u8bb8\u4f7f\u7528 Executors \u53bb\u521b\u5efa\uff0c\u800c\u662f\u901a\u8fc7 ThreadPoolExecutor \u7684\u65b9\u5f0f\uff0c\u8fd9\u6837\u7684\u5904\u7406\u65b9\u5f0f\u66f4\u52a0\u660e\u786e\u7ebf\u7a0b\u6c60\u7684\u8fd0\u884c\u89c4\u5219\uff0c\u89c4\u907f\u8d44\u6e90\u8017\u5c3d\u7684\u98ce\u9669"}),"\n",(0,r.jsx)(e.p,{children:"Executors \u8fd4\u56de\u7684\u7ebf\u7a0b\u6c60\u5bf9\u8c61\u5f0a\u7aef\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"FixedThreadPool \u548c SingleThreadPool\uff1a\u8bf7\u6c42\u961f\u5217\u957f\u5ea6\u4e3a Integer.MAX_VALUE\uff0c\u53ef\u80fd\u4f1a\u5806\u79ef\u5927\u91cf\u7684\u8bf7\u6c42\uff0c\u4ece\u800c\u5bfc\u81f4 OOM"}),"\n",(0,r.jsx)(e.li,{children:"CacheThreadPool \u548c ScheduledThreadPool\uff1a\u5141\u8bb8\u521b\u5efa\u7ebf\u7a0b\u6570\u91cf\u4e3a Integer.MAX_VALUE\uff0c\u53ef\u80fd\u4f1a\u521b\u5efa\u5927\u91cf\u7684\u7ebf\u7a0b\uff0c\u5bfc\u81f4 OOM"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u521b\u5efa\u591a\u5927\u5bb9\u91cf\u7684\u7ebf\u7a0b\u6c60\u5408\u9002\uff1f"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4e00\u822c\u6765\u8bf4\u6c60\u4e2d",(0,r.jsx)(e.strong,{children:"\u603b\u7ebf\u7a0b\u6570\u662f\u6838\u5fc3\u6c60\u7ebf\u7a0b\u6570\u91cf\u4e24\u500d"}),"\uff0c\u786e\u4fdd\u5f53\u6838\u5fc3\u6c60\u6709\u7ebf\u7a0b\u505c\u6b62\u65f6\uff0c\u6838\u5fc3\u6c60\u5916\u6709\u7ebf\u7a0b\u8fdb\u5165\u6838\u5fc3\u6c60"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fc7\u5c0f\u4f1a\u5bfc\u81f4\u7a0b\u5e8f\u4e0d\u80fd\u5145\u5206\u5730\u5229\u7528\u7cfb\u7edf\u8d44\u6e90\u3001\u5bb9\u6613\u5bfc\u81f4\u9965\u997f"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fc7\u5927\u4f1a\u5bfc\u81f4\u66f4\u591a\u7684\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u5360\u7528\u66f4\u591a\u5185\u5b58"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0a\u4e0b\u6587\u5207\u6362\uff1a\u5f53\u524d\u4efb\u52a1\u5728\u6267\u884c\u5b8c CPU \u65f6\u95f4\u7247\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u4efb\u52a1\u4e4b\u524d\u4f1a\u5148\u4fdd\u5b58\u81ea\u5df1\u7684\u72b6\u6001\uff0c\u4ee5\u4fbf\u4e0b\u6b21\u518d\u5207\u6362\u56de\u8fd9\u4e2a\u4efb\u52a1\u65f6\uff0c\u53ef\u4ee5\u518d\u52a0\u8f7d\u8fd9\u4e2a\u4efb\u52a1\u7684\u72b6\u6001\uff0c\u4efb\u52a1\u4ece\u4fdd\u5b58\u5230\u518d\u52a0\u8f7d\u7684\u8fc7\u7a0b\u5c31\u662f\u4e00\u6b21\u4e0a\u4e0b\u6587\u5207\u6362"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6838\u5fc3\u7ebf\u7a0b\u6570\u5e38\u7528\u516c\u5f0f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"CPU \u5bc6\u96c6\u578b\u4efb\u52a1 (N+1)\uff1a"})," \u8fd9\u79cd\u4efb\u52a1\u6d88\u8017\u7684\u662f CPU \u8d44\u6e90\uff0c\u53ef\u4ee5\u5c06\u6838\u5fc3\u7ebf\u7a0b\u6570\u8bbe\u7f6e\u4e3a N (CPU \u6838\u5fc3\u6570) + 1\uff0c\u6bd4 CPU \u6838\u5fc3\u6570\u591a\u51fa\u6765\u7684\u4e00\u4e2a\u7ebf\u7a0b\u662f\u4e3a\u4e86\u9632\u6b62\u7ebf\u7a0b\u53d1\u751f\u7f3a\u9875\u4e2d\u65ad\uff0c\u6216\u8005\u5176\u5b83\u539f\u56e0\u5bfc\u81f4\u7684\u4efb\u52a1\u6682\u505c\u800c\u5e26\u6765\u7684\u5f71\u54cd\u3002\u4e00\u65e6\u4efb\u52a1\u6682\u505c\uff0cCPU \u67d0\u4e2a\u6838\u5fc3\u5c31\u4f1a\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u800c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u591a\u51fa\u6765\u7684\u4e00\u4e2a\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u5145\u5206\u5229\u7528 CPU \u7684\u7a7a\u95f2\u65f6\u95f4"]}),"\n",(0,r.jsx)(e.p,{children:"CPU \u5bc6\u96c6\u578b\u7b80\u5355\u7406\u89e3\u5c31\u662f\u5229\u7528 CPU \u8ba1\u7b97\u80fd\u529b\u7684\u4efb\u52a1\u6bd4\u5982\u5728\u5185\u5b58\u4e2d\u5bf9\u5927\u91cf\u6570\u636e\u8fdb\u884c\u5206\u6790"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"I/O \u5bc6\u96c6\u578b\u4efb\u52a1\uff1a"})," \u8fd9\u79cd\u7cfb\u7edf CPU \u5904\u4e8e\u963b\u585e\u72b6\u6001\uff0c\u7528\u5927\u90e8\u5206\u7684\u65f6\u95f4\u6765\u5904\u7406 I/O \u4ea4\u4e92\uff0c\u800c\u7ebf\u7a0b\u5728\u5904\u7406 I/O \u7684\u65f6\u95f4\u6bb5\u5185\u4e0d\u4f1a\u5360\u7528 CPU \u6765\u5904\u7406\uff0c\u8fd9\u65f6\u5c31\u53ef\u4ee5\u5c06 CPU \u4ea4\u51fa\u7ed9\u5176\u5b83\u7ebf\u7a0b\u4f7f\u7528\uff0c\u56e0\u6b64\u5728 I/O \u5bc6\u96c6\u578b\u4efb\u52a1\u7684\u5e94\u7528\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u591a\u914d\u7f6e\u4e00\u4e9b\u7ebf\u7a0b\uff0c\u5177\u4f53\u7684\u8ba1\u7b97\u65b9\u6cd5\u662f 2N \u6216 CPU \u6838\u6570/ (1-\u963b\u585e\u7cfb\u6570)\uff0c\u963b\u585e\u7cfb\u6570\u5728 0.8~0.9 \u4e4b\u95f4"]}),"\n",(0,r.jsx)(e.p,{children:"IO \u5bc6\u96c6\u578b\u5c31\u662f\u6d89\u53ca\u5230\u7f51\u7edc\u8bfb\u53d6\uff0c\u6587\u4ef6\u8bfb\u53d6\u6b64\u7c7b\u4efb\u52a1 \uff0c\u7279\u70b9\u662f CPU \u8ba1\u7b97\u8017\u8d39\u65f6\u95f4\u76f8\u6bd4\u4e8e\u7b49\u5f85 IO \u64cd\u4f5c\u5b8c\u6210\u7684\u65f6\u95f4\u6765\u8bf4\u5f88\u5c11\uff0c\u5927\u90e8\u5206\u65f6\u95f4\u90fd\u82b1\u5728\u4e86\u7b49\u5f85 IO \u64cd\u4f5c\u5b8c\u6210\u4e0a"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u63d0\u4ea4\u65b9\u6cd5",children:"\u63d0\u4ea4\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"ExecutorService \u7c7b API\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"void execute(Runnable command)"}),(0,r.jsx)(e.td,{children:"\u6267\u884c\u4efb\u52a1\uff08Executor \u7c7b API\uff09"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Future<?> submit(Runnable task)"}),(0,r.jsx)(e.td,{children:"\u63d0\u4ea4\u4efb\u52a1 task()"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsxs)(e.td,{children:["Future submit(Callable",(0,r.jsx)(e.t,{children:" task)"})]}),(0,r.jsx)(e.td,{children:"\u63d0\u4ea4\u4efb\u52a1 task\uff0c\u7528\u8fd4\u56de\u503c Future \u83b7\u5f97\u4efb\u52a1\u6267\u884c\u7ed3\u679c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsxs)(e.td,{children:["List<Future",(0,r.jsxs)(e.t,{children:["> invokeAll(Collection<? extends Callable",(0,r.jsx)(e.t,{children:"> tasks)"})]})]}),(0,r.jsx)(e.td,{children:"\u63d0\u4ea4 tasks \u4e2d\u6240\u6709\u4efb\u52a1"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsxs)(e.td,{children:["List<Future",(0,r.jsxs)(e.t,{children:["> invokeAll(Collection<? extends Callable",(0,r.jsx)(e.t,{children:"> tasks, long timeout, TimeUnit unit)"})]})]}),(0,r.jsx)(e.td,{children:"\u63d0\u4ea4 tasks \u4e2d\u6240\u6709\u4efb\u52a1\uff0c\u8d85\u65f6\u65f6\u95f4\u9488\u5bf9\u6240\u6709task\uff0c\u8d85\u65f6\u4f1a\u53d6\u6d88\u6ca1\u6709\u6267\u884c\u5b8c\u7684\u4efb\u52a1\uff0c\u5e76\u629b\u51fa\u8d85\u65f6\u5f02\u5e38"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsxs)(e.td,{children:["T invokeAny(Collection<? extends Callable",(0,r.jsx)(e.t,{children:"> tasks)"})]}),(0,r.jsx)(e.td,{children:"\u63d0\u4ea4 tasks \u4e2d\u6240\u6709\u4efb\u52a1\uff0c\u54ea\u4e2a\u4efb\u52a1\u5148\u6210\u529f\u6267\u884c\u5b8c\u6bd5\uff0c\u8fd4\u56de\u6b64\u4efb\u52a1\u6267\u884c\u7ed3\u679c\uff0c\u5176\u5b83\u4efb\u52a1\u53d6\u6d88"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:"execute \u548c submit \u90fd\u5c5e\u4e8e\u7ebf\u7a0b\u6c60\u7684\u65b9\u6cd5\uff0c\u5bf9\u6bd4\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["execute \u53ea\u80fd\u6267\u884c Runnable \u7c7b\u578b\u7684\u4efb\u52a1\uff0c\u6ca1\u6709\u8fd4\u56de\u503c\uff1b submit \u65e2\u80fd\u63d0\u4ea4 Runnable \u7c7b\u578b\u4efb\u52a1\u4e5f\u80fd\u63d0\u4ea4 Callable \u7c7b\u578b\u4efb\u52a1\uff0c\u5e95\u5c42\u662f",(0,r.jsx)(e.strong,{children:"\u5c01\u88c5\u6210 FutureTask\uff0c\u7136\u540e\u8c03\u7528 execute \u6267\u884c"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"execute \u4f1a\u76f4\u63a5\u629b\u51fa\u4efb\u52a1\u6267\u884c\u65f6\u7684\u5f02\u5e38\uff0csubmit \u4f1a\u541e\u6389\u5f02\u5e38\uff0c\u53ef\u901a\u8fc7 Future \u7684 get \u65b9\u6cd5\u5c06\u4efb\u52a1\u6267\u884c\u65f6\u7684\u5f02\u5e38\u91cd\u65b0\u629b\u51fa"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5173\u95ed\u65b9\u6cd5",children:"\u5173\u95ed\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"ExecutorService \u7c7b API\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"void shutdown()"}),(0,r.jsx)(e.td,{children:"\u7ebf\u7a0b\u6c60\u72b6\u6001\u53d8\u4e3a SHUTDOWN\uff0c\u7b49\u5f85\u4efb\u52a1\u6267\u884c\u5b8c\u540e\u5173\u95ed\u7ebf\u7a0b\u6c60\uff0c\u4e0d\u4f1a\u63a5\u6536\u65b0\u4efb\u52a1\uff0c\u4f46\u5df2\u63d0\u4ea4\u4efb\u52a1\u4f1a\u6267\u884c\u5b8c\uff0c\u800c\u4e14\u4e5f\u53ef\u4ee5\u6dfb\u52a0\u7ebf\u7a0b\uff08\u4e0d\u7ed1\u5b9a\u4efb\u52a1\uff09"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsxs)(e.td,{children:["List",(0,r.jsx)(e.runnable,{children:" shutdownNow()"})]}),(0,r.jsx)(e.td,{children:"\u7ebf\u7a0b\u6c60\u72b6\u6001\u53d8\u4e3a STOP\uff0c\u7528 interrupt \u4e2d\u65ad\u6b63\u5728\u6267\u884c\u7684\u4efb\u52a1\uff0c\u76f4\u63a5\u5173\u95ed\u7ebf\u7a0b\u6c60\uff0c\u4e0d\u4f1a\u63a5\u6536\u65b0\u4efb\u52a1\uff0c\u4f1a\u5c06\u961f\u5217\u4e2d\u7684\u4efb\u52a1\u8fd4\u56de"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"boolean isShutdown()"}),(0,r.jsx)(e.td,{children:"\u4e0d\u5728 RUNNING \u72b6\u6001\u7684\u7ebf\u7a0b\u6c60\uff0c\u6b64\u6267\u884c\u8005\u5df2\u88ab\u5173\u95ed\uff0c\u65b9\u6cd5\u8fd4\u56de true"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"boolean isTerminated()"}),(0,r.jsx)(e.td,{children:"\u7ebf\u7a0b\u6c60\u72b6\u6001\u662f\u5426\u662f TERMINATED\uff0c\u5982\u679c\u6240\u6709\u4efb\u52a1\u5728\u5173\u95ed\u540e\u5b8c\u6210\uff0c\u8fd4\u56de true"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"boolean awaitTermination(long timeout, TimeUnit unit)"}),(0,r.jsx)(e.td,{children:"\u8c03\u7528 shutdown \u540e\uff0c\u7531\u4e8e\u8c03\u7528\u7ebf\u7a0b\u4e0d\u4f1a\u7b49\u5f85\u6240\u6709\u4efb\u52a1\u8fd0\u884c\u7ed3\u675f\uff0c\u5982\u679c\u5b83\u60f3\u5728\u7ebf\u7a0b\u6c60 TERMINATED \u540e\u505a\u4e9b\u4e8b\u60c5\uff0c\u53ef\u4ee5\u5229\u7528\u6b64\u65b9\u6cd5\u7b49\u5f85"})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5904\u7406\u5f02\u5e38",children:"\u5904\u7406\u5f02\u5e38"}),"\n",(0,r.jsx)(e.p,{children:"execute \u4f1a\u76f4\u63a5\u629b\u51fa\u4efb\u52a1\u6267\u884c\u65f6\u7684\u5f02\u5e38\uff0csubmit \u4f1a\u541e\u6389\u5f02\u5e38\uff0c\u6709\u4e24\u79cd\u5904\u7406\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u65b9\u6cd5 1\uff1a\u4e3b\u52a8\u6349\u5f02\u5e38"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'ExecutorService executorService = Executors.newFixedThreadPool(1);\npool.submit(() -> {\n    try {\n        System.out.println("task1");\n        int i = 1 / 0;\n    } catch (Exception e) {\n        e.printStackTrace();\n    }\n});\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u65b9\u6cd5 2\uff1a\u4f7f\u7528 Future \u5bf9\u8c61"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'ExecutorService executorService = Executors.newFixedThreadPool(1);\nFuture<?> future = pool.submit(() -> {\n    System.out.println("task1");\n    int i = 1 / 0;\n    return true;\n});\nSystem.out.println(future.get());\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u5de5\u4f5c\u539f\u7406",children:"\u5de5\u4f5c\u539f\u7406"}),"\n",(0,r.jsx)(e.h4,{id:"\u72b6\u6001\u4fe1\u606f",children:"\u72b6\u6001\u4fe1\u606f"}),"\n",(0,r.jsxs)(e.p,{children:["ThreadPoolExecutor \u4f7f\u7528 int \u7684",(0,r.jsx)(e.strong,{children:"\u9ad8 3 \u4f4d\u6765\u8868\u793a\u7ebf\u7a0b\u6c60\u72b6\u6001\uff0c\u4f4e 29 \u4f4d\u8868\u793a\u7ebf\u7a0b\u6570\u91cf"}),"\u3002\u8fd9\u4e9b\u4fe1\u606f\u5b58\u50a8\u5728\u4e00\u4e2a\u539f\u5b50\u53d8\u91cf ctl \u4e2d\uff0c\u76ee\u7684\u662f\u5c06\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e0e\u7ebf\u7a0b\u4e2a\u6570\u5408\u4e8c\u4e3a\u4e00\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7528\u4e00\u6b21 CAS \u539f\u5b50\u64cd\u4f5c\u8fdb\u884c\u8d4b\u503c"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u72b6\u6001\u8868\u793a\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u9ad83\u4f4d\uff1a\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u6c60\u8fd0\u884c\u72b6\u6001\uff0c\u9664\u53bb\u9ad83\u4f4d\u4e4b\u540e\u7684\u4f4e\u4f4d\uff1a\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u6c60\u4e2d\u6240\u62e5\u6709\u7684\u7ebf\u7a0b\u6570\u91cf\nprivate final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\n// \u8868\u793a\u5728 ctl \u4e2d\uff0c\u4f4e COUNT_BITS \u4f4d\uff0c\u662f\u7528\u4e8e\u5b58\u653e\u5f53\u524d\u7ebf\u7a0b\u6570\u91cf\u7684\u4f4d\nprivate static final int COUNT_BITS = Integer.SIZE - 3;\n// \u4f4e COUNT_BITS \u4f4d\u6240\u80fd\u8868\u8fbe\u7684\u6700\u5927\u6570\u503c\uff0c000 11111111111111111111 => 5\u4ebf\u591a\nprivate static final int CAPACITY   = (1 << COUNT_BITS) - 1;\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(12180).A+"",width:"952",height:"329"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u56db\u79cd\u72b6\u6001\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// 111 000000000000000000\uff0c\u8f6c\u6362\u6210\u6574\u6570\u540e\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u3010\u8d1f\u6570\u3011\nprivate static final int RUNNING    = -1 << COUNT_BITS;\n// 000 000000000000000000\nprivate static final int SHUTDOWN   =  0 << COUNT_BITS;\n// 001 000000000000000000\nprivate static final int STOP       =  1 << COUNT_BITS;\n// 010 000000000000000000\nprivate static final int TIDYING    =  2 << COUNT_BITS;\n// 011 000000000000000000\nprivate static final int TERMINATED =  3 << COUNT_BITS;\n"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u72b6\u6001"}),(0,r.jsx)(e.th,{children:"\u9ad83\u4f4d"}),(0,r.jsx)(e.th,{children:"\u63a5\u6536\u65b0\u4efb\u52a1"}),(0,r.jsx)(e.th,{children:"\u5904\u7406\u963b\u585e\u4efb\u52a1\u961f\u5217"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"RUNNING"}),(0,r.jsx)(e.td,{children:"111"}),(0,r.jsx)(e.td,{children:"Y"}),(0,r.jsx)(e.td,{children:"Y"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"SHUTDOWN"}),(0,r.jsx)(e.td,{children:"000"}),(0,r.jsx)(e.td,{children:"N"}),(0,r.jsx)(e.td,{children:"Y"}),(0,r.jsx)(e.td,{children:"\u4e0d\u63a5\u6536\u65b0\u4efb\u52a1\uff0c\u4f46\u5904\u7406\u963b\u585e\u961f\u5217\u5269\u4f59\u4efb\u52a1"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"STOP"}),(0,r.jsx)(e.td,{children:"001"}),(0,r.jsx)(e.td,{children:"N"}),(0,r.jsx)(e.td,{children:"N"}),(0,r.jsx)(e.td,{children:"\u4e2d\u65ad\u6b63\u5728\u6267\u884c\u7684\u4efb\u52a1\uff0c\u5e76\u629b\u5f03\u963b\u585e\u961f\u5217\u4efb\u52a1"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"TIDYING"}),(0,r.jsx)(e.td,{children:"010"}),(0,r.jsx)(e.td,{children:"-"}),(0,r.jsx)(e.td,{children:"-"}),(0,r.jsx)(e.td,{children:"\u4efb\u52a1\u5168\u6267\u884c\u5b8c\u6bd5\uff0c\u6d3b\u52a8\u7ebf\u7a0b\u4e3a 0 \u5373\u5c06\u8fdb\u5165\u7ec8\u7ed3"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"TERMINATED"}),(0,r.jsx)(e.td,{children:"011"}),(0,r.jsx)(e.td,{children:"-"}),(0,r.jsx)(e.td,{children:"-"}),(0,r.jsx)(e.td,{children:"\u7ec8\u6b62\u72b6\u6001"})]})]})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u6c60\u8fd0\u884c\u72b6\u6001\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// ~CAPACITY = ~000 11111111111111111111 = 111 000000000000000000000\uff08\u53d6\u53cd\uff09\n// c == ctl = 111 000000000000000000111\n// 111 000000000000000000111\n// 111 000000000000000000000\n// 111 000000000000000000000\t\u83b7\u53d6\u5230\u4e86\u8fd0\u884c\u72b6\u6001\nprivate static int runStateOf(int c)     { return c & ~CAPACITY; }\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u6c60\u7ebf\u7a0b\u6570\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"//        c = 111 000000000000000000111\n// CAPACITY = 000 111111111111111111111\n//            000 000000000000000000111 => 7\nprivate static int workerCountOf(int c)  { return c & CAPACITY; }\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u91cd\u7f6e\u5f53\u524d\u7ebf\u7a0b\u6c60\u72b6\u6001 ctl\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// rs \u8868\u793a\u7ebf\u7a0b\u6c60\u72b6\u6001\uff0cwc \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u6c60\u4e2d worker\uff08\u7ebf\u7a0b\uff09\u6570\u91cf\uff0c\u76f8\u4e0e\u4ee5\u540e\u5c31\u662f\u5408\u5e76\u540e\u7684\u72b6\u6001\nprivate static int ctlOf(int rs, int wc) { return rs | wc; }\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6bd4\u8f83\u5f53\u524d\u7ebf\u7a0b\u6c60 ctl \u6240\u8868\u793a\u7684\u72b6\u6001\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u6bd4\u8f83\u5f53\u524d\u7ebf\u7a0b\u6c60 ctl \u6240\u8868\u793a\u7684\u72b6\u6001\uff0c\u662f\u5426\u5c0f\u4e8e\u67d0\u4e2a\u72b6\u6001 s\n// \u72b6\u6001\u5bf9\u6bd4\uff1aRUNNING < SHUTDOWN < STOP < TIDYING < TERMINATED\nprivate static boolean runStateLessThan(int c, int s) { return c < s; }\n// \u6bd4\u8f83\u5f53\u524d\u7ebf\u7a0b\u6c60 ctl \u6240\u8868\u793a\u7684\u72b6\u6001\uff0c\u662f\u5426\u5927\u4e8e\u7b49\u4e8e\u67d0\u4e2a\u72b6\u6001s\nprivate static boolean runStateAtLeast(int c, int s) { return c >= s; }\n// \u5c0f\u4e8e SHUTDOWN \u7684\u4e00\u5b9a\u662f RUNNING\uff0cSHUTDOWN == 0\nprivate static boolean isRunning(int c) { return c < SHUTDOWN; }\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bbe\u7f6e\u7ebf\u7a0b\u6c60 ctl\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u4f7f\u7528 CAS \u65b9\u5f0f \u8ba9 ctl \u503c +1 \uff0c\u6210\u529f\u8fd4\u56de true, \u5931\u8d25\u8fd4\u56de false\nprivate boolean compareAndIncrementWorkerCount(int expect) {\n    return ctl.compareAndSet(expect, expect + 1);\n}\n// \u4f7f\u7528 CAS \u65b9\u5f0f \u8ba9 ctl \u503c -1 \uff0c\u6210\u529f\u8fd4\u56de true, \u5931\u8d25\u8fd4\u56de false\nprivate boolean compareAndDecrementWorkerCount(int expect) {\n    return ctl.compareAndSet(expect, expect - 1);\n}\n// \u5c06 ctl \u503c\u51cf\u4e00\uff0cdo while \u5faa\u73af\u4f1a\u4e00\u76f4\u91cd\u8bd5\uff0c\u76f4\u5230\u6210\u529f\u4e3a\u6b62\nprivate void decrementWorkerCount() {\n    do {} while (!compareAndDecrementWorkerCount(ctl.get()));\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u5c5e\u6027-2",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u6c60\u4e2d\u5b58\u653e Worker \u7684\u5bb9\u5668"}),"\uff1a\u7ebf\u7a0b\u6c60\u6ca1\u6709\u521d\u59cb\u5316\uff0c\u76f4\u63a5\u5f80\u6c60\u4e2d\u52a0\u7ebf\u7a0b\u5373\u53ef"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final HashSet<Worker> workers = new HashSet<Worker>();\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u5168\u5c40\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u589e\u52a0\u51cf\u5c11 worker \u6216\u8005\u65f6\u4fee\u6539\u7ebf\u7a0b\u6c60\u8fd0\u884c\u72b6\u6001\u9700\u8981\u6301\u6709 mainLock\nprivate final ReentrantLock mainLock = new ReentrantLock();\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u53ef\u91cd\u5165\u9501\u7684\u6761\u4ef6\u53d8\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5f53\u5916\u90e8\u7ebf\u7a0b\u8c03\u7528 awaitTermination() \u65b9\u6cd5\u65f6\uff0c\u4f1a\u7b49\u5f85\u5f53\u524d\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3a Termination \u4e3a\u6b62\nprivate final Condition termination = mainLock.newCondition()\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u6c60\u76f8\u5173\u53c2\u6570\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private volatile int corePoolSize;\t\t\t\t// \u6838\u5fc3\u7ebf\u7a0b\u6570\u91cf\nprivate volatile int maximumPoolSize;\t\t\t// \u7ebf\u7a0b\u6c60\u6700\u5927\u7ebf\u7a0b\u6570\u91cf\nprivate volatile long keepAliveTime;\t\t\t// \u7a7a\u95f2\u7ebf\u7a0b\u5b58\u6d3b\u65f6\u95f4\nprivate volatile ThreadFactory threadFactory;\t// \u521b\u5efa\u7ebf\u7a0b\u65f6\u4f7f\u7528\u7684\u7ebf\u7a0b\u5de5\u5382\uff0c\u9ed8\u8ba4\u662f DefaultThreadFactory\nprivate final BlockingQueue<Runnable> workQueue;// \u3010\u8d85\u8fc7\u6838\u5fc3\u7ebf\u7a0b\u63d0\u4ea4\u4efb\u52a1\u5c31\u653e\u5165 \u963b\u585e\u961f\u5217\u3011\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private volatile RejectedExecutionHandler handler;\t// \u62d2\u7edd\u7b56\u7565\uff0cjuc\u5305\u63d0\u4f9b\u4e864\u4e2d\u65b9\u5f0f\nprivate static final RejectedExecutionHandler defaultHandler = new AbortPolicy();// \u9ed8\u8ba4\u7b56\u7565\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bb0\u5f55\u7ebf\u7a0b\u6c60\u76f8\u5173\u5c5e\u6027\u7684\u6570\u503c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private int largestPoolSize;\t\t// \u8bb0\u5f55\u7ebf\u7a0b\u6c60\u751f\u547d\u5468\u671f\u5185\u7ebf\u7a0b\u6570\u6700\u5927\u503c\nprivate long completedTaskCount;\t// \u8bb0\u5f55\u7ebf\u7a0b\u6c60\u6240\u5b8c\u6210\u4efb\u52a1\u603b\u6570\uff0c\u5f53\u67d0\u4e2a worker \u9000\u51fa\u65f6\u5c06\u5b8c\u6210\u7684\u4efb\u52a1\u7d2f\u52a0\u5230\u8be5\u5c5e\u6027\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u63a7\u5236",(0,r.jsx)(e.strong,{children:"\u6838\u5fc3\u7ebf\u7a0b\u6570\u91cf\u5185\u7684\u7ebf\u7a0b\u662f\u5426\u53ef\u4ee5\u88ab\u56de\u6536"}),"\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// false\uff08\u9ed8\u8ba4\uff09\u4ee3\u8868\u4e0d\u53ef\u4ee5\uff0c\u4e3a true \u65f6\u6838\u5fc3\u7ebf\u7a0b\u7a7a\u95f2\u8d85\u8fc7 keepAliveTime \u4e5f\u4f1a\u88ab\u56de\u6536\n// allowCoreThreadTimeOut(boolean value) \u65b9\u6cd5\u53ef\u4ee5\u8bbe\u7f6e\u8be5\u503c\nprivate volatile boolean allowCoreThreadTimeOut;\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5185\u90e8\u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Worker \u7c7b\uff1a",(0,r.jsx)(e.strong,{children:"\u6bcf\u4e2a Worker \u5bf9\u8c61\u4f1a\u7ed1\u5b9a\u4e00\u4e2a\u521d\u59cb\u4efb\u52a1"}),"\uff0c\u542f\u52a8 Worker \u65f6\u4f18\u5148\u6267\u884c\uff0c\u8fd9\u4e5f\u662f\u9020\u6210\u7ebf\u7a0b\u6c60\u4e0d\u516c\u5e73\u7684\u539f\u56e0\u3002Worker \u7ee7\u627f\u81ea AQS\uff0c\u672c\u8eab\u5177\u6709\u9501\u7684\u7279\u6027\uff0c\u91c7\u7528\u72ec\u5360\u9501\u6a21\u5f0f\uff0cstate = 0 \u8868\u793a\u672a\u88ab\u5360\u7528\uff0c> 0 \u8868\u793a\u88ab\u5360\u7528\uff0c< 0 \u8868\u793a\u521d\u59cb\u72b6\u6001\u4e0d\u80fd\u88ab\u62a2\u9501"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final class Worker extends AbstractQueuedSynchronizer implements Runnable {\n\tfinal Thread thread;\t\t\t// worker \u5185\u90e8\u5c01\u88c5\u7684\u5de5\u4f5c\u7ebf\u7a0b\n    Runnable firstTask;\t\t\t\t// worker \u7b2c\u4e00\u4e2a\u6267\u884c\u7684\u4efb\u52a1\uff0c\u666e\u901a\u7684 Runnable \u5b9e\u73b0\u7c7b\u6216\u8005\u662f FutureTask\n    volatile long completedTasks;\t// \u8bb0\u5f55\u5f53\u524d worker \u6240\u5b8c\u6210\u4efb\u52a1\u6570\u91cf\n    \n    // \u6784\u9020\u65b9\u6cd5\n    Worker(Runnable firstTask) {\n        // \u8bbe\u7f6eAQS\u72ec\u5360\u6a21\u5f0f\u4e3a\u521d\u59cb\u5316\u4e2d\u72b6\u6001\uff0c\u8fd9\u4e2a\u72b6\u6001\u4e0d\u80fd\u88ab\u62a2\u5360\u9501\n       \tsetState(-1);\n        // firstTask\u4e0d\u4e3a\u7a7a\u65f6\uff0c\u5f53worker\u542f\u52a8\u540e\uff0c\u5185\u90e8\u7ebf\u7a0b\u4f1a\u4f18\u5148\u6267\u884cfirstTask\uff0c\u6267\u884c\u5b8c\u540e\u4f1a\u5230queue\u4e2d\u53bb\u83b7\u53d6\u4e0b\u4e2a\u4efb\u52a1\n        this.firstTask = firstTask;\n        // \u4f7f\u7528\u7ebf\u7a0b\u5de5\u5382\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5e76\u4e14\u3010\u5c06\u5f53\u524dworker\u6307\u5b9a\u4e3aRunnable\u3011\uff0c\u6240\u4ee5thread\u542f\u52a8\u65f6\u4f1a\u8c03\u7528 worker.run()\n        this.thread = getThreadFactory().newThread(this);\n    }\n    // \u3010\u4e0d\u53ef\u91cd\u5165\u9501\u3011\n    protected boolean tryAcquire(int unused) {\n        if (compareAndSetState(0, 1)) {\n            setExclusiveOwnerThread(Thread.currentThread());\n            return true;\n        }\n        return false;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public Thread newThread(Runnable r) {\n    // \u5c06\u5f53\u524d worker \u6307\u5b9a\u4e3a thread \u7684\u6267\u884c\u65b9\u6cd5\uff0c\u7ebf\u7a0b\u8c03\u7528 start \u4f1a\u8c03\u7528 r.run()\n    Thread t = new Thread(group, r, namePrefix + threadNumber.getAndIncrement(), 0);\n    if (t.isDaemon())\n        t.setDaemon(false);\n    if (t.getPriority() != Thread.NORM_PRIORITY)\n        t.setPriority(Thread.NORM_PRIORITY);\n    return t;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u62d2\u7edd\u7b56\u7565\u76f8\u5173\u7684\u5185\u90e8\u7c7b"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u65b9\u6cd5-2",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.h5,{id:"\u63d0\u4ea4\u65b9\u6cd5-1",children:"\u63d0\u4ea4\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["AbstractExecutorService#submit()\uff1a\u63d0\u4ea4\u4efb\u52a1\uff0c",(0,r.jsx)(e.strong,{children:"\u628a Runnable \u6216 Callable \u4efb\u52a1\u5c01\u88c5\u6210 FutureTask \u6267\u884c"}),"\uff0c\u53ef\u4ee5\u901a\u8fc7\u65b9\u6cd5\u8fd4\u56de\u7684\u4efb\u52a1\u5bf9\u8c61\uff0c\u8c03\u7528 get \u963b\u585e\u83b7\u53d6\u4efb\u52a1\u6267\u884c\u7684\u7ed3\u679c\u6216\u8005\u5f02\u5e38\uff0c\u6e90\u7801\u5206\u6790\u5728\u7b14\u8bb0\u7684 Future \u90e8\u5206"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public Future<?> submit(Runnable task) {\n    // \u7a7a\u6307\u9488\u5f02\u5e38\n    if (task == null) throw new NullPointerException();\n    // \u628a Runnable \u5c01\u88c5\u6210\u672a\u6765\u4efb\u52a1\u5bf9\u8c61\uff0c\u6267\u884c\u7ed3\u679c\u5c31\u662f null\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570\u6307\u5b9a FutureTask#get \u8fd4\u56de\u6570\u636e\n    RunnableFuture<Void> ftask = newTaskFor(task, null);\n    // \u6267\u884c\u65b9\u6cd5\n    execute(ftask);\n    return ftask;\n}\npublic <T> Future<T> submit(Callable<T> task) {\n    if (task == null) throw new NullPointerException();\n    // \u628a Callable \u5c01\u88c5\u6210\u672a\u6765\u4efb\u52a1\u5bf9\u8c61\n    RunnableFuture<T> ftask = newTaskFor(task);\n    // \u6267\u884c\u65b9\u6cd5\n    execute(ftask);\t\n    // \u8fd4\u56de\u672a\u6765\u4efb\u52a1\u5bf9\u8c61\uff0c\u7528\u6765\u83b7\u53d6\u8fd4\u56de\u503c\n    return ftask;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected <T> RunnableFuture<T> newTaskFor(Runnable runnable, T value) {\n    // Runnable \u5c01\u88c5\u6210 FutureTask\uff0c\u3010\u6307\u5b9a\u8fd4\u56de\u503c\u3011\n    return new FutureTask<T>(runnable, value);\n}\nprotected <T> RunnableFuture<T> newTaskFor(Callable<T> callable) {\n    // Callable \u76f4\u63a5\u5c01\u88c5\u6210 FutureTask\n    return new FutureTask<T>(callable);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["execute()\uff1a\u6267\u884c\u4efb\u52a1\uff0c",(0,r.jsx)(e.strong,{children:"\u4f46\u662f\u6ca1\u6709\u8fd4\u56de\u503c\uff0c\u6ca1\u529e\u6cd5\u83b7\u53d6\u4efb\u52a1\u6267\u884c\u7ed3\u679c"}),"\uff0c\u51fa\u73b0\u5f02\u5e38\u4f1a\u76f4\u63a5\u629b\u51fa\u4efb\u52a1\u6267\u884c\u65f6\u7684\u5f02\u5e38\u3002\u6839\u636e\u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\uff0c\u9009\u62e9\u6dfb\u52a0\u4efb\u52a1\u65f6\u7684\u5904\u7406\u65b9\u5f0f"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// command \u53ef\u4ee5\u662f\u666e\u901a\u7684 Runnable \u5b9e\u73b0\u7c7b\uff0c\u4e5f\u53ef\u4ee5\u662f FutureTask\uff0c\u4e0d\u80fd\u662f Callable\npublic void execute(Runnable command) {\n    // \u975e\u7a7a\u5224\u65ad\n    if (command == null)\n        throw new NullPointerException();\n  \t// \u83b7\u53d6 ctl \u6700\u65b0\u503c\u8d4b\u503c\u7ed9 c\uff0cctl \u9ad8 3 \u4f4d\u8868\u793a\u7ebf\u7a0b\u6c60\u72b6\u6001\uff0c\u4f4e\u4f4d\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u6c60\u7ebf\u7a0b\u6570\u91cf\u3002\n    int c = ctl.get();\n    // \u30101\u3011\u5f53\u524d\u7ebf\u7a0b\u6570\u91cf\u5c0f\u4e8e\u6838\u5fc3\u7ebf\u7a0b\u6570\uff0c\u6b64\u6b21\u63d0\u4ea4\u4efb\u52a1\u76f4\u63a5\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 worker\uff0c\u7ebf\u7a0b\u6c60\u4e2d\u591a\u4e86\u4e00\u4e2a\u65b0\u7684\u7ebf\u7a0b\n    if (workerCountOf(c) < corePoolSize) {\n        // addWorker \u4e3a\u521b\u5efa\u7ebf\u7a0b\u7684\u8fc7\u7a0b\uff0c\u4f1a\u521b\u5efa worker \u5bf9\u8c61\u5e76\u4e14\u5c06 command \u4f5c\u4e3a firstTask\uff0c\u4f18\u5148\u6267\u884c\n        if (addWorker(command, true))\n            return;\n        \n        // \u6267\u884c\u5230\u8fd9\u6761\u8bed\u53e5\uff0c\u8bf4\u660e addWorker \u4e00\u5b9a\u662f\u5931\u8d25\u7684\uff0c\u5b58\u5728\u5e76\u53d1\u73b0\u8c61\u6216\u8005\u7ebf\u7a0b\u6c60\u72b6\u6001\u88ab\u6539\u53d8\uff0c\u91cd\u65b0\u83b7\u53d6\u72b6\u6001\n        // SHUTDOWN \u72b6\u6001\u4e0b\u4e5f\u6709\u53ef\u80fd\u521b\u5efa\u6210\u529f\uff0c\u524d\u63d0 firstTask == null \u800c\u4e14\u5f53\u524d queue \u4e0d\u4e3a\u7a7a\uff08\u7279\u6b8a\u60c5\u51b5\uff09\n        c = ctl.get();\n    }\n    // \u30102\u3011\u6267\u884c\u5230\u8fd9\u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u6570\u91cf\u5df2\u7ecf\u8fbe\u5230\u6838\u5fc3\u7ebf\u7a0b\u6570\u91cf \u6216\u8005 addWorker \u5931\u8d25\n    // \t\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u6c60\u662f\u5426\u5904\u4e8erunning\u72b6\u6001\uff0c\u6210\u7acb\u5c31\u5c1d\u8bd5\u5c06 task \u653e\u5165\u5230 workQueue \u4e2d\n    if (isRunning(c) && workQueue.offer(command)) {\n        int recheck = ctl.get();\n        // \u6761\u4ef6\u4e00\u6210\u7acb\u8bf4\u660e\u7ebf\u7a0b\u6c60\u72b6\u6001\u88ab\u5916\u90e8\u7ebf\u7a0b\u7ed9\u4fee\u6539\u4e86\uff0c\u53ef\u80fd\u662f\u6267\u884c\u4e86 shutdown() \u65b9\u6cd5\uff0c\u8be5\u72b6\u6001\u4e0d\u80fd\u63a5\u6536\u65b0\u63d0\u4ea4\u7684\u4efb\u52a1\n        // \u6240\u4ee5\u8981\u628a\u521a\u63d0\u4ea4\u7684\u4efb\u52a1\u5220\u9664\uff0c\u5220\u9664\u6210\u529f\u8bf4\u660e\u63d0\u4ea4\u4e4b\u540e\u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u8fd8\u672a\u6d88\u8d39\uff08\u5904\u7406\uff09\u8be5\u4efb\u52a1\n        if (!isRunning(recheck) && remove(command))\n            // \u4efb\u52a1\u51fa\u961f\u6210\u529f\uff0c\u8d70\u62d2\u7edd\u7b56\u7565\n            reject(command);\n        // \u6267\u884c\u5230\u8fd9\u8bf4\u660e\u7ebf\u7a0b\u6c60\u662f running \u72b6\u6001\uff0c\u83b7\u53d6\u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\uff0c\u5224\u65ad\u662f\u5426\u662f 0\n        // \u3010\u62c5\u4fdd\u673a\u5236\u3011\uff0c\u4fdd\u8bc1\u7ebf\u7a0b\u6c60\u5728 running \u72b6\u6001\u4e0b\uff0c\u6700\u8d77\u7801\u5f97\u6709\u4e00\u4e2a\u7ebf\u7a0b\u5728\u5de5\u4f5c\n        else if (workerCountOf(recheck) == 0)\n            addWorker(null, false);\n    }\n    // \u30103\u3011offer\u5931\u8d25\u8bf4\u660equeue\u6ee1\u4e86\n    // \u5982\u679c\u7ebf\u7a0b\u6570\u91cf\u5c1a\u672a\u8fbe\u5230 maximumPoolSize\uff0c\u4f1a\u521b\u5efa\u975e\u6838\u5fc3 worker \u7ebf\u7a0b\u76f4\u63a5\u6267\u884c command\uff0c\u3010\u8fd9\u4e5f\u662f\u4e0d\u516c\u5e73\u7684\u539f\u56e0\u3011\n    // \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u6570\u91cf\u8fbe\u5230 maximumPoolSiz\uff0c\u8fd9\u91cc addWorker \u4e5f\u4f1a\u5931\u8d25\uff0c\u8d70\u62d2\u7edd\u7b56\u7565\n    else if (!addWorker(command, false))\n        reject(command);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6dfb\u52a0\u7ebf\u7a0b",children:"\u6dfb\u52a0\u7ebf\u7a0b"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["prestartAllCoreThreads()\uff1a",(0,r.jsx)(e.strong,{children:"\u63d0\u524d\u9884\u70ed"}),"\uff0c\u521b\u5efa\u6240\u6709\u7684\u6838\u5fc3\u7ebf\u7a0b"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public int prestartAllCoreThreads() {\n    int n = 0;\n    while (addWorker(null, true))\n        ++n;\n    return n;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["addWorker()\uff1a",(0,r.jsx)(e.strong,{children:"\u6dfb\u52a0\u7ebf\u7a0b\u5230\u7ebf\u7a0b\u6c60"}),"\uff0c\u8fd4\u56de true \u8868\u793a\u521b\u5efa Worker \u6210\u529f\uff0c\u4e14\u7ebf\u7a0b\u542f\u52a8\u3002\u9996\u5148\u5224\u65ad\u7ebf\u7a0b\u6c60\u662f\u5426\u5141\u8bb8\u6dfb\u52a0\u7ebf\u7a0b\uff0c\u5141\u8bb8\u5c31\u8ba9\u7ebf\u7a0b\u6570\u91cf + 1\uff0c\u7136\u540e\u53bb\u521b\u5efa Worker \u52a0\u5165\u7ebf\u7a0b\u6c60"]}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1aSHUTDOWN \u72b6\u6001\u4e5f\u80fd\u6dfb\u52a0\u7ebf\u7a0b\uff0c\u4f46\u662f\u8981\u6c42\u65b0\u52a0\u7684 Woker \u6ca1\u6709 firstTask\uff0c\u800c\u4e14\u5f53\u524d queue \u4e0d\u4e3a\u7a7a\uff0c\u6240\u4ee5\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5e2e\u52a9\u7ebf\u7a0b\u6c60\u6267\u884c\u961f\u5217\u4e2d\u7684\u4efb\u52a1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// core == true \u8868\u793a\u91c7\u7528\u6838\u5fc3\u7ebf\u7a0b\u6570\u91cf\u9650\u5236\uff0cfalse \u8868\u793a\u91c7\u7528 maximumPoolSize\nprivate boolean addWorker(Runnable firstTask, boolean core) {\n    // \u81ea\u65cb\u3010\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u6c60\u72b6\u6001\u662f\u5426\u5141\u8bb8\u521b\u5efa\u7ebf\u7a0b\u3011\uff0c\u5141\u8bb8\u5c31\u8bbe\u7f6e\u7ebf\u7a0b\u6570\u91cf + 1\n    retry:\n    for (;;) {\n        // \u83b7\u53d6 ctl \u7684\u503c\n        int c = ctl.get();\n        // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u6c60\u8fd0\u884c\u72b6\u6001\n        int rs = runStateOf(c);\t\n        \n        // \u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u6c60\u72b6\u6001\u3010\u662f\u5426\u5141\u8bb8\u6dfb\u52a0\u7ebf\u7a0b\u3011\n        \n        // \u5f53\u524d\u7ebf\u7a0b\u6c60\u662f SHUTDOWN \u72b6\u6001\uff0c\u4f46\u662f\u961f\u5217\u91cc\u9762\u8fd8\u6709\u4efb\u52a1\u5c1a\u672a\u5904\u7406\u5b8c\uff0c\u9700\u8981\u5904\u7406\u5b8c queue \u4e2d\u7684\u4efb\u52a1\n        // \u3010\u4e0d\u5141\u8bb8\u518d\u63d0\u4ea4\u65b0\u7684 task\uff0c\u6240\u4ee5 firstTask \u4e3a\u7a7a\uff0c\u4f46\u662f\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0 worker\u3011\n        if (rs >= SHUTDOWN && !(rs == SHUTDOWN && firstTask == null && !workQueue.isEmpty()))\n            return false;\n        for (;;) {\n            // \u83b7\u53d6\u7ebf\u7a0b\u6c60\u4e2d\u7ebf\u7a0b\u6570\u91cf\n            int wc = workerCountOf(c);\n            // \u6761\u4ef6\u4e00\u4e00\u822c\u4e0d\u6210\u7acb\uff0cCAPACITY\u662f5\u4ebf\u591a\uff0c\u6839\u636e core \u5224\u65ad\u4f7f\u7528\u54ea\u4e2a\u5927\u5c0f\u9650\u5236\u7ebf\u7a0b\u6570\u91cf\uff0c\u8d85\u8fc7\u4e86\u8fd4\u56de false\n            if (wc >= CAPACITY || wc >= (core ? corePoolSize : maximumPoolSize))\n                return false;\n            // \u8bb0\u5f55\u7ebf\u7a0b\u6570\u91cf\u5df2\u7ecf\u52a0 1\uff0c\u7c7b\u6bd4\u4e8e\u7533\u8bf7\u5230\u4e86\u4e00\u5757\u4ee4\u724c\uff0c\u6761\u4ef6\u5931\u8d25\u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u4fee\u6539\u4e86\u6570\u91cf\n            if (compareAndIncrementWorkerCount(c))\n                // \u7533\u8bf7\u6210\u529f\uff0c\u8df3\u51fa\u4e86 retry \u8fd9\u4e2a for \u81ea\u65cb\n                break retry;\n            // CAS \u5931\u8d25\uff0c\u6ca1\u6709\u6210\u529f\u7684\u7533\u8bf7\u5230\u4ee4\u724c\n            c = ctl.get();\n            // \u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u6c60\u72b6\u6001\u662f\u5426\u53d1\u751f\u8fc7\u53d8\u5316\uff0c\u88ab\u5176\u4ed6\u7ebf\u7a0b\u4fee\u6539\u4e86\uff0c\u53ef\u80fd\u5176\u4ed6\u7ebf\u7a0b\u8c03\u7528\u4e86 shutdown() \u65b9\u6cd5\n            if (runStateOf(c) != rs)\n                // \u8fd4\u56de\u5916\u5c42\u5faa\u73af\u68c0\u67e5\u662f\u5426\u80fd\u521b\u5efa\u7ebf\u7a0b\uff0c\u5728 if \u8bed\u53e5\u4e2d\u8fd4\u56de false\n                continue retry;\n           \n        }\n    }\n    \n    //\u3010\u4ee4\u724c\u7533\u8bf7\u6210\u529f\uff0c\u5f00\u59cb\u521b\u5efa\u7ebf\u7a0b\u3011\n    \n\t// \u8fd0\u884c\u6807\u8bb0\uff0c\u8868\u793a\u521b\u5efa\u7684 worker \u662f\u5426\u5df2\u7ecf\u542f\u52a8\uff0cfalse\u672a\u542f\u52a8  true\u542f\u52a8\n    boolean workerStarted = false;\n    // \u6dfb\u52a0\u6807\u8bb0\uff0c\u8868\u793a\u521b\u5efa\u7684 worker \u662f\u5426\u6dfb\u52a0\u5230\u6c60\u5b50\u4e2d\u4e86\uff0c\u9ed8\u8ba4false\u672a\u6dfb\u52a0\uff0ctrue\u662f\u6dfb\u52a0\u3002\n    boolean workerAdded = false;\n    Worker w = null;\n    try {\n        // \u3010\u521b\u5efa Worker\uff0c\u5e95\u5c42\u901a\u8fc7\u7ebf\u7a0b\u5de5\u5382 newThread \u65b9\u6cd5\u521b\u5efa\u6267\u884c\u7ebf\u7a0b\uff0c\u6307\u5b9a\u4e86\u9996\u5148\u6267\u884c\u7684\u4efb\u52a1\u3011\n        w = new Worker(firstTask);\n        // \u5c06\u65b0\u521b\u5efa\u7684 worker \u8282\u70b9\u4e2d\u7684\u7ebf\u7a0b\u8d4b\u503c\u7ed9 t\n        final Thread t = w.thread;\n        // \u8fd9\u91cc\u7684\u5224\u65ad\u4e3a\u4e86\u9632\u6b62 \u7a0b\u5e8f\u5458\u81ea\u5b9a\u4e49\u7684 ThreadFactory \u5b9e\u73b0\u7c7b\u6709 bug\uff0c\u521b\u9020\u4e0d\u51fa\u7ebf\u7a0b\n        if (t != null) {\n            final ReentrantLock mainLock = this.mainLock;\n            // \u52a0\u4e92\u65a5\u9501\uff0c\u8981\u6dfb\u52a0 worker \u4e86\n            mainLock.lock();\n            try {\n                // \u83b7\u53d6\u6700\u65b0\u7ebf\u7a0b\u6c60\u8fd0\u884c\u72b6\u6001\u4fdd\u5b58\u5230 rs\n                int rs = runStateOf(ctl.get());\n\t\t\t\t// \u5224\u65ad\u7ebf\u7a0b\u6c60\u662f\u5426\u4e3aRUNNING\u72b6\u6001\uff0c\u4e0d\u662f\u518d\u3010\u5224\u65ad\u5f53\u524d\u662f\u5426\u4e3aSHUTDOWN\u72b6\u6001\u4e14firstTask\u4e3a\u7a7a\uff0c\u7279\u6b8a\u60c5\u51b5\u3011\n                if (rs < SHUTDOWN || (rs == SHUTDOWN && firstTask == null)) {\n                    // \u5f53\u7ebf\u7a0bstart\u540e\uff0c\u7ebf\u7a0bisAlive\u4f1a\u8fd4\u56detrue\uff0c\u8fd9\u91cc\u8fd8\u6ca1\u5f00\u59cb\u542f\u52a8\u7ebf\u7a0b\uff0c\u5982\u679c\u88ab\u542f\u52a8\u4e86\u5c31\u9700\u8981\u62a5\u9519\n                    if (t.isAlive())\n                        throw new IllegalThreadStateException();\n                    \n                    //\u3010\u5c06\u65b0\u5efa\u7684 Worker \u6dfb\u52a0\u5230\u7ebf\u7a0b\u6c60\u4e2d\u3011\n                    workers.add(w);\n                    int s = workers.size();\n\t\t\t\t\t// \u5f53\u524d\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\u662f\u4e00\u4e2a\u65b0\u9ad8\uff0c\u66f4\u65b0 largestPoolSize\n                    if (s > largestPoolSize)\n                        largestPoolSize = s;\n                    // \u6dfb\u52a0\u6807\u8bb0\u7f6e\u4e3a true\n                    workerAdded = true;\n                }\n            } finally {\n                // \u89e3\u9501\u554a\n                mainLock.unlock();\n            }\n            // \u6dfb\u52a0\u6210\u529f\u5c31\u3010\u542f\u52a8\u7ebf\u7a0b\u6267\u884c\u4efb\u52a1\u3011\n            if (workerAdded) {\n                // Thread \u7c7b\u4e2d\u6301\u6709 Runnable \u4efb\u52a1\u5bf9\u8c61\uff0c\u8c03\u7528\u7684\u662f Runnable \u7684 run \uff0c\u4e5f\u5c31\u662f FutureTask\n                t.start();\n                // \u8fd0\u884c\u6807\u8bb0\u7f6e\u4e3a true\n                workerStarted = true;\n            }\n        }\n    } finally {\n        // \u5982\u679c\u542f\u52a8\u7ebf\u7a0b\u5931\u8d25\uff0c\u505a\u6e05\u7406\u5de5\u4f5c\n        if (! workerStarted)\n            addWorkerFailed(w);\n    }\n    // \u8fd4\u56de\u65b0\u521b\u5efa\u7684\u7ebf\u7a0b\u662f\u5426\u542f\u52a8\n    return workerStarted;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"addWorkerFailed()\uff1a\u6e05\u7406\u4efb\u52a1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void addWorkerFailed(Worker w) {\n    final ReentrantLock mainLock = this.mainLock;\n    // \u6301\u6709\u7ebf\u7a0b\u6c60\u5168\u5c40\u9501\uff0c\u56e0\u4e3a\u64cd\u4f5c\u7684\u662f\u7ebf\u7a0b\u6c60\u76f8\u5173\u7684\u4e1c\u897f\n    mainLock.lock();\n    try {\n        //\u6761\u4ef6\u6210\u7acb\u9700\u8981\u5c06 worker \u5728 workers \u4e2d\u6e05\u7406\u51fa\u53bb\u3002\n        if (w != null)\n            workers.remove(w);\n        // \u5c06\u7ebf\u7a0b\u6c60\u8ba1\u6570 -1\uff0c\u76f8\u5f53\u4e8e\u5f52\u8fd8\u4ee4\u724c\u3002\n        decrementWorkerCount();\n        // \u5c1d\u8bd5\u505c\u6b62\u7ebf\u7a0b\u6c60\n        tryTerminate();\n    } finally {\n        //\u91ca\u653e\u7ebf\u7a0b\u6c60\u5168\u5c40\u9501\u3002\n        mainLock.unlock();\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u8fd0\u884c\u65b9\u6cd5",children:"\u8fd0\u884c\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Worker#run\uff1aWorker \u5b9e\u73b0\u4e86 Runnable \u63a5\u53e3\uff0c\u5f53\u7ebf\u7a0b\u542f\u52a8\u65f6\uff0c\u4f1a\u8c03\u7528 Worker \u7684 run() \u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void run() {\n    // ThreadPoolExecutor#runWorker()\n    runWorker(this);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["runWorker()\uff1a\u7ebf\u7a0b\u542f\u52a8\u5c31\u8981",(0,r.jsx)(e.strong,{children:"\u6267\u884c\u4efb\u52a1"}),"\uff0c\u4f1a\u4e00\u76f4 while \u5faa\u73af\u83b7\u53d6\u4efb\u52a1\u5e76\u6267\u884c"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final void runWorker(Worker w) {\n    Thread wt = Thread.currentThread();\t\n    // \u83b7\u53d6 worker \u7684 firstTask\n    Runnable task = w.firstTask;\n    // \u5f15\u7528\u7f6e\u7a7a\uff0c\u3010\u9632\u6b62\u590d\u7528\u8be5\u7ebf\u7a0b\u65f6\u91cd\u590d\u6267\u884c\u8be5\u4efb\u52a1\u3011\n    w.firstTask = null;\n    // \u521d\u59cb\u5316 worker \u65f6\u8bbe\u7f6e state = -1\uff0c\u8868\u793a\u4e0d\u5141\u8bb8\u62a2\u5360\u9501\n    // \u8fd9\u91cc\u9700\u8981\u8bbe\u7f6e state = 0 \u548c exclusiveOwnerThread = null\uff0c\u5f00\u59cb\u72ec\u5360\u6a21\u5f0f\u62a2\u9501\n    w.unlock();\n    // true \u8868\u793a\u53d1\u751f\u5f02\u5e38\u9000\u51fa\uff0cfalse \u8868\u793a\u6b63\u5e38\u9000\u51fa\u3002\n    boolean completedAbruptly = true;\n    try {\n        // firstTask \u4e0d\u662f null \u5c31\u76f4\u63a5\u8fd0\u884c\uff0c\u5426\u5219\u53bb queue \u4e2d\u83b7\u53d6\u4efb\u52a1\n        // \u3010getTask \u5982\u679c\u662f\u963b\u585e\u83b7\u53d6\u4efb\u52a1\uff0c\u4f1a\u4e00\u76f4\u963b\u585e\u5728take\u65b9\u6cd5\uff0c\u76f4\u5230\u83b7\u53d6\u4efb\u52a1\uff0c\u4e0d\u4f1a\u8d70\u8fd4\u56denull\u7684\u903b\u8f91\u3011\n        while (task != null || (task = getTask()) != null) {\n            // worker \u52a0\u9501\uff0cshutdown \u65f6\u4f1a\u5224\u65ad\u5f53\u524d worker \u72b6\u6001\uff0c\u3010\u6839\u636e\u72ec\u5360\u9501\u72b6\u6001\u5224\u65ad\u662f\u5426\u7a7a\u95f2\u3011\n            w.lock();\n            \n\t\t\t// \u8bf4\u660e\u7ebf\u7a0b\u6c60\u72b6\u6001\u5927\u4e8e STOP\uff0c\u76ee\u524d\u5904\u4e8e STOP/TIDYING/TERMINATION\uff0c\u6b64\u65f6\u7ed9\u7ebf\u7a0b\u4e00\u4e2a\u4e2d\u65ad\u4fe1\u53f7\n            if ((runStateAtLeast(ctl.get(), STOP) ||\n                 // \u8bf4\u660e\u7ebf\u7a0b\u5904\u4e8e RUNNING \u6216\u8005 SHUTDOWN \u72b6\u6001\uff0c\u6e05\u9664\u6253\u65ad\u6807\u8bb0\n                 (Thread.interrupted() && runStateAtLeast(ctl.get(), STOP))) && !wt.isInterrupted())\n                // \u4e2d\u65ad\u7ebf\u7a0b\uff0c\u8bbe\u7f6e\u7ebf\u7a0b\u7684\u4e2d\u65ad\u6807\u5fd7\u4f4d\u4e3a true\n                wt.interrupt();\n            try {\n                // \u94a9\u5b50\u65b9\u6cd5\uff0c\u3010\u4efb\u52a1\u6267\u884c\u7684\u524d\u7f6e\u5904\u7406\u3011\n                beforeExecute(wt, task);\n                Throwable thrown = null;\n                try {\n                    // \u3010\u6267\u884c\u4efb\u52a1\u3011\n                    task.run();\n                } catch (Exception x) {\n                 \t//.....\n                } finally {\n                    // \u94a9\u5b50\u65b9\u6cd5\uff0c\u3010\u4efb\u52a1\u6267\u884c\u7684\u540e\u7f6e\u5904\u7406\u3011\n                    afterExecute(task, thrown);\n                }\n            } finally {\n                task = null;\t\t// \u5c06\u5c40\u90e8\u53d8\u91cftask\u7f6e\u4e3anull\uff0c\u4ee3\u8868\u4efb\u52a1\u6267\u884c\u5b8c\u6210\n                w.completedTasks++;\t// \u66f4\u65b0worker\u5b8c\u6210\u4efb\u52a1\u6570\u91cf\n                w.unlock();\t\t\t// \u89e3\u9501\n            }\n        }\n        // getTask()\u65b9\u6cd5\u8fd4\u56denull\u65f6\u4f1a\u8d70\u5230\u8fd9\u91cc\uff0c\u8868\u793aqueue\u4e3a\u7a7a\u5e76\u4e14\u7ebf\u7a0b\u7a7a\u95f2\u8d85\u8fc7\u4fdd\u6d3b\u65f6\u95f4\uff0c\u3010\u5f53\u524d\u7ebf\u7a0b\u6267\u884c\u9000\u51fa\u903b\u8f91\u3011\n        completedAbruptly = false;\t\n    } finally {\n        // \u6b63\u5e38\u9000\u51fa completedAbruptly = false\n       \t// \u5f02\u5e38\u9000\u51fa completedAbruptly = true\uff0c\u3010\u4ece task.run() \u5185\u90e8\u629b\u51fa\u5f02\u5e38\u3011\u65f6\uff0c\u8df3\u5230\u8fd9\u4e00\u884c\n        processWorkerExit(w, completedAbruptly);\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"unlock()\uff1a\u91cd\u7f6e\u9501"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void unlock() { release(1); }\n// \u5916\u90e8\u4e0d\u4f1a\u76f4\u63a5\u8c03\u7528\u8fd9\u4e2a\u65b9\u6cd5 \u8fd9\u4e2a\u65b9\u6cd5\u662f AQS \u5185\u8c03\u7528\u7684\uff0c\u5916\u90e8\u8c03\u7528 unlock \u65f6\u89e6\u53d1\u6b64\u65b9\u6cd5\nprotected boolean tryRelease(int unused) {\n    setExclusiveOwnerThread(null);\t\t// \u8bbe\u7f6e\u6301\u6709\u8005\u4e3a null\n    setState(0);\t\t\t\t\t\t// \u8bbe\u7f6e state = 0\n    return true;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["getTask()\uff1a\u83b7\u53d6\u4efb\u52a1\uff0c\u7ebf\u7a0b\u7a7a\u95f2\u65f6\u95f4\u8d85\u8fc7 keepAliveTime \u5c31\u4f1a\u88ab\u56de\u6536\uff0c\u5224\u65ad\u7684\u4f9d\u636e\u662f",(0,r.jsx)(e.strong,{children:"\u5f53\u524d\u7ebf\u7a0b\u963b\u585e\u83b7\u53d6\u4efb\u52a1\u8d85\u8fc7\u4fdd\u6d3b\u65f6\u95f4"}),"\uff0c\u65b9\u6cd5\u8fd4\u56de null \u5c31\u4ee3\u8868\u5f53\u524d\u7ebf\u7a0b\u8981\u88ab\u56de\u6536\u4e86\uff0c\u8fd4\u56de\u5230 runWorker \u6267\u884c\u7ebf\u7a0b\u9000\u51fa\u903b\u8f91\u3002\u7ebf\u7a0b\u6c60\u5177\u6709\u62c5\u4fdd\u673a\u5236\uff0c\u5bf9\u4e8e RUNNING \u72b6\u6001\u4e0b\u7684\u8d85\u65f6\u56de\u6536\uff0c\u8981\u4fdd\u8bc1\u7ebf\u7a0b\u6c60\u4e2d\u6700\u5c11\u6709\u4e00\u4e2a\u7ebf\u7a0b\u8fd0\u884c\uff0c\u6216\u8005\u4efb\u52a1\u963b\u585e\u961f\u5217\u5df2\u7ecf\u662f\u7a7a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private Runnable getTask() {\n    // \u8d85\u65f6\u6807\u8bb0\uff0c\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u83b7\u53d6\u4efb\u52a1\u662f\u5426\u8d85\u65f6\uff0ctrue \u8868\u793a\u5df2\u8d85\u65f6\n    boolean timedOut = false; \n    for (;;) {\n        int c = ctl.get();\n        // \u83b7\u53d6\u7ebf\u7a0b\u6c60\u5f53\u524d\u8fd0\u884c\u72b6\u6001\n        int rs = runStateOf(c);\n\t\t\n        // \u3010tryTerminate\u3011\u6253\u65ad\u7ebf\u7a0b\u540e\u6267\u884c\u5230\u8fd9\uff0c\u6b64\u65f6\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3aSTOP\u6216\u8005\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3aSHUTDOWN\u5e76\u4e14\u961f\u5217\u5df2\u7ecf\u662f\u7a7a\n        // \u6240\u4ee5\u4e0b\u9762\u7684 if \u6761\u4ef6\u4e00\u5b9a\u662f\u6210\u7acb\u7684\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de null\uff0c\u7ebf\u7a0b\u5c31\u5e94\u8be5\u9000\u51fa\u4e86\n        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {\n            // \u4f7f\u7528 CAS \u81ea\u65cb\u7684\u65b9\u5f0f\u8ba9 ctl \u503c -1\n            decrementWorkerCount();\n            return null;\n        }\n        \n\t\t// \u83b7\u53d6\u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\n        int wc = workerCountOf(c);\n\n        // \u7ebf\u7a0b\u6ca1\u6709\u660e\u786e\u7684\u533a\u5206\u8c01\u662f\u6838\u5fc3\u6216\u8005\u975e\u6838\u5fc3\u7ebf\u7a0b\uff0c\u662f\u6839\u636e\u5f53\u524d\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\u5224\u65ad\n        \n        // timed = false \u8868\u793a\u5f53\u524d\u8fd9\u4e2a\u7ebf\u7a0b \u83b7\u53d6task\u65f6\u4e0d\u652f\u6301\u8d85\u65f6\u673a\u5236\u7684\uff0c\u5f53\u524d\u7ebf\u7a0b\u4f1a\u4f7f\u7528 queue.take() \u963b\u585e\u83b7\u53d6\n        // timed = true \u8868\u793a\u5f53\u524d\u8fd9\u4e2a\u7ebf\u7a0b \u83b7\u53d6task\u65f6\u652f\u6301\u8d85\u65f6\u673a\u5236\uff0c\u4f7f\u7528 queue.poll(xxx,xxx) \u8d85\u65f6\u83b7\u53d6\n        // \u6761\u4ef6\u4e00\u4ee3\u8868\u5141\u8bb8\u56de\u6536\u6838\u5fc3\u7ebf\u7a0b\uff0c\u90a3\u5c31\u65e0\u6240\u8c13\u4e86\uff0c\u5168\u90e8\u7ebf\u7a0b\u90fd\u6267\u884c\u8d85\u65f6\u56de\u6536\n        // \u6761\u4ef6\u4e8c\u6210\u7acb\u8bf4\u660e\u7ebf\u7a0b\u6570\u91cf\u5927\u4e8e\u6838\u5fc3\u7ebf\u7a0b\u6570\uff0c\u5f53\u524d\u7ebf\u7a0b\u8ba4\u4e3a\u662f\u975e\u6838\u5fc3\u7ebf\u7a0b\uff0c\u6709\u4fdd\u6d3b\u65f6\u95f4\uff0c\u53bb\u8d85\u65f6\u83b7\u53d6\u4efb\u52a1\n        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n        \n\t\t// \u5982\u679c\u7ebf\u7a0b\u6570\u91cf\u662f\u5426\u8d85\u8fc7\u6700\u5927\u7ebf\u7a0b\u6570\uff0c\u76f4\u63a5\u56de\u6536\n        // \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u3010\u5141\u8bb8\u8d85\u65f6\u56de\u6536\u5e76\u4e14\u5df2\u7ecf\u8d85\u65f6\u4e86\u3011\uff0c\u5c31\u5e94\u8be5\u88ab\u56de\u6536\u4e86\uff0c\u7531\u4e8e\u3010\u62c5\u4fdd\u673a\u5236\u3011\u8fd8\u8981\u505a\u5224\u65ad\uff1a\n        // \t  wc > 1 \u8bf4\u660e\u7ebf\u7a0b\u6c60\u8fd8\u7528\u5176\u4ed6\u7ebf\u7a0b\uff0c\u5f53\u524d\u7ebf\u7a0b\u53ef\u4ee5\u76f4\u63a5\u56de\u6536\n        //    workQueue.isEmpty() \u524d\u7f6e\u6761\u4ef6\u662f wc = 1\uff0c\u3010\u5982\u679c\u5f53\u524d\u4efb\u52a1\u961f\u5217\u4e5f\u662f\u7a7a\u4e86\uff0c\u6700\u540e\u4e00\u4e2a\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u9000\u51fa\u3011\n        if ((wc > maximumPoolSize || (timed && timedOut)) && (wc > 1 || workQueue.isEmpty())) {\n            // \u4f7f\u7528 CAS \u673a\u5236\u5c06 ctl \u503c -1 ,\u51cf 1 \u6210\u529f\u7684\u7ebf\u7a0b\uff0c\u8fd4\u56de null\uff0c\u4ee3\u8868\u53ef\u4ee5\u9000\u51fa\n            if (compareAndDecrementWorkerCount(c))\n                return null;\n            continue;\n        }\n\n        try {\n            // \u6839\u636e\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u9700\u8981\u8d85\u65f6\u56de\u6536\uff0c\u3010\u9009\u62e9\u4ece\u961f\u5217\u83b7\u53d6\u4efb\u52a1\u7684\u65b9\u6cd5\u3011\u662f\u8d85\u65f6\u83b7\u53d6\u6216\u8005\u963b\u585e\u83b7\u53d6\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take();\n            // \u83b7\u53d6\u5230\u4efb\u52a1\u8fd4\u56de\u4efb\u52a1\uff0c\u3010\u963b\u585e\u83b7\u53d6\u4f1a\u963b\u585e\u5230\u83b7\u53d6\u4efb\u52a1\u4e3a\u6b62\u3011\uff0c\u4e0d\u4f1a\u8fd4\u56de null\n            if (r != null)\n                return r;\n            // \u83b7\u53d6\u4efb\u52a1\u4e3a null \u8bf4\u660e\u8d85\u65f6\u4e86\uff0c\u5c06\u8d85\u65f6\u6807\u8bb0\u8bbe\u7f6e\u4e3a true\uff0c\u4e0b\u6b21\u81ea\u65cb\u65f6\u8fd4 null\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            // \u963b\u585e\u7ebf\u7a0b\u88ab\u6253\u65ad\u540e\u8d85\u65f6\u6807\u8bb0\u7f6e\u4e3a false\uff0c\u3010\u8bf4\u660e\u88ab\u6253\u65ad\u4e0d\u7b97\u8d85\u65f6\u3011\uff0c\u8981\u7ee7\u7eed\u83b7\u53d6\uff0c\u76f4\u5230\u8d85\u65f6\u6216\u8005\u83b7\u53d6\u5230\u4efb\u52a1\n            // \u5982\u679c\u7ebf\u7a0b\u6c60 SHUTDOWN \u72b6\u6001\u4e0b\u7684\u6253\u65ad\uff0c\u4f1a\u5728\u5faa\u73af\u83b7\u53d6\u4efb\u52a1\u524d\u5224\u65ad\uff0c\u8fd4\u56de null\n            timedOut = false;\n        }\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["processWorkerExit()\uff1a",(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u9000\u51fa\u7ebf\u7a0b\u6c60"}),"\uff0c\u4e5f\u6709\u62c5\u4fdd\u673a\u5236\uff0c\u4fdd\u8bc1\u961f\u5217\u4e2d\u7684\u4efb\u52a1\u88ab\u6267\u884c"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u6b63\u5e38\u9000\u51fa completedAbruptly = false\uff0c\u5f02\u5e38\u9000\u51fa\u4e3a true\nprivate void processWorkerExit(Worker w, boolean completedAbruptly) {\n    // \u6761\u4ef6\u6210\u7acb\u4ee3\u8868\u5f53\u524d worker \u662f\u53d1\u751f\u5f02\u5e38\u9000\u51fa\u7684\uff0ctask \u4efb\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u5411\u4e0a\u629b\u51fa\u5f02\u5e38\u4e86\n    if (completedAbruptly) \n        // \u4ece\u5f02\u5e38\u65f6\u5230\u8fd9\u91cc ctl \u4e00\u76f4\u6ca1\u6709 -1\uff0c\u9700\u8981\u5728\u8fd9\u91cc -1\n        decrementWorkerCount();\n\n    final ReentrantLock mainLock = this.mainLock;\n    // \u52a0\u9501\n    mainLock.lock();\n    try {\n        // \u5c06\u5f53\u524d worker \u5b8c\u6210\u7684 task \u6570\u91cf\uff0c\u6c47\u603b\u5230\u7ebf\u7a0b\u6c60\u7684 completedTaskCount\n        completedTaskCount += w.completedTasks;\n\t\t// \u5c06 worker \u4ece\u7ebf\u7a0b\u6c60\u4e2d\u79fb\u9664\n        workers.remove(w);\n    } finally {\n        mainLock.unlock();\t// \u89e3\u9501\n    }\n\t// \u5c1d\u8bd5\u505c\u6b62\u7ebf\u7a0b\u6c60\uff0c\u5524\u9192\u4e0b\u4e00\u4e2a\u7ebf\u7a0b\n    tryTerminate();\n\n    int c = ctl.get();\n    // \u7ebf\u7a0b\u6c60\u4e0d\u662f\u505c\u6b62\u72b6\u6001\u5c31\u5e94\u8be5\u6709\u7ebf\u7a0b\u8fd0\u884c\u3010\u62c5\u4fdd\u673a\u5236\u3011\n    if (runStateLessThan(c, STOP)) {\n        // \u6b63\u5e38\u9000\u51fa\u7684\u903b\u8f91\uff0c\u662f\u5bf9\u7a7a\u95f2\u7ebf\u7a0b\u56de\u6536\uff0c\u4e0d\u662f\u6267\u884c\u51fa\u9519\n        if (!completedAbruptly) {\n            // \u6839\u636e\u662f\u5426\u56de\u6536\u6838\u5fc3\u7ebf\u7a0b\u786e\u5b9a\u3010\u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\u6700\u5c0f\u503c\u3011\n            int min = allowCoreThreadTimeOut ? 0 : corePoolSize;\n            // \u6700\u5c0f\u503c\u4e3a 0\uff0c\u4f46\u662f\u7ebf\u7a0b\u961f\u5217\u4e0d\u4e3a\u7a7a\uff0c\u9700\u8981\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5b8c\u6210\u4efb\u52a1\u62c5\u4fdd\u673a\u5236\n            if (min == 0 && !workQueue.isEmpty())\n                min = 1;\n            // \u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\u5927\u4e8e\u6700\u5c0f\u503c\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\n            if (workerCountOf(c) >= min)\n                return;\n        }\n        // \u6267\u884c task \u65f6\u53d1\u751f\u5f02\u5e38\uff0c\u6709\u4e2a\u7ebf\u7a0b\u56e0\u4e3a\u5f02\u5e38\u7ec8\u6b62\u4e86\uff0c\u9700\u8981\u6dfb\u52a0\n        // \u6216\u8005\u7ebf\u7a0b\u6c60\u4e2d\u7684\u6570\u91cf\u5c0f\u4e8e\u6700\u5c0f\u503c\uff0c\u8fd9\u91cc\u8981\u521b\u5efa\u4e00\u4e2a\u65b0 worker \u52a0\u8fdb\u7ebf\u7a0b\u6c60\n        addWorker(null, false);\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u505c\u6b62\u65b9\u6cd5",children:"\u505c\u6b62\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"shutdown()\uff1a\u505c\u6b62\u7ebf\u7a0b\u6c60"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void shutdown() {\n    final ReentrantLock mainLock = this.mainLock;\n    // \u83b7\u53d6\u7ebf\u7a0b\u6c60\u5168\u5c40\u9501\n    mainLock.lock();\n    try {\n        checkShutdownAccess();\n        // \u8bbe\u7f6e\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3a SHUTDOWN\uff0c\u5982\u679c\u7ebf\u7a0b\u6c60\u72b6\u6001\u5927\u4e8e SHUTDOWN\uff0c\u5c31\u4e0d\u4f1a\u8bbe\u7f6e\u76f4\u63a5\u8fd4\u56de\n        advanceRunState(SHUTDOWN);\n        // \u4e2d\u65ad\u7a7a\u95f2\u7ebf\u7a0b\n        interruptIdleWorkers();\n        // \u7a7a\u65b9\u6cd5\uff0c\u5b50\u7c7b\u53ef\u4ee5\u6269\u5c55\n        onShutdown(); \n    } finally {\n        // \u91ca\u653e\u7ebf\u7a0b\u6c60\u5168\u5c40\u9501\n        mainLock.unlock();\n    }\n    tryTerminate();\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["interruptIdleWorkers()\uff1ashutdown \u65b9\u6cd5\u4f1a",(0,r.jsx)(e.strong,{children:"\u4e2d\u65ad\u6240\u6709\u7a7a\u95f2\u7ebf\u7a0b"}),"\uff0c\u6839\u636e\u662f\u5426\u53ef\u4ee5\u83b7\u53d6 AQS \u72ec\u5360\u9501\u5224\u65ad\u662f\u5426\u5904\u4e8e\u5de5\u4f5c\u72b6\u6001\u3002\u7ebf\u7a0b\u4e4b\u6240\u4ee5\u7a7a\u95f2\u662f\u56e0\u4e3a\u963b\u585e\u961f\u5217\u6ca1\u6709\u4efb\u52a1\uff0c\u4e0d\u4f1a\u4e2d\u65ad\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\uff0c\u6240\u4ee5 shutdown \u65b9\u6cd5\u4f1a\u8ba9\u6240\u6709\u7684\u4efb\u52a1\u6267\u884c\u5b8c\u6bd5"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// onlyOne == true \u8bf4\u660e\u53ea\u4e2d\u65ad\u4e00\u4e2a\u7ebf\u7a0b \uff0cfalse \u5219\u4e2d\u65ad\u6240\u6709\u7ebf\u7a0b\nprivate void interruptIdleWorkers(boolean onlyOne) {\n    final ReentrantLock mainLock = this.mainLock;\n    / /\u6301\u6709\u5168\u5c40\u9501\n    mainLock.lock();\n    try {\n        // \u904d\u5386\u6240\u6709 worker\n        for (Worker w : workers) {\n            // \u83b7\u53d6\u5f53\u524d worker \u7684\u7ebf\u7a0b\n            Thread t = w.thread;\n            // \u6761\u4ef6\u4e00\u6210\u7acb\uff1a\u8bf4\u660e\u5f53\u524d\u8fed\u4ee3\u7684\u8fd9\u4e2a\u7ebf\u7a0b\u5c1a\u672a\u4e2d\u65ad\n            // \u6761\u4ef6\u4e8c\u6210\u7acb\uff1a\u8bf4\u660e\u3010\u5f53\u524dworker\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\u3011\uff0c\u963b\u585e\u5728poll\u6216\u8005take\uff0c\u56e0\u4e3aworker\u6267\u884ctask\u65f6\u662f\u8981\u52a0\u9501\u7684\n            //           \u6bcf\u4e2aworker\u6709\u4e00\u4e2a\u72ec\u5360\u9501\uff0cw.tryLock()\u5c1d\u8bd5\u52a0\u9501\uff0c\u52a0\u9501\u6210\u529f\u8fd4\u56de true\n            if (!t.isInterrupted() && w.tryLock()) {\n                try {\n                    // \u4e2d\u65ad\u7ebf\u7a0b\uff0c\u5904\u4e8e queue \u963b\u585e\u7684\u7ebf\u7a0b\u4f1a\u88ab\u5524\u9192\uff0c\u8fdb\u5165\u4e0b\u4e00\u6b21\u81ea\u65cb\uff0c\u8fd4\u56de null\uff0c\u6267\u884c\u9000\u51fa\u76f8\u903b\u8f91\n                    t.interrupt();\n                } catch (SecurityException ignore) {\n                } finally {\n                    // \u91ca\u653eworker\u7684\u72ec\u5360\u9501\n                    w.unlock();\n                }\n            }\n            // false\uff0c\u4ee3\u8868\u4e2d\u65ad\u6240\u6709\u7684\u7ebf\u7a0b\n            if (onlyOne)\n                break;\n        }\n\n    } finally {\n        // \u91ca\u653e\u5168\u5c40\u9501\n        mainLock.unlock();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"shutdownNow()\uff1a\u76f4\u63a5\u5173\u95ed\u7ebf\u7a0b\u6c60\uff0c\u4e0d\u4f1a\u7b49\u5f85\u4efb\u52a1\u6267\u884c\u5b8c\u6210"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public List<Runnable> shutdownNow() {\n    // \u8fd4\u56de\u503c\u5f15\u7528\n    List<Runnable> tasks;\n    final ReentrantLock mainLock = this.mainLock;\n    // \u83b7\u53d6\u7ebf\u7a0b\u6c60\u5168\u5c40\u9501\n    mainLock.lock();\n    try {\n        checkShutdownAccess();\n        // \u8bbe\u7f6e\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3aSTOP\n        advanceRunState(STOP);\n        // \u4e2d\u65ad\u7ebf\u7a0b\u6c60\u4e2d\u3010\u6240\u6709\u7ebf\u7a0b\u3011\n        interruptWorkers();\n        // \u4ece\u963b\u585e\u961f\u5217\u4e2d\u5bfc\u51fa\u672a\u5904\u7406\u7684task\n        tasks = drainQueue();\n    } finally {\n        mainLock.unlock();\n    }\n\n    tryTerminate();\n    // \u8fd4\u56de\u5f53\u524d\u4efb\u52a1\u961f\u5217\u4e2d \u672a\u5904\u7406\u7684\u4efb\u52a1\u3002\n    return tasks;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"tryTerminate()\uff1a\u8bbe\u7f6e\u4e3a TERMINATED \u72b6\u6001 if either (SHUTDOWN and pool and queue empty) or (STOP and pool empty)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final void tryTerminate() {\n    for (;;) {\n        // \u83b7\u53d6 ctl \u7684\u503c\n        int c = ctl.get();\n        // \u7ebf\u7a0b\u6c60\u6b63\u5e38\uff0c\u6216\u8005\u6709\u5176\u4ed6\u7ebf\u7a0b\u6267\u884c\u4e86\u72b6\u6001\u8f6c\u6362\u7684\u65b9\u6cd5\uff0c\u5f53\u524d\u7ebf\u7a0b\u76f4\u63a5\u8fd4\u56de\n        if (isRunning(c) || runStateAtLeast(c, TIDYING) ||\n            // \u7ebf\u7a0b\u6c60\u662f SHUTDOWN \u5e76\u4e14\u4efb\u52a1\u961f\u5217\u4e0d\u662f\u7a7a\uff0c\u9700\u8981\u53bb\u5904\u7406\u961f\u5217\u4e2d\u7684\u4efb\u52a1\n            (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))\n            return;\n        \n        // \u6267\u884c\u5230\u8fd9\u91cc\u8bf4\u660e\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3a STOP \u6216\u8005\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3a SHUTDOWN \u5e76\u4e14\u961f\u5217\u5df2\u7ecf\u662f\u7a7a\n        // \u5224\u65ad\u7ebf\u7a0b\u6c60\u4e2d\u7ebf\u7a0b\u7684\u6570\u91cf\n        if (workerCountOf(c) != 0) {\n            // \u3010\u4e2d\u65ad\u4e00\u4e2a\u7a7a\u95f2\u7ebf\u7a0b\u3011\uff0c\u5728 queue.take() | queue.poll() \u963b\u585e\u7a7a\u95f2\n            // \u5524\u9192\u540e\u7684\u7ebf\u7a0b\u4f1a\u5728getTask()\u65b9\u6cd5\u8fd4\u56denull\uff0c\n            // \u6267\u884c processWorkerExit \u9000\u51fa\u903b\u8f91\u65f6\u4f1a\u518d\u6b21\u8c03\u7528 tryTerminate() \u5524\u9192\u4e0b\u4e00\u4e2a\u7a7a\u95f2\u7ebf\u7a0b\n            interruptIdleWorkers(ONLY_ONE);\n            return;\n        }\n\t\t// \u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\u4e3a 0 \u6765\u5230\u8fd9\u91cc\n        final ReentrantLock mainLock = this.mainLock;\n        // \u52a0\u5168\u5c40\u9501\n        mainLock.lock();\n        try {\n            // \u8bbe\u7f6e\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3a TIDYING \u72b6\u6001\uff0c\u7ebf\u7a0b\u6570\u91cf\u4e3a 0\n            if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {\n                try {\n                    // \u7ed3\u675f\u7ebf\u7a0b\u6c60\n                    terminated();\n                } finally {\n                    // \u8bbe\u7f6e\u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3aTERMINATED\u72b6\u6001\u3002\n                    ctl.set(ctlOf(TERMINATED, 0));\n                    // \u3010\u5524\u9192\u6240\u6709\u8c03\u7528 awaitTermination() \u65b9\u6cd5\u7684\u7ebf\u7a0b\u3011\n                    termination.signalAll();\n                }\n                return;\n            }\n        } finally {\n\t\t\t// \u91ca\u653e\u7ebf\u7a0b\u6c60\u5168\u5c40\u9501\n            mainLock.unlock();\n        }\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"future",children:"Future"}),"\n",(0,r.jsx)(e.h5,{id:"\u7ebf\u7a0b\u4f7f\u7528",children:"\u7ebf\u7a0b\u4f7f\u7528"}),"\n",(0,r.jsx)(e.p,{children:"FutureTask \u672a\u6765\u4efb\u52a1\u5bf9\u8c61\uff0c\u7ee7\u627f Runnable\u3001Future \u63a5\u53e3\uff0c\u7528\u4e8e\u5305\u88c5 Callable \u5bf9\u8c61\uff0c\u5b9e\u73b0\u4efb\u52a1\u7684\u63d0\u4ea4"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws ExecutionException, InterruptedException {\n    FutureTask<String> task = new FutureTask<>(new Callable<String>() {\n        @Override\n        public String call() throws Exception {\n            return "Hello World";\n        }\n    });\n    new Thread(task).start();\t//\u542f\u52a8\u7ebf\u7a0b\n    String msg = task.get();\t//\u83b7\u53d6\u8fd4\u56de\u4efb\u52a1\u6570\u636e\n    System.out.println(msg);\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public FutureTask(Callable<V> callable){\n\tthis.callable = callable;\t// \u5c5e\u6027\u6ce8\u5165\n    this.state = NEW; \t\t\t// \u4efb\u52a1\u72b6\u6001\u8bbe\u7f6e\u4e3a new\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public FutureTask(Runnable runnable, V result) {\n    // \u9002\u914d\u5668\u6a21\u5f0f\n    this.callable = Executors.callable(runnable, result);\n    this.state = NEW;       \n}\npublic static <T> Callable<T> callable(Runnable task, T result) {\n    if (task == null) throw new NullPointerException();\n    // \u4f7f\u7528\u88c5\u9970\u8005\u6a21\u5f0f\u5c06 runnable \u8f6c\u6362\u6210 callable \u63a5\u53e3\uff0c\u5916\u90e8\u7ebf\u7a0b\u901a\u8fc7 get \u83b7\u53d6\n    // \u5f53\u524d\u4efb\u52a1\u6267\u884c\u7ed3\u679c\u65f6\uff0c\u7ed3\u679c\u53ef\u80fd\u4e3a null \u4e5f\u53ef\u80fd\u4e3a\u4f20\u8fdb\u6765\u7684\u503c\uff0c\u3010\u4f20\u8fdb\u6765\u4ec0\u4e48\u8fd4\u56de\u4ec0\u4e48\u3011\n    return new RunnableAdapter<T>(task, result);\n}\nstatic final class RunnableAdapter<T> implements Callable<T> {\n    final Runnable task;\n    final T result;\n    // \u6784\u9020\u65b9\u6cd5\n    RunnableAdapter(Runnable task, T result) {\n        this.task = task;\n        this.result = result;\n    }\n    public T call() {\n        // \u5b9e\u5219\u8c03\u7528 Runnable#run \u65b9\u6cd5\n        task.run();\n        // \u8fd4\u56de\u503c\u4e3a\u6784\u9020 FutureTask \u5bf9\u8c61\u65f6\u4f20\u5165\u7684\u8fd4\u56de\u503c\u6216\u8005\u662f null\n        return result;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u5c5e\u6027-3",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsx)(e.p,{children:"FutureTask \u7c7b\u7684\u6210\u5458\u5c5e\u6027\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u72b6\u6001\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8868\u793a\u5f53\u524dtask\u72b6\u6001\nprivate volatile int state;\n// \u5f53\u524d\u4efb\u52a1\u5c1a\u672a\u6267\u884c\nprivate static final int NEW          = 0;\n// \u5f53\u524d\u4efb\u52a1\u6b63\u5728\u7ed3\u675f\uff0c\u5c1a\u672a\u5b8c\u5168\u7ed3\u675f\uff0c\u4e00\u79cd\u4e34\u754c\u72b6\u6001\nprivate static final int COMPLETING   = 1;\n// \u5f53\u524d\u4efb\u52a1\u6b63\u5e38\u7ed3\u675f\nprivate static final int NORMAL       = 2;\n// \u5f53\u524d\u4efb\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u53d1\u751f\u4e86\u5f02\u5e38\uff0c\u5185\u90e8\u5c01\u88c5\u7684 callable.run() \u5411\u4e0a\u629b\u51fa\u5f02\u5e38\u4e86\nprivate static final int EXCEPTIONAL  = 3;\n// \u5f53\u524d\u4efb\u52a1\u88ab\u53d6\u6d88\nprivate static final int CANCELLED    = 4;\n// \u5f53\u524d\u4efb\u52a1\u4e2d\u65ad\u4e2d\nprivate static final int INTERRUPTING = 5;\n// \u5f53\u524d\u4efb\u52a1\u5df2\u4e2d\u65ad\nprivate static final int INTERRUPTED  = 6;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u5bf9\u8c61\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private Callable<V> callable;\t// Runnable \u4f7f\u7528\u88c5\u9970\u8005\u6a21\u5f0f\u4f2a\u88c5\u6210 Callable\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u5b58\u50a8\u4efb\u52a1\u6267\u884c\u7684\u7ed3\u679c"}),"\uff0c\u8fd9\u662f run \u65b9\u6cd5\u8fd4\u56de\u503c\u662f void \u4e5f\u53ef\u4ee5\u83b7\u53d6\u5230\u6267\u884c\u7ed3\u679c\u7684\u539f\u56e0\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u6b63\u5e38\u60c5\u51b5\u4e0b\uff1a\u4efb\u52a1\u6b63\u5e38\u6267\u884c\u7ed3\u675f\uff0coutcome \u4fdd\u5b58\u6267\u884c\u7ed3\u679c\uff0ccallable \u8fd4\u56de\u503c\n// \u975e\u6b63\u5e38\u60c5\u51b5\uff1acallable \u5411\u4e0a\u629b\u51fa\u5f02\u5e38\uff0coutcome \u4fdd\u5b58\u5f02\u5e38\nprivate Object outcome; \n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6267\u884c\u5f53\u524d\u4efb\u52a1\u7684\u7ebf\u7a0b\u5bf9\u8c61\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private volatile Thread runner;\t// \u5f53\u524d\u4efb\u52a1\u88ab\u7ebf\u7a0b\u6267\u884c\u671f\u95f4\uff0c\u4fdd\u5b58\u5f53\u524d\u6267\u884c\u4efb\u52a1\u7684\u7ebf\u7a0b\u5bf9\u8c61\u5f15\u7528\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u963b\u585e\u961f\u5217\u7684\u5934\u8282\u70b9"}),"\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u4f1a\u6709\u5f88\u591a\u7ebf\u7a0b\u53bb get \u5f53\u524d\u4efb\u52a1\u7684\u7ed3\u679c\uff0c\u8fd9\u91cc\u4f7f\u7528\u4e86\u4e00\u79cd\u6570\u636e\u7ed3\u6784\u5934\u63d2\u5934\u53d6\uff08\u7c7b\u4f3c\u6808\uff09\u7684\u4e00\u4e2a\u961f\u5217\u6765\u4fdd\u5b58\u6240\u6709\u7684 get \u7ebf\u7a0b\nprivate volatile WaitNode waiters;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5185\u90e8\u7c7b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final class WaitNode {\n    // \u5355\u5411\u94fe\u8868\n    volatile Thread thread;\n    volatile WaitNode next;\n    WaitNode() { thread = Thread.currentThread(); }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u65b9\u6cd5-3",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"FutureTask \u7c7b\u7684\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"FutureTask#run"}),"\uff1a\u4efb\u52a1\u6267\u884c\u5165\u53e3"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void run() {\n    //\u6761\u4ef6\u4e00\uff1a\u6210\u7acb\u8bf4\u660e\u5f53\u524d task \u5df2\u7ecf\u88ab\u6267\u884c\u8fc7\u4e86\u6216\u8005\u88ab cancel \u4e86\uff0c\u975e NEW \u72b6\u6001\u7684\u4efb\u52a1\uff0c\u7ebf\u7a0b\u5c31\u4e0d\u9700\u8981\u5904\u7406\u4e86\n    //\u6761\u4ef6\u4e8c\uff1a\u7ebf\u7a0b\u662f NEW \u72b6\u6001\uff0c\u5c1d\u8bd5\u8bbe\u7f6e\u5f53\u524d\u4efb\u52a1\u5bf9\u8c61\u7684\u7ebf\u7a0b\u662f\u5f53\u524d\u7ebf\u7a0b\uff0c\u8bbe\u7f6e\u5931\u8d25\u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u62a2\u5360\u4e86\u8be5\u4efb\u52a1\uff0c\u76f4\u63a5\u8fd4\u56de\n    if (state != NEW ||\n        !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread()))\n        return;\n    try {\n        // \u6267\u884c\u5230\u8fd9\u91cc\uff0c\u5f53\u524d task \u4e00\u5b9a\u662f NEW \u72b6\u6001\uff0c\u800c\u4e14\u3010\u5f53\u524d\u7ebf\u7a0b\u4e5f\u62a2\u5360 task \u6210\u529f\u3011\n        Callable<V> c = callable;\n        // \u5224\u65ad\u4efb\u52a1\u662f\u5426\u4e3a\u7a7a\uff0c\u9632\u6b62\u7a7a\u6307\u9488\u5f02\u5e38\uff1b\u5224\u65ad state \u72b6\u6001\uff0c\u9632\u6b62\u5916\u90e8\u7ebf\u7a0b\u5728\u6b64\u671f\u95f4 cancel \u6389\u5f53\u524d\u4efb\u52a1\n        // \u3010\u56e0\u4e3a task \u7684\u6267\u884c\u8005\u5df2\u7ecf\u8bbe\u7f6e\u4e3a\u5f53\u524d\u7ebf\u7a0b\uff0c\u6240\u4ee5\u8fd9\u91cc\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u3011\n        if (c != null && state == NEW) {\n            V result;\n            // true \u8868\u793a callable.run \u4ee3\u7801\u5757\u6267\u884c\u6210\u529f \u672a\u629b\u51fa\u5f02\u5e38\n            // false \u8868\u793a callable.run \u4ee3\u7801\u5757\u6267\u884c\u5931\u8d25 \u629b\u51fa\u5f02\u5e38\n            boolean ran;\n            try {\n\t\t\t\t// \u3010\u8c03\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u6cd5\uff0c\u6267\u884c\u7ed3\u679c\u8d4b\u503c\u7ed9 result\u3011\n                result = c.call();\n                // \u6ca1\u6709\u51fa\u73b0\u5f02\u5e38\n                ran = true;\n            } catch (Throwable ex) {\n                // \u51fa\u73b0\u5f02\u5e38\uff0c\u8fd4\u56de\u503c\u7f6e\u7a7a\uff0cran \u7f6e\u4e3a false\n                result = null;\n                ran = false;\n                // \u8bbe\u7f6e\u8fd4\u56de\u7684\u5f02\u5e38\n                setException(ex);\n            }\n            // \u4ee3\u7801\u5757\u6267\u884c\u6b63\u5e38\n            if (ran)\n                // \u8bbe\u7f6e\u8fd4\u56de\u7684\u7ed3\u679c\n                set(result);\n        }\n    } finally {\n        // \u4efb\u52a1\u6267\u884c\u5b8c\u6210\uff0c\u53d6\u6d88\u7ebf\u7a0b\u7684\u5f15\u7528\uff0chelp GC\n        runner = null;\n        int s = state;\n        // \u5224\u65ad\u4efb\u52a1\u662f\u4e0d\u662f\u88ab\u4e2d\u65ad\n        if (s >= INTERRUPTING)\n            // \u6267\u884c\u4e2d\u65ad\u5904\u7406\u65b9\u6cd5\n            handlePossibleCancellationInterrupt(s);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"FutureTask#set\uff1a\u8bbe\u7f6e\u6b63\u5e38\u8fd4\u56de\u503c\uff0c\u9996\u5148\u5c06\u4efb\u52a1\u72b6\u6001\u8bbe\u7f6e\u4e3a COMPLETING \u72b6\u6001\u4ee3\u8868\u5b8c\u6210\u4e2d\uff0c\u903b\u8f91\u6267\u884c\u5b8c\u8bbe\u7f6e\u4e3a NORMAL \u72b6\u6001\u4ee3\u8868\u4efb\u52a1\u6b63\u5e38\u6267\u884c\u5b8c\u6210\uff0c\u6700\u540e\u5524\u9192 get() \u963b\u585e\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected void set(V v) {\n    // CAS \u65b9\u5f0f\u8bbe\u7f6e\u5f53\u524d\u4efb\u52a1\u72b6\u6001\u4e3a\u5b8c\u6210\u4e2d\uff0c\u8bbe\u7f6e\u5931\u8d25\u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u53d6\u6d88\u4e86\u8be5\u4efb\u52a1\n    if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n        // \u3010\u5c06\u7ed3\u679c\u8d4b\u503c\u7ed9 outcome\u3011\n        outcome = v;\n        // \u5c06\u5f53\u524d\u4efb\u52a1\u72b6\u6001\u4fee\u6539\u4e3a NORMAL \u6b63\u5e38\u7ed3\u675f\u72b6\u6001\u3002\n        UNSAFE.putOrderedInt(this, stateOffset, NORMAL);\n        finishCompletion();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"FutureTask#setException\uff1a\u8bbe\u7f6e\u5f02\u5e38\u8fd4\u56de\u503c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected void setException(Throwable t) {\n    if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n        // \u8d4b\u503c\u7ed9\u8fd4\u56de\u7ed3\u679c\uff0c\u7528\u6765\u5411\u4e0a\u5c42\u629b\u51fa\u6765\u7684\u5f02\u5e38\n        outcome = t;\n        // \u5c06\u5f53\u524d\u4efb\u52a1\u7684\u72b6\u6001 \u4fee\u6539\u4e3a EXCEPTIONAL\n        UNSAFE.putOrderedInt(this, stateOffset, EXCEPTIONAL);\n        finishCompletion();\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["FutureTask#finishCompletion\uff1a",(0,r.jsx)(e.strong,{children:"\u5524\u9192 get() \u963b\u585e\u7ebf\u7a0b"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void finishCompletion() {\n    // \u904d\u5386\u6240\u6709\u7684\u7b49\u5f85\u7684\u8282\u70b9\uff0cq \u6307\u5411\u5934\u8282\u70b9\n    for (WaitNode q; (q = waiters) != null;) {\n        // \u4f7f\u7528cas\u8bbe\u7f6e waiters \u4e3a null\uff0c\u9632\u6b62\u5916\u90e8\u7ebf\u7a0b\u4f7f\u7528cancel\u53d6\u6d88\u5f53\u524d\u4efb\u52a1\uff0c\u89e6\u53d1finishCompletion\u65b9\u6cd5\u91cd\u590d\u6267\u884c\n        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\n            // \u81ea\u65cb\n            for (;;) {\n                // \u83b7\u53d6\u5f53\u524d WaitNode \u8282\u70b9\u5c01\u88c5\u7684 thread\n                Thread t = q.thread;\n                // \u5f53\u524d\u7ebf\u7a0b\u4e0d\u4e3a null\uff0c\u5524\u9192\u5f53\u524d get() \u7b49\u5f85\u83b7\u53d6\u6570\u636e\u7684\u7ebf\u7a0b\n                if (t != null) {\n                    q.thread = null;\n                    LockSupport.unpark(t);\n                }\n                // \u83b7\u53d6\u5f53\u524d\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\n                WaitNode next = q.next;\n                // \u5f53\u524d\u8282\u70b9\u662f\u6700\u540e\u4e00\u4e2a\u8282\u70b9\u4e86\n                if (next == null)\n                    break;\n                // \u65ad\u5f00\u94fe\u8868\n                q.next = null; // help gc\n                q = next;\n            }\n            break;\n        }\n    }\n    done();\n    callable = null;\t// help GC\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"FutureTask#handlePossibleCancellationInterrupt\uff1a\u4efb\u52a1\u4e2d\u65ad\u5904\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void handlePossibleCancellationInterrupt(int s) {\n    if (s == INTERRUPTING)\n        // \u4e2d\u65ad\u72b6\u6001\u4e2d\n        while (state == INTERRUPTING)\n            // \u7b49\u5f85\u4e2d\u65ad\u5b8c\u6210\n            Thread.yield();\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"FutureTask#get"}),"\uff1a\u83b7\u53d6\u4efb\u52a1\u6267\u884c\u7684\u8fd4\u56de\u503c\uff0c\u6267\u884c run \u548c get \u7684\u4e0d\u662f\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e00\u822c\u6709\u591a\u4e2a\u7ebf\u7a0b get\uff0c\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b run"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public V get() throws InterruptedException, ExecutionException {\n    // \u83b7\u53d6\u5f53\u524d\u4efb\u52a1\u72b6\u6001\n    int s = state;\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u4efb\u52a1\u8fd8\u6ca1\u6267\u884c\u5b8c\u6210\n    if (s <= COMPLETING)\n        // \u8fd4\u56de task \u5f53\u524d\u72b6\u6001\uff0c\u53ef\u80fd\u5f53\u524d\u7ebf\u7a0b\u5728\u91cc\u9762\u5df2\u7ecf\u7761\u4e86\u4e00\u4f1a\n        s = awaitDone(false, 0L);\n    return report(s);\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["FutureTask#awaitDone\uff1a",(0,r.jsx)(e.strong,{children:"get \u7ebf\u7a0b\u5c01\u88c5\u6210 WaitNode \u5bf9\u8c61\u8fdb\u5165\u963b\u585e\u961f\u5217\u963b\u585e\u7b49\u5f85"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private int awaitDone(boolean timed, long nanos) throws InterruptedException {\n    // 0 \u4e0d\u5e26\u8d85\u65f6\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    // \u5f15\u7528\u5f53\u524d\u7ebf\u7a0b\uff0c\u5c01\u88c5\u6210 WaitNode \u5bf9\u8c61\n    WaitNode q = null;\n    // \u8868\u793a\u5f53\u524d\u7ebf\u7a0b waitNode \u5bf9\u8c61\uff0c\u662f\u5426\u8fdb\u5165\u963b\u585e\u961f\u5217\n    boolean queued = false;\n    // \u3010\u4e09\u6b21\u81ea\u65cb\u5f00\u59cb\u4f11\u7720\u3011\n    for (;;) {\n        // \u5224\u65ad\u5f53\u524d get() \u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u6253\u65ad\u8fd4\u56de true\uff0c\u6e05\u9664\u6253\u65ad\u6807\u8bb0\n        if (Thread.interrupted()) {\n            // \u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u7684\u7b49\u5f85 node \u51fa\u961f\uff0c\n            removeWaiter(q);\n            throw new InterruptedException();\n        }\n\t\t// \u83b7\u53d6\u4efb\u52a1\u72b6\u6001\n        int s = state;\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u5df2\u7ecf\u6709\u7ed3\u679c\u4e86\n        if (s > COMPLETING) {\n            // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5df2\u7ecf\u4e3a\u5f53\u524d\u7ebf\u7a0b\u521b\u5efa\u4e86 WaitNode\uff0c\u7f6e\u7a7a help GC\n            if (q != null)\n                q.thread = null;\n            // \u8fd4\u56de\u5f53\u524d\u7684\u72b6\u6001\n            return s;\n        }\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u4efb\u52a1\u63a5\u8fd1\u5b8c\u6210\u72b6\u6001\uff0c\u8fd9\u91cc\u8ba9\u5f53\u524d\u7ebf\u7a0b\u91ca\u653e\u4e00\u4e0b cpu \uff0c\u7b49\u5f85\u8fdb\u884c\u4e0b\u4e00\u6b21\u62a2\u5360 cpu\n        else if (s == COMPLETING) \n            Thread.yield();\n        // \u3010\u7b2c\u4e00\u6b21\u81ea\u65cb\u3011\uff0c\u5f53\u524d\u7ebf\u7a0b\u8fd8\u672a\u521b\u5efa WaitNode \u5bf9\u8c61\uff0c\u6b64\u65f6\u4e3a\u5f53\u524d\u7ebf\u7a0b\u521b\u5efa WaitNode\u5bf9\u8c61\n        else if (q == null)\n            q = new WaitNode();\n        // \u3010\u7b2c\u4e8c\u6b21\u81ea\u65cb\u3011\uff0c\u5f53\u524d\u7ebf\u7a0b\u5df2\u7ecf\u521b\u5efa WaitNode \u5bf9\u8c61\u4e86\uff0c\u4f46\u662fnode\u5bf9\u8c61\u8fd8\u672a\u5165\u961f\n        else if (!queued)\n            // waiters \u6307\u5411\u961f\u9996\uff0c\u8ba9\u5f53\u524d WaitNode \u6210\u4e3a\u65b0\u7684\u961f\u9996\uff0c\u3010\u5934\u63d2\u6cd5\u3011\uff0c\u5931\u8d25\u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u4fee\u6539\u4e86\u65b0\u7684\u961f\u9996\n            queued = UNSAFE.compareAndSwapObject(this, waitersOffset, q.next = waiters, q);\n        // \u3010\u7b2c\u4e09\u6b21\u81ea\u65cb\u3011\uff0c\u4f1a\u5230\u8fd9\u91cc\uff0c\u6216\u8005 else \u5185\n        else if (timed) {\n            nanos = deadline - System.nanoTime();\n            if (nanos <= 0L) {\n                removeWaiter(q);\n                return state;\n            }\n            // \u963b\u585e\u6307\u5b9a\u7684\u65f6\u95f4\n            LockSupport.parkNanos(this, nanos);\n        }\n        // \u6761\u4ef6\u6210\u7acb\uff1a\u8bf4\u660e\u9700\u8981\u963b\u585e\n        else\n            // \u3010\u5f53\u524d get \u64cd\u4f5c\u7684\u7ebf\u7a0b\u88ab park \u963b\u585e\u3011\uff0c\u9664\u975e\u6709\u5176\u5b83\u7ebf\u7a0b\u5c06\u5524\u9192\u6216\u8005\u5c06\u5f53\u524d\u7ebf\u7a0b\u4e2d\u65ad\n            LockSupport.park(this);\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["FutureTask#report\uff1a\u5c01\u88c5\u8fd0\u884c\u7ed3\u679c\uff0c\u53ef\u4ee5\u83b7\u53d6 run() \u65b9\u6cd5\u4e2d\u8bbe\u7f6e\u7684\u6210\u5458\u53d8\u91cf outcome\uff0c",(0,r.jsx)(e.strong,{children:"\u8fd9\u662f run \u65b9\u6cd5\u7684\u8fd4\u56de\u503c\u662f void \u4e5f\u53ef\u4ee5\u83b7\u53d6\u5230\u4efb\u52a1\u6267\u884c\u7684\u7ed3\u679c\u7684\u539f\u56e0"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private V report(int s) throws ExecutionException {\n    // \u83b7\u53d6\u6267\u884c\u7ed3\u679c\uff0c\u662f\u5728\u4e00\u4e2a futuretask \u5bf9\u8c61\u4e2d\u7684\u5c5e\u6027\uff0c\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\n    Object x = outcome;\n    // \u5f53\u524d\u4efb\u52a1\u72b6\u6001\u6b63\u5e38\u7ed3\u675f\n    if (s == NORMAL)\n        return (V)x;\t// \u76f4\u63a5\u8fd4\u56de callable \u7684\u903b\u8f91\u7ed3\u679c\n    // \u5f53\u524d\u4efb\u52a1\u88ab\u53d6\u6d88\u6216\u8005\u4e2d\u65ad\n    if (s >= CANCELLED)\n        throw new CancellationException();\t\t// \u629b\u51fa\u5f02\u5e38\n    // \u6267\u884c\u5230\u8fd9\u91cc\u8bf4\u660e\u81ea\u5b9a\u4e49\u7684 callable \u4e2d\u7684\u65b9\u6cd5\u6709\u5f02\u5e38\uff0c\u4f7f\u7528 outcome \u4e0a\u5c42\u629b\u51fa\u5f02\u5e38\n    throw new ExecutionException((Throwable)x);\t\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"FutureTask#cancel\uff1a\u4efb\u52a1\u53d6\u6d88\uff0c\u6253\u65ad\u6b63\u5728\u6267\u884c\u8be5\u4efb\u52a1\u7684\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean cancel(boolean mayInterruptIfRunning) {\n    // \u6761\u4ef6\u4e00\uff1a\u8868\u793a\u5f53\u524d\u4efb\u52a1\u5904\u4e8e\u8fd0\u884c\u4e2d\u6216\u8005\u5904\u4e8e\u7ebf\u7a0b\u6c60\u4efb\u52a1\u961f\u5217\u4e2d\n    // \u6761\u4ef6\u4e8c\uff1a\u8868\u793a\u4fee\u6539\u72b6\u6001\uff0c\u6210\u529f\u53ef\u4ee5\u53bb\u6267\u884c\u4e0b\u9762\u903b\u8f91\uff0c\u5426\u5219\u8fd4\u56de false \u8868\u793a cancel \u5931\u8d25\n    if (!(state == NEW &&\n          UNSAFE.compareAndSwapInt(this, stateOffset, NEW,\n                                   mayInterruptIfRunning ? INTERRUPTING : CANCELLED)))\n        return false;\n    try {\n        // \u5982\u679c\u4efb\u52a1\u5df2\u7ecf\u88ab\u6267\u884c\uff0c\u662f\u5426\u5141\u8bb8\u6253\u65ad\n        if (mayInterruptIfRunning) {\n            try {\n                // \u83b7\u53d6\u6267\u884c\u5f53\u524d FutureTask \u7684\u7ebf\u7a0b\n                Thread t = runner;\n                if (t != null)\n                    // \u6253\u65ad\u6267\u884c\u7684\u7ebf\u7a0b\n                    t.interrupt();\n            } finally {\n                // \u8bbe\u7f6e\u4efb\u52a1\u72b6\u6001\u4e3a\u3010\u4e2d\u65ad\u5b8c\u6210\u3011\n                UNSAFE.putOrderedInt(this, stateOffset, INTERRUPTED);\n            }\n        }\n    } finally {\n        // \u5524\u9192\u6240\u6709 get() \u963b\u585e\u7684\u7ebf\u7a0b\n        finishCompletion();\n    }\n    return true;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u4efb\u52a1\u8c03\u5ea6",children:"\u4efb\u52a1\u8c03\u5ea6"}),"\n",(0,r.jsx)(e.h4,{id:"timer",children:"Timer"}),"\n",(0,r.jsx)(e.p,{children:"Timer \u5b9e\u73b0\u5b9a\u65f6\u529f\u80fd\uff0cTimer \u7684\u4f18\u70b9\u5728\u4e8e\u7b80\u5355\u6613\u7528\uff0c\u4f46\u7531\u4e8e\u6240\u6709\u4efb\u52a1\u90fd\u662f\u7531\u540c\u4e00\u4e2a\u7ebf\u7a0b\u6765\u8c03\u5ea6\uff0c\u56e0\u6b64\u6240\u6709\u4efb\u52a1\u90fd\u662f\u4e32\u884c\u6267\u884c\u7684\uff0c\u540c\u4e00\u65f6\u95f4\u53ea\u80fd\u6709\u4e00\u4e2a\u4efb\u52a1\u5728\u6267\u884c\uff0c\u524d\u4e00\u4e2a\u4efb\u52a1\u7684\u5ef6\u8fdf\u6216\u5f02\u5e38\u90fd\u5c06\u4f1a\u5f71\u54cd\u5230\u4e4b\u540e\u7684\u4efb\u52a1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'private static void method1() {\n    Timer timer = new Timer();\n    TimerTask task1 = new TimerTask() {\n        @Override\n        public void run() {\n            System.out.println("task 1");\n            //int i = 1 / 0;//\u4efb\u52a1\u4e00\u7684\u51fa\u9519\u4f1a\u5bfc\u81f4\u4efb\u52a1\u4e8c\u65e0\u6cd5\u6267\u884c\n            Thread.sleep(2000);\n        }\n    };\n    TimerTask task2 = new TimerTask() {\n        @Override\n        public void run() {\n            System.out.println("task 2");\n        }\n    };\n    // \u4f7f\u7528 timer \u6dfb\u52a0\u4e24\u4e2a\u4efb\u52a1\uff0c\u5e0c\u671b\u5b83\u4eec\u90fd\u5728 1s \u540e\u6267\u884c\n\t// \u4f46\u7531\u4e8e timer \u5185\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6765\u987a\u5e8f\u6267\u884c\u961f\u5217\u4e2d\u7684\u4efb\u52a1\uff0c\u56e0\u6b64\u4efb\u52a11\u7684\u5ef6\u65f6\uff0c\u5f71\u54cd\u4e86\u4efb\u52a12\u7684\u6267\u884c\n    timer.schedule(task1, 1000);//17:45:56 c.ThreadPool [Timer-0] - task 1\n    timer.schedule(task2, 1000);//17:45:58 c.ThreadPool [Timer-0] - task 2\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"scheduled",children:"Scheduled"}),"\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u8c03\u5ea6\u7ebf\u7a0b\u6c60 ScheduledThreadPoolExecutor \u7ee7\u627f ThreadPoolExecutor\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u5185\u90e8\u7c7b ScheduledFutureTask \u5c01\u88c5\u4efb\u52a1"}),"\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u5185\u90e8\u7c7b DelayedWorkQueue \u4f5c\u4e3a\u7ebf\u7a0b\u6c60\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"\u91cd\u5199 onShutdown \u65b9\u6cd5\u53bb\u5904\u7406 shutdown \u540e\u7684\u4efb\u52a1"}),"\n",(0,r.jsx)(e.li,{children:"\u63d0\u4f9b decorateTask \u65b9\u6cd5\u4f5c\u4e3a ScheduledFutureTask \u7684\u4fee\u9970\u65b9\u6cd5\uff0c\u4ee5\u4fbf\u5f00\u53d1\u8005\u8fdb\u884c\u6269\u5c55"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u6784\u9020\u65b9\u6cd5\uff1a",(0,r.jsx)(e.code,{children:"Executors.newScheduledThreadPool(int corePoolSize)"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ScheduledThreadPoolExecutor(int corePoolSize) {\n    // \u6700\u5927\u7ebf\u7a0b\u6570\u56fa\u5b9a\u4e3a Integer.MAX_VALUE\uff0c\u4fdd\u6d3b\u65f6\u95f4 keepAliveTime \u56fa\u5b9a\u4e3a 0\n    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,\n          // \u963b\u585e\u961f\u5217\u662f DelayedWorkQueue\n          new DelayedWorkQueue());\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528 API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"ScheduledFuture<?> schedule(Runnable/Callable<V>, long delay, TimeUnit u)"}),"\uff1a\u5ef6\u8fdf\u6267\u884c\u4efb\u52a1"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"ScheduledFuture<?> scheduleAtFixedRate(Runnable/Callable<V>, long initialDelay, long period, TimeUnit unit)"}),"\uff1a\u5b9a\u65f6\u6267\u884c\u5468\u671f\u4efb\u52a1\uff0c\u4e0d\u8003\u8651\u6267\u884c\u7684\u8017\u65f6\uff0c\u53c2\u6570\u4e3a\u521d\u59cb\u5ef6\u8fdf\u65f6\u95f4\u3001\u95f4\u9694\u65f6\u95f4\u3001\u5355\u4f4d"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"ScheduledFuture<?> scheduleWithFixedDelay(Runnable/Callable<V>, long initialDelay, long delay, TimeUnit unit)"}),"\uff1a\u5b9a\u65f6\u6267\u884c\u5468\u671f\u4efb\u52a1\uff0c\u8003\u8651\u6267\u884c\u7684\u8017\u65f6\uff0c\u53c2\u6570\u4e3a\u521d\u59cb\u5ef6\u8fdf\u65f6\u95f4\u3001\u95f4\u9694\u65f6\u95f4\u3001\u5355\u4f4d"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u57fa\u672c\u4f7f\u7528\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5ef6\u8fdf\u4efb\u52a1\uff0c\u4f46\u662f\u51fa\u73b0\u5f02\u5e38\u5e76\u4e0d\u4f1a\u5728\u63a7\u5236\u53f0\u6253\u5370\uff0c\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u7ebf\u7a0b\u7684\u6267\u884c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args){\n    // \u7ebf\u7a0b\u6c60\u5927\u5c0f\u4e3a1\u65f6\u4e5f\u662f\u4e32\u884c\u6267\u884c\n    ScheduledExecutorService executor = Executors.newScheduledThreadPool(2);\n    // \u6dfb\u52a0\u4e24\u4e2a\u4efb\u52a1\uff0c\u90fd\u5728 1s \u540e\u540c\u65f6\u6267\u884c\n    executor.schedule(() -> {\n    \tSystem.out.println("\u4efb\u52a11\uff0c\u6267\u884c\u65f6\u95f4\uff1a" + new Date());\n        //int i = 1 / 0;\n    \ttry { Thread.sleep(2000); } catch (InterruptedException e) { }\n    }, 1000, TimeUnit.MILLISECONDS);\n    \n    executor.schedule(() -> {\n    \tSystem.out.println("\u4efb\u52a12\uff0c\u6267\u884c\u65f6\u95f4\uff1a" + new Date());\n    }, 1000, TimeUnit.MILLISECONDS);\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5b9a\u65f6\u4efb\u52a1 scheduleAtFixedRate\uff1a",(0,r.jsx)(e.strong,{children:"\u4e00\u6b21\u4efb\u52a1\u7684\u542f\u52a8\u5230\u4e0b\u4e00\u6b21\u4efb\u52a1\u7684\u542f\u52a8"}),"\u4e4b\u95f4\u53ea\u8981\u5927\u4e8e\u7b49\u4e8e\u95f4\u9694\u65f6\u95f4\uff0c\u62a2\u5360\u5230 CPU \u5c31\u4f1a\u7acb\u5373\u6267\u884c"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ScheduledExecutorService pool = Executors.newScheduledThreadPool(1);\n    System.out.println("start..." + new Date());\n    \n    pool.scheduleAtFixedRate(() -> {\n        System.out.println("running..." + new Date());\n        Thread.sleep(2000);\n    }, 1, 1, TimeUnit.SECONDS);\n}\n\n/*start...Sat Apr 24 18:08:12 CST 2021\nrunning...Sat Apr 24 18:08:13 CST 2021\nrunning...Sat Apr 24 18:08:15 CST 2021\nrunning...Sat Apr 24 18:08:17 CST 2021\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5b9a\u65f6\u4efb\u52a1 scheduleWithFixedDelay\uff1a",(0,r.jsx)(e.strong,{children:"\u4e00\u6b21\u4efb\u52a1\u7684\u7ed3\u675f\u5230\u4e0b\u4e00\u6b21\u4efb\u52a1\u7684\u542f\u52a8\u4e4b\u95f4"}),"\u7b49\u4e8e\u95f4\u9694\u65f6\u95f4\uff0c\u62a2\u5360\u5230 CPU \u5c31\u4f1a\u7acb\u5373\u6267\u884c\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u624d\u662f\u771f\u6b63\u7684\u8bbe\u7f6e\u4e24\u4e2a\u4efb\u52a1\u4e4b\u95f4\u7684\u95f4\u9694"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args){\n    ScheduledExecutorService pool = Executors.newScheduledThreadPool(3);\n    System.out.println("start..." + new Date());\n    \n    pool.scheduleWithFixedDelay(() -> {\n        System.out.println("running..." + new Date());\n        Thread.sleep(2000);\n    }, 1, 1, TimeUnit.SECONDS);\n}\n/*start...Sat Apr 24 18:11:41 CST 2021\nrunning...Sat Apr 24 18:11:42 CST 2021\nrunning...Sat Apr 24 18:11:45 CST 2021\nrunning...Sat Apr 24 18:11:48 CST 2021\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u5c5e\u6027-4",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u53d8\u91cf-1",children:"\u6210\u5458\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"shutdown \u540e\u662f\u5426\u7ee7\u7eed\u6267\u884c\u5468\u671f\u4efb\u52a1\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private volatile boolean continueExistingPeriodicTasksAfterShutdown;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"shutdown \u540e\u662f\u5426\u7ee7\u7eed\u6267\u884c\u5ef6\u8fdf\u4efb\u52a1\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private volatile boolean executeExistingDelayedTasksAfterShutdown = true;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u53d6\u6d88\u65b9\u6cd5\u662f\u5426\u5c06\u8be5\u4efb\u52a1\u4ece\u961f\u5217\u4e2d\u79fb\u9664\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u9ed8\u8ba4 false\uff0c\u4e0d\u79fb\u9664\uff0c\u7b49\u5230\u7ebf\u7a0b\u62ff\u5230\u4efb\u52a1\u4e4b\u540e\u629b\u5f03\nprivate volatile boolean removeOnCancel = false;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u7684\u5e8f\u5217\u53f7\uff0c\u53ef\u4ee5\u7528\u6765\u6bd4\u8f83\u4f18\u5148\u7ea7\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final AtomicLong sequencer = new AtomicLong();\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5ef6\u8fdf\u4efb\u52a1",children:"\u5ef6\u8fdf\u4efb\u52a1"}),"\n",(0,r.jsxs)(e.p,{children:["ScheduledFutureTask \u7ee7\u627f FutureTask\uff0c\u5b9e\u73b0 RunnableScheduledFuture \u63a5\u53e3\uff0c\u5177\u6709\u5ef6\u8fdf\u6267\u884c\u7684\u7279\u70b9\uff0c\u8986\u76d6 FutureTask \u7684 run \u65b9\u6cd5\u6765\u5b9e\u73b0\u5bf9",(0,r.jsx)(e.strong,{children:"\u5ef6\u65f6\u6267\u884c\u3001\u5468\u671f\u6267\u884c"}),"\u7684\u652f\u6301\u3002\u5bf9\u4e8e\u5ef6\u65f6\u4efb\u52a1\u8c03\u7528 FutureTask#run\uff0c\u800c\u5bf9\u4e8e\u5468\u671f\u6027\u4efb\u52a1\u5219\u8c03\u7528 FutureTask#runAndReset \u5e76\u4e14\u5728\u6210\u529f\u4e4b\u540e\u6839\u636e fixed-delay/fixed-rate \u6a21\u5f0f\u6765\u8bbe\u7f6e\u4e0b\u6b21\u6267\u884c\u65f6\u95f4\u5e76\u91cd\u65b0\u5c06\u4efb\u52a1\u585e\u5230\u5de5\u4f5c\u961f\u5217"]}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u8c03\u5ea6\u7ebf\u7a0b\u6c60\u4e2d\u65e0\u8bba\u662f runnable \u8fd8\u662f callable\uff0c\u65e0\u8bba\u662f\u5426\u9700\u8981\u5ef6\u8fdf\u548c\u5b9a\u65f6\uff0c\u6240\u6709\u7684\u4efb\u52a1\u90fd\u4f1a\u88ab\u5c01\u88c5\u6210 ScheduledFutureTask"}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u5e8f\u5217\u53f7\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final long sequenceNumber;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6267\u884c\u65f6\u95f4\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private long time;\t\t\t// \u4efb\u52a1\u53ef\u4ee5\u88ab\u6267\u884c\u7684\u65f6\u95f4\uff0c\u4ea4\u4ed8\u65f6\u95f4\uff0c\u4ee5\u7eb3\u79d2\u8868\u793a\nprivate final long period;\t// 0 \u8868\u793a\u975e\u5468\u671f\u4efb\u52a1\uff0c\u6b63\u6570\u8868\u793a fixed-rate \u6a21\u5f0f\u7684\u5468\u671f\uff0c\u8d1f\u6570\u8868\u793a fixed-delay \u6a21\u5f0f\n"})}),"\n",(0,r.jsx)(e.p,{children:"fixed-rate\uff1a\u4e24\u6b21\u5f00\u59cb\u542f\u52a8\u7684\u95f4\u9694\uff0cfixed-delay\uff1a\u4e00\u6b21\u6267\u884c\u7ed3\u675f\u5230\u4e0b\u4e00\u6b21\u5f00\u59cb\u542f\u52a8"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5b9e\u9645\u7684\u4efb\u52a1\u5bf9\u8c61\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"RunnableScheduledFuture<V> outerTask = this;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u5728\u961f\u5217\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15\u4e0b\u6807\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// DelayedWorkQueue \u5e95\u5c42\u4f7f\u7528\u7684\u6570\u636e\u7ed3\u6784\u662f\u6700\u5c0f\u5806\uff0c\u8bb0\u5f55\u5f53\u524d\u4efb\u52a1\u5728\u5806\u4e2d\u7684\u7d22\u5f15\uff0c-1 \u4ee3\u8868\u5220\u9664\nint heapIndex;\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"ScheduledFutureTask(Runnable r, V result, long ns, long period) {\n    super(r, result);\n    // \u4efb\u52a1\u7684\u89e6\u53d1\u65f6\u95f4\n    this.time = ns;\n    // \u4efb\u52a1\u7684\u5468\u671f\uff0c\u591a\u957f\u65f6\u95f4\u6267\u884c\u4e00\u6b21\n    this.period = period;\n    // \u4efb\u52a1\u7684\u5e8f\u53f7\n    this.sequenceNumber = sequencer.getAndIncrement();\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"compareTo()\uff1aScheduledFutureTask \u6839\u636e\u6267\u884c\u65f6\u95f4 time \u6b63\u5e8f\u6392\u5217\uff0c\u5982\u679c\u6267\u884c\u65f6\u95f4\u76f8\u540c\uff0c\u5728\u6309\u7167\u5e8f\u5217\u53f7 sequenceNumber \u6b63\u5e8f\u6392\u5217\uff0c\u4efb\u52a1\u9700\u8981\u653e\u5165 DelayedWorkQueue\uff0c\u5ef6\u8fdf\u961f\u5217\u4e2d\u4f7f\u7528\u8be5\u65b9\u6cd5\u6309\u7167\u4ece\u5c0f\u5230\u5927\u8fdb\u884c\u6392\u5e8f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public int compareTo(Delayed other) {\n    if (other == this) // compare zero if same object\n        return 0;\n    if (other instanceof ScheduledFutureTask) {\n        // \u7c7b\u578b\u5f3a\u8f6c\n        ScheduledFutureTask<?> x = (ScheduledFutureTask<?>)other;\n        // \u6bd4\u8f83\u8005 - \u88ab\u6bd4\u8f83\u8005\u7684\u6267\u884c\u65f6\u95f4\n        long diff = time - x.time;\n        // \u6bd4\u8f83\u8005\u5148\u6267\u884c\n        if (diff < 0)\n            return -1;\n        // \u88ab\u6bd4\u8f83\u8005\u5148\u6267\u884c\n        else if (diff > 0)\n            return 1;\n        // \u6bd4\u8f83\u8005\u7684\u5e8f\u5217\u53f7\u5c0f\n        else if (sequenceNumber < x.sequenceNumber)\n            return -1;\n        else\n            return 1;\n    }\n    // \u4e0d\u662f ScheduledFutureTask \u7c7b\u578b\u65f6\uff0c\u6839\u636e\u5ef6\u8fdf\u65f6\u95f4\u6392\u5e8f\n    long diff = getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS);\n    return (diff < 0) ? -1 : (diff > 0) ? 1 : 0;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["run()\uff1a\u6267\u884c\u4efb\u52a1\uff0c\u975e\u5468\u671f\u4efb\u52a1\u76f4\u63a5\u5b8c\u6210\u76f4\u63a5\u7ed3\u675f\uff0c",(0,r.jsx)(e.strong,{children:"\u5468\u671f\u4efb\u52a1\u6267\u884c\u5b8c\u540e\u4f1a\u8bbe\u7f6e\u4e0b\u4e00\u6b21\u7684\u6267\u884c\u65f6\u95f4\uff0c\u91cd\u65b0\u653e\u5165\u7ebf\u7a0b\u6c60\u7684\u963b\u585e\u961f\u5217"}),"\uff0c\u5982\u679c\u7ebf\u7a0b\u6c60\u4e2d\u7684\u7ebf\u7a0b\u6570\u91cf\u5c11\u4e8e\u6838\u5fc3\u7ebf\u7a0b\uff0c\u5c31\u4f1a\u6dfb\u52a0 Worker \u5f00\u542f\u65b0\u7ebf\u7a0b"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void run() {\n    // \u662f\u5426\u5468\u671f\u6027\uff0c\u5c31\u662f\u5224\u65ad period \u662f\u5426\u4e3a 0\n    boolean periodic = isPeriodic();\n    // \u6839\u636e\u662f\u5426\u662f\u5468\u671f\u4efb\u52a1\u68c0\u67e5\u5f53\u524d\u72b6\u6001\u80fd\u5426\u6267\u884c\u4efb\u52a1\uff0c\u4e0d\u80fd\u6267\u884c\u5c31\u53d6\u6d88\u4efb\u52a1\n    if (!canRunInCurrentRunState(periodic))\n        cancel(false);\n    // \u975e\u5468\u671f\u4efb\u52a1\uff0c\u76f4\u63a5\u8c03\u7528 FutureTask#run \u6267\u884c\n    else if (!periodic)\n        ScheduledFutureTask.super.run();\n    // \u5468\u671f\u4efb\u52a1\u7684\u6267\u884c\uff0c\u8fd4\u56de true \u8868\u793a\u6267\u884c\u6210\u529f\n    else if (ScheduledFutureTask.super.runAndReset()) {\n        // \u8bbe\u7f6e\u5468\u671f\u4efb\u52a1\u7684\u4e0b\u4e00\u6b21\u6267\u884c\u65f6\u95f4\n        setNextRunTime();\n        // \u4efb\u52a1\u7684\u4e0b\u4e00\u6b21\u6267\u884c\u5b89\u6392\uff0c\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u6c60\u72b6\u6001\u53ef\u4ee5\u6267\u884c\u5468\u671f\u4efb\u52a1\uff0c\u52a0\u5165\u961f\u5217\uff0c\u5e76\u5f00\u542f\u65b0\u7ebf\u7a0b\n        reExecutePeriodic(outerTask);\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u5468\u671f\u4efb\u52a1\u6b63\u5e38\u5b8c\u6210\u540e",(0,r.jsx)(e.strong,{children:"\u4efb\u52a1\u7684\u72b6\u6001\u4e0d\u4f1a\u53d8\u5316"}),"\uff0c\u4f9d\u65e7\u662f NEW\uff0c\u4e0d\u4f1a\u8bbe\u7f6e outcome \u5c5e\u6027\u3002\u4f46\u662f\u5982\u679c\u672c\u6b21\u4efb\u52a1\u6267\u884c\u51fa\u73b0\u5f02\u5e38\uff0c\u4f1a\u8fdb\u5165 setException \u65b9\u6cd5\u5c06\u4efb\u52a1\u72b6\u6001\u7f6e\u4e3a\u5f02\u5e38\uff0c\u628a\u5f02\u5e38\u4fdd\u5b58\u5728 outcome \u4e2d\uff0c\u65b9\u6cd5\u8fd4\u56de false\uff0c\u540e\u7eed\u7684\u8be5\u4efb\u52a1\u5c06\u4e0d\u4f1a\u518d\u5468\u671f\u7684\u6267\u884c"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected boolean runAndReset() {\n    // \u4efb\u52a1\u4e0d\u662f\u65b0\u5efa\u7684\u72b6\u6001\u4e86\uff0c\u6216\u8005\u88ab\u522b\u7684\u7ebf\u7a0b\u6267\u884c\u4e86\uff0c\u76f4\u63a5\u8fd4\u56de false\n    if (state != NEW ||\n        !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread()))\n        return false;\n    boolean ran = false;\n    int s = state;\n    try {\n        Callable<V> c = callable;\n        if (c != null && s == NEW) {\n            try {\n                // \u6267\u884c\u65b9\u6cd5\uff0c\u6ca1\u6709\u8fd4\u56de\u503c\n                c.call();\n                ran = true;\n            } catch (Throwable ex) {\n                // \u51fa\u73b0\u5f02\u5e38\uff0c\u628a\u4efb\u52a1\u8bbe\u7f6e\u4e3a\u5f02\u5e38\u72b6\u6001\uff0c\u5524\u9192\u6240\u6709\u7684 get \u963b\u585e\u7ebf\u7a0b\n                setException(ex);\n            }\n        }\n    } finally {\n\t\t// \u6267\u884c\u5b8c\u6210\u628a\u6267\u884c\u7ebf\u7a0b\u5f15\u7528\u7f6e\u4e3a null\n        runner = null;\n        s = state;\n        // \u5982\u679c\u7ebf\u7a0b\u88ab\u4e2d\u65ad\u8fdb\u884c\u4e2d\u65ad\u5904\u7406\n        if (s >= INTERRUPTING)\n            handlePossibleCancellationInterrupt(s);\n    }\n    // \u5982\u679c\u6b63\u5e38\u6267\u884c\uff0c\u8fd4\u56de true\uff0c\u5e76\u4e14\u4efb\u52a1\u72b6\u6001\u6ca1\u6709\u88ab\u53d6\u6d88\n    return ran && s == NEW;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u4efb\u52a1\u4e0b\u4e00\u6b21\u7684\u89e6\u53d1\u65f6\u95f4\nprivate void setNextRunTime() {\n    long p = period;\n    if (p > 0)\n        // fixed-rate \u6a21\u5f0f\uff0c\u3010\u65f6\u95f4\u8bbe\u7f6e\u4e3a\u4e0a\u4e00\u6b21\u6267\u884c\u4efb\u52a1\u7684\u65f6\u95f4 + p\u3011\uff0c\u4e24\u6b21\u4efb\u52a1\u6267\u884c\u7684\u65f6\u95f4\u5dee\n        time += p;\n    else\n        // fixed-delay \u6a21\u5f0f\uff0c\u4e0b\u4e00\u6b21\u6267\u884c\u65f6\u95f4\u662f\u3010\u5f53\u524d\u8fd9\u6b21\u4efb\u52a1\u7ed3\u675f\u7684\u65f6\u95f4\uff08\u5c31\u662f\u73b0\u5728\uff09 + delay \u503c\u3011\n        time = triggerTime(-p);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["reExecutePeriodic()",(0,r.jsx)(e.strong,{children:"\uff1a\u51c6\u5907\u4efb\u52a1\u7684\u4e0b\u4e00\u6b21\u6267\u884c\uff0c\u91cd\u65b0\u653e\u5165\u963b\u585e\u4efb\u52a1\u961f\u5217"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// ScheduledThreadPoolExecutor#reExecutePeriodic\nvoid reExecutePeriodic(RunnableScheduledFuture<?> task) {\n    if (canRunInCurrentRunState(true)) {\n        // \u3010\u653e\u5165\u4efb\u52a1\u961f\u5217\u3011\n        super.getQueue().add(task);\n        // \u5982\u679c\u63d0\u4ea4\u5b8c\u4efb\u52a1\u4e4b\u540e\uff0c\u7ebf\u7a0b\u6c60\u72b6\u6001\u53d8\u4e3a\u4e86 shutdown \u72b6\u6001\uff0c\u9700\u8981\u518d\u6b21\u68c0\u67e5\u662f\u5426\u53ef\u4ee5\u6267\u884c\uff0c\n        // \u5982\u679c\u4e0d\u80fd\u6267\u884c\u4e14\u4efb\u52a1\u8fd8\u5728\u961f\u5217\u4e2d\u672a\u88ab\u53d6\u8d70\uff0c\u5219\u53d6\u6d88\u4efb\u52a1\n        if (!canRunInCurrentRunState(true) && remove(task))\n            task.cancel(false);\n        else\n            // \u5f53\u524d\u7ebf\u7a0b\u6c60\u72b6\u6001\u53ef\u4ee5\u6267\u884c\u5468\u671f\u4efb\u52a1\uff0c\u52a0\u5165\u961f\u5217\uff0c\u5e76\u3010\u6839\u636e\u7ebf\u7a0b\u6570\u91cf\u662f\u5426\u5927\u4e8e\u6838\u5fc3\u7ebf\u7a0b\u6570\u786e\u5b9a\u662f\u5426\u5f00\u542f\u65b0\u7ebf\u7a0b\u3011\n            ensurePrestart();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"cancel()\uff1a\u53d6\u6d88\u4efb\u52a1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean cancel(boolean mayInterruptIfRunning) {\n    // \u8c03\u7528\u7236\u7c7b FutureTask#cancel \u6765\u53d6\u6d88\u4efb\u52a1\n    boolean cancelled = super.cancel(mayInterruptIfRunning);\n    // removeOnCancel \u7528\u4e8e\u63a7\u5236\u4efb\u52a1\u53d6\u6d88\u540e\u662f\u5426\u5e94\u8be5\u4ece\u963b\u585e\u961f\u5217\u4e2d\u79fb\u9664\n    if (cancelled && removeOnCancel && heapIndex >= 0)\n        // \u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u5220\u9664\u8be5\u4efb\u52a1\uff0c\u5e76\u8c03\u7528 tryTerminate() \u5224\u65ad\u662f\u5426\u9700\u8981\u505c\u6b62\u7ebf\u7a0b\u6c60\n        remove(this);\n    return cancelled;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5ef6\u8fdf\u961f\u5217",children:"\u5ef6\u8fdf\u961f\u5217"}),"\n",(0,r.jsx)(e.p,{children:"DelayedWorkQueue \u662f\u652f\u6301\u5ef6\u65f6\u83b7\u53d6\u5143\u7d20\u7684\u963b\u585e\u961f\u5217\uff0c\u5185\u90e8\u91c7\u7528\u4f18\u5148\u961f\u5217 PriorityQueue\uff08\u5c0f\u6839\u5806\u3001\u6ee1\u4e8c\u53c9\u6811\uff09\u5b58\u50a8\u5143\u7d20"}),"\n",(0,r.jsxs)(e.p,{children:["\u5176\u4ed6\u963b\u585e\u961f\u5217\u5b58\u50a8\u8282\u70b9\u7684\u6570\u636e\u7ed3\u6784\u5927\u90fd\u662f\u94fe\u8868\uff0c",(0,r.jsx)(e.strong,{children:"\u5ef6\u8fdf\u961f\u5217\u662f\u6570\u7ec4"}),"\uff0c\u6240\u4ee5\u5ef6\u8fdf\u961f\u5217\u51fa\u961f\u5934\u5143\u7d20\u540e\u9700\u8981",(0,r.jsx)(e.strong,{children:"\u8ba9\u5176\u4ed6\u5143\u7d20\uff08\u5c3e\uff09\u66ff\u6362\u5230\u5934\u8282\u70b9"}),"\uff0c\u9632\u6b62\u7a7a\u6307\u9488\u5f02\u5e38"]}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5bb9\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final int INITIAL_CAPACITY = 16;\t\t\t// \u521d\u59cb\u5bb9\u91cf\nprivate int size = 0;\t\t\t\t\t\t\t\t\t// \u8282\u70b9\u6570\u91cf\nprivate RunnableScheduledFuture<?>[] queue = \n    new RunnableScheduledFuture<?>[INITIAL_CAPACITY];\t// \u5b58\u653e\u8282\u70b9\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final ReentrantLock lock = new ReentrantLock();\t// \u63a7\u5236\u5e76\u53d1\nprivate final Condition available = lock.newCondition();// \u6761\u4ef6\u961f\u5217\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u963b\u585e\u7b49\u5f85\u5934\u8282\u70b9\u7684\u7ebf\u7a0b\uff1a\u7ebf\u7a0b\u6c60\u5185\u7684\u67d0\u4e2a\u7ebf\u7a0b\u53bb take() \u83b7\u53d6\u4efb\u52a1\u65f6\uff0c\u5982\u679c\u5ef6\u8fdf\u961f\u5217\u9876\u5c42\u8282\u70b9\u4e0d\u4e3a null\uff08\u961f\u5217\u5185\u6709\u4efb\u52a1\uff09\uff0c\u4f46\u662f\u8282\u70b9\u4efb\u52a1\u8fd8\u4e0d\u5230\u89e6\u53d1\u65f6\u95f4\uff0c\u7ebf\u7a0b\u5c31\u53bb\u68c0\u67e5",(0,r.jsx)(e.strong,{children:"\u961f\u5217\u7684 leader\u5b57\u6bb5"}),"\u662f\u5426\u88ab\u5360\u7528"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u5982\u679c\u672a\u88ab\u5360\u7528\uff0c\u5219\u5f53\u524d\u7ebf\u7a0b\u5360\u7528\u8be5\u5b57\u6bb5\uff0c\u7136\u540e\u5f53\u524d\u7ebf\u7a0b\u5230 available \u6761\u4ef6\u961f\u5217\u6307\u5b9a\u8d85\u65f6\u65f6\u95f4 ",(0,r.jsx)(e.code,{children:"\u5806\u9876\u4efb\u52a1.time - now()"})," \u6302\u8d77"]}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u88ab\u5360\u7528\uff0c\u5f53\u524d\u7ebf\u7a0b\u76f4\u63a5\u5230 available \u6761\u4ef6\u961f\u5217\u4e0d\u6307\u5b9a\u8d85\u65f6\u65f6\u95f4\u7684\u6302\u8d77"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// leader \u5728 available \u6761\u4ef6\u961f\u5217\u5185\u662f\u9996\u5143\u7d20\uff0c\u5b83\u8d85\u65f6\u4e4b\u540e\u4f1a\u9192\u8fc7\u6765\uff0c\u7136\u540e\u518d\u6b21\u5c06\u5806\u9876\u5143\u7d20\u83b7\u53d6\u8d70\uff0c\u83b7\u53d6\u8d70\u4e4b\u540e\uff0ctake()\u7ed3\u675f\u4e4b\u524d\uff0c\u4f1a\u8c03\u7528\u662f available.signal() \u5524\u9192\u4e0b\u4e00\u4e2a\u6761\u4ef6\u961f\u5217\u5185\u7684\u7b49\u5f85\u8005\uff0c\u7136\u540e\u91ca\u653e lock\uff0c\u4e0b\u4e00\u4e2a\u7b49\u5f85\u8005\u88ab\u5524\u9192\u540e\u53bb\u5230 AQS \u961f\u5217\uff0c\u505a acquireQueue(node) \u903b\u8f91\nprivate Thread leader = null;\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"offer()\uff1a\u63d2\u5165\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean offer(Runnable x) {\n    // \u5224\u7a7a\n    if (x == null)\n        throw new NullPointerException();\n    RunnableScheduledFuture<?> e = (RunnableScheduledFuture<?>)x;\n    // \u961f\u5217\u9501\uff0c\u589e\u52a0\u5220\u9664\u6570\u636e\u65f6\u90fd\u8981\u52a0\u9501\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    try {\n        int i = size;\n        // \u961f\u5217\u6570\u91cf\u5927\u4e8e\u5b58\u653e\u8282\u70b9\u7684\u6570\u7ec4\u957f\u5ea6\uff0c\u9700\u8981\u6269\u5bb9\n        if (i >= queue.length)\n            // \u6269\u5bb9\u4e3a\u539f\u6765\u957f\u5ea6\u7684 1.5 \u500d\n            grow();\n        size = i + 1;\n        // \u5f53\u524d\u662f\u7b2c\u4e00\u4e2a\u8981\u63d2\u5165\u7684\u8282\u70b9\n        if (i == 0) {\n            queue[0] = e;\n            // \u4fee\u6539 ScheduledFutureTask \u7684 heapIndex \u5c5e\u6027\uff0c\u8868\u793a\u8be5\u5bf9\u8c61\u5728\u961f\u5217\u91cc\u7684\u4e0b\u6807\n            setIndex(e, 0);\n        } else {\n            // \u5411\u4e0a\u8c03\u6574\u5143\u7d20\u7684\u4f4d\u7f6e\uff0c\u5e76\u66f4\u65b0 heapIndex \n            siftUp(i, e);\n        }\n        // \u60c5\u51b51\uff1a\u5f53\u524d\u4efb\u52a1\u662f\u7b2c\u4e00\u4e2a\u52a0\u5165\u5230 queue \u5185\u7684\u4efb\u52a1\uff0c\u6240\u4ee5\u5728\u5f53\u524d\u4efb\u52a1\u52a0\u5165\u5230 queue \u4e4b\u524d\uff0ctake() \u7ebf\u7a0b\u4f1a\u76f4\u63a5\n        //\t\t\u5230 available \u961f\u5217\u4e0d\u8bbe\u7f6e\u8d85\u65f6\u7684\u6302\u8d77\uff0c\u5e76\u4e0d\u4f1a\u53bb\u5360\u7528 leader \u5b57\u6bb5\uff0c\u8fd9\u65f6\u9700\u4f1a\u5524\u9192\u4e00\u4e2a\u7ebf\u7a0b \u8ba9\u5b83\u53bb\u6d88\u8d39\n       \t// \u60c5\u51b52\uff1a\u5f53\u524d\u4efb\u52a1\u3010\u4f18\u5148\u7ea7\u6700\u9ad8\u3011\uff0c\u539f\u5806\u9876\u4efb\u52a1\u53ef\u80fd\u8fd8\u672a\u5230\u89e6\u53d1\u65f6\u95f4\uff0cleader \u7ebf\u7a0b\u8bbe\u7f6e\u8d85\u65f6\u7684\u5728 available \u6302\u8d77\n        //\t\t\u539f\u5148\u7684 leader \u7b49\u5f85\u7684\u662f\u539f\u5148\u7684\u5934\u8282\u70b9\uff0c\u6240\u4ee5 leader \u5df2\u7ecf\u65e0\u6548\uff0c\u9700\u8981\u5c06 leader \u7ebf\u7a0b\u5524\u9192\uff0c\n        //\t\t\u5524\u9192\u4e4b\u540e\u5b83\u4f1a\u68c0\u67e5\u5806\u9876\uff0c\u5982\u679c\u5806\u9876\u4efb\u52a1\u53ef\u4ee5\u88ab\u6d88\u8d39\uff0c\u5219\u76f4\u63a5\u83b7\u53d6\u8d70\uff0c\u5426\u5219\u7ee7\u7eed\u6210\u4e3a leader \u7b49\u5f85\u65b0\u5806\u9876\u4efb\u52a1\n        if (queue[0] == e) {\n            // \u5c06 leader \u8bbe\u7f6e\u4e3a null\n            leader = null;\n            // \u76f4\u63a5\u968f\u4fbf\u5524\u9192\u7b49\u5f85\u5934\u7ed3\u70b9\u7684\u963b\u585e\u7ebf\u7a0b\n            available.signal();\n        }\n    } finally {\n        lock.unlock();\n    }\n    return true;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u63d2\u5165\u65b0\u8282\u70b9\u540e\u5bf9\u5806\u8fdb\u884c\u8c03\u6574\uff0c\u8fdb\u884c\u8282\u70b9\u4e0a\u79fb\uff0c\u4fdd\u6301\u5176\u7279\u6027\u3010\u8282\u70b9\u7684\u503c\u5c0f\u4e8e\u5b50\u8282\u70b9\u7684\u503c\u3011\uff0c\u5c0f\u9876\u5806\nprivate void siftUp(int k, RunnableScheduledFuture<?> key) {\n    while (k > 0) {\n        // \u7236\u8282\u70b9\uff0c\u5c31\u662f\u5806\u6392\u5e8f\n        int parent = (k - 1) >>> 1;\n        RunnableScheduledFuture<?> e = queue[parent];\n        // key \u548c\u7236\u8282\u70b9\u6bd4\uff0c\u5982\u679c\u5927\u4e8e\u7236\u8282\u70b9\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\uff0c\u5426\u5219\u5c31\u7ee7\u7eed\u4e0a\u6d6e\n        if (key.compareTo(e) >= 0)\n            break;\n        queue[k] = e;\n        setIndex(e, k);\n        k = parent;\n    }\n    queue[k] = key;\n    setIndex(key, k);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["poll()\uff1a\u975e\u963b\u585e\u83b7\u53d6\u5934\u7ed3\u70b9\uff0c",(0,r.jsx)(e.strong,{children:"\u83b7\u53d6\u6267\u884c\u65f6\u95f4\u6700\u8fd1\u5e76\u4e14\u53ef\u4ee5\u6267\u884c\u7684"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u975e\u963b\u585e\u83b7\u53d6\npublic RunnableScheduledFuture<?> poll() {\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    try {\n        // \u83b7\u53d6\u961f\u5934\u8282\u70b9\uff0c\u56e0\u4e3a\u662f\u5c0f\u9876\u5806\n        RunnableScheduledFuture<?> first = queue[0];\n        // \u5934\u7ed3\u70b9\u4e3a\u7a7a\u6216\u8005\u7684\u5ef6\u8fdf\u65f6\u95f4\u6ca1\u5230\u8fd4\u56de null\n        if (first == null || first.getDelay(NANOSECONDS) > 0)\n            return null;\n        else\n            // \u5934\u7ed3\u70b9\u8fbe\u5230\u5ef6\u8fdf\u65f6\u95f4\uff0c\u3010\u5c3e\u8282\u70b9\u6210\u4e3a\u66ff\u4ee3\u8282\u70b9\u4e0b\u79fb\u8c03\u6574\u5806\u7ed3\u6784\u3011\uff0c\u8fd4\u56de\u5934\u7ed3\u70b9\n            return finishPoll(first);\n    } finally {\n        lock.unlock();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private RunnableScheduledFuture<?> finishPoll(RunnableScheduledFuture<?> f) {\n    // \u83b7\u53d6\u5c3e\u7d22\u5f15\n    int s = --size;\n    // \u83b7\u53d6\u5c3e\u8282\u70b9\n    RunnableScheduledFuture<?> x = queue[s];\n    // \u5c06\u5806\u7ed3\u6784\u6700\u540e\u4e00\u4e2a\u8282\u70b9\u5360\u7528\u7684 slot \u8bbe\u7f6e\u4e3a null\uff0c\u56e0\u4e3a\u8be5\u8282\u70b9\u8981\u5c1d\u8bd5\u5347\u7ea7\u6210\u5806\u9876\uff0c\u4f1a\u6839\u636e\u7279\u6027\u4e0b\u8c03\n    queue[s] = null;\n    // s == 0 \u8bf4\u660e \u5f53\u524d\u5806\u7ed3\u6784\u53ea\u6709\u5806\u9876\u4e00\u4e2a\u8282\u70b9\uff0c\u6b64\u65f6\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u7684\u4e8b\u60c5\n    if (s != 0)\n        // \u4ece\u7d22\u5f15\u5904 0 \u5f00\u59cb\u5411\u4e0b\u8c03\u6574\n        siftDown(0, x);\n    // \u51fa\u961f\u7684\u5143\u7d20\u7d22\u5f15\u8bbe\u7f6e\u4e3a -1\n    setIndex(f, -1);\n    return f;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"take()\uff1a\u963b\u585e\u83b7\u53d6\u5934\u8282\u70b9\uff0c\u8bfb\u53d6\u5f53\u524d\u5806\u4e2d\u6700\u5c0f\u7684\u4e5f\u5c31\u662f\u89e6\u53d1\u65f6\u95f4\u6700\u8fd1\u7684\u4efb\u52a1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public RunnableScheduledFuture<?> take() throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    // \u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168\n    lock.lockInterruptibly();\n    try {\n        for (;;) {\n            // \u5934\u8282\u70b9\n            RunnableScheduledFuture<?> first = queue[0];\n            if (first == null)\n                // \u7b49\u5f85\u961f\u5217\u4e0d\u7a7a\uff0c\u76f4\u81f3\u6709\u4efb\u52a1\u901a\u8fc7 offer \u5165\u961f\u5e76\u5524\u9192\n                available.await();\n            else {\n                // \u83b7\u53d6\u5934\u8282\u70b9\u7684\u5ef6\u8fdf\u65f6\u95f4\u662f\u5426\u5230\u65f6\n                long delay = first.getDelay(NANOSECONDS);\n                if (delay <= 0)\n                    // \u5230\u8fbe\u89e6\u53d1\u65f6\u95f4\uff0c\u83b7\u53d6\u5934\u8282\u70b9\u5e76\u8c03\u6574\u5806\uff0c\u91cd\u65b0\u9009\u62e9\u5ef6\u8fdf\u65f6\u95f4\u6700\u5c0f\u7684\u8282\u70b9\u653e\u5165\u5934\u90e8\n                    return finishPoll(first);\n                \n                // \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u5934\u8282\u70b9\u7684\u5ef6\u8fdf\u65f6\u95f4\u8fd8\u6ca1\u5230\n                first = null;\n                // \u8bf4\u660e\u6709 leader \u7ebf\u7a0b\u5728\u7b49\u5f85\u83b7\u53d6\u5934\u8282\u70b9\uff0c\u5f53\u524d\u7ebf\u7a0b\u76f4\u63a5\u53bb\u963b\u585e\u7b49\u5f85\n                if (leader != null)\n                    available.await();\n                else {\n                    // \u6ca1\u6709 leader \u7ebf\u7a0b\uff0c\u3010\u5f53\u524d\u7ebf\u7a0b\u4f5c\u4e3aleader\u7ebf\u7a0b\uff0c\u5e76\u8bbe\u7f6e\u5934\u7ed3\u70b9\u7684\u5ef6\u8fdf\u65f6\u95f4\u4f5c\u4e3a\u963b\u585e\u65f6\u95f4\u3011\n                    Thread thisThread = Thread.currentThread();\n                    leader = thisThread;\n                    try {\n                        // \u5728\u6761\u4ef6\u961f\u5217 available \u4f7f\u7528\u5e26\u8d85\u65f6\u7684\u6302\u8d77\uff08\u5806\u9876\u4efb\u52a1.time - now() \u7eb3\u79d2\u503c..\uff09\n                        available.awaitNanos(delay);\n                        // \u5230\u8fbe\u963b\u585e\u65f6\u95f4\u65f6\uff0c\u5f53\u524d\u7ebf\u7a0b\u4f1a\u4ece\u8fd9\u91cc\u9192\u6765\u6765\n                    } finally {\n                        // t\u5806\u9876\u66f4\u65b0\uff0cleader \u7f6e\u4e3a null\uff0coffer \u65b9\u6cd5\u91ca\u653e\u9501\u540e\uff0c\n                        // \u6709\u5176\u5b83\u7ebf\u7a0b\u901a\u8fc7 take/poll \u62ff\u5230\u9501,\u8bfb\u5230 leader == null\uff0c\u7136\u540e\u5c06\u81ea\u8eab\u66f4\u65b0\u4e3aleader\u3002\n                        if (leader == thisThread)\n                            // leader \u7f6e\u4e3a null \u7528\u4ee5\u63a5\u4e0b\u6765\u5224\u65ad\u662f\u5426\u9700\u8981\u5524\u9192\u540e\u7ee7\u7ebf\u7a0b\n                            leader = null;\n                    }\n                }\n            }\n        }\n    } finally {\n        // \u6ca1\u6709 leader \u7ebf\u7a0b\uff0c\u5934\u7ed3\u70b9\u4e0d\u4e3a null\uff0c\u5524\u9192\u963b\u585e\u83b7\u53d6\u5934\u8282\u70b9\u7684\u7ebf\u7a0b\uff0c\n        // \u3010\u5982\u679c\u6ca1\u6709\u8fd9\u4e00\u6b65\uff0c\u5c31\u4f1a\u51fa\u73b0\u6709\u4e86\u9700\u8981\u6267\u884c\u7684\u4efb\u52a1\uff0c\u4f46\u662f\u6ca1\u6709\u7ebf\u7a0b\u53bb\u6267\u884c\u3011\n        if (leader == null && queue[0] != null)\n            available.signal();\n        lock.unlock();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["remove()\uff1a\u5220\u9664\u8282\u70b9\uff0c\u5806\u79fb\u9664\u4e00\u4e2a\u5143\u7d20\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f O(log n)\uff0c",(0,r.jsx)(e.strong,{children:"\u5ef6\u8fdf\u4efb\u52a1\u7ef4\u62a4\u4e86 heapIndex"}),"\uff0c\u76f4\u63a5\u8bbf\u95ee\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f O(1)\uff0c\u4ece\u800c\u53ef\u4ee5\u66f4\u5feb\u7684\u79fb\u9664\u5143\u7d20\uff0c\u4efb\u52a1\u5728\u961f\u5217\u4e2d\u88ab\u53d6\u6d88\u540e\u4f1a\u8fdb\u5165\u8be5\u903b\u8f91"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean remove(Object x) {\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    try {\n        // \u67e5\u627e\u5bf9\u8c61\u5728\u961f\u5217\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\n        int i = indexOf(x);\n        // \u8282\u70b9\u4e0d\u5b58\u5728\uff0c\u8fd4\u56de false\n        if (i < 0)\n            return false;\n\t\t// \u4fee\u6539\u5143\u7d20\u7684 heapIndex\uff0c-1 \u4ee3\u8868\u5220\u9664\n        setIndex(queue[i], -1);\n        // \u5c3e\u7d22\u5f15\u662f\u957f\u5ea6-1\n        int s = --size;\n        // \u5c3e\u8282\u70b9\u4f5c\u4e3a\u66ff\u4ee3\u8282\u70b9\n        RunnableScheduledFuture<?> replacement = queue[s];\n        queue[s] = null;\n        // s == i \u8bf4\u660e\u5934\u8282\u70b9\u5c31\u662f\u5c3e\u8282\u70b9\uff0c\u961f\u5217\u7a7a\u4e86\n        if (s != i) {\n            // \u5411\u4e0b\u8c03\u6574\n            siftDown(i, replacement);\n            // \u8bf4\u660e\u6ca1\u53d1\u751f\u8c03\u6574\n            if (queue[i] == replacement)\n                // \u4e0a\u79fb\u548c\u4e0b\u79fb\u4e0d\u53ef\u80fd\u540c\u65f6\u53d1\u751f\uff0c\u66ff\u4ee3\u8282\u70b9\u5927\u4e8e\u5b50\u8282\u70b9\u65f6\u4e0b\u79fb\uff0c\u5426\u5219\u4e0a\u79fb\n                siftUp(i, replacement);\n        }\n        return true;\n    } finally {\n        lock.unlock();\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u65b9\u6cd5-4",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.h5,{id:"\u63d0\u4ea4\u4efb\u52a1",children:"\u63d0\u4ea4\u4efb\u52a1"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"schedule()\uff1a\u5ef6\u8fdf\u6267\u884c\u65b9\u6cd5\uff0c\u5e76\u6307\u5b9a\u6267\u884c\u7684\u65f6\u95f4\uff0c\u9ed8\u8ba4\u662f\u5f53\u524d\u65f6\u95f4"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void execute(Runnable command) {\n    // \u4ee5\u96f6\u5ef6\u65f6\u4efb\u52a1\u7684\u5f62\u5f0f\u5b9e\u73b0\n    schedule(command, 0, NANOSECONDS);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ScheduledFuture<?> schedule(Runnable command, long delay, TimeUnit unit) {\n    // \u5224\u7a7a\n    if (command == null || unit == null) throw new NullPointerException();\n    // \u6ca1\u6709\u505a\u4efb\u4f55\u64cd\u4f5c\uff0c\u76f4\u63a5\u5c06 task \u8fd4\u56de\uff0c\u8be5\u65b9\u6cd5\u4e3b\u8981\u76ee\u7684\u662f\u7528\u4e8e\u5b50\u7c7b\u6269\u5c55\uff0c\u5e76\u4e14\u3010\u6839\u636e\u5ef6\u8fdf\u65f6\u95f4\u8bbe\u7f6e\u4efb\u52a1\u89e6\u53d1\u7684\u65f6\u95f4\u70b9\u3011\n    RunnableScheduledFuture<?> t = decorateTask(command, new ScheduledFutureTask<Void>(\n        \t\t\t\t\t\t\t\t\t\t\tcommand, null, triggerTime(delay, unit)));\n    // \u5ef6\u8fdf\u6267\u884c\n    delayedExecute(t);\n    return t;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8fd4\u56de\u3010\u5f53\u524d\u65f6\u95f4 + \u5ef6\u8fdf\u65f6\u95f4\u3011\uff0c\u5c31\u662f\u89e6\u53d1\u5f53\u524d\u4efb\u52a1\u6267\u884c\u7684\u65f6\u95f4\nprivate long triggerTime(long delay, TimeUnit unit) {\n    // \u8bbe\u7f6e\u89e6\u53d1\u7684\u65f6\u95f4\n    return triggerTime(unit.toNanos((delay < 0) ? 0 : delay));\n}\nlong triggerTime(long delay) {\n    // \u5982\u679c delay < Long.Max_VALUE/2\uff0c\u5219\u4e0b\u6b21\u6267\u884c\u65f6\u95f4\u4e3a\u5f53\u524d\u65f6\u95f4 +delay\n    // \u5426\u5219\u4e3a\u4e86\u907f\u514d\u961f\u5217\u4e2d\u51fa\u73b0\u7531\u4e8e\u6ea2\u51fa\u5bfc\u81f4\u7684\u6392\u5e8f\u7d0a\u4e71,\u9700\u8981\u8c03\u7528overflowFree\u6765\u4fee\u6b63\u4e00\u4e0bdelay\n    return now() + ((delay < (Long.MAX_VALUE >> 1)) ? delay : overflowFree(delay));\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"overflowFree \u7684\u539f\u56e0\uff1a\u5982\u679c\u67d0\u4e2a\u4efb\u52a1\u7684 delay \u4e3a\u8d1f\u6570\uff0c\u8bf4\u660e\u5f53\u524d\u53ef\u4ee5\u6267\u884c\uff08\u5176\u5b9e\u65e9\u8be5\u6267\u884c\u4e86\uff09\u3002\u963b\u585e\u961f\u5217\u4e2d\u7ef4\u62a4\u4efb\u52a1\u987a\u5e8f\u662f\u57fa\u4e8e compareTo \u6bd4\u8f83\u7684\uff0c\u6bd4\u8f83\u4e24\u4e2a\u4efb\u52a1\u7684\u987a\u5e8f\u4f1a\u7528 time \u76f8\u51cf\u3002\u90a3\u4e48\u53ef\u80fd\u51fa\u73b0\u4e00\u4e2a delay \u4e3a\u6b63\u6570\u51cf\u53bb\u53e6\u4e00\u4e2a\u4e3a\u8d1f\u6570\u7684 delay\uff0c\u7ed3\u679c\u4e0a\u6ea2\u4e3a\u8d1f\u6570\uff0c\u5219\u4f1a\u5bfc\u81f4 compareTo \u4ea7\u751f\u9519\u8bef\u7684\u7ed3\u679c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private long overflowFree(long delay) {\n    Delayed head = (Delayed) super.getQueue().peek();\n    if (head != null) {\n        long headDelay = head.getDelay(NANOSECONDS);\n        // \u5224\u65ad\u4e00\u4e0b\u961f\u9996\u7684delay\u662f\u4e0d\u662f\u8d1f\u6570\uff0c\u5982\u679c\u662f\u6b63\u6570\u5c31\u4e0d\u7528\u7ba1\uff0c\u600e\u4e48\u51cf\u90fd\u4e0d\u4f1a\u6ea2\u51fa\n        // \u5426\u5219\u62ff\u5f53\u524d delay \u51cf\u53bb\u961f\u9996\u7684 delay \u6765\u6bd4\u8f83\u770b\uff0c\u5982\u679c\u4e0d\u51fa\u73b0\u4e0a\u6ea2\uff0c\u6392\u5e8f\u4e0d\u4f1a\u4e71\n\t\t// \u4e0d\u7136\u5c31\u628a\u5f53\u524d delay \u503c\u7ed9\u8c03\u6574\u4e3a Long.MAX_VALUE + \u961f\u9996 delay\n        if (headDelay < 0 && (delay - headDelay < 0))\n            delay = Long.MAX_VALUE + headDelay;\n    }\n    return delay;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"scheduleAtFixedRate()\uff1a\u5b9a\u65f6\u6267\u884c\uff0c\u4e00\u6b21\u4efb\u52a1\u7684\u542f\u52a8\u5230\u4e0b\u4e00\u6b21\u4efb\u52a1\u7684\u542f\u52a8\u7684\u95f4\u9694"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ScheduledFuture<?> scheduleAtFixedRate(Runnable command, long initialDelay, long period,\n                                              TimeUnit unit) {\n    if (command == null || unit == null)\n        throw new NullPointerException();\n    if (period <= 0)\n        throw new IllegalArgumentException();\n    // \u4efb\u52a1\u5c01\u88c5\uff0c\u3010\u6307\u5b9a\u521d\u59cb\u7684\u5ef6\u8fdf\u65f6\u95f4\u548c\u5468\u671f\u65f6\u95f4\u3011\n    ScheduledFutureTask<Void> sft =new ScheduledFutureTask<Void>(command, null,\n                                      triggerTime(initialDelay, unit), unit.toNanos(period));\n    // \u9ed8\u8ba4\u8fd4\u56de\u672c\u8eab\n    RunnableScheduledFuture<Void> t = decorateTask(command, sft);\n    sft.outerTask = t;\n    // \u5f00\u59cb\u6267\u884c\u8fd9\u4e2a\u4efb\u52a1\n    delayedExecute(t);\n    return t;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"scheduleWithFixedDelay()\uff1a\u5b9a\u65f6\u6267\u884c\uff0c\u4e00\u6b21\u4efb\u52a1\u7684\u7ed3\u675f\u5230\u4e0b\u4e00\u6b21\u4efb\u52a1\u7684\u542f\u52a8\u7684\u95f4\u9694"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ScheduledFuture<?> scheduleWithFixedDelay(Runnable command, long initialDelay, long delay,\n                                                 TimeUnit unit) {\n    if (command == null || unit == null) \n        throw new NullPointerException();\n    if (delay <= 0)\n        throw new IllegalArgumentException();\n    // \u4efb\u52a1\u5c01\u88c5\uff0c\u3010\u6307\u5b9a\u521d\u59cb\u7684\u5ef6\u8fdf\u65f6\u95f4\u548c\u5468\u671f\u65f6\u95f4\u3011\uff0c\u5468\u671f\u65f6\u95f4\u4e3a - \u8868\u793a\u662f fixed-delay \u6a21\u5f0f\n    ScheduledFutureTask<Void> sft = new ScheduledFutureTask<Void>(command, null,\n                                      triggerTime(initialDelay, unit), unit.toNanos(-delay));\n    RunnableScheduledFuture<Void> t = decorateTask(command, sft);\n    sft.outerTask = t;\n    delayedExecute(t);\n    return t;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u8fd0\u884c\u4efb\u52a1",children:"\u8fd0\u884c\u4efb\u52a1"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["delayedExecute()\uff1a",(0,r.jsx)(e.strong,{children:"\u6821\u9a8c\u7ebf\u7a0b\u6c60\u72b6\u6001"}),"\uff0c\u5ef6\u8fdf\u6216\u5468\u671f\u6027\u4efb\u52a1\u7684\u4e3b\u8981\u6267\u884c\u65b9\u6cd5"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void delayedExecute(RunnableScheduledFuture<?> task) {\n    // \u7ebf\u7a0b\u6c60\u662f SHUTDOWN \u72b6\u6001\uff0c\u9700\u8981\u6267\u884c\u62d2\u7edd\u7b56\u7565\n    if (isShutdown())\n        reject(task);\n    else {\n        // \u628a\u5f53\u524d\u4efb\u52a1\u653e\u5165\u963b\u585e\u961f\u5217\uff0c\u56e0\u4e3a\u9700\u8981\u3010\u83b7\u53d6\u6267\u884c\u65f6\u95f4\u6700\u8fd1\u7684\u3011\uff0c\u5f53\u524d\u4efb\u52a1\u9700\u8981\u6bd4\u8f83\n        super.getQueue().add(task);\n        // \u7ebf\u7a0b\u6c60\u72b6\u6001\u4e3a SHUTDOWN \u5e76\u4e14\u4e0d\u5141\u8bb8\u6267\u884c\u4efb\u52a1\u4e86\uff0c\u5c31\u4ece\u961f\u5217\u5220\u9664\u8be5\u4efb\u52a1\uff0c\u5e76\u8bbe\u7f6e\u4efb\u52a1\u7684\u72b6\u6001\u4e3a\u53d6\u6d88\u72b6\u6001\n        if (isShutdown() && !canRunInCurrentRunState(task.isPeriodic()) && remove(task))\n            task.cancel(false);\n        else\n            // \u53ef\u4ee5\u6267\u884c\n            ensurePrestart();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["ensurePrestart()\uff1a",(0,r.jsx)(e.strong,{children:"\u5f00\u542f\u7ebf\u7a0b\u6267\u884c\u4efb\u52a1"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// ThreadPoolExecutor#ensurePrestart\nvoid ensurePrestart() {\n    int wc = workerCountOf(ctl.get());\n    // worker\u6570\u76ee\u5c0f\u4e8ecorePoolSize\uff0c\u5219\u6dfb\u52a0\u4e00\u4e2aworker\u3002\n    if (wc < corePoolSize)\n        // \u7b2c\u4e8c\u4e2a\u53c2\u6570 true \u8868\u793a\u91c7\u7528\u6838\u5fc3\u7ebf\u7a0b\u6570\u91cf\u9650\u5236\uff0cfalse \u8868\u793a\u91c7\u7528 maximumPoolSize\n        addWorker(null, true);\n    // corePoolSize = 0\u7684\u60c5\u51b5\uff0c\u81f3\u5c11\u5f00\u542f\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u3010\u62c5\u4fdd\u673a\u5236\u3011\n    else if (wc == 0)\n        addWorker(null, false);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"canRunInCurrentRunState()\uff1a\u4efb\u52a1\u8fd0\u884c\u65f6\u90fd\u4f1a\u88ab\u8c03\u7528\u4ee5\u6821\u9a8c\u5f53\u524d\u72b6\u6001\u662f\u5426\u53ef\u4ee5\u8fd0\u884c\u4efb\u52a1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"boolean canRunInCurrentRunState(boolean periodic) {\n    // \u6839\u636e\u662f\u5426\u662f\u5468\u671f\u4efb\u52a1\u5224\u65ad\uff0c\u5728\u7ebf\u7a0b\u6c60 shutdown \u540e\u662f\u5426\u7ee7\u7eed\u6267\u884c\u8be5\u4efb\u52a1\uff0c\u9ed8\u8ba4\u975e\u5468\u671f\u4efb\u52a1\u662f\u7ee7\u7eed\u6267\u884c\u7684\n    return isRunningOrShutdown(periodic ? continueExistingPeriodicTasksAfterShutdown :\n                               executeExistingDelayedTasksAfterShutdown);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"onShutdown()\uff1a\u5220\u9664\u5e76\u53d6\u6d88\u5de5\u4f5c\u961f\u5217\u4e2d\u7684\u4e0d\u9700\u8981\u518d\u6267\u884c\u7684\u4efb\u52a1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"void onShutdown() {\n    BlockingQueue<Runnable> q = super.getQueue();\n    // shutdown \u540e\u662f\u5426\u4ecd\u7136\u6267\u884c\u5ef6\u65f6\u4efb\u52a1\n    boolean keepDelayed = getExecuteExistingDelayedTasksAfterShutdownPolicy();\n    // shutdown \u540e\u662f\u5426\u4ecd\u7136\u6267\u884c\u5468\u671f\u4efb\u52a1\n    boolean keepPeriodic = getContinueExistingPeriodicTasksAfterShutdownPolicy();\n    // \u5982\u679c\u4e24\u8005\u7686\u4e0d\u53ef\uff0c\u5219\u5bf9\u961f\u5217\u4e2d\u3010\u6240\u6709\u4efb\u52a1\u3011\u8c03\u7528 cancel \u53d6\u6d88\u5e76\u6e05\u7a7a\u961f\u5217\n    if (!keepDelayed && !keepPeriodic) {\n        for (Object e : q.toArray())\n            if (e instanceof RunnableScheduledFuture<?>)\n                ((RunnableScheduledFuture<?>) e).cancel(false);\n        q.clear();\n    }\n    else {\n        for (Object e : q.toArray()) {\n            if (e instanceof RunnableScheduledFuture) {\n                RunnableScheduledFuture<?> t = (RunnableScheduledFuture<?>)e;\n                // \u4e0d\u9700\u8981\u6267\u884c\u7684\u4efb\u52a1\u5220\u9664\u5e76\u53d6\u6d88\uff0c\u5df2\u7ecf\u53d6\u6d88\u7684\u4efb\u52a1\u4e5f\u9700\u8981\u4ece\u961f\u5217\u4e2d\u5220\u9664\n                if ((t.isPeriodic() ? !keepPeriodic : !keepDelayed) ||\n                    t.isCancelled()) {\n                    if (q.remove(t))\n                        t.cancel(false);\n                }\n            }\n        }\n    }\n    // \u56e0\u4e3a\u4efb\u52a1\u88ab\u4ece\u961f\u5217\u4e2d\u6e05\u7406\u6389\uff0c\u6240\u4ee5\u9700\u8981\u8c03\u7528 tryTerminate \u5c1d\u8bd5\u3010\u6539\u53d8\u7ebf\u7a0b\u6c60\u7684\u72b6\u6001\u3011\n    tryTerminate();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"forkjoin",children:"ForkJoin"}),"\n",(0,r.jsxs)(e.p,{children:["Fork/Join\uff1a\u7ebf\u7a0b\u6c60\u7684\u5b9e\u73b0\uff0c\u4f53\u73b0\u662f\u5206\u6cbb\u601d\u60f3\uff0c\u9002\u7528\u4e8e\u80fd\u591f\u8fdb\u884c\u4efb\u52a1\u62c6\u5206\u7684 CPU \u5bc6\u96c6\u578b\u8fd0\u7b97\uff0c\u7528\u4e8e",(0,r.jsx)(e.strong,{children:"\u5e76\u884c\u8ba1\u7b97"})]}),"\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u62c6\u5206\uff1a\u5c06\u4e00\u4e2a\u5927\u4efb\u52a1\u62c6\u5206\u4e3a\u7b97\u6cd5\u4e0a\u76f8\u540c\u7684\u5c0f\u4efb\u52a1\uff0c\u76f4\u81f3\u4e0d\u80fd\u62c6\u5206\u53ef\u4ee5\u76f4\u63a5\u6c42\u89e3\u3002\u8ddf\u9012\u5f52\u76f8\u5173\u7684\u4e00\u4e9b\u8ba1\u7b97\uff0c\u5982\u5f52\u5e76\u6392\u5e8f\u3001\u6590\u6ce2\u90a3\u5951\u6570\u5217\u90fd\u53ef\u4ee5\u7528\u5206\u6cbb\u601d\u60f3\u8fdb\u884c\u6c42\u89e3"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Fork/Join \u5728",(0,r.jsx)(e.strong,{children:"\u5206\u6cbb\u7684\u57fa\u7840\u4e0a\u52a0\u5165\u4e86\u591a\u7ebf\u7a0b"}),"\uff0c\u628a\u6bcf\u4e2a\u4efb\u52a1\u7684\u5206\u89e3\u548c\u5408\u5e76\u4ea4\u7ed9\u4e0d\u540c\u7684\u7ebf\u7a0b\u6765\u5b8c\u6210\uff0c\u63d0\u5347\u4e86\u8fd0\u7b97\u6548\u7387"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"ForkJoin \u4f7f\u7528 ForkJoinPool \u6765\u542f\u52a8\uff0c\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u7ebf\u7a0b\u6c60\uff0c\u9ed8\u8ba4\u4f1a\u521b\u5efa\u4e0e CPU \u6838\u5fc3\u6570\u5927\u5c0f\u76f8\u540c\u7684\u7ebf\u7a0b\u6c60"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4efb\u52a1\u6709\u8fd4\u56de\u503c\u7ee7\u627f RecursiveTask\uff0c\u6ca1\u6709\u8fd4\u56de\u503c\u7ee7\u627f RecursiveAction"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ForkJoinPool pool = new ForkJoinPool(4);\n    System.out.println(pool.invoke(new MyTask(5)));\n    //\u62c6\u5206  5 + MyTask(4) --\x3e 4 + MyTask(3) --\x3e\n}\n\n// 1~ n \u4e4b\u95f4\u6574\u6570\u7684\u548c\nclass MyTask extends RecursiveTask<Integer> {\n    private int n;\n\n    public MyTask(int n) {\n        this.n = n;\n    }\n\n    @Override\n    public String toString() {\n        return "MyTask{" + "n=" + n + \'}\';\n    }\n\n    @Override\n    protected Integer compute() {\n        // \u5982\u679c n \u5df2\u7ecf\u4e3a 1\uff0c\u53ef\u4ee5\u6c42\u5f97\u7ed3\u679c\u4e86\n        if (n == 1) {\n            return n;\n        }\n        // \u5c06\u4efb\u52a1\u8fdb\u884c\u62c6\u5206(fork)\n        MyTask t1 = new MyTask(n - 1);\n        t1.fork();\n        // \u5408\u5e76(join)\u7ed3\u679c\n        int result = n + t1.join();\n        return result;\n    }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u7ee7\u7eed\u62c6\u5206\u4f18\u5316\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'class AddTask extends RecursiveTask<Integer> {\n    int begin;\n    int end;\n    public AddTask(int begin, int end) {\n        this.begin = begin;\n        this.end = end;\n    }\n    \n    @Override\n    public String toString() {\n        return "{" + begin + "," + end + \'}\';\n    }\n    \n    @Override\n    protected Integer compute() {\n        // 5, 5\n        if (begin == end) {\n            return begin;\n        }\n        // 4, 5  \u9632\u6b62\u591a\u4f59\u7684\u62c6\u5206  \u63d0\u9ad8\u6548\u7387\n        if (end - begin == 1) {\n            return end + begin;\n        }\n        // 1 5\n        int mid = (end + begin) / 2; // 3\n        AddTask t1 = new AddTask(begin, mid); // 1,3\n        t1.fork();\n        AddTask t2 = new AddTask(mid + 1, end); // 4,5\n        t2.fork();\n        int result = t1.join() + t2.join();\n        return result;\n    }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:["ForkJoinPool \u5b9e\u73b0\u4e86",(0,r.jsx)(e.strong,{children:"\u5de5\u4f5c\u7a83\u53d6\u7b97\u6cd5"}),"\u6765\u63d0\u9ad8 CPU \u7684\u5229\u7528\u7387\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u7ef4\u62a4\u4e86\u4e00\u4e2a",(0,r.jsx)(e.strong,{children:"\u53cc\u7aef\u961f\u5217"}),"\uff0c\u7528\u6765\u5b58\u50a8\u9700\u8981\u6267\u884c\u7684\u4efb\u52a1"]}),"\n",(0,r.jsx)(e.li,{children:"\u5de5\u4f5c\u7a83\u53d6\u7b97\u6cd5\u5141\u8bb8\u7a7a\u95f2\u7684\u7ebf\u7a0b\u4ece\u5176\u5b83\u7ebf\u7a0b\u7684\u53cc\u7aef\u961f\u5217\u4e2d\u7a83\u53d6\u4e00\u4e2a\u4efb\u52a1\u6765\u6267\u884c"}),"\n",(0,r.jsxs)(e.li,{children:["\u7a83\u53d6\u7684\u5fc5\u987b\u662f",(0,r.jsx)(e.strong,{children:"\u6700\u665a\u7684\u4efb\u52a1"}),"\uff0c\u907f\u514d\u548c\u961f\u5217\u6240\u5c5e\u7ebf\u7a0b\u53d1\u751f\u7ade\u4e89\uff0c\u4f46\u662f\u961f\u5217\u4e2d\u53ea\u6709\u4e00\u4e2a\u4efb\u52a1\u65f6\u8fd8\u662f\u4f1a\u53d1\u751f\u7ade\u4e89"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u4eab\u5143\u6a21\u5f0f",children:"\u4eab\u5143\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"\u4eab\u5143\u6a21\u5f0f\uff08Flyweight pattern\uff09\uff1a \u7528\u4e8e\u51cf\u5c11\u521b\u5efa\u5bf9\u8c61\u7684\u6570\u91cf\uff0c\u4ee5\u51cf\u5c11\u5185\u5b58\u5360\u7528\u548c\u63d0\u9ad8\u6027\u80fd\uff0c\u8fd9\u79cd\u7c7b\u578b\u7684\u8bbe\u8ba1\u6a21\u5f0f\u5c5e\u4e8e\u7ed3\u6784\u578b\u6a21\u5f0f\uff0c\u5b83\u63d0\u4f9b\u4e86\u51cf\u5c11\u5bf9\u8c61\u6570\u91cf\u4ece\u800c\u6539\u5584\u5e94\u7528\u6240\u9700\u7684\u5bf9\u8c61\u7ed3\u6784\u7684\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"\u5f02\u6b65\u6a21\u5f0f\uff1a\u8ba9\u6709\u9650\u7684\u5de5\u4f5c\u7ebf\u7a0b\uff08Worker Thread\uff09\u6765\u8f6e\u6d41\u5f02\u6b65\u5904\u7406\u65e0\u9650\u591a\u7684\u4efb\u52a1\uff0c\u4e5f\u53ef\u5c06\u5176\u5f52\u7c7b\u4e3a\u5206\u5de5\u6a21\u5f0f\uff0c\u5178\u578b\u5b9e\u73b0\u5c31\u662f\u7ebf\u7a0b\u6c60"}),"\n",(0,r.jsx)(e.p,{children:"\u5de5\u4f5c\u673a\u5236\uff1a\u4eab\u5143\u6a21\u5f0f\u5c1d\u8bd5\u91cd\u7528\u73b0\u6709\u7684\u540c\u7c7b\u5bf9\u8c61\uff0c\u5982\u679c\u672a\u627e\u5230\u5339\u914d\u7684\u5bf9\u8c61\uff0c\u5219\u521b\u5efa\u65b0\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.p,{children:"\u81ea\u5b9a\u4e49\u8fde\u63a5\u6c60\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    Pool pool = new Pool(2);\n    for (int i = 0; i < 5; i++) {\n        new Thread(() -> {\n            Connection con = pool.borrow();\n            try {\n                Thread.sleep(new Random().nextInt(1000));\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            pool.free(con);\n        }).start();\n    }\n}\nclass Pool {\n    //\u8fde\u63a5\u6c60\u7684\u5927\u5c0f\n    private final int poolSize;\n    //\u8fde\u63a5\u5bf9\u8c61\u7684\u6570\u7ec4\n    private Connection[] connections;\n    //\u8fde\u63a5\u72b6\u6001\u6570\u7ec4 0\u8868\u793a\u7a7a\u95f2  1\u8868\u793a\u7e41\u5fd9\n    private AtomicIntegerArray states;  //int[] -> AtomicIntegerArray\n\n    //\u6784\u9020\u65b9\u6cd5\n    public Pool(int poolSize) {\n        this.poolSize = poolSize;\n        this.connections = new Connection[poolSize];\n        this.states = new AtomicIntegerArray(new int[poolSize]);\n        for (int i = 0; i < poolSize; i++) {\n            connections[i] = new MockConnection("\u8fde\u63a5" + (i + 1));\n        }\n    }\n\n    //\u4f7f\u7528\u8fde\u63a5\n    public Connection borrow() {\n        while (true) {\n            for (int i = 0; i < poolSize; i++) {\n                if (states.get(i) == 0) {\n                    if (states.compareAndSet(i, 0, 1)) {\n                        System.out.println(Thread.currentThread().getName() + " borrow " +  connections[i]);\n                        return connections[i];\n                    }\n                }\n            }\n            //\u5982\u679c\u6ca1\u6709\u7a7a\u95f2\u8fde\u63a5\uff0c\u5f53\u524d\u7ebf\u7a0b\u7b49\u5f85\n            synchronized (this) {\n                try {\n                    System.out.println(Thread.currentThread().getName() + " wait...");\n                    this.wait();\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n        }\n    }\n\n    //\u5f52\u8fd8\u8fde\u63a5\n    public void free(Connection con) {\n        for (int i = 0; i < poolSize; i++) {\n            if (connections[i] == con) {//\u5224\u65ad\u662f\u5426\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\n                states.set(i, 0);//\u4e0d\u7528cas\u7684\u539f\u56e0\u662f\u53ea\u4f1a\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4f7f\u7528\u8be5\u8fde\u63a5\n                synchronized (this) {\n                    System.out.println(Thread.currentThread().getName() + " free " + con);\n                    this.notifyAll();\n                }\n                break;\n            }\n        }\n    }\n\n}\n\nclass MockConnection implements Connection {\n    private String name;\n    //.....\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u540c\u6b65\u5668",children:"\u540c\u6b65\u5668"}),"\n",(0,r.jsx)(e.h3,{id:"aqs",children:"AQS"}),"\n",(0,r.jsx)(e.h4,{id:"\u6838\u5fc3\u601d\u60f3",children:"\u6838\u5fc3\u601d\u60f3"}),"\n",(0,r.jsx)(e.p,{children:"AQS\uff1aAbstractQueuedSynchronizer\uff0c\u662f\u963b\u585e\u5f0f\u9501\u548c\u76f8\u5173\u7684\u540c\u6b65\u5668\u5de5\u5177\u7684\u6846\u67b6\uff0c\u8bb8\u591a\u540c\u6b65\u7c7b\u5b9e\u73b0\u90fd\u4f9d\u8d56\u4e8e\u8be5\u540c\u6b65\u5668"}),"\n",(0,r.jsxs)(e.p,{children:["AQS \u7528\u72b6\u6001\u5c5e\u6027\u6765\u8868\u793a\u8d44\u6e90\u7684\u72b6\u6001\uff08\u5206",(0,r.jsx)(e.strong,{children:"\u72ec\u5360\u6a21\u5f0f\u548c\u5171\u4eab\u6a21\u5f0f"}),"\uff09\uff0c\u5b50\u7c7b\u9700\u8981\u5b9a\u4e49\u5982\u4f55\u7ef4\u62a4\u8fd9\u4e2a\u72b6\u6001\uff0c\u63a7\u5236\u5982\u4f55\u83b7\u53d6\u9501\u548c\u91ca\u653e\u9501"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u72ec\u5360\u6a21\u5f0f\u662f\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u80fd\u591f\u8bbf\u95ee\u8d44\u6e90\uff0c\u5982 ReentrantLock"}),"\n",(0,r.jsx)(e.li,{children:"\u5171\u4eab\u6a21\u5f0f\u5141\u8bb8\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95ee\u8d44\u6e90\uff0c\u5982 Semaphore\uff0cReentrantReadWriteLock \u662f\u7ec4\u5408\u5f0f"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"AQS \u6838\u5fc3\u601d\u60f3\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u88ab\u8bf7\u6c42\u7684\u5171\u4eab\u8d44\u6e90\u7a7a\u95f2\uff0c\u5219\u5c06\u5f53\u524d\u8bf7\u6c42\u8d44\u6e90\u7684\u7ebf\u7a0b\u8bbe\u7f6e\u4e3a\u6709\u6548\u7684\u5de5\u4f5c\u7ebf\u7a0b\uff0c\u5e76\u5c06\u5171\u4eab\u8d44\u6e90\u8bbe\u7f6e\u9501\u5b9a\u72b6\u6001"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bf7\u6c42\u7684\u5171\u4eab\u8d44\u6e90\u88ab\u5360\u7528\uff0cAQS \u7528\u961f\u5217\u5b9e\u73b0\u7ebf\u7a0b\u963b\u585e\u7b49\u5f85\u4ee5\u53ca\u88ab\u5524\u9192\u65f6\u9501\u5206\u914d\u7684\u673a\u5236\uff0c\u5c06\u6682\u65f6\u83b7\u53d6\u4e0d\u5230\u9501\u7684\u7ebf\u7a0b\u52a0\u5165\u5230\u961f\u5217\u4e2d"}),"\n",(0,r.jsxs)(e.p,{children:["CLH \u662f\u4e00\u79cd\u57fa\u4e8e\u5355\u5411\u94fe\u8868\u7684",(0,r.jsx)(e.strong,{children:"\u9ad8\u6027\u80fd\u3001\u516c\u5e73\u7684\u81ea\u65cb\u9501"}),"\uff0cAQS \u662f\u5c06\u6bcf\u6761\u8bf7\u6c42\u5171\u4eab\u8d44\u6e90\u7684\u7ebf\u7a0b\u5c01\u88c5\u6210\u4e00\u4e2a CLH \u9501\u961f\u5217\u7684\u4e00\u4e2a\u7ed3\u70b9\uff08Node\uff09\u6765\u5b9e\u73b0\u9501\u7684\u5206\u914d"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(70819).A+"",width:"852",height:"401"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u8bbe\u8ba1\u539f\u7406",children:"\u8bbe\u8ba1\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"\u8bbe\u8ba1\u539f\u7406\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"while(state \u72b6\u6001\u4e0d\u5141\u8bb8\u83b7\u53d6) {\t// tryAcquire(arg)\n    if(\u961f\u5217\u4e2d\u8fd8\u6ca1\u6709\u6b64\u7ebf\u7a0b) {\n        \u5165\u961f\u5e76\u963b\u585e park\n    }\n}\n\u5f53\u524d\u7ebf\u7a0b\u51fa\u961f\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u91ca\u653e\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"if(state \u72b6\u6001\u5141\u8bb8\u4e86) {\t// tryRelease(arg)\n\t\u6062\u590d\u963b\u585e\u7684\u7ebf\u7a0b(s) unpark\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"AbstractQueuedSynchronizer \u4e2d state \u8bbe\u8ba1\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"state \u4f7f\u7528\u4e86 32bit int \u6765\u7ef4\u62a4\u540c\u6b65\u72b6\u6001\uff0c\u72ec\u5360\u6a21\u5f0f 0 \u8868\u793a\u672a\u52a0\u9501\u72b6\u6001\uff0c\u5927\u4e8e 0 \u8868\u793a\u5df2\u7ecf\u52a0\u9501\u72b6\u6001"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private volatile int state;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["state ",(0,r.jsx)(e.strong,{children:"\u4f7f\u7528 volatile \u4fee\u9970\u914d\u5408 cas"})," \u4fdd\u8bc1\u5176\u4fee\u6539\u65f6\u7684\u539f\u5b50\u6027"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["state \u8868\u793a",(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u91cd\u5165\u7684\u6b21\u6570\uff08\u72ec\u5360\u6a21\u5f0f\uff09\u6216\u8005\u5269\u4f59\u8bb8\u53ef\u6570\uff08\u5171\u4eab\u6a21\u5f0f\uff09"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"state API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"protected final int getState()"}),"\uff1a\u83b7\u53d6 state \u72b6\u6001"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"protected final void setState(int newState)"}),"\uff1a\u8bbe\u7f6e state \u72b6\u6001"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"protected final boolean compareAndSetState(int expect,int update)"}),"\uff1a",(0,r.jsx)(e.strong,{children:"CAS"})," \u5b89\u5168\u8bbe\u7f6e state"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5c01\u88c5\u7ebf\u7a0b\u7684 Node \u8282\u70b9\u4e2d waitstate \u8bbe\u8ba1\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4f7f\u7528 ",(0,r.jsx)(e.strong,{children:"volatile \u4fee\u9970\u914d\u5408 CAS"})," \u4fdd\u8bc1\u5176\u4fee\u6539\u65f6\u7684\u539f\u5b50\u6027"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8868\u793a Node \u8282\u70b9\u7684\u72b6\u6001\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u72b6\u6001\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u9ed8\u8ba4\u4e3a 0\nvolatile int waitStatus;\n// \u7531\u4e8e\u8d85\u65f6\u6216\u4e2d\u65ad\uff0c\u6b64\u8282\u70b9\u88ab\u53d6\u6d88\uff0c\u4e0d\u4f1a\u518d\u6539\u53d8\u72b6\u6001\nstatic final int CANCELLED =  1;\n// \u6b64\u8282\u70b9\u540e\u9762\u7684\u8282\u70b9\u5df2\uff08\u6216\u5373\u5c06\uff09\u88ab\u963b\u6b62\uff08\u901a\u8fc7park\uff09\uff0c\u3010\u5f53\u524d\u8282\u70b9\u5728\u91ca\u653e\u6216\u53d6\u6d88\u65f6\u5fc5\u987b\u5524\u9192\u540e\u9762\u7684\u8282\u70b9\u3011\nstatic final int SIGNAL    = -1;\n// \u6b64\u8282\u70b9\u5f53\u524d\u5728\u6761\u4ef6\u961f\u5217\u4e2d\nstatic final int CONDITION = -2;\n// \u5c06releaseShared\u4f20\u64ad\u5230\u5176\u4ed6\u8282\u70b9\nstatic final int PROPAGATE = -3;\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u963b\u585e\u6062\u590d\u8bbe\u8ba1\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528 park & unpark \u6765\u5b9e\u73b0\u7ebf\u7a0b\u7684\u6682\u505c\u548c\u6062\u590d\uff0c\u56e0\u4e3a\u547d\u4ee4\u7684\u5148\u540e\u987a\u5e8f\u4e0d\u5f71\u54cd\u7ed3\u679c"}),"\n",(0,r.jsx)(e.li,{children:"park & unpark \u662f\u9488\u5bf9\u7ebf\u7a0b\u7684\uff0c\u800c\u4e0d\u662f\u9488\u5bf9\u540c\u6b65\u5668\u7684\uff0c\u56e0\u6b64\u63a7\u5236\u7c92\u5ea6\u66f4\u4e3a\u7cbe\u7ec6"}),"\n",(0,r.jsx)(e.li,{children:"park \u7ebf\u7a0b\u53ef\u4ee5\u901a\u8fc7 interrupt \u6253\u65ad"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u961f\u5217\u8bbe\u8ba1\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4f7f\u7528\u4e86 FIFO \u5148\u5165\u5148\u51fa\u961f\u5217\uff0c\u5e76\u4e0d\u652f\u6301\u4f18\u5148\u7ea7\u961f\u5217\uff0c",(0,r.jsx)(e.strong,{children:"\u540c\u6b65\u961f\u5217\u662f\u53cc\u5411\u94fe\u8868\uff0c\u4fbf\u4e8e\u51fa\u961f\u5165\u961f"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5934\u7ed3\u70b9\uff0c\u6307\u5411\u54d1\u5143\u8282\u70b9\nprivate transient volatile Node head;\n// \u963b\u585e\u961f\u5217\u7684\u5c3e\u8282\u70b9\uff0c\u963b\u585e\u961f\u5217\u4e0d\u5305\u542b\u5934\u7ed3\u70b9\uff0c\u4ece head.next \u2192 tail \u8ba4\u4e3a\u662f\u963b\u585e\u961f\u5217\nprivate transient volatile Node tail;\n\nstatic final class Node {\n    // \u679a\u4e3e\uff1a\u5171\u4eab\u6a21\u5f0f\n    static final Node SHARED = new Node();\n    // \u679a\u4e3e\uff1a\u72ec\u5360\u6a21\u5f0f\n    static final Node EXCLUSIVE = null;\n    // node \u9700\u8981\u6784\u5efa\u6210 FIFO \u961f\u5217\uff0cprev \u6307\u5411\u524d\u7ee7\u8282\u70b9\n    volatile Node prev;\n    // next \u6307\u5411\u540e\u7ee7\u8282\u70b9\n    volatile Node next;\n    // \u5f53\u524d node \u5c01\u88c5\u7684\u7ebf\u7a0b\n    volatile Thread thread;\n    // \u6761\u4ef6\u961f\u5217\u662f\u5355\u5411\u94fe\u8868\uff0c\u53ea\u6709\u540e\u7ee7\u6307\u9488\uff0c\u6761\u4ef6\u961f\u5217\u4f7f\u7528\u8be5\u5c5e\u6027\n    Node nextWaiter;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(25999).A+"",width:"719",height:"252"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6761\u4ef6\u53d8\u91cf\u6765\u5b9e\u73b0\u7b49\u5f85\u3001\u5524\u9192\u673a\u5236\uff0c\u652f\u6301\u591a\u4e2a\u6761\u4ef6\u53d8\u91cf\uff0c\u7c7b\u4f3c\u4e8e Monitor \u7684 WaitSet\uff0c",(0,r.jsx)(e.strong,{children:"\u6761\u4ef6\u961f\u5217\u662f\u5355\u5411\u94fe\u8868"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:" public class ConditionObject implements Condition, java.io.Serializable {\n     // \u6307\u5411\u6761\u4ef6\u961f\u5217\u7684\u7b2c\u4e00\u4e2a node \u8282\u70b9\n     private transient Node firstWaiter;\n     // \u6307\u5411\u6761\u4ef6\u961f\u5217\u7684\u6700\u540e\u4e00\u4e2a node \u8282\u70b9\n     private transient Node lastWaiter;\n }\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6a21\u677f\u5bf9\u8c61",children:"\u6a21\u677f\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u6b65\u5668\u7684\u8bbe\u8ba1\u662f\u57fa\u4e8e\u6a21\u677f\u65b9\u6cd5\u6a21\u5f0f\uff0c\u8be5\u6a21\u5f0f\u662f\u57fa\u4e8e\u7ee7\u627f\u7684\uff0c\u4e3b\u8981\u662f\u4e3a\u4e86\u5728\u4e0d\u6539\u53d8\u6a21\u677f\u7ed3\u6784\u7684\u524d\u63d0\u4e0b\u5728\u5b50\u7c7b\u4e2d\u91cd\u65b0\u5b9a\u4e49\u6a21\u677f\u4e2d\u7684\u5185\u5bb9\u4ee5\u5b9e\u73b0\u590d\u7528\u4ee3\u7801"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u4f7f\u7528\u8005\u7ee7\u627f ",(0,r.jsx)(e.code,{children:"AbstractQueuedSynchronizer"})," \u5e76\u91cd\u5199\u6307\u5b9a\u7684\u65b9\u6cd5"]}),"\n",(0,r.jsx)(e.li,{children:"\u5c06 AQS \u7ec4\u5408\u5728\u81ea\u5b9a\u4e49\u540c\u6b65\u7ec4\u4ef6\u7684\u5b9e\u73b0\u4e2d\uff0c\u5e76\u8c03\u7528\u5176\u6a21\u677f\u65b9\u6cd5\uff0c\u8fd9\u4e9b\u6a21\u677f\u65b9\u6cd5\u4f1a\u8c03\u7528\u4f7f\u7528\u8005\u91cd\u5199\u7684\u65b9\u6cd5"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"AQS \u4f7f\u7528\u4e86\u6a21\u677f\u65b9\u6cd5\u6a21\u5f0f\uff0c\u81ea\u5b9a\u4e49\u540c\u6b65\u5668\u65f6\u9700\u8981\u91cd\u5199\u4e0b\u9762\u51e0\u4e2a AQS \u63d0\u4f9b\u7684\u6a21\u677f\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"isHeldExclusively()\t\t//\u8be5\u7ebf\u7a0b\u662f\u5426\u6b63\u5728\u72ec\u5360\u8d44\u6e90\u3002\u53ea\u6709\u7528\u5230condition\u624d\u9700\u8981\u53bb\u5b9e\u73b0\u5b83\ntryAcquire(int)\t\t\t//\u72ec\u5360\u65b9\u5f0f\u3002\u5c1d\u8bd5\u83b7\u53d6\u8d44\u6e90\uff0c\u6210\u529f\u5219\u8fd4\u56detrue\uff0c\u5931\u8d25\u5219\u8fd4\u56defalse\ntryRelease(int)\t\t\t//\u72ec\u5360\u65b9\u5f0f\u3002\u5c1d\u8bd5\u91ca\u653e\u8d44\u6e90\uff0c\u6210\u529f\u5219\u8fd4\u56detrue\uff0c\u5931\u8d25\u5219\u8fd4\u56defalse\ntryAcquireShared(int)\t//\u5171\u4eab\u65b9\u5f0f\u3002\u5c1d\u8bd5\u83b7\u53d6\u8d44\u6e90\u3002\u8d1f\u6570\u8868\u793a\u5931\u8d25\uff1b0\u8868\u793a\u6210\u529f\u4f46\u6ca1\u6709\u5269\u4f59\u53ef\u7528\u8d44\u6e90\uff1b\u6b63\u6570\u8868\u793a\u6210\u529f\u4e14\u6709\u5269\u4f59\u8d44\u6e90\ntryReleaseShared(int)\t//\u5171\u4eab\u65b9\u5f0f\u3002\u5c1d\u8bd5\u91ca\u653e\u8d44\u6e90\uff0c\u6210\u529f\u5219\u8fd4\u56detrue\uff0c\u5931\u8d25\u5219\u8fd4\u56defalse\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u65b9\u6cd5\u90fd\u629b\u51fa ",(0,r.jsx)(e.code,{children:"UnsupportedOperationException"})]}),"\n",(0,r.jsx)(e.li,{children:"\u8fd9\u4e9b\u65b9\u6cd5\u7684\u5b9e\u73b0\u5fc5\u987b\u662f\u5185\u90e8\u7ebf\u7a0b\u5b89\u5168\u7684"}),"\n",(0,r.jsx)(e.li,{children:"AQS \u7c7b\u4e2d\u7684\u5176\u4ed6\u65b9\u6cd5\u90fd\u662f final \uff0c\u6240\u4ee5\u65e0\u6cd5\u88ab\u5176\u4ed6\u7c7b\u4f7f\u7528\uff0c\u53ea\u6709\u8fd9\u51e0\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u88ab\u5176\u4ed6\u7c7b\u4f7f\u7528"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u81ea\u5b9a\u4e49",children:"\u81ea\u5b9a\u4e49"}),"\n",(0,r.jsx)(e.p,{children:"\u81ea\u5b9a\u4e49\u4e00\u4e2a\u4e0d\u53ef\u91cd\u5165\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"class MyLock implements Lock {\n    //\u72ec\u5360\u9501 \u4e0d\u53ef\u91cd\u5165\n    class MySync extends AbstractQueuedSynchronizer {\n        @Override\n        protected boolean tryAcquire(int arg) {\n            if (compareAndSetState(0, 1)) {\n                // \u52a0\u4e0a\u9501 \u8bbe\u7f6e owner \u4e3a\u5f53\u524d\u7ebf\u7a0b\n                setExclusiveOwnerThread(Thread.currentThread());\n                return true;\n            }\n            return false;\n        }\n        @Override   //\u89e3\u9501\n        protected boolean tryRelease(int arg) {\n            setExclusiveOwnerThread(null);\n            setState(0);//volatile \u4fee\u9970\u7684\u53d8\u91cf\u653e\u5728\u540e\u9762\uff0c\u9632\u6b62\u6307\u4ee4\u91cd\u6392\n            return true;\n        }\n        @Override   //\u662f\u5426\u6301\u6709\u72ec\u5360\u9501\n        protected boolean isHeldExclusively() {\n            return getState() == 1;\n        }\n        public Condition newCondition() {\n            return new ConditionObject();\n        }\n    }\n\n    private MySync sync = new MySync();\n\n    @Override   //\u52a0\u9501\uff08\u4e0d\u6210\u529f\u8fdb\u5165\u7b49\u5f85\u961f\u5217\u7b49\u5f85\uff09\n    public void lock() {\n        sync.acquire(1);\n    }\n\n    @Override   //\u52a0\u9501 \u53ef\u6253\u65ad\n    public void lockInterruptibly() throws InterruptedException {\n        sync.acquireInterruptibly(1);\n    }\n\n    @Override   //\u5c1d\u8bd5\u52a0\u9501\uff0c\u5c1d\u8bd5\u4e00\u6b21\n    public boolean tryLock() {\n        return sync.tryAcquire(1);\n    }\n\n    @Override   //\u5c1d\u8bd5\u52a0\u9501\uff0c\u5e26\u8d85\u65f6\n    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {\n        return sync.tryAcquireNanos(1, unit.toNanos(time));\n    }\n    \n    @Override   //\u89e3\u9501\n    public void unlock() {\n        sync.release(1);\n    }\n    \n    @Override   //\u6761\u4ef6\u53d8\u91cf\n    public Condition newCondition() {\n        return sync.newCondition();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"re-lock",children:"Re-Lock"}),"\n",(0,r.jsx)(e.h4,{id:"\u9501\u5bf9\u6bd4",children:"\u9501\u5bf9\u6bd4"}),"\n",(0,r.jsx)(e.p,{children:"ReentrantLock \u76f8\u5bf9\u4e8e synchronized \u5177\u5907\u5982\u4e0b\u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u9501\u7684\u5b9e\u73b0\uff1asynchronized \u662f JVM \u5b9e\u73b0\u7684\uff0c\u800c ReentrantLock \u662f JDK \u5b9e\u73b0\u7684"}),"\n",(0,r.jsx)(e.li,{children:"\u6027\u80fd\uff1a\u65b0\u7248\u672c Java \u5bf9 synchronized \u8fdb\u884c\u4e86\u5f88\u591a\u4f18\u5316\uff0csynchronized \u4e0e ReentrantLock \u5927\u81f4\u76f8\u540c"}),"\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\uff1aReentrantLock \u9700\u8981\u624b\u52a8\u89e3\u9501\uff0csynchronized \u6267\u884c\u5b8c\u4ee3\u7801\u5757\u81ea\u52a8\u89e3\u9501"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u53ef\u4e2d\u65ad"}),"\uff1aReentrantLock \u53ef\u4e2d\u65ad\uff0c\u800c synchronized \u4e0d\u884c"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u516c\u5e73\u9501"}),"\uff1a\u516c\u5e73\u9501\u662f\u6307\u591a\u4e2a\u7ebf\u7a0b\u5728\u7b49\u5f85\u540c\u4e00\u4e2a\u9501\u65f6\uff0c\u5fc5\u987b\u6309\u7167\u7533\u8bf7\u9501\u7684\u65f6\u95f4\u987a\u5e8f\u6765\u4f9d\u6b21\u83b7\u5f97\u9501\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"ReentrantLock \u53ef\u4ee5\u8bbe\u7f6e\u516c\u5e73\u9501\uff0csynchronized \u4e2d\u7684\u9501\u662f\u975e\u516c\u5e73\u7684"}),"\n",(0,r.jsx)(e.li,{children:"\u4e0d\u516c\u5e73\u9501\u7684\u542b\u4e49\u662f\u963b\u585e\u961f\u5217\u5185\u516c\u5e73\uff0c\u961f\u5217\u5916\u975e\u516c\u5e73"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u9501\u8d85\u65f6\uff1a\u5c1d\u8bd5\u83b7\u53d6\u9501\uff0c\u8d85\u65f6\u83b7\u53d6\u4e0d\u5230\u76f4\u63a5\u653e\u5f03\uff0c\u4e0d\u8fdb\u5165\u963b\u585e\u961f\u5217\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"ReentrantLock \u53ef\u4ee5\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\uff0csynchronized \u4f1a\u4e00\u76f4\u7b49\u5f85"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u9501\u7ed1\u5b9a\u591a\u4e2a\u6761\u4ef6\uff1a\u4e00\u4e2a ReentrantLock \u53ef\u4ee5\u540c\u65f6\u7ed1\u5b9a\u591a\u4e2a Condition \u5bf9\u8c61\uff0c\u66f4\u7ec6\u7c92\u5ea6\u7684\u5524\u9192\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"\u4e24\u8005\u90fd\u662f\u53ef\u91cd\u5165\u9501"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4f7f\u7528\u9501-1",children:"\u4f7f\u7528\u9501"}),"\n",(0,r.jsxs)(e.p,{children:["\u6784\u9020\u65b9\u6cd5\uff1a",(0,r.jsx)(e.code,{children:"ReentrantLock lock = new ReentrantLock();"})]}),"\n",(0,r.jsx)(e.p,{children:"ReentrantLock \u7c7b API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public void lock()"}),"\uff1a\u83b7\u5f97\u9501"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u9501\u6ca1\u6709\u88ab\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5360\u7528\uff0c\u5219\u5c06\u9501\u5b9a\u8ba1\u6570\u8bbe\u7f6e\u4e3a 1"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u5df2\u7ecf\u4fdd\u6301\u9501\u5b9a\uff0c\u5219\u4fdd\u6301\u8ba1\u6570\u589e\u52a0 1"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u9501\u88ab\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u4fdd\u6301\uff0c\u5219\u5f53\u524d\u7ebf\u7a0b\u88ab\u7981\u7528\u7ebf\u7a0b\u8c03\u5ea6\uff0c\u5e76\u4e14\u5728\u9501\u5b9a\u5df2\u88ab\u83b7\u53d6\u4e4b\u524d\u5904\u4e8e\u4f11\u7720\u72b6\u6001"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public void unlock()"}),"\uff1a\u5c1d\u8bd5\u91ca\u653e\u9501"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u662f\u8be5\u9501\u7684\u6301\u6709\u8005\uff0c\u5219\u4fdd\u6301\u8ba1\u6570\u9012\u51cf"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u4fdd\u6301\u8ba1\u6570\u73b0\u5728\u4e3a\u96f6\uff0c\u5219\u9501\u5b9a\u88ab\u91ca\u653e"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u4e0d\u662f\u8be5\u9501\u7684\u6301\u6709\u8005\uff0c\u5219\u629b\u51fa\u5f02\u5e38"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u57fa\u672c\u8bed\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u83b7\u53d6\u9501\nreentrantLock.lock();\ntry {\n    // \u4e34\u754c\u533a\n} finally {\n\t// \u91ca\u653e\u9501\n\treentrantLock.unlock();\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u516c\u5e73\u9501",children:"\u516c\u5e73\u9501"}),"\n",(0,r.jsx)(e.h5,{id:"\u57fa\u672c\u4f7f\u7528-3",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsxs)(e.p,{children:["\u6784\u9020\u65b9\u6cd5\uff1a",(0,r.jsx)(e.code,{children:"ReentrantLock lock = new ReentrantLock(true)"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ReentrantLock(boolean fair) {\n    sync = fair ? new FairSync() : new NonfairSync();\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"ReentrantLock \u9ed8\u8ba4\u662f\u4e0d\u516c\u5e73\u7684\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ReentrantLock() {\n    sync = new NonfairSync();\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u8bf4\u660e\uff1a\u516c\u5e73\u9501\u4e00\u822c\u6ca1\u6709\u5fc5\u8981\uff0c\u4f1a\u964d\u4f4e\u5e76\u53d1\u5ea6"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u975e\u516c\u539f\u7406",children:"\u975e\u516c\u539f\u7406"}),"\n",(0,r.jsx)(e.h6,{id:"\u52a0\u9501",children:"\u52a0\u9501"}),"\n",(0,r.jsx)(e.p,{children:"NonfairSync \u7ee7\u627f\u81ea AQS"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void lock() {\n    sync.lock();\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6ca1\u6709\u7ade\u4e89\uff1aExclusiveOwnerThread \u5c5e\u4e8e Thread-0\uff0cstate \u8bbe\u7f6e\u4e3a 1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// ReentrantLock.NonfairSync#lock\nfinal void lock() {\n    // \u7528 cas \u5c1d\u8bd5\uff08\u4ec5\u5c1d\u8bd5\u4e00\u6b21\uff09\u5c06 state \u4ece 0 \u6539\u4e3a 1, \u5982\u679c\u6210\u529f\u8868\u793a\u3010\u83b7\u5f97\u4e86\u72ec\u5360\u9501\u3011\n    if (compareAndSetState(0, 1))\n        // \u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u4e3a\u72ec\u5360\u7ebf\u7a0b\n        setExclusiveOwnerThread(Thread.currentThread());\n    else\n        acquire(1);//\u5931\u8d25\u8fdb\u5165\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7b2c\u4e00\u4e2a\u7ade\u4e89\u51fa\u73b0\uff1aThread-1 \u6267\u884c\uff0cCAS \u5c1d\u8bd5\u5c06 state \u7531 0 \u6539\u4e3a 1\uff0c\u7ed3\u679c\u5931\u8d25\uff08\u7b2c\u4e00\u6b21\uff09\uff0c\u8fdb\u5165 acquire \u903b\u8f91"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// AbstractQueuedSynchronizer#acquire\npublic final void acquire(int arg) {\n    // tryAcquire \u5c1d\u8bd5\u83b7\u53d6\u9501\u5931\u8d25\u65f6, \u4f1a\u8c03\u7528 addWaiter \u5c06\u5f53\u524d\u7ebf\u7a0b\u5c01\u88c5\u6210node\u5165\u961f\uff0cacquireQueued \u963b\u585e\u5f53\u524d\u7ebf\u7a0b\uff0c\n    // acquireQueued \u8fd4\u56de true \u8868\u793a\u6302\u8d77\u8fc7\u7a0b\u4e2d\u7ebf\u7a0b\u88ab\u4e2d\u65ad\u5524\u9192\u8fc7\uff0cfalse \u8868\u793a\u672a\u88ab\u4e2d\u65ad\u8fc7\n    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n        // \u5982\u679c\u7ebf\u7a0b\u88ab\u4e2d\u65ad\u4e86\u903b\u8f91\u6765\u5230\u8fd9\uff0c\u5b8c\u6210\u4e00\u6b21\u771f\u6b63\u7684\u6253\u65ad\u6548\u679c\n        selfInterrupt();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(12225).A+"",width:"640",height:"277"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fdb\u5165 tryAcquire \u5c1d\u8bd5\u83b7\u53d6\u9501\u903b\u8f91\uff0c\u8fd9\u65f6 state \u5df2\u7ecf\u662f1\uff0c\u7ed3\u679c\u4ecd\u7136\u5931\u8d25\uff08\u7b2c\u4e8c\u6b21\uff09\uff0c\u52a0\u9501\u6210\u529f\u6709\u4e24\u79cd\u60c5\u51b5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53\u524d AQS \u5904\u4e8e\u65e0\u9501\u72b6\u6001"}),"\n",(0,r.jsx)(e.li,{children:"\u52a0\u9501\u7ebf\u7a0b\u5c31\u662f\u5f53\u524d\u7ebf\u7a0b\uff0c\u8bf4\u660e\u53d1\u751f\u4e86\u9501\u91cd\u5165"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// ReentrantLock.NonfairSync#tryAcquire\nprotected final boolean tryAcquire(int acquires) {\n    return nonfairTryAcquire(acquires);\n}\n// \u62a2\u5360\u6210\u529f\u8fd4\u56de true\uff0c\u62a2\u5360\u5931\u8d25\u8fd4\u56de false\nfinal boolean nonfairTryAcquire(int acquires) {\n    final Thread current = Thread.currentThread();\n    // state \u503c\n    int c = getState();\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u5904\u4e8e\u3010\u65e0\u9501\u72b6\u6001\u3011\n    if (c == 0) {\n        //\u5982\u679c\u8fd8\u6ca1\u6709\u83b7\u5f97\u9501\uff0c\u5c1d\u8bd5\u7528cas\u83b7\u5f97\uff0c\u8fd9\u91cc\u4f53\u73b0\u975e\u516c\u5e73\u6027: \u4e0d\u53bb\u68c0\u67e5 AQS \u961f\u5217\u662f\u5426\u6709\u963b\u585e\u7ebf\u7a0b\u76f4\u63a5\u83b7\u53d6\u9501        \n    \tif (compareAndSetState(0, acquires)) {\n            // \u83b7\u53d6\u9501\u6210\u529f\u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u4e3a\u72ec\u5360\u9501\u7ebf\u7a0b\u3002\n            setExclusiveOwnerThread(current);\n            return true;\n         }    \n\t}    \n   \t// \u5982\u679c\u5df2\u7ecf\u6709\u7ebf\u7a0b\u83b7\u5f97\u4e86\u9501, \u72ec\u5360\u9501\u7ebf\u7a0b\u8fd8\u662f\u5f53\u524d\u7ebf\u7a0b, \u8868\u793a\u3010\u53d1\u751f\u4e86\u9501\u91cd\u5165\u3011\n\telse if (current == getExclusiveOwnerThread()) {\n        // \u66f4\u65b0\u9501\u91cd\u5165\u7684\u503c\n        int nextc = c + acquires;\n        // \u8d8a\u754c\u5224\u65ad\uff0c\u5f53\u91cd\u5165\u7684\u6df1\u5ea6\u5f88\u6df1\u65f6\uff0c\u4f1a\u5bfc\u81f4 nextc < 0\uff0cint\u503c\u8fbe\u5230\u6700\u5927\u4e4b\u540e\u518d + 1 \u53d8\u8d1f\u6570\n        if (nextc < 0) // overflow\n            throw new Error("Maximum lock count exceeded");\n        // \u66f4\u65b0 state \u7684\u503c\uff0c\u8fd9\u91cc\u4e0d\u4f7f\u7528 cas \u662f\u56e0\u4e3a\u5f53\u524d\u7ebf\u7a0b\u6b63\u5728\u6301\u6709\u9501\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u64cd\u4f5c\u76f8\u5f53\u4e8e\u5728\u4e00\u4e2a\u7ba1\u7a0b\u5185\n        setState(nextc);\n        return true;\n    }\n    // \u83b7\u53d6\u5931\u8d25\n    return false;\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u63a5\u4e0b\u6765\u8fdb\u5165 addWaiter \u903b\u8f91\uff0c\u6784\u9020 Node \u961f\u5217\uff08\u4e0d\u662f\u963b\u585e\u961f\u5217\uff09\uff0c\u524d\u7f6e\u6761\u4ef6\u662f\u5f53\u524d\u7ebf\u7a0b\u83b7\u53d6\u9501\u5931\u8d25\uff0c\u8bf4\u660e\u6709\u7ebf\u7a0b\u5360\u7528\u4e86\u9501"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u56fe\u4e2d\u9ec4\u8272\u4e09\u89d2\u8868\u793a\u8be5 Node \u7684 waitStatus \u72b6\u6001\uff0c\u5176\u4e2d 0 \u4e3a\u9ed8\u8ba4",(0,r.jsx)(e.strong,{children:"\u6b63\u5e38\u72b6\u6001"})]}),"\n",(0,r.jsxs)(e.li,{children:["Node \u7684\u521b\u5efa\u662f\u61d2\u60f0\u7684\uff0c\u5176\u4e2d\u7b2c\u4e00\u4e2a Node \u79f0\u4e3a ",(0,r.jsx)(e.strong,{children:"Dummy\uff08\u54d1\u5143\uff09\u6216\u54e8\u5175"}),"\uff0c\u7528\u6765\u5360\u4f4d\uff0c\u5e76\u4e0d\u5173\u8054\u7ebf\u7a0b"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// AbstractQueuedSynchronizer#addWaiter\uff0c\u8fd4\u56de\u5f53\u524d\u7ebf\u7a0b\u7684 node \u8282\u70b9\nprivate Node addWaiter(Node mode) {\n    // \u5c06\u5f53\u524d\u7ebf\u7a0b\u5173\u8054\u5230\u4e00\u4e2a Node \u5bf9\u8c61\u4e0a, \u6a21\u5f0f\u4e3a\u72ec\u5360\u6a21\u5f0f   \n    Node node = new Node(Thread.currentThread(), mode);\n    Node pred = tail;\n    // \u5feb\u901f\u5165\u961f\uff0c\u5982\u679c tail \u4e0d\u4e3a null\uff0c\u8bf4\u660e\u5b58\u5728\u961f\u5217\n    if (pred != null) {\n        // \u5c06\u5f53\u524d\u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\u6307\u5411 \u5c3e\u8282\u70b9\n        node.prev = pred;\n        // \u901a\u8fc7 cas \u5c06 Node \u5bf9\u8c61\u52a0\u5165 AQS \u961f\u5217\uff0c\u6210\u4e3a\u5c3e\u8282\u70b9\uff0c\u3010\u5c3e\u63d2\u6cd5\u3011\n        if (compareAndSetTail(pred, node)) {\n            pred.next = node;// \u53cc\u5411\u94fe\u8868\n            return node;\n        }\n    }\n    // \u521d\u59cb\u65f6\u961f\u5217\u4e3a\u7a7a\uff0c\u6216\u8005 CAS \u5931\u8d25\u8fdb\u5165\u8fd9\u91cc\n    enq(node);\n    return node;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// AbstractQueuedSynchronizer#enq\nprivate Node enq(final Node node) {\n    // \u81ea\u65cb\u5165\u961f\uff0c\u5fc5\u987b\u5165\u961f\u6210\u529f\u624d\u7ed3\u675f\u5faa\u73af\n    for (;;) {\n        Node t = tail;\n        // \u8bf4\u660e\u5f53\u524d\u9501\u88ab\u5360\u7528\uff0c\u4e14\u5f53\u524d\u7ebf\u7a0b\u53ef\u80fd\u662f\u3010\u7b2c\u4e00\u4e2a\u83b7\u53d6\u9501\u5931\u8d25\u3011\u7684\u7ebf\u7a0b\uff0c\u3010\u8fd8\u6ca1\u6709\u5efa\u7acb\u961f\u5217\u3011\n        if (t == null) {\n            // \u8bbe\u7f6e\u4e00\u4e2a\u3010\u54d1\u5143\u8282\u70b9\u3011\uff0c\u5934\u5c3e\u6307\u9488\u90fd\u6307\u5411\u8be5\u8282\u70b9\n            if (compareAndSetHead(new Node()))\n                tail = head;\n        } else {\n            // \u81ea\u65cb\u5230\u8fd9\uff0c\u666e\u901a\u5165\u961f\u65b9\u5f0f\uff0c\u9996\u5148\u8d4b\u503c\u5c3e\u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\u3010\u5c3e\u63d2\u6cd5\u3011\n            node.prev = t;\n            // \u3010\u5728\u8bbe\u7f6e\u5b8c\u5c3e\u8282\u70b9\u540e\uff0c\u624d\u66f4\u65b0\u7684\u539f\u59cb\u5c3e\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\uff0c\u6240\u4ee5\u6b64\u65f6\u4ece\u524d\u5f80\u540e\u904d\u5386\u4f1a\u4e22\u5931\u5c3e\u8282\u70b9\u3011\n            if (compareAndSetTail(t, node)) {\n                //\u3010\u6b64\u65f6 t.next  = null\uff0c\u5e76\u4e14\u8fd9\u91cc\u5df2\u7ecf CAS \u7ed3\u675f\uff0c\u7ebf\u7a0b\u5e76\u4e0d\u662f\u5b89\u5168\u7684\u3011\n                t.next = node;\n                return t;\t// \u8fd4\u56de\u5f53\u524d node \u7684\u524d\u9a71\u8282\u70b9\n            }\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(63242).A+"",width:"739",height:"252"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u8282\u70b9\u52a0\u5165\u961f\u5217\u6210\u529f\uff0c\u8fdb\u5165 AbstractQueuedSynchronizer#acquireQueued \u903b\u8f91\u963b\u585e\u7ebf\u7a0b"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"acquireQueued \u4f1a\u5728\u4e00\u4e2a\u81ea\u65cb\u4e2d\u4e0d\u65ad\u5c1d\u8bd5\u83b7\u5f97\u9501\uff0c\u5931\u8d25\u540e\u8fdb\u5165 park \u963b\u585e"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u662f\u5728 head \u8282\u70b9\u540e\uff0c\u4f1a\u518d\u6b21 tryAcquire \u5c1d\u8bd5\u83b7\u53d6\u9501\uff0cstate \u4ecd\u4e3a 1 \u5219\u5931\u8d25\uff08\u7b2c\u4e09\u6b21\uff09"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final boolean acquireQueued(final Node node, int arg) {\n    // true \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u62a2\u5360\u9501\u5931\u8d25\uff0cfalse \u8868\u793a\u6210\u529f\n    boolean failed = true;\n    try {\n        // \u4e2d\u65ad\u6807\u8bb0\uff0c\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u4e2d\u65ad\n        boolean interrupted = false;\n        for (;;) {\n            // \u83b7\u5f97\u5f53\u524d\u7ebf\u7a0b\u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\n            final Node p = node.predecessor();\n            // \u524d\u9a71\u8282\u70b9\u662f head, FIFO \u961f\u5217\u7684\u7279\u6027\u8868\u793a\u8f6e\u5230\u5f53\u524d\u7ebf\u7a0b\u53ef\u4ee5\u53bb\u83b7\u53d6\u9501\n            if (p == head && tryAcquire(arg)) {\n                // \u83b7\u53d6\u6210\u529f, \u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u81ea\u5df1\u7684 node \u4e3a head\n                setHead(node);\n                p.next = null; // help GC\n                // \u8868\u793a\u62a2\u5360\u9501\u6210\u529f\n                failed = false;\n                // \u8fd4\u56de\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u4e2d\u65ad\n                return interrupted;\n            }\n            // \u5224\u65ad\u662f\u5426\u5e94\u5f53 park\uff0c\u8fd4\u56de false \u540e\u9700\u8981\u65b0\u4e00\u8f6e\u7684\u5faa\u73af\uff0c\u8fd4\u56de true \u8fdb\u5165\u6761\u4ef6\u4e8c\u963b\u585e\u7ebf\u7a0b\n            if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\n                // \u6761\u4ef6\u4e8c\u8fd4\u56de\u7ed3\u679c\u662f\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u6ca1\u6709\u88ab\u6253\u65ad\u8fd4\u56de false \u4e0d\u8fdb\u5165\u8fd9\u91cc\u7684\u903b\u8f91\n                // \u3010\u5c31\u7b97\u88ab\u6253\u65ad\u4e86\uff0c\u4e5f\u4f1a\u7ee7\u7eed\u5faa\u73af\uff0c\u5e76\u4e0d\u4f1a\u8fd4\u56de\u3011\n                interrupted = true;\n        }\n    } finally {\n        // \u3010\u53ef\u6253\u65ad\u6a21\u5f0f\u4e0b\u624d\u4f1a\u8fdb\u5165\u8be5\u903b\u8f91\u3011\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u8fdb\u5165 shouldParkAfterFailedAcquire \u903b\u8f91\uff0c",(0,r.jsx)(e.strong,{children:"\u5c06\u524d\u9a71 node \u7684 waitStatus \u6539\u4e3a -1"}),"\uff0c\u8fd4\u56de false\uff1bwaitStatus \u4e3a -1 \u7684\u8282\u70b9\u7528\u6765\u5524\u9192\u4e0b\u4e00\u4e2a\u8282\u70b9"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {\n    int ws = pred.waitStatus;\n    // \u8868\u793a\u524d\u7f6e\u8282\u70b9\u662f\u4e2a\u53ef\u4ee5\u5524\u9192\u5f53\u524d\u8282\u70b9\u7684\u8282\u70b9\uff0c\u8fd4\u56de true\n    if (ws == Node.SIGNAL)\n        return true;\n    // \u524d\u7f6e\u8282\u70b9\u7684\u72b6\u6001\u5904\u4e8e\u53d6\u6d88\u72b6\u6001\uff0c\u9700\u8981\u3010\u5220\u9664\u524d\u9762\u6240\u6709\u53d6\u6d88\u7684\u8282\u70b9\u3011, \u8fd4\u56de\u5230\u5916\u5c42\u5faa\u73af\u91cd\u8bd5\n    if (ws > 0) {\n        do {\n            node.prev = pred = pred.prev;\n        } while (pred.waitStatus > 0);\n        // \u83b7\u53d6\u5230\u975e\u53d6\u6d88\u7684\u8282\u70b9\uff0c\u8fde\u63a5\u4e0a\u5f53\u524d\u8282\u70b9\n        pred.next = node;\n    // \u9ed8\u8ba4\u60c5\u51b5\u4e0b node \u7684 waitStatus \u662f 0\uff0c\u8fdb\u5165\u8fd9\u91cc\u7684\u903b\u8f91\n    } else {\n        // \u3010\u8bbe\u7f6e\u4e0a\u4e00\u4e2a\u8282\u70b9\u72b6\u6001\u4e3a Node.SIGNAL\u3011\uff0c\u8fd4\u56de\u5916\u5c42\u5faa\u73af\u91cd\u8bd5\n        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);\n    }\n    // \u8fd4\u56de\u4e0d\u5e94\u8be5 park\uff0c\u518d\u6b21\u5c1d\u8bd5\u4e00\u6b21\n    return false;\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"shouldParkAfterFailedAcquire \u6267\u884c\u5b8c\u6bd5\u56de\u5230 acquireQueued \uff0c\u518d\u6b21 tryAcquire \u5c1d\u8bd5\u83b7\u53d6\u9501\uff0c\u8fd9\u65f6 state \u4ecd\u4e3a 1 \u83b7\u53d6\u5931\u8d25\uff08\u7b2c\u56db\u6b21\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53\u518d\u6b21\u8fdb\u5165 shouldParkAfterFailedAcquire \u65f6\uff0c\u8fd9\u65f6\u5176\u524d\u9a71 node \u7684 waitStatus \u5df2\u7ecf\u662f -1 \u4e86\uff0c\u8fd4\u56de true"}),"\n",(0,r.jsx)(e.li,{children:"\u8fdb\u5165 parkAndCheckInterrupt\uff0c Thread-1 park\uff08\u7070\u8272\u8868\u793a\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final boolean parkAndCheckInterrupt() {\n    // \u963b\u585e\u5f53\u524d\u7ebf\u7a0b\uff0c\u5982\u679c\u6253\u65ad\u6807\u8bb0\u5df2\u7ecf\u662f true, \u5219 park \u4f1a\u5931\u6548\n    LockSupport.park(this);\n    // \u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u6e05\u9664\u6253\u65ad\u6807\u8bb0\n    return Thread.interrupted();\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u518d\u6709\u591a\u4e2a\u7ebf\u7a0b\u7ecf\u5386\u7ade\u4e89\u5931\u8d25\u540e\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(2099).A+"",width:"1259",height:"270"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h6,{id:"\u89e3\u9501",children:"\u89e3\u9501"}),"\n",(0,r.jsx)(e.p,{children:"ReentrantLock#unlock\uff1a\u91ca\u653e\u9501"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void unlock() {\n    sync.release(1);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"Thread-0 \u91ca\u653e\u9501\uff0c\u8fdb\u5165 release \u6d41\u7a0b"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fdb\u5165 tryRelease\uff0c\u8bbe\u7f6e exclusiveOwnerThread \u4e3a null\uff0cstate = 0"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u524d\u961f\u5217\u4e0d\u4e3a null\uff0c\u5e76\u4e14 head \u7684 waitStatus = -1\uff0c\u8fdb\u5165 unparkSuccessor"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// AbstractQueuedSynchronizer#release\npublic final boolean release(int arg) {\n    // \u5c1d\u8bd5\u91ca\u653e\u9501\uff0ctryRelease \u8fd4\u56de true \u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u5df2\u7ecf\u3010\u5b8c\u5168\u91ca\u653e\u9501\uff0c\u91cd\u5165\u7684\u91ca\u653e\u4e86\u3011\n    if (tryRelease(arg)) {\n        // \u961f\u5217\u5934\u8282\u70b9\n        Node h = head;\n        // \u5934\u8282\u70b9\u4ec0\u4e48\u65f6\u5019\u662f\u7a7a\uff1f\u6ca1\u6709\u53d1\u751f\u9501\u7ade\u4e89\uff0c\u6ca1\u6709\u7ade\u4e89\u7ebf\u7a0b\u521b\u5efa\u54d1\u5143\u8282\u70b9\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u963b\u585e\u961f\u5217\u6709\u7b49\u5f85\u7ebf\u7a0b\uff0c\u9700\u8981\u5524\u9192 head \u8282\u70b9\u540e\u9762\u7684\u7ebf\u7a0b\n        if (h != null && h.waitStatus != 0)\n            unparkSuccessor(h);\n        return true;\n    }    \n    return false;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// ReentrantLock.Sync#tryRelease\nprotected final boolean tryRelease(int releases) {\n    // \u51cf\u53bb\u91ca\u653e\u7684\u503c\uff0c\u53ef\u80fd\u91cd\u5165\n    int c = getState() - releases;\n    // \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u4e0d\u662f\u6301\u6709\u9501\u7684\u7ebf\u7a0b\u76f4\u63a5\u62a5\u9519\n    if (Thread.currentThread() != getExclusiveOwnerThread())\n        throw new IllegalMonitorStateException();\n    // \u662f\u5426\u5df2\u7ecf\u5b8c\u5168\u91ca\u653e\u9501\n    boolean free = false;\n    // \u652f\u6301\u9501\u91cd\u5165, \u53ea\u6709 state \u51cf\u4e3a 0, \u624d\u5b8c\u5168\u91ca\u653e\u9501\u6210\u529f\n    if (c == 0) {\n        free = true;\n        setExclusiveOwnerThread(null);\n    }\n    // \u5f53\u524d\u7ebf\u7a0b\u5c31\u662f\u6301\u6709\u9501\u7ebf\u7a0b\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u66f4\u65b0\u9501\uff0c\u4e0d\u9700\u8981\u4f7f\u7528 CAS\n    setState(c);\n    return free;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fdb\u5165 AbstractQueuedSynchronizer#unparkSuccessor \u65b9\u6cd5\uff0c\u5524\u9192\u5f53\u524d\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u627e\u5230\u961f\u5217\u4e2d\u8ddd\u79bb head \u6700\u8fd1\u7684\u4e00\u4e2a\u6ca1\u53d6\u6d88\u7684 Node\uff0cunpark \u6062\u590d\u5176\u8fd0\u884c\uff0c\u672c\u4f8b\u4e2d\u5373\u4e3a Thread-1"}),"\n",(0,r.jsx)(e.li,{children:"\u56de\u5230 Thread-1 \u7684 acquireQueued \u6d41\u7a0b"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void unparkSuccessor(Node node) {\n    // \u5f53\u524d\u8282\u70b9\u7684\u72b6\u6001\n    int ws = node.waitStatus;    \n    if (ws < 0)        \n        // \u3010\u5c1d\u8bd5\u91cd\u7f6e\u72b6\u6001\u4e3a 0\u3011\uff0c\u56e0\u4e3a\u5f53\u524d\u8282\u70b9\u8981\u5b8c\u6210\u5bf9\u540e\u7eed\u8282\u70b9\u7684\u5524\u9192\u4efb\u52a1\u4e86\uff0c\u4e0d\u9700\u8981 -1 \u4e86\n        compareAndSetWaitStatus(node, ws, 0);    \n    // \u627e\u5230\u9700\u8981 unpark \u7684\u8282\u70b9\uff0c\u5f53\u524d\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a    \n    Node s = node.next;    \n    // \u5df2\u53d6\u6d88\u7684\u8282\u70b9\u4e0d\u80fd\u5524\u9192\uff0c\u9700\u8981\u627e\u5230\u8ddd\u79bb\u5934\u8282\u70b9\u6700\u8fd1\u7684\u975e\u53d6\u6d88\u7684\u8282\u70b9\n    if (s == null || s.waitStatus > 0) {\n        s = null;\n        // AQS \u961f\u5217\u3010\u4ece\u540e\u81f3\u524d\u3011\u627e\u9700\u8981 unpark \u7684\u8282\u70b9\uff0c\u76f4\u5230 t == \u5f53\u524d\u7684 node \u4e3a\u6b62\uff0c\u627e\u4e0d\u5230\u5c31\u4e0d\u5524\u9192\u4e86\n        for (Node t = tail; t != null && t != node; t = t.prev)\n            // \u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u72b6\u6001\u9700\u8981\u88ab\u5524\u9192\n            if (t.waitStatus <= 0)\n                // \u7f6e\u6362\u5f15\u7528\n                s = t;\n    }\n    // \u3010\u627e\u5230\u5408\u9002\u7684\u53ef\u4ee5\u88ab\u5524\u9192\u7684 node\uff0c\u5219\u5524\u9192\u7ebf\u7a0b\u3011\n    if (s != null)\n        LockSupport.unpark(s.thread);\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u4ece\u540e\u5411\u524d\u7684\u5524\u9192\u7684\u539f\u56e0"}),"\uff1aenq \u65b9\u6cd5\u4e2d\uff0c\u8282\u70b9\u662f\u5c3e\u63d2\u6cd5\uff0c\u9996\u5148\u8d4b\u503c\u7684\u662f\u5c3e\u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\uff0c\u6b64\u65f6\u524d\u9a71\u8282\u70b9\u7684 next \u5e76\u6ca1\u6709\u6307\u5411\u5c3e\u8282\u70b9\uff0c\u4ece\u524d\u904d\u5386\u4f1a\u4e22\u5931\u5c3e\u8282\u70b9"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5524\u9192\u7684\u7ebf\u7a0b\u4f1a\u4ece park \u4f4d\u7f6e\u5f00\u59cb\u6267\u884c\uff0c\u5982\u679c\u52a0\u9501\u6210\u529f\uff08\u6ca1\u6709\u7ade\u4e89\uff09\uff0c\u4f1a\u8bbe\u7f6e"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"exclusiveOwnerThread \u4e3a Thread-1\uff0cstate = 1"}),"\n",(0,r.jsx)(e.li,{children:"head \u6307\u5411\u521a\u521a Thread-1 \u6240\u5728\u7684 Node\uff0c\u8be5 Node \u4f1a\u6e05\u7a7a Thread"}),"\n",(0,r.jsx)(e.li,{children:"\u539f\u672c\u7684 head \u56e0\u4e3a\u4ece\u94fe\u8868\u65ad\u5f00\uff0c\u800c\u53ef\u88ab\u5783\u573e\u56de\u6536\uff08\u56fe\u4e2d\u6709\u9519\u8bef\uff0c\u539f\u6765\u7684\u5934\u8282\u70b9\u7684 waitStatus \u88ab\u6539\u4e3a 0 \u4e86\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(18492).A+"",width:"768",height:"203"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u8fd9\u65f6\u6709\u5176\u5b83\u7ebf\u7a0b\u6765\u7ade\u4e89**\uff08\u975e\u516c\u5e73\uff09**\uff0c\u4f8b\u5982\u8fd9\u65f6\u6709 Thread-4 \u6765\u4e86\u5e76\u62a2\u5360\u4e86\u9501"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Thread-4 \u88ab\u8bbe\u7f6e\u4e3a exclusiveOwnerThread\uff0cstate = 1"}),"\n",(0,r.jsx)(e.li,{children:"Thread-1 \u518d\u6b21\u8fdb\u5165 acquireQueued \u6d41\u7a0b\uff0c\u83b7\u53d6\u9501\u5931\u8d25\uff0c\u91cd\u65b0\u8fdb\u5165 park \u963b\u585e"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(47909).A+"",width:"1266",height:"352"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u516c\u5e73\u539f\u7406",children:"\u516c\u5e73\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0e\u975e\u516c\u5e73\u9501\u4e3b\u8981\u533a\u522b\u5728\u4e8e tryAcquire \u65b9\u6cd5\uff1a\u5148\u68c0\u67e5 AQS \u961f\u5217\u4e2d\u662f\u5426\u6709\u524d\u9a71\u8282\u70b9\uff0c\u6ca1\u6709\u624d\u53bb CAS \u7ade\u4e89"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final class FairSync extends Sync {\n    private static final long serialVersionUID = -3000897897090466540L;\n    final void lock() {\n        acquire(1);\n    }\n\n    protected final boolean tryAcquire(int acquires) {\n        final Thread current = Thread.currentThread();\n        int c = getState();\n        if (c == 0) {\n            // \u5148\u68c0\u67e5 AQS \u961f\u5217\u4e2d\u662f\u5426\u6709\u524d\u9a71\u8282\u70b9, \u6ca1\u6709(false)\u624d\u53bb\u7ade\u4e89\n            if (!hasQueuedPredecessors() &&\n                compareAndSetState(0, acquires)) {\n                setExclusiveOwnerThread(current);\n                return true;\n            }\n        }\n        // \u9501\u91cd\u5165\n        return false;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final boolean hasQueuedPredecessors() {    \n    Node t = tail;\n    Node h = head;\n    Node s;    \n    // \u5934\u5c3e\u6307\u5411\u4e00\u4e2a\u8282\u70b9\uff0c\u94fe\u8868\u4e3a\u7a7a\uff0c\u8fd4\u56defalse\n    return h != t &&\n        // \u5934\u5c3e\u4e4b\u95f4\u6709\u8282\u70b9\uff0c\u5224\u65ad\u5934\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u662f\u4e0d\u662f\u7a7a\n        // \u4e0d\u662f\u7a7a\u8fdb\u5165\u6700\u540e\u7684\u5224\u65ad\uff0c\u7b2c\u4e8c\u4e2a\u8282\u70b9\u7684\u7ebf\u7a0b\u662f\u5426\u662f\u672c\u7ebf\u7a0b\uff0c\u4e0d\u662f\u8fd4\u56de true\uff0c\u8868\u793a\u5f53\u524d\u8282\u70b9\u6709\u524d\u9a71\u8282\u70b9\n        ((s = h.next) == null || s.thread != Thread.currentThread());\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u53ef\u91cd\u5165",children:"\u53ef\u91cd\u5165"}),"\n",(0,r.jsx)(e.p,{children:"\u53ef\u91cd\u5165\u662f\u6307\u540c\u4e00\u4e2a\u7ebf\u7a0b\u5982\u679c\u9996\u6b21\u83b7\u5f97\u4e86\u8fd9\u628a\u9501\uff0c\u90a3\u4e48\u5b83\u662f\u8fd9\u628a\u9501\u7684\u62e5\u6709\u8005\uff0c\u56e0\u6b64\u6709\u6743\u5229\u518d\u6b21\u83b7\u53d6\u8fd9\u628a\u9501\uff0c\u5982\u679c\u4e0d\u53ef\u91cd\u5165\u9501\uff0c\u90a3\u4e48\u7b2c\u4e8c\u6b21\u83b7\u5f97\u9501\u65f6\uff0c\u81ea\u5df1\u4e5f\u4f1a\u88ab\u9501\u6321\u4f4f\uff0c\u76f4\u63a5\u9020\u6210\u6b7b\u9501"}),"\n",(0,r.jsxs)(e.p,{children:["\u6e90\u7801\u89e3\u6790\u53c2\u8003\uff1a",(0,r.jsx)(e.code,{children:"nonfairTryAcquire(int acquires)) "})," \u548c ",(0,r.jsx)(e.code,{children:"tryRelease(int releases)"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'static ReentrantLock lock = new ReentrantLock();\npublic static void main(String[] args) {\n    method1();\n}\npublic static void method1() {\n    lock.lock();\n    try {\n        System.out.println(Thread.currentThread().getName() + " execute method1");\n        method2();\n    } finally {\n        lock.unlock();\n    }\n}\npublic static void method2() {\n    lock.lock();\n    try {\n        System.out.println(Thread.currentThread().getName() + " execute method2");\n    } finally {\n        lock.unlock();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u5728 Lock \u65b9\u6cd5\u52a0\u4e24\u628a\u9501\u4f1a\u662f\u4ec0\u4e48\u60c5\u51b5\u5462\uff1f"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u52a0\u9501\u4e24\u6b21\u89e3\u9501\u4e24\u6b21\uff1a\u6b63\u5e38\u6267\u884c"}),"\n",(0,r.jsxs)(e.li,{children:["\u52a0\u9501\u4e24\u6b21\u89e3\u9501\u4e00\u6b21\uff1a\u7a0b\u5e8f\u76f4\u63a5\u5361\u6b7b\uff0c\u7ebf\u7a0b\u4e0d\u80fd\u51fa\u6765\uff0c\u4e5f\u5c31\u8bf4\u660e",(0,r.jsx)(e.strong,{children:"\u7533\u8bf7\u51e0\u628a\u9501\uff0c\u6700\u540e\u9700\u8981\u89e3\u9664\u51e0\u628a\u9501"})]}),"\n",(0,r.jsx)(e.li,{children:"\u52a0\u9501\u4e00\u6b21\u89e3\u9501\u4e24\u6b21\uff1a\u8fd0\u884c\u7a0b\u5e8f\u4f1a\u76f4\u63a5\u62a5\u9519"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public void getLock() {\n    lock.lock();\n    lock.lock();\n    try {\n        System.out.println(Thread.currentThread().getName() + "\\t get Lock");\n    } finally {\n        lock.unlock();\n        //lock.unlock();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u53ef\u6253\u65ad",children:"\u53ef\u6253\u65ad"}),"\n",(0,r.jsx)(e.h5,{id:"\u57fa\u672c\u4f7f\u7528-4",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public void lockInterruptibly()"}),"\uff1a\u83b7\u5f97\u53ef\u6253\u65ad\u7684\u9501"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u6ca1\u6709\u7ade\u4e89\u6b64\u65b9\u6cd5\u5c31\u4f1a\u83b7\u53d6 lock \u5bf9\u8c61\u9501"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u6709\u7ade\u4e89\u5c31\u8fdb\u5165\u963b\u585e\u961f\u5217\uff0c\u53ef\u4ee5\u88ab\u5176\u4ed6\u7ebf\u7a0b\u7528 interrupt \u6253\u65ad"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1a\u5982\u679c\u662f\u4e0d\u53ef\u4e2d\u65ad\u6a21\u5f0f\uff0c\u90a3\u4e48\u5373\u4f7f\u4f7f\u7528\u4e86 interrupt \u4e5f\u4e0d\u4f1a\u8ba9\u7b49\u5f85\u72b6\u6001\u4e2d\u7684\u7ebf\u7a0b\u4e2d\u65ad"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws InterruptedException {    \n    ReentrantLock lock = new ReentrantLock();    \n    Thread t1 = new Thread(() -> {        \n        try {            \n            System.out.println("\u5c1d\u8bd5\u83b7\u53d6\u9501");            \n            lock.lockInterruptibly();        \n        } catch (InterruptedException e) {            \n            System.out.println("\u6ca1\u6709\u83b7\u53d6\u5230\u9501\uff0c\u88ab\u6253\u65ad\uff0c\u76f4\u63a5\u8fd4\u56de");            \n            return;        \n        }        \n        try {            \n            System.out.println("\u83b7\u53d6\u5230\u9501");        \n        } finally {            \n            lock.unlock();        \n        }    \n    }, "t1");    \n    lock.lock();    \n    t1.start();    \n    Thread.sleep(2000);    \n    System.out.println("\u4e3b\u7ebf\u7a0b\u8fdb\u884c\u6253\u65ad\u9501");    \n    t1.interrupt();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5b9e\u73b0\u539f\u7406-2",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4e0d\u53ef\u6253\u65ad\u6a21\u5f0f\uff1a\u5373\u4f7f\u5b83\u88ab\u6253\u65ad\uff0c\u4ecd\u4f1a\u9a7b\u7559\u5728 AQS \u963b\u585e\u961f\u5217\u4e2d\uff0c\u4e00\u76f4\u8981",(0,r.jsx)(e.strong,{children:"\u7b49\u5230\u83b7\u5f97\u9501\u540e\u624d\u80fd\u5f97\u77e5\u81ea\u5df1\u88ab\u6253\u65ad"}),"\u4e86"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final void acquire(int arg) {    \n    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))//\u963b\u585e\u7b49\u5f85        \n        // \u5982\u679cacquireQueued\u8fd4\u56detrue\uff0c\u6253\u65ad\u72b6\u6001 interrupted = true        \n        selfInterrupt();\n}\nstatic void selfInterrupt() {\n    // \u77e5\u9053\u81ea\u5df1\u88ab\u6253\u65ad\u4e86\uff0c\u9700\u8981\u91cd\u65b0\u4ea7\u751f\u4e00\u6b21\u4e2d\u65ad\u5b8c\u6210\u4e2d\u65ad\u6548\u679c\n    Thread.currentThread().interrupt();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final boolean acquireQueued(final Node node, int arg) {    \n    try {        \n        boolean interrupted = false;        \n        for (;;) {            \n            final Node p = node.predecessor();            \n            if (p == head && tryAcquire(arg)) {                \n                setHead(node);                \n                p.next = null; // help GC                \n                failed = false;                \n                // \u8fd8\u662f\u9700\u8981\u83b7\u5f97\u9501\u540e, \u624d\u80fd\u8fd4\u56de\u6253\u65ad\u72b6\u6001\n                return interrupted;            \n            }            \n            if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt()){\n                // \u6761\u4ef6\u4e8c\u4e2d\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u88ab\u6253\u65ad\u8fd4\u56detrue\uff0c\u8bbe\u7f6e\u4e2d\u65ad\u6807\u8bb0\u4e3a true\uff0c\u3010\u83b7\u53d6\u9501\u540e\u8fd4\u56de\u3011\n                interrupted = true;  \n            }                  \n        } \n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n private final boolean parkAndCheckInterrupt() {    \n     // \u963b\u585e\u5f53\u524d\u7ebf\u7a0b\uff0c\u5982\u679c\u6253\u65ad\u6807\u8bb0\u5df2\u7ecf\u662f true, \u5219 park \u4f1a\u5931\u6548\n     LockSupport.park(this);    \n     // \u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u6e05\u9664\u6253\u65ad\u6807\u8bb0\uff0c\u88ab\u6253\u65ad\u8fd4\u56detrue\n     return Thread.interrupted();\n }\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u53ef\u6253\u65ad\u6a21\u5f0f\uff1aAbstractQueuedSynchronizer#acquireInterruptibly\uff0c",(0,r.jsx)(e.strong,{children:"\u88ab\u6253\u65ad\u540e\u4f1a\u76f4\u63a5\u629b\u51fa\u5f02\u5e38"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void lockInterruptibly() throws InterruptedException {    \n    sync.acquireInterruptibly(1);\n}\npublic final void acquireInterruptibly(int arg) {\n    // \u88ab\u5176\u4ed6\u7ebf\u7a0b\u6253\u65ad\u4e86\u76f4\u63a5\u8fd4\u56de false\n    if (Thread.interrupted())\n\t\tthrow new InterruptedException();\n    if (!tryAcquire(arg))\n        // \u6ca1\u83b7\u53d6\u5230\u9501\uff0c\u8fdb\u5165\u8fd9\u91cc\n        doAcquireInterruptibly(arg);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void doAcquireInterruptibly(int arg) throws InterruptedException {\n    // \u8fd4\u56de\u5c01\u88c5\u5f53\u524d\u7ebf\u7a0b\u7684\u8282\u70b9\n    final Node node = addWaiter(Node.EXCLUSIVE);\n    boolean failed = true;\n    try {\n        for (;;) {\n            //...\n            if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\n                // \u3010\u5728 park \u8fc7\u7a0b\u4e2d\u5982\u679c\u88ab interrupt \u4f1a\u629b\u51fa\u5f02\u5e38\u3011, \u800c\u4e0d\u4f1a\u518d\u6b21\u8fdb\u5165\u5faa\u73af\u83b7\u53d6\u9501\u540e\u624d\u5b8c\u6210\u6253\u65ad\u6548\u679c\n                throw new InterruptedException();\n        }    \n    } finally {\n        // \u629b\u51fa\u5f02\u5e38\u524d\u4f1a\u8fdb\u5165\u8fd9\u91cc\n        if (failed)\n            // \u53d6\u6d88\u5f53\u524d\u7ebf\u7a0b\u7684\u8282\u70b9\n            cancelAcquire(node);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u53d6\u6d88\u8282\u70b9\u51fa\u961f\u7684\u903b\u8f91\nprivate void cancelAcquire(Node node) {\n    // \u5224\u7a7a\n    if (node == null)\n        return;\n\t// \u628a\u5f53\u524d\u8282\u70b9\u5c01\u88c5\u7684 Thread \u7f6e\u4e3a\u7a7a\n    node.thread = null;\n\t// \u83b7\u53d6\u5f53\u524d\u53d6\u6d88\u7684 node \u7684\u524d\u9a71\u8282\u70b9\n    Node pred = node.prev;\n    // \u524d\u9a71\u8282\u70b9\u4e5f\u88ab\u53d6\u6d88\u4e86\uff0c\u5faa\u73af\u627e\u5230\u524d\u9762\u6700\u8fd1\u7684\u6ca1\u88ab\u53d6\u6d88\u7684\u8282\u70b9\n    while (pred.waitStatus > 0)\n        node.prev = pred = pred.prev;\n    \n\t// \u83b7\u53d6\u524d\u9a71\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\uff0c\u53ef\u80fd\u662f\u5f53\u524d node\uff0c\u4e5f\u53ef\u80fd\u662f waitStatus > 0 \u7684\u8282\u70b9\n    Node predNext = pred.next;\n    \n\t// \u628a\u5f53\u524d\u8282\u70b9\u7684\u72b6\u6001\u8bbe\u7f6e\u4e3a \u3010\u53d6\u6d88\u72b6\u6001 1\u3011\n    node.waitStatus = Node.CANCELLED;\n    \n\t// \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u8282\u70b9\u662f\u5c3e\u8282\u70b9\uff0c\u628a\u5f53\u524d\u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\u8bbe\u7f6e\u4e3a\u5c3e\u8282\u70b9\n    if (node == tail && compareAndSetTail(node, pred)) {\n        // \u628a\u524d\u9a71\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\u7f6e\u7a7a\uff0c\u8fd9\u91cc\u76f4\u63a5\u628a\u6240\u6709\u7684\u53d6\u6d88\u8282\u70b9\u51fa\u961f\n        compareAndSetNext(pred, predNext, null);\n    } else {\n        // \u8bf4\u660e\u5f53\u524d\u8282\u70b9\u4e0d\u662f tail \u8282\u70b9\n        int ws;\n        // \u6761\u4ef6\u4e00\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u8282\u70b9\u4e0d\u662f head.next \u8282\u70b9\n        if (pred != head &&\n            // \u5224\u65ad\u524d\u9a71\u8282\u70b9\u7684\u72b6\u6001\u662f\u4e0d\u662f -1\uff0c\u4e0d\u6210\u7acb\u8bf4\u660e\u524d\u9a71\u72b6\u6001\u53ef\u80fd\u662f 0 \u6216\u8005\u521a\u88ab\u5176\u4ed6\u7ebf\u7a0b\u53d6\u6d88\u6392\u961f\u4e86\n            ((ws = pred.waitStatus) == Node.SIGNAL ||\n             // \u5982\u679c\u72b6\u6001\u4e0d\u662f -1\uff0c\u8bbe\u7f6e\u524d\u9a71\u8282\u70b9\u7684\u72b6\u6001\u4e3a -1\n             (ws <= 0 && compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &&\n            // \u524d\u9a71\u8282\u70b9\u7684\u7ebf\u7a0b\u4e0d\u4e3anull\n            pred.thread != null) {\n            \n            Node next = node.next;\n            // \u5f53\u524d\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\u662f\u6b63\u5e38\u8282\u70b9\n            if (next != null && next.waitStatus <= 0)\n                // \u628a \u524d\u9a71\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9 \u8bbe\u7f6e\u4e3a \u5f53\u524d\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\uff0c\u3010\u4ece\u961f\u5217\u4e2d\u5220\u9664\u4e86\u5f53\u524d\u8282\u70b9\u3011\n                compareAndSetNext(pred, predNext, next);\n        } else {\n            // \u5f53\u524d\u8282\u70b9\u662f head.next \u8282\u70b9\uff0c\u5524\u9192\u5f53\u524d\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\n            unparkSuccessor(node);\n        }\n        node.next = node; // help GC\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u9501\u8d85\u65f6",children:"\u9501\u8d85\u65f6"}),"\n",(0,r.jsx)(e.h5,{id:"\u57fa\u672c\u4f7f\u7528-5",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public boolean tryLock()"}),"\uff1a\u5c1d\u8bd5\u83b7\u53d6\u9501\uff0c\u83b7\u53d6\u5230\u8fd4\u56de true\uff0c\u83b7\u53d6\u4e0d\u5230\u76f4\u63a5\u653e\u5f03\uff0c\u4e0d\u8fdb\u5165\u963b\u585e\u961f\u5217"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public boolean tryLock(long timeout, TimeUnit unit)"}),"\uff1a\u5728\u7ed9\u5b9a\u65f6\u95f4\u5185\u83b7\u53d6\u9501\uff0c\u83b7\u53d6\u4e0d\u5230\u5c31\u9000\u51fa"]}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1atryLock \u671f\u95f4\u4e5f\u53ef\u4ee5\u88ab\u6253\u65ad"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ReentrantLock lock = new ReentrantLock();\n    Thread t1 = new Thread(() -> {\n        try {\n            if (!lock.tryLock(2, TimeUnit.SECONDS)) {\n                System.out.println("\u83b7\u53d6\u4e0d\u5230\u9501");\n                return;\n            }\n        } catch (InterruptedException e) {\n            System.out.println("\u88ab\u6253\u65ad\uff0c\u83b7\u53d6\u4e0d\u5230\u9501");\n            return;\n        }\n        try {\n            log.debug("\u83b7\u53d6\u5230\u9501");\n        } finally {\n            lock.unlock();\n        }\n    }, "t1");\n    lock.lock();\n    System.out.println("\u4e3b\u7ebf\u7a0b\u83b7\u53d6\u5230\u9501");\n    t1.start();\n    \n    Thread.sleep(1000);\n    try {\n        System.out.println("\u4e3b\u7ebf\u7a0b\u91ca\u653e\u4e86\u9501");\n    } finally {\n        lock.unlock();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5b9e\u73b0\u539f\u7406-3",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u53d8\u91cf\uff1a\u6307\u5b9a\u8d85\u65f6\u9650\u5236\u7684\u9608\u503c\uff0c\u5c0f\u4e8e\u8be5\u503c\u7684\u7ebf\u7a0b\u4e0d\u4f1a\u88ab\u6302\u8d77"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final long spinForTimeoutThreshold = 1000L;\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u7684\u5c0f\u4e8e\u8be5\u503c\uff0c\u5c31\u4f1a\u88ab\u7981\u6b62\u6302\u8d77\uff0c\u56e0\u4e3a\u963b\u585e\u5728\u5524\u9192\u7684\u6210\u672c\u592a\u9ad8\uff0c\u4e0d\u5982\u9009\u62e9\u81ea\u65cb\u7a7a\u8f6c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"tryLock()"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean tryLock() {   \n    // \u53ea\u5c1d\u8bd5\u4e00\u6b21\n    return sync.nonfairTryAcquire(1);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"tryLock(long timeout, TimeUnit unit)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final boolean tryAcquireNanos(int arg, long nanosTimeout) {\n    if (Thread.interrupted())        \n        throw new InterruptedException();    \n    // tryAcquire \u5c1d\u8bd5\u4e00\u6b21\n    return tryAcquire(arg) || doAcquireNanos(arg, nanosTimeout);\n}\nprotected final boolean tryAcquire(int acquires) {    \n    return nonfairTryAcquire(acquires);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private boolean doAcquireNanos(int arg, long nanosTimeout) {    \n    if (nanosTimeout <= 0L)\n        return false;\n    // \u83b7\u53d6\u6700\u540e\u671f\u9650\u7684\u65f6\u95f4\u6233\n    final long deadline = System.nanoTime() + nanosTimeout;\n    //...\n    try {\n        for (;;) {\n            //...\n            // \u8ba1\u7b97\u8fd8\u9700\u7b49\u5f85\u7684\u65f6\u95f4\n            nanosTimeout = deadline - System.nanoTime();\n            if (nanosTimeout <= 0L)\t//\u65f6\u95f4\u5df2\u5230     \n                return false;\n            if (shouldParkAfterFailedAcquire(p, node) &&\n                // \u5982\u679c nanosTimeout \u5927\u4e8e\u8be5\u503c\uff0c\u624d\u6709\u963b\u585e\u7684\u610f\u4e49\uff0c\u5426\u5219\u76f4\u63a5\u81ea\u65cb\u4f1a\u597d\u70b9\n                nanosTimeout > spinForTimeoutThreshold)\n                LockSupport.parkNanos(this, nanosTimeout);\n            // \u3010\u88ab\u6253\u65ad\u4f1a\u62a5\u5f02\u5e38\u3011\n            if (Thread.interrupted())\n                throw new InterruptedException();\n        }    \n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u54f2\u5b66\u5bb6\u5c31\u9910",children:"\u54f2\u5b66\u5bb6\u5c31\u9910"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    Chopstick c1 = new Chopstick("1");//...\n    Chopstick c5 = new Chopstick("5");\n    new Philosopher("\u82cf\u683c\u62c9\u5e95", c1, c2).start();\n    new Philosopher("\u67cf\u62c9\u56fe", c2, c3).start();\n    new Philosopher("\u4e9a\u91cc\u58eb\u591a\u5fb7", c3, c4).start();\n    new Philosopher("\u8d6b\u62c9\u514b\u5229\u7279", c4, c5).start();    \n    new Philosopher("\u963f\u57fa\u7c73\u5fb7", c5, c1).start();\n}\nclass Philosopher extends Thread {\n    Chopstick left;\n    Chopstick right;\n    public void run() {\n        while (true) {\n            // \u5c1d\u8bd5\u83b7\u5f97\u5de6\u624b\u7b77\u5b50\n            if (left.tryLock()) {\n                try {\n                    // \u5c1d\u8bd5\u83b7\u5f97\u53f3\u624b\u7b77\u5b50\n                    if (right.tryLock()) {\n                        try {\n                            System.out.println("eating...");\n                            Thread.sleep(1000);\n                        } finally {\n                            right.unlock();\n                        }\n                    }\n                } finally {\n                    left.unlock();\n                }\n            }\n        }\n    }\n}\nclass Chopstick extends ReentrantLock {\n    String name;\n    public Chopstick(String name) {\n        this.name = name;\n    }\n    @Override\n    public String toString() {\n        return "\u7b77\u5b50{" + name + \'}\';\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6761\u4ef6\u53d8\u91cf",children:"\u6761\u4ef6\u53d8\u91cf"}),"\n",(0,r.jsx)(e.h5,{id:"\u57fa\u672c\u4f7f\u7528-6",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsx)(e.p,{children:"synchronized \u7684\u6761\u4ef6\u53d8\u91cf\uff0c\u662f\u5f53\u6761\u4ef6\u4e0d\u6ee1\u8db3\u65f6\u8fdb\u5165 WaitSet \u7b49\u5f85\uff1bReentrantLock \u7684\u6761\u4ef6\u53d8\u91cf\u6bd4 synchronized \u5f3a\u5927\u4e4b\u5904\u5728\u4e8e\u652f\u6301\u591a\u4e2a\u6761\u4ef6\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.p,{children:["ReentrantLock \u7c7b\u83b7\u53d6 Condition \u5bf9\u8c61\uff1a",(0,r.jsx)(e.code,{children:"public Condition newCondition()"})]}),"\n",(0,r.jsx)(e.p,{children:"Condition \u7c7b API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"void await()"}),"\uff1a\u5f53\u524d\u7ebf\u7a0b\u4ece\u8fd0\u884c\u72b6\u6001\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\uff0c\u91ca\u653e\u9501"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"void signal()"}),"\uff1a\u5524\u9192\u4e00\u4e2a\u7b49\u5f85\u5728 Condition \u4e0a\u7684\u7ebf\u7a0b\uff0c\u4f46\u662f\u5fc5\u987b\u83b7\u5f97\u4e0e\u8be5 Condition \u76f8\u5173\u7684\u9501"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4f7f\u7528\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"await / signal \u524d\u9700\u8981\u83b7\u5f97\u9501"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"await \u6267\u884c\u540e\uff0c\u4f1a\u91ca\u653e\u9501\u8fdb\u5165 ConditionObject \u7b49\u5f85"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"await \u7684\u7ebf\u7a0b\u88ab\u5524\u9192\u53bb\u91cd\u65b0\u7ade\u4e89 lock \u9501"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u7ebf\u7a0b\u5728\u6761\u4ef6\u961f\u5217\u88ab\u6253\u65ad\u4f1a\u629b\u51fa\u4e2d\u65ad\u5f02\u5e38"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ade\u4e89 lock \u9501\u6210\u529f\u540e\uff0c\u4ece await \u540e\u7ee7\u7eed\u6267\u884c"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws InterruptedException {    \n    ReentrantLock lock = new ReentrantLock();\n    //\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6761\u4ef6\u53d8\u91cf\n    Condition condition1 = lock.newCondition();\n    Condition condition2 = lock.newCondition();\n    new Thread(() -> {\n        try {\n            lock.lock();\n            System.out.println("\u8fdb\u5165\u7b49\u5f85");\n            //\u8fdb\u5165\u4f11\u606f\u5ba4\u7b49\u5f85\n            condition1.await();\n            System.out.println("\u88ab\u5524\u9192\u4e86");\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } finally {\n            lock.unlock();\n        }    \n    }).start();\n    Thread.sleep(1000);\n    //\u53eb\u9192\n    new Thread(() -> {\n        try {            \n            lock.lock();\n            //\u5524\u9192\n            condition2.signal();\n        } finally {\n            lock.unlock();\n        }\n    }).start();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5b9e\u73b0\u539f\u7406-4",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.h6,{id:"await",children:"await"}),"\n",(0,r.jsxs)(e.p,{children:["\u603b\u4f53\u6d41\u7a0b\u662f\u5c06 await \u7ebf\u7a0b\u5305\u88c5\u6210 node \u8282\u70b9\u653e\u5165 ConditionObject \u7684\u6761\u4ef6\u961f\u5217\uff0c\u5982\u679c\u88ab\u5524\u9192\u5c31\u5c06 node \u8f6c\u79fb\u5230 AQS \u7684\u6267\u884c\u963b\u585e\u961f\u5217\uff0c\u7b49\u5f85\u83b7\u53d6\u9501\uff0c",(0,r.jsx)(e.strong,{children:"\u6bcf\u4e2a Condition \u5bf9\u8c61\u90fd\u5305\u542b\u4e00\u4e2a\u7b49\u5f85\u961f\u5217"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5f00\u59cb Thread-0 \u6301\u6709\u9501\uff0c\u8c03\u7528 await\uff0c\u7ebf\u7a0b\u8fdb\u5165 ConditionObject \u7b49\u5f85\uff0c\u76f4\u5230\u88ab\u5524\u9192\u6216\u6253\u65ad\uff0c\u8c03\u7528 await \u65b9\u6cd5\u7684\u7ebf\u7a0b\u90fd\u662f\u6301\u9501\u72b6\u6001\u7684\uff0c\u6240\u4ee5\u8bf4\u903b\u8f91\u91cc",(0,r.jsx)(e.strong,{children:"\u4e0d\u5b58\u5728\u5e76\u53d1"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final void await() throws InterruptedException {\n     // \u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u662f\u4e2d\u65ad\u72b6\u6001\uff0c\u662f\u5c31\u76f4\u63a5\u7ed9\u4e2a\u4e2d\u65ad\u5f02\u5e38\n    if (Thread.interrupted())\n        throw new InterruptedException();\n    // \u5c06\u8c03\u7528 await \u7684\u7ebf\u7a0b\u5305\u88c5\u6210 Node\uff0c\u6dfb\u52a0\u5230\u6761\u4ef6\u961f\u5217\u5e76\u8fd4\u56de\n    Node node = addConditionWaiter();\n    // \u5b8c\u5168\u91ca\u653e\u8282\u70b9\u6301\u6709\u7684\u9501\uff0c\u56e0\u4e3a\u5176\u4ed6\u7ebf\u7a0b\u5524\u9192\u5f53\u524d\u7ebf\u7a0b\u7684\u524d\u63d0\u662f\u3010\u6301\u6709\u9501\u3011\n    int savedState = fullyRelease(node);\n    \n    // \u8bbe\u7f6e\u6253\u65ad\u6a21\u5f0f\u4e3a\u6ca1\u6709\u88ab\u6253\u65ad\uff0c\u72b6\u6001\u7801\u4e3a 0\n    int interruptMode = 0;\n    \n    // \u5982\u679c\u8be5\u8282\u70b9\u8fd8\u6ca1\u6709\u8f6c\u79fb\u81f3 AQS \u963b\u585e\u961f\u5217, park \u963b\u585e\uff0c\u7b49\u5f85\u8fdb\u5165\u963b\u585e\u961f\u5217\n    while (!isOnSyncQueue(node)) {\n        LockSupport.park(this);\n        // \u5982\u679c\u88ab\u6253\u65ad\uff0c\u9000\u51fa\u7b49\u5f85\u961f\u5217\uff0c\u5bf9\u5e94\u7684 node \u3010\u4e5f\u4f1a\u88ab\u8fc1\u79fb\u5230\u963b\u585e\u961f\u5217\u3011\u5c3e\u90e8\uff0c\u72b6\u6001\u8bbe\u7f6e\u4e3a 0\n        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)\n            break;\n    }\n    // \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u9000\u51fa\u7b49\u5f85\u961f\u5217\uff0c\u8fdb\u5165\u3010\u963b\u585e\u961f\u5217\u3011\n    \n    // \u5c1d\u8bd5\u67aa\u9501\uff0c\u91ca\u653e\u4e86\u591a\u5c11\u9501\u5c31\u3010\u91cd\u65b0\u83b7\u53d6\u591a\u5c11\u9501\u3011\uff0c\u83b7\u53d6\u9501\u6210\u529f\u5224\u65ad\u6253\u65ad\u6a21\u5f0f\n    if (acquireQueued(node, savedState) && interruptMode != THROW_IE)\n        interruptMode = REINTERRUPT;\n    \n    // node \u5728\u6761\u4ef6\u961f\u5217\u65f6 \u5982\u679c\u88ab\u5916\u90e8\u7ebf\u7a0b\u4e2d\u65ad\u5524\u9192\uff0c\u4f1a\u52a0\u5165\u5230\u963b\u585e\u961f\u5217\uff0c\u4f46\u662f\u5e76\u672a\u8bbe nextWaiter = null\n    if (node.nextWaiter != null)\n        // \u6e05\u7406\u6761\u4ef6\u961f\u5217\u5185\u6240\u6709\u5df2\u53d6\u6d88\u7684 Node\n        unlinkCancelledWaiters();\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u6302\u8d77\u671f\u95f4\u53d1\u751f\u8fc7\u4e2d\u65ad\n    if (interruptMode != 0)\n        // \u5e94\u7528\u6253\u65ad\u6a21\u5f0f\n        reportInterruptAfterWait(interruptMode);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u6253\u65ad\u6a21\u5f0f - \u5728\u9000\u51fa\u7b49\u5f85\u65f6\u91cd\u65b0\u8bbe\u7f6e\u6253\u65ad\u72b6\u6001\nprivate static final int REINTERRUPT = 1;\n// \u6253\u65ad\u6a21\u5f0f - \u5728\u9000\u51fa\u7b49\u5f85\u65f6\u629b\u51fa\u5f02\u5e38\nprivate static final int THROW_IE = -1;\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(71009).A+"",width:"949",height:"363"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u521b\u5efa\u65b0\u7684 Node \u72b6\u6001\u4e3a -2\uff08Node.CONDITION\uff09"}),"\uff0c\u5173\u8054 Thread-0\uff0c\u52a0\u5165\u7b49\u5f85\u961f\u5217\u5c3e\u90e8"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private Node addConditionWaiter() {\n    // \u83b7\u53d6\u5f53\u524d\u6761\u4ef6\u961f\u5217\u7684\u5c3e\u8282\u70b9\u7684\u5f15\u7528\uff0c\u4fdd\u5b58\u5230\u5c40\u90e8\u53d8\u91cf t \u4e2d\n    Node t = lastWaiter;\n    // \u5f53\u524d\u961f\u5217\u4e2d\u4e0d\u662f\u7a7a\uff0c\u5e76\u4e14\u8282\u70b9\u7684\u72b6\u6001\u4e0d\u662f CONDITION\uff08-2\uff09\uff0c\u8bf4\u660e\u5f53\u524d\u8282\u70b9\u53d1\u751f\u4e86\u4e2d\u65ad\n    if (t != null && t.waitStatus != Node.CONDITION) {\n        // \u6e05\u7406\u6761\u4ef6\u961f\u5217\u5185\u6240\u6709\u5df2\u53d6\u6d88\u7684 Node\n        unlinkCancelledWaiters();\n        // \u6e05\u7406\u5b8c\u6210\u91cd\u65b0\u83b7\u53d6 \u5c3e\u8282\u70b9 \u7684\u5f15\u7528\n        t = lastWaiter;\n    }\n    // \u521b\u5efa\u4e00\u4e2a\u5173\u8054\u5f53\u524d\u7ebf\u7a0b\u7684\u65b0 node, \u8bbe\u7f6e\u72b6\u6001\u4e3a CONDITION(-2)\uff0c\u6dfb\u52a0\u81f3\u961f\u5217\u5c3e\u90e8\n    Node node = new Node(Thread.currentThread(), Node.CONDITION);\n    if (t == null)\n        firstWaiter = node;\t\t// \u7a7a\u961f\u5217\u76f4\u63a5\u653e\u5728\u961f\u9996\u3010\u4e0d\u7528CAS\u56e0\u4e3a\u6267\u884c\u7ebf\u7a0b\u662f\u6301\u9501\u7ebf\u7a0b\uff0c\u5e76\u53d1\u5b89\u5168\u3011\n    else\n        t.nextWaiter = node;\t// \u975e\u7a7a\u961f\u5217\u961f\u5c3e\u8ffd\u52a0\n    lastWaiter = node;\t\t\t// \u66f4\u65b0\u961f\u5c3e\u7684\u5f15\u7528\n    return node;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u6e05\u7406\u6761\u4ef6\u961f\u5217\u5185\u6240\u6709\u5df2\u53d6\u6d88\uff08\u4e0d\u662fCONDITION\uff09\u7684 node\uff0c\u3010\u94fe\u8868\u5220\u9664\u7684\u903b\u8f91\u3011\nprivate void unlinkCancelledWaiters() {\n    // \u4ece\u5934\u8282\u70b9\u5f00\u59cb\u904d\u5386\u3010FIFO\u3011\n    Node t = firstWaiter;\n    // \u6307\u5411\u6b63\u5e38\u7684 CONDITION \u8282\u70b9\n    Node trail = null;\n    // \u7b49\u5f85\u961f\u5217\u4e0d\u7a7a\n    while (t != null) {\n        // \u83b7\u53d6\u5f53\u524d\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\n        Node next = t.nextWaiter;\n        // \u5224\u65ad t \u8282\u70b9\u662f\u4e0d\u662f CONDITION \u8282\u70b9\uff0c\u6761\u4ef6\u961f\u5217\u5185\u4e0d\u662f CONDITION \u5c31\u4e0d\u662f\u6b63\u5e38\u7684\n        if (t.waitStatus != Node.CONDITION) { \n            // \u4e0d\u662f\u6b63\u5e38\u8282\u70b9\uff0c\u9700\u8981 t \u4e0e\u4e0b\u4e00\u4e2a\u8282\u70b9\u65ad\u5f00\n            t.nextWaiter = null;\n            // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u904d\u5386\u5230\u7684\u8282\u70b9\u8fd8\u672a\u78b0\u5230\u8fc7\u6b63\u5e38\u8282\u70b9\n            if (trail == null)\n                // \u66f4\u65b0 firstWaiter \u6307\u9488\u4e3a\u4e0b\u4e2a\u8282\u70b9\n                firstWaiter = next;\n            else\n                // \u8ba9\u4e0a\u4e00\u4e2a\u6b63\u5e38\u8282\u70b9\u6307\u5411 \u5f53\u524d\u53d6\u6d88\u8282\u70b9\u7684 \u4e0b\u4e00\u4e2a\u8282\u70b9\uff0c\u3010\u5220\u9664\u975e\u6b63\u5e38\u7684\u8282\u70b9\u3011\n                trail.nextWaiter = next;\n            // t \u662f\u5c3e\u8282\u70b9\u4e86\uff0c\u66f4\u65b0 lastWaiter \u6307\u5411\u6700\u540e\u4e00\u4e2a\u6b63\u5e38\u8282\u70b9\n            if (next == null)\n                lastWaiter = trail;\n        } else {\n            // trail \u6307\u5411\u7684\u662f\u6b63\u5e38\u8282\u70b9 \n            trail = t;\n        }\n        // \u628a t.next \u8d4b\u503c\u7ed9 t\uff0c\u5faa\u73af\u904d\u5386\n        t = next; \n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u63a5\u4e0b\u6765 Thread-0 \u8fdb\u5165 AQS \u7684 fullyRelease \u6d41\u7a0b\uff0c\u91ca\u653e\u540c\u6b65\u5668\u4e0a\u7684\u9501"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u7ebf\u7a0b\u53ef\u80fd\u91cd\u5165\uff0c\u9700\u8981\u5c06 state \u5168\u90e8\u91ca\u653e\nfinal int fullyRelease(Node node) {\n    // \u5b8c\u5168\u91ca\u653e\u9501\u662f\u5426\u6210\u529f\uff0cfalse \u4ee3\u8868\u6210\u529f\n    boolean failed = true;\n    try {\n        // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u6240\u6301\u6709\u7684 state \u503c\u603b\u6570\n        int savedState = getState();\n        // release -> tryRelease \u89e3\u9501\u91cd\u5165\u9501\n        if (release(savedState)) {\n            // \u91ca\u653e\u6210\u529f\n            failed = false;\n            // \u8fd4\u56de\u89e3\u9501\u7684\u6df1\u5ea6\n            return savedState;\n        } else {\n            // \u89e3\u9501\u5931\u8d25\u629b\u51fa\u5f02\u5e38\n            throw new IllegalMonitorStateException();\n        }\n    } finally {\n        // \u6ca1\u6709\u91ca\u653e\u6210\u529f\uff0c\u5c06\u5f53\u524d node \u8bbe\u7f6e\u4e3a\u53d6\u6d88\u72b6\u6001\n        if (failed)\n            node.waitStatus = Node.CANCELLED;\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"fullyRelease \u4e2d\u4f1a unpark AQS \u961f\u5217\u4e2d\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\u7ade\u4e89\u9501\uff0c\u5047\u8bbe Thread-1 \u7ade\u4e89\u6210\u529f"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(29930).A+"",width:"1003",height:"349"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Thread-0 \u8fdb\u5165 isOnSyncQueue \u903b\u8f91\u5224\u65ad\u8282\u70b9",(0,r.jsx)(e.strong,{children:"\u662f\u5426\u79fb\u52a8\u5230\u963b\u585e\u961f\u5217"}),"\uff0c\u6ca1\u6709\u5c31 park \u963b\u585e Thread-0"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final boolean isOnSyncQueue(Node node) {\n    // node \u7684\u72b6\u6001\u662f CONDITION\uff0csignal \u65b9\u6cd5\u662f\u5148\u4fee\u6539\u72b6\u6001\u518d\u8fc1\u79fb\uff0c\u6240\u4ee5\u524d\u9a71\u8282\u70b9\u4e3a\u7a7a\u8bc1\u660e\u8fd8\u3010\u6ca1\u6709\u5b8c\u6210\u8fc1\u79fb\u3011\n    if (node.waitStatus == Node.CONDITION || node.prev == null)\n        return false;\n    // \u8bf4\u660e\u5f53\u524d\u8282\u70b9\u5df2\u7ecf\u6210\u529f\u5165\u961f\u5230\u963b\u585e\u961f\u5217\uff0c\u4e14\u5f53\u524d\u8282\u70b9\u540e\u9762\u5df2\u7ecf\u6709\u5176\u5b83 node\uff0c\u56e0\u4e3a\u6761\u4ef6\u961f\u5217\u7684 next \u6307\u9488\u4e3a null\n    if (node.next != null)\n        return true;\n\t// \u8bf4\u660e\u3010\u53ef\u80fd\u5728\u963b\u585e\u961f\u5217\uff0c\u4f46\u662f\u662f\u5c3e\u8282\u70b9\u3011\n    // \u4ece\u963b\u585e\u961f\u5217\u7684\u5c3e\u8282\u70b9\u5f00\u59cb\u5411\u524d\u3010\u904d\u5386\u67e5\u627e node\u3011\uff0c\u5982\u679c\u67e5\u627e\u5230\u8fd4\u56de true\uff0c\u67e5\u627e\u4e0d\u5230\u8fd4\u56de false\n    return findNodeFromTail(node);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["await \u7ebf\u7a0b park \u540e\u5982\u679c\u88ab unpark \u6216\u8005\u88ab\u6253\u65ad\uff0c\u90fd\u4f1a\u8fdb\u5165 checkInterruptWhileWaiting \u5224\u65ad\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff1a",(0,r.jsx)(e.strong,{children:"\u5728\u6761\u4ef6\u961f\u5217\u88ab\u6253\u65ad\u7684\u7ebf\u7a0b\u9700\u8981\u629b\u51fa\u5f02\u5e38"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private int checkInterruptWhileWaiting(Node node) {\n    // Thread.interrupted() \u8fd4\u56de\u5f53\u524d\u7ebf\u7a0b\u4e2d\u65ad\u6807\u8bb0\u4f4d\uff0c\u5e76\u4e14\u91cd\u7f6e\u5f53\u524d\u6807\u8bb0\u4f4d \u4e3a false\n    // \u5982\u679c\u88ab\u4e2d\u65ad\u4e86\uff0c\u6839\u636e\u662f\u5426\u5728\u6761\u4ef6\u961f\u5217\u88ab\u4e2d\u65ad\u7684\uff0c\u8bbe\u7f6e\u4e2d\u65ad\u72b6\u6001\u7801\n    return Thread.interrupted() ?(transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8fd9\u4e2a\u65b9\u6cd5\u53ea\u6709\u5728\u7ebf\u7a0b\u662f\u88ab\u6253\u65ad\u5524\u9192\u65f6\u624d\u4f1a\u8c03\u7528\nfinal boolean transferAfterCancelledWait(Node node) {\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524dnode\u4e00\u5b9a\u662f\u5728\u6761\u4ef6\u961f\u5217\u5185\uff0c\u56e0\u4e3a signal \u8fc1\u79fb\u8282\u70b9\u5230\u963b\u585e\u961f\u5217\u65f6\uff0c\u4f1a\u5c06\u8282\u70b9\u7684\u72b6\u6001\u4fee\u6539\u4e3a 0\n    if (compareAndSetWaitStatus(node, Node.CONDITION, 0)) {\n        // \u628a\u3010\u4e2d\u65ad\u5524\u9192\u7684 node \u52a0\u5165\u5230\u963b\u585e\u961f\u5217\u4e2d\u3011\n        enq(node);\n        // \u8868\u793a\u662f\u5728\u6761\u4ef6\u961f\u5217\u5185\u88ab\u4e2d\u65ad\u4e86\uff0c\u8bbe\u7f6e\u4e3a THROW_IE \u4e3a -1\n        return true;\n    }\n\n    //\u6267\u884c\u5230\u8fd9\u91cc\u7684\u60c5\u51b5\uff1a\n    //1.\u5f53\u524dnode\u5df2\u7ecf\u88ab\u5916\u90e8\u7ebf\u7a0b\u8c03\u7528 signal \u65b9\u6cd5\u5c06\u5176\u8fc1\u79fb\u5230 \u963b\u585e\u961f\u5217 \u5185\u4e86\n    //2.\u5f53\u524dnode\u6b63\u5728\u88ab\u5916\u90e8\u7ebf\u7a0b\u8c03\u7528 signal \u65b9\u6cd5\u5c06\u5176\u8fc1\u79fb\u81f3 \u963b\u585e\u961f\u5217 \u8fdb\u884c\u4e2d\u72b6\u6001\n    \n    // \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u8fd8\u6ca1\u5230\u963b\u585e\u961f\u5217\uff0c\u4e00\u76f4\u91ca\u653e CPU\n    while (!isOnSyncQueue(node))\n        Thread.yield();\n\n    // \u8868\u793a\u5f53\u524d\u8282\u70b9\u88ab\u4e2d\u65ad\u5524\u9192\u65f6\u4e0d\u5728\u6761\u4ef6\u961f\u5217\u4e86\uff0c\u8bbe\u7f6e\u4e3a REINTERRUPT \u4e3a 1\n    return false;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6700\u540e\u5f00\u59cb\u5904\u7406\u4e2d\u65ad\u72b6\u6001\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void reportInterruptAfterWait(int interruptMode) throws InterruptedException {\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u3010\u5728\u6761\u4ef6\u961f\u5217\u5185\u53d1\u751f\u8fc7\u4e2d\u65ad\uff0c\u6b64\u65f6 await \u65b9\u6cd5\u629b\u51fa\u4e2d\u65ad\u5f02\u5e38\u3011\n    if (interruptMode == THROW_IE)\n        throw new InterruptedException();\n\n    // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u3010\u5728\u6761\u4ef6\u961f\u5217\u5916\u53d1\u751f\u7684\u4e2d\u65ad\uff0c\u6b64\u65f6\u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u7684\u4e2d\u65ad\u6807\u8bb0\u4f4d\u4e3a true\u3011\n    else if (interruptMode == REINTERRUPT)\n        // \u8fdb\u884c\u4e00\u6b21\u81ea\u5df1\u6253\u65ad\uff0c\u4ea7\u751f\u4e2d\u65ad\u7684\u6548\u679c\n        selfInterrupt();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h6,{id:"signal",children:"signal"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5047\u8bbe Thread-1 \u8981\u6765\u5524\u9192 Thread-0\uff0c\u8fdb\u5165 ConditionObject \u7684 doSignal \u6d41\u7a0b\uff0c",(0,r.jsx)(e.strong,{children:"\u53d6\u5f97\u7b49\u5f85\u961f\u5217\u4e2d\u7b2c\u4e00\u4e2a Node"}),"\uff0c\u5373 Thread-0 \u6240\u5728 Node\uff0c\u5fc5\u987b\u6301\u6709\u9501\u624d\u80fd\u5524\u9192, \u56e0\u6b64 doSignal \u5185\u7ebf\u7a0b\u5b89\u5168"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final void signal() {\n    // \u5224\u65ad\u8c03\u7528 signal \u65b9\u6cd5\u7684\u7ebf\u7a0b\u662f\u5426\u662f\u72ec\u5360\u9501\u6301\u6709\u7ebf\u7a0b\n    if (!isHeldExclusively())\n        throw new IllegalMonitorStateException();\n    // \u83b7\u53d6\u6761\u4ef6\u961f\u5217\u4e2d\u7b2c\u4e00\u4e2a Node\n    Node first = firstWaiter;\n    // \u4e0d\u4e3a\u7a7a\u5c31\u5c06\u7b2c\u8be5\u8282\u70b9\u3010\u8fc1\u79fb\u5230\u963b\u585e\u961f\u5217\u3011\n    if (first != null)\n        doSignal(first);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5524\u9192 - \u3010\u5c06\u6ca1\u53d6\u6d88\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\u8f6c\u79fb\u81f3 AQS \u961f\u5217\u5c3e\u90e8\u3011\nprivate void doSignal(Node first) {\n    do {\n        // \u6210\u7acb\u8bf4\u660e\u5f53\u524d\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\u662f null\uff0c\u5f53\u524d\u8282\u70b9\u662f\u5c3e\u8282\u70b9\u4e86\uff0c\u961f\u5217\u4e2d\u53ea\u6709\u5f53\u524d\u4e00\u4e2a\u8282\u70b9\u4e86\n        if ((firstWaiter = first.nextWaiter) == null)\n            lastWaiter = null;\n        first.nextWaiter = null;\n    // \u5c06\u7b49\u5f85\u961f\u5217\u4e2d\u7684 Node \u8f6c\u79fb\u81f3 AQS \u961f\u5217\uff0c\u4e0d\u6210\u529f\u4e14\u8fd8\u6709\u8282\u70b9\u5219\u7ee7\u7eed\u5faa\u73af\n    } while (!transferForSignal(first) && (first = firstWaiter) != null);\n}\n\n// signalAll() \u4f1a\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\uff0c\u5524\u9192\u6240\u6709\u7684\u8282\u70b9\nprivate void doSignalAll(Node first) {\n    lastWaiter = firstWaiter = null;\n    do {\n        Node next = first.nextWaiter;\n        first.nextWaiter = null;\n        transferForSignal(first);\n        first = next;\n    // \u5524\u9192\u6240\u6709\u7684\u8282\u70b9\uff0c\u90fd\u653e\u5230\u963b\u585e\u961f\u5217\u4e2d\n    } while (first != null);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6267\u884c transferForSignal\uff0c",(0,r.jsx)(e.strong,{children:"\u5148\u5c06\u8282\u70b9\u7684 waitStatus \u6539\u4e3a 0\uff0c\u7136\u540e\u52a0\u5165 AQS \u963b\u585e\u961f\u5217\u5c3e\u90e8"}),"\uff0c\u5c06 Thread-3 \u7684 waitStatus \u6539\u4e3a -1"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5982\u679c\u8282\u70b9\u72b6\u6001\u662f\u53d6\u6d88, \u8fd4\u56de false \u8868\u793a\u8f6c\u79fb\u5931\u8d25, \u5426\u5219\u8f6c\u79fb\u6210\u529f\nfinal boolean transferForSignal(Node node) {\n    // CAS \u4fee\u6539\u5f53\u524d\u8282\u70b9\u7684\u72b6\u6001\uff0c\u4fee\u6539\u4e3a 0\uff0c\u56e0\u4e3a\u5f53\u524d\u8282\u70b9\u9a6c\u4e0a\u8981\u8fc1\u79fb\u5230\u963b\u585e\u961f\u5217\u4e86\n    // \u5982\u679c\u72b6\u6001\u5df2\u7ecf\u4e0d\u662f CONDITION, \u8bf4\u660e\u7ebf\u7a0b\u88ab\u53d6\u6d88\uff08await \u91ca\u653e\u5168\u90e8\u9501\u5931\u8d25\uff09\u6216\u8005\u88ab\u4e2d\u65ad\uff08\u53ef\u6253\u65ad cancelAcquire\uff09\n    if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))\n        // \u8fd4\u56de\u51fd\u6570\u8c03\u7528\u5904\u7ee7\u7eed\u5bfb\u627e\u4e0b\u4e00\u4e2a\u8282\u70b9\n        return false;\n    \n    // \u3010\u5148\u6539\u72b6\u6001\uff0c\u518d\u8fdb\u884c\u8fc1\u79fb\u3011\n    // \u5c06\u5f53\u524d node \u5165\u963b\u585e\u961f\u5217\uff0cp \u662f\u5f53\u524d\u8282\u70b9\u5728\u963b\u585e\u961f\u5217\u7684\u3010\u524d\u9a71\u8282\u70b9\u3011\n    Node p = enq(node);\n    int ws = p.waitStatus;\n    \n    // \u5982\u679c\u524d\u9a71\u8282\u70b9\u88ab\u53d6\u6d88\u6216\u8005\u4e0d\u80fd\u8bbe\u7f6e\u72b6\u6001\u4e3a Node.SIGNAL\uff0c\u5c31 unpark \u53d6\u6d88\u5f53\u524d\u8282\u70b9\u7ebf\u7a0b\u7684\u963b\u585e\u72b6\u6001, \n    // \u8ba9 thread-0 \u7ebf\u7a0b\u7ade\u4e89\u9501\uff0c\u91cd\u65b0\u540c\u6b65\u72b6\u6001\n    if (ws > 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))\n        LockSupport.unpark(node.thread);\n    return true;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(45491).A+"",width:"1005",height:"362"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Thread-1 \u91ca\u653e\u9501\uff0c\u8fdb\u5165 unlock \u6d41\u7a0b"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"readwrite",children:"ReadWrite"}),"\n",(0,r.jsx)(e.h4,{id:"\u8bfb\u5199\u9501",children:"\u8bfb\u5199\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u72ec\u5360\u9501\uff1a\u6307\u8be5\u9501\u4e00\u6b21\u53ea\u80fd\u88ab\u4e00\u4e2a\u7ebf\u7a0b\u6240\u6301\u6709\uff0c\u5bf9 ReentrantLock \u548c Synchronized \u800c\u8a00\u90fd\u662f\u72ec\u5360\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u5171\u4eab\u9501\uff1a\u6307\u8be5\u9501\u53ef\u4ee5\u88ab\u591a\u4e2a\u7ebf\u7a0b\u9501\u6301\u6709"}),"\n",(0,r.jsxs)(e.p,{children:["ReentrantReadWriteLock \u5176",(0,r.jsx)(e.strong,{children:"\u8bfb\u9501\u662f\u5171\u4eab\u9501\uff0c\u5199\u9501\u662f\u72ec\u5360\u9501"})]}),"\n",(0,r.jsx)(e.p,{children:"\u4f5c\u7528\uff1a\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8bfb\u4e00\u4e2a\u8d44\u6e90\u7c7b\u6ca1\u6709\u4efb\u4f55\u95ee\u9898\uff0c\u4e3a\u4e86\u6ee1\u8db3\u5e76\u53d1\u91cf\uff0c\u8bfb\u53d6\u5171\u4eab\u8d44\u6e90\u5e94\u8be5\u540c\u65f6\u8fdb\u884c\uff0c\u4f46\u662f\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u60f3\u53bb\u5199\u5171\u4eab\u8d44\u6e90\uff0c\u5c31\u4e0d\u5e94\u8be5\u518d\u6709\u5176\u5b83\u7ebf\u7a0b\u53ef\u4ee5\u5bf9\u8be5\u8d44\u6e90\u8fdb\u884c\u8bfb\u6216\u5199"}),"\n",(0,r.jsx)(e.p,{children:"\u4f7f\u7528\u89c4\u5219\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u52a0\u9501\u89e3\u9501\u683c\u5f0f\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"r.lock();\ntry {\n    // \u4e34\u754c\u533a\n} finally {\n\tr.unlock();\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bfb-\u8bfb\u80fd\u5171\u5b58\u3001\u8bfb-\u5199\u4e0d\u80fd\u5171\u5b58\u3001\u5199-\u5199\u4e0d\u80fd\u5171\u5b58"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bfb\u9501\u4e0d\u652f\u6301\u6761\u4ef6\u53d8\u91cf"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u91cd\u5165\u65f6\u5347\u7ea7\u4e0d\u652f\u6301"}),"\uff1a\u6301\u6709\u8bfb\u9501\u7684\u60c5\u51b5\u4e0b\u53bb\u83b7\u53d6\u5199\u9501\u4f1a\u5bfc\u81f4\u83b7\u53d6\u5199\u9501\u6c38\u4e45\u7b49\u5f85\uff0c\u9700\u8981\u5148\u91ca\u653e\u8bfb\uff0c\u518d\u53bb\u83b7\u5f97\u5199"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u91cd\u5165\u65f6\u964d\u7ea7\u652f\u6301"}),"\uff1a\u6301\u6709\u5199\u9501\u7684\u60c5\u51b5\u4e0b\u53bb\u83b7\u53d6\u8bfb\u9501\uff0c\u9020\u6210\u53ea\u6709\u5f53\u524d\u7ebf\u7a0b\u4f1a\u6301\u6709\u8bfb\u9501\uff0c\u56e0\u4e3a\u5199\u9501\u4f1a\u4e92\u65a5\u5176\u4ed6\u7684\u9501"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"w.lock();\ntry {\n    r.lock();// \u964d\u7ea7\u4e3a\u8bfb\u9501, \u91ca\u653e\u5199\u9501, \u8fd9\u6837\u80fd\u591f\u8ba9\u5176\u5b83\u7ebf\u7a0b\u8bfb\u53d6\u7f13\u5b58\n    try {\n        // ...\n    } finally{\n    \tw.unlock();// \u8981\u5728\u5199\u9501\u91ca\u653e\u4e4b\u524d\u83b7\u53d6\u8bfb\u9501\n    }\n} finally{\n\tr.unlock();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public ReentrantReadWriteLock()"}),"\uff1a\u9ed8\u8ba4\u6784\u9020\u65b9\u6cd5\uff0c\u975e\u516c\u5e73\u9501"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public ReentrantReadWriteLock(boolean fair)"}),"\uff1atrue \u4e3a\u516c\u5e73\u9501"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public ReentrantReadWriteLock.ReadLock readLock()"}),"\uff1a\u8fd4\u56de\u8bfb\u9501"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public ReentrantReadWriteLock.WriteLock writeLock()"}),"\uff1a\u8fd4\u56de\u5199\u9501"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void lock()"}),"\uff1a\u52a0\u9501"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void unlock()"}),"\uff1a\u89e3\u9501"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public boolean tryLock()"}),"\uff1a\u5c1d\u8bd5\u83b7\u53d6\u9501"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u8bfb\u8bfb\u5e76\u53d1\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ReentrantReadWriteLock rw = new ReentrantReadWriteLock();\n    ReentrantReadWriteLock.ReadLock r = rw.readLock();\n    ReentrantReadWriteLock.WriteLock w = rw.writeLock();\n\n    new Thread(() -> {\n        r.lock();\n        try {\n            Thread.sleep(2000);\n            System.out.println("Thread 1 running " + new Date());\n        } finally {\n            r.unlock();\n        }\n    },"t1").start();\n    new Thread(() -> {\n        r.lock();\n        try {\n            Thread.sleep(2000);\n            System.out.println("Thread 2 running " + new Date());\n        } finally {\n            r.unlock();\n        }\n    },"t2").start();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u7f13\u5b58\u5e94\u7528",children:"\u7f13\u5b58\u5e94\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u7f13\u5b58\u66f4\u65b0\u65f6\uff0c\u662f\u5148\u6e05\u7f13\u5b58\u8fd8\u662f\u5148\u66f4\u65b0\u6570\u636e\u5e93"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5148\u6e05\u7f13\u5b58\uff1a\u53ef\u80fd\u9020\u6210\u521a\u6e05\u7406\u7f13\u5b58\u8fd8\u6ca1\u6709\u66f4\u65b0\u6570\u636e\u5e93\uff0c\u7ebf\u7a0b\u76f4\u63a5\u67e5\u8be2\u4e86\u6570\u636e\u5e93\u66f4\u65b0\u8fc7\u671f\u6570\u636e\u5230\u7f13\u5b58"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5148\u66f4\u65b0\u636e\u5e93\uff1a\u53ef\u80fd\u9020\u6210\u521a\u66f4\u65b0\u6570\u636e\u5e93\uff0c\u8fd8\u6ca1\u6e05\u7a7a\u7f13\u5b58\u5c31\u6709\u7ebf\u7a0b\u4ece\u7f13\u5b58\u62ff\u5230\u4e86\u65e7\u6570\u636e"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8865\u5145\u60c5\u51b5\uff1a\u67e5\u8be2\u7ebf\u7a0b A \u67e5\u8be2\u6570\u636e\u65f6\u6070\u597d\u7f13\u5b58\u6570\u636e\u7531\u4e8e\u65f6\u95f4\u5230\u671f\u5931\u6548\uff0c\u6216\u662f\u7b2c\u4e00\u6b21\u67e5\u8be2"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(20452).A+"",width:"805",height:"339"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u53ef\u4ee5\u4f7f\u7528\u8bfb\u5199\u9501\u8fdb\u884c\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b9e\u73b0\u539f\u7406-5",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u5c5e\u6027-5",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsxs)(e.p,{children:["\u8bfb\u5199\u9501\u7528\u7684\u662f\u540c\u4e00\u4e2a Sycn \u540c\u6b65\u5668\uff0c\u56e0\u6b64\u7b49\u5f85\u961f\u5217\u3001state \u7b49\u4e5f\u662f\u540c\u4e00\u4e2a\uff0c\u539f\u7406\u4e0e ReentrantLock \u52a0\u9501\u76f8\u6bd4\u6ca1\u6709\u7279\u6b8a\u4e4b\u5904\uff0c\u4e0d\u540c\u662f",(0,r.jsx)(e.strong,{children:"\u5199\u9501\u72b6\u6001\u5360\u4e86 state \u7684\u4f4e 16 \u4f4d\uff0c\u800c\u8bfb\u9501\u4f7f\u7528\u7684\u662f state \u7684\u9ad8 16 \u4f4d"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bfb\u5199\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final ReentrantReadWriteLock.ReadLock readerLock;\t\t\nprivate final ReentrantReadWriteLock.WriteLock writerLock;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a\u9ed8\u8ba4\u662f\u975e\u516c\u5e73\u9501\uff0c\u53ef\u4ee5\u6307\u5b9a\u53c2\u6570\u521b\u5efa\u516c\u5e73\u9501"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ReentrantReadWriteLock(boolean fair) {\n    // true \u4e3a\u516c\u5e73\u9501\n    sync = fair ? new FairSync() : new NonfairSync();\n    // \u8fd9\u4e24\u4e2a lock \u5171\u4eab\u540c\u4e00\u4e2a sync \u5b9e\u4f8b\uff0c\u90fd\u662f\u7531 ReentrantReadWriteLock \u7684 sync \u63d0\u4f9b\u540c\u6b65\u5b9e\u73b0\n    readerLock = new ReadLock(this);\n    writerLock = new WriteLock(this);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Sync \u7c7b\u7684\u5c5e\u6027\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7edf\u8ba1\u53d8\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u7528\u6765\u79fb\u4f4d\nstatic final int SHARED_SHIFT   = 16;\n// \u9ad816\u4f4d\u76841\nstatic final int SHARED_UNIT    = (1 << SHARED_SHIFT);\n// 65535\uff0c16\u4e2a1\uff0c\u4ee3\u8868\u5199\u9501\u7684\u6700\u5927\u91cd\u5165\u6b21\u6570\nstatic final int MAX_COUNT      = (1 << SHARED_SHIFT) - 1;\n// \u4f4e16\u4f4d\u63a9\u7801\uff1a0b 1111 1111 1111 1111\uff0c\u7528\u6765\u83b7\u53d6\u5199\u9501\u91cd\u5165\u7684\u6b21\u6570\nstatic final int EXCLUSIVE_MASK = (1 << SHARED_SHIFT) - 1;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u8bfb\u5199\u9501\u7684\u6b21\u6570\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u83b7\u53d6\u8bfb\u5199\u9501\u7684\u8bfb\u9501\u5206\u914d\u7684\u603b\u6b21\u6570\nstatic int sharedCount(int c)    { return c >>> SHARED_SHIFT; }\n// \u5199\u9501\uff08\u72ec\u5360\uff09\u9501\u7684\u91cd\u5165\u6b21\u6570\nstatic int exclusiveCount(int c) { return c & EXCLUSIVE_MASK; }\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5185\u90e8\u7c7b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8bb0\u5f55\u8bfb\u9501\u7ebf\u7a0b\u81ea\u5df1\u7684\u6301\u6709\u8bfb\u9501\u7684\u6570\u91cf\uff08\u91cd\u5165\u6b21\u6570\uff09\uff0c\u56e0\u4e3a state \u9ad816\u4f4d\u8bb0\u5f55\u7684\u662f\u5168\u5c40\u8303\u56f4\u5185\u6240\u6709\u7684\u8bfb\u7ebf\u7a0b\u83b7\u53d6\u8bfb\u9501\u7684\u603b\u91cf\nstatic final class HoldCounter {\n    int count = 0;\n    // Use id, not reference, to avoid garbage retention\n    final long tid = getThreadId(Thread.currentThread());\n}\n// \u7ebf\u7a0b\u5b89\u5168\u7684\u5b58\u653e\u7ebf\u7a0b\u5404\u81ea\u7684 HoldCounter \u5bf9\u8c61\nstatic final class ThreadLocalHoldCounter extends ThreadLocal<HoldCounter> {\n    public HoldCounter initialValue() {\n        return new HoldCounter();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5185\u90e8\u7c7b\u5b9e\u4f8b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5f53\u524d\u7ebf\u7a0b\u6301\u6709\u7684\u53ef\u91cd\u5165\u8bfb\u9501\u7684\u6570\u91cf\uff0c\u8ba1\u6570\u4e3a 0 \u65f6\u5220\u9664\nprivate transient ThreadLocalHoldCounter readHolds;\n// \u8bb0\u5f55\u6700\u540e\u4e00\u4e2a\u83b7\u53d6\u3010\u8bfb\u9501\u3011\u7ebf\u7a0b\u7684 HoldCounter \u5bf9\u8c61\nprivate transient HoldCounter cachedHoldCounter;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u9996\u6b21\u83b7\u53d6\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u7b2c\u4e00\u4e2a\u83b7\u53d6\u8bfb\u9501\u7684\u7ebf\u7a0b\nprivate transient Thread firstReader = null;\n// \u8bb0\u5f55\u8be5\u7ebf\u7a0b\u6301\u6709\u7684\u8bfb\u9501\u6b21\u6570\uff08\u8bfb\u9501\u91cd\u5165\u6b21\u6570\uff09\nprivate transient int firstReaderHoldCount;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Sync \u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"Sync() {\n    readHolds = new ThreadLocalHoldCounter();\n    // \u786e\u4fdd\u5176\u4ed6\u7ebf\u7a0b\u7684\u6570\u636e\u53ef\u89c1\u6027\uff0cstate \u662f volatile \u4fee\u9970\u7684\u53d8\u91cf\uff0c\u91cd\u5199\u8be5\u503c\u4f1a\u5c06\u7ebf\u7a0b\u672c\u5730\u7f13\u5b58\u6570\u636e\u3010\u540c\u6b65\u81f3\u4e3b\u5b58\u3011\n    setState(getState()); \n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u52a0\u9501\u539f\u7406",children:"\u52a0\u9501\u539f\u7406"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["t1 \u7ebf\u7a0b\uff1aw.lock\uff08",(0,r.jsx)(e.strong,{children:"\u5199\u9501"}),"\uff09\uff0c\u6210\u529f\u4e0a\u9501 state = 0_1"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// lock()  -> sync.acquire(1);\npublic void lock() {\n    sync.acquire(1);\n}\npublic final void acquire(int arg) {\n    // \u5c1d\u8bd5\u83b7\u5f97\u5199\u9501\uff0c\u83b7\u5f97\u5199\u9501\u5931\u8d25\uff0c\u5c06\u5f53\u524d\u7ebf\u7a0b\u5173\u8054\u5230\u4e00\u4e2a Node \u5bf9\u8c61\u4e0a, \u6a21\u5f0f\u4e3a\u72ec\u5360\u6a21\u5f0f \n    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n        selfInterrupt();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'protected final boolean tryAcquire(int acquires) {\n    Thread current = Thread.currentThread();\n    int c = getState();\n    // \u83b7\u5f97\u4f4e 16 \u4f4d, \u4ee3\u8868\u5199\u9501\u7684 state \u8ba1\u6570\n    int w = exclusiveCount(c);\n    // \u8bf4\u660e\u6709\u8bfb\u9501\u6216\u8005\u5199\u9501\n    if (c != 0) {\n        // c != 0 and w == 0 \u8868\u793a\u6709\u8bfb\u9501\uff0c\u3010\u8bfb\u9501\u4e0d\u80fd\u5347\u7ea7\u3011\uff0c\u76f4\u63a5\u8fd4\u56de false\n        // w != 0 \u8bf4\u660e\u6709\u5199\u9501\uff0c\u5199\u9501\u7684\u62e5\u6709\u8005\u4e0d\u662f\u81ea\u5df1\uff0c\u83b7\u53d6\u5931\u8d25\n        if (w == 0 || current != getExclusiveOwnerThread())\n            return false;\n        \n        // \u6267\u884c\u5230\u8fd9\u91cc\u53ea\u6709\u4e00\u79cd\u60c5\u51b5\uff1a\u3010\u5199\u9501\u91cd\u5165\u3011\uff0c\u6240\u4ee5\u4e0b\u9762\u51e0\u884c\u4ee3\u7801\u4e0d\u5b58\u5728\u5e76\u53d1\n        if (w + exclusiveCount(acquires) > MAX_COUNT)\n            throw new Error("Maximum lock count exceeded");\n        // \u5199\u9501\u91cd\u5165, \u83b7\u5f97\u9501\u6210\u529f\uff0c\u6ca1\u6709\u5e76\u53d1\uff0c\u6240\u4ee5\u4e0d\u4f7f\u7528 CAS\n        setState(c + acquires);\n        return true;\n    }\n    \n    // c == 0\uff0c\u8bf4\u660e\u6ca1\u6709\u4efb\u4f55\u9501\uff0c\u5224\u65ad\u5199\u9501\u662f\u5426\u8be5\u963b\u585e\uff0c\u662f false \u5c31\u5c1d\u8bd5\u83b7\u53d6\u9501\uff0c\u5931\u8d25\u8fd4\u56de false\n    if (writerShouldBlock() || !compareAndSetState(c, c + acquires))\n        return false;\n    // \u83b7\u5f97\u9501\u6210\u529f\uff0c\u8bbe\u7f6e\u9501\u7684\u6301\u6709\u7ebf\u7a0b\u4e3a\u5f53\u524d\u7ebf\u7a0b\n    setExclusiveOwnerThread(current);\n    return true;\n}\n// \u975e\u516c\u5e73\u9501 writerShouldBlock \u603b\u662f\u8fd4\u56de false, \u65e0\u9700\u963b\u585e\nfinal boolean writerShouldBlock() {\n    return false; \n}\n// \u516c\u5e73\u9501\u4f1a\u68c0\u67e5 AQS \u961f\u5217\u4e2d\u662f\u5426\u6709\u524d\u9a71\u8282\u70b9, \u6ca1\u6709(false)\u624d\u53bb\u7ade\u4e89\nfinal boolean writerShouldBlock() {\n    return hasQueuedPredecessors();\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["t2 r.lock\uff08",(0,r.jsx)(e.strong,{children:"\u8bfb\u9501"}),"\uff09\uff0c\u8fdb\u5165 tryAcquireShared \u6d41\u7a0b\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8fd4\u56de -1 \u8868\u793a\u5931\u8d25"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u8fd4\u56de 0 \u8868\u793a\u6210\u529f"}),"\n",(0,r.jsx)(e.li,{children:"\u8fd4\u56de\u6b63\u6570\u8868\u793a\u8fd8\u6709\u591a\u5c11\u540e\u7ee7\u8282\u70b9\u652f\u6301\u5171\u4eab\u6a21\u5f0f\uff0c\u8bfb\u5199\u9501\u8fd4\u56de 1"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void lock() {\n    sync.acquireShared(1);\n}\npublic final void acquireShared(int arg) {\n    // tryAcquireShared \u8fd4\u56de\u8d1f\u6570, \u8868\u793a\u83b7\u53d6\u8bfb\u9501\u5931\u8d25\n    if (tryAcquireShared(arg) < 0)\n        doAcquireShared(arg);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5c1d\u8bd5\u4ee5\u5171\u4eab\u6a21\u5f0f\u83b7\u53d6\nprotected final int tryAcquireShared(int unused) {\n    Thread current = Thread.currentThread();\n    int c = getState();\n    // exclusiveCount(c) \u4ee3\u8868\u4f4e 16 \u4f4d, \u5199\u9501\u7684 state\uff0c\u6210\u7acb\u8bf4\u660e\u6709\u7ebf\u7a0b\u6301\u6709\u5199\u9501\n    // \u5199\u9501\u7684\u6301\u6709\u8005\u4e0d\u662f\u5f53\u524d\u7ebf\u7a0b\uff0c\u5219\u83b7\u53d6\u8bfb\u9501\u5931\u8d25\uff0c\u3010\u5199\u9501\u5141\u8bb8\u964d\u7ea7\u3011\n    if (exclusiveCount(c) != 0 && getExclusiveOwnerThread() != current)\n        return -1;\n    \n    // \u9ad8 16 \u4f4d\uff0c\u4ee3\u8868\u8bfb\u9501\u7684 state\uff0c\u5171\u4eab\u9501\u5206\u914d\u51fa\u53bb\u7684\u603b\u6b21\u6570\n    int r = sharedCount(c);\n    // \u8bfb\u9501\u662f\u5426\u5e94\u8be5\u963b\u585e\n    if (!readerShouldBlock() &&\tr < MAX_COUNT &&\n        compareAndSetState(c, c + SHARED_UNIT)) {\t// \u5c1d\u8bd5\u589e\u52a0\u8bfb\u9501\u8ba1\u6570\n        // \u52a0\u9501\u6210\u529f\n        // \u52a0\u9501\u4e4b\u524d\u8bfb\u9501\u4e3a 0\uff0c\u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u662f\u7b2c\u4e00\u4e2a\u8bfb\u9501\u7ebf\u7a0b\n        if (r == 0) {\n            firstReader = current;\n            firstReaderHoldCount = 1;\n        // \u7b2c\u4e00\u4e2a\u8bfb\u9501\u7ebf\u7a0b\u662f\u81ea\u5df1\u5c31\u53d1\u751f\u4e86\u8bfb\u9501\u91cd\u5165\n        } else if (firstReader == current) {\n            firstReaderHoldCount++;\n        } else {\n            // cachedHoldCounter \u8bbe\u7f6e\u4e3a\u5f53\u524d\u7ebf\u7a0b\u7684 holdCounter \u5bf9\u8c61\uff0c\u5373\u6700\u540e\u4e00\u4e2a\u83b7\u53d6\u8bfb\u9501\u7684\u7ebf\u7a0b\n            HoldCounter rh = cachedHoldCounter;\n            // \u8bf4\u660e\u8fd8\u6ca1\u8bbe\u7f6e rh\n            if (rh == null || rh.tid != getThreadId(current))\n                // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u7684\u9501\u91cd\u5165\u7684\u5bf9\u8c61\uff0c\u8d4b\u503c\u7ed9 cachedHoldCounter\n                cachedHoldCounter = rh = readHolds.get();\n            // \u8fd8\u6ca1\u91cd\u5165\n            else if (rh.count == 0)\n                readHolds.set(rh);\n            // \u91cd\u5165 + 1\n            rh.count++;\n        }\n        // \u8bfb\u9501\u52a0\u9501\u6210\u529f\n        return 1;\n    }\n    // \u903b\u8f91\u5230\u8fd9 \u5e94\u8be5\u963b\u585e\uff0c\u6216\u8005 cas \u52a0\u9501\u5931\u8d25\n    // \u4f1a\u4e0d\u65ad\u5c1d\u8bd5 for (;;) \u83b7\u53d6\u8bfb\u9501, \u6267\u884c\u8fc7\u7a0b\u4e2d\u65e0\u963b\u585e\n    return fullTryAcquireShared(current);\n}\n// \u975e\u516c\u5e73\u9501 readerShouldBlock \u504f\u5411\u5199\u9501\u4e00\u4e9b\uff0c\u770b AQS \u963b\u585e\u961f\u5217\u4e2d\u7b2c\u4e00\u4e2a\u8282\u70b9\u662f\u5426\u662f\u5199\u9501\uff0c\u662f\u5219\u963b\u585e\uff0c\u53cd\u4e4b\u4e0d\u963b\u585e\n// \u9632\u6b62\u4e00\u76f4\u6709\u8bfb\u9501\u7ebf\u7a0b\uff0c\u5bfc\u81f4\u5199\u9501\u7ebf\u7a0b\u9965\u997f\n// true \u5219\u8be5\u963b\u585e, false \u5219\u4e0d\u963b\u585e\nfinal boolean readerShouldBlock() {\n    return apparentlyFirstQueuedIsExclusive();\n}\nfinal boolean readerShouldBlock() {\n    return hasQueuedPredecessors();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'final int fullTryAcquireShared(Thread current) {\n    // \u5f53\u524d\u8bfb\u9501\u7ebf\u7a0b\u6301\u6709\u7684\u8bfb\u9501\u6b21\u6570\u5bf9\u8c61\n    HoldCounter rh = null;\n    for (;;) {\n        int c = getState();\n        // \u8bf4\u660e\u6709\u7ebf\u7a0b\u6301\u6709\u5199\u9501\n        if (exclusiveCount(c) != 0) {\n            // \u5199\u9501\u4e0d\u662f\u81ea\u5df1\u5219\u83b7\u53d6\u9501\u5931\u8d25\n            if (getExclusiveOwnerThread() != current)\n                return -1;\n        } else if (readerShouldBlock()) {\n            // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u662f firstReader\uff0c\u5f53\u524d\u9501\u662f\u8bfb\u5fd9\u788c\u72b6\u6001\uff0c\u800c\u4e14\u5f53\u524d\u7ebf\u7a0b\u4e5f\u662f\u8bfb\u9501\u91cd\u5165\n            if (firstReader == current) {\n                // assert firstReaderHoldCount > 0;\n            } else {\n                if (rh == null) {\n                    // \u6700\u540e\u4e00\u4e2a\u8bfb\u9501\u7684 HoldCounter\n                    rh = cachedHoldCounter;\n                    // \u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u4e5f\u4e0d\u662f\u6700\u540e\u4e00\u4e2a\u8bfb\u9501\n                    if (rh == null || rh.tid != getThreadId(current)) {\n                        // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u7684 HoldCounter\n                        rh = readHolds.get();\n                        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e HoldCounter \u5bf9\u8c61\u662f\u4e0a\u4e00\u6b65\u4ee3\u7801\u65b0\u5efa\u7684\n                        // \u5f53\u524d\u7ebf\u7a0b\u4e0d\u662f\u9501\u91cd\u5165\uff0c\u5728 readerShouldBlock() \u8fd4\u56de true \u65f6\u9700\u8981\u53bb\u6392\u961f\n                        if (rh.count == 0)\n                            // \u9632\u6b62\u5185\u5b58\u6cc4\u6f0f\n                            readHolds.remove();\n                    }\n                }\n                if (rh.count == 0)\n                    return -1;\n            }\n        }\n        // \u8d8a\u754c\u5224\u65ad\n        if (sharedCount(c) == MAX_COUNT)\n            throw new Error("Maximum lock count exceeded");\n        // \u8bfb\u9501\u52a0\u9501\uff0c\u6761\u4ef6\u5185\u7684\u903b\u8f91\u4e0e tryAcquireShared \u76f8\u540c\n        if (compareAndSetState(c, c + SHARED_UNIT)) {\n            if (sharedCount(c) == 0) {\n                firstReader = current;\n                firstReaderHoldCount = 1;\n            } else if (firstReader == current) {\n                firstReaderHoldCount++;\n            } else {\n                if (rh == null)\n                    rh = cachedHoldCounter;\n                if (rh == null || rh.tid != getThreadId(current))\n                    rh = readHolds.get();\n                else if (rh.count == 0)\n                    readHolds.set(rh);\n                rh.count++;\n                cachedHoldCounter = rh; // cache for release\n            }\n            return 1;\n        }\n    }\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u8bfb\u9501\u5931\u8d25\uff0c\u8fdb\u5165 sync.doAcquireShared(1) \u6d41\u7a0b\u5f00\u59cb\u963b\u585e\uff0c\u9996\u5148\u4e5f\u662f\u8c03\u7528 addWaiter \u6dfb\u52a0\u8282\u70b9\uff0c\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u8282\u70b9\u88ab\u8bbe\u7f6e\u4e3a Node.SHARED \u6a21\u5f0f\u800c\u975e Node.EXCLUSIVE \u6a21\u5f0f\uff0c\u6ce8\u610f\u6b64\u65f6 t2 \u4ecd\u5904\u4e8e\u6d3b\u8dc3\u72b6\u6001"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void doAcquireShared(int arg) {\n    // \u5c06\u5f53\u524d\u7ebf\u7a0b\u5173\u8054\u5230\u4e00\u4e2a Node \u5bf9\u8c61\u4e0a, \u6a21\u5f0f\u4e3a\u5171\u4eab\u6a21\u5f0f\n    final Node node = addWaiter(Node.SHARED);\n    boolean failed = true;\n    try {\n        boolean interrupted = false;\n        for (;;) {\n            // \u83b7\u53d6\u524d\u9a71\u8282\u70b9\n            final Node p = node.predecessor();\n            // \u5982\u679c\u524d\u9a71\u8282\u70b9\u5c31\u5934\u8282\u70b9\u5c31\u53bb\u5c1d\u8bd5\u83b7\u53d6\u9501\n            if (p == head) {\n                // \u518d\u4e00\u6b21\u5c1d\u8bd5\u83b7\u53d6\u8bfb\u9501\n                int r = tryAcquireShared(arg);\n                // r >= 0 \u8868\u793a\u83b7\u53d6\u6210\u529f\n                if (r >= 0) {\n                    //\u3010\u8fd9\u91cc\u4f1a\u8bbe\u7f6e\u81ea\u5df1\u4e3a\u5934\u8282\u70b9\uff0c\u5524\u9192\u76f8\u8fde\u7684\u540e\u5e8f\u7684\u5171\u4eab\u8282\u70b9\u3011\n                    setHeadAndPropagate(node, r);\n                    p.next = null; // help GC\n                    if (interrupted)\n                        selfInterrupt();\n                    failed = false;\n                    return;\n                }\n            }\n            // \u662f\u5426\u5728\u83b7\u53d6\u8bfb\u9501\u5931\u8d25\u65f6\u963b\u585e      \t\t\t\t\t park \u5f53\u524d\u7ebf\u7a0b\n            if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u6ca1\u6709\u6210\u529f\uff0c\u5728 doAcquireShared \u5185 for (;;) \u5faa\u73af\u4e00\u6b21\uff0cshouldParkAfterFailedAcquire \u5185\u628a\u524d\u9a71\u8282\u70b9\u7684 waitStatus \u6539\u4e3a -1\uff0c\u518d for (;;) \u5faa\u73af\u4e00\u6b21\u5c1d\u8bd5 tryAcquireShared\uff0c\u4e0d\u6210\u529f\u5728 parkAndCheckInterrupt() \u5904 park"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(83006).A+"",width:"880",height:"363"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fd9\u79cd\u72b6\u6001\u4e0b\uff0c\u5047\u8bbe\u53c8\u6709 t3 r.lock\uff0ct4 w.lock\uff0c\u8fd9\u671f\u95f4 t1 \u4ecd\u7136\u6301\u6709\u9501\uff0c\u5c31\u53d8\u6210\u4e86\u4e0b\u9762\u7684\u6837\u5b50"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(50357).A+"",width:"966",height:"296"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u89e3\u9501\u539f\u7406",children:"\u89e3\u9501\u539f\u7406"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"t1 w.unlock\uff0c \u5199\u9501\u89e3\u9501"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void unlock() {\n    // \u91ca\u653e\u9501\n    sync.release(1);\n}\npublic final boolean release(int arg) {\n    // \u5c1d\u8bd5\u91ca\u653e\u9501\n    if (tryRelease(arg)) {\n        Node h = head;\n        // \u5934\u8282\u70b9\u4e0d\u4e3a\u7a7a\u5e76\u4e14\u4e0d\u662f\u7b49\u5f85\u72b6\u6001\u4e0d\u662f 0\uff0c\u5524\u9192\u540e\u7ee7\u7684\u975e\u53d6\u6d88\u8282\u70b9\n        if (h != null && h.waitStatus != 0)\n            unparkSuccessor(h);\n        return true;\n    }\n    return false;\n}\nprotected final boolean tryRelease(int releases) {\n    if (!isHeldExclusively())\n        throw new IllegalMonitorStateException();\n    int nextc = getState() - releases;\n    // \u56e0\u4e3a\u53ef\u91cd\u5165\u7684\u539f\u56e0, \u5199\u9501\u8ba1\u6570\u4e3a 0, \u624d\u7b97\u91ca\u653e\u6210\u529f\n    boolean free = exclusiveCount(nextc) == 0;\n    if (free)\n        setExclusiveOwnerThread(null);\n    setState(nextc);\n    return free;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5524\u9192\u6d41\u7a0b sync.unparkSuccessor\uff0c\u8fd9\u65f6 t2 \u5728 doAcquireShared \u7684 parkAndCheckInterrupt() \u5904\u6062\u590d\u8fd0\u884c\uff0c\u7ee7\u7eed\u5faa\u73af\uff0c\u6267\u884c tryAcquireShared \u6210\u529f\u5219\u8ba9\u8bfb\u9501\u8ba1\u6570\u52a0\u4e00"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u63a5\u4e0b\u6765 t2 \u8c03\u7528 setHeadAndPropagate(node, 1)\uff0c\u5b83\u539f\u672c\u6240\u5728\u8282\u70b9\u88ab\u7f6e\u4e3a\u5934\u8282\u70b9\uff1b\u8fd8\u4f1a\u68c0\u67e5\u4e0b\u4e00\u4e2a\u8282\u70b9\u662f\u5426\u662f shared\uff0c\u5982\u679c\u662f\u5219\u8c03\u7528 doReleaseShared() \u5c06 head \u7684\u72b6\u6001\u4ece -1 \u6539\u4e3a 0 \u5e76\u5524\u9192\u4e0b\u4e00\u4e2a\u8282\u70b9\uff0c\u8fd9\u65f6 t3 \u5728 doAcquireShared \u5185 parkAndCheckInterrupt() \u5904\u6062\u590d\u8fd0\u884c\uff0c",(0,r.jsx)(e.strong,{children:"\u5524\u9192\u8fde\u7eed\u7684\u6240\u6709\u7684\u5171\u4eab\u8282\u70b9"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void setHeadAndPropagate(Node node, int propagate) {\n    Node h = head; \n    // \u8bbe\u7f6e\u81ea\u5df1\u4e3a head \u8282\u70b9\n    setHead(node);\n    // propagate \u8868\u793a\u6709\u5171\u4eab\u8d44\u6e90\uff08\u4f8b\u5982\u5171\u4eab\u8bfb\u9501\u6216\u4fe1\u53f7\u91cf\uff09\uff0c\u4e3a 0 \u5c31\u6ca1\u6709\u8d44\u6e90\n    if (propagate > 0 || h == null || h.waitStatus < 0 ||\n        (h = head) == null || h.waitStatus < 0) {\n        // \u83b7\u53d6\u4e0b\u4e00\u4e2a\u8282\u70b9\n        Node s = node.next;\n        // \u5982\u679c\u5f53\u524d\u662f\u6700\u540e\u4e00\u4e2a\u8282\u70b9\uff0c\u6216\u8005\u4e0b\u4e00\u4e2a\u8282\u70b9\u662f\u3010\u7b49\u5f85\u5171\u4eab\u8bfb\u9501\u7684\u8282\u70b9\u3011\n        if (s == null || s.isShared())\n            // \u5524\u9192\u540e\u7ee7\u8282\u70b9\n            doReleaseShared();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void doReleaseShared() {\n    // \u5982\u679c head.waitStatus == Node.SIGNAL ==> 0 \u6210\u529f, \u4e0b\u4e00\u4e2a\u8282\u70b9 unpark\n\t// \u5982\u679c head.waitStatus == 0 ==> Node.PROPAGATE\n    for (;;) {\n        Node h = head;\n        if (h != null && h != tail) {\n            int ws = h.waitStatus;\n            // SIGNAL \u5524\u9192\u540e\u7ee7\n            if (ws == Node.SIGNAL) {\n                // \u56e0\u4e3a\u8bfb\u9501\u5171\u4eab\uff0c\u5982\u679c\u5176\u5b83\u7ebf\u7a0b\u4e5f\u5728\u91ca\u653e\u8bfb\u9501\uff0c\u90a3\u4e48\u9700\u8981\u5c06 waitStatus \u5148\u6539\u4e3a 0\n            \t// \u9632\u6b62 unparkSuccessor \u88ab\u591a\u6b21\u6267\u884c\n                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))\n                    continue;  \n                // \u5524\u9192\u540e\u7ee7\u8282\u70b9\n                unparkSuccessor(h);\n            }\n            // \u5982\u679c\u5df2\u7ecf\u662f 0 \u4e86\uff0c\u6539\u4e3a -3\uff0c\u7528\u6765\u89e3\u51b3\u4f20\u64ad\u6027\n            else if (ws == 0 && !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))\n                continue;                \n        }\n        // \u6761\u4ef6\u4e0d\u6210\u7acb\u8bf4\u660e\u88ab\u5524\u9192\u7684\u8282\u70b9\u975e\u5e38\u79ef\u6781\uff0c\u76f4\u63a5\u5c06\u81ea\u5df1\u8bbe\u7f6e\u4e3a\u4e86\u65b0\u7684 head\uff0c\n        // \u6b64\u65f6\u5524\u9192\u5b83\u7684\u8282\u70b9\uff08\u524d\u9a71\uff09\u6267\u884c h == head \u4e0d\u6210\u7acb\uff0c\u6240\u4ee5\u4e0d\u4f1a\u8df3\u51fa\u5faa\u73af\uff0c\u4f1a\u7ee7\u7eed\u5524\u9192\u65b0\u7684 head \u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\n        if (h == head)                   \n            break;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(93053).A+"",width:"1000",height:"477"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4e0b\u4e00\u4e2a\u8282\u70b9\u4e0d\u662f shared \u4e86\uff0c\u56e0\u6b64\u4e0d\u4f1a\u7ee7\u7eed\u5524\u9192 t4 \u6240\u5728\u8282\u70b9"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"t2 \u8bfb\u9501\u89e3\u9501\uff0c\u8fdb\u5165 sync.releaseShared(1) \u4e2d\uff0c\u8c03\u7528 tryReleaseShared(1) \u8ba9\u8ba1\u6570\u51cf\u4e00\uff0c\u4f46\u8ba1\u6570\u8fd8\u4e0d\u4e3a\u96f6\uff0ct3 \u540c\u6837\u8ba9\u8ba1\u6570\u51cf\u4e00\uff0c\u8ba1\u6570\u4e3a\u96f6\uff0c\u8fdb\u5165doReleaseShared() \u5c06\u5934\u8282\u70b9\u4ece -1 \u6539\u4e3a 0 \u5e76\u5524\u9192\u4e0b\u4e00\u4e2a\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void unlock() {\n    sync.releaseShared(1);\n}\npublic final boolean releaseShared(int arg) {\n    if (tryReleaseShared(arg)) {\n        doReleaseShared();\n        return true;\n    }\n    return false;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected final boolean tryReleaseShared(int unused) {\n\n    for (;;) {\n        int c = getState();\n        int nextc = c - SHARED_UNIT;\n        // \u8bfb\u9501\u7684\u8ba1\u6570\u4e0d\u4f1a\u5f71\u54cd\u5176\u5b83\u83b7\u53d6\u8bfb\u9501\u7ebf\u7a0b, \u4f46\u4f1a\u5f71\u54cd\u5176\u5b83\u83b7\u53d6\u5199\u9501\u7ebf\u7a0b\uff0c\u8ba1\u6570\u4e3a 0 \u624d\u662f\u771f\u6b63\u91ca\u653e\n        if (compareAndSetState(c, nextc))\n            // \u8fd4\u56de\u662f\u5426\u5df2\u7ecf\u5b8c\u5168\u91ca\u653e\u4e86 \n            return nextc == 0;\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"t4 \u5728 acquireQueued \u4e2d parkAndCheckInterrupt \u5904\u6062\u590d\u8fd0\u884c\uff0c\u518d\u6b21 for (;;) \u8fd9\u6b21\u81ea\u5df1\u662f\u5934\u8282\u70b9\u7684\u4e34\u8282\u70b9\uff0c\u5e76\u4e14\u6ca1\u6709\u5176\u4ed6\u8282\u70b9\u7ade\u4e89\uff0ctryAcquire(1) \u6210\u529f\uff0c\u4fee\u6539\u5934\u7ed3\u70b9\uff0c\u6d41\u7a0b\u7ed3\u675f"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(95494).A+"",width:"1061",height:"430"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"stamped",children:"Stamped"}),"\n",(0,r.jsx)(e.p,{children:"StampedLock\uff1a\u8bfb\u5199\u9501\uff0c\u8be5\u7c7b\u81ea JDK 8 \u52a0\u5165\uff0c\u662f\u4e3a\u4e86\u8fdb\u4e00\u6b65\u4f18\u5316\u8bfb\u6027\u80fd"}),"\n",(0,r.jsx)(e.p,{children:"\u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5728\u4f7f\u7528\u8bfb\u9501\u3001\u5199\u9501\u65f6\u90fd\u5fc5\u987b\u914d\u5408\u6233\u4f7f\u7528"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"StampedLock \u4e0d\u652f\u6301\u6761\u4ef6\u53d8\u91cf"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["StampedLock ",(0,r.jsx)(e.strong,{children:"\u4e0d\u652f\u6301\u91cd\u5165"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u57fa\u672c\u7528\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u52a0\u89e3\u8bfb\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"long stamp = lock.readLock();\nlock.unlockRead(stamp);\t\t\t// \u7c7b\u4f3c\u4e8e unpark\uff0c\u89e3\u6307\u5b9a\u7684\u9501\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u52a0\u89e3\u5199\u9501\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"long stamp = lock.writeLock();\nlock.unlockWrite(stamp);\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4e50\u89c2\u8bfb\uff0cStampedLock \u652f\u6301 ",(0,r.jsx)(e.code,{children:"tryOptimisticRead()"})," \u65b9\u6cd5\uff0c\u8bfb\u53d6\u5b8c\u6bd5\u540e\u505a\u4e00\u6b21",(0,r.jsx)(e.strong,{children:"\u6233\u6821\u9a8c"}),"\uff0c\u5982\u679c\u6821\u9a8c\u901a\u8fc7\uff0c\u8868\u793a\u8fd9\u671f\u95f4\u6ca1\u6709\u5176\u4ed6\u7ebf\u7a0b\u7684\u5199\u64cd\u4f5c\uff0c\u6570\u636e\u53ef\u4ee5\u5b89\u5168\u4f7f\u7528\uff0c\u5982\u679c\u6821\u9a8c\u6ca1\u901a\u8fc7\uff0c\u9700\u8981\u91cd\u65b0\u83b7\u53d6\u8bfb\u9501\uff0c\u4fdd\u8bc1\u6570\u636e\u4e00\u81f4\u6027"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"long stamp = lock.tryOptimisticRead();\n// \u9a8c\u6233\nif(!lock.validate(stamp)){\n\t// \u9501\u5347\u7ea7\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u63d0\u4f9b\u4e00\u4e2a\u6570\u636e\u5bb9\u5668\u7c7b\u5185\u90e8\u5206\u522b\u4f7f\u7528\u8bfb\u9501\u4fdd\u62a4\u6570\u636e\u7684 read() \u65b9\u6cd5\uff0c\u5199\u9501\u4fdd\u62a4\u6570\u636e\u7684 write() \u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8bfb-\u8bfb\u53ef\u4ee5\u4f18\u5316"}),"\n",(0,r.jsx)(e.li,{children:"\u8bfb-\u5199\u4f18\u5316\u8bfb\uff0c\u8865\u52a0\u8bfb\u9501"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) throws InterruptedException {\n    DataContainerStamped dataContainer = new DataContainerStamped(1);\n    new Thread(() -> {\n    \tdataContainer.read(1000);\n    },"t1").start();\n    Thread.sleep(500);\n    \n    new Thread(() -> {\n        dataContainer.write(1000);\n    },"t2").start();\n}\n\nclass DataContainerStamped {\n    private int data;\n    private final StampedLock lock = new StampedLock();\n\n    public int read(int readTime) throws InterruptedException {\n        long stamp = lock.tryOptimisticRead();\n        System.out.println(new Date() + " optimistic read locking" + stamp);\n        Thread.sleep(readTime);\n        // \u6233\u6709\u6548\uff0c\u76f4\u63a5\u8fd4\u56de\u6570\u636e\n        if (lock.validate(stamp)) {\n            Sout(new Date() + " optimistic read finish..." + stamp);\n            return data;\n        }\n\n        // \u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u66f4\u6539\u4e86\u6233\uff0c\u9700\u8981\u9501\u5347\u7ea7\u4e86\uff0c\u4ece\u4e50\u89c2\u8bfb\u5347\u7ea7\u5230\u8bfb\u9501\n        System.out.println(new Date() + " updating to read lock" + stamp);\n        try {\n            stamp = lock.readLock();\n            System.out.println(new Date() + " read lock" + stamp);\n            Thread.sleep(readTime);\n            System.out.println(new Date() + " read finish..." + stamp);\n            return data;\n        } finally {\n            System.out.println(new Date() + " read unlock " +  stamp);\n            lock.unlockRead(stamp);\n        }\n    }\n\n    public void write(int newData) {\n        long stamp = lock.writeLock();\n        System.out.println(new Date() + " write lock " + stamp);\n        try {\n            Thread.sleep(2000);\n            this.data = newData;\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } finally {\n            System.out.println(new Date() + " write unlock " + stamp);\n            lock.unlockWrite(stamp);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"countdown",children:"CountDown"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4f7f\u7528-7",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsxs)(e.p,{children:["CountDownLatch\uff1a\u8ba1\u6570\u5668\uff0c\u7528\u6765\u8fdb\u884c\u7ebf\u7a0b\u540c\u6b65\u534f\u4f5c\uff0c",(0,r.jsx)(e.strong,{children:"\u7b49\u5f85\u6240\u6709\u7ebf\u7a0b\u5b8c\u6210"})]}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u5668\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public CountDownLatch(int count)"}),"\uff1a\u521d\u59cb\u5316\u5524\u9192\u9700\u8981\u7684 down \u51e0\u6b65"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void await() "}),"\uff1a\u8ba9\u5f53\u524d\u7ebf\u7a0b\u7b49\u5f85\uff0c\u5fc5\u987b down \u5b8c\u521d\u59cb\u5316\u7684\u6570\u5b57\u624d\u53ef\u4ee5\u88ab\u5524\u9192\uff0c\u5426\u5219\u8fdb\u5165\u65e0\u9650\u7b49\u5f85"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void countDown()"}),"\uff1a\u8ba1\u6570\u5668\u8fdb\u884c\u51cf 1\uff08down 1\uff09"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\uff1a\u540c\u6b65\u7b49\u5f85\u591a\u4e2a Rest \u8fdc\u7a0b\u8c03\u7528\u7ed3\u675f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// LOL 10\u4eba\u8fdb\u5165\u6e38\u620f\u5012\u8ba1\u65f6\npublic static void main(String[] args) throws InterruptedException {\n    CountDownLatch latch = new CountDownLatch(10);\n    ExecutorService service = Executors.newFixedThreadPool(10);\n    String[] all = new String[10];\n    Random random = new Random();\n\n    for (int j = 0; j < 10; j++) {\n        int finalJ = j;//\u5e38\u91cf\n        service.submit(() -> {\n            for (int i = 0; i <= 100; i++) {\n                Thread.sleep(random.nextInt(100));\t//\u968f\u673a\u4f11\u7720\n                all[finalJ] = i + "%";\n                System.out.print("\\r" + Arrays.toString(all));\t// \\r\u4ee3\u8868\u8986\u76d6\n            }\n            latch.countDown();\n        });\n    }\n    latch.await();\n    System.out.println("\\n\u6e38\u620f\u5f00\u59cb");\n    service.shutdown();\n}\n/*\n[100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%]\n\u6e38\u620f\u5f00\u59cb\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b9e\u73b0\u539f\u7406-6",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"\u963b\u585e\u7b49\u5f85\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u8c03\u7528 await() \u7b49\u5f85\u5176\u4ed6\u7ebf\u7a0b\u5b8c\u6210\u4efb\u52a1\uff1a\u652f\u6301\u6253\u65ad"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void await() throws InterruptedException {\n    sync.acquireSharedInterruptibly(1);\n}\n// AbstractQueuedSynchronizer#acquireSharedInterruptibly\npublic final void acquireSharedInterruptibly(int arg) throws InterruptedException {\n    // \u5224\u65ad\u7ebf\u7a0b\u662f\u5426\u88ab\u6253\u65ad\uff0c\u629b\u51fa\u6253\u65ad\u5f02\u5e38\n    if (Thread.interrupted())\n        throw new InterruptedException();\n    // \u5c1d\u8bd5\u83b7\u53d6\u5171\u4eab\u9501\uff0c\u6761\u4ef6\u6210\u7acb\u8bf4\u660e state > 0\uff0c\u6b64\u65f6\u7ebf\u7a0b\u5165\u961f\u963b\u585e\u7b49\u5f85\uff0c\u7b49\u5f85\u5176\u4ed6\u7ebf\u7a0b\u83b7\u53d6\u5171\u4eab\u8d44\u6e90\n    // \u6761\u4ef6\u4e0d\u6210\u7acb\u8bf4\u660e state = 0\uff0c\u6b64\u65f6\u4e0d\u9700\u8981\u963b\u585e\u7ebf\u7a0b\uff0c\u76f4\u63a5\u7ed3\u675f\u51fd\u6570\u8c03\u7528\n    if (tryAcquireShared(arg) < 0)\n        doAcquireSharedInterruptibly(arg);\n}\n// CountDownLatch.Sync#tryAcquireShared\nprotected int tryAcquireShared(int acquires) {\n    return (getState() == 0) ? 1 : -1;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u8fdb\u5165 AbstractQueuedSynchronizer#doAcquireSharedInterruptibly \u51fd\u6570\u963b\u585e\u6302\u8d77\uff0c\u7b49\u5f85 latch \u53d8\u4e3a 0\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void doAcquireSharedInterruptibly(int arg) throws InterruptedException {\n    // \u5c06\u8c03\u7528latch.await()\u65b9\u6cd5\u7684\u7ebf\u7a0b \u5305\u88c5\u6210 SHARED \u7c7b\u578b\u7684 node \u52a0\u5165\u5230 AQS \u7684\u963b\u585e\u961f\u5217\u4e2d\n    final Node node = addWaiter(Node.SHARED);\n    boolean failed = true;\n    try {\n        for (;;) {\n            // \u83b7\u53d6\u5f53\u524d\u8282\u70b9\u7684\u524d\u9a71\u8282\u70b9\n            final Node p = node.predecessor();\n            // \u524d\u9a71\u8282\u70b9\u65f6\u5934\u8282\u70b9\u5c31\u53ef\u4ee5\u5c1d\u8bd5\u83b7\u53d6\u9501\n            if (p == head) {\n                // \u518d\u6b21\u5c1d\u8bd5\u83b7\u53d6\u9501\uff0c\u83b7\u53d6\u6210\u529f\u8fd4\u56de 1\n                int r = tryAcquireShared(arg);\n                if (r >= 0) {\n                    // \u83b7\u53d6\u9501\u6210\u529f\uff0c\u8bbe\u7f6e\u5f53\u524d\u8282\u70b9\u4e3a head \u8282\u70b9\uff0c\u5e76\u4e14\u5411\u540e\u4f20\u64ad\n                    setHeadAndPropagate(node, r);\n                    p.next = null; // help GC\n                    failed = false;\n                    return;\n                }\n            }\n            // \u963b\u585e\u5728\u8fd9\u91cc\n            if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\n                throw new InterruptedException();\n        }\n    } finally {\n        // \u963b\u585e\u7ebf\u7a0b\u88ab\u4e2d\u65ad\u540e\u629b\u51fa\u5f02\u5e38\uff0c\u8fdb\u5165\u53d6\u6d88\u8282\u70b9\u7684\u903b\u8f91\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u5171\u4eab\u9501\u6210\u529f\uff0c\u8fdb\u5165\u5524\u9192\u963b\u585e\u961f\u5217\u4e2d\u4e0e\u5934\u8282\u70b9\u76f8\u8fde\u7684 SHARED \u6a21\u5f0f\u7684\u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void setHeadAndPropagate(Node node, int propagate) {\n    Node h = head;\n    // \u5c06\u5f53\u524d\u8282\u70b9\u8bbe\u7f6e\u4e3a\u65b0\u7684 head \u8282\u70b9\uff0c\u524d\u9a71\u8282\u70b9\u548c\u6301\u6709\u7ebf\u7a0b\u7f6e\u4e3a null\n    setHead(node);\n\t// propagate = 1\uff0c\u6761\u4ef6\u4e00\u6210\u7acb\n    if (propagate > 0 || h == null || h.waitStatus < 0 || (h = head) == null || h.waitStatus < 0) {\n        // \u83b7\u53d6\u5f53\u524d\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\n        Node s = node.next;\n        // \u5f53\u524d\u8282\u70b9\u662f\u5c3e\u8282\u70b9\u65f6 next \u4e3a null\uff0c\u6216\u8005\u540e\u7ee7\u8282\u70b9\u662f SHARED \u5171\u4eab\u6a21\u5f0f\n        if (s == null || s.isShared())\n            // \u5524\u9192\u6240\u6709\u7684\u7b49\u5f85\u5171\u4eab\u9501\u7684\u8282\u70b9\n            doReleaseShared();\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u8ba1\u6570\u51cf\u4e00\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u8fdb\u5165 countDown() \u5b8c\u6210\u8ba1\u6570\u5668\u51cf\u4e00\uff08\u91ca\u653e\u9501\uff09\u7684\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void countDown() {\n    sync.releaseShared(1);\n}\npublic final boolean releaseShared(int arg) {\n    // \u5c1d\u8bd5\u91ca\u653e\u5171\u4eab\u9501\n    if (tryReleaseShared(arg)) {\n        // \u91ca\u653e\u9501\u6210\u529f\u5f00\u59cb\u5524\u9192\u963b\u585e\u8282\u70b9\n        doReleaseShared();\n        return true;\n    }\n    return false;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u66f4\u65b0 state \u503c\uff0c\u6bcf\u8c03\u7528\u4e00\u6b21\uff0cstate \u503c\u51cf\u4e00\uff0c\u5f53 state -1 \u6b63\u597d\u4e3a 0 \u65f6\uff0c\u8fd4\u56de true"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected boolean tryReleaseShared(int releases) {\n    for (;;) {\n        int c = getState();\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u524d\u9762\u3010\u5df2\u7ecf\u6709\u7ebf\u7a0b\u89e6\u53d1\u5524\u9192\u64cd\u4f5c\u3011\u4e86\uff0c\u8fd9\u91cc\u8fd4\u56de false\n        if (c == 0)\n            return false;\n        // \u8ba1\u6570\u5668\u51cf\u4e00\n        int nextc = c-1;\n        if (compareAndSetState(c, nextc))\n            // \u8ba1\u6570\u5668\u4e3a 0 \u65f6\u8fd4\u56de true\n            return nextc == 0;\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["state = 0 \u65f6\uff0c\u5f53\u524d\u7ebf\u7a0b\u9700\u8981\u6267\u884c",(0,r.jsx)(e.strong,{children:"\u5524\u9192\u963b\u585e\u8282\u70b9\u7684\u4efb\u52a1"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void doReleaseShared() {\n    for (;;) {\n        Node h = head;\n        // \u5224\u65ad\u961f\u5217\u662f\u5426\u662f\u7a7a\u961f\u5217\n        if (h != null && h != tail) {\n            int ws = h.waitStatus;\n            // \u5934\u8282\u70b9\u7684\u72b6\u6001\u4e3a signal\uff0c\u8bf4\u660e\u540e\u7ee7\u8282\u70b9\u6ca1\u6709\u88ab\u5524\u9192\u8fc7\n            if (ws == Node.SIGNAL) {\n                // cas \u8bbe\u7f6e\u5934\u8282\u70b9\u7684\u72b6\u6001\u4e3a 0\uff0c\u8bbe\u7f6e\u5931\u8d25\u7ee7\u7eed\u81ea\u65cb\n                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))\n                    continue;\n                // \u5524\u9192\u540e\u7ee7\u8282\u70b9\n                unparkSuccessor(h);\n            }\n            // \u5982\u679c\u6709\u5176\u4ed6\u7ebf\u7a0b\u5df2\u7ecf\u8bbe\u7f6e\u4e86\u5934\u8282\u70b9\u7684\u72b6\u6001\uff0c\u91cd\u65b0\u8bbe\u7f6e\u4e3a PROPAGATE \u4f20\u64ad\u5c5e\u6027\n            else if (ws == 0 && !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))\n                continue;\n        }\n        // \u6761\u4ef6\u4e0d\u6210\u7acb\u8bf4\u660e\u88ab\u5524\u9192\u7684\u8282\u70b9\u975e\u5e38\u79ef\u6781\uff0c\u76f4\u63a5\u5c06\u81ea\u5df1\u8bbe\u7f6e\u4e3a\u4e86\u65b0\u7684head\uff0c\n        // \u6b64\u65f6\u5524\u9192\u5b83\u7684\u8282\u70b9\uff08\u524d\u9a71\uff09\u6267\u884c h == head \u4e0d\u6210\u7acb\uff0c\u6240\u4ee5\u4e0d\u4f1a\u8df3\u51fa\u5faa\u73af\uff0c\u4f1a\u7ee7\u7eed\u5524\u9192\u65b0\u7684 head \u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\n        if (h == head)\n            break;\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"cyclicbarrier",children:"CyclicBarrier"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4f7f\u7528-8",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsx)(e.p,{children:"CyclicBarrier\uff1a\u5faa\u73af\u5c4f\u969c\uff0c\u7528\u6765\u8fdb\u884c\u7ebf\u7a0b\u534f\u4f5c\uff0c\u7b49\u5f85\u7ebf\u7a0b\u6ee1\u8db3\u67d0\u4e2a\u8ba1\u6570\uff0c\u624d\u80fd\u89e6\u53d1\u81ea\u5df1\u6267\u884c"}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public CyclicBarrier(int parties, Runnable barrierAction)"}),"\uff1a\u7528\u4e8e\u5728\u7ebf\u7a0b\u5230\u8fbe\u5c4f\u969c parties \u65f6\uff0c\u6267\u884c barrierAction\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"parties\uff1a\u4ee3\u8868\u591a\u5c11\u4e2a\u7ebf\u7a0b\u5230\u8fbe\u5c4f\u969c\u5f00\u59cb\u89e6\u53d1\u7ebf\u7a0b\u4efb\u52a1"}),"\n",(0,r.jsx)(e.li,{children:"barrierAction\uff1a\u7ebf\u7a0b\u4efb\u52a1"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public int await()"}),"\uff1a\u7ebf\u7a0b\u8c03\u7528 await \u65b9\u6cd5\u901a\u77e5 CyclicBarrier \u672c\u7ebf\u7a0b\u5df2\u7ecf\u5230\u8fbe\u5c4f\u969c"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e0e CountDownLatch \u7684\u533a\u522b\uff1aCyclicBarrier \u662f\u53ef\u4ee5\u91cd\u7528\u7684"}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\uff1a\u53ef\u4ee5\u5b9e\u73b0\u591a\u7ebf\u7a0b\u4e2d\uff0c\u67d0\u4e2a\u4efb\u52a1\u5728\u7b49\u5f85\u5176\u4ed6\u7ebf\u7a0b\u6267\u884c\u5b8c\u6bd5\u4ee5\u540e\u89e6\u53d1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ExecutorService service = Executors.newFixedThreadPool(2);\n    CyclicBarrier barrier = new CyclicBarrier(2, () -> {\n        System.out.println("task1 task2 finish...");\n    });\n\n    for (int i = 0; i < 3; i++) { // \u5faa\u73af\u91cd\u7528\n        service.submit(() -> {\n            System.out.println("task1 begin...");\n            try {\n                Thread.sleep(1000);\n                barrier.await();    // 2 - 1 = 1\n            } catch (InterruptedException | BrokenBarrierException e) {\n                e.printStackTrace();\n            }\n        });\n\n        service.submit(() -> {\n            System.out.println("task2 begin...");\n            try {\n                Thread.sleep(2000);\n                barrier.await();    // 1 - 1 = 0\n            } catch (InterruptedException | BrokenBarrierException e) {\n                e.printStackTrace();\n            }\n        });\n    }\n    service.shutdown();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b9e\u73b0\u539f\u7406-7",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u5c5e\u6027-6",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5168\u5c40\u9501\uff1a\u5229\u7528\u53ef\u91cd\u5165\u9501\u5b9e\u73b0\u7684\u5de5\u5177\u7c7b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// barrier \u5b9e\u73b0\u662f\u4f9d\u8d56\u4e8eCondition\u6761\u4ef6\u961f\u5217\uff0ccondition \u6761\u4ef6\u961f\u5217\u5fc5\u987b\u4f9d\u8d56lock\u624d\u80fd\u4f7f\u7528\nprivate final ReentrantLock lock = new ReentrantLock();\n// \u7ebf\u7a0b\u6302\u8d77\u5b9e\u73b0\u4f7f\u7528\u7684 condition \u961f\u5217\uff0c\u5f53\u524d\u4ee3\u6240\u6709\u7ebf\u7a0b\u5230\u4f4d\uff0c\u8fd9\u4e2a\u6761\u4ef6\u961f\u5217\u5185\u7684\u7ebf\u7a0b\u624d\u4f1a\u88ab\u5524\u9192\nprivate final Condition trip = lock.newCondition();\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u6570\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final int parties;\t// \u4ee3\u8868\u591a\u5c11\u4e2a\u7ebf\u7a0b\u5230\u8fbe\u5c4f\u969c\u5f00\u59cb\u89e6\u53d1\u7ebf\u7a0b\u4efb\u52a1\nprivate int count;\t\t\t// \u8868\u793a\u5f53\u524d\u201c\u4ee3\u201d\u8fd8\u6709\u591a\u5c11\u4e2a\u7ebf\u7a0b\u672a\u5230\u4f4d\uff0c\u521d\u59cb\u503c\u4e3a parties\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f53\u524d\u4ee3\u4e2d\u6700\u540e\u4e00\u4e2a\u7ebf\u7a0b\u5230\u4f4d\u540e\u8981\u6267\u884c\u7684\u4e8b\u4ef6\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final Runnable barrierCommand;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4ee3\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8868\u793a barrier \u5bf9\u8c61\u5f53\u524d \u4ee3\nprivate Generation generation = new Generation();\nprivate static class Generation {\n    // \u8868\u793a\u5f53\u524d\u201c\u4ee3\u201d\u662f\u5426\u88ab\u6253\u7834\uff0c\u5982\u679c\u88ab\u6253\u7834\u518d\u6765\u5230\u8fd9\u4e00\u4ee3\u7684\u7ebf\u7a0b \u5c31\u4f1a\u76f4\u63a5\u629b\u51fa BrokenException \u5f02\u5e38\n    // \u4e14\u5728\u8fd9\u4e00\u4ee3\u6302\u8d77\u7684\u7ebf\u7a0b\u90fd\u4f1a\u88ab\u5524\u9192\uff0c\u7136\u540e\u629b\u51fa BrokerException \u5f02\u5e38\u3002\n    boolean broken = false;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public CyclicBarrie(int parties, Runnable barrierAction) {\n    // \u56e0\u4e3a\u5c0f\u4e8e\u7b49\u4e8e 0 \u7684 barrier \u6ca1\u6709\u4efb\u4f55\u610f\u4e49\n    if (parties <= 0) throw new IllegalArgumentException();\n\n    this.parties = parties;\n    this.count = parties;\n    // \u53ef\u4ee5\u4e3a null\n    this.barrierCommand = barrierAction;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(90757).A+"",width:"1044",height:"574"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6210\u5458\u65b9\u6cd5-5",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"await()\uff1a\u963b\u585e\u7b49\u5f85\u6240\u6709\u7ebf\u7a0b\u5230\u4f4d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public int await() throws InterruptedException, BrokenBarrierException {\n    try {\n        return dowait(false, 0L);\n    } catch (TimeoutException toe) {\n        throw new Error(toe); // cannot happen\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// timed\uff1a\u8868\u793a\u5f53\u524d\u8c03\u7528await\u65b9\u6cd5\u7684\u7ebf\u7a0b\u662f\u5426\u6307\u5b9a\u4e86\u8d85\u65f6\u65f6\u957f\uff0c\u5982\u679c true \u8868\u793a\u7ebf\u7a0b\u662f\u54cd\u5e94\u8d85\u65f6\u7684\n// nanos\uff1a\u7ebf\u7a0b\u7b49\u5f85\u8d85\u65f6\u65f6\u957f\uff0c\u5355\u4f4d\u662f\u7eb3\u79d2\nprivate int dowait(boolean timed, long nanos) {\n    final ReentrantLock lock = this.lock;\n    // \u52a0\u9501\n    lock.lock();\n    try {\n        // \u83b7\u53d6\u5f53\u524d\u4ee3\n        final Generation g = generation;\n\n        // \u3010\u5982\u679c\u5f53\u524d\u4ee3\u662f\u5df2\u7ecf\u88ab\u6253\u7834\u72b6\u6001\uff0c\u5219\u5f53\u524d\u8c03\u7528await\u65b9\u6cd5\u7684\u7ebf\u7a0b\uff0c\u76f4\u63a5\u629b\u51faBroken\u5f02\u5e38\u3011\n        if (g.broken)\n            throw new BrokenBarrierException();\n\t\t// \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u88ab\u4e2d\u65ad\u4e86\uff0c\u5219\u6253\u7834\u5f53\u524d\u4ee3\uff0c\u7136\u540e\u5f53\u524d\u7ebf\u7a0b\u629b\u51fa\u4e2d\u65ad\u5f02\u5e38\n        if (Thread.interrupted()) {\n            // \u8bbe\u7f6e\u5f53\u524d\u4ee3\u7684\u72b6\u6001\u4e3a broken \u72b6\u6001\uff0c\u5524\u9192\u5728 trip \u6761\u4ef6\u961f\u5217\u5185\u7684\u7ebf\u7a0b\n            breakBarrier();\n            throw new InterruptedException();\n        }\n\n        // \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\uff0c\u5f53\u524d\u7ebf\u7a0b\u4e2d\u65ad\u72b6\u6001\u662f false\uff0c \u5f53\u524d\u4ee3\u7684 broken \u4e3a false\uff08\u672a\u6253\u7834\u72b6\u6001\uff09\n        \n        // \u5047\u8bbe parties \u7ed9\u7684\u662f 5\uff0c\u90a3\u4e48index\u5bf9\u5e94\u7684\u503c\u4e3a 4,3,2,1,0\n        int index = --count;\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u662f\u6700\u540e\u4e00\u4e2a\u5230\u8fbe barrier \u7684\u7ebf\u7a0b\uff0c\u3010\u9700\u8981\u5f00\u542f\u65b0\u4ee3\uff0c\u5524\u9192\u963b\u585e\u7ebf\u7a0b\u3011\n        if (index == 0) {\n            // \u6805\u680f\u4efb\u52a1\u542f\u52a8\u6807\u8bb0\n            boolean ranAction = false;\n            try {\n                final Runnable command = barrierCommand;\n                if (command != null)\n                    // \u542f\u52a8\u89e6\u53d1\u7684\u4efb\u52a1\n                    command.run();\n                // run()\u672a\u629b\u51fa\u5f02\u5e38\u7684\u8bdd\uff0c\u542f\u52a8\u6807\u8bb0\u8bbe\u7f6e\u4e3a true\n                ranAction = true;\n                // \u5f00\u542f\u65b0\u7684\u4e00\u4ee3\uff0c\u8fd9\u91cc\u4f1a\u3010\u5524\u9192\u6240\u6709\u7684\u963b\u585e\u961f\u5217\u3011\n                nextGeneration();\n                // \u8fd4\u56de 0 \u56e0\u4e3a\u5f53\u524d\u7ebf\u7a0b\u662f\u6b64\u4ee3\u6700\u540e\u4e00\u4e2a\u5230\u8fbe\u7684\u7ebf\u7a0b\uff0cindex == 0\n                return 0;\n            } finally {\n                // \u5982\u679c command.run() \u6267\u884c\u629b\u51fa\u5f02\u5e38\u7684\u8bdd\uff0c\u4f1a\u8fdb\u5165\u5230\u8fd9\u91cc\n                if (!ranAction)\n                    breakBarrier();\n            }\n        }\n\n        // \u81ea\u65cb\uff0c\u4e00\u76f4\u5230\u6761\u4ef6\u6ee1\u8db3\u3001\u5f53\u524d\u4ee3\u88ab\u6253\u7834\u3001\u7ebf\u7a0b\u88ab\u4e2d\u65ad\uff0c\u7b49\u5f85\u8d85\u65f6\n        for (;;) {\n            try {\n                // \u6839\u636e\u662f\u5426\u9700\u8981\u8d85\u65f6\u7b49\u5f85\u9009\u62e9\u963b\u585e\u65b9\u6cd5\n                if (!timed)\n                    // \u5f53\u524d\u7ebf\u7a0b\u91ca\u653e\u6389 lock\uff0c\u3010\u8fdb\u5165\u5230 trip \u6761\u4ef6\u961f\u5217\u7684\u5c3e\u90e8\u6302\u8d77\u81ea\u5df1\u3011\uff0c\u7b49\u5f85\u88ab\u5524\u9192\n                    trip.await();\n                else if (nanos > 0L)\n                    nanos = trip.awaitNanos(nanos);\n            } catch (InterruptedException ie) {\n                // \u88ab\u4e2d\u65ad\u540e\u6765\u5230\u8fd9\u91cc\u7684\u903b\u8f91\n                \n                // \u5f53\u524d\u4ee3\u6ca1\u6709\u53d8\u5316\u5e76\u4e14\u6ca1\u6709\u88ab\u6253\u7834\n                if (g == generation && !g.broken) {\n                    // \u6253\u7834\u5c4f\u969c\n                    breakBarrier();\n                    // node \u8282\u70b9\u5728\u3010\u6761\u4ef6\u961f\u5217\u3011\u5185\u6536\u5230\u4e2d\u65ad\u4fe1\u53f7\u65f6 \u4f1a\u629b\u51fa\u4e2d\u65ad\u5f02\u5e38\n                    throw ie;\n                } else {\n                    // \u7b49\u5f85\u8fc7\u7a0b\u4e2d\u4ee3\u53d8\u5316\u4e86\uff0c\u5b8c\u6210\u4e00\u6b21\u81ea\u6211\u6253\u65ad\n                    Thread.currentThread().interrupt();\n                }\n            }\n\t\t\t// \u5524\u9192\u540e\u7684\u7ebf\u7a0b\uff0c\u3010\u5224\u65ad\u5f53\u524d\u4ee3\u5df2\u7ecf\u88ab\u6253\u7834\uff0c\u7ebf\u7a0b\u5524\u9192\u540e\u4f9d\u6b21\u629b\u51fa BrokenBarrier \u5f02\u5e38\u3011\n            if (g.broken)\n                throw new BrokenBarrierException();\n\n            // \u5f53\u524d\u7ebf\u7a0b\u6302\u8d77\u671f\u95f4\uff0c\u6700\u540e\u4e00\u4e2a\u7ebf\u7a0b\u5230\u4f4d\u4e86\uff0c\u7136\u540e\u89e6\u53d1\u4e86\u5f00\u542f\u65b0\u7684\u4e00\u4ee3\u7684\u903b\u8f91\n            if (g != generation)\n                return index;\n\t\t\t// \u5f53\u524d\u7ebf\u7a0b trip \u4e2d\u7b49\u5f85\u8d85\u65f6\uff0c\u7136\u540e\u4e3b\u52a8\u8f6c\u79fb\u5230\u963b\u585e\u961f\u5217\n            if (timed && nanos <= 0L) {\n                breakBarrier();\n                // \u629b\u51fa\u8d85\u65f6\u5f02\u5e38\n                throw new TimeoutException();\n            }\n        }\n    } finally {\n        // \u89e3\u9501\n        lock.unlock();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"breakBarrier()\uff1a\u6253\u7834 Barrier \u5c4f\u969c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void breakBarrier() {\n    // \u5c06\u4ee3\u4e2d\u7684 broken \u8bbe\u7f6e\u4e3a true\uff0c\u8868\u793a\u8fd9\u4e00\u4ee3\u662f\u88ab\u6253\u7834\u4e86\uff0c\u518d\u6765\u5230\u8fd9\u4e00\u4ee3\u7684\u7ebf\u7a0b\uff0c\u76f4\u63a5\u629b\u51fa\u5f02\u5e38\n    generation.broken = true;\n    // \u91cd\u7f6e count \u4e3a parties\n    count = parties;\n    // \u5c06\u5728trip\u6761\u4ef6\u961f\u5217\u5185\u6302\u8d77\u7684\u7ebf\u7a0b\u5168\u90e8\u5524\u9192\uff0c\u5524\u9192\u540e\u7684\u7ebf\u7a0b\u4f1a\u68c0\u67e5\u5f53\u524d\u662f\u5426\u662f\u6253\u7834\u7684\uff0c\u7136\u540e\u629b\u51fa\u5f02\u5e38\n    trip.signalAll();\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"nextGeneration()\uff1a\u5f00\u542f\u65b0\u7684\u4e0b\u4e00\u4ee3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void nextGeneration() {\n    // \u5c06\u5728 trip \u6761\u4ef6\u961f\u5217\u5185\u6302\u8d77\u7684\u7ebf\u7a0b\u5168\u90e8\u5524\u9192\n    trip.signalAll();\n    // \u91cd\u7f6e count \u4e3a parties\n    count = parties;\n\n    // \u5f00\u542f\u65b0\u7684\u4e00\u4ee3\uff0c\u4f7f\u7528\u4e00\u4e2a\u65b0\u7684generation\u5bf9\u8c61\uff0c\u8868\u793a\u65b0\u7684\u4e00\u4ee3\uff0c\u65b0\u7684\u4e00\u4ee3\u548c\u4e0a\u4e00\u4ee3\u3010\u6ca1\u6709\u4efb\u4f55\u5173\u7cfb\u3011\n    generation = new Generation();\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://space.bilibili.com/457326371/",children:"https://space.bilibili.com/457326371/"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"semaphore",children:"Semaphore"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4f7f\u7528-9",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,r.jsx)(e.p,{children:"synchronized \u53ef\u4ee5\u8d77\u5230\u9501\u7684\u4f5c\u7528\uff0c\u4f46\u67d0\u4e2a\u65f6\u95f4\u6bb5\u5185\uff0c\u53ea\u80fd\u6709\u4e00\u4e2a\u7ebf\u7a0b\u5141\u8bb8\u6267\u884c"}),"\n",(0,r.jsx)(e.p,{children:"Semaphore\uff08\u4fe1\u53f7\u91cf\uff09\u7528\u6765\u9650\u5236\u80fd\u540c\u65f6\u8bbf\u95ee\u5171\u4eab\u8d44\u6e90\u7684\u7ebf\u7a0b\u4e0a\u9650\uff0c\u975e\u91cd\u5165\u9501"}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public Semaphore(int permits)"}),"\uff1apermits \u8868\u793a\u8bb8\u53ef\u7ebf\u7a0b\u7684\u6570\u91cf\uff08state\uff09"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public Semaphore(int permits, boolean fair)"}),"\uff1afair \u8868\u793a\u516c\u5e73\u6027\uff0c\u5982\u679c\u8bbe\u4e3a true\uff0c\u4e0b\u6b21\u6267\u884c\u7684\u7ebf\u7a0b\u4f1a\u662f\u7b49\u5f85\u6700\u4e45\u7684\u7ebf\u7a0b"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void acquire()"}),"\uff1a\u8868\u793a\u83b7\u53d6\u8bb8\u53ef"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void release()"}),"\uff1a\u8868\u793a\u91ca\u653e\u8bb8\u53ef\uff0cacquire() \u548c release() \u65b9\u6cd5\u4e4b\u95f4\u7684\u4ee3\u7801\u4e3a\u540c\u6b65\u4ee3\u7801"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    // 1.\u521b\u5efaSemaphore\u5bf9\u8c61\n    Semaphore semaphore = new Semaphore(3);\n\n    // 2. 10\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8fd0\u884c\n    for (int i = 0; i < 10; i++) {\n        new Thread(() -> {\n            try {\n                // 3. \u83b7\u53d6\u8bb8\u53ef\n                semaphore.acquire();\n                sout(Thread.currentThread().getName() + " running...");\n                Thread.sleep(1000);\n                sout(Thread.currentThread().getName() + " end...");\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            } finally {\n                // 4. \u91ca\u653e\u8bb8\u53ef\n                semaphore.release();\n            }\n        }).start();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b9e\u73b0\u539f\u7406-8",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"\u52a0\u9501\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Semaphore \u7684 permits\uff08state\uff09\u4e3a 3\uff0c\u8fd9\u65f6 5 \u4e2a\u7ebf\u7a0b\u6765\u83b7\u53d6\u8d44\u6e90"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"Sync(int permits) {\n    setState(permits);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5047\u8bbe\u5176\u4e2d Thread-1\uff0cThread-2\uff0cThread-4 CAS \u7ade\u4e89\u6210\u529f\uff0cpermits \u53d8\u4e3a 0\uff0c\u800c Thread-0 \u548c Thread-3 \u7ade\u4e89\u5931\u8d25\uff0c\u8fdb\u5165 AQS \u961f\u5217park \u963b\u585e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// acquire() -> sync.acquireSharedInterruptibly(1)\uff0c\u53ef\u4e2d\u65ad\npublic final void acquireSharedInterruptibly(int arg) {\n    if (Thread.interrupted())\n        throw new InterruptedException();\n    // \u5c1d\u8bd5\u83b7\u53d6\u901a\u884c\u8bc1\uff0c\u83b7\u53d6\u6210\u529f\u8fd4\u56de >= 0\u7684\u503c\n    if (tryAcquireShared(arg) < 0)\n        // \u83b7\u53d6\u8bb8\u53ef\u8bc1\u5931\u8d25\uff0c\u8fdb\u5165\u963b\u585e\n        doAcquireSharedInterruptibly(arg);\n}\n\n// tryAcquireShared() -> nonfairTryAcquireShared()\n// \u975e\u516c\u5e73\uff0c\u516c\u5e73\u9501\u4f1a\u5728\u5faa\u73af\u5185 hasQueuedPredecessors()\u65b9\u6cd5\u5224\u65ad\u963b\u585e\u961f\u5217\u662f\u5426\u6709\u4e34\u5934\u8282\u70b9(\u7b2c\u4e8c\u4e2a\u8282\u70b9)\nfinal int nonfairTryAcquireShared(int acquires) {\n    for (;;) {\n        // \u83b7\u53d6 state \uff0cstate \u8fd9\u91cc\u3010\u8868\u793a\u901a\u884c\u8bc1\u3011\n        int available = getState();\n        // \u8ba1\u7b97\u5f53\u524d\u7ebf\u7a0b\u83b7\u53d6\u901a\u884c\u8bc1\u5b8c\u6210\u4e4b\u540e\uff0c\u901a\u884c\u8bc1\u8fd8\u5269\u4f59\u6570\u91cf\n        int remaining = available - acquires;\n        // \u5982\u679c\u8bb8\u53ef\u5df2\u7ecf\u7528\u5b8c, \u8fd4\u56de\u8d1f\u6570, \u8868\u793a\u83b7\u53d6\u5931\u8d25,\n        if (remaining < 0 ||\n            // \u8bb8\u53ef\u8bc1\u8db3\u591f\u5206\u914d\u7684\uff0c\u5982\u679c cas \u91cd\u8bd5\u6210\u529f, \u8fd4\u56de\u6b63\u6570, \u8868\u793a\u83b7\u53d6\u6210\u529f\n            compareAndSetState(available, remaining))\n            return remaining;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void doAcquireSharedInterruptibly(int arg) {\n    // \u5c06\u8c03\u7528 Semaphore.aquire \u65b9\u6cd5\u7684\u7ebf\u7a0b\uff0c\u5305\u88c5\u6210 node \u52a0\u5165\u5230 AQS \u7684\u963b\u585e\u961f\u5217\u4e2d\n    final Node node = addWaiter(Node.SHARED);\n    // \u83b7\u53d6\u6807\u8bb0\n    boolean failed = true;\n    try {\n        for (;;) {\n            final Node p = node.predecessor();\n            // \u524d\u9a71\u8282\u70b9\u662f\u5934\u8282\u70b9\u53ef\u4ee5\u518d\u6b21\u83b7\u53d6\u8bb8\u53ef\n            if (p == head) {\n                // \u518d\u6b21\u5c1d\u8bd5\u83b7\u53d6\u8bb8\u53ef\uff0c\u3010\u8fd4\u56de\u5269\u4f59\u7684\u8bb8\u53ef\u8bc1\u6570\u91cf\u3011\n                int r = tryAcquireShared(arg);\n                if (r >= 0) {\n                    // \u6210\u529f\u540e\u672c\u7ebf\u7a0b\u51fa\u961f\uff08AQS\uff09, \u6240\u5728 Node\u8bbe\u7f6e\u4e3a head\n                    // r \u8868\u793a\u3010\u53ef\u7528\u8d44\u6e90\u6570\u3011, \u4e3a 0 \u5219\u4e0d\u4f1a\u7ee7\u7eed\u4f20\u64ad\n                    setHeadAndPropagate(node, r); \n                    p.next = null; // help GC\n                    failed = false;\n                    return;\n                }\n            }\n            // \u4e0d\u6210\u529f, \u8bbe\u7f6e\u4e0a\u4e00\u4e2a\u8282\u70b9 waitStatus = Node.SIGNAL, \u4e0b\u8f6e\u8fdb\u5165 park \u963b\u585e\n            if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\n                throw new InterruptedException();\n        }\n    } finally {\n        // \u88ab\u6253\u65ad\u540e\u8fdb\u5165\u8be5\u903b\u8f91\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void setHeadAndPropagate(Node node, int propagate) {    \n    Node h = head;\n    // \u8bbe\u7f6e\u81ea\u5df1\u4e3a head \u8282\u70b9\n    setHead(node);\n    // propagate \u8868\u793a\u6709\u3010\u5171\u4eab\u8d44\u6e90\u3011\uff08\u4f8b\u5982\u5171\u4eab\u8bfb\u9501\u6216\u4fe1\u53f7\u91cf\uff09\n    // head waitStatus == Node.SIGNAL \u6216 Node.PROPAGATE\uff0cdoReleaseShared \u51fd\u6570\u4e2d\u8bbe\u7f6e\u7684\n    if (propagate > 0 || h == null || h.waitStatus < 0 ||\n        (h = head) == null || h.waitStatus < 0) {\n        Node s = node.next;\n        // \u5982\u679c\u662f\u6700\u540e\u4e00\u4e2a\u8282\u70b9\u6216\u8005\u662f\u7b49\u5f85\u5171\u4eab\u8bfb\u9501\u7684\u8282\u70b9\uff0c\u505a\u4e00\u6b21\u5524\u9192\n        if (s == null || s.isShared())\n            doReleaseShared();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(78745).A+"",width:"989",height:"285"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8fd9\u65f6 Thread-4 \u91ca\u653e\u4e86 permits\uff0c\u72b6\u6001\u5982\u4e0b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// release() -> releaseShared()\npublic final boolean releaseShared(int arg) {\n    // \u5c1d\u8bd5\u91ca\u653e\u9501\n    if (tryReleaseShared(arg)) {\n        doReleaseShared();\n        return true;\n    }    \n    return false;\n}\nprotected final boolean tryReleaseShared(int releases) {    \n    for (;;) {\n        // \u83b7\u53d6\u5f53\u524d\u9501\u8d44\u6e90\u7684\u53ef\u7528\u8bb8\u53ef\u8bc1\u6570\u91cf\n        int current = getState();\n        int next = current + releases;\n        // \u7d22\u5f15\u8d8a\u754c\u5224\u65ad\n        if (next < current)            \n            throw new Error("Maximum permit count exceeded");        \n        // \u91ca\u653e\u9501\n        if (compareAndSetState(current, next))            \n            return true;    \n    }\n}\nprivate void doReleaseShared() {    \n    // PROPAGATE \u8be6\u89e3    \n    // \u5982\u679c head.waitStatus == Node.SIGNAL ==> 0 \u6210\u529f, \u4e0b\u4e00\u4e2a\u8282\u70b9 unpark\t\n    // \u5982\u679c head.waitStatus == 0 ==> Node.PROPAGATE\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(30562).A+"",width:"959",height:"280"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u63a5\u4e0b\u6765 Thread-0 \u7ade\u4e89\u6210\u529f\uff0cpermits \u518d\u6b21\u8bbe\u7f6e\u4e3a 0\uff0c\u8bbe\u7f6e\u81ea\u5df1\u4e3a head \u8282\u70b9\uff0c\u5e76\u4e14 unpark \u63a5\u4e0b\u6765\u7684\u5171\u4eab\u72b6\u6001\u7684 Thread-3 \u8282\u70b9\uff0c\u4f46\u7531\u4e8e permits \u662f 0\uff0c\u56e0\u6b64 Thread-3 \u5728\u5c1d\u8bd5\u4e0d\u6210\u529f\u540e\u518d\u6b21\u8fdb\u5165 park \u72b6\u6001"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"propagate",children:"PROPAGATE"}),"\n",(0,r.jsxs)(e.p,{children:["\u5047\u8bbe\u5b58\u5728\u67d0\u6b21\u5faa\u73af\u4e2d\u961f\u5217\u91cc\u6392\u961f\u7684\u7ed3\u70b9\u60c5\u51b5\u4e3a ",(0,r.jsx)(e.code,{children:"head(-1) \u2192 t1(-1) \u2192 t2(0)"}),"\uff0c\u5b58\u5728\u5c06\u8981\u91ca\u653e\u4fe1\u53f7\u91cf\u7684 T3 \u548c T4\uff0c\u91ca\u653e\u987a\u5e8f\u4e3a\u5148 T3 \u540e T4"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8001\u7248\u672c\u4ee3\u7801\nprivate void setHeadAndPropagate(Node node, int propagate) {    \n    setHead(node);    \n    // \u6709\u7a7a\u95f2\u8d44\u6e90    \n    if (propagate > 0 && node.waitStatus != 0) {    \t\n        Node s = node.next;        \n        // \u4e0b\u4e00\u4e2a        \n        if (s == null || s.isShared())            \n            unparkSuccessor(node);        \n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u6b63\u5e38\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"T3 \u8c03\u7528 releaseShared(1)\uff0c\u76f4\u63a5\u8c03\u7528\u4e86 unparkSuccessor(head)\uff0chead.waitStatus \u4ece -1 \u53d8\u4e3a 0"}),"\n",(0,r.jsx)(e.li,{children:"T1 \u7531\u4e8e T3 \u91ca\u653e\u4fe1\u53f7\u91cf\u88ab\u5524\u9192\uff0c\u7136\u540e T4 \u91ca\u653e\uff0c\u5524\u9192 T2"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"BUG \u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"T3 \u8c03\u7528 releaseShared(1)\uff0c\u76f4\u63a5\u8c03\u7528\u4e86 unparkSuccessor(head)\uff0chead.waitStatus \u4ece -1 \u53d8\u4e3a 0"}),"\n",(0,r.jsx)(e.li,{children:"T1 \u7531\u4e8e T3 \u91ca\u653e\u4fe1\u53f7\u91cf\u88ab\u5524\u9192\uff0c\u8c03\u7528 tryAcquireShared\uff0c\u8fd4\u56de\u503c\u4e3a 0\uff08\u83b7\u53d6\u9501\u6210\u529f\uff0c\u4f46\u6ca1\u6709\u5269\u4f59\u8d44\u6e90\u91cf\uff09"}),"\n",(0,r.jsx)(e.li,{children:"T1 \u8fd8\u6ca1\u8c03\u7528 setHeadAndPropagate \u65b9\u6cd5\uff0cT4 \u8c03\u7528 releaseShared(1)\uff0c\u6b64\u65f6 head.waitStatus \u4e3a 0\uff08\u6b64\u65f6\u8bfb\u5230\u7684 head \u548c 1 \u4e2d\u4e3a\u540c\u4e00\u4e2a head\uff09\uff0c\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u56e0\u6b64\u4e0d\u8c03\u7528 unparkSuccessor(head)"}),"\n",(0,r.jsxs)(e.li,{children:["T1 \u83b7\u53d6\u4fe1\u53f7\u91cf\u6210\u529f\uff0c\u8c03\u7528 setHeadAndPropagate(t1.node, 0) \u65f6\uff0c\u56e0\u4e3a\u4e0d\u6ee1\u8db3 propagate > 0\uff08\u5269\u4f59\u8d44\u6e90\u91cf == 0\uff09\uff0c\u4ece\u800c\u4e0d\u4f1a\u5524\u9192\u540e\u7ee7\u7ed3\u70b9\uff0c ",(0,r.jsx)(e.strong,{children:"T2 \u7ebf\u7a0b\u5f97\u4e0d\u5230\u5524\u9192"})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u66f4\u65b0\u540e\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"T3 \u8c03\u7528 releaseShared(1)\uff0c\u76f4\u63a5\u8c03\u7528\u4e86 unparkSuccessor(head)\uff0chead.waitStatus \u4ece -1 \u53d8\u4e3a 0"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"T1 \u7531\u4e8e T3 \u91ca\u653e\u4fe1\u53f7\u91cf\u88ab\u5524\u9192\uff0c\u8c03\u7528 tryAcquireShared\uff0c\u8fd4\u56de\u503c\u4e3a 0\uff08\u83b7\u53d6\u9501\u6210\u529f\uff0c\u4f46\u6ca1\u6709\u5269\u4f59\u8d44\u6e90\u91cf\uff09"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["T1 \u8fd8\u6ca1\u8c03\u7528 setHeadAndPropagate \u65b9\u6cd5\uff0cT4 \u8c03\u7528 releaseShared()\uff0c\u6b64\u65f6 head.waitStatus \u4e3a 0\uff08\u6b64\u65f6\u8bfb\u5230\u7684 head \u548c 1 \u4e2d\u4e3a\u540c\u4e00\u4e2a head\uff09\uff0c\u8c03\u7528 doReleaseShared() \u5c06\u7b49\u5f85\u72b6\u6001\u7f6e\u4e3a ",(0,r.jsx)(e.strong,{children:"PROPAGATE\uff08-3\uff09"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"T1 \u83b7\u53d6\u4fe1\u53f7\u91cf\u6210\u529f\uff0c\u8c03\u7528 setHeadAndPropagate \u65f6\uff0c\u8bfb\u5230 h.waitStatus < 0\uff0c\u4ece\u800c\u8c03\u7528 doReleaseShared() \u5524\u9192 T2"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void setHeadAndPropagate(Node node, int propagate) {    \n    Node h = head;\n    // \u8bbe\u7f6e\u81ea\u5df1\u4e3a head \u8282\u70b9\n    setHead(node);\n    // propagate \u8868\u793a\u6709\u5171\u4eab\u8d44\u6e90\uff08\u4f8b\u5982\u5171\u4eab\u8bfb\u9501\u6216\u4fe1\u53f7\u91cf\uff09\n    // head waitStatus == Node.SIGNAL \u6216 Node.PROPAGATE\n    if (propagate > 0 || h == null || h.waitStatus < 0 ||\n        (h = head) == null || h.waitStatus < 0) {\n        Node s = node.next;\n        // \u5982\u679c\u662f\u6700\u540e\u4e00\u4e2a\u8282\u70b9\u6216\u8005\u662f\u7b49\u5f85\u5171\u4eab\u8bfb\u9501\u7684\u8282\u70b9\uff0c\u505a\u4e00\u6b21\u5524\u9192\n        if (s == null || s.isShared())\n            doReleaseShared();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5524\u9192\nprivate void doReleaseShared() {\n    // \u5982\u679c head.waitStatus == Node.SIGNAL ==> 0 \u6210\u529f, \u4e0b\u4e00\u4e2a\u8282\u70b9 unpark\t\n    // \u5982\u679c head.waitStatus == 0 ==> Node.PROPAGATE    \n    for (;;) {\n        Node h = head;\n        if (h != null && h != tail) {\n            int ws = h.waitStatus;\n            if (ws == Node.SIGNAL) {\n                // \u9632\u6b62 unparkSuccessor \u88ab\u591a\u6b21\u6267\u884c\n                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))\n                    continue;\n                // \u5524\u9192\u540e\u7ee7\u8282\u70b9\n                unparkSuccessor(h);\n            }\n            // \u5982\u679c\u5df2\u7ecf\u662f 0 \u4e86\uff0c\u6539\u4e3a -3\uff0c\u7528\u6765\u89e3\u51b3\u4f20\u64ad\u6027\n            else if (ws == 0 && !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))\n                continue;\n        }\n        if (h == head)\n            break;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"exchanger",children:"Exchanger"}),"\n",(0,r.jsx)(e.p,{children:"Exchanger\uff1a\u4ea4\u6362\u5668\uff0c\u662f\u4e00\u4e2a\u7528\u4e8e\u7ebf\u7a0b\u95f4\u534f\u4f5c\u7684\u5de5\u5177\u7c7b\uff0c\u7528\u4e8e\u8fdb\u884c\u7ebf\u7a0b\u95f4\u7684\u6570\u636e\u4ea4\u6362"}),"\n",(0,r.jsx)(e.p,{children:"\u5de5\u4f5c\u6d41\u7a0b\uff1a\u4e24\u4e2a\u7ebf\u7a0b\u901a\u8fc7 exchange \u65b9\u6cd5\u4ea4\u6362\u6570\u636e\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u7ebf\u7a0b\u5148\u6267\u884c exchange() \u65b9\u6cd5\uff0c\u5b83\u4f1a\u4e00\u76f4\u7b49\u5f85\u7b2c\u4e8c\u4e2a\u7ebf\u7a0b\u4e5f\u6267\u884c exchange \u65b9\u6cd5\uff0c\u5f53\u4e24\u4e2a\u7ebf\u7a0b\u90fd\u5230\u8fbe\u540c\u6b65\u70b9\u65f6\uff0c\u8fd9\u4e24\u4e2a\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u4ea4\u6362\u6570\u636e"}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public Exchanger()"}),"\uff1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u4ea4\u6362\u5668"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public V exchange(V x)"}),"\uff1a\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5230\u8fbe\u6b64\u4ea4\u6362\u70b9"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public V exchange(V x, long timeout, TimeUnit unit)"}),"\uff1a\u7b49\u5f85\u4e00\u5b9a\u7684\u65f6\u95f4"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ExchangerDemo {\n    public static void main(String[] args) {\n        // \u521b\u5efa\u4ea4\u6362\u5bf9\u8c61\uff08\u4fe1\u4f7f\uff09\n        Exchanger<String> exchanger = new Exchanger<>();\n        new ThreadA(exchanger).start();\n        new ThreadB(exchanger).start();\n    } \n}\nclass ThreadA extends Thread{\n    private Exchanger<String> exchanger();\n    \n    public ThreadA(Exchanger<String> exchanger){\n        this.exchanger = exchanger;\n    }\n    \n    @Override\n    public void run() {\n        try{\n            sout("\u7ebf\u7a0bA\uff0c\u505a\u597d\u4e86\u793c\u7269A\uff0c\u7b49\u5f85\u7ebf\u7a0bB\u9001\u6765\u7684\u793c\u7269B");\n            //\u5982\u679c\u7b49\u5f85\u4e865s\u8fd8\u6ca1\u6709\u4ea4\u6362\u5c31\u6b7b\u4ea1\uff08\u629b\u51fa\u5f02\u5e38\uff09\uff01\n            String s = exchanger.exchange("\u793c\u7269A",5,TimeUnit.SECONDS);\n            sout("\u7ebf\u7a0bA\u6536\u5230\u7ebf\u7a0bB\u7684\u793c\u7269\uff1a" + s);\n        } catch (Exception e) {\n            System.out.println("\u7ebf\u7a0bA\u7b49\u5f85\u4e865s\uff0c\u6ca1\u6709\u6536\u5230\u793c\u7269,\u6700\u7ec8\u5c31\u6267\u884c\u7ed3\u675f\u4e86!");\n        }\n    }\n}\nclass ThreadB extends Thread{\n    private Exchanger<String> exchanger;\n    \n    public ThreadB(Exchanger<String> exchanger) {\n        this.exchanger = exchanger;\n    }\n    \n    @Override\n    public void run() {\n        try {\n            sout("\u7ebf\u7a0bB,\u505a\u597d\u4e86\u793c\u7269B,\u7b49\u5f85\u7ebf\u7a0bA\u9001\u6765\u7684\u793c\u7269A.....");\n            // \u5f00\u59cb\u4ea4\u6362\u793c\u7269\u3002\u53c2\u6570\u662f\u9001\u7ed9\u5176\u4ed6\u7ebf\u7a0b\u7684\u793c\u7269!\n            sout("\u7ebf\u7a0bB\u6536\u5230\u7ebf\u7a0bA\u7684\u793c\u7269\uff1a" + exchanger.exchange("\u793c\u7269B"));\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u5e76\u53d1\u5305",children:"\u5e76\u53d1\u5305"}),"\n",(0,r.jsx)(e.h3,{id:"conhashmap",children:"ConHashMap"}),"\n",(0,r.jsx)(e.h4,{id:"\u5e76\u53d1\u96c6\u5408",children:"\u5e76\u53d1\u96c6\u5408"}),"\n",(0,r.jsx)(e.h5,{id:"\u96c6\u5408\u5bf9\u6bd4",children:"\u96c6\u5408\u5bf9\u6bd4"}),"\n",(0,r.jsx)(e.p,{children:"\u4e09\u79cd\u96c6\u5408\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"HashMap \u662f\u7ebf\u7a0b\u4e0d\u5b89\u5168\u7684\uff0c\u6027\u80fd\u597d"}),"\n",(0,r.jsx)(e.li,{children:"Hashtable \u7ebf\u7a0b\u5b89\u5168\u57fa\u4e8e synchronized\uff0c\u7efc\u5408\u6027\u80fd\u5dee\uff0c\u5df2\u7ecf\u88ab\u6dd8\u6c70"}),"\n",(0,r.jsx)(e.li,{children:"ConcurrentHashMap \u4fdd\u8bc1\u4e86\u7ebf\u7a0b\u5b89\u5168\uff0c\u7efc\u5408\u6027\u80fd\u8f83\u597d\uff0c\u4e0d\u6b62\u7ebf\u7a0b\u5b89\u5168\uff0c\u800c\u4e14\u6548\u7387\u9ad8\uff0c\u6027\u80fd\u597d"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u96c6\u5408\u5bf9\u6bd4\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Hashtable \u7ee7\u627f Dictionary \u7c7b\uff0cHashMap\u3001ConcurrentHashMap \u7ee7\u627f AbstractMap\uff0c\u5747\u5b9e\u73b0 Map \u63a5\u53e3"}),"\n",(0,r.jsx)(e.li,{children:"Hashtable \u5e95\u5c42\u662f\u6570\u7ec4 + \u94fe\u8868\uff0cJDK8 \u4ee5\u540e HashMap \u548c ConcurrentHashMap \u5e95\u5c42\u662f\u6570\u7ec4 + \u94fe\u8868 + \u7ea2\u9ed1\u6811"}),"\n",(0,r.jsx)(e.li,{children:"HashMap \u7ebf\u7a0b\u975e\u5b89\u5168\uff0cHashtable \u7ebf\u7a0b\u5b89\u5168\uff0cHashtable \u7684\u65b9\u6cd5\u90fd\u52a0\u4e86 synchronized \u5173\u6765\u786e\u4fdd\u7ebf\u7a0b\u540c\u6b65"}),"\n",(0,r.jsxs)(e.li,{children:["ConcurrentHashMap\u3001Hashtable ",(0,r.jsx)(e.strong,{children:"\u4e0d\u5141\u8bb8 null \u503c"}),"\uff0cHashMap \u5141\u8bb8 null \u503c"]}),"\n",(0,r.jsx)(e.li,{children:"ConcurrentHashMap\u3001HashMap \u7684\u521d\u59cb\u5bb9\u91cf\u4e3a 16\uff0cHashtable \u521d\u59cb\u5bb9\u91cf\u4e3a11\uff0c\u586b\u5145\u56e0\u5b50\u9ed8\u8ba4\u90fd\u662f 0.75\uff0c\u4e24\u79cd Map \u6269\u5bb9\u662f\u5f53\u524d\u5bb9\u91cf\u7ffb\u500d\uff1acapacity * 2\uff0cHashtable \u6269\u5bb9\u65f6\u662f\u5bb9\u91cf\u7ffb\u500d + 1\uff1acapacity*2 + 1"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{alt:"ConcurrentHashMap\u6570\u636e\u7ed3\u6784",src:l(23190).A+"",width:"1354",height:"487"})}),"\n",(0,r.jsx)(e.p,{children:"\u5de5\u4f5c\u6b65\u9aa4\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u521d\u59cb\u5316\uff0c\u4f7f\u7528 cas \u6765\u4fdd\u8bc1\u5e76\u53d1\u5b89\u5168\uff0c\u61d2\u60f0\u521d\u59cb\u5316 table"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6811\u5316\uff0c\u5f53 table.length < 64 \u65f6\uff0c\u5148\u5c1d\u8bd5\u6269\u5bb9\uff0c\u8d85\u8fc7 64 \u65f6\uff0c\u5e76\u4e14 bin.length > 8 \u65f6\uff0c\u4f1a\u5c06",(0,r.jsx)(e.strong,{children:"\u94fe\u8868\u6811\u5316"}),"\uff0c\u6811\u5316\u8fc7\u7a0b\u4f1a\u7528 synchronized \u9501\u4f4f\u94fe\u8868\u5934"]}),"\n",(0,r.jsxs)(e.p,{children:["\u8bf4\u660e\uff1a\u9501\u4f4f\u67d0\u4e2a\u69fd\u4f4d\u7684\u5bf9\u8c61\u5934\uff0c\u662f\u4e00\u79cd\u5f88\u597d\u7684",(0,r.jsx)(e.strong,{children:"\u7ec6\u7c92\u5ea6\u7684\u52a0\u9501"}),"\u65b9\u5f0f\uff0c\u7c7b\u4f3c MySQL \u4e2d\u7684\u884c\u9501"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"put\uff0c\u5982\u679c\u8be5 bin \u5c1a\u672a\u521b\u5efa\uff0c\u53ea\u9700\u8981\u4f7f\u7528 cas \u521b\u5efa bin\uff1b\u5982\u679c\u5df2\u7ecf\u6709\u4e86\uff0c\u9501\u4f4f\u94fe\u8868\u5934\u8fdb\u884c\u540e\u7eed put \u64cd\u4f5c\uff0c\u5143\u7d20\u6dfb\u52a0\u81f3 bin \u7684\u5c3e\u90e8"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"get\uff0c\u65e0\u9501\u64cd\u4f5c\u4ec5\u9700\u8981\u4fdd\u8bc1\u53ef\u89c1\u6027\uff0c\u6269\u5bb9\u8fc7\u7a0b\u4e2d get \u64cd\u4f5c\u62ff\u5230\u7684\u662f ForwardingNode \u4f1a\u8ba9 get \u64cd\u4f5c\u5728\u65b0 table \u8fdb\u884c\u641c\u7d22"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6269\u5bb9\uff0c\u6269\u5bb9\u65f6\u4ee5 bin \u4e3a\u5355\u4f4d\u8fdb\u884c\uff0c\u9700\u8981\u5bf9 bin \u8fdb\u884c synchronized\uff0c\u4f46\u8fd9\u65f6\u5176\u5b83\u7ade\u4e89\u7ebf\u7a0b\u4e5f\u4e0d\u662f\u65e0\u4e8b\u53ef\u505a\uff0c\u5b83\u4eec\u4f1a\u5e2e\u52a9\u628a\u5176\u5b83 bin \u8fdb\u884c\u6269\u5bb9"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"size\uff0c\u5143\u7d20\u4e2a\u6570\u4fdd\u5b58\u5728 baseCount \u4e2d\uff0c\u5e76\u53d1\u65f6\u7684\u4e2a\u6570\u53d8\u52a8\u4fdd\u5b58\u5728 CounterCell[] \u5f53\u4e2d\uff0c\u6700\u540e\u7edf\u8ba1\u6570\u91cf\u65f6\u7d2f\u52a0"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'//\u9700\u6c42\uff1a\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5f80HashMap\u5bb9\u5668\u4e2d\u5b58\u5165\u6570\u636e\u4f1a\u51fa\u73b0\u5b89\u5168\u95ee\u9898\npublic class ConcurrentHashMapDemo{\n    public static Map<String,String> map = new ConcurrentHashMap();\n    \n    public static void main(String[] args){\n        new AddMapDataThread().start();\n        new AddMapDataThread().start();\n        \n        Thread.sleep(1000 * 5);//\u4f11\u606f5\u79d2\uff0c\u786e\u4fdd\u4e24\u4e2a\u7ebf\u7a0b\u6267\u884c\u5b8c\u6bd5\n        System.out.println("Map\u5927\u5c0f\uff1a" + map.size());//20\u4e07\n    }\n}\n\npublic class AddMapDataThread extends Thread{\n    @Override\n    public void run() {\n        for(int i = 0 ; i < 1000000 ; i++ ){\n            ConcurrentHashMapDemo.map.put("\u952e\uff1a"+i , "\u503c"+i);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5e76\u53d1\u6b7b\u94fe",children:"\u5e76\u53d1\u6b7b\u94fe"}),"\n",(0,r.jsx)(e.p,{children:"JDK1.7 \u7684 HashMap \u91c7\u7528\u7684\u5934\u63d2\u6cd5\uff08\u62c9\u94fe\u6cd5\uff09\u8fdb\u884c\u8282\u70b9\u7684\u6dfb\u52a0\uff0cHashMap \u7684\u6269\u5bb9\u957f\u5ea6\u4e3a\u539f\u6765\u7684 2 \u500d"}),"\n",(0,r.jsx)(e.p,{children:"resize() \u4e2d\u8282\u70b9\uff08Entry\uff09\u8f6c\u79fb\u7684\u6e90\u4ee3\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"void transfer(Entry[] newTable, boolean rehash) {\n    int newCapacity = newTable.length;//\u5f97\u5230\u65b0\u6570\u7ec4\u7684\u957f\u5ea6   \n    // \u904d\u5386\u6574\u4e2a\u6570\u7ec4\u5bf9\u5e94\u4e0b\u6807\u4e0b\u7684\u94fe\u8868\uff0ce\u4ee3\u8868\u4e00\u4e2a\u8282\u70b9\n    for (Entry<K,V> e : table) {   \n        // \u5f53e == null\u65f6\uff0c\u5219\u8be5\u94fe\u8868\u904d\u5386\u5b8c\u4e86\uff0c\u7ee7\u7eed\u904d\u5386\u4e0b\u4e00\u6570\u7ec4\u4e0b\u6807\u7684\u94fe\u8868 \n        while(null != e) { \n            // \u5148\u628ae\u8282\u70b9\u7684\u4e0b\u4e00\u8282\u70b9\u5b58\u8d77\u6765\n            Entry<K,V> next = e.next; \n            if (rehash) {              //\u5f97\u5230\u65b0\u7684hash\u503c\n                e.hash = null == e.key ? 0 : hash(e.key);  \n            }\n            // \u5728\u65b0\u6570\u7ec4\u4e0b\u5f97\u5230\u65b0\u7684\u6570\u7ec4\u4e0b\u6807\n            int i = indexFor(e.hash, newCapacity);  \n             // \u5c06e\u7684next\u6307\u9488\u6307\u5411\u65b0\u6570\u7ec4\u4e0b\u6807\u7684\u4f4d\u7f6e\n            e.next = newTable[i];   \n            // \u5c06\u8be5\u6570\u7ec4\u4e0b\u6807\u7684\u8282\u70b9\u53d8\u4e3ae\u8282\u70b9\n            newTable[i] = e; \n            // \u904d\u5386\u94fe\u8868\u7684\u4e0b\u4e00\u8282\u70b9\n            e = next;                                   \n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"JDK 8 \u867d\u7136\u5c06\u6269\u5bb9\u7b97\u6cd5\u505a\u4e86\u8c03\u6574\uff0c\u6539\u7528\u4e86\u5c3e\u63d2\u6cd5\uff0c\u4f46\u4ecd\u4e0d\u610f\u5473\u7740\u80fd\u591f\u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u80fd\u591f\u5b89\u5168\u6269\u5bb9\uff0c\u8fd8\u4f1a\u51fa\u73b0\u5176\u5b83\u95ee\u9898\uff08\u5982\u6269\u5bb9\u4e22\u6570\u636e\uff09"}),"\n",(0,r.jsxs)(e.p,{children:["B\u7ad9\u89c6\u9891\u89e3\u6790\uff1a",(0,r.jsx)(e.a,{href:"https://www.bilibili.com/video/BV1n541177Ea",children:"https://www.bilibili.com/video/BV1n541177Ea"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u5c5e\u6027-7",children:"\u6210\u5458\u5c5e\u6027"}),"\n",(0,r.jsx)(e.h5,{id:"\u53d8\u91cf",children:"\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5b58\u50a8\u6570\u7ec4\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"transient volatile Node<K,V>[] table;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6563\u5217\u8868\u7684\u957f\u5ea6\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final int MAXIMUM_CAPACITY = 1 << 30;\t// \u6700\u5927\u957f\u5ea6\nprivate static final int DEFAULT_CAPACITY = 16;\t\t\t// \u9ed8\u8ba4\u957f\u5ea6\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5e76\u53d1\u7ea7\u522b\uff0cJDK7 \u9057\u7559\u4e0b\u6765\uff0c1.8 \u4e2d\u4e0d\u4ee3\u8868\u5e76\u53d1\u7ea7\u522b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final int DEFAULT_CONCURRENCY_LEVEL = 16;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8d1f\u8f7d\u56e0\u5b50\uff0cJDK1.8 \u7684 ConcurrentHashMap \u4e2d\u662f\u56fa\u5b9a\u503c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final float LOAD_FACTOR = 0.75f;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u9608\u503c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final int TREEIFY_THRESHOLD = 8;\t\t// \u94fe\u8868\u6811\u5316\u7684\u9608\u503c\nstatic final int UNTREEIFY_THRESHOLD = 6;\t// \u7ea2\u9ed1\u6811\u8f6c\u5316\u4e3a\u94fe\u8868\u7684\u9608\u503c\nstatic final int MIN_TREEIFY_CAPACITY = 64;\t// \u5f53\u6570\u7ec4\u957f\u5ea6\u8fbe\u523064\u4e14\u67d0\u4e2a\u6876\u4f4d\u4e2d\u7684\u94fe\u8868\u957f\u5ea6\u8d85\u8fc78\uff0c\u624d\u4f1a\u771f\u6b63\u6811\u5316\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6269\u5bb9\u76f8\u5173\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final int MIN_TRANSFER_STRIDE = 16;\t// \u7ebf\u7a0b\u8fc1\u79fb\u6570\u636e\u3010\u6700\u5c0f\u6b65\u957f\u3011\uff0c\u63a7\u5236\u7ebf\u7a0b\u8fc1\u79fb\u4efb\u52a1\u7684\u6700\u5c0f\u533a\u95f4\nprivate static int RESIZE_STAMP_BITS = 16;\t\t\t// \u7528\u6765\u8ba1\u7b97\u6269\u5bb9\u65f6\u751f\u6210\u7684\u3010\u6807\u8bc6\u6233\u3011\nprivate static final int MAX_RESIZERS = (1 << (32 - RESIZE_STAMP_BITS)) - 1;// 65535-1\u5e76\u53d1\u6269\u5bb9\u6700\u591a\u7ebf\u7a0b\u6570\nprivate static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;\t\t// \u6269\u5bb9\u65f6\u4f7f\u7528\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8282\u70b9\u54c8\u5e0c\u503c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final int MOVED     = -1; \t\t\t// \u8868\u793a\u5f53\u524d\u8282\u70b9\u662f FWD \u8282\u70b9\nstatic final int TREEBIN   = -2; \t\t\t// \u8868\u793a\u5f53\u524d\u8282\u70b9\u5df2\u7ecf\u6811\u5316\uff0c\u4e14\u5f53\u524d\u8282\u70b9\u4e3a TreeBin \u5bf9\u8c61\nstatic final int RESERVED  = -3; \t\t\t// \u8868\u793a\u8282\u70b9\u65f6\u4e34\u65f6\u8282\u70b9\nstatic final int HASH_BITS = 0x7fffffff; \t// \u6b63\u5e38\u8282\u70b9\u7684\u54c8\u5e0c\u503c\u7684\u53ef\u7528\u7684\u4f4d\u6570\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6269\u5bb9\u8fc7\u7a0b\uff1avolatile \u4fee\u9970\u4fdd\u8bc1\u591a\u7ebf\u7a0b\u7684\u53ef\u89c1\u6027"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u6269\u5bb9\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u5c06\u6269\u5bb9\u4e2d\u7684\u65b0 table \u8d4b\u503c\u7ed9 nextTable \u4fdd\u6301\u5f15\u7528\uff0c\u6269\u5bb9\u7ed3\u675f\u4e4b\u540e\uff0c\u8fd9\u91cc\u4f1a\u88ab\u8bbe\u7f6e\u4e3a null\nprivate transient volatile Node<K,V>[] nextTable;\n// \u8bb0\u5f55\u6269\u5bb9\u8fdb\u5ea6\uff0c\u6240\u6709\u7ebf\u7a0b\u90fd\u8981\u4ece 0 - transferIndex \u4e2d\u5206\u914d\u533a\u95f4\u4efb\u52a1\uff0c\u7b80\u5355\u8bf4\u5c31\u662f\u8001\u8868\u8f6c\u79fb\u5230\u54ea\u4e86\uff0c\u7d22\u5f15\u4ece\u9ad8\u5230\u4f4e\u8f6c\u79fb\nprivate transient volatile int transferIndex;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7d2f\u52a0\u7edf\u8ba1\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// LongAdder \u4e2d\u7684 baseCount \u672a\u53d1\u751f\u7ade\u4e89\u65f6\u6216\u8005\u5f53\u524dLongAdder\u5904\u4e8e\u52a0\u9501\u72b6\u6001\u65f6\uff0c\u589e\u91cf\u7d2f\u5230\u5230 baseCount \u4e2d\nprivate transient volatile long baseCount;\n// LongAdder \u4e2d\u7684 cellsBuzy\uff0c0 \u8868\u793a\u5f53\u524d LongAdder \u5bf9\u8c61\u65e0\u9501\u72b6\u6001\uff0c1 \u8868\u793a\u5f53\u524d LongAdder \u5bf9\u8c61\u52a0\u9501\u72b6\u6001\nprivate transient volatile int cellsBusy;\n// LongAdder \u4e2d\u7684 cells \u6570\u7ec4\uff0c\nprivate transient volatile CounterCell[] counterCells;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u63a7\u5236\u53d8\u91cf\uff1a"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"sizeCtl"})," < 0\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"-1 \u8868\u793a\u5f53\u524d table \u6b63\u5728\u521d\u59cb\u5316\uff08\u6709\u7ebf\u7a0b\u5728\u521b\u5efa table \u6570\u7ec4\uff09\uff0c\u5f53\u524d\u7ebf\u7a0b\u9700\u8981\u81ea\u65cb\u7b49\u5f85"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5176\u4ed6\u8d1f\u6570\u8868\u793a\u5f53\u524d map \u7684 table \u6570\u7ec4\u6b63\u5728\u8fdb\u884c\u6269\u5bb9\uff0c\u9ad8 16 \u4f4d\u8868\u793a\u6269\u5bb9\u7684\u6807\u8bc6\u6233\uff1b\u4f4e 16 \u4f4d\u8868\u793a (1 + nThread) \u5f53\u524d\u53c2\u4e0e\u5e76\u53d1\u6269\u5bb9\u7684\u7ebf\u7a0b\u6570\u91cf + 1"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"sizeCtl = 0\uff0c\u8868\u793a\u521b\u5efa table \u6570\u7ec4\u65f6\u4f7f\u7528 DEFAULT_CAPACITY \u4e3a\u6570\u7ec4\u5927\u5c0f"}),"\n",(0,r.jsx)(e.p,{children:"sizeCtl > 0\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c table \u672a\u521d\u59cb\u5316\uff0c\u8868\u793a\u521d\u59cb\u5316\u5927\u5c0f"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c table \u5df2\u7ecf\u521d\u59cb\u5316\uff0c\u8868\u793a\u4e0b\u6b21\u6269\u5bb9\u65f6\u7684\u89e6\u53d1\u6761\u4ef6\uff08\u9608\u503c\uff0c\u5143\u7d20\u4e2a\u6570\uff0c\u4e0d\u662f\u6570\u7ec4\u7684\u957f\u5ea6\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private transient volatile int sizeCtl;\t\t// volatile \u4fdd\u6301\u53ef\u89c1\u6027\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5185\u90e8\u7c7b",children:"\u5185\u90e8\u7c7b"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Node \u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static class Node<K,V> implements Entry<K,V> {\n    // \u8282\u70b9\u54c8\u5e0c\u503c\n    final int hash;\n    final K key;\n    volatile V val;\n    // \u5355\u5411\u94fe\u8868\n    volatile Node<K,V> next;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"TreeBin \u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:" static final class TreeBin<K,V> extends Node<K,V> {\n     // \u7ea2\u9ed1\u6811\u6839\u8282\u70b9\n     TreeNode<K,V> root;\n     // \u94fe\u8868\u7684\u5934\u8282\u70b9\n     volatile TreeNode<K,V> first;\n     // \u7b49\u5f85\u8005\u7ebf\u7a0b\n     volatile Thread waiter;\n\n     volatile int lockState;\n     // \u5199\u9501\u72b6\u6001 \u5199\u9501\u662f\u72ec\u5360\u72b6\u6001\uff0c\u4ee5\u6563\u5217\u8868\u6765\u770b\uff0c\u771f\u6b63\u8fdb\u5165\u5230 TreeBin \u4e2d\u7684\u5199\u7ebf\u7a0b\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\n     static final int WRITER = 1;\n     // \u7b49\u5f85\u8005\u72b6\u6001\uff08\u5199\u7ebf\u7a0b\u5728\u7b49\u5f85\uff09\uff0c\u5f53 TreeBin \u4e2d\u6709\u8bfb\u7ebf\u7a0b\u76ee\u524d\u6b63\u5728\u8bfb\u53d6\u6570\u636e\u65f6\uff0c\u5199\u7ebf\u7a0b\u65e0\u6cd5\u4fee\u6539\u6570\u636e\n     static final int WAITER = 2;\n     // \u8bfb\u9501\u72b6\u6001\u662f\u5171\u4eab\uff0c\u540c\u4e00\u65f6\u523b\u53ef\u4ee5\u6709\u591a\u4e2a\u7ebf\u7a0b \u540c\u65f6\u8fdb\u5165\u5230 TreeBi \u5bf9\u8c61\u4e2d\u83b7\u53d6\u6570\u636e\uff0c\u6bcf\u4e00\u4e2a\u7ebf\u7a0b\u90fd\u7ed9 lockState + 4\n     static final int READER = 4;\n }\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"TreeNode \u8282\u70b9\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final class TreeNode<K,V> extends Node<K,V> {\n    TreeNode<K,V> parent;  // red-black tree links\n    TreeNode<K,V> left;\n    TreeNode<K,V> right;\n    TreeNode<K,V> prev;   //\u53cc\u5411\u94fe\u8868\n    boolean red;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"ForwardingNode \u8282\u70b9\uff1a\u8f6c\u79fb\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:" static final class ForwardingNode<K,V> extends Node<K,V> {\n     // \u6301\u6709\u6269\u5bb9\u540e\u65b0\u7684\u54c8\u5e0c\u8868\u7684\u5f15\u7528\n     final Node<K,V>[] nextTable;\n     ForwardingNode(Node<K,V>[] tab) {\n         // ForwardingNode \u8282\u70b9\u7684 hash \u503c\u8bbe\u4e3a -1\n         super(MOVED, null, null, null);\n         this.nextTable = tab;\n     }\n }\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u4ee3\u7801\u5757",children:"\u4ee3\u7801\u5757"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u53d8\u91cf\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u8868\u793asizeCtl\u5c5e\u6027\u5728 ConcurrentHashMap \u4e2d\u5185\u5b58\u504f\u79fb\u5730\u5740\nprivate static final long SIZECTL;\n// \u8868\u793atransferIndex\u5c5e\u6027\u5728 ConcurrentHashMap \u4e2d\u5185\u5b58\u504f\u79fb\u5730\u5740\nprivate static final long TRANSFERINDEX;\n// \u8868\u793abaseCount\u5c5e\u6027\u5728 ConcurrentHashMap \u4e2d\u5185\u5b58\u504f\u79fb\u5730\u5740\nprivate static final long BASECOUNT;\n// \u8868\u793acellsBusy\u5c5e\u6027\u5728 ConcurrentHashMap \u4e2d\u5185\u5b58\u504f\u79fb\u5730\u5740\nprivate static final long CELLSBUSY;\n// \u8868\u793acellValue\u5c5e\u6027\u5728 CounterCell \u4e2d\u5185\u5b58\u504f\u79fb\u5730\u5740\nprivate static final long CELLVALUE;\n// \u8868\u793a\u6570\u7ec4\u7b2c\u4e00\u4e2a\u5143\u7d20\u7684\u504f\u79fb\u5730\u5740\nprivate static final long ABASE;\n// \u7528\u4f4d\u79fb\u8fd0\u7b97\u66ff\u4ee3\u4e58\u6cd5\nprivate static final int ASHIFT;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8d4b\u503c\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// \u8868\u793a\u6570\u7ec4\u5355\u5143\u6240\u5360\u7528\u7a7a\u95f4\u5927\u5c0f\uff0cscale \u8868\u793a Node[] \u6570\u7ec4\u4e2d\u6bcf\u4e00\u4e2a\u5355\u5143\u6240\u5360\u7528\u7a7a\u95f4\u5927\u5c0f\uff0cint \u662f 4 \u5b57\u8282\nint scale = U.arrayIndexScale(ak);\n// \u5224\u65ad\u4e00\u4e2a\u6570\u662f\u4e0d\u662f 2 \u7684 n \u6b21\u5e42\uff0c\u6bd4\u5982 8\uff1a1000 & 0111 = 0000\nif ((scale & (scale - 1)) != 0)\n    throw new Error("data type scale not a power of two");\n\n// numberOfLeadingZeros(n)\uff1a\u8fd4\u56de\u5f53\u524d\u6570\u503c\u8f6c\u6362\u4e3a\u4e8c\u8fdb\u5236\u540e\uff0c\u4ece\u9ad8\u4f4d\u5230\u4f4e\u4f4d\u5f00\u59cb\u7edf\u8ba1\uff0c\u770b\u6709\u591a\u5c11\u4e2a0\u8fde\u7eed\u5728\u4e00\u8d77\n// 8 \u2192 1000 numberOfLeadingZeros(8) = 28\n// 4 \u2192 100 numberOfLeadingZeros(4) = 29   int \u503c\u5c31\u662f\u53604\u4e2a\u5b57\u8282\nASHIFT = 31 - Integer.numberOfLeadingZeros(scale);\n\n// ASHIFT = 31 - 29 = 2 \uff0cint \u7684\u5927\u5c0f\u5c31\u662f 2 \u7684 2 \u6b21\u65b9\uff0c\u83b7\u53d6\u6b21\u65b9\u6570\n// ABASE + \uff085 << ASHIFT\uff09 \u7528\u4f4d\u79fb\u8fd0\u7b97\u66ff\u4ee3\u4e86\u4e58\u6cd5\uff0c\u83b7\u53d6 arr[5] \u7684\u503c\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6784\u9020\u65b9\u6cd5",children:"\u6784\u9020\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u65e0\u53c2\u6784\u9020\uff0c \u6563\u5217\u8868\u7ed3\u6784\u5ef6\u8fdf\u521d\u59cb\u5316\uff0c\u9ed8\u8ba4\u7684\u6570\u7ec4\u5927\u5c0f\u662f 16\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ConcurrentHashMap() {\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6709\u53c2\u6784\u9020\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ConcurrentHashMap(int initialCapacity) {\n    // \u6307\u5b9a\u5bb9\u91cf\u521d\u59cb\u5316\n    if (initialCapacity < 0) throw new IllegalArgumentException();\n    int cap = ((initialCapacity >= (MAXIMUM_CAPACITY >>> 1)) ?\n               MAXIMUM_CAPACITY :\n               // \u5047\u5982\u4f20\u5165\u7684\u53c2\u6570\u662f 16\uff0c16 + 8 + 1 \uff0c\u6700\u540e\u5f97\u5230 32\n               // \u4f20\u5165 12\uff0c 12 + 6 + 1 = 19\uff0c\u6700\u540e\u5f97\u5230 32\uff0c\u5c3d\u53ef\u80fd\u7684\u5927\uff0c\u4e0e HashMap\u4e0d\u4e00\u6837\n               tableSizeFor(initialCapacity + (initialCapacity >>> 1) + 1));\n    // sizeCtl > 0\uff0c\u5f53\u76ee\u524d table \u672a\u521d\u59cb\u5316\u65f6\uff0csizeCtl \u8868\u793a\u521d\u59cb\u5316\u5bb9\u91cf\n    this.sizeCtl = cap;\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final int tableSizeFor(int c) {\n    int n = c - 1;\n    n |= n >>> 1;\n    n |= n >>> 2;\n    n |= n >>> 4;\n    n |= n >>> 8;\n    n |= n >>> 16;\n    return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["HashMap \u90e8\u5206\u8be6\u89e3\u4e86\u8be5\u51fd\u6570\uff0c\u6838\u5fc3\u601d\u60f3\u5c31\u662f",(0,r.jsx)(e.strong,{children:"\u628a\u6700\u9ad8\u4f4d\u662f 1 \u7684\u4f4d\u4ee5\u53ca\u53f3\u8fb9\u7684\u4f4d\u5168\u90e8\u7f6e 1"}),"\uff0c\u7ed3\u679c\u52a0 1 \u540e\u5c31\u662f 2 \u7684 n \u6b21\u5e42"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u591a\u4e2a\u53c2\u6570\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) {\n    if (!(loadFactor > 0.0f) || initialCapacity < 0 || concurrencyLevel <= 0)\n        throw new IllegalArgumentException();\n    // \u521d\u59cb\u5bb9\u91cf\u5c0f\u4e8e\u5e76\u53d1\u7ea7\u522b\n    if (initialCapacity < concurrencyLevel)  \n        // \u628a\u5e76\u53d1\u7ea7\u522b\u8d4b\u503c\u7ed9\u521d\u59cb\u5bb9\u91cf\n        initialCapacity = concurrencyLevel; \n\t// loadFactor \u9ed8\u8ba4\u662f 0.75\n    long size = (long)(1.0 + (long)initialCapacity / loadFactor);\n    int cap = (size >= (long)MAXIMUM_CAPACITY) ?\n        MAXIMUM_CAPACITY : tableSizeFor((int)size);\n    // sizeCtl > 0\uff0c\u5f53\u76ee\u524d table \u672a\u521d\u59cb\u5316\u65f6\uff0csizeCtl \u8868\u793a\u521d\u59cb\u5316\u5bb9\u91cf\n    this.sizeCtl = cap;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u96c6\u5408\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ConcurrentHashMap(Map<? extends K, ? extends V> m) {\n    this.sizeCtl = DEFAULT_CAPACITY;\t// \u9ed8\u8ba416\n    putAll(m);\n}\npublic void putAll(Map<? extends K, ? extends V> m) {\n    // \u5c1d\u8bd5\u89e6\u53d1\u6269\u5bb9\n    tryPresize(m.size());\n    for (Entry<? extends K, ? extends V> e : m.entrySet())\n        putVal(e.getKey(), e.getValue(), false);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final void tryPresize(int size) {\n    // \u6269\u5bb9\u4e3a\u5927\u4e8e 2 \u500d\u7684\u6700\u5c0f\u7684 2 \u7684 n \u6b21\u5e42\n    int c = (size >= (MAXIMUM_CAPACITY >>> 1)) ? MAXIMUM_CAPACITY :\n    \ttableSizeFor(size + (size >>> 1) + 1);\n    int sc;\n    while ((sc = sizeCtl) >= 0) {\n        Node<K,V>[] tab = table; int n;\n        // \u6570\u7ec4\u8fd8\u672a\u521d\u59cb\u5316\uff0c\u3010\u4e00\u822c\u662f\u8c03\u7528\u96c6\u5408\u6784\u9020\u65b9\u6cd5\u624d\u4f1a\u6210\u7acb\uff0cput \u540e\u8c03\u7528\u8be5\u65b9\u6cd5\u90fd\u662f\u4e0d\u6210\u7acb\u7684\u3011\n        if (tab == null || (n = tab.length) == 0) {\n            n = (sc > c) ? sc : c;\n            if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {\n                try {\n                    if (table == tab) {\n                        Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];\n                        table = nt;\n                        sc = n - (n >>> 2);// \u6269\u5bb9\u9608\u503c\uff1an - 1/4 n\n                    }\n                } finally {\n                    sizeCtl = sc;\t// \u6269\u5bb9\u9608\u503c\u8d4b\u503c\u7ed9sizeCtl\n                }\n            }\n        }\n        // \u672a\u8fbe\u5230\u6269\u5bb9\u9608\u503c\u6216\u8005\u6570\u7ec4\u957f\u5ea6\u5df2\u7ecf\u5927\u4e8e\u6700\u5927\u957f\u5ea6\n        else if (c <= sc || n >= MAXIMUM_CAPACITY)\n            break;\n        // \u4e0e addCount \u903b\u8f91\u76f8\u540c\n        else if (tab == table) {\n           \n        }\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u65b9\u6cd5-6",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.h5,{id:"\u6570\u636e\u8bbf\u5b58",children:"\u6570\u636e\u8bbf\u5b58"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["tabAt()\uff1a\u83b7\u53d6\u6570\u7ec4\u67d0\u4e2a\u69fd\u4f4d\u7684",(0,r.jsx)(e.strong,{children:"\u5934\u8282\u70b9"}),"\uff0c\u7c7b\u4f3c\u4e8e\u6570\u7ec4\u4e2d\u7684\u76f4\u63a5\u5bfb\u5740 arr[i]"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// i \u662f\u6570\u7ec4\u7d22\u5f15\nstatic final <K,V> Node<K,V> tabAt(Node<K,V>[] tab, int i) {\n    // (i << ASHIFT) + ABASE == ABASE + i * 4 \uff08\u4e00\u4e2a int \u5360 4 \u4e2a\u5b57\u8282\uff09\uff0c\u8fd9\u5c31\u76f8\u5f53\u4e8e\u5bfb\u5740\uff0c\u66ff\u4ee3\u4e86\u4e58\u6cd5\n    return (Node<K,V>)U.getObjectVolatile(tab, ((long)i << ASHIFT) + ABASE);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"casTabAt()\uff1a\u6307\u5b9a\u6570\u7ec4\u7d22\u5f15\u4f4d\u7f6e\u4fee\u6539\u539f\u503c\u4e3a\u6307\u5b9a\u7684\u503c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final <K,V> boolean casTabAt(Node<K,V>[] tab, int i, Node<K,V> c, Node<K,V> v) {\n    return U.compareAndSwapObject(tab, ((long)i << ASHIFT) + ABASE, c, v);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"setTabAt()\uff1a\u6307\u5b9a\u6570\u7ec4\u7d22\u5f15\u4f4d\u7f6e\u8bbe\u7f6e\u503c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final <K,V> void setTabAt(Node<K,V>[] tab, int i, Node<K,V> v) {\n    U.putObjectVolatile(tab, ((long)i << ASHIFT) + ABASE, v);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6dfb\u52a0\u65b9\u6cd5",children:"\u6dfb\u52a0\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public V put(K key, V value) {\n    // \u7b2c\u4e09\u4e2a\u53c2\u6570 onlyIfAbsent \u4e3a false \u8868\u793a\u54c8\u5e0c\u8868\u4e2d\u5b58\u5728\u76f8\u540c\u7684 key \u65f6\u3010\u7528\u5f53\u524d\u6570\u636e\u8986\u76d6\u65e7\u6570\u636e\u3011\n    return putVal(key, value, false);\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"putVal()"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final V putVal(K key, V value, boolean onlyIfAbsent) {\n    // \u3010ConcurrentHashMap \u4e0d\u80fd\u5b58\u653e null \u503c\u3011\n    if (key == null || value == null) throw new NullPointerException();\n    // \u6270\u52a8\u8fd0\u7b97\uff0c\u9ad8\u4f4e\u4f4d\u90fd\u53c2\u4e0e\u5bfb\u5740\u8fd0\u7b97\n    int hash = spread(key.hashCode());\n    // \u8868\u793a\u5f53\u524d k-v \u5c01\u88c5\u6210 node \u540e\u63d2\u5165\u5230\u6307\u5b9a\u6876\u4f4d\u540e\uff0c\u5728\u6876\u4f4d\u4e2d\u7684\u6240\u5c5e\u94fe\u8868\u7684\u4e0b\u6807\u4f4d\u7f6e\n    int binCount = 0;\n    // tab \u5f15\u7528\u5f53\u524d map \u7684\u6570\u7ec4 table\uff0c\u5f00\u59cb\u81ea\u65cb\n    for (Node<K,V>[] tab = table;;) {\n        // f \u8868\u793a\u6876\u4f4d\u7684\u5934\u8282\u70b9\uff0cn \u8868\u793a\u54c8\u5e0c\u8868\u6570\u7ec4\u7684\u957f\u5ea6\n        // i \u8868\u793a key \u901a\u8fc7\u5bfb\u5740\u8ba1\u7b97\u540e\u5f97\u5230\u7684\u6876\u4f4d\u4e0b\u6807\uff0cfh \u8868\u793a\u6876\u4f4d\u5934\u7ed3\u70b9\u7684 hash \u503c\n        Node<K,V> f; int n, i, fh;\n        \n        // \u3010CASE1\u3011\uff1a\u8868\u793a\u5f53\u524d map \u4e2d\u7684 table \u5c1a\u672a\u521d\u59cb\u5316\n        if (tab == null || (n = tab.length) == 0)\n            //\u3010\u5ef6\u8fdf\u521d\u59cb\u5316\u3011\n            tab = initTable();\n        \n        // \u3010CASE2\u3011\uff1ai \u8868\u793a key \u4f7f\u7528\u3010\u5bfb\u5740\u7b97\u6cd5\u3011\u5f97\u5230 key \u5bf9\u5e94\u6570\u7ec4\u7684\u4e0b\u6807\u4f4d\u7f6e\uff0ctabAt \u83b7\u53d6\u6307\u5b9a\u6876\u4f4d\u7684\u5934\u7ed3\u70b9f\n        else if ((f = tabAt(tab, i = (n - 1) & hash)) == null) {\n            // \u5bf9\u5e94\u7684\u6570\u7ec4\u4e3a null \u8bf4\u660e\u6ca1\u6709\u54c8\u5e0c\u51b2\u7a81\uff0c\u76f4\u63a5\u65b0\u5efa\u8282\u70b9\u6dfb\u52a0\u5230\u8868\u4e2d\n            if (casTabAt(tab, i, null, new Node<K,V>(hash, key, value, null)))\n                break;\n        }\n        // \u3010CASE3\u3011\uff1a\u903b\u8f91\u8bf4\u660e\u6570\u7ec4\u5df2\u7ecf\u88ab\u521d\u59cb\u5316\uff0c\u5e76\u4e14\u5f53\u524d key \u5bf9\u5e94\u7684\u4f4d\u7f6e\u4e0d\u4e3a null\n        // \u6761\u4ef6\u6210\u7acb\u8868\u793a\u5f53\u524d\u6876\u4f4d\u7684\u5934\u7ed3\u70b9\u4e3a FWD \u7ed3\u70b9\uff0c\u8868\u793a\u76ee\u524d map \u6b63\u5904\u4e8e\u6269\u5bb9\u8fc7\u7a0b\u4e2d\n        else if ((fh = f.hash) == MOVED)\n            // \u5f53\u524d\u7ebf\u7a0b\u3010\u9700\u8981\u53bb\u5e2e\u52a9\u54c8\u5e0c\u8868\u5b8c\u6210\u6269\u5bb9\u3011\n            tab = helpTransfer(tab, f);\n        \n        // \u3010CASE4\u3011\uff1a\u54c8\u5e0c\u8868\u6ca1\u6709\u5728\u6269\u5bb9\uff0c\u5f53\u524d\u6876\u4f4d\u53ef\u80fd\u662f\u94fe\u8868\u4e5f\u53ef\u80fd\u662f\u7ea2\u9ed1\u6811\n        else {\n            // \u5f53\u63d2\u5165 key \u5b58\u5728\u65f6\uff0c\u4f1a\u5c06\u65e7\u503c\u8d4b\u503c\u7ed9 oldVal \u8fd4\u56de\n            V oldVal = null;\n            // \u3010\u9501\u4f4f\u5f53\u524d key \u5bfb\u5740\u7684\u6876\u4f4d\u7684\u5934\u8282\u70b9\u3011\n            synchronized (f) {\n                // \u8fd9\u91cc\u91cd\u65b0\u83b7\u53d6\u4e00\u4e0b\u6876\u7684\u5934\u8282\u70b9\u6709\u6ca1\u6709\u88ab\u4fee\u6539\uff0c\u56e0\u4e3a\u53ef\u80fd\u88ab\u5176\u4ed6\u7ebf\u7a0b\u4fee\u6539\u8fc7\uff0c\u8fd9\u91cc\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u83b7\u53d6\n                if (tabAt(tab, i) == f) {\n                    // \u3010\u5934\u8282\u70b9\u7684\u54c8\u5e0c\u503c\u5927\u4e8e 0 \u8bf4\u660e\u5f53\u524d\u6876\u4f4d\u662f\u666e\u901a\u7684\u94fe\u8868\u8282\u70b9\u3011\n                    if (fh >= 0) {\n                        // \u5f53\u524d\u7684\u63d2\u5165\u64cd\u4f5c\u6ca1\u51fa\u73b0\u91cd\u590d\u7684 key\uff0c\u8ffd\u52a0\u5230\u94fe\u8868\u7684\u672b\u5c3e\uff0cbinCount\u8868\u793a\u94fe\u8868\u957f\u5ea6 -1\n                        // \u63d2\u5165\u7684key\u4e0e\u94fe\u8868\u4e2d\u7684\u67d0\u4e2a\u5143\u7d20\u7684 key \u4e00\u81f4\uff0c\u53d8\u6210\u66ff\u6362\u64cd\u4f5c\uff0cbinCount \u8868\u793a\u7b2c\u51e0\u4e2a\u8282\u70b9\u51b2\u7a81\n                        binCount = 1;\n                        // \u8fed\u4ee3\u5faa\u73af\u5f53\u524d\u6876\u4f4d\u7684\u94fe\u8868\uff0ce \u662f\u6bcf\u6b21\u5faa\u73af\u5904\u7406\u8282\u70b9\uff0ce \u521d\u59cb\u662f\u5934\u8282\u70b9\n                        for (Node<K,V> e = f;; ++binCount) {\n                            // \u5f53\u524d\u5faa\u73af\u8282\u70b9 key\n                            K ek;\n                            // key \u7684\u54c8\u5e0c\u503c\u4e0e\u5f53\u524d\u8282\u70b9\u7684\u54c8\u5e0c\u4e00\u81f4\uff0c\u5e76\u4e14 key \u7684\u503c\u4e5f\u76f8\u540c\n                            if (e.hash == hash &&\n                                ((ek = e.key) == key ||\n                                 (ek != null && key.equals(ek)))) {\n                                // \u628a\u5f53\u524d\u8282\u70b9\u7684 value \u8d4b\u503c\u7ed9 oldVal\n                                oldVal = e.val;\n                                // \u5141\u8bb8\u8986\u76d6\n                                if (!onlyIfAbsent)\n                                    // \u65b0\u6570\u636e\u8986\u76d6\u65e7\u6570\u636e\n                                    e.val = value;\n                                // \u8df3\u51fa\u5faa\u73af\n                                break;\n                            }\n                            Node<K,V> pred = e;\n                            // \u5982\u679c\u4e0b\u4e00\u4e2a\u8282\u70b9\u4e3a\u7a7a\uff0c\u628a\u6570\u636e\u5c01\u88c5\u6210\u8282\u70b9\u63d2\u5165\u94fe\u8868\u5c3e\u90e8\uff0c\u3010binCount \u4ee3\u8868\u957f\u5ea6 - 1\u3011\n                            if ((e = e.next) == null) {\n                                pred.next = new Node<K,V>(hash, key,\n                                                          value, null);\n                                break;\n                            }\n                        }\n                    }\n                    // \u5f53\u524d\u6876\u4f4d\u5934\u8282\u70b9\u662f\u7ea2\u9ed1\u6811\n                    else if (f instanceof TreeBin) {\n                        Node<K,V> p;\n                        binCount = 2;\n                        if ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,\n                                                              value)) != null) {\n                            oldVal = p.val;\n                            if (!onlyIfAbsent)\n                                p.val = value;\n                        }\n                    }\n                }\n            }\n            \n            // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d\u662f\u94fe\u8868\u6216\u8005\u7ea2\u9ed1\u6811\n            if (binCount != 0) {\n                // \u5982\u679c binCount >= 8 \u8868\u793a\u5904\u7406\u7684\u6876\u4f4d\u4e00\u5b9a\u662f\u94fe\u8868\uff0c\u8bf4\u660e\u957f\u5ea6\u662f 9\n                if (binCount >= TREEIFY_THRESHOLD)\n                    // \u6811\u5316\n                    treeifyBin(tab, i);\n                if (oldVal != null)\n                    return oldVal;\n                break;\n            }\n        }\n    }\n    // \u7edf\u8ba1\u5f53\u524d table \u4e00\u5171\u6709\u591a\u5c11\u6570\u636e\uff0c\u5224\u65ad\u662f\u5426\u8fbe\u5230\u6269\u5bb9\u9608\u503c\u6807\u51c6\uff0c\u89e6\u53d1\u6269\u5bb9\n    // binCount = 0 \u8868\u793a\u5f53\u524d\u6876\u4f4d\u4e3a null\uff0cnode \u53ef\u4ee5\u76f4\u63a5\u653e\u5165\uff0c2 \u8868\u793a\u5f53\u524d\u6876\u4f4d\u5df2\u7ecf\u662f\u7ea2\u9ed1\u6811\n    addCount(1L, binCount);\n    return null;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"spread()\uff1a\u6270\u52a8\u51fd\u6570"}),"\n",(0,r.jsxs)(e.p,{children:["\u5c06 hashCode \u65e0\u7b26\u53f7\u53f3\u79fb 16 \u4f4d\uff0c\u9ad8 16bit \u548c\u4f4e 16bit \u505a\u5f02\u6216\uff0c\u6700\u540e\u4e0e HASH_BITS \u76f8\u4e0e\u53d8\u6210\u6b63\u6570\uff0c",(0,r.jsx)(e.strong,{children:"\u4e0e\u6811\u5316\u8282\u70b9\u548c\u8f6c\u79fb\u8282\u70b9\u533a\u5206"}),"\uff0c\u628a\u9ad8\u4f4e\u4f4d\u90fd\u5229\u7528\u8d77\u6765\u51cf\u5c11\u54c8\u5e0c\u51b2\u7a81\uff0c\u4fdd\u8bc1\u6563\u5217\u7684\u5747\u5300\u6027"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final int spread(int h) {\n    return (h ^ (h >>> 16)) & HASH_BITS; // 0111 1111 1111 1111 1111 1111 1111 1111\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initTable()\uff1a\u521d\u59cb\u5316\u6570\u7ec4\uff0c\u5ef6\u8fdf\u521d\u59cb\u5316"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final Node<K,V>[] initTable() {\n    // tab \u5f15\u7528 map.table\uff0csc \u5f15\u7528 sizeCtl\n    Node<K,V>[] tab; int sc;\n    // table \u5c1a\u672a\u521d\u59cb\u5316\uff0c\u5f00\u59cb\u81ea\u65cb\n    while ((tab = table) == null || tab.length == 0) {\n        // sc < 0 \u8bf4\u660e table \u6b63\u5728\u521d\u59cb\u5316\u6216\u8005\u6b63\u5728\u6269\u5bb9\uff0c\u5f53\u524d\u7ebf\u7a0b\u53ef\u4ee5\u91ca\u653e CPU \u8d44\u6e90\n        if ((sc = sizeCtl) < 0)\n            Thread.yield();\n        // sizeCtl \u8bbe\u7f6e\u4e3a -1\uff0c\u76f8\u5f53\u4e8e\u52a0\u9501\uff0c\u3010\u8bbe\u7f6e\u7684\u662f SIZECTL \u4f4d\u7f6e\u7684\u6570\u636e\u3011\uff0c\n        // \u56e0\u4e3a\u662f sizeCtl \u662f\u57fa\u672c\u7c7b\u578b\uff0c\u4e0d\u662f\u5f15\u7528\u7c7b\u578b\uff0c\u6240\u4ee5 sc \u4fdd\u5b58\u7684\u662f\u6570\u636e\u7684\u526f\u672c\n        else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {\n            try {\n                // \u7ebf\u7a0b\u5b89\u5168\u7684\u903b\u8f91\uff0c\u518d\u8fdb\u884c\u4e00\u6b21\u5224\u65ad\n                if ((tab = table) == null || tab.length == 0) {\n                    // sc > 0 \u521b\u5efa table \u65f6\u4f7f\u7528 sc \u4e3a\u6307\u5b9a\u5927\u5c0f\uff0c\u5426\u5219\u4f7f\u7528 16 \u9ed8\u8ba4\u503c\n                    int n = (sc > 0) ? sc : DEFAULT_CAPACITY;\n                    // \u521b\u5efa\u54c8\u5e0c\u8868\u6570\u7ec4\n                    Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];\n                    table = tab = nt;\n                    // \u6269\u5bb9\u9608\u503c\uff0cn >>> 2  => \u7b49\u4e8e 1/4 n \uff0cn - (1/4)n = 3/4 n => 0.75 * n\n                    sc = n - (n >>> 2);\n                }\n            } finally {\n                // \u89e3\u9501\uff0c\u628a\u4e0b\u4e00\u6b21\u6269\u5bb9\u7684\u9608\u503c\u8d4b\u503c\u7ed9 sizeCtl\n                sizeCtl = sc;\n            }\n            break;\n        }\n    }\n    return tab;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"treeifyBin()\uff1a\u6811\u5316\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final void treeifyBin(Node<K,V>[] tab, int index) {\n    Node<K,V> b; int n, sc;\n    if (tab != null) {\n        // \u6761\u4ef6\u6210\u7acb\uff1a\u3010\u8bf4\u660e\u5f53\u524d table \u6570\u7ec4\u957f\u5ea6\u672a\u8fbe\u5230 64\uff0c\u6b64\u65f6\u4e0d\u8fdb\u884c\u6811\u5316\u64cd\u4f5c\uff0c\u8fdb\u884c\u6269\u5bb9\u64cd\u4f5c\u3011\n        if ((n = tab.length) < MIN_TREEIFY_CAPACITY)\n            // \u5f53\u524d\u5bb9\u91cf\u7684 2 \u500d\n            tryPresize(n << 1);\n\n        // \u6761\u4ef6\u6210\u7acb\uff1a\u8bf4\u660e\u5f53\u524d\u6876\u4f4d\u6709\u6570\u636e\uff0c\u4e14\u662f\u666e\u901a node \u6570\u636e\u3002\n        else if ((b = tabAt(tab, index)) != null && b.hash >= 0) {\n            // \u3010\u6811\u5316\u52a0\u9501\u3011\n            synchronized (b) {\n                // \u6761\u4ef6\u6210\u7acb\uff1a\u8868\u793a\u52a0\u9501\u6ca1\u95ee\u9898\u3002\n                if (tabAt(tab, index) == b) {\n                    TreeNode<K,V> hd = null, tl = null;\n                    for (Node<K,V> e = b; e != null; e = e.next) {\n                        TreeNode<K,V> p = new TreeNode<K,V>(e.hash, e.key, e.val,null, null);\n                        if ((p.prev = tl) == null)\n                            hd = p;\n                        else\n                            tl.next = p;\n                        tl = p;\n                    }\n                    setTabAt(tab, index, new TreeBin<K,V>(hd));\n                }\n            }\n        }\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["addCount()\uff1a\u6dfb\u52a0\u8ba1\u6570\uff0c",(0,r.jsx)(e.strong,{children:"\u4ee3\u8868\u54c8\u5e0c\u8868\u4e2d\u7684\u6570\u636e\u603b\u91cf"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final void addCount(long x, int check) {\n    // \u3010\u4e0a\u9762\u8fd9\u90e8\u5206\u7684\u903b\u8f91\u5c31\u662f LongAdder \u7684\u7d2f\u52a0\u903b\u8f91\u3011\n    CounterCell[] as; long b, s;\n    // \u5224\u65ad\u7d2f\u52a0\u6570\u7ec4 cells \u662f\u5426\u521d\u59cb\u5316\uff0c\u6ca1\u6709\u5c31\u53bb\u7d2f\u52a0 base \u57df\uff0c\u7d2f\u52a0\u5931\u8d25\u8fdb\u5165\u6761\u4ef6\u5185\u903b\u8f91\n    if ((as = counterCells) != null ||\n        !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) {\n        CounterCell a; long v; int m;\n        // true \u672a\u7ade\u4e89\uff0cfalse \u53d1\u751f\u7ade\u4e89\n        boolean uncontended = true;\n        // \u5224\u65ad cells \u662f\u5426\u88ab\u5176\u4ed6\u7ebf\u7a0b\u521d\u59cb\u5316\n        if (as == null || (m = as.length - 1) < 0 ||\n            // \u524d\u9762\u7684\u6761\u4ef6\u4e3a fasle \u8bf4\u660e cells \u88ab\u5176\u4ed6\u7ebf\u7a0b\u521d\u59cb\u5316\uff0c\u901a\u8fc7 hash \u5bfb\u5740\u5bf9\u5e94\u7684\u69fd\u4f4d\n            (a = as[ThreadLocalRandom.getProbe() & m]) == null ||\n            // \u5c1d\u8bd5\u53bb\u5bf9\u5e94\u7684\u69fd\u4f4d\u7d2f\u52a0\uff0c\u7d2f\u52a0\u5931\u8d25\u8fdb\u5165 fullAddCount \u8fdb\u884c\u91cd\u8bd5\u6216\u8005\u6269\u5bb9\n            !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {\n            // \u4e0e Striped64#longAccumulate \u65b9\u6cd5\u76f8\u540c\n            fullAddCount(x, uncontended);\n            return;\n        }\n        // \u8868\u793a\u5f53\u524d\u6876\u4f4d\u662f null\uff0c\u6216\u8005\u4e00\u4e2a\u94fe\u8868\u8282\u70b9\n        if (check <= 1)\t\n            return;\n    \t// \u3010\u83b7\u53d6\u5f53\u524d\u6563\u5217\u8868\u5143\u7d20\u4e2a\u6570\u3011\uff0c\u8fd9\u662f\u4e00\u4e2a\u671f\u671b\u503c\n        s = sumCount();\n    }\n    \n    // \u8868\u793a\u4e00\u5b9a \u3010\u662f\u4e00\u4e2a put \u64cd\u4f5c\u8c03\u7528\u7684 addCount\u3011\n    if (check >= 0) {\n        Node<K,V>[] tab, nt; int n, sc;\n        \n        // \u6761\u4ef6\u4e00\uff1atrue \u8bf4\u660e\u5f53\u524d sizeCtl \u53ef\u80fd\u4e3a\u4e00\u4e2a\u8d1f\u6570\u8868\u793a\u6b63\u5728\u6269\u5bb9\u4e2d\uff0c\u6216\u8005 sizeCtl \u662f\u4e00\u4e2a\u6b63\u6570\uff0c\u8868\u793a\u6269\u5bb9\u9608\u503c\n        //        false \u8868\u793a\u54c8\u5e0c\u8868\u7684\u6570\u636e\u7684\u6570\u91cf\u6ca1\u8fbe\u5230\u6269\u5bb9\u6761\u4ef6\n        // \u7136\u540e\u5224\u65ad\u5f53\u524d table \u6570\u7ec4\u662f\u5426\u521d\u59cb\u5316\u4e86\uff0c\u5f53\u524d table \u957f\u5ea6\u662f\u5426\u5c0f\u4e8e\u6700\u5927\u503c\u9650\u5236\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u6269\u5bb9\n        while (s >= (long)(sc = sizeCtl) && (tab = table) != null &&\n               (n = tab.length) < MAXIMUM_CAPACITY) {\n            // 16 -> 32 \u6269\u5bb9 \u6807\u8bc6\u4e3a\uff1a1000 0000 0001 1011\uff0c\u3010\u8d1f\u6570\uff0c\u6269\u5bb9\u6279\u6b21\u552f\u4e00\u6807\u8bc6\u6233\u3011\n            int rs = resizeStamp(n);\n            \n            // \u8868\u793a\u5f53\u524d table\uff0c\u3010\u6b63\u5728\u6269\u5bb9\u3011\uff0csc \u9ad8 16 \u4f4d\u662f\u6269\u5bb9\u6807\u8bc6\u6233\uff0c\u4f4e 16 \u4f4d\u662f\u7ebf\u7a0b\u6570 + 1\n            if (sc < 0) {\n                // \u6761\u4ef6\u4e00\uff1a\u5224\u65ad\u6269\u5bb9\u6807\u8bc6\u6233\u662f\u5426\u4e00\u6837\uff0cfasle \u4ee3\u8868\u4e00\u6837\n                // \u52d8\u8bef\u4e24\u4e2a\u6761\u4ef6\uff1a\n                // \u6761\u4ef6\u4e8c\u662f\uff1asc == (rs << 16 ) + 1\uff0ctrue \u4ee3\u8868\u6269\u5bb9\u5b8c\u6210\uff0c\u56e0\u4e3a\u4f4e16\u4f4d\u662f1\u4ee3\u8868\u6ca1\u6709\u7ebf\u7a0b\u6269\u5bb9\u4e86\n                // \u6761\u4ef6\u4e09\u662f\uff1asc == (rs << 16) + MAX_RESIZERS\uff0c\u5224\u65ad\u662f\u5426\u5df2\u7ecf\u8d85\u8fc7\u6700\u5927\u5141\u8bb8\u7684\u5e76\u53d1\u6269\u5bb9\u7ebf\u7a0b\u6570\n                // \u6761\u4ef6\u56db\uff1a\u5224\u65ad\u65b0\u8868\u7684\u5f15\u7528\u662f\u5426\u662f null\uff0c\u4ee3\u8868\u6269\u5bb9\u5b8c\u6210\n                // \u6761\u4ef6\u4e94\uff1a\u3010\u6269\u5bb9\u662f\u4ece\u9ad8\u4f4d\u5230\u4f4e\u4f4d\u8f6c\u79fb\u3011\uff0ctransferIndex < 0 \u8bf4\u660e\u6ca1\u6709\u533a\u95f4\u9700\u8981\u6269\u5bb9\u4e86\n                if ((sc >>> RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||\n                    sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||\n                    transferIndex <= 0)\n                    break;\n                \n                // \u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u53c2\u4e0e\u5230\u6269\u5bb9\u4efb\u52a1\u4e2d\uff0c\u5c06 sc \u4f4e 16 \u4f4d\u503c\u52a0 1\uff0c\u8868\u793a\u591a\u4e00\u4e2a\u7ebf\u7a0b\u53c2\u4e0e\u6269\u5bb9\n                // \u8bbe\u7f6e\u5931\u8d25\u5176\u4ed6\u7ebf\u7a0b\u6216\u8005 transfer \u5185\u90e8\u4fee\u6539\u4e86 sizeCtl \u503c\n                if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))\n                    //\u3010\u534f\u52a9\u6269\u5bb9\u7ebf\u7a0b\u3011\uff0c\u6301\u6709nextTable\u53c2\u6570\n                    transfer(tab, nt);\n            }\n            // \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u5f53\u524d\u7ebf\u7a0b\u662f\u89e6\u53d1\u6269\u5bb9\u7684\u7b2c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u7ebf\u7a0b\u6570\u91cf + 2\n            // 1000 0000 0001 1011 0000 0000 0000 0000 +2 => 1000 0000 0001 1011 0000 0000 0000 0010\n            else if (U.compareAndSwapInt(this, SIZECTL, sc,(rs << RESIZE_STAMP_SHIFT) + 2))\n                //\u3010\u89e6\u53d1\u6269\u5bb9\u6761\u4ef6\u7684\u7ebf\u7a0b\u3011\uff0c\u4e0d\u6301\u6709 nextTable\uff0c\u521d\u59cb\u7ebf\u7a0b\u4f1a\u65b0\u5efa nextTable\n                transfer(tab, null);\n            s = sumCount();\n        }\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["resizeStamp()\uff1a\u6269\u5bb9\u6807\u8bc6\u7b26\uff0c",(0,r.jsx)(e.strong,{children:"\u6bcf\u6b21\u6269\u5bb9\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\uff0c\u4e0d\u662f\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u4ea7\u751f"}),"\uff0c16 \u6269\u5bb9\u5230 32 \u4ea7\u751f\u4e00\u4e2a\uff0c32 \u6269\u5bb9\u5230 64 \u4ea7\u751f\u4e00\u4e2a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"/**\n * \u6269\u5bb9\u7684\u6807\u8bc6\u7b26\n * 16 -> 32 \u4ece16\u6269\u5bb9\u523032\n * numberOfLeadingZeros(16) => 1 0000 => 32 - 5 = 27 => 0000 0000 0001 1011\n * (1 << (RESIZE_STAMP_BITS - 1)) => 1000 0000 0000 0000 => 32768\n * ---------------------------------------------------------------\n * 0000 0000 0001 1011\n * 1000 0000 0000 0000\n * 1000 0000 0001 1011\n * \u6c38\u8fdc\u662f\u8d1f\u6570\n */\nstatic final int resizeStamp(int n) {\n    // \u6216\u8fd0\u7b97\n    return Integer.numberOfLeadingZeros(n) | (1 << (RESIZE_STAMP_BITS - 1)); // (16 -1 = 15)\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6269\u5bb9\u65b9\u6cd5",children:"\u6269\u5bb9\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u6269\u5bb9\u673a\u5236\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53\u94fe\u8868\u4e2d\u5143\u7d20\u4e2a\u6570\u8d85\u8fc7 8 \u4e2a\uff0c\u6570\u7ec4\u7684\u5927\u5c0f\u8fd8\u672a\u8d85\u8fc7 64 \u65f6\uff0c\u6b64\u65f6\u8fdb\u884c\u6570\u7ec4\u7684\u6269\u5bb9\uff0c\u5982\u679c\u8d85\u8fc7\u5219\u5c06\u94fe\u8868\u8f6c\u5316\u6210\u7ea2\u9ed1\u6811"}),"\n",(0,r.jsx)(e.li,{children:"put \u6570\u636e\u540e\u8c03\u7528 addCount() \u65b9\u6cd5\uff0c\u5224\u65ad\u5f53\u524d\u54c8\u5e0c\u8868\u7684\u5bb9\u91cf\u8d85\u8fc7\u9608\u503c sizeCtl\uff0c\u8d85\u8fc7\u8fdb\u884c\u6269\u5bb9"}),"\n",(0,r.jsx)(e.li,{children:"\u589e\u5220\u6539\u7ebf\u7a0b\u53d1\u73b0\u5176\u4ed6\u7ebf\u7a0b\u6b63\u5728\u6269\u5bb9\uff0c\u5e2e\u5176\u6269\u5bb9"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u89c1\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"transfer()\uff1a\u6570\u636e\u8f6c\u79fb\u5230\u65b0\u8868\u4e2d\uff0c\u5b8c\u6210\u6269\u5bb9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private final void transfer(Node<K,V>[] tab, Node<K,V>[] nextTab) {\n    // n \u8868\u793a\u6269\u5bb9\u4e4b\u524d table \u6570\u7ec4\u7684\u957f\u5ea6\n    int n = tab.length, stride;\n    // stride \u8868\u793a\u5206\u914d\u7ed9\u7ebf\u7a0b\u4efb\u52a1\u7684\u6b65\u957f\uff0c\u9ed8\u8ba4\u5c31\u662f 16 \n    if ((stride = (NCPU > 1) ? (n >>> 3) / NCPU : n) < MIN_TRANSFER_STRIDE)\n        stride = MIN_TRANSFER_STRIDE;\n    // \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u4e3a\u89e6\u53d1\u672c\u6b21\u6269\u5bb9\u7684\u7ebf\u7a0b\uff0c\u9700\u8981\u505a\u4e00\u4e9b\u6269\u5bb9\u51c6\u5907\u5de5\u4f5c\uff0c\u3010\u534f\u52a9\u7ebf\u7a0b\u4e0d\u505a\u8fd9\u4e00\u6b65\u3011\n    if (nextTab == null) {\n        try {\n            // \u521b\u5efa\u4e00\u4e2a\u5bb9\u91cf\u662f\u4e4b\u524d\u3010\u4e8c\u500d\u7684 table \u6570\u7ec4\u3011\n            Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n << 1];\n            nextTab = nt;\n        } catch (Throwable ex) {\n            sizeCtl = Integer.MAX_VALUE;\n            return;\n        }\n        // \u628a\u65b0\u8868\u8d4b\u503c\u7ed9\u5bf9\u8c61\u5c5e\u6027 nextTable\uff0c\u65b9\u4fbf\u5176\u4ed6\u7ebf\u7a0b\u83b7\u53d6\u65b0\u8868\n        nextTable = nextTab;\n        // \u8bb0\u5f55\u8fc1\u79fb\u6570\u636e\u6574\u4f53\u4f4d\u7f6e\u7684\u4e00\u4e2a\u6807\u8bb0\uff0ctransferIndex \u8ba1\u6570\u4ece1\u5f00\u59cb\u4e0d\u662f 0\uff0c\u6240\u4ee5\u8fd9\u91cc\u662f\u957f\u5ea6\uff0c\u4e0d\u662f\u957f\u5ea6-1\n        transferIndex = n;\n    }\n    // \u65b0\u6570\u7ec4\u7684\u957f\u5ea6\n    int nextn = nextTab.length;\n    // \u5f53\u67d0\u4e2a\u6876\u4f4d\u6570\u636e\u5904\u7406\u5b8c\u6bd5\u540e\uff0c\u5c06\u6b64\u6876\u4f4d\u8bbe\u7f6e\u4e3a fwd \u8282\u70b9\uff0c\u5176\u5b83\u5199\u7ebf\u7a0b\u6216\u8bfb\u7ebf\u7a0b\u770b\u5230\u540e\uff0c\u53ef\u4ee5\u4ece\u4e2d\u83b7\u53d6\u5230\u65b0\u8868\n    ForwardingNode<K,V> fwd = new ForwardingNode<K,V>(nextTab);\n    // \u63a8\u8fdb\u6807\u8bb0\n    boolean advance = true;\n    // \u5b8c\u6210\u6807\u8bb0\n    boolean finishing = false;\n    \n    // i \u8868\u793a\u5206\u914d\u7ed9\u5f53\u524d\u7ebf\u7a0b\u4efb\u52a1\uff0c\u6267\u884c\u5230\u7684\u6876\u4f4d\n    // bound \u8868\u793a\u5206\u914d\u7ed9\u5f53\u524d\u7ebf\u7a0b\u4efb\u52a1\u7684\u4e0b\u754c\u9650\u5236\uff0c\u56e0\u4e3a\u662f\u5012\u5e8f\u8fc1\u79fb\uff0c16 \u8fc1\u79fb\u5b8c \u8fc1\u79fb 15\uff0c15\u5b8c\u6210\u53bb\u8fc1\u79fb14\n    for (int i = 0, bound = 0;;) {\n        Node<K,V> f; int fh;\n        \n        // \u7ed9\u5f53\u524d\u7ebf\u7a0b\u3010\u5206\u914d\u4efb\u52a1\u533a\u95f4\u3011\n        while (advance) {\n            // \u5206\u914d\u4efb\u52a1\u7684\u5f00\u59cb\u4e0b\u6807\uff0c\u5206\u914d\u4efb\u52a1\u7684\u7ed3\u675f\u4e0b\u6807\n            int nextIndex, nextBound;\n         \n            // --i \u8ba9\u5f53\u524d\u7ebf\u7a0b\u5904\u7406\u4e0b\u4e00\u4e2a\u7d22\u5f15\uff0ctrue\u8bf4\u660e\u5f53\u524d\u7684\u8fc1\u79fb\u4efb\u52a1\u5c1a\u672a\u5b8c\u6210\uff0cfalse\u8bf4\u660e\u7ebf\u7a0b\u5df2\u7ecf\u5b8c\u6210\u6216\u8005\u8fd8\u672a\u5206\u914d\n            if (--i >= bound || finishing)\n                advance = false;\n            // \u8fc1\u79fb\u7684\u5f00\u59cb\u4e0b\u6807\uff0c\u5c0f\u4e8e0\u8bf4\u660e\u6ca1\u6709\u533a\u95f4\u9700\u8981\u8fc1\u79fb\u4e86\uff0c\u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u7684 i \u53d8\u91cf\u4e3a -1 \u8df3\u51fa\u5faa\u73af\n            else if ((nextIndex = transferIndex) <= 0) {\n                i = -1;\n                advance = false;\n            }\n            // \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u8fd8\u6709\u533a\u95f4\u9700\u8981\u5206\u914d\uff0c\u7136\u540e\u7ed9\u5f53\u524d\u7ebf\u7a0b\u5206\u914d\u4efb\u52a1\uff0c\n            else if (U.compareAndSwapInt(this, TRANSFERINDEX, nextIndex,\n                      // \u5224\u65ad\u533a\u95f4\u662f\u5426\u8fd8\u591f\u4e00\u4e2a\u6b65\u957f\uff0c\u4e0d\u591f\u5c31\u5168\u90e8\u5206\u914d\n                      nextBound = (nextIndex > stride ? nextIndex - stride : 0))) {\n                // \u5f53\u524d\u7ebf\u7a0b\u7684\u7ed3\u675f\u4e0b\u6807\n                bound = nextBound;\n                // \u5f53\u524d\u7ebf\u7a0b\u7684\u5f00\u59cb\u4e0b\u6807\uff0c\u4e0a\u4e00\u4e2a\u7ebf\u7a0b\u7ed3\u675f\u7684\u4e0b\u6807\u7684\u4e0b\u4e00\u4e2a\u7d22\u5f15\u5c31\u662f\u8fd9\u4e2a\u7ebf\u7a0b\u5f00\u59cb\u7684\u4e0b\u6807\n                i = nextIndex - 1;\n                // \u4efb\u52a1\u5206\u914d\u7ed3\u675f\uff0c\u8df3\u51fa\u5faa\u73af\u6267\u884c\u8fc1\u79fb\u64cd\u4f5c\n                advance = false;\n            }\n        }\n        \n        // \u3010\u5206\u914d\u5b8c\u6210\uff0c\u5f00\u59cb\u6570\u636e\u8fc1\u79fb\u64cd\u4f5c\u3011\n        // \u3010CASE1\u3011\uff1ai < 0 \u6210\u7acb\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u672a\u5206\u914d\u5230\u4efb\u52a1\uff0c\u6216\u8005\u4efb\u52a1\u6267\u884c\u5b8c\u4e86\n        if (i < 0 || i >= n || i + n >= nextn) {\n            int sc;\n            // \u5982\u679c\u8fc1\u79fb\u5b8c\u6210\n            if (finishing) {\n                nextTable = null;\t// help GC\n                table = nextTab;\t// \u65b0\u8868\u8d4b\u503c\u7ed9\u5f53\u524d\u5bf9\u8c61\n                sizeCtl = (n << 1) - (n >>> 1);// \u6269\u5bb9\u9608\u503c\u4e3a 2n - n/2 = 3n/2 = 0.75*(2n)\n                return;\n            }\n            // \u5f53\u524d\u7ebf\u7a0b\u5b8c\u6210\u4e86\u5206\u914d\u7684\u4efb\u52a1\u533a\u95f4\uff0c\u53ef\u4ee5\u9000\u51fa\uff0c\u5148\u628a sizeCtl \u8d4b\u503c\u7ed9 sc \u4fdd\u7559\n            if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) {\n                // \u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u662f\u4e0d\u662f\u6700\u540e\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e0d\u662f\u7684\u8bdd\u76f4\u63a5 return\uff0c\n                if ((sc - 2) != resizeStamp(n) << RESIZE_STAMP_SHIFT)\n                    return;\n                // \u6240\u4ee5\u6700\u540e\u4e00\u4e2a\u7ebf\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0csizeCtl \u7684\u4f4e 16 \u4f4d\u4e3a 1\n                finishing = advance = true;\n                // \u3010\u8fd9\u91cc\u8868\u793a\u6700\u540e\u4e00\u4e2a\u7ebf\u7a0b\u9700\u8981\u91cd\u65b0\u68c0\u67e5\u4e00\u904d\u662f\u5426\u6709\u6f0f\u6389\u7684\u533a\u95f4\u3011\n                i = n;\n            }\n        }\n        \n        // \u3010CASE2\u3011\uff1a\u5f53\u524d\u6876\u4f4d\u672a\u5b58\u653e\u6570\u636e\uff0c\u53ea\u9700\u8981\u5c06\u6b64\u5904\u8bbe\u7f6e\u4e3a fwd \u8282\u70b9\u5373\u53ef\u3002\n        else if ((f = tabAt(tab, i)) == null)\n            advance = casTabAt(tab, i, null, fwd);\n        // \u3010CASE3\u3011\uff1a\u8bf4\u660e\u5f53\u524d\u6876\u4f4d\u5df2\u7ecf\u8fc1\u79fb\u8fc7\u4e86\uff0c\u5f53\u524d\u7ebf\u7a0b\u4e0d\u7528\u518d\u5904\u7406\u4e86\uff0c\u76f4\u63a5\u5904\u7406\u4e0b\u4e00\u4e2a\u6876\u4f4d\u5373\u53ef\n        else if ((fh = f.hash) == MOVED)\n            advance = true; \n        // \u3010CASE4\u3011\uff1a\u5f53\u524d\u6876\u4f4d\u6709\u6570\u636e\uff0c\u800c\u4e14 node \u8282\u70b9\u4e0d\u662f fwd \u8282\u70b9\uff0c\u8bf4\u660e\u8fd9\u4e9b\u6570\u636e\u9700\u8981\u8fc1\u79fb\n        else {\n            // \u3010\u9501\u4f4f\u5934\u8282\u70b9\u3011\n            synchronized (f) {\n                // \u4e8c\u6b21\u68c0\u67e5\uff0c\u9632\u6b62\u5934\u8282\u70b9\u5df2\u7ecf\u88ab\u4fee\u6539\u4e86\uff0c\u56e0\u4e3a\u8fd9\u91cc\u624d\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u8bbf\u95ee\n                if (tabAt(tab, i) == f) {\n                    // \u3010\u8fc1\u79fb\u6570\u636e\u7684\u903b\u8f91\uff0c\u548c HashMap \u76f8\u4f3c\u3011\n                        \n                    // ln \u8868\u793a\u4f4e\u4f4d\u94fe\u8868\u5f15\u7528\n                    // hn \u8868\u793a\u9ad8\u4f4d\u94fe\u8868\u5f15\u7528\n                    Node<K,V> ln, hn;\n                    // \u54c8\u5e0c > 0 \u8868\u793a\u5f53\u524d\u6876\u4f4d\u662f\u94fe\u8868\u6876\u4f4d\n                    if (fh >= 0) {\n                        // \u548c HashMap \u7684\u5904\u7406\u65b9\u5f0f\u4e00\u81f4\uff0c\u4e0e\u8001\u6570\u7ec4\u957f\u5ea6\u76f8\u4e0e\uff0c16 \u662f 10000\n                        // \u5224\u65ad\u5bf9\u5e94\u7684 1 \u7684\u4f4d\u7f6e\u4e0a\u662f 0 \u6216 1 \u5206\u6210\u9ad8\u4f4e\u4f4d\u94fe\u8868\n                        int runBit = fh & n;\n                        Node<K,V> lastRun = f;\n                        // \u904d\u5386\u94fe\u8868\uff0c\u5bfb\u627e\u3010\u9006\u5e8f\u770b\u3011\u6700\u957f\u7684\u5bf9\u5e94\u4f4d\u76f8\u540c\u7684\u94fe\u8868\uff0c\u770b\u4e0b\u9762\u7684\u56fe\u66f4\u597d\u7684\u7406\u89e3\n                        for (Node<K,V> p = f.next; p != null; p = p.next) {\n                            // \u5c06\u5f53\u524d\u8282\u70b9\u7684\u54c8\u5e0c \u4e0e n\n                            int b = p.hash & n;\n                            // \u5982\u679c\u5f53\u524d\u503c\u4e0e\u524d\u9762\u8282\u70b9\u7684\u503c \u5bf9\u5e94\u4f4d \u4e0d\u540c\uff0c\u5219\u4fee\u6539 runBit\uff0c\u628a lastRun \u6307\u5411\u5f53\u524d\u8282\u70b9\n                            if (b != runBit) {\n                                runBit = b;\n                                lastRun = p;\n                            }\n                        }\n                        // \u5224\u65ad\u7b5b\u9009\u51fa\u7684\u94fe\u8868\u662f\u4f4e\u4f4d\u7684\u8fd8\u662f\u9ad8\u4f4d\u7684\n                        if (runBit == 0) {\n                            ln = lastRun;\t// ln \u6307\u5411\u8be5\u94fe\u8868\n                            hn = null;\t\t// hn \u4e3a null\n                        }\n                        // \u8bf4\u660e lastRun \u5f15\u7528\u7684\u94fe\u8868\u4e3a\u9ad8\u4f4d\u94fe\u8868\uff0c\u5c31\u8ba9 hn \u6307\u5411\u9ad8\u4f4d\u94fe\u8868\u5934\u8282\u70b9\n                        else {\n                            hn = lastRun;\n                            ln = null;\n                        }\n                        // \u4ece\u5934\u5f00\u59cb\u904d\u5386\u6240\u6709\u7684\u94fe\u8868\u8282\u70b9\uff0c\u8fed\u4ee3\u5230 p == lastRun \u8282\u70b9\u8df3\u51fa\u5faa\u73af\n                        for (Node<K,V> p = f; p != lastRun; p = p.next) {\n                            int ph = p.hash; K pk = p.key; V pv = p.val;\n                            if ((ph & n) == 0)\n                                // \u3010\u5934\u63d2\u6cd5\u3011\uff0c\u4ece\u53f3\u5f80\u5de6\u770b\uff0c\u9996\u5148 ln \u6307\u5411\u7684\u662f\u4e0a\u4e00\u4e2a\u8282\u70b9\uff0c\n                                // \u6240\u4ee5\u8fd9\u6b21\u65b0\u5efa\u7684\u8282\u70b9\u7684 next \u6307\u5411\u4e0a\u4e00\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u66f4\u65b0 ln \u7684\u5f15\u7528\n                                ln = new Node<K,V>(ph, pk, pv, ln);\n                            else\n                                hn = new Node<K,V>(ph, pk, pv, hn);\n                        }\n                        // \u9ad8\u4f4e\u4f4d\u94fe\u8bbe\u7f6e\u5230\u65b0\u8868\u4e2d\u7684\u6307\u5b9a\u4f4d\u7f6e\n                        setTabAt(nextTab, i, ln);\n                        setTabAt(nextTab, i + n, hn);\n                        // \u8001\u8868\u4e2d\u7684\u8be5\u6876\u4f4d\u8bbe\u7f6e\u4e3a fwd \u8282\u70b9\n                        setTabAt(tab, i, fwd);\n                        advance = true;\n                    }\n                    // \u6761\u4ef6\u6210\u7acb\uff1a\u8868\u793a\u5f53\u524d\u6876\u4f4d\u662f \u7ea2\u9ed1\u6811\u7ed3\u70b9\n                    else if (f instanceof TreeBin) {\n                        TreeBin<K,V> t = (TreeBin<K,V>)f;\n                        TreeNode<K,V> lo = null, loTail = null;\n                        TreeNode<K,V> hi = null, hiTail = null;\n                        int lc = 0, hc = 0;\n                        // \u8fed\u4ee3 TreeBin \u4e2d\u7684\u53cc\u5411\u94fe\u8868\uff0c\u4ece\u5934\u7ed3\u70b9\u81f3\u5c3e\u8282\u70b9\n                        for (Node<K,V> e = t.first; e != null; e = e.next) {\n                            // \u8fed\u4ee3\u7684\u5f53\u524d\u5143\u7d20\u7684 hash\n                            int h = e.hash;\n                            TreeNode<K,V> p = new TreeNode<K,V>\n                                (h, e.key, e.val, null, null);\n                            // \u6761\u4ef6\u6210\u7acb\u8868\u793a\u5f53\u524d\u5faa\u73af\u8282\u70b9\u5c5e\u4e8e\u4f4e\u4f4d\u94fe\u8282\u70b9\n                            if ((h & n) == 0) {\n                                if ((p.prev = loTail) == null)\n                                    lo = p;\n                                else\n                                    //\u3010\u5c3e\u63d2\u6cd5\u3011\n                                    loTail.next = p;\n                                // loTail \u6307\u5411\u5c3e\u8282\u70b9\n                                loTail = p;\n                                ++lc;\n                            }\n                            else {\n                                if ((p.prev = hiTail) == null)\n                                    hi = p;\n                                else\n                                    hiTail.next = p;\n                                hiTail = p;\n                                ++hc;\n                            }\n                        }\n                        // \u62c6\u6210\u7684\u9ad8\u4f4d\u4f4e\u4f4d\u4e24\u4e2a\u94fe\uff0c\u3010\u5224\u65ad\u662f\u5426\u9700\u8981\u9700\u8981\u8f6c\u5316\u4e3a\u94fe\u8868\u3011\uff0c\u53cd\u4e4b\u4fdd\u6301\u6811\u5316\n                        ln = (lc <= UNTREEIFY_THRESHOLD) ? untreeify(lo) :\n                        (hc != 0) ? new TreeBin<K,V>(lo) : t;\n                        hn = (hc <= UNTREEIFY_THRESHOLD) ? untreeify(hi) :\n                        (lc != 0) ? new TreeBin<K,V>(hi) : t;\n                        setTabAt(nextTab, i, ln);\n                        setTabAt(nextTab, i + n, hn);\n                        setTabAt(tab, i, fwd);\n                        advance = true;\n                    }\n                }\n            }\n        }\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u94fe\u8868\u5904\u7406\u7684 LastRun \u673a\u5236\uff0c",(0,r.jsx)(e.strong,{children:"\u53ef\u4ee5\u51cf\u5c11\u8282\u70b9\u7684\u521b\u5efa"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(56200).A+"",width:"1488",height:"526"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"helpTransfer()\uff1a\u5e2e\u52a9\u6269\u5bb9\u673a\u5236"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final Node<K,V>[] helpTransfer(Node<K,V>[] tab, Node<K,V> f) {\n    Node<K,V>[] nextTab; int sc;\n    // \u6570\u7ec4\u4e0d\u4e3a\u7a7a\uff0c\u8282\u70b9\u662f\u8f6c\u53d1\u8282\u70b9\uff0c\u83b7\u53d6\u8f6c\u53d1\u8282\u70b9\u6307\u5411\u7684\u65b0\u8868\u5f00\u59cb\u534f\u52a9\u4e3b\u7ebf\u7a0b\u6269\u5bb9\n    if (tab != null && (f instanceof ForwardingNode) &&\n        (nextTab = ((ForwardingNode<K,V>)f).nextTable) != null) {\n        // \u6269\u5bb9\u6807\u8bc6\u6233\n        int rs = resizeStamp(tab.length);\n        // \u5224\u65ad\u6570\u636e\u8fc1\u79fb\u662f\u5426\u5b8c\u6210\uff0c\u8fc1\u79fb\u5b8c\u6210\u4f1a\u628a \u65b0\u8868\u8d4b\u503c\u7ed9 nextTable \u5c5e\u6027\n        while (nextTab == nextTable && table == tab && (sc = sizeCtl) < 0) {\n            if ((sc >>> RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||\n                sc == rs + MAX_RESIZERS || transferIndex <= 0)\n                break;\n            // \u8bbe\u7f6e\u6269\u5bb9\u7ebf\u7a0b\u6570\u91cf + 1\n            if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) {\n                // \u534f\u52a9\u6269\u5bb9\n                transfer(tab, nextTab);\n                break;\n            }\n        }\n        return nextTab;\n    }\n    return table;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u83b7\u53d6\u65b9\u6cd5",children:"\u83b7\u53d6\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"ConcurrentHashMap \u4f7f\u7528 get()  \u65b9\u6cd5\u83b7\u53d6\u6307\u5b9a key \u7684\u6570\u636e"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"get()\uff1a\u83b7\u53d6\u6307\u5b9a\u6570\u636e\u7684\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public V get(Object key) {\n    Node<K,V>[] tab; Node<K,V> e, p; int n, eh; K ek;\n    // \u6270\u52a8\u8fd0\u7b97\uff0c\u83b7\u53d6 key \u7684\u54c8\u5e0c\u503c\n    int h = spread(key.hashCode());\n    // \u5224\u65ad\u5f53\u524d\u54c8\u5e0c\u8868\u7684\u6570\u7ec4\u662f\u5426\u521d\u59cb\u5316\n    if ((tab = table) != null && (n = tab.length) > 0 &&\n        // \u5982\u679c table \u5df2\u7ecf\u521d\u59cb\u5316\uff0c\u8fdb\u884c\u3010\u54c8\u5e0c\u5bfb\u5740\u3011\uff0c\u6620\u5c04\u5230\u6570\u7ec4\u5bf9\u5e94\u7d22\u5f15\u5904\uff0c\u83b7\u53d6\u8be5\u7d22\u5f15\u5904\u7684\u5934\u8282\u70b9\n        (e = tabAt(tab, (n - 1) & h)) != null) {\n        // \u5bf9\u6bd4\u5934\u7ed3\u70b9 hash \u4e0e\u67e5\u8be2 key \u7684 hash \u662f\u5426\u4e00\u81f4\n        if ((eh = e.hash) == h) {\n            // \u8fdb\u884c\u503c\u7684\u5224\u65ad\uff0c\u5982\u679c\u6210\u529f\u5c31\u8bf4\u660e\u5f53\u524d\u8282\u70b9\u5c31\u662f\u8981\u67e5\u8be2\u7684\u8282\u70b9\uff0c\u76f4\u63a5\u8fd4\u56de\n            if ((ek = e.key) == key || (ek != null && key.equals(ek)))\n                return e.val;\n        }\n        // \u5f53\u524d\u69fd\u4f4d\u7684\u3010\u54c8\u5e0c\u503c\u5c0f\u4e8e0\u3011\u8bf4\u660e\u662f\u7ea2\u9ed1\u6811\u8282\u70b9\u6216\u8005\u662f\u6b63\u5728\u6269\u5bb9\u7684 fwd \u8282\u70b9\n        else if (eh < 0)\n            return (p = e.find(h, key)) != null ? p.val : null;\n        // \u5f53\u524d\u6876\u4f4d\u662f\u3010\u94fe\u8868\u3011\uff0c\u5faa\u73af\u904d\u5386\u67e5\u627e\n        while ((e = e.next) != null) {\n            if (e.hash == h &&\n                ((ek = e.key) == key || (ek != null && key.equals(ek))))\n                return e.val;\n        }\n    }\n    return null;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"ForwardingNode#find\uff1a\u8f6c\u79fb\u8282\u70b9\u7684\u67e5\u627e\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"Node<K,V> find(int h, Object k) {\n    // \u83b7\u53d6\u65b0\u8868\u7684\u5f15\u7528\n    outer: for (Node<K,V>[] tab = nextTable;;)  {\n        // e \u8868\u793a\u5728\u6269\u5bb9\u800c\u521b\u5efa\u65b0\u8868\u4f7f\u7528\u5bfb\u5740\u7b97\u6cd5\u5f97\u5230\u7684\u6876\u4f4d\u5934\u7ed3\u70b9\uff0cn \u8868\u793a\u4e3a\u6269\u5bb9\u800c\u521b\u5efa\u7684\u65b0\u8868\u7684\u957f\u5ea6\n        Node<K,V> e; int n;\n \n        if (k == null || tab == null || (n = tab.length) == 0 ||\n            // \u5728\u65b0\u8868\u4e2d\u91cd\u65b0\u5b9a\u4f4d hash \u5bf9\u5e94\u7684\u5934\u7ed3\u70b9\uff0c\u8868\u793a\u5728 oldTable \u4e2d\u5bf9\u5e94\u7684\u6876\u4f4d\u5728\u8fc1\u79fb\u4e4b\u524d\u5c31\u662f null\n            (e = tabAt(tab, (n - 1) & h)) == null)\n            return null;\n\n        for (;;) {\n            int eh; K ek;\n            // \u3010\u54c8\u5e0c\u76f8\u540c\u503c\u4e5f\u76f8\u540c\u3011\uff0c\u8868\u793a\u65b0\u8868\u5f53\u524d\u547d\u4e2d\u6876\u4f4d\u4e2d\u7684\u6570\u636e\uff0c\u5373\u4e3a\u67e5\u8be2\u60f3\u8981\u6570\u636e\n            if ((eh = e.hash) == h && ((ek = e.key) == k || (ek != null && k.equals(ek))))\n                return e;\n\n            // eh < 0 \u8bf4\u660e\u5f53\u524d\u65b0\u8868\u4e2d\u8be5\u7d22\u5f15\u7684\u5934\u8282\u70b9\u662f TreeBin \u7c7b\u578b\uff0c\u6216\u8005\u662f FWD \u7c7b\u578b\n            if (eh < 0) {\n                // \u5728\u5e76\u53d1\u5f88\u5927\u7684\u60c5\u51b5\u4e0b\u65b0\u6269\u5bb9\u7684\u8868\u8fd8\u6ca1\u5b8c\u6210\u53ef\u80fd\u3010\u518d\u6b21\u6269\u5bb9\u3011\uff0c\u5728\u6b64\u65b9\u6cd5\u5904\u518d\u6b21\u62ff\u5230 FWD \u7c7b\u578b\n                if (e instanceof ForwardingNode) {\n                    // \u7ee7\u7eed\u83b7\u53d6\u65b0\u7684 fwd \u6307\u5411\u7684\u65b0\u6570\u7ec4\u7684\u5730\u5740\uff0c\u9012\u5f52\u4e86\n                    tab = ((ForwardingNode<K,V>)e).nextTable;\n                    continue outer;\n                }\n                else\n                    // \u8bf4\u660e\u6b64\u6876\u4f4d\u4e3a TreeBin \u8282\u70b9\uff0c\u4f7f\u7528TreeBin.find \u67e5\u627e\u7ea2\u9ed1\u6811\u4e2d\u76f8\u5e94\u8282\u70b9\u3002\n                    return e.find(h, k);\n            }\n\n            // \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u5f53\u524d\u6876\u4f4d\u662f\u94fe\u8868\uff0c\u5c06\u5f53\u524d\u5143\u7d20\u6307\u5411\u94fe\u8868\u7684\u4e0b\u4e00\u4e2a\u5143\u7d20\uff0c\u5224\u65ad\u5f53\u524d\u5143\u7d20\u7684\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\u662f\u5426\u4e3a\u7a7a\n            if ((e = e.next) == null)\n                // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u8fed\u4ee3\u5230\u94fe\u8868\u672b\u5c3e\uff0c\u3010\u672a\u627e\u5230\u5bf9\u5e94\u7684\u6570\u636e\uff0c\u8fd4\u56de null\u3011\n                return null;\n        }\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5220\u9664\u65b9\u6cd5",children:"\u5220\u9664\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"remove()\uff1a\u5220\u9664\u6307\u5b9a\u5143\u7d20"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public V remove(Object key) {\n    return replaceNode(key, null, null);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["replaceNode()\uff1a\u66ff\u4ee3\u6307\u5b9a\u7684\u5143\u7d20\uff0c\u4f1a\u534f\u52a9\u6269\u5bb9\uff0c",(0,r.jsx)(e.strong,{children:"\u589e\u5220\u6539\uff08\u5199\uff09\u90fd\u4f1a\u534f\u52a9\u6269\u5bb9\uff0c\u67e5\u8be2\uff08\u8bfb\uff09\u64cd\u4f5c\u4e0d\u4f1a"}),"\uff0c\u56e0\u4e3a\u8bfb\u64cd\u4f5c\u4e0d\u6d89\u53ca\u52a0\u9501"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final V replaceNode(Object key, V value, Object cv) {\n    // \u8ba1\u7b97 key \u6270\u52a8\u8fd0\u7b97\u540e\u7684 hash\n    int hash = spread(key.hashCode());\n    // \u5f00\u59cb\u81ea\u65cb\n    for (Node<K,V>[] tab = table;;) {\n        Node<K,V> f; int n, i, fh;\n        \n        // \u3010CASE1\u3011\uff1atable \u8fd8\u672a\u521d\u59cb\u5316\u6216\u8005\u54c8\u5e0c\u5bfb\u5740\u7684\u6570\u7ec4\u7d22\u5f15\u5904\u4e3a null\uff0c\u76f4\u63a5\u7ed3\u675f\u81ea\u65cb\uff0c\u8fd4\u56de null\n        if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) & hash)) == null)\n            break;\n        // \u3010CASE2\u3011\uff1a\u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u5f53\u524d table \u6b63\u5728\u6269\u5bb9\uff0c\u3010\u5f53\u524d\u662f\u4e2a\u5199\u64cd\u4f5c\uff0c\u6240\u4ee5\u5f53\u524d\u7ebf\u7a0b\u9700\u8981\u534f\u52a9 table \u5b8c\u6210\u6269\u5bb9\u3011\n        else if ((fh = f.hash) == MOVED)\n            tab = helpTransfer(tab, f);\n        // \u3010CASE3\u3011\uff1a\u5f53\u524d\u6876\u4f4d\u53ef\u80fd\u662f \u94fe\u8868 \u4e5f\u53ef\u80fd\u662f \u7ea2\u9ed1\u6811 \n        else {\n            // \u4fdd\u7559\u66ff\u6362\u4e4b\u524d\u6570\u636e\u5f15\u7528\n            V oldVal = null;\n            // \u6821\u9a8c\u6807\u8bb0\n            boolean validated = false;\n            // \u3010\u52a0\u9501\u5f53\u524d\u6876\u4f4d\u5934\u7ed3\u70b9\u3011\uff0c\u52a0\u9501\u6210\u529f\u4e4b\u540e\u4f1a\u8fdb\u5165\u4ee3\u7801\u5757\n            synchronized (f) {\n                // \u53cc\u91cd\u68c0\u67e5\n                if (tabAt(tab, i) == f) {\n                    // \u8bf4\u660e\u5f53\u524d\u8282\u70b9\u662f\u94fe\u8868\u8282\u70b9\n                    if (fh >= 0) {\n                        validated = true;\n                        //\u904d\u5386\u6240\u6709\u7684\u8282\u70b9\n                        for (Node<K,V> e = f, pred = null;;) {\n                            K ek;\n                            // hash \u548c\u503c\u90fd\u76f8\u540c\uff0c\u5b9a\u4f4d\u5230\u4e86\u5177\u4f53\u7684\u8282\u70b9\n                            if (e.hash == hash &&\n                                ((ek = e.key) == key ||\n                                 (ek != null && key.equals(ek)))) {\n                                // \u5f53\u524d\u8282\u70b9\u7684value\n                                V ev = e.val;\n                                if (cv == null || cv == ev ||\n                                    (ev != null && cv.equals(ev))) {\n                                    // \u5c06\u5f53\u524d\u8282\u70b9\u7684\u503c \u8d4b\u503c\u7ed9 oldVal \u540e\u7eed\u8fd4\u56de\u4f1a\u7528\u5230\n                                    oldVal = ev;\n                                    if (value != null)\t\t// \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u662f\u66ff\u6362\u64cd\u4f5c\n                                        e.val = value;\t\n                                    else if (pred != null)\t// \u975e\u5934\u8282\u70b9\u5220\u9664\u64cd\u4f5c\uff0c\u65ad\u5f00\u94fe\u8868\n                                        pred.next = e.next;\t\n                                    else\n                                        // \u8bf4\u660e\u5f53\u524d\u8282\u70b9\u5373\u4e3a\u5934\u7ed3\u70b9\uff0c\u5c06\u6876\u4f4d\u5934\u8282\u70b9\u8bbe\u7f6e\u4e3a\u4ee5\u524d\u5934\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\n                                        setTabAt(tab, i, e.next);\n                                }\n                                break;\n                            }\n                            pred = e;\n                            if ((e = e.next) == null)\n                                break;\n                        }\n                    }\n                    // \u8bf4\u660e\u662f\u7ea2\u9ed1\u6811\u8282\u70b9\n                    else if (f instanceof TreeBin) {\n                        validated = true;\n                        TreeBin<K,V> t = (TreeBin<K,V>)f;\n                        TreeNode<K,V> r, p;\n                        if ((r = t.root) != null &&\n                            (p = r.findTreeNode(hash, key, null)) != null) {\n                            V pv = p.val;\n                            if (cv == null || cv == pv ||\n                                (pv != null && cv.equals(pv))) {\n                                oldVal = pv;\n                                // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e\u66ff\u6362\u64cd\u4f5c\n                                if (value != null)\n                                    p.val = value;\n                                // \u5220\u9664\u64cd\u4f5c\n                                else if (t.removeTreeNode(p))\n                                    setTabAt(tab, i, untreeify(t.first));\n                            }\n                        }\n                    }\n                }\n            }\n            // \u5176\u4ed6\u7ebf\u7a0b\u4fee\u6539\u8fc7\u6876\u4f4d\u5934\u7ed3\u70b9\u65f6\uff0c\u5f53\u524d\u7ebf\u7a0b sync \u5934\u7ed3\u70b9\u9501\u9519\u5bf9\u8c61\uff0cvalidated \u4e3a false\uff0c\u4f1a\u8fdb\u5165\u4e0b\u6b21 for \u81ea\u65cb\n            if (validated) {\n                if (oldVal != null) {\n                    // \u66ff\u6362\u7684\u503c\u4e3a null\uff0c\u3010\u8bf4\u660e\u5f53\u524d\u662f\u4e00\u6b21\u5220\u9664\u64cd\u4f5c\uff0c\u66f4\u65b0\u5f53\u524d\u5143\u7d20\u4e2a\u6570\u8ba1\u6570\u5668\u3011\n                    if (value == null)\n                        addCount(-1L, -1);\n                    return oldVal;\n                }\n                break;\n            }\n        }\n    }\n    return null;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://space.bilibili.com/457326371/",children:"https://space.bilibili.com/457326371/"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"jdk7\u539f\u7406",children:"JDK7\u539f\u7406"}),"\n",(0,r.jsxs)(e.p,{children:["ConcurrentHashMap \u5bf9\u9501\u7c92\u5ea6\u8fdb\u884c\u4e86\u4f18\u5316\uff0c",(0,r.jsx)(e.strong,{children:"\u5206\u6bb5\u9501\u6280\u672f"}),"\uff0c\u5c06\u6574\u5f20\u8868\u5206\u6210\u4e86\u591a\u4e2a\u6570\u7ec4\uff08Segment\uff09\uff0c\u6bcf\u4e2a\u6570\u7ec4\u53c8\u662f\u4e00\u4e2a\u7c7b\u4f3c HashMap \u6570\u7ec4\u7684\u7ed3\u6784\u3002\u5141\u8bb8\u591a\u4e2a\u4fee\u6539\u64cd\u4f5c\u5e76\u53d1\u8fdb\u884c\uff0cSegment \u662f\u4e00\u79cd\u53ef\u91cd\u5165\u9501\uff0c\u7ee7\u627f ReentrantLock\uff0c\u5e76\u53d1\u65f6\u9501\u4f4f\u7684\u662f\u6bcf\u4e2a Segment\uff0c\u5176\u4ed6 Segment \u8fd8\u662f\u53ef\u4ee5\u64cd\u4f5c\u7684\uff0c\u8fd9\u6837\u4e0d\u540c Segment \u4e4b\u95f4\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5e76\u53d1\uff0c\u5927\u5927\u63d0\u9ad8\u6548\u7387\u3002"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5e95\u5c42\u7ed3\u6784\uff1a ",(0,r.jsx)(e.strong,{children:"Segment \u6570\u7ec4 + HashEntry \u6570\u7ec4 + \u94fe\u8868"}),"\uff08\u6570\u7ec4 + \u94fe\u8868\u662f HashMap \u7684\u7ed3\u6784\uff09"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4f18\u70b9\uff1a\u5982\u679c\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95ee\u4e0d\u540c\u7684 segment\uff0c\u5b9e\u9645\u662f\u6ca1\u6709\u51b2\u7a81\u7684\uff0c\u8fd9\u4e0e JDK8 \u4e2d\u662f\u7c7b\u4f3c\u7684"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7f3a\u70b9\uff1aSegments \u6570\u7ec4\u9ed8\u8ba4\u5927\u5c0f\u4e3a16\uff0c\u8fd9\u4e2a\u5bb9\u91cf\u521d\u59cb\u5316\u6307\u5b9a\u540e\u5c31\u4e0d\u80fd\u6539\u53d8\u4e86\uff0c\u5e76\u4e14\u4e0d\u662f\u61d2\u60f0\u521d\u59cb\u5316"}),"\n",(0,r.jsx)(e.p,{children:"![](./images/JUC-ConcurrentHashMap 1.7\u5e95\u5c42\u7ed3\u6784.png)"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"copyonwrite",children:"CopyOnWrite"}),"\n",(0,r.jsx)(e.h4,{id:"\u539f\u7406\u5206\u6790-1",children:"\u539f\u7406\u5206\u6790"}),"\n",(0,r.jsxs)(e.p,{children:["CopyOnWriteArrayList \u91c7\u7528\u4e86",(0,r.jsx)(e.strong,{children:"\u5199\u5165\u65f6\u62f7\u8d1d"}),"\u7684\u601d\u60f3\uff0c\u589e\u5220\u6539\u64cd\u4f5c\u4f1a\u5c06\u5e95\u5c42\u6570\u7ec4\u62f7\u8d1d\u4e00\u4efd\uff0c\u5728\u65b0\u6570\u7ec4\u4e0a\u6267\u884c\u64cd\u4f5c\uff0c\u4e0d\u5f71\u54cd\u5176\u5b83\u7ebf\u7a0b\u7684",(0,r.jsx)(e.strong,{children:"\u5e76\u53d1\u8bfb\uff0c\u8bfb\u5199\u5206\u79bb"})]}),"\n",(0,r.jsx)(e.p,{children:"CopyOnWriteArraySet \u5e95\u5c42\u5bf9 CopyOnWriteArrayList \u8fdb\u884c\u4e86\u5305\u88c5\uff0c\u88c5\u9970\u5668\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public CopyOnWriteArraySet() {\n    al = new CopyOnWriteArrayList<E>();\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5b58\u50a8\u7ed3\u6784\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private transient volatile Object[] array;\t// volatile \u4fdd\u8bc1\u4e86\u8bfb\u5199\u7ebf\u7a0b\u4e4b\u95f4\u7684\u53ef\u89c1\u6027\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5168\u5c40\u9501\uff1a\u4fdd\u8bc1\u7ebf\u7a0b\u7684\u6267\u884c\u5b89\u5168"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final transient ReentrantLock lock = new ReentrantLock();\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u65b0\u589e\u6570\u636e\uff1a\u9700\u8981\u52a0\u9501\uff0c",(0,r.jsx)(e.strong,{children:"\u521b\u5efa\u65b0\u7684\u6570\u7ec4\u64cd\u4f5c"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean add(E e) {\n    final ReentrantLock lock = this.lock;\n    // \u52a0\u9501\uff0c\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168\n    lock.lock();\n    try {\n        // \u83b7\u53d6\u65e7\u7684\u6570\u7ec4\n        Object[] elements = getArray();\n        int len = elements.length;\n        // \u3010\u62f7\u8d1d\u65b0\u7684\u6570\u7ec4\uff08\u8fd9\u91cc\u662f\u6bd4\u8f83\u8017\u65f6\u7684\u64cd\u4f5c\uff0c\u4f46\u4e0d\u5f71\u54cd\u5176\u5b83\u8bfb\u7ebf\u7a0b\uff09\u3011\n        Object[] newElements = Arrays.copyOf(elements, len + 1);\n        // \u6dfb\u52a0\u65b0\u5143\u7d20\n        newElements[len] = e;\n        // \u66ff\u6362\u65e7\u7684\u6570\u7ec4\uff0c\u3010\u8fd9\u4e2a\u64cd\u4f5c\u4ee5\u540e\uff0c\u5176\u4ed6\u7ebf\u7a0b\u83b7\u53d6\u6570\u7ec4\u5c31\u662f\u83b7\u53d6\u7684\u65b0\u6570\u7ec4\u4e86\u3011\n        setArray(newElements);\n        return true;\n    } finally {\n        lock.unlock();\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u8bfb\u64cd\u4f5c\uff1a\u4e0d\u52a0\u9501\uff0c",(0,r.jsx)(e.strong,{children:"\u5728\u539f\u6570\u7ec4\u4e0a\u64cd\u4f5c"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public E get(int index) {\n    return get(getArray(), index);\n}\nprivate E get(Object[] a, int index) {\n    return (E) a[index];\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u9002\u5408\u8bfb\u591a\u5199\u5c11\u7684\u5e94\u7528\u573a\u666f"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u8fed\u4ee3\u5668\uff1aCopyOnWriteArrayList \u5728\u8fd4\u56de\u8fed\u4ee3\u5668\u65f6\uff0c",(0,r.jsx)(e.strong,{children:"\u521b\u5efa\u4e00\u4e2a\u5185\u90e8\u6570\u7ec4\u5f53\u524d\u7684\u5feb\u7167\uff08\u5f15\u7528\uff09"}),"\uff0c\u5373\u4f7f\u5176\u4ed6\u7ebf\u7a0b\u66ff\u6362\u4e86\u539f\u59cb\u6570\u7ec4\uff0c\u8fed\u4ee3\u5668\u904d\u5386\u7684\u5feb\u7167\u4f9d\u7136\u5f15\u7528\u7684\u662f\u521b\u5efa\u5feb\u7167\u65f6\u7684\u6570\u7ec4\uff0c\u6240\u4ee5\u8fd9\u79cd\u5b9e\u73b0\u65b9\u5f0f\u4e5f\u5b58\u5728\u4e00\u5b9a\u7684\u6570\u636e\u5ef6\u8fdf\u6027\uff0c\u5bf9\u5176\u4ed6\u7ebf\u7a0b\u5e76\u884c\u6dfb\u52a0\u7684\u6570\u636e\u4e0d\u53ef\u89c1"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public Iterator<E> iterator() {\n    // \u83b7\u53d6\u5230\u6570\u7ec4\u5f15\u7528\uff0c\u6574\u4e2a\u904d\u5386\u7684\u8fc7\u7a0b\u8be5\u6570\u7ec4\u90fd\u4e0d\u4f1a\u53d8\uff0c\u4e00\u76f4\u5f15\u7528\u7684\u90fd\u662f\u8001\u6570\u7ec4\uff0c\n    return new COWIterator<E>(getArray(), 0);\n}\n\n// \u8fed\u4ee3\u5668\u4f1a\u521b\u5efa\u4e00\u4e2a\u5e95\u5c42array\u7684\u5feb\u7167\uff0c\u6545\u4e3b\u7c7b\u7684\u4fee\u6539\u4e0d\u5f71\u54cd\u8be5\u5feb\u7167\nstatic final class COWIterator<E> implements ListIterator<E> {\n    // \u5185\u90e8\u6570\u7ec4\u5feb\u7167\n    private final Object[] snapshot;\n\n    private COWIterator(Object[] elements, int initialCursor) {\n        cursor = initialCursor;\n        // \u6570\u7ec4\u7684\u5f15\u7528\u5728\u8fed\u4ee3\u8fc7\u7a0b\u4e0d\u4f1a\u6539\u53d8\n        snapshot = elements;\n    }\n    // \u3010\u4e0d\u652f\u6301\u5199\u64cd\u4f5c\u3011\uff0c\u56e0\u4e3a\u662f\u5728\u5feb\u7167\u4e0a\u64cd\u4f5c\uff0c\u65e0\u6cd5\u540c\u6b65\u56de\u53bb\n    public void remove() {\n        throw new UnsupportedOperationException();\n    } \n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5f31\u4e00\u81f4\u6027",children:"\u5f31\u4e00\u81f4\u6027"}),"\n",(0,r.jsx)(e.p,{children:"\u6570\u636e\u4e00\u81f4\u6027\u5c31\u662f\u8bfb\u5230\u6700\u65b0\u66f4\u65b0\u7684\u6570\u636e\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f3a\u4e00\u81f4\u6027\uff1a\u5f53\u66f4\u65b0\u64cd\u4f5c\u5b8c\u6210\u4e4b\u540e\uff0c\u4efb\u4f55\u591a\u4e2a\u540e\u7eed\u8fdb\u7a0b\u6216\u8005\u7ebf\u7a0b\u7684\u8bbf\u95ee\u90fd\u4f1a\u8fd4\u56de\u6700\u65b0\u7684\u66f4\u65b0\u8fc7\u7684\u503c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5f31\u4e00\u81f4\u6027\uff1a\u7cfb\u7edf\u5e76\u4e0d\u4fdd\u8bc1\u8fdb\u7a0b\u6216\u8005\u7ebf\u7a0b\u7684\u8bbf\u95ee\u90fd\u4f1a\u8fd4\u56de\u6700\u65b0\u7684\u66f4\u65b0\u8fc7\u7684\u503c\uff0c\u4e5f\u4e0d\u4f1a\u627f\u8bfa\u591a\u4e45\u4e4b\u540e\u53ef\u4ee5\u8bfb\u5230"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(8443).A+"",width:"767",height:"337"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65f6\u95f4\u70b9"}),(0,r.jsx)(e.th,{children:"\u64cd\u4f5c"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"1"}),(0,r.jsx)(e.td,{children:"Thread-0 getArray()"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"2"}),(0,r.jsx)(e.td,{children:"Thread-1 getArray()"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"3"}),(0,r.jsx)(e.td,{children:"Thread-1 setArray(arrayCopy)"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"4"}),(0,r.jsx)(e.td,{children:"Thread-0 array[index]"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:"Thread-0 \u8bfb\u5230\u4e86\u810f\u6570\u636e"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0d\u4e00\u5b9a\u5f31\u4e00\u81f4\u6027\u5c31\u4e0d\u597d"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u6570\u636e\u5e93\u7684",(0,r.jsx)(e.strong,{children:"\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b"}),"\u5c31\u662f\u5f31\u4e00\u81f4\u6027\u7684\u8868\u73b0"]}),"\n",(0,r.jsx)(e.li,{children:"\u5e76\u53d1\u9ad8\u548c\u4e00\u81f4\u6027\u662f\u77db\u76fe\u7684\uff0c\u9700\u8981\u6743\u8861"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b89\u5168\u5931\u8d25",children:"\u5b89\u5168\u5931\u8d25"}),"\n",(0,r.jsx)(e.p,{children:"\u5728 java.util \u5305\u7684\u96c6\u5408\u7c7b\u5c31\u90fd\u662f\u5feb\u901f\u5931\u8d25\u7684\uff0c\u800c java.util.concurrent \u5305\u4e0b\u7684\u7c7b\u90fd\u662f\u5b89\u5168\u5931\u8d25"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5feb\u901f\u5931\u8d25\uff1a\u5728 A \u7ebf\u7a0b\u4f7f\u7528",(0,r.jsx)(e.strong,{children:"\u8fed\u4ee3\u5668"}),"\u5bf9\u96c6\u5408\u8fdb\u884c\u904d\u5386\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6b64\u65f6 B \u7ebf\u7a0b\u5bf9\u96c6\u5408\u8fdb\u884c\u4fee\u6539\uff08\u589e\u5220\u6539\uff09\uff0c\u6216\u8005 A \u7ebf\u7a0b\u5728\u904d\u5386\u8fc7\u7a0b\u4e2d\u5bf9\u96c6\u5408\u8fdb\u884c\u4fee\u6539\uff0c\u90fd\u4f1a\u5bfc\u81f4 A \u7ebf\u7a0b\u629b\u51fa ConcurrentModificationException \u5f02\u5e38"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["AbstractList \u7c7b\u4e2d\u7684\u6210\u5458\u53d8\u91cf modCount\uff0c\u7528\u6765\u8bb0\u5f55 List \u7ed3\u6784\u53d1\u751f\u53d8\u5316\u7684\u6b21\u6570\uff0c",(0,r.jsx)(e.strong,{children:"\u7ed3\u6784\u53d1\u751f\u53d8\u5316"}),"\u662f\u6307\u6dfb\u52a0\u6216\u8005\u5220\u9664\u81f3\u5c11\u4e00\u4e2a\u5143\u7d20\u7684\u64cd\u4f5c\uff0c\u6216\u8005\u662f\u8c03\u6574\u5185\u90e8\u6570\u7ec4\u7684\u5927\u5c0f\uff0c\u4ec5\u4ec5\u8bbe\u7f6e\u5143\u7d20\u7684\u503c\u4e0d\u7b97\u7ed3\u6784\u53d1\u751f\u53d8\u5316"]}),"\n",(0,r.jsx)(e.li,{children:"\u5728\u8fdb\u884c\u5e8f\u5217\u5316\u6216\u8005\u8fed\u4ee3\u7b49\u64cd\u4f5c\u65f6\uff0c\u9700\u8981\u6bd4\u8f83\u64cd\u4f5c\u524d\u540e modCount \u662f\u5426\u6539\u53d8\uff0c\u5982\u679c\u6539\u53d8\u4e86\u629b\u51fa CME \u5f02\u5e38"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5b89\u5168\u5931\u8d25\uff1a\u91c7\u7528\u5b89\u5168\u5931\u8d25\u673a\u5236\u7684\u96c6\u5408\u5bb9\u5668\uff0c\u5728",(0,r.jsx)(e.strong,{children:"\u8fed\u4ee3\u5668"}),"\u904d\u5386\u65f6\u76f4\u63a5\u5728\u539f\u96c6\u5408\u6570\u7ec4\u5185\u5bb9\u4e0a\u8bbf\u95ee\uff0c\u4f46\u5176\u4ed6\u7ebf\u7a0b\u7684\u589e\u5220\u6539\u90fd\u4f1a\u65b0\u5efa\u6570\u7ec4\u8fdb\u884c\u4fee\u6539\uff0c\u5c31\u7b97\u4fee\u6539\u4e86\u96c6\u5408\u5e95\u5c42\u7684\u6570\u7ec4\u5bb9\u5668\uff0c\u8fed\u4ee3\u5668\u4f9d\u7136\u5f15\u7528\u7740\u4ee5\u524d\u7684\u6570\u7ec4\uff08",(0,r.jsx)(e.strong,{children:"\u5feb\u7167\u601d\u60f3"}),"\uff09\uff0c\u6240\u4ee5\u4e0d\u4f1a\u51fa\u73b0\u5f02\u5e38"]}),"\n",(0,r.jsx)(e.p,{children:"ConcurrentHashMap \u4e0d\u4f1a\u51fa\u73b0\u5e76\u53d1\u65f6\u7684\u8fed\u4ee3\u5f02\u5e38\uff0c\u56e0\u4e3a\u5728\u8fed\u4ee3\u8fc7\u7a0b\u4e2d CHM \u7684\u8fed\u4ee3\u5668\u5e76\u6ca1\u6709\u5224\u65ad\u7ed3\u6784\u7684\u53d8\u5316\uff0c\u8fed\u4ee3\u5668\u8fd8\u53ef\u4ee5\u6839\u636e\u8fed\u4ee3\u7684\u8282\u70b9\u72b6\u6001\u53bb\u5bfb\u627e\u5e76\u53d1\u6269\u5bb9\u65f6\u7684\u65b0\u8868\u8fdb\u884c\u8fed\u4ee3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"ConcurrentHashMap map = new ConcurrentHashMap();\n// KeyIterator\nIterator iterator = map.keySet().iterator();\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:" Traverser(Node<K,V>[] tab, int size, int index, int limit) {\n     // \u5f15\u7528\u8fd8\u662f\u539f\u6765\u96c6\u5408\u7684 Node \u6570\u7ec4\uff0c\u6240\u4ee5\u5176\u4ed6\u7ebf\u7a0b\u5bf9\u6570\u636e\u7684\u4fee\u6539\u662f\u53ef\u89c1\u7684\n     this.tab = tab;\n     this.baseSize = size;\n     this.baseIndex = this.index = index;\n     this.baseLimit = limit;\n     this.next = null;\n }\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public final boolean hasNext() { return next != null; }\npublic final K next() {\n    Node<K,V> p;\n    if ((p = next) == null)\n        throw new NoSuchElementException();\n    K k = p.key;\n    lastReturned = p;\n    // \u5728\u65b9\u6cd5\u4e2d\u8fdb\u884c\u4e0b\u4e00\u4e2a\u8282\u70b9\u7684\u83b7\u53d6\uff0c\u4f1a\u8fdb\u884c\u69fd\u4f4d\u5934\u8282\u70b9\u7684\u72b6\u6001\u5224\u65ad\n    advance();\n    return k;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"collections",children:"Collections"}),"\n",(0,r.jsx)(e.p,{children:"Collections\u7c7b\u662f\u7528\u6765\u64cd\u4f5c\u96c6\u5408\u7684\u5de5\u5177\u7c7b\uff0c\u63d0\u4f9b\u4e86\u96c6\u5408\u8f6c\u6362\u6210\u7ebf\u7a0b\u5b89\u5168\u7684\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:" public static <T> Collection<T> synchronizedCollection(Collection<T> c) {\n     return new SynchronizedCollection<>(c);\n }\npublic static <K,V> Map<K,V> synchronizedMap(Map<K,V> m) {\n    return new SynchronizedMap<>(m);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u6e90\u7801\uff1a\u5e95\u5c42\u4e5f\u662f\u5bf9\u65b9\u6cd5\u8fdb\u884c\u52a0\u9501"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean add(E e) {\n    synchronized (mutex) {return c.add(e);}\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"skiplistmap",children:"SkipListMap"}),"\n",(0,r.jsx)(e.h4,{id:"\u5e95\u5c42\u7ed3\u6784-1",children:"\u5e95\u5c42\u7ed3\u6784"}),"\n",(0,r.jsxs)(e.p,{children:["\u8df3\u8868 SkipList \u662f\u4e00\u4e2a",(0,r.jsx)(e.strong,{children:"\u6709\u5e8f\u7684\u94fe\u8868"}),"\uff0c\u9ed8\u8ba4\u5347\u5e8f\uff0c\u5e95\u5c42\u662f\u94fe\u8868\u52a0\u591a\u7ea7\u7d22\u5f15\u7684\u7ed3\u6784\u3002\u8df3\u8868\u53ef\u4ee5\u5bf9\u5143\u7d20\u8fdb\u884c\u5feb\u901f\u67e5\u8be2\uff0c\u7c7b\u4f3c\u4e8e\u5e73\u8861\u6811\uff0c\u662f\u4e00\u79cd\u5229\u7528\u7a7a\u95f4\u6362\u65f6\u95f4\u7684\u7b97\u6cd5"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5bf9\u4e8e\u5355\u94fe\u8868\uff0c\u5373\u4f7f\u94fe\u8868\u662f\u6709\u5e8f\u7684\uff0c\u5982\u679c\u67e5\u627e\u6570\u636e\u4e5f\u53ea\u80fd\u4ece\u5934\u5230\u5c3e\u904d\u5386\u94fe\u8868\uff0c\u6240\u4ee5\u91c7\u7528\u94fe\u8868\u4e0a\u5efa\u7d22\u5f15\u7684\u65b9\u5f0f\u63d0\u9ad8\u6548\u7387\uff0c\u8df3\u8868\u7684\u67e5\u8be2\u65f6\u95f4\u590d\u6742\u5ea6\u662f ",(0,r.jsx)(e.strong,{children:"O(logn)"}),"\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 O(n)"]}),"\n",(0,r.jsx)(e.p,{children:"ConcurrentSkipListMap \u63d0\u4f9b\u4e86\u4e00\u79cd\u7ebf\u7a0b\u5b89\u5168\u7684\u5e76\u53d1\u8bbf\u95ee\u7684\u6392\u5e8f\u6620\u5c04\u8868\uff0c\u5185\u90e8\u662f\u8df3\u8868\u7ed3\u6784\u5b9e\u73b0\uff0c\u901a\u8fc7 CAS + volatile \u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168"}),"\n",(0,r.jsx)(e.p,{children:"\u5e73\u8861\u6811\u548c\u8df3\u8868\u7684\u533a\u522b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u5bf9\u5e73\u8861\u6811\u7684\u63d2\u5165\u548c\u5220\u9664\u5f80\u5f80\u5f88\u53ef\u80fd\u5bfc\u81f4\u5e73\u8861\u6811\u8fdb\u884c\u4e00\u6b21\u5168\u5c40\u7684\u8c03\u6574\uff1b\u800c\u5bf9\u8df3\u8868\u7684\u63d2\u5165\u548c\u5220\u9664\uff0c",(0,r.jsx)(e.strong,{children:"\u53ea\u9700\u8981\u5bf9\u6574\u4e2a\u7ed3\u6784\u7684\u5c40\u90e8\u8fdb\u884c\u64cd\u4f5c"})]}),"\n",(0,r.jsx)(e.li,{children:"\u5728\u9ad8\u5e76\u53d1\u7684\u60c5\u51b5\u4e0b\uff0c\u4fdd\u8bc1\u6574\u4e2a\u5e73\u8861\u6811\u7684\u7ebf\u7a0b\u5b89\u5168\u9700\u8981\u4e00\u4e2a\u5168\u5c40\u9501\uff1b\u5bf9\u4e8e\u8df3\u8868\u5219\u53ea\u9700\u8981\u90e8\u5206\u9501\uff0c\u62e5\u6709\u66f4\u597d\u7684\u6027\u80fd"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(6700).A+"",width:"1304",height:"390"})}),"\n",(0,r.jsxs)(e.p,{children:["BaseHeader \u5b58\u50a8\u6570\u636e\uff0cheadIndex \u5b58\u50a8\u7d22\u5f15\uff0c\u7eb5\u5411\u4e0a",(0,r.jsx)(e.strong,{children:"\u6240\u6709\u7d22\u5f15\u90fd\u6307\u5411\u94fe\u8868\u6700\u4e0b\u9762\u7684\u8282\u70b9"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u53d8\u91cf-2",children:"\u6210\u5458\u53d8\u91cf"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6807\u8bc6\u7d22\u5f15\u5934\u8282\u70b9\u4f4d\u7f6e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private static final Object BASE_HEADER = new Object();\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8df3\u8868\u7684\u9876\u5c42\u7d22\u5f15"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private transient volatile HeadIndex<K,V> head;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6bd4\u8f83\u5668\uff0c\u4e3a null \u5219\u4f7f\u7528\u81ea\u7136\u6392\u5e8f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"final Comparator<? super K> comparator;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Node \u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final class Node<K, V>{\n    final K key;  \t\t\t\t// key \u662f final \u7684, \u8bf4\u660e\u8282\u70b9\u4e00\u65e6\u5b9a\u4e0b\u6765, \u9664\u4e86\u5220\u9664, \u4e00\u822c\u4e0d\u4f1a\u6539\u52a8 key\n    volatile Object value; \t\t// \u5bf9\u5e94\u7684 value\n    volatile Node<K, V> next; \t// \u4e0b\u4e00\u4e2a\u8282\u70b9\uff0c\u5355\u5411\u94fe\u8868\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7d22\u5f15\u8282\u70b9 Index\uff0c\u53ea\u6709\u5411\u4e0b\u548c\u5411\u53f3\u7684\u6307\u9488"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static class Index<K, V>{\n    final Node<K, V> node; \t\t// \u7d22\u5f15\u6307\u5411\u7684\u8282\u70b9\uff0c\u6bcf\u4e2a\u90fd\u4f1a\u6307\u5411\u6570\u636e\u8282\u70b9\n    final Index<K, V> down; \t// \u4e0b\u8fb9level\u5c42\u7684Index\uff0c\u5206\u5c42\u7d22\u5f15\n    volatile Index<K, V> right; // \u53f3\u8fb9\u7684Index\uff0c\u5355\u5411\n\n    // \u5728 index \u672c\u8eab\u548c succ \u4e4b\u95f4\u63d2\u5165\u4e00\u4e2a\u65b0\u7684\u8282\u70b9 newSucc\n    final boolean link(Index<K, V> succ, Index<K, V> newSucc){\n        Node<K, V> n = node;\n        newSucc.right = succ;\n        // \u628a\u5f53\u524d\u8282\u70b9\u7684\u53f3\u6307\u9488\u4ece succ \u6539\u4e3a newSucc\n        return n.value != null && casRight(succ, newSucc);\n    }\n\n    // \u65ad\u5f00\u5f53\u524d\u8282\u70b9\u548c succ \u8282\u70b9\uff0c\u5c06\u5f53\u524d\u7684\u8282\u70b9 index \u8bbe\u7f6e\u5176\u7684 right \u4e3a succ.right\uff0c\u5c31\u662f\u628a succ \u5220\u9664\n    final boolean unlink(Index<K, V> succ){\n        return node.value != null && casRight(succ, succ.right);\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5934\u7d22\u5f15\u8282\u70b9 HeadIndex"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static final class HeadIndex<K,V> extends Index<K,V> {\n    final int level;\t// \u8868\u793a\u7d22\u5f15\u5c42\u7ea7\uff0c\u6240\u6709\u7684 HeadIndex \u90fd\u6307\u5411\u540c\u4e00\u4e2a Base_header \u8282\u70b9\n    HeadIndex(Node<K,V> node, Index<K,V> down, Index<K,V> right, int level) {\n        super(node, down, right);\n        this.level = level;\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u65b9\u6cd5-7",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.h5,{id:"\u5176\u4ed6\u65b9\u6cd5",children:"\u5176\u4ed6\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ConcurrentSkipListMap() {\n    this.comparator = null;\t// comparator \u4e3a null\uff0c\u4f7f\u7528 key \u7684\u81ea\u7136\u5e8f\uff0c\u5982\u5b57\u5178\u5e8f\n    initialize();\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void initialize() {\n    keySet = null;\n    entrySet = null;\n    values = null;\n    descendingMap = null;\n    // \u521d\u59cb\u5316\u7d22\u5f15\u5934\u8282\u70b9\uff0cNode \u7684 key \u4e3a null\uff0cvalue \u4e3a BASE_HEADER \u5bf9\u8c61\uff0c\u4e0b\u4e00\u4e2a\u8282\u70b9\u4e3a null\n    // head \u7684\u5206\u5c42\u7d22\u5f15 down \u4e3a null\uff0c\u94fe\u8868\u7684\u540e\u7eed\u7d22\u5f15 right \u4e3a null\uff0c\u5c42\u7ea7 level \u4e3a\u7b2c 1 \u5c42\n    head = new HeadIndex<K,V>(new Node<K,V>(null, BASE_HEADER, null), null, null, 1);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"cpr\uff1a\u6392\u5e8f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"//\u3000x \u662f\u6bd4\u8f83\u8005\uff0cy \u662f\u88ab\u6bd4\u8f83\u8005\uff0c\u6bd4\u8f83\u8005\u5927\u4e8e\u88ab\u6bd4\u8f83\u8005 \u8fd4\u56de\u6b63\u6570\uff0c\u5c0f\u4e8e\u8fd4\u56de\u8d1f\u6570\uff0c\u76f8\u7b49\u8fd4\u56de 0\nstatic final int cpr(Comparator c, Object x, Object y) {\n    return (c != null) ? c.compare(x, y) : ((Comparable)x).compareTo(y);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6dfb\u52a0\u65b9\u6cd5-1",children:"\u6dfb\u52a0\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"findPredecessor()\uff1a\u5bfb\u627e\u524d\u7f6e\u8282\u70b9"}),"\n",(0,r.jsx)(e.p,{children:"\u4ece\u6700\u4e0a\u5c42\u7684\u5934\u7d22\u5f15\u5f00\u59cb\u5411\u53f3\u67e5\u627e\uff08\u94fe\u8868\u7684\u540e\u7eed\u7d22\u5f15\uff09\uff0c\u5982\u679c\u540e\u7eed\u7d22\u5f15\u7684\u8282\u70b9\u7684 key \u5927\u4e8e\u8981\u67e5\u627e\u7684 key\uff0c\u5219\u5934\u7d22\u5f15\u79fb\u5230\u4e0b\u5c42\u94fe\u8868\uff0c\u5728\u4e0b\u5c42\u94fe\u8868\u67e5\u627e\uff0c\u4ee5\u6b64\u53cd\u590d\uff0c\u4e00\u76f4\u67e5\u627e\u5230\u6ca1\u6709\u4e0b\u5c42\u7684\u5206\u5c42\u7d22\u5f15\u4e3a\u6b62\uff0c\u8fd4\u56de\u8be5\u7d22\u5f15\u7684\u8282\u70b9\u3002\u5982\u679c\u540e\u7eed\u7d22\u5f15\u7684\u8282\u70b9\u7684 key \u5c0f\u4e8e\u8981\u67e5\u627e\u7684 key\uff0c\u5219\u5728\u8be5\u5c42\u94fe\u8868\u4e2d\u5411\u540e\u67e5\u627e\u3002\u7531\u4e8e\u67e5\u627e\u7684 key \u53ef\u80fd\u6c38\u8fdc\u5927\u4e8e\u7d22\u5f15\u8282\u70b9\u7684 key\uff0c\u6240\u4ee5\u53ea\u80fd\u627e\u5230\u76ee\u6807\u7684\u524d\u7f6e\u7d22\u5f15\u8282\u70b9\u3002\u5982\u679c\u9047\u5230\u7a7a\u503c\u7d22\u5f15\u7684\u5b58\u5728\uff0c\u901a\u8fc7 CAS \u6765\u65ad\u5f00\u7d22\u5f15"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private Node<K,V> findPredecessor(Object key, Comparator<? super K> cmp) {\n    if (key == null)\n        throw new NullPointerException(); // don't postpone errors\n    for (;;) {\n        // 1.\u521d\u59cb\u6570\u636e q \u662f head\uff0cr \u662f\u6700\u9876\u5c42 h \u7684\u53f3 Index \u8282\u70b9\n        for (Index<K,V> q = head, r = q.right, d;;) {\n            // 2.\u53f3\u7d22\u5f15\u8282\u70b9\u4e0d\u4e3a\u7a7a\uff0c\u5219\u8fdb\u884c\u5411\u4e0b\u67e5\u627e\n            if (r != null) {\n                Node<K,V> n = r.node;\n                K k = n.key;\n                // 3.n.value \u4e3a null \u8bf4\u660e\u8282\u70b9 n \u6b63\u5728\u5220\u9664\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6b64\u65f6\u3010\u5f53\u524d\u7ebf\u7a0b\u5e2e\u5176\u5220\u9664\u7d22\u5f15\u3011\n                if (n.value == null) {\n                    // \u5728 index \u5c42\u76f4\u63a5\u5220\u9664 r \u7d22\u5f15\u8282\u70b9\n                    if (!q.unlink(r))\n                        // \u5220\u9664\u5931\u8d25\u91cd\u65b0\u4ece head \u8282\u70b9\u5f00\u59cb\u67e5\u627e\uff0cbreak \u4e00\u4e2a for \u5230\u6b65\u9aa4 1\uff0c\u53c8\u4ece\u521d\u59cb\u503c\u5f00\u59cb\n                        break;\n                    \n                    // \u5220\u9664\u8282\u70b9 r \u6210\u529f\uff0c\u83b7\u53d6\u65b0\u7684 r \u8282\u70b9,\n                    r = q.right;\n                    // \u56de\u5230\u6b65\u9aa4 2\uff0c\u8fd8\u662f\u4ece\u8fd9\u5c42\u7d22\u5f15\u5f00\u59cb\u5411\u53f3\u904d\u5386\n                    continue;\n                }\n                // 4.\u82e5\u53c2\u6570 key > r.node.key\uff0c\u5219\u7ee7\u7eed\u5411\u53f3\u904d\u5386, continue \u5230\u6b65\u9aa4 2 \u5904\u83b7\u53d6\u53f3\u8282\u70b9\n                //   \u82e5\u53c2\u6570 key < r.node.key\uff0c\u8bf4\u660e\u9700\u8981\u8fdb\u5165\u4e0b\u5c42\u7d22\u5f15\uff0c\u5230\u6b65\u9aa4 5\n                if (cpr(cmp, key, k) > 0) {\n                    q = r;\n                    r = r.right;\n                    continue;\n                }\n            }\n            // 5.\u5148\u8ba9 d \u6307\u5411 q \u7684\u4e0b\u4e00\u5c42\uff0c\u5224\u65ad\u662f\u5426\u662f null\uff0c\u662f\u5219\u8bf4\u660e\u5df2\u7ecf\u5230\u4e86\u6570\u636e\u5c42\uff0c\u4e5f\u5c31\u662f\u7b2c\u4e00\u5c42\n            if ((d = q.down) == null) \n                return q.node;\n            // 6.\u672a\u5230\u6570\u636e\u5c42, \u8fdb\u884c\u91cd\u65b0\u8d4b\u503c\u5411\u4e0b\u626b\u63cf\n            q = d;\t\t// q \u6307\u5411 d\n            r = d.right;// r \u6307\u5411 q \u7684\u540e\u7eed\u7d22\u5f15\u8282\u70b9\uff0c\u6b64\u65f6(q.key < key < r.key)\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(60735).A+"",width:"1480",height:"623"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"put()\uff1a\u6dfb\u52a0\u6570\u636e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public V put(K key, V value) {\n    // \u975e\u7a7a\u5224\u65ad\uff0cvalue\u4e0d\u80fd\u4e3a\u7a7a\n    if (value == null)\n        throw new NullPointerException();\n    return doPut(key, value, false);\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'private V doPut(K key, V value, boolean onlyIfAbsent) {\n    Node<K,V> z;\n    // \u975e\u7a7a\u5224\u65ad\uff0ckey \u4e0d\u80fd\u4e3a\u7a7a\n    if (key == null)\n        throw new NullPointerException();\n    Comparator<? super K> cmp = comparator;\n    // outer \u5faa\u73af\uff0c\u3010\u628a\u5f85\u63d2\u5165\u6570\u636e\u63d2\u5165\u5230\u6570\u636e\u5c42\u7684\u5408\u9002\u7684\u4f4d\u7f6e\uff0c\u5e76\u5728\u626b\u63cf\u8fc7\u7a0b\u4e2d\u5904\u7406\u5df2\u5220\u9664(value = null)\u7684\u6570\u636e\u3011\n    outer: for (;;) {\n        //0.for (;;)\n        //1.\u5c06 key \u5bf9\u5e94\u7684\u524d\u7ee7\u8282\u70b9\u627e\u5230, b \u4e3a\u524d\u7ee7\u8282\u70b9\uff0c\u662f\u6570\u636e\u5c42\u7684, n \u662f\u524d\u7ee7\u8282\u70b9\u7684 next, \n\t\t//  \u82e5\u6ca1\u53d1\u751f\u6761\u4ef6\u7ade\u4e89\uff0c\u6700\u7ec8 key \u5728 b \u4e0e n \u4e4b\u95f4 (\u627e\u5230\u7684 b \u5728 base_level \u4e0a)\n        for (Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {\n            // 2.n \u4e0d\u4e3a null \u8bf4\u660e b \u4e0d\u662f\u94fe\u8868\u7684\u6700\u540e\u4e00\u4e2a\u8282\u70b9\n            if (n != null) {\n                Object v; int c;\n                // 3.\u83b7\u53d6 n \u7684\u53f3\u8282\u70b9\n                Node<K,V> f = n.next;\n                // 4.\u6761\u4ef6\u7ade\u4e89\uff0c\u5e76\u53d1\u4e0b\u5176\u4ed6\u7ebf\u7a0b\u5728 b \u4e4b\u540e\u63d2\u5165\u8282\u70b9\u6216\u76f4\u63a5\u5220\u9664\u8282\u70b9 n, break \u5230\u6b65\u9aa4 0\n                if (n != b.next)              \n                    break;\n                //  \u82e5\u8282\u70b9 n \u5df2\u7ecf\u5220\u9664, \u5219\u8c03\u7528 helpDelete \u8fdb\u884c\u3010\u5e2e\u52a9\u5220\u9664\u8282\u70b9\u3011\n                if ((v = n.value) == null) {\n                    n.helpDelete(b, f);\n                    break;\n                }\n                // 5.\u8282\u70b9 b \u88ab\u5220\u9664\u4e2d\uff0c\u5219 break \u5230\u6b65\u9aa4 0,\n\t\t\t\t//  \u3010\u8c03\u7528findPredecessor\u5e2e\u52a9\u5220\u9664index\u5c42\u7684\u6570\u636e, node\u5c42\u7684\u6570\u636e\u4f1a\u901a\u8fc7helpDelete\u65b9\u6cd5\u8fdb\u884c\u5220\u9664\u3011\n                if (b.value == null || v == n) \n                    break;\n                // 6.\u82e5 key > n.key\uff0c\u5219\u8fdb\u884c\u5411\u540e\u626b\u63cf\n                //   \u82e5 key < n.key\uff0c\u5219\u8bc1\u660e key \u5e94\u8be5\u5b58\u50a8\u5728 b \u548c n \u4e4b\u95f4\n                if ((c = cpr(cmp, key, n.key)) > 0) {\n                    b = n;\n                    n = f;\n                    continue;\n                }\n                // 7.key \u7684\u503c\u548c n.key \u76f8\u7b49\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u8986\u76d6\u8d4b\u503c\n                if (c == 0) {\n                    // onlyIfAbsent \u9ed8\u8ba4 false\uff0c\n                    if (onlyIfAbsent || n.casValue(v, value)) {\n                        @SuppressWarnings("unchecked") V vv = (V)v;\n                        // \u8fd4\u56de\u88ab\u8986\u76d6\u7684\u503c\n                        return vv;\n                    }\n                    // cas\u5931\u8d25\uff0cbreak \u4e00\u5c42\u5faa\u73af\uff0c\u8fd4\u56de 0 \u91cd\u8bd5\n                    break;\n                }\n                // else c < 0; fall through\n            }\n            // 8.\u6b64\u65f6\u7684\u60c5\u51b5 b.key < key < n.key\uff0c\u5bf9\u5e94\u6d41\u7a0b\u56fe1\u4e2d\u76847\uff0c\u521b\u5efaz\u8282\u70b9\u6307\u5411n\n            z = new Node<K,V>(key, value, n);\n            // 9.\u5c1d\u8bd5\u628a b.next \u4ece n \u8bbe\u7f6e\u6210 z\n            if (!b.casNext(n, z))\n                // cas\u5931\u8d25\uff0c\u8fd4\u56de\u5230\u6b65\u9aa40\uff0c\u91cd\u8bd5\n                break;\n            // 10.break outer \u540e, \u4e0a\u9762\u7684 for \u5faa\u73af\u4e0d\u4f1a\u518d\u6267\u884c, \u800c\u540e\u6267\u884c\u4e0b\u9762\u7684\u4ee3\u7801\n            break outer;\n        }\n    }\n\t// \u3010\u4ee5\u4e0a\u63d2\u5165\u8282\u70b9\u5df2\u7ecf\u5b8c\u6210\uff0c\u5269\u4e0b\u7684\u4efb\u52a1\u8981\u6839\u636e\u968f\u673a\u6570\u7684\u503c\u6765\u8868\u793a\u662f\u5426\u5411\u4e0a\u589e\u52a0\u5c42\u6570\u4e0e\u4e0a\u5c42\u7d22\u5f15\u3011\n    \n    // \u968f\u673a\u6570\n    int rnd = ThreadLocalRandom.nextSecondarySeed();\n    \n    // \u5982\u679c\u968f\u673a\u6570\u7684\u4e8c\u8fdb\u5236\u4e0e 10000000000000000000000000000001 \u8fdb\u884c\u4e0e\u8fd0\u7b97\u4e3a 0\n    // \u5373\u968f\u673a\u6570\u7684\u4e8c\u8fdb\u5236\u6700\u9ad8\u4f4d\u4e0e\u6700\u672b\u5c3e\u5fc5\u987b\u4e3a 0\uff0c\u5176\u4ed6\u4f4d\u65e0\u6240\u8c13\uff0c\u5c31\u8fdb\u5165\u8be5\u5faa\u73af\n    // \u5982\u679c\u968f\u673a\u6570\u7684\u4e8c\u8fdb\u5236\u6700\u9ad8\u4f4d\u4e0e\u6700\u672b\u4f4d\u4e0d\u4e3a 0\uff0c\u4e0d\u589e\u52a0\u65b0\u8282\u70b9\u7684\u5c42\u6570\n    \n    // 11.\u5224\u65ad\u662f\u5426\u9700\u8981\u6dfb\u52a0 level\uff0c32 \u4f4d\n    if ((rnd & 0x80000001) == 0) {\n        // \u7d22\u5f15\u5c42 level\uff0c\u4ece 1 \u5f00\u59cb\uff0c\u5c31\u662f\u6700\u5e95\u5c42\n        int level = 1, max;\n        // 12.\u5224\u65ad\u6700\u4f4e\u4f4d\u524d\u9762\u6709\u51e0\u4e2a 1\uff0c\u6709\u51e0\u4e2aleve\u5c31\u52a0\u51e0\uff1a0..0 0001 1110\uff0c\u8fd9\u662f4\u4e2a\uff0c\u52191+4=5\n        //    \u3010\u6700\u5927\u670930\u4e2a\u5c31\u662f 1 + 30 = 31\n        while (((rnd >>>= 1) & 1) != 0)\n            ++level;\n        // \u6700\u7ec8\u4f1a\u6307\u5411 z \u8282\u70b9\uff0c\u5c31\u662f\u6dfb\u52a0\u7684\u8282\u70b9 \n        Index<K,V> idx = null;\n        // \u6307\u5411\u5934\u7d22\u5f15\u8282\u70b9\n        HeadIndex<K,V> h = head;\n        \n        // 13.\u5224\u65adlevel\u662f\u5426\u6bd4\u5f53\u524d\u6700\u9ad8\u7d22\u5f15\u5c0f\uff0c\u56fe\u4e2d max \u4e3a 3\n        if (level <= (max = h.level)) {\n            for (int i = 1; i <= level; ++i)\n                // \u6839\u636e\u5c42\u6570level\u4e0d\u65ad\u521b\u5efa\u65b0\u589e\u8282\u70b9\u7684\u4e0a\u5c42\u7d22\u5f15\uff0c\u7d22\u5f15\u7684\u540e\u7ee7\u7d22\u5f15\u7559\u7a7a\n                // \u7b2c\u4e00\u6b21idx\u4e3anull\uff0c\u4e5f\u5c31\u662f\u4e0b\u5c42\u7d22\u5f15\u4e3a\u7a7a\uff0c\u7b2c\u4e8c\u6b21\u628a\u4e0a\u6b21\u7684\u7d22\u5f15\u4f5c\u4e3a\u4e0b\u5c42\u7d22\u5f15\uff0c\u3010\u7c7b\u4f3c\u5934\u63d2\u6cd5\u3011\n                idx = new Index<K,V>(z, idx, null);\n            // \u5faa\u73af\u4ee5\u540e\u7684\u7d22\u5f15\u7ed3\u6784\n            // index-3\t\u2190 idx\n            //   \u2193\n            // index-2\n            //   \u2193\n            // index-1\n            //   \u2193\n            //  z-node\n        }\n        // 14.\u82e5 level > max\uff0c\u5219\u3010\u53ea\u589e\u52a0\u4e00\u5c42 index \u7d22\u5f15\u5c42\u3011\uff0c3 + 1 = 4\n        else { \n            level = max + 1;\n            //\u521b\u5efa\u4e00\u4e2a index \u6570\u7ec4\uff0c\u957f\u5ea6\u662f level+1\uff0c\u5047\u8bbe level \u662f 4\uff0c\u521b\u5efa\u7684\u6570\u7ec4\u957f\u5ea6\u4e3a 5\n            Index<K,V>[] idxs = (Index<K,V>[])new Index<?,?>[level+1];\n            // index[0]\u7684\u6570\u7ec4 slot \u5e76\u6ca1\u6709\u4f7f\u7528\uff0c\u53ea\u4f7f\u7528 [1,level] \u8fd9\u4e9b\u6570\u7ec4\u7684 slot\n            for (int i = 1; i <= level; ++i)\n                idxs[i] = idx = new Index<K,V>(z, idx, null);\n              \t\t// index-4   \u2190 idx\n                    //   \u2193\n                  \t// ......\n                    //   \u2193\n                    // index-1\n                    //   \u2193\n                    //  z-node\n            \n            for (;;) {\n                h = head;\n                // \u83b7\u53d6\u5934\u7d22\u5f15\u7684\u5c42\u6570\uff0c3\n                int oldLevel = h.level;\n                // \u5982\u679c level <= oldLevel\uff0c\u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u8fdb\u884c\u4e86 index \u5c42\u589e\u52a0\u64cd\u4f5c\uff0c\u9000\u51fa\u5faa\u73af\n                if (level <= oldLevel)\n                    break;\n                // \u5b9a\u4e49\u4e00\u4e2a\u65b0\u7684\u5934\u7d22\u5f15\u8282\u70b9\n                HeadIndex<K,V> newh = h;\n                // \u83b7\u53d6\u5934\u7d22\u5f15\u7684\u8282\u70b9\uff0c\u5c31\u662f BASE_HEADER\n                Node<K,V> oldbase = h.node;\n                // \u5347\u7ea7 baseHeader \u7d22\u5f15\uff0c\u5347\u9ad8\u4e00\u7ea7\uff0c\u5e76\u53d1\u4e0b\u53ef\u80fd\u5347\u9ad8\u591a\u7ea7\n                for (int j = oldLevel + 1; j <= level; ++j)\n                    // \u53c2\u65701\uff1a\u5e95\u5c42node\uff0c\u53c2\u6570\u4e8c\uff1adown\uff0c\u4e3a\u4ee5\u524d\u7684\u5934\u8282\u70b9\uff0c\u53c2\u6570\u4e09\uff1aright\uff0c\u65b0\u5efa\n                    newh = new HeadIndex<K,V>(oldbase, newh, idxs[j], j);\n                // \u6267\u884c\u5b8cfor\u5faa\u73af\u4e4b\u540e\uff0cbaseHeader \u7d22\u5f15\u957f\u8fd9\u4e2a\u6837\u5b50\uff0c\u8fd9\u91cc\u53ea\u5347\u9ad8\u4e00\u7ea7\n                // index-4             \u2192             index-4\t\u2190 idx\n                //   \u2193                                  \u2193\n                // index-3                           index-3     \n                //   \u2193                                  \u2193\n                // index-2                           index-2\n                //   \u2193                                  \u2193\n                // index-1                           index-1\n                //   \u2193                                  \u2193\n                // baseHeader    \u2192    ....      \u2192     z-node\n                \n                // cas \u6210\u529f\u540e\uff0chead \u5b57\u6bb5\u6307\u5411\u6700\u65b0\u7684 headIndex\uff0cbaseHeader \u7684 index-4\n                if (casHead(h, newh)) {\n                    // h \u6307\u5411\u6700\u65b0\u7684 index-4 \u8282\u70b9\n                    h = newh;\n                    // \u8ba9 idx \u6307\u5411 z-node \u7684 index-3 \u8282\u70b9\uff0c\n\t\t\t\t\t// \u56e0\u4e3a\u4ece index-3 - index-1 \u7684\u8fd9\u4e9b z-node \u7d22\u5f15\u8282\u70b9 \u90fd\u6ca1\u6709\u63d2\u5165\u5230\u7d22\u5f15\u94fe\u8868\n                    idx = idxs[level = oldLevel];\n                    break;\n                }\n            }\n        }\n        // 15.\u3010\u628a\u65b0\u52a0\u7684\u7d22\u5f15\u63d2\u5165\u7d22\u5f15\u94fe\u8868\u4e2d\u3011\uff0c\u6709\u4e0a\u8ff0\u4e24\u79cd\u60c5\u51b5\uff0c\u4e00\u79cd\u7d22\u5f15\u9ad8\u5ea6\u4e0d\u53d8\uff0c\u53e6\u4e00\u79cd\u662f\u9ad8\u5ea6\u52a0 1\n        // \u8981\u63d2\u5165\u7684\u662f\u7b2c\u51e0\u5c42\u7684\u7d22\u5f15\n        splice: for (int insertionLevel = level;;) {\n            // \u83b7\u53d6\u5934\u7d22\u5f15\u7684\u5c42\u6570\uff0c\u60c5\u51b5 1 \u662f 3\uff0c\u60c5\u51b5 2 \u662f 4\n            int j = h.level;\n            // \u3010\u904d\u5386 insertionLevel \u5c42\u7684\u7d22\u5f15\uff0c\u627e\u5230\u5408\u9002\u7684\u63d2\u5165\u4f4d\u7f6e\u3011\n            for (Index<K,V> q = h, r = q.right, t = idx;;) {\n                // \u5982\u679c\u5934\u7d22\u5f15\u4e3a null \u6216\u8005\u65b0\u589e\u8282\u70b9\u7d22\u5f15\u4e3a null\uff0c\u9000\u51fa\u63d2\u5165\u7d22\u5f15\u7684\u603b\u5faa\u73af\n                if (q == null || t == null)\n                    // \u6b64\u5904\u8868\u793a\u6709\u5176\u4ed6\u7ebf\u7a0b\u5220\u9664\u4e86\u5934\u7d22\u5f15\u6216\u8005\u65b0\u589e\u8282\u70b9\u7684\u7d22\u5f15\n                    break splice;\n                // \u5934\u7d22\u5f15\u7684\u94fe\u8868\u540e\u7eed\u7d22\u5f15\u5b58\u5728\uff0c\u5982\u679c\u662f\u65b0\u5c42\u5219\u4e3a\u65b0\u8282\u70b9\u7d22\u5f15\uff0c\u5982\u679c\u662f\u8001\u5c42\u5219\u4e3a\u539f\u7d22\u5f15\n                if (r != null) {\n                    // \u83b7\u53d6r\u7684\u8282\u70b9\n                    Node<K,V> n = r.node;\n                    // \u63d2\u5165\u7684key\u548cn.key\u7684\u6bd4\u8f83\u503c\n                    int c = cpr(cmp, key, n.key);\n                    // \u3010\u5220\u9664\u7a7a\u503c\u7d22\u5f15\u3011\n                    if (n.value == null) {\n                        if (!q.unlink(r))\n                            break;\n                        r = q.right;\n                        continue;\n                    }\n                    // key > r.node.key\uff0c\u5411\u53f3\u626b\u63cf\n                    if (c > 0) {\n                        q = r;\n                        r = r.right;\n                        continue;\n                    }\n                }\n                // \u6267\u884c\u5230\u8fd9\u91cc\uff0c\u8bf4\u660e key < r.node.key\uff0c\u5224\u65ad\u662f\u5426\u662f\u7b2c j \u5c42\u63d2\u5165\u65b0\u589e\u8282\u70b9\u7684\u524d\u7f6e\u7d22\u5f15\n                if (j == insertionLevel) {\n                    // \u3010\u5c06\u65b0\u7d22\u5f15\u8282\u70b9 t \u63d2\u5165 q r \u4e4b\u95f4\u3011\n                    if (!q.link(r, t))\n                        break; \n                    // \u5982\u679c\u65b0\u589e\u8282\u70b9\u7684\u503c\u4e3a null\uff0c\u8868\u793a\u8be5\u8282\u70b9\u5df2\u7ecf\u88ab\u5176\u4ed6\u7ebf\u7a0b\u5220\u9664\n                    if (t.node.value == null) {\n                        // \u627e\u5230\u8be5\u8282\u70b9\n                        findNode(key);\n                        break splice;\n                    }\n                    // \u63d2\u5165\u5c42\u9010\u5c42\u81ea\u51cf\uff0c\u5f53\u4e3a\u6700\u5e95\u5c42\u65f6\u9000\u51fa\u5faa\u73af\n                    if (--insertionLevel == 0)\n                        break splice;\n                }\n\t\t\t\t// \u5176\u4ed6\u8282\u70b9\u968f\u7740\u63d2\u5165\u8282\u70b9\u7684\u5c42\u6570\u4e0b\u79fb\u800c\u4e0b\u79fb\n                if (--j >= insertionLevel && j < level)\n                    t = t.down;\n                q = q.down;\n                r = q.right;\n            }\n        }\n    }\n    return null;\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"findNode()"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private Node<K,V> findNode(Object key) {\n    // \u539f\u7406\u4e0edoGet\u76f8\u540c\uff0c\u65e0\u975e\u662f findNode \u8fd4\u56de\u8282\u70b9\uff0cdoGet \u8fd4\u56de value\n    if ((c = cpr(cmp, key, n.key)) == 0)\n        return n;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u83b7\u53d6\u65b9\u6cd5-1",children:"\u83b7\u53d6\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"get(key)\uff1a\u83b7\u53d6\u5bf9\u5e94\u7684\u6570\u636e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public V get(Object key) {\n    return doGet(key);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"doGet()\uff1a\u626b\u63cf\u8fc7\u7a0b\u4f1a\u5bf9\u5df2 value = null \u7684\u5143\u7d20\u8fdb\u884c\u5220\u9664\u5904\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'private V doGet(Object key) {\n    if (key == null)\n        throw new NullPointerException();\n    Comparator<? super K> cmp = comparator;\n    outer: for (;;) {\n        // 1.\u627e\u5230\u6700\u5e95\u5c42\u8282\u70b9\u7684\u524d\u7f6e\u8282\u70b9\n        for (Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {\n            Object v; int c;\n            // 2.\u3010\u5982\u679c\u8be5\u524d\u7f6e\u8282\u70b9\u7684\u94fe\u8868\u540e\u7eed\u8282\u70b9\u4e3a null\uff0c\u8bf4\u660e\u4e0d\u5b58\u5728\u8be5\u8282\u70b9\u3011\n            if (n == null)\n                break outer;\n            // b \u2192 n \u2192 f\n            Node<K,V> f = n.next;\n            // 3.\u5982\u679cn\u4e0d\u4e3a\u524d\u7f6e\u8282\u70b9\u7684\u540e\u7eed\u8282\u70b9\uff0c\u8868\u793a\u5df2\u7ecf\u6709\u5176\u4ed6\u7ebf\u7a0b\u5220\u9664\u4e86\u8be5\u8282\u70b9\n            if (n != b.next) \n                break;\n            // 4.\u5982\u679c\u540e\u7eed\u8282\u70b9\u7684\u503c\u4e3anull\uff0c\u3010\u9700\u8981\u5e2e\u52a9\u5220\u9664\u8be5\u8282\u70b9\u3011\n            if ((v = n.value) == null) {\n                n.helpDelete(b, f);\n                break;\n            }\n            // 5.\u5982\u679c\u524d\u7f6e\u8282\u70b9\u5df2\u88ab\u5176\u4ed6\u7ebf\u7a0b\u5220\u9664\uff0c\u91cd\u65b0\u5faa\u73af\n            if (b.value == null || v == n)\n                break;\n             // 6.\u5982\u679c\u8981\u83b7\u53d6\u7684key\u4e0e\u540e\u7eed\u8282\u70b9\u7684key\u76f8\u7b49\uff0c\u8fd4\u56de\u8282\u70b9\u7684value\n            if ((c = cpr(cmp, key, n.key)) == 0) {\n                @SuppressWarnings("unchecked") V vv = (V)v;\n                return vv;\n            }\n            // 7.key < n.key\uff0c\u56e0\u4f4d key > b.key\uff0cb \u548c n \u76f8\u8fde\uff0c\u8bf4\u660e\u4e0d\u5b58\u5728\u8be5\u8282\u70b9\u6216\u8005\u88ab\u5176\u4ed6\u7ebf\u7a0b\u5220\u9664\u4e86\n            if (c < 0)\n                break outer;\n            b = n;\n            n = f;\n        }\n    }\n    return null;\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5220\u9664\u65b9\u6cd5-1",children:"\u5220\u9664\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"remove()"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public V remove(Object key) {\n    return doRemove(key, null);\n}\nfinal V doRemove(Object key, Object value) {\n    if (key == null)\n        throw new NullPointerException();\n    Comparator<? super K> cmp = comparator;\n    outer: for (;;) {\n        // 1.\u627e\u5230\u6700\u5e95\u5c42\u76ee\u6807\u8282\u70b9\u7684\u524d\u7f6e\u8282\u70b9\uff0cb.key < key\n        for (Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {\n            Object v; int c;\n            // 2.\u5982\u679c\u8be5\u524d\u7f6e\u8282\u70b9\u7684\u94fe\u8868\u540e\u7eed\u8282\u70b9\u4e3a null\uff0c\u9000\u51fa\u5faa\u73af\uff0c\u8bf4\u660e\u4e0d\u5b58\u5728\u8fd9\u4e2a\u5143\u7d20\n            if (n == null)\n                break outer;\n            // b \u2192 n \u2192 f\n            Node<K,V> f = n.next;\n            if (n != b.next)                    // inconsistent read\n                break;\n            if ((v = n.value) == null) {        // n is deleted\n                n.helpDelete(b, f);\n                break;\n            }\n            if (b.value == null || v == n)      // b is deleted\n                break;\n            //3.key < n.key\uff0c\u8bf4\u660e\u88ab\u5176\u4ed6\u7ebf\u7a0b\u5220\u9664\u4e86\uff0c\u6216\u8005\u4e0d\u5b58\u5728\u8be5\u8282\u70b9\n            if ((c = cpr(cmp, key, n.key)) < 0)\n                break outer;\n            //4.key > n.key\uff0c\u7ee7\u7eed\u5411\u540e\u626b\u63cf\n            if (c > 0) {\n                b = n;\n                n = f;\n                continue;\n            }\n            //5.\u5230\u8fd9\u91cc\u662f key = n.key\uff0cvalue \u4e0d\u4e3a\u7a7a\u7684\u60c5\u51b5\u4e0b\u5224\u65ad value \u548c n.value \u662f\u5426\u76f8\u7b49\n            if (value != null && !value.equals(v))\n                break outer;\n            //6.\u3010\u628a n \u8282\u70b9\u7684 value \u7f6e\u7a7a\u3011\n            if (!n.casValue(v, null))\n                break;\n            //7.\u3010\u7ed9 n \u6dfb\u52a0\u4e00\u4e2a\u5220\u9664\u6807\u5fd7 mark\u3011\uff0cmark.next = f\uff0c\u7136\u540e\u628a b.next \u8bbe\u7f6e\u4e3a f\uff0c\u6210\u529f\u540en\u51fa\u961f\n            if (!n.appendMarker(f) || !b.casNext(n, f))\n                // \u5bf9 key \u5bf9\u5e94\u7684 index \u8fdb\u884c\u5220\u9664\uff0c\u8c03\u7528\u4e86 findPredecessor \u65b9\u6cd5\n                findNode(key);\n            else {\n                // \u8fdb\u884c\u64cd\u4f5c\u5931\u8d25\u540e\u901a\u8fc7 findPredecessor \u4e2d\u8fdb\u884c index \u7684\u5220\u9664\n                findPredecessor(key, cmp);\n                if (head.right == null)\n                    // \u8fdb\u884cheadIndex \u5bf9\u5e94\u7684index \u5c42\u7684\u5220\u9664\n                    tryReduceLevel();\n            }\n            @SuppressWarnings("unchecked") V vv = (V)v;\n            return vv;\n        }\n    }\n    return null;\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u7ecf\u8fc7 findPredecessor() \u4e2d\u7684 unlink() \u540e\u7d22\u5f15\u5df2\u7ecf\u88ab\u5220\u9664"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(94862).A+"",width:"1752",height:"607"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"appendMarker()\uff1a\u6dfb\u52a0\u5220\u9664\u6807\u8bb0\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"boolean appendMarker(Node<K,V> f) {\n    // \u901a\u8fc7 CAS \u8ba9 n.next \u6307\u5411\u4e00\u4e2a key \u4e3a null\uff0cvalue \u4e3a this\uff0cnext \u4e3a f \u7684\u6807\u8bb0\u8282\u70b9\n    return casNext(f, new Node<K,V>(f));\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"helpDelete()\uff1a\u5c06\u6dfb\u52a0\u4e86\u5220\u9664\u6807\u8bb0\u7684\u8282\u70b9\u6e05\u9664\uff0c\u53c2\u6570\u662f\u8be5\u8282\u70b9\u7684\u524d\u9a71\u548c\u540e\u7ee7\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"void helpDelete(Node<K,V> b, Node<K,V> f) {\n    // this \u8282\u70b9\u7684\u540e\u7eed\u8282\u70b9\u4e3a f\uff0c\u4e14\u672c\u8eab\u4e3a b \u7684\u540e\u7eed\u8282\u70b9\uff0c\u4e00\u822c\u90fd\u662f\u6b63\u786e\u7684\uff0c\u9664\u975e\u88ab\u522b\u7684\u7ebf\u7a0b\u5220\u9664\n    if (f == next && this == b.next) {\n        // \u5982\u679c n \u8fd8\u8fd8\u6ca1\u6709\u88ab\u6807\u8bb0\n        if (f == null || f.value != f) \n            casNext(f, new Node<K,V>(f));\n        else\n            // \u901a\u8fc7 CAS\uff0c\u5c06 b \u7684\u4e0b\u4e00\u4e2a\u8282\u70b9 n \u53d8\u6210 f.next\uff0c\u5373\u6210\u4e3a\u56fe\u4e2d\u7684\u6837\u5f0f\n            b.casNext(this, f.next);\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"tryReduceLevel()\uff1a\u5220\u9664\u7d22\u5f15"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private void tryReduceLevel() {\n    HeadIndex<K,V> h = head;\n    HeadIndex<K,V> d;\n    HeadIndex<K,V> e;\n    if (h.level > 3 &&\n        (d = (HeadIndex<K,V>)h.down) != null &&\n        (e = (HeadIndex<K,V>)d.down) != null &&\n        e.right == null &&\n        d.right == null &&\n        h.right == null &&\n        // \u8bbe\u7f6e\u5934\u7d22\u5f15\n        casHead(h, d) && \n        // \u91cd\u65b0\u68c0\u67e5\n        h.right != null) \n        // \u91cd\u65b0\u68c0\u67e5\u8fd4\u56detrue\uff0c\u8bf4\u660e\u5176\u4ed6\u7ebf\u7a0b\u589e\u52a0\u4e86\u7d22\u5f15\u5c42\u7ea7\uff0c\u628a\u7d22\u5f15\u5934\u8282\u70b9\u8bbe\u7f6e\u56de\u6765\n        casHead(d, h);   \n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://my.oschina.net/u/3768341/blog/3135659",children:"https://my.oschina.net/u/3768341/blog/3135659"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://www.bilibili.com/video/BV1Er4y1P7k1",children:"https://www.bilibili.com/video/BV1Er4y1P7k1"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"noblocking",children:"NoBlocking"}),"\n",(0,r.jsx)(e.h4,{id:"\u975e\u963b\u585e\u961f\u5217",children:"\u975e\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.p,{children:"\u5e76\u53d1\u7f16\u7a0b\u4e2d\uff0c\u9700\u8981\u7528\u5230\u5b89\u5168\u7684\u961f\u5217\uff0c\u5b9e\u73b0\u5b89\u5168\u961f\u5217\u53ef\u4ee5\u4f7f\u7528 2 \u79cd\u65b9\u5f0f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u52a0\u9501\uff0c\u8fd9\u79cd\u5b9e\u73b0\u65b9\u5f0f\u662f\u963b\u585e\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u5faa\u73af CAS \u7b97\u6cd5\u5b9e\u73b0\uff0c\u8fd9\u79cd\u65b9\u5f0f\u662f\u975e\u963b\u585e\u961f\u5217"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"ConcurrentLinkedQueue \u662f\u4e00\u4e2a\u57fa\u4e8e\u94fe\u63a5\u8282\u70b9\u7684\u65e0\u754c\u7ebf\u7a0b\u5b89\u5168\u961f\u5217\uff0c\u91c7\u7528\u5148\u8fdb\u5148\u51fa\u7684\u89c4\u5219\u5bf9\u8282\u70b9\u8fdb\u884c\u6392\u5e8f\uff0c\u5f53\u6dfb\u52a0\u4e00\u4e2a\u5143\u7d20\u65f6\uff0c\u4f1a\u6dfb\u52a0\u5230\u961f\u5217\u7684\u5c3e\u90e8\uff0c\u5f53\u83b7\u53d6\u4e00\u4e2a\u5143\u7d20\u65f6\uff0c\u4f1a\u8fd4\u56de\u961f\u5217\u5934\u90e8\u7684\u5143\u7d20"}),"\n",(0,r.jsx)(e.p,{children:"\u8865\u5145\uff1aConcurrentLinkedDeque \u662f\u53cc\u5411\u94fe\u8868\u7ed3\u6784\u7684\u65e0\u754c\u5e76\u53d1\u961f\u5217"}),"\n",(0,r.jsx)(e.p,{children:"ConcurrentLinkedQueue \u4f7f\u7528\u7ea6\u5b9a\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e0d\u5141\u8bb8 null \u5165\u5217"}),"\n",(0,r.jsx)(e.li,{children:"\u961f\u5217\u4e2d\u6240\u6709\u672a\u5220\u9664\u7684\u8282\u70b9\u7684 item \u90fd\u4e0d\u80fd\u4e3a null \u4e14\u90fd\u80fd\u4ece head \u8282\u70b9\u904d\u5386\u5230"}),"\n",(0,r.jsx)(e.li,{children:"\u5220\u9664\u8282\u70b9\u662f\u5c06 item \u8bbe\u7f6e\u4e3a null\uff0c\u961f\u5217\u8fed\u4ee3\u65f6\u8df3\u8fc7 item \u4e3a null \u8282\u70b9"}),"\n",(0,r.jsxs)(e.li,{children:["head \u8282\u70b9\u8ddf tail \u4e0d\u4e00\u5b9a\u6307\u5411\u5934\u8282\u70b9\u6216\u5c3e\u8282\u70b9\uff0c\u53ef\u80fd",(0,r.jsx)(e.strong,{children:"\u5b58\u5728\u6ede\u540e\u6027"})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"ConcurrentLinkedQueue \u7531 head \u8282\u70b9\u548c tail \u8282\u70b9\u7ec4\u6210\uff0c\u6bcf\u4e2a\u8282\u70b9\u7531\u8282\u70b9\u5143\u7d20\u548c\u6307\u5411\u4e0b\u4e00\u4e2a\u8282\u70b9\u7684\u5f15\u7528\u7ec4\u6210\uff0c\u7ec4\u6210\u4e00\u5f20\u94fe\u8868\u7ed3\u6784\u7684\u961f\u5217"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"private transient volatile Node<E> head;\nprivate transient volatile Node<E> tail;\n\nprivate static class Node<E> {\n    volatile E item;\n    volatile Node<E> next;\n    //.....\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6784\u9020\u65b9\u6cd5-1",children:"\u6784\u9020\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u65e0\u53c2\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ConcurrentLinkedQueue() {\n    // \u9ed8\u8ba4\u60c5\u51b5\u4e0b head \u8282\u70b9\u5b58\u50a8\u7684\u5143\u7d20\u4e3a\u7a7a\uff0cdummy \u8282\u70b9\uff0ctail \u8282\u70b9\u7b49\u4e8e head \u8282\u70b9\n    head = tail = new Node<E>(null);\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6709\u53c2\u6784\u9020\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public ConcurrentLinkedQueue(Collection<? extends E> c) {\n    Node<E> h = null, t = null;\n    // \u904d\u5386\u8282\u70b9\n    for (E e : c) {\n        checkNotNull(e);\n        Node<E> newNode = new Node<E>(e);\n        if (h == null)\n            h = t = newNode;\n        else {\n            // \u5355\u5411\u94fe\u8868\n            t.lazySetNext(newNode);\n            t = newNode;\n        }\n    }\n    if (h == null)\n        h = t = new Node<E>(null);\n    head = h;\n    tail = t;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5165\u961f\u65b9\u6cd5",children:"\u5165\u961f\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u4e0e\u4f20\u7edf\u7684\u94fe\u8868\u4e0d\u540c\uff0c\u5355\u7ebf\u7a0b\u5165\u961f\u7684\u5de5\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5c06\u5165\u961f\u8282\u70b9\u8bbe\u7f6e\u6210\u5f53\u524d\u961f\u5217\u5c3e\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9"}),"\n",(0,r.jsxs)(e.li,{children:["\u66f4\u65b0 tail \u8282\u70b9\uff0c\u5982\u679c tail \u8282\u70b9\u7684 next \u8282\u70b9\u4e0d\u4e3a\u7a7a\uff0c\u5219\u5c06\u5165\u961f\u8282\u70b9\u8bbe\u7f6e\u6210 tail \u8282\u70b9\uff1b\u5982\u679c tail \u8282\u70b9\u7684 next \u8282\u70b9\u4e3a\u7a7a\uff0c\u5219\u5c06\u5165\u961f\u8282\u70b9\u8bbe\u7f6e\u6210 tail \u7684 next \u8282\u70b9\uff0c\u6240\u4ee5 tail \u8282\u70b9\u4e0d\u603b\u662f\u5c3e\u8282\u70b9\uff0c",(0,r.jsx)(e.strong,{children:"\u5b58\u5728\u6ede\u540e\u6027"})]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean offer(E e) {\n    checkNotNull(e);\n    // \u521b\u5efa\u5165\u961f\u8282\u70b9\n    final Node<E> newNode = new Node<E>(e);\n\t\n    // \u5faa\u73af CAS \u76f4\u5230\u5165\u961f\u6210\u529f\n    for (Node<E> t = tail, p = t;;) {\n        // p \u7528\u6765\u8868\u793a\u961f\u5217\u7684\u5c3e\u8282\u70b9\uff0c\u521d\u59cb\u60c5\u51b5\u4e0b\u7b49\u4e8e tail \u8282\u70b9\uff0cq \u662f p \u7684 next \u8282\u70b9\n        Node<E> q = p.next;\n        // \u6761\u4ef6\u6210\u7acb\u8bf4\u660e p \u662f\u5c3e\u8282\u70b9\n        if (q == null) {\n            // p \u662f\u5c3e\u8282\u70b9\uff0c\u8bbe\u7f6e p \u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\u4e3a\u65b0\u8282\u70b9\n            // \u8bbe\u7f6e\u6210\u529f\u5219 casNext \u8fd4\u56de true\uff0c\u5426\u5219\u8fd4\u56de false\uff0c\u8bf4\u660e\u6709\u5176\u4ed6\u7ebf\u7a0b\u66f4\u65b0\u8fc7\u5c3e\u8282\u70b9\uff0c\u7ee7\u7eed\u5bfb\u627e\u5c3e\u8282\u70b9\uff0c\u7ee7\u7eed CAS\n            if (p.casNext(null, newNode)) {\n                // \u9996\u6b21\u6dfb\u52a0\u65f6\uff0cp \u7b49\u4e8e t\uff0c\u4e0d\u8fdb\u884c\u5c3e\u8282\u70b9\u66f4\u65b0\uff0c\u6240\u4ee5\u5c3e\u8282\u70b9\u5b58\u5728\u6ede\u540e\u6027\n                if (p != t)\n                    // \u5c06 tail \u8bbe\u7f6e\u6210\u65b0\u5165\u961f\u7684\u8282\u70b9\uff0c\u8bbe\u7f6e\u5931\u8d25\u8868\u793a\u5176\u4ed6\u7ebf\u7a0b\u66f4\u65b0\u4e86 tail \u8282\u70b9\n                    casTail(t, newNode); \n                return true;\n            }\n        }\n        else if (p == q)\n            // \u5f53 tail \u4e0d\u6307\u5411\u6700\u540e\u8282\u70b9\u65f6\uff0c\u5982\u679c\u6267\u884c\u51fa\u5217\u64cd\u4f5c\uff0c\u53ef\u80fd\u5c06 tail \u4e5f\u79fb\u9664\uff0ctail \u4e0d\u5728\u94fe\u8868\u4e2d \n        \t// \u6b64\u65f6\u9700\u8981\u5bf9 tail \u8282\u70b9\u8fdb\u884c\u590d\u4f4d\uff0c\u590d\u4f4d\u5230 head \u8282\u70b9\n            p = (t != (t = tail)) ? t : head;\n        else\n            // \u63a8\u52a8 tail \u5c3e\u8282\u70b9\u5f80\u961f\u5c3e\u79fb\u52a8\n            p = (p != t && t != (t = tail)) ? t : q;\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u56fe\u89e3\u5165\u961f\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(82688).A+"",width:"1240",height:"441"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(61019).A+"",width:"1240",height:"612"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(29842).A+"",width:"1240",height:"602"})}),"\n",(0,r.jsxs)(e.p,{children:["\u5f53 tail \u8282\u70b9\u548c\u5c3e\u8282\u70b9\u7684\u8ddd\u79bb",(0,r.jsx)(e.strong,{children:"\u5927\u4e8e\u7b49\u4e8e 1"})," \u65f6\uff08\u6bcf\u5165\u961f\u4e24\u6b21\uff09\u66f4\u65b0 tail\uff0c\u53ef\u4ee5\u51cf\u5c11 CAS \u66f4\u65b0 tail \u8282\u70b9\u7684\u6b21\u6570\uff0c\u63d0\u9ad8\u5165\u961f\u6548\u7387"]}),"\n",(0,r.jsx)(e.p,{children:"\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b 1 \u7ebf\u7a0b 2 \u540c\u65f6\u5165\u961f\uff0c\u65e0\u8bba\u4ece\u54ea\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u5e76\u53d1\u5165\u961f\uff0c\u90fd\u53ef\u4ee5\u5faa\u73af CAS\uff0c\u76f4\u5230\u5165\u961f\u6210\u529f\uff0c\u7ebf\u7a0b\u5b89\u5168"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b 1 \u904d\u5386\uff0c\u7ebf\u7a0b 2 \u5165\u961f\uff0c\u6240\u4ee5\u9020\u6210 ConcurrentLinkedQueue \u7684 size \u662f\u53d8\u5316\uff0c\u9700\u8981\u52a0\u9501\u4fdd\u8bc1\u5b89\u5168"}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b 1 \u7ebf\u7a0b 2 \u540c\u65f6\u51fa\u5217\uff0c\u7ebf\u7a0b\u4e5f\u662f\u5b89\u5168\u7684"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u51fa\u961f\u65b9\u6cd5",children:"\u51fa\u961f\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.p,{children:"\u51fa\u961f\u5217\u7684\u5c31\u662f\u4ece\u961f\u5217\u91cc\u8fd4\u56de\u4e00\u4e2a\u8282\u70b9\u5143\u7d20\uff0c\u5e76\u6e05\u7a7a\u8be5\u8282\u70b9\u5bf9\u5143\u7d20\u7684\u5f15\u7528\uff0c\u5e76\u4e0d\u662f\u6bcf\u6b21\u51fa\u961f\u90fd\u66f4\u65b0 head \u8282\u70b9"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5f53 head \u8282\u70b9\u91cc\u6709\u5143\u7d20\u65f6\uff0c\u76f4\u63a5\u5f39\u51fa head \u8282\u70b9\u91cc\u7684\u5143\u7d20\uff0c\u800c\u4e0d\u4f1a\u66f4\u65b0 head \u8282\u70b9"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53 head \u8282\u70b9\u91cc\u6ca1\u6709\u5143\u7d20\u65f6\uff0c\u51fa\u961f\u64cd\u4f5c\u624d\u4f1a\u66f4\u65b0 head \u8282\u70b9"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u6279\u5904\u7406\u65b9\u5f0f"}),"\u53ef\u4ee5\u51cf\u5c11\u4f7f\u7528 CAS \u66f4\u65b0 head \u8282\u70b9\u7684\u6d88\u8017\uff0c\u4ece\u800c\u63d0\u9ad8\u51fa\u961f\u6548\u7387"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public E poll() {\n    restartFromHead:\n    for (;;) {\n        // p \u8282\u70b9\u8868\u793a\u9996\u8282\u70b9\uff0c\u5373\u9700\u8981\u51fa\u961f\u7684\u8282\u70b9\uff0cFIFO\n        for (Node<E> h = head, p = h, q;;) {\n            E item = p.item;\n\t\t\t// \u5982\u679c p \u8282\u70b9\u7684\u5143\u7d20\u4e0d\u4e3a null\uff0c\u5219\u901a\u8fc7 CAS \u6765\u8bbe\u7f6e p \u8282\u70b9\u5f15\u7528\u5143\u7d20\u4e3a null\uff0c\u6210\u529f\u8fd4\u56de item\n            if (item != null && p.casItem(item, null)) {\n                if (p != h)\t\n                   \t// \u5bf9 head \u8fdb\u884c\u79fb\u52a8\n                    updateHead(h, ((q = p.next) != null) ? q : p);\n                return item;\n            }\n           \t// \u903b\u8f91\u5230\u8fd9\u8bf4\u660e\u5934\u8282\u70b9\u7684\u5143\u7d20\u4e3a\u7a7a\u6216\u5934\u8282\u70b9\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u5934\u8282\u70b9\u88ab\u53e6\u5916\u4e00\u4e2a\u7ebf\u7a0b\u4fee\u6539\u4e86\n            // \u90a3\u4e48\u83b7\u53d6 p \u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\uff0c\u5982\u679c p \u8282\u70b9\u7684\u4e0b\u4e00\u8282\u70b9\u4e5f\u4e3a null\uff0c\u5219\u8868\u660e\u961f\u5217\u5df2\u7ecf\u7a7a\u4e86\n            else if ((q = p.next) == null) {\n                updateHead(h, p);\n                return null;\n            }\n      \t\t// \u7b2c\u4e00\u8f6e\u64cd\u4f5c\u5931\u8d25\uff0c\u4e0b\u4e00\u8f6e\u7ee7\u7eed\uff0c\u8c03\u56de\u5230\u5faa\u73af\u524d\n            else if (p == q)\n                continue restartFromHead;\n            // \u5982\u679c\u4e0b\u4e00\u4e2a\u5143\u7d20\u4e0d\u4e3a\u7a7a\uff0c\u5219\u5c06\u5934\u8282\u70b9\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\u8bbe\u7f6e\u6210\u5934\u8282\u70b9\n            else\n                p = q;\n        }\n    }\n}\nfinal void updateHead(Node<E> h, Node<E> p) {\n    if (h != p && casHead(h, p))\n        // \u5c06\u65e7\u7ed3\u70b9 h \u7684 next \u57df\u6307\u5411\u4e3a h\uff0chelp gc\n        h.lazySetNext(h);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u66f4\u65b0\u5b8c head \u4e4b\u540e\uff0c\u4f1a\u5c06\u65e7\u7684\u5934\u7ed3\u70b9 h \u7684 next \u57df\u6307\u5411\u4e3a h\uff0c\u56fe\u4e2d\u6240\u793a\u7684\u865a\u7ebf\u4e5f\u5c31\u8868\u793a\u8fd9\u4e2a\u8282\u70b9\u7684\u81ea\u5f15\u7528\uff0c\u88ab\u79fb\u52a8\u7684\u8282\u70b9\uff08item \u4e3a null \u7684\u8282\u70b9\uff09\u4f1a\u88ab GC \u56de\u6536"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(99011).A+"",width:"1750",height:"705"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(62152).A+"",width:"1620",height:"548"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(2097).A+"",width:"1552",height:"398"})}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u8fd9\u65f6\uff0c\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6765\u6dfb\u52a0\u5143\u7d20\uff0c\u901a\u8fc7 tail \u83b7\u53d6\u7684 next \u8282\u70b9\u5219\u4ecd\u7136\u662f\u5b83\u672c\u8eab\uff0c\u8fd9\u5c31\u51fa\u73b0\u4e86p == q \u7684\u60c5\u51b5\uff0c\u51fa\u73b0\u8be5\u79cd\u60c5\u51b5\u4e4b\u540e\uff0c\u5219\u4f1a\u89e6\u53d1\u6267\u884c head \u7684\u66f4\u65b0\uff0c\u5c06 p \u8282\u70b9\u91cd\u65b0\u6307\u5411\u4e3a head"}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://www.jianshu.com/p/231caf90f30b",children:"https://www.jianshu.com/p/231caf90f30b"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6210\u5458\u65b9\u6cd5-8",children:"\u6210\u5458\u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"peek()\uff1a\u4f1a\u6539\u53d8 head \u6307\u5411\uff0c\u6267\u884c peek() \u65b9\u6cd5\u540e head \u4f1a\u6307\u5411\u7b2c\u4e00\u4e2a\u5177\u6709\u975e\u7a7a\u5143\u7d20\u7684\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u83b7\u53d6\u94fe\u8868\u7684\u9996\u90e8\u5143\u7d20\uff0c\u53ea\u8bfb\u53d6\u800c\u4e0d\u79fb\u9664\npublic E peek() {\n    restartFromHead:\n    for (;;) {\n        for (Node<E> h = head, p = h, q;;) {\n            E item = p.item;\n            if (item != null || (q = p.next) == null) {\n                // \u66f4\u6539h\u7684\u4f4d\u7f6e\u4e3a\u975e\u7a7a\u5143\u7d20\u8282\u70b9\n                updateHead(h, p);\n                return item;\n            }\n            else if (p == q)\n                continue restartFromHead;\n            else\n                p = q;\n        }\n    }\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"size()\uff1a\u7528\u6765\u83b7\u53d6\u5f53\u524d\u961f\u5217\u7684\u5143\u7d20\u4e2a\u6570\uff0c\u56e0\u4e3a\u6574\u4e2a\u8fc7\u7a0b\u90fd\u6ca1\u6709\u52a0\u9501\uff0c\u5728\u5e76\u53d1\u73af\u5883\u4e2d\u4ece\u8c03\u7528 size \u65b9\u6cd5\u5230\u8fd4\u56de\u7ed3\u679c\u671f\u95f4\u6709\u53ef\u80fd\u589e\u5220\u5143\u7d20\uff0c\u5bfc\u81f4\u7edf\u8ba1\u7684\u5143\u7d20\u4e2a\u6570\u4e0d\u7cbe\u786e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public int size() {\n    int count = 0;\n    // first() \u83b7\u53d6\u7b2c\u4e00\u4e2a\u5177\u6709\u975e\u7a7a\u5143\u7d20\u7684\u8282\u70b9\uff0c\u82e5\u4e0d\u5b58\u5728\uff0c\u8fd4\u56de null\n    // succ(p) \u65b9\u6cd5\u83b7\u53d6 p \u7684\u540e\u7ee7\u8282\u70b9\uff0c\u82e5 p == p.next\uff0c\u5219\u8fd4\u56de head\n    // \u7c7b\u4f3c\u904d\u5386\u94fe\u8868\n    for (Node<E> p = first(); p != null; p = succ(p))\n        if (p.item != null)\n            // \u6700\u5927\u8fd4\u56deInteger.MAX_VALUE\n            if (++count == Integer.MAX_VALUE)\n                break;\n    return count;\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"remove()\uff1a\u79fb\u9664\u5143\u7d20"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public boolean remove(Object o) {\n    // \u5220\u9664\u7684\u5143\u7d20\u4e0d\u80fd\u4e3anull\n    if (o != null) {\n        Node<E> next, pred = null;\n        for (Node<E> p = first(); p != null; pred = p, p = next) {\n            boolean removed = false;\n            E item = p.item;\n            // \u8282\u70b9\u5143\u7d20\u4e0d\u4e3anull\n            if (item != null) {\n                // \u82e5\u4e0d\u5339\u914d\uff0c\u5219\u83b7\u53d6next\u8282\u70b9\u7ee7\u7eed\u5339\u914d\n                if (!o.equals(item)) {\n                    next = succ(p);\n                    continue;\n                }\n                // \u82e5\u5339\u914d\uff0c\u5219\u901a\u8fc7 CAS \u64cd\u4f5c\u5c06\u5bf9\u5e94\u8282\u70b9\u5143\u7d20\u7f6e\u4e3a null\n                removed = p.casItem(item, null);\n            }\n            // \u83b7\u53d6\u5220\u9664\u8282\u70b9\u7684\u540e\u7ee7\u8282\u70b9\n            next = succ(p);\n            // \u5c06\u88ab\u5220\u9664\u7684\u8282\u70b9\u79fb\u9664\u961f\u5217\n            if (pred != null && next != null) // unlink\n                pred.casNext(p, next);\n            if (removed)\n                return true;\n        }\n    }\n    return false;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h1,{id:"net",children:"NET"}),"\n",(0,r.jsx)(e.h2,{id:"des",children:"DES"}),"\n",(0,r.jsx)(e.h3,{id:"\u7f51\u7edc\u7f16\u7a0b",children:"\u7f51\u7edc\u7f16\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:"\u7f51\u7edc\u7f16\u7a0b\uff0c\u5c31\u662f\u5728\u4e00\u5b9a\u7684\u534f\u8bae\u4e0b\uff0c\u5b9e\u73b0\u4e24\u53f0\u8ba1\u7b97\u673a\u7684\u901a\u4fe1\u7684\u6280\u672f"}),"\n",(0,r.jsx)(e.p,{children:"\u901a\u4fe1\u4e00\u5b9a\u662f\u57fa\u4e8e\u8f6f\u4ef6\u7ed3\u6784\u5b9e\u73b0\u7684:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"C/S \u7ed3\u6784 \uff1a\u5168\u79f0\u4e3a Client/Server \u7ed3\u6784\uff0c\u662f\u6307\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7ed3\u6784\uff0c\u5e38\u89c1\u7a0b\u5e8f\u6709 QQ\u3001IDEA \u7b49\u8f6f\u4ef6"}),"\n",(0,r.jsx)(e.li,{children:"B/S \u7ed3\u6784 \uff1a\u5168\u79f0\u4e3a Browser/Server \u7ed3\u6784\uff0c\u662f\u6307\u6d4f\u89c8\u5668\u548c\u670d\u52a1\u5668\u7ed3\u6784"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e24\u79cd\u67b6\u6784\u5404\u6709\u4f18\u52bf\uff0c\u4f46\u662f\u65e0\u8bba\u54ea\u79cd\u67b6\u6784\uff0c\u90fd\u79bb\u4e0d\u5f00\u7f51\u7edc\u7684\u652f\u6301"}),"\n",(0,r.jsx)(e.p,{children:"\u7f51\u7edc\u901a\u4fe1\u7684\u4e09\u8981\u7d20\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u534f\u8bae\uff1a\u8ba1\u7b97\u673a\u7f51\u7edc\u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u7aef\u901a\u4fe1\u5fc5\u987b\u7ea6\u5b9a\u548c\u5f7c\u6b64\u9075\u5b88\u7684\u901a\u4fe1\u89c4\u5219\uff0cHTTP\u3001FTP\u3001TCP\u3001UDP\u3001SMTP"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"IP \u5730\u5740\uff1a\u4e92\u8054\u7f51\u534f\u8bae\u5730\u5740\uff08Internet Protocol Address\uff09\uff0c\u7528\u6765\u7ed9\u4e00\u4e2a\u7f51\u7edc\u4e2d\u7684\u8ba1\u7b97\u673a\u8bbe\u5907\u505a\u552f\u4e00\u7684\u7f16\u53f7"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"IPv4\uff1a4 \u4e2a\u5b57\u8282\uff0c32 \u4f4d\u7ec4\u6210\uff0c192.168.1.1"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"IPv6\uff1a\u53ef\u4ee5\u5b9e\u73b0\u4e3a\u6240\u6709\u8bbe\u5907\u5206\u914d IP\uff0c128 \u4f4d"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"ipconfig\uff1a\u67e5\u770b\u672c\u673a\u7684 IP"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"ping \u68c0\u67e5\u672c\u673a\u4e0e\u67d0\u4e2a IP \u6307\u5b9a\u7684\u673a\u5668\u662f\u5426\u8054\u901a\uff0c\u6216\u8005\u8bf4\u662f\u68c0\u6d4b\u5bf9\u65b9\u662f\u5426\u5728\u7ebf\u3002"}),"\n",(0,r.jsxs)(e.li,{children:["ping \u7a7a\u683c IP\u5730\u5740 \uff1aping 220.181.57.216\uff0cping ",(0,r.jsx)(e.a,{href:"http://www.baidu.com",children:"www.baidu.com"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u7279\u6b8a\u7684IP\u5730\u5740\uff1a \u672c\u673aIP\u5730\u5740\uff0c",(0,r.jsx)(e.strong,{children:"127.0.0.1 == localhost"}),"\uff0c\u56de\u73af\u6d4b\u8bd5"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7aef\u53e3\uff1a\u7aef\u53e3\u53f7\u5c31\u53ef\u4ee5\u552f\u4e00\u6807\u8bc6\u8bbe\u5907\u4e2d\u7684\u8fdb\u7a0b\uff08\u5e94\u7528\u7a0b\u5e8f\uff09\u3002\u7aef\u53e3\u53f7\u662f\u7528\u4e24\u4e2a\u5b57\u8282\u8868\u793a\u7684\u6574\u6570\uff0c\u53d6\u503c\u8303\u56f4\u662f 0-65535\uff0c0-1023 \u4e4b\u95f4\u7684\u7aef\u53e3\u53f7\u7528\u4e8e\u4e00\u4e9b\u77e5\u540d\u7684\u7f51\u7edc\u670d\u52a1\u548c\u5e94\u7528\u666e\u901a\u7684\u5e94\u7528\u7a0b\u5e8f\u9700\u8981\u4f7f\u7528 1024 \u4ee5\u4e0a\u7684\u7aef\u53e3\u53f7\u3002\u5982\u679c\u7aef\u53e3\u53f7\u88ab\u53e6\u5916\u4e00\u4e2a\u670d\u52a1\u6216\u5e94\u7528\u6240\u5360\u7528\uff0c\u4f1a\u5bfc\u81f4\u5f53\u524d\u7a0b\u5e8f\u542f\u52a8\u5931\u8d25\uff0c\u62a5\u51fa\u7aef\u53e3\u88ab\u5360\u7528\u5f02\u5e38"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5229\u7528",(0,r.jsx)(e.strong,{children:"\u534f\u8bae+IP \u5730\u5740+\u7aef\u53e3\u53f7"}),"\u4e09\u5143\u7ec4\u5408\uff0c\u5c31\u53ef\u4ee5\u6807\u8bc6\u7f51\u7edc\u4e2d\u7684\u8fdb\u7a0b\u4e86\uff0c\u90a3\u4e48\u8fdb\u7a0b\u95f4\u7684\u901a\u4fe1\u5c31\u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a\u6807\u8bc6\u4e0e\u5176\u5b83\u8fdb\u7a0b\u8fdb\u884c\u4ea4\u4e92"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://www.bilibili.com/video/BV1kT4y1M7vt",children:"https://www.bilibili.com/video/BV1kT4y1M7vt"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u901a\u4fe1\u534f\u8bae",children:"\u901a\u4fe1\u534f\u8bae"}),"\n",(0,r.jsx)(e.p,{children:"\u7f51\u7edc\u901a\u4fe1\u534f\u8bae\uff1a\u5bf9\u8ba1\u7b97\u673a\u5fc5\u987b\u9075\u5b88\u7684\u89c4\u5219\uff0c\u53ea\u6709\u9075\u5b88\u8fd9\u4e9b\u89c4\u5219\uff0c\u8ba1\u7b97\u673a\u4e4b\u95f4\u624d\u80fd\u8fdb\u884c\u901a\u4fe1"}),"\n",(0,r.jsxs)(e.p,{children:["\u901a\u4fe1",(0,r.jsx)(e.strong,{children:"\u662f\u8fdb\u7a0b\u4e0e\u8fdb\u7a0b\u4e4b\u95f4\u7684\u901a\u4fe1"}),"\uff0c\u4e0d\u662f\u4e3b\u673a\u4e0e\u4e3b\u673a\u4e4b\u95f4\u7684\u901a\u4fe1"]}),"\n",(0,r.jsx)(e.p,{children:"TCP/IP\u534f\u8bae\uff1a\u4f20\u8f93\u63a7\u5236\u534f\u8bae (Transmission Control Protocol)"}),"\n",(0,r.jsx)(e.p,{children:"\u4f20\u8f93\u63a7\u5236\u534f\u8bae TCP\uff08Transmission Control Protocol\uff09\u662f\u9762\u5411\u8fde\u63a5\u7684\uff0c\u63d0\u4f9b\u53ef\u9760\u4ea4\u4ed8\uff0c\u6709\u6d41\u91cf\u63a7\u5236\uff0c\u62e5\u585e\u63a7\u5236\uff0c\u63d0\u4f9b\u5168\u53cc\u5de5\u901a\u4fe1\uff0c\u9762\u5411\u5b57\u8282\u6d41\uff0c\u6bcf\u4e00\u6761 TCP \u8fde\u63a5\u53ea\u80fd\u662f\u70b9\u5bf9\u70b9\u7684\uff08\u4e00\u5bf9\u4e00\uff09"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5728\u901a\u4fe1\u4e4b\u524d\u5fc5\u987b\u786e\u5b9a\u5bf9\u65b9\u5728\u7ebf\u5e76\u4e14\u8fde\u63a5\u6210\u529f\u624d\u53ef\u4ee5\u901a\u4fe1"}),"\n",(0,r.jsx)(e.li,{children:"\u4f8b\u5982\u4e0b\u8f7d\u6587\u4ef6\u3001\u6d4f\u89c8\u7f51\u9875\u7b49\uff08\u8981\u6c42\u53ef\u9760\u4f20\u8f93\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u6237\u6570\u636e\u62a5\u534f\u8bae UDP\uff08User Datagram Protocol\uff09\u662f\u65e0\u8fde\u63a5\u7684\uff0c\u5c3d\u6700\u5927\u53ef\u80fd\u4ea4\u4ed8\uff0c\u4e0d\u53ef\u9760\uff0c\u6ca1\u6709\u62e5\u585e\u63a7\u5236\uff0c\u9762\u5411\u62a5\u6587\uff0c\u652f\u6301\u4e00\u5bf9\u4e00\u3001\u4e00\u5bf9\u591a\u3001\u591a\u5bf9\u4e00\u548c\u591a\u5bf9\u591a\u7684\u4ea4\u4e92\u901a\u4fe1"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u76f4\u63a5\u53d1\u6d88\u606f\u7ed9\u5bf9\u65b9\uff0c\u4e0d\u7ba1\u5bf9\u65b9\u662f\u5426\u5728\u7ebf\uff0c\u53d1\u6d88\u606f\u540e\u4e5f\u4e0d\u9700\u8981\u786e\u8ba4"}),"\n",(0,r.jsx)(e.li,{children:"\u65e0\u7ebf\uff08\u89c6\u9891\u4f1a\u8bae\uff0c\u901a\u8bdd\uff09\uff0c\u6027\u80fd\u597d\uff0c\u53ef\u80fd\u4e22\u5931\u4e00\u4e9b\u6570\u636e"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"java\u6a21\u578b",children:"Java\u6a21\u578b"}),"\n",(0,r.jsx)(e.p,{children:"\u76f8\u5173\u6982\u5ff5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u540c\u6b65\uff1a\u5f53\u524d\u7ebf\u7a0b\u8981\u81ea\u5df1\u8fdb\u884c\u6570\u636e\u7684\u8bfb\u5199\u64cd\u4f5c\uff08\u81ea\u5df1\u53bb\u94f6\u884c\u53d6\u94b1\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u5f02\u6b65\uff1a\u5f53\u524d\u7ebf\u7a0b\u53ef\u4ee5\u53bb\u505a\u5176\u4ed6\u4e8b\u60c5\uff08\u59d4\u6258\u522b\u4eba\u62ff\u94f6\u884c\u5361\u5230\u94f6\u884c\u53d6\u94b1\uff0c\u7136\u540e\u7ed9\u4f60\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u963b\u585e\uff1a\u5728\u6570\u636e\u6ca1\u6709\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd8\u662f\u8981\u7ee7\u7eed\u7b49\u5f85\u7740\u8bfb\uff08\u6392\u961f\u7b49\u5f85\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u975e\u963b\u585e\uff1a\u5728\u6570\u636e\u6ca1\u6709\u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u53bb\u505a\u5176\u4ed6\u4e8b\u60c5\uff0c\u4e00\u65e6\u6709\u4e86\u6570\u636e\u518d\u6765\u83b7\u53d6\uff08\u67dc\u53f0\u53d6\u6b3e\uff0c\u53d6\u4e2a\u53f7\uff0c\u7136\u540e\u5750\u5728\u6905\u5b50\u4e0a\u505a\u5176\u5b83\u4e8b\uff0c\u7b49\u53f7\u5e7f\u64ad\u4f1a\u901a\u77e5\u4f60\u529e\u7406\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Java \u4e2d\u7684\u901a\u4fe1\u6a21\u578b:"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"BIO \u8868\u793a\u540c\u6b65\u963b\u585e\u5f0f\u901a\u4fe1\uff0c\u670d\u52a1\u5668\u5b9e\u73b0\u6a21\u5f0f\u4e3a\u4e00\u4e2a\u8fde\u63a5\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5373\u5ba2\u6237\u7aef\u6709\u8fde\u63a5\u8bf7\u6c42\u65f6\u670d\u52a1\u5668\u7aef\u5c31\u9700\u8981\u542f\u52a8\u4e00\u4e2a\u7ebf\u7a0b\u8fdb\u884c\u5904\u7406\uff0c\u5982\u679c\u8fd9\u4e2a\u8fde\u63a5\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5\u4f1a\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u7ebf\u7a0b\u5f00\u9500\uff0c\u53ef\u4ee5\u901a\u8fc7\u7ebf\u7a0b\u6c60\u673a\u5236\u6539\u5584"}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u6b65\u963b\u585e\u5f0f\u6027\u80fd\u6781\u5dee\uff1a\u5927\u91cf\u7ebf\u7a0b\uff0c\u5927\u91cf\u963b\u585e"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4f2a\u5f02\u6b65\u901a\u4fe1\uff1a\u5f15\u5165\u7ebf\u7a0b\u6c60\uff0c\u4e0d\u9700\u8981\u4e00\u4e2a\u5ba2\u6237\u7aef\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5b9e\u73b0\u7ebf\u7a0b\u590d\u7528\u6765\u5904\u7406\u5f88\u591a\u4e2a\u5ba2\u6237\u7aef\uff0c\u7ebf\u7a0b\u53ef\u63a7"}),"\n",(0,r.jsx)(e.p,{children:"\u9ad8\u5e76\u53d1\u4e0b\u6027\u80fd\u8fd8\u662f\u5f88\u5dee\uff1a\u7ebf\u7a0b\u6570\u91cf\u5c11\uff0c\u6570\u636e\u4f9d\u7136\u662f\u963b\u585e\u7684\uff0c\u6570\u636e\u6ca1\u6709\u6765\u7ebf\u7a0b\u8fd8\u662f\u8981\u7b49\u5f85"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["NIO \u8868\u793a",(0,r.jsx)(e.strong,{children:"\u540c\u6b65\u975e\u963b\u585e IO"}),"\uff0c\u670d\u52a1\u5668\u5b9e\u73b0\u6a21\u5f0f\u4e3a\u8bf7\u6c42\u5bf9\u5e94\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u8fde\u63a5\u4f1a\u6ce8\u518c\u5230\u591a\u8def\u590d\u7528\u5668\u4e0a\uff0c\u591a\u8def\u590d\u7528\u5668\u8f6e\u8be2\u5230\u8fde\u63a5\u6709 I/O \u8bf7\u6c42\u65f6\u624d\u542f\u52a8\u4e00\u4e2a\u7ebf\u7a0b\u8fdb\u884c\u5904\u7406"]}),"\n",(0,r.jsx)(e.p,{children:"\u5de5\u4f5c\u539f\u7406\uff1a1 \u4e2a\u4e3b\u7ebf\u7a0b\u4e13\u95e8\u8d1f\u8d23\u63a5\u6536\u5ba2\u6237\u7aef\uff0c1 \u4e2a\u7ebf\u7a0b\u8f6e\u8be2\u6240\u6709\u7684\u5ba2\u6237\u7aef\uff0c\u53d1\u6765\u4e86\u6570\u636e\u624d\u4f1a\u5f00\u542f\u7ebf\u7a0b\u5904\u7406"}),"\n",(0,r.jsx)(e.p,{children:"\u540c\u6b65\uff1a\u7ebf\u7a0b\u8fd8\u8981\u4e0d\u65ad\u7684\u63a5\u6536\u5ba2\u6237\u7aef\u8fde\u63a5\uff0c\u4ee5\u53ca\u5904\u7406\u6570\u636e"}),"\n",(0,r.jsx)(e.p,{children:"\u975e\u963b\u585e\uff1a\u5982\u679c\u4e00\u4e2a\u7ba1\u9053\u6ca1\u6709\u6570\u636e\uff0c\u4e0d\u9700\u8981\u7b49\u5f85\uff0c\u53ef\u4ee5\u8f6e\u8be2\u4e0b\u4e00\u4e2a\u7ba1\u9053\u662f\u5426\u6709\u6570\u636e"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"AIO \u8868\u793a\u5f02\u6b65\u975e\u963b\u585e IO\uff0cAIO \u5f15\u5165\u5f02\u6b65\u901a\u9053\u7684\u6982\u5ff5\uff0c\u91c7\u7528\u4e86 Proactor \u6a21\u5f0f\uff0c\u6709\u6548\u7684\u8bf7\u6c42\u624d\u542f\u52a8\u7ebf\u7a0b\uff0c\u7279\u70b9\u662f\u5148\u7531\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u540e\u624d\u901a\u77e5\u670d\u52a1\u7aef\u7a0b\u5e8f\u542f\u52a8\u7ebf\u7a0b\u53bb\u5904\u7406\uff0c\u4e00\u822c\u9002\u7528\u4e8e\u8fde\u63a5\u6570\u8f83\u591a\u4e14\u8fde\u63a5\u65f6\u95f4\u8f83\u957f\u7684\u5e94\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u5f02\u6b65\uff1a\u670d\u52a1\u7aef\u7ebf\u7a0b\u63a5\u6536\u5230\u4e86\u5ba2\u6237\u7aef\u7ba1\u9053\u4ee5\u540e\u5c31\u4ea4\u7ed9\u5e95\u5c42\u5904\u7406 IO \u901a\u4fe1\uff0c\u7ebf\u7a0b\u53ef\u4ee5\u505a\u5176\u4ed6\u4e8b\u60c5"}),"\n",(0,r.jsx)(e.p,{children:"\u975e\u963b\u585e\uff1a\u5e95\u5c42\u4e5f\u662f\u5ba2\u6237\u7aef\u6709\u6570\u636e\u624d\u4f1a\u5904\u7406\uff0c\u6709\u4e86\u6570\u636e\u4ee5\u540e\u5904\u7406\u597d\u901a\u77e5\u670d\u52a1\u5668\u5e94\u7528\u6765\u542f\u52a8\u7ebf\u7a0b\u8fdb\u884c\u5904\u7406"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5404\u79cd\u6a21\u578b\u5e94\u7528\u573a\u666f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"BIO \u9002\u7528\u4e8e\u8fde\u63a5\u6570\u76ee\u6bd4\u8f83\u5c0f\u4e14\u56fa\u5b9a\u7684\u67b6\u6784\uff0c\u8be5\u65b9\u5f0f\u5bf9\u670d\u52a1\u5668\u8d44\u6e90\u8981\u6c42\u6bd4\u8f83\u9ad8\uff0c\u5e76\u53d1\u5c40\u9650\u4e8e\u5e94\u7528\u4e2d\uff0c\u7a0b\u5e8f\u7b80\u5355"}),"\n",(0,r.jsx)(e.li,{children:"NIO \u9002\u7528\u4e8e\u8fde\u63a5\u6570\u76ee\u591a\u4e14\u8fde\u63a5\u6bd4\u8f83\u77ed\uff08\u8f7b\u64cd\u4f5c\uff09\u7684\u67b6\u6784\uff0c\u5982\u804a\u5929\u670d\u52a1\u5668\uff0c\u5e76\u53d1\u5c40\u9650\u4e8e\u5e94\u7528\u4e2d\uff0c\u7f16\u7a0b\u590d\u6742\uff0cJDK 1.4 \u5f00\u59cb\u652f\u6301"}),"\n",(0,r.jsx)(e.li,{children:"AIO \u9002\u7528\u4e8e\u8fde\u63a5\u6570\u76ee\u591a\u4e14\u8fde\u63a5\u6bd4\u8f83\u957f\uff08\u91cd\u64cd\u4f5c\uff09\u7684\u67b6\u6784\uff0c\u5982\u76f8\u518c\u670d\u52a1\u5668\uff0c\u5145\u5206\u8c03\u7528\u64cd\u4f5c\u7cfb\u7edf\u53c2\u4e0e\u5e76\u53d1\u64cd\u4f5c\uff0cJDK 1.7 \u5f00\u59cb\u652f\u6301"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"io",children:"I/O"}),"\n",(0,r.jsx)(e.h3,{id:"io\u6a21\u578b",children:"IO\u6a21\u578b"}),"\n",(0,r.jsx)(e.h4,{id:"\u4e94\u79cd\u6a21\u578b",children:"\u4e94\u79cd\u6a21\u578b"}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u4e8e\u4e00\u4e2a\u5957\u63a5\u5b57\u4e0a\u7684\u8f93\u5165\u64cd\u4f5c\uff0c\u7b2c\u4e00\u6b65\u662f\u7b49\u5f85\u6570\u636e\u4ece\u7f51\u7edc\u4e2d\u5230\u8fbe\uff0c\u5f53\u6570\u636e\u5230\u8fbe\u65f6\u88ab\u590d\u5236\u5230\u5185\u6838\u4e2d\u7684\u67d0\u4e2a\u7f13\u51b2\u533a\u3002\u7b2c\u4e8c\u6b65\u5c31\u662f\u628a\u6570\u636e\u4ece\u5185\u6838\u7f13\u51b2\u533a\u590d\u5236\u5230\u5e94\u7528\u8fdb\u7a0b\u7f13\u51b2\u533a"}),"\n",(0,r.jsx)(e.p,{children:"Linux \u6709\u4e94\u79cd I/O \u6a21\u578b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u963b\u585e\u5f0f I/O"}),"\n",(0,r.jsx)(e.li,{children:"\u975e\u963b\u585e\u5f0f I/O"}),"\n",(0,r.jsx)(e.li,{children:"I/O \u590d\u7528\uff08select \u548c poll\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u4fe1\u53f7\u9a71\u52a8\u5f0f I/O\uff08SIGIO\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u5f02\u6b65 I/O\uff08AIO\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e94\u79cd\u6a21\u578b\u5bf9\u6bd4\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u540c\u6b65 I/O \u5305\u62ec\u963b\u585e\u5f0f I/O\u3001\u975e\u963b\u585e\u5f0f I/O\u3001I/O \u590d\u7528\u548c\u4fe1\u53f7\u9a71\u52a8 I/O \uff0c\u5b83\u4eec\u7684\u4e3b\u8981\u533a\u522b\u5728\u7b2c\u4e00\u4e2a\u9636\u6bb5\uff0c\u975e\u963b\u585e\u5f0f I/O \u3001\u4fe1\u53f7\u9a71\u52a8 I/O \u548c\u5f02\u6b65 I/O \u5728\u7b2c\u4e00\u9636\u6bb5\u4e0d\u4f1a\u963b\u585e"}),"\n"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u540c\u6b65 I/O\uff1a\u5c06\u6570\u636e\u4ece\u5185\u6838\u7f13\u51b2\u533a\u590d\u5236\u5230\u5e94\u7528\u8fdb\u7a0b\u7f13\u51b2\u533a\u7684\u9636\u6bb5\uff08\u7b2c\u4e8c\u9636\u6bb5\uff09\uff0c\u5e94\u7528\u8fdb\u7a0b\u4f1a\u963b\u585e"}),"\n",(0,r.jsx)(e.li,{children:"\u5f02\u6b65 I/O\uff1a\u7b2c\u4e8c\u9636\u6bb5\u5e94\u7528\u8fdb\u7a0b\u4e0d\u4f1a\u963b\u585e"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u963b\u585e\u5f0fio",children:"\u963b\u585e\u5f0fIO"}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\u8fdb\u7a0b\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528 recvfrom \u63a5\u6536\u6570\u636e\uff0c\u4f1a\u88ab\u963b\u585e\uff0c\u76f4\u5230\u6570\u636e\u4ece\u5185\u6838\u7f13\u51b2\u533a\u590d\u5236\u5230\u5e94\u7528\u8fdb\u7a0b\u7f13\u51b2\u533a\u4e2d\u624d\u8fd4\u56de\u3002\u963b\u585e\u4e0d\u610f\u5473\u7740\u6574\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u90fd\u88ab\u963b\u585e\uff0c\u5176\u5b83\u5e94\u7528\u8fdb\u7a0b\u8fd8\u53ef\u4ee5\u6267\u884c\uff0c\u53ea\u662f\u5f53\u524d\u963b\u585e\u8fdb\u7a0b\u4e0d\u6d88\u8017 CPU \u65f6\u95f4\uff0c\u8fd9\u79cd\u6a21\u578b\u7684 CPU \u5229\u7528\u7387\u4f1a\u6bd4\u8f83\u9ad8"}),"\n",(0,r.jsxs)(e.p,{children:["recvfrom() \u7528\u4e8e",(0,r.jsx)(e.strong,{children:"\u63a5\u6536 Socket \u4f20\u6765\u7684\u6570\u636e\uff0c\u5e76\u590d\u5236\u5230\u5e94\u7528\u8fdb\u7a0b\u7684\u7f13\u51b2\u533a buf \u4e2d"}),"\uff0c\u628a recvfrom() \u5f53\u6210\u7cfb\u7edf\u8c03\u7528"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(34101).A+"",width:"913",height:"383"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u975e\u963b\u585e\u5f0f",children:"\u975e\u963b\u585e\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\u8fdb\u7a0b\u901a\u8fc7 recvfrom \u8c03\u7528\u4e0d\u505c\u7684\u53bb\u548c\u5185\u6838\u4ea4\u4e92\uff0c\u76f4\u5230\u5185\u6838\u51c6\u5907\u597d\u6570\u636e\u3002\u5982\u679c\u6ca1\u6709\u51c6\u5907\u597d\u6570\u636e\uff0c\u5185\u6838\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\u7801\uff0c\u8fc7\u4e00\u6bb5\u65f6\u95f4\u5e94\u7528\u8fdb\u7a0b\u518d\u6267\u884c recvfrom \u7cfb\u7edf\u8c03\u7528\uff0c\u5728\u4e24\u6b21\u53d1\u9001\u8bf7\u6c42\u7684\u65f6\u95f4\u6bb5\uff0c\u8fdb\u7a0b\u53ef\u4ee5\u8fdb\u884c\u5176\u4ed6\u4efb\u52a1\uff0c\u8fd9\u79cd\u65b9\u5f0f\u79f0\u4e3a\u8f6e\u8be2\uff08polling\uff09"}),"\n",(0,r.jsx)(e.p,{children:"\u7531\u4e8e CPU \u8981\u5904\u7406\u66f4\u591a\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u56e0\u6b64\u8fd9\u79cd\u6a21\u578b\u7684 CPU \u5229\u7528\u7387\u6bd4\u8f83\u4f4e"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(7819).A+"",width:"888",height:"423"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4fe1\u53f7\u9a71\u52a8",children:"\u4fe1\u53f7\u9a71\u52a8"}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\u8fdb\u7a0b\u4f7f\u7528 sigaction \u7cfb\u7edf\u8c03\u7528\uff0c\u5185\u6838\u7acb\u5373\u8fd4\u56de\uff0c\u5e94\u7528\u8fdb\u7a0b\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\uff0c\u7b49\u5f85\u6570\u636e\u9636\u6bb5\u5e94\u7528\u8fdb\u7a0b\u662f\u975e\u963b\u585e\u7684\u3002\u5f53\u5185\u6838\u6570\u636e\u51c6\u5907\u5c31\u7eea\u65f6\u5411\u5e94\u7528\u8fdb\u7a0b\u53d1\u9001 SIGIO \u4fe1\u53f7\uff0c\u5e94\u7528\u8fdb\u7a0b\u6536\u5230\u4e4b\u540e\u5728\u4fe1\u53f7\u5904\u7406\u7a0b\u5e8f\u4e2d\u8c03\u7528 recvfrom \u5c06\u6570\u636e\u4ece\u5185\u6838\u590d\u5236\u5230\u5e94\u7528\u8fdb\u7a0b\u4e2d"}),"\n",(0,r.jsx)(e.p,{children:"\u76f8\u6bd4\u4e8e\u975e\u963b\u585e\u5f0f I/O \u7684\u8f6e\u8be2\u65b9\u5f0f\uff0c\u4fe1\u53f7\u9a71\u52a8 I/O \u7684 CPU \u5229\u7528\u7387\u66f4\u9ad8"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(18588).A+"",width:"955",height:"430"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"io-\u590d\u7528",children:"IO \u590d\u7528"}),"\n",(0,r.jsxs)(e.p,{children:["IO \u590d\u7528\u6a21\u578b\u4f7f\u7528 select \u6216\u8005 poll \u51fd\u6570\u7b49\u5f85\u6570\u636e\uff0cselect \u4f1a\u76d1\u542c\u6240\u6709\u6ce8\u518c\u597d\u7684 IO\uff0c",(0,r.jsx)(e.strong,{children:"\u7b49\u5f85\u591a\u4e2a\u5957\u63a5\u5b57\u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u53d8\u4e3a\u53ef\u8bfb"}),"\uff0c\u7b49\u5f85\u8fc7\u7a0b\u4f1a\u88ab\u963b\u585e\uff0c\u5f53\u67d0\u4e2a\u5957\u63a5\u5b57\u51c6\u5907\u597d\u6570\u636e\u53d8\u4e3a\u53ef\u8bfb\u65f6 select \u8c03\u7528\u5c31\u8fd4\u56de\uff0c\u7136\u540e\u8c03\u7528 recvfrom \u628a\u6570\u636e\u4ece\u5185\u6838\u590d\u5236\u5230\u8fdb\u7a0b\u4e2d"]}),"\n",(0,r.jsxs)(e.p,{children:["IO \u590d\u7528\u8ba9\u5355\u4e2a\u8fdb\u7a0b\u5177\u6709\u5904\u7406\u591a\u4e2a I/O \u4e8b\u4ef6\u7684\u80fd\u529b\uff0c\u53c8\u88ab\u79f0\u4e3a Event Driven I/O\uff0c\u5373",(0,r.jsx)(e.strong,{children:"\u4e8b\u4ef6\u9a71\u52a8 I/O"})]}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u4e00\u4e2a Web \u670d\u52a1\u5668\u6ca1\u6709 I/O \u590d\u7528\uff0c\u90a3\u4e48\u6bcf\u4e00\u4e2a Socket \u8fde\u63a5\u90fd\u8981\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u53bb\u5904\u7406\uff0c\u5982\u679c\u540c\u65f6\u6709\u51e0\u4e07\u4e2a\u8fde\u63a5\uff0c\u5c31\u9700\u8981\u521b\u5efa\u76f8\u540c\u6570\u91cf\u7684\u7ebf\u7a0b\u3002\u76f8\u6bd4\u4e8e\u591a\u8fdb\u7a0b\u548c\u591a\u7ebf\u7a0b\u6280\u672f\uff0cI/O \u590d\u7528\u4e0d\u9700\u8981\u8fdb\u7a0b\u7ebf\u7a0b\u521b\u5efa\u548c\u5207\u6362\u7684\u5f00\u9500\uff0c\u7cfb\u7edf\u5f00\u9500\u66f4\u5c0f"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(41652).A+"",width:"880",height:"404"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5f02\u6b65-io",children:"\u5f02\u6b65 IO"}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\u8fdb\u7a0b\u6267\u884c aio_read \u7cfb\u7edf\u8c03\u7528\u4f1a\u7acb\u5373\u8fd4\u56de\uff0c\u7ed9\u5185\u6838\u4f20\u9012\u63cf\u8ff0\u7b26\u3001\u7f13\u51b2\u533a\u6307\u9488\u3001\u7f13\u51b2\u533a\u5927\u5c0f\u7b49\u3002\u5e94\u7528\u8fdb\u7a0b\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u4e0d\u4f1a\u88ab\u963b\u585e\uff0c\u5185\u6838\u4f1a\u5728\u6240\u6709\u64cd\u4f5c\u5b8c\u6210\u4e4b\u540e\u5411\u5e94\u7528\u8fdb\u7a0b\u53d1\u9001\u4fe1\u53f7"}),"\n",(0,r.jsx)(e.p,{children:"\u5f02\u6b65 I/O \u4e0e\u4fe1\u53f7\u9a71\u52a8 I/O \u7684\u533a\u522b\u5728\u4e8e\uff0c\u5f02\u6b65 I/O \u7684\u4fe1\u53f7\u662f\u901a\u77e5\u5e94\u7528\u8fdb\u7a0b I/O \u5b8c\u6210\uff0c\u800c\u4fe1\u53f7\u9a71\u52a8 I/O \u7684\u4fe1\u53f7\u662f\u901a\u77e5\u5e94\u7528\u8fdb\u7a0b\u53ef\u4ee5\u5f00\u59cb I/O"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(15344).A+"",width:"907",height:"442"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u591a\u8def\u590d\u7528",children:"\u591a\u8def\u590d\u7528"}),"\n",(0,r.jsx)(e.h4,{id:"select",children:"select"}),"\n",(0,r.jsx)(e.h5,{id:"\u51fd\u6570",children:"\u51fd\u6570"}),"\n",(0,r.jsxs)(e.p,{children:["Socket \u4e0d\u662f\u6587\u4ef6\uff0c\u53ea\u662f\u4e00\u4e2a\u6807\u8bc6\u7b26\uff0c\u4f46\u662f Unix \u64cd\u4f5c\u7cfb\u7edf\u628a\u6240\u6709\u4e1c\u897f\u90fd",(0,r.jsx)(e.strong,{children:"\u770b\u4f5c"}),"\u662f\u6587\u4ef6\uff0c\u6240\u4ee5 Socket \u8bf4\u6210 file descriptor\uff0c\u4e5f\u5c31\u662f fd"]}),"\n",(0,r.jsx)(e.p,{children:"select \u5141\u8bb8\u5e94\u7528\u7a0b\u5e8f\u76d1\u89c6\u4e00\u7ec4\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u7b49\u5f85\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u63cf\u8ff0\u7b26\u6210\u4e3a\u5c31\u7eea\u72b6\u6001\uff0c\u4ece\u800c\u5b8c\u6210 I/O \u64cd\u4f5c\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"int select(int n, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["fd_set \u4f7f\u7528 ",(0,r.jsx)(e.strong,{children:"bitmap \u6570\u7ec4"}),"\u5b9e\u73b0\uff0c\u6570\u7ec4\u5927\u5c0f\u7528 FD_SETSIZE \u5b9a\u4e49\uff0c",(0,r.jsx)(e.strong,{children:"\u5355\u8fdb\u7a0b"}),"\u53ea\u80fd\u76d1\u542c\u5c11\u4e8e FD_SETSIZE \u6570\u91cf\u7684\u63cf\u8ff0\u7b26\uff0c32 \u4f4d\u673a\u9ed8\u8ba4\u662f 1024 \u4e2a\uff0c64 \u4f4d\u673a\u9ed8\u8ba4\u662f 2048\uff0c\u53ef\u4ee5\u5bf9\u8fdb\u884c\u4fee\u6539\uff0c\u7136\u540e\u91cd\u65b0\u7f16\u8bd1\u5185\u6838"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"fd_set \u6709\u4e09\u79cd\u7c7b\u578b\u7684\u63cf\u8ff0\u7b26\uff1areadset\u3001writeset\u3001exceptset\uff0c\u5bf9\u5e94\u8bfb\u3001\u5199\u3001\u5f02\u5e38\u6761\u4ef6\u7684\u63cf\u8ff0\u7b26\u96c6\u5408"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"n \u662f\u76d1\u6d4b\u7684 socket \u7684\u6700\u5927\u6570\u91cf"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["timeout \u4e3a\u8d85\u65f6\u53c2\u6570\uff0c\u8c03\u7528 select \u4f1a\u4e00\u76f4",(0,r.jsx)(e.strong,{children:"\u963b\u585e"}),"\u76f4\u5230\u6709\u63cf\u8ff0\u7b26\u7684\u4e8b\u4ef6\u5230\u8fbe\u6216\u8005\u7b49\u5f85\u7684\u65f6\u95f4\u8d85\u8fc7 timeout"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"struct timeval{\n    long tv_sec; \t//\u79d2\n    long tv_usec;\t//\u5fae\u79d2\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"timeout == null\uff1a\u7b49\u5f85\u65e0\u9650\u957f\u7684\u65f6\u95f4"}),"\n",(0,r.jsx)(e.li,{children:"tv_sec == 0 && tv_usec == 0\uff1a\u83b7\u53d6\u540e\u76f4\u63a5\u8fd4\u56de\uff0c\u4e0d\u963b\u585e\u7b49\u5f85"}),"\n",(0,r.jsx)(e.li,{children:"tv_sec != 0 || tv_usec != 0\uff1a\u7b49\u5f85\u6307\u5b9a\u65f6\u95f4"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u65b9\u6cd5\u6210\u529f\u8c03\u7528\u8fd4\u56de\u7ed3\u679c\u4e3a",(0,r.jsx)(e.strong,{children:"\u5c31\u7eea\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e2a\u6570"}),"\uff0c\u51fa\u9519\u8fd4\u56de\u7ed3\u679c\u4e3a -1\uff0c\u8d85\u65f6\u8fd4\u56de\u7ed3\u679c\u4e3a 0"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Linux \u63d0\u4f9b\u4e86\u4e00\u7ec4\u5b8f\u4e3a fd_set \u8fdb\u884c\u8d4b\u503c\u64cd\u4f5c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"int FD_ZERO(fd_set *fdset);\t\t\t// \u5c06\u4e00\u4e2a fd_set \u7c7b\u578b\u53d8\u91cf\u7684\u6240\u6709\u503c\u90fd\u7f6e\u4e3a 0\nint FD_CLR(int fd, fd_set *fdset);\t// \u5c06\u4e00\u4e2a fd_set \u7c7b\u578b\u53d8\u91cf\u7684 fd \u4f4d\u7f6e\u4e3a 0\nint FD_SET(int fd, fd_set *fdset);\t// \u5c06\u4e00\u4e2a fd_set \u7c7b\u578b\u53d8\u91cf\u7684 fd \u4f4d\u7f6e\u4e3a 1\nint FD_ISSET(int fd, fd_set *fdset);// \u5224\u65ad fd \u4f4d\u662f\u5426\u88ab\u7f6e\u4e3a 1\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u793a\u4f8b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:'sockfd = socket(AF_INET, SOCK_STREAM, 0);\nmemset(&addr, 0, sizeof(addr)));\naddr.sin_family = AF_INET;\naddr.sin_port = htons(2000);\naddr.sin_addr.s_addr = INADDR_ANY;\nbind(sockfd, (struct sockaddr*)&addr, sizeof(addr));//\u7ed1\u5b9a\u8fde\u63a5\nlisten(sockfd, 5);//\u76d1\u542c5\u4e2a\u7aef\u53e3\nfor(i = 0; i < 5; i++) {\n\tmemset(&client, e, sizeof(client));\n    addrlen = sizeof(client);\n\tfds[i] = accept(sockfd, (struct sockaddr*)&client, &addrlen);\n    //\u5c06\u76d1\u542c\u7684\u5bf9\u5e94\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u5b58\u5165fds\uff1a[3,4,5,6,7]\n    if(fds[i] > max)\n\t\tmax = fds[i];\n}\nwhile(1) {\n    FD_ZERO(&rset);//\u7f6e\u4e3a0\n    for(i = 0; i < 5; i++) {\n    \tFD_SET(fds[i], &rset);//\u5bf9\u5e94\u4f4d\u7f6e1 [0001 1111 00.....]\n\t}\n\tprint("round again");\n\tselect(max + 1, &rset, NULL, NULL, NULL);//\u76d1\u542c\n    \n\tfor(i = 0; i <5; i++) {\n        if(FD_ISSET(fds[i], &rset)) {//\u5224\u65ad\u76d1\u542c\u54ea\u4e00\u4e2a\u7aef\u53e3\n            memset(buffer, 0, MAXBUF);\n            read(fds[i], buffer, MAXBUF);//\u8fdb\u5165\u5185\u6838\u6001\u8bfb\u6570\u636e\n            print(buffer);\n        }\n    }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://www.bilibili.com/video/BV19D4y1o797",children:"https://www.bilibili.com/video/BV19D4y1o797"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6d41\u7a0b",children:"\u6d41\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:"select \u8c03\u7528\u6d41\u7a0b\u56fe\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(97440).A+"",width:"632",height:"368"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528 copy_from_user \u4ece\u7528\u6237\u7a7a\u95f4\u62f7\u8d1d fd_set \u5230\u5185\u6838\u7a7a\u95f4\uff0c\u8fdb\u7a0b\u963b\u585e"}),"\n",(0,r.jsx)(e.li,{children:"\u6ce8\u518c\u56de\u8c03\u51fd\u6570 _pollwait"}),"\n",(0,r.jsx)(e.li,{children:"\u904d\u5386\u6240\u6709 fd\uff0c\u8c03\u7528\u5176\u5bf9\u5e94\u7684 poll \u65b9\u6cd5\u5224\u65ad\u5f53\u524d\u8bf7\u6c42\u662f\u5426\u51c6\u5907\u5c31\u7eea\uff0c\u5bf9\u4e8e socket\uff0c\u8fd9\u4e2a poll \u65b9\u6cd5\u662f sock_poll\uff0csock_poll \u6839\u636e\u60c5\u51b5\u4f1a\u8c03\u7528\u5230 tcp_poll\u3001udp_poll \u6216\u8005 datagram_poll\uff0c\u4ee5 tcp_poll \u4e3a\u4f8b\uff0c\u5176\u6838\u5fc3\u5b9e\u73b0\u5c31\u662f _pollwait"}),"\n",(0,r.jsx)(e.li,{children:"_pollwait \u628a **current\uff08\u8c03\u7528 select \u7684\u8fdb\u7a0b\uff09**\u6302\u5230\u8bbe\u5907\u7684\u7b49\u5f85\u961f\u5217\uff0c\u4e0d\u540c\u8bbe\u5907\u6709\u4e0d\u540c\u7684\u7b49\u5f85\u961f\u5217\uff0c\u5bf9\u4e8e tcp_poll \uff0c\u5176\u7b49\u5f85\u961f\u5217\u662f sk \u2192 sk_sleep\uff08\u628a\u8fdb\u7a0b\u6302\u5230\u7b49\u5f85\u961f\u5217\u4e2d\u5e76\u4e0d\u4ee3\u8868\u8fdb\u7a0b\u5df2\u7ecf\u7761\u7720\uff09\uff0c\u5728\u8bbe\u5907\u6536\u5230\u6d88\u606f\uff08\u7f51\u7edc\u8bbe\u5907\uff09\u6216\u586b\u5199\u5b8c\u6587\u4ef6\u6570\u636e\uff08\u78c1\u76d8\u8bbe\u5907\uff09\u540e\uff0c\u4f1a\u5524\u9192\u8bbe\u5907\u7b49\u5f85\u961f\u5217\u4e0a\u7761\u7720\u7684\u8fdb\u7a0b\uff0c\u8fd9\u65f6 current \u4fbf\u88ab\u5524\u9192\uff0c\u8fdb\u5165\u5c31\u7eea\u961f\u5217"}),"\n",(0,r.jsx)(e.li,{children:"poll \u65b9\u6cd5\u8fd4\u56de\u65f6\u4f1a\u8fd4\u56de\u4e00\u4e2a\u63cf\u8ff0\u8bfb\u5199\u64cd\u4f5c\u662f\u5426\u5c31\u7eea\u7684 mask \u63a9\u7801\uff0c\u6839\u636e\u8fd9\u4e2a mask \u63a9\u7801\u7ed9 fd_set \u8d4b\u503c"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u904d\u5386\u5b8c\u6240\u6709\u7684 fd\uff0c\u8fd8\u6ca1\u6709\u8fd4\u56de\u4e00\u4e2a\u53ef\u8bfb\u5199\u7684 mask \u63a9\u7801\uff0c\u5219\u4f1a\u8c03\u7528 schedule_timeout \u8ba9 current \u8fdb\u7a0b\u8fdb\u5165\u7761\u7720\u3002\u5f53\u8bbe\u5907\u9a71\u52a8\u53d1\u751f\u81ea\u8eab\u8d44\u6e90\u53ef\u8bfb\u5199\u540e\uff0c\u4f1a\u5524\u9192\u5176\u7b49\u5f85\u961f\u5217\u4e0a\u7761\u7720\u7684\u8fdb\u7a0b\uff0c\u5982\u679c\u8d85\u8fc7\u4e00\u5b9a\u7684\u8d85\u65f6\u65f6\u95f4\uff08schedule_timeout\uff09\u6ca1\u6709\u5176\u4ed6\u7ebf\u7a0b\u5524\u9192\uff0c\u5219\u8c03\u7528 select \u7684\u8fdb\u7a0b\u4f1a\u91cd\u65b0\u88ab\u5524\u9192\u83b7\u5f97 CPU\uff0c\u8fdb\u800c\u91cd\u65b0\u904d\u5386 fd\uff0c\u5224\u65ad\u6709\u6ca1\u6709\u5c31\u7eea\u7684 fd"}),"\n",(0,r.jsx)(e.li,{children:"\u628a fd_set \u4ece\u5185\u6838\u7a7a\u95f4\u62f7\u8d1d\u5230\u7528\u6237\u7a7a\u95f4\uff0c\u963b\u585e\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://www.cnblogs.com/anker/p/3265058.html",children:"https://www.cnblogs.com/anker/p/3265058.html"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u5176\u4ed6\u6d41\u7a0b\u56fe\uff1a",(0,r.jsx)(e.a,{href:"https://www.processon.com/view/link/5f62b9a6e401fd2ad7e5d6d1",children:"https://www.processon.com/view/link/5f62b9a6e401fd2ad7e5d6d1"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"poll",children:"poll"}),"\n",(0,r.jsx)(e.p,{children:"poll \u7684\u529f\u80fd\u4e0e select \u7c7b\u4f3c\uff0c\u4e5f\u662f\u7b49\u5f85\u4e00\u7ec4\u63cf\u8ff0\u7b26\u4e2d\u7684\u4e00\u4e2a\u6210\u4e3a\u5c31\u7eea\u72b6\u6001"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"int poll(struct pollfd *fds, unsigned int nfds, int timeout);\n"})}),"\n",(0,r.jsx)(e.p,{children:"poll \u4e2d\u7684\u63cf\u8ff0\u7b26\u662f pollfd \u7c7b\u578b\u7684\u6570\u7ec4\uff0cpollfd \u7684\u5b9a\u4e49\u5982\u4e0b\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"struct pollfd {\n    int   fd;         /* file descriptor */\n    short events;     /* requested events */\n    short revents;    /* returned events */\n};\n"})}),"\n",(0,r.jsx)(e.p,{children:"select \u548c poll \u5bf9\u6bd4\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"select \u4f1a\u4fee\u6539\u63cf\u8ff0\u7b26\uff0c\u800c poll \u4e0d\u4f1a"}),"\n",(0,r.jsxs)(e.li,{children:["select \u7684\u63cf\u8ff0\u7b26\u7c7b\u578b\u4f7f\u7528\u6570\u7ec4\u5b9e\u73b0\uff0c\u6709\u63cf\u8ff0\u7b26\u7684\u9650\u5236\uff1b\u800c poll \u4f7f\u7528",(0,r.jsx)(e.strong,{children:"\u94fe\u8868"}),"\u5b9e\u73b0\uff0c\u6ca1\u6709\u63cf\u8ff0\u7b26\u6570\u91cf\u7684\u9650\u5236"]}),"\n",(0,r.jsx)(e.li,{children:"poll \u63d0\u4f9b\u4e86\u66f4\u591a\u7684\u4e8b\u4ef6\u7c7b\u578b\uff0c\u5e76\u4e14\u5bf9\u63cf\u8ff0\u7b26\u7684\u91cd\u590d\u5229\u7528\u4e0a\u6bd4 select \u9ad8"}),"\n"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["select \u548c poll \u901f\u5ea6\u90fd\u6bd4\u8f83\u6162\uff0c",(0,r.jsx)(e.strong,{children:"\u6bcf\u6b21\u8c03\u7528"}),"\u90fd\u9700\u8981\u5c06\u5168\u90e8\u63cf\u8ff0\u7b26\u6570\u7ec4 fd \u4ece\u5e94\u7528\u8fdb\u7a0b\u7f13\u51b2\u533a\u590d\u5236\u5230\u5185\u6838\u7f13\u51b2\u533a\uff0c\u540c\u65f6\u6bcf\u6b21\u90fd\u9700\u8981\u5728\u5185\u6838\u904d\u5386\u4f20\u9012\u8fdb\u6765\u7684\u6240\u6709 fd \uff0c\u8fd9\u4e2a\u5f00\u9500\u5728 fd \u5f88\u591a\u65f6\u4f1a\u5f88\u5927"]}),"\n",(0,r.jsx)(e.li,{children:"\u51e0\u4e4e\u6240\u6709\u7684\u7cfb\u7edf\u90fd\u652f\u6301 select\uff0c\u4f46\u662f\u53ea\u6709\u6bd4\u8f83\u65b0\u7684\u7cfb\u7edf\u652f\u6301 poll"}),"\n",(0,r.jsxs)(e.li,{children:["select \u548c poll \u7684\u65f6\u95f4\u590d\u6742\u5ea6 O(n)\uff0c\u5bf9 socket \u8fdb\u884c\u626b\u63cf\u65f6\u662f\u7ebf\u6027\u626b\u63cf\uff0c\u5373\u91c7\u7528\u8f6e\u8be2\u7684\u65b9\u6cd5\uff0c\u6548\u7387\u8f83\u4f4e\uff0c\u56e0\u4e3a\u5e76\u4e0d\u77e5\u9053\u5177\u4f53\u662f\u54ea\u4e2a socket \u5177\u6709\u4e8b\u4ef6\uff0c\u6240\u4ee5\u968f\u7740 fd \u6570\u91cf\u7684\u589e\u52a0\u4f1a\u9020\u6210\u904d\u5386\u901f\u5ea6\u6162\u7684",(0,r.jsx)(e.strong,{children:"\u7ebf\u6027\u4e0b\u964d"}),"\u6027\u80fd\u95ee\u9898"]}),"\n",(0,r.jsx)(e.li,{children:"poll \u8fd8\u6709\u4e00\u4e2a\u7279\u70b9\u662f\u6c34\u5e73\u89e6\u53d1\uff0c\u5982\u679c\u62a5\u544a\u4e86 fd \u540e\uff0c\u6ca1\u6709\u88ab\u5904\u7406\uff0c\u90a3\u4e48\u4e0b\u6b21 poll \u65f6\u4f1a\u518d\u6b21\u62a5\u544a\u8be5 fd"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u67d0\u4e2a\u63cf\u8ff0\u7b26\u8c03\u7528\u4e86 select \u6216\u8005 poll\uff0c\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5173\u95ed\u4e86\u8be5\u63cf\u8ff0\u7b26\uff0c\u4f1a\u5bfc\u81f4\u8c03\u7528\u7ed3\u679c\u4e0d\u786e\u5b9a"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md",children:"https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"epoll",children:"epoll"}),"\n",(0,r.jsx)(e.h5,{id:"\u51fd\u6570-1",children:"\u51fd\u6570"}),"\n",(0,r.jsxs)(e.p,{children:["epoll \u4f7f\u7528\u4e8b\u4ef6\u7684\u5c31\u7eea\u901a\u77e5\u65b9\u5f0f\uff0c\u901a\u8fc7 epoll_ctl() \u5411\u5185\u6838\u6ce8\u518c\u65b0\u7684\u63cf\u8ff0\u7b26\u6216\u8005\u662f\u6539\u53d8\u67d0\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u72b6\u6001\u3002\u5df2\u6ce8\u518c\u7684\u63cf\u8ff0\u7b26\u5728\u5185\u6838\u4e2d\u4f1a\u88ab\u7ef4\u62a4\u5728\u4e00\u68f5",(0,r.jsx)(e.strong,{children:"\u7ea2\u9ed1\u6811"}),"\u4e0a\uff0c\u4e00\u65e6\u8be5 fd \u5c31\u7eea\uff0c",(0,r.jsx)(e.strong,{children:"\u5185\u6838\u901a\u8fc7 callback \u56de\u8c03\u51fd\u6570\u5c06 I/O \u51c6\u5907\u597d\u7684\u63cf\u8ff0\u7b26\u52a0\u5165\u5230\u4e00\u4e2a\u94fe\u8868\u4e2d"}),"\u7ba1\u7406\uff0c\u8fdb\u7a0b\u8c03\u7528 epoll_wait() \u4fbf\u53ef\u4ee5\u5f97\u5230\u4e8b\u4ef6\u5c31\u7eea\u7684\u63cf\u8ff0\u7b26"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"int epoll_create(int size);\nint epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)\uff1b\nint epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epall_create\uff1a\u4e00\u4e2a\u7cfb\u7edf\u51fd\u6570\uff0c\u51fd\u6570\u5c06\u5728\u5185\u6838\u7a7a\u95f4\u5185\u521b\u5efa\u4e00\u4e2a epoll \u6570\u636e\u7ed3\u6784\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a epoll \u7ed3\u6784\u7a7a\u95f4\uff0c\u8fd4\u56de\u503c\u4e3a epoll \u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u7f16\u53f7\uff0c\u4ee5\u540e\u6709 client \u8fde\u63a5\u65f6\uff0c\u5411\u8be5 epoll \u7ed3\u6784\u4e2d\u6dfb\u52a0\u76d1\u542c\uff0c\u6240\u4ee5 epoll \u4f7f\u7528\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u7ba1\u7406\u591a\u4e2a\u63cf\u8ff0\u7b26"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epall_ctl\uff1aepoll \u7684\u4e8b\u4ef6\u6ce8\u518c\u51fd\u6570\uff0cselect \u51fd\u6570\u662f\u8c03\u7528\u65f6\u6307\u5b9a\u9700\u8981\u76d1\u542c\u7684\u63cf\u8ff0\u7b26\u548c\u4e8b\u4ef6\uff0cepoll \u5148\u5c06\u7528\u6237\u611f\u5174\u8da3\u7684\u63cf\u8ff0\u7b26\u4e8b\u4ef6\u6ce8\u518c\u5230 epoll \u7a7a\u95f4\u3002\u6b64\u51fd\u6570\u662f\u975e\u963b\u585e\u51fd\u6570\uff0c\u7528\u6765\u589e\u5220\u6539 epoll \u7a7a\u95f4\u5185\u7684\u63cf\u8ff0\u7b26\uff0c\u53c2\u6570\u89e3\u91ca\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epfd\uff1aepoll \u7ed3\u6784\u7684\u8fdb\u7a0b fd \u7f16\u53f7\uff0c\u51fd\u6570\u5c06\u4f9d\u9760\u8be5\u7f16\u53f7\u627e\u5230\u5bf9\u5e94\u7684 epoll \u7ed3\u6784"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"op\uff1a\u8868\u793a\u5f53\u524d\u8bf7\u6c42\u7c7b\u578b\uff0c\u6709\u4e09\u4e2a\u5b8f\u5b9a\u4e49\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"EPOLL_CTL_ADD\uff1a\u6ce8\u518c\u65b0\u7684 fd \u5230 epfd \u4e2d"}),"\n",(0,r.jsx)(e.li,{children:"EPOLL_CTL_MOD\uff1a\u4fee\u6539\u5df2\u7ecf\u6ce8\u518c\u7684 fd \u7684\u76d1\u542c\u4e8b\u4ef6"}),"\n",(0,r.jsx)(e.li,{children:"EPOLL_CTI_DEL\uff1a\u4ece epfd \u4e2d\u5220\u9664\u4e00\u4e2a fd"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"fd\uff1a\u9700\u8981\u76d1\u542c\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4e00\u822c\u6307 socket_fd"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"event\uff1a\u544a\u8bc9\u5185\u6838\u5bf9\u8be5 fd \u8d44\u6e90\u611f\u5174\u8da3\u7684\u4e8b\u4ef6\uff0cepoll_event \u7684\u7ed3\u6784\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"struct epoll_event {\n    _uint32_t events;\t/*epoll events*/\n    epoll_data_t data;\t/*user data variable*/\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"events \u53ef\u4ee5\u662f\u4ee5\u4e0b\u51e0\u4e2a\u5b8f\u96c6\u5408\uff1aEPOLLIN\u3001EPOLOUT\u3001EPOLLPRI\u3001EPOLLERR\u3001EPOLLHUP\uff08\u6302\u65ad\uff09\u3001EPOLET\uff08\u8fb9\u7f18\u89e6\u53d1\uff09\u3001EPOLLONESHOT\uff08\u53ea\u76d1\u542c\u4e00\u6b21\uff0c\u4e8b\u4ef6\u89e6\u53d1\u540e\u81ea\u52a8\u6e05\u9664\u8be5 fd\uff0c\u4ece epoll \u5217\u8868\uff09"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epoll_wait\uff1a\u7b49\u5f85\u4e8b\u4ef6\u7684\u4ea7\u751f\uff0c\u7c7b\u4f3c\u4e8e select() \u8c03\u7528\uff0c\u8fd4\u56de\u503c\u4e3a\u672c\u6b21\u5c31\u7eea\u7684 fd \u4e2a\u6570\uff0c\u76f4\u63a5\u4ece\u5c31\u7eea\u94fe\u8868\u83b7\u53d6\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 O(1)"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["epfd\uff1a",(0,r.jsx)(e.strong,{children:"\u6307\u5b9a\u611f\u5174\u8da3\u7684 epoll \u4e8b\u4ef6\u5217\u8868"})]}),"\n",(0,r.jsx)(e.li,{children:"events\uff1a\u6307\u5411\u4e00\u4e2a epoll_event \u7ed3\u6784\u6570\u7ec4\uff0c\u5f53\u51fd\u6570\u8fd4\u56de\u65f6\uff0c\u5185\u6838\u4f1a\u628a\u5c31\u7eea\u72b6\u6001\u7684\u6570\u636e\u62f7\u8d1d\u5230\u8be5\u6570\u7ec4"}),"\n",(0,r.jsx)(e.li,{children:"maxevents\uff1a\u6807\u660e epoll_event \u6570\u7ec4\u6700\u591a\u80fd\u63a5\u6536\u7684\u6570\u636e\u91cf\uff0c\u5373\u672c\u6b21\u64cd\u4f5c\u6700\u591a\u80fd\u83b7\u53d6\u591a\u5c11\u5c31\u7eea\u6570\u636e"}),"\n",(0,r.jsxs)(e.li,{children:["timeout\uff1a\u5355\u4f4d\u4e3a\u6beb\u79d2\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"0\uff1a\u8868\u793a\u7acb\u5373\u8fd4\u56de\uff0c\u975e\u963b\u585e\u8c03\u7528"}),"\n",(0,r.jsx)(e.li,{children:"-1\uff1a\u963b\u585e\u8c03\u7528\uff0c\u76f4\u5230\u6709\u7528\u6237\u611f\u5174\u8da3\u7684\u4e8b\u4ef6\u5c31\u7eea\u4e3a\u6b62"}),"\n",(0,r.jsx)(e.li,{children:"\u5927\u4e8e 0\uff1a\u963b\u585e\u8c03\u7528\uff0c\u963b\u585e\u6307\u5b9a\u65f6\u95f4\u5185\u5982\u679c\u6709\u4e8b\u4ef6\u5c31\u7eea\u5219\u63d0\u524d\u8fd4\u56de\uff0c\u5426\u5219\u7b49\u5f85\u6307\u5b9a\u65f6\u95f4\u540e\u8fd4\u56de"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"epoll \u7684\u63cf\u8ff0\u7b26\u4e8b\u4ef6\u6709\u4e24\u79cd\u89e6\u53d1\u6a21\u5f0f\uff1aLT\uff08level trigger\uff09\u548c ET\uff08edge trigger\uff09\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"LT \u6a21\u5f0f\uff1a\u5f53 epoll_wait() \u68c0\u6d4b\u5230\u63cf\u8ff0\u7b26\u4e8b\u4ef6\u5230\u8fbe\u65f6\uff0c\u5c06\u6b64\u4e8b\u4ef6\u901a\u77e5\u8fdb\u7a0b\uff0c\u8fdb\u7a0b\u53ef\u4ee5\u4e0d\u7acb\u5373\u5904\u7406\u8be5\u4e8b\u4ef6\uff0c\u4e0b\u6b21\u8c03\u7528 epoll_wait() \u4f1a\u518d\u6b21\u901a\u77e5\u8fdb\u7a0b\uff0c\u662f\u9ed8\u8ba4\u7684\u4e00\u79cd\u6a21\u5f0f\uff0c\u5e76\u4e14\u540c\u65f6\u652f\u6301 Blocking \u548c No-Blocking"}),"\n",(0,r.jsx)(e.li,{children:"ET \u6a21\u5f0f\uff1a\u901a\u77e5\u4e4b\u540e\u8fdb\u7a0b\u5fc5\u987b\u7acb\u5373\u5904\u7406\u4e8b\u4ef6\uff0c\u4e0b\u6b21\u518d\u8c03\u7528 epoll_wait() \u65f6\u4e0d\u4f1a\u518d\u5f97\u5230\u4e8b\u4ef6\u5230\u8fbe\u7684\u901a\u77e5\u3002\u51cf\u5c11\u4e86 epoll \u4e8b\u4ef6\u88ab\u91cd\u590d\u89e6\u53d1\u7684\u6b21\u6570\uff0c\u56e0\u6b64\u6548\u7387\u8981\u6bd4 LT \u6a21\u5f0f\u9ad8\uff1b\u53ea\u652f\u6301 No-Blocking\uff0c\u4ee5\u907f\u514d\u7531\u4e8e\u4e00\u4e2a fd \u7684\u963b\u585e\u8bfb/\u963b\u585e\u5199\u64cd\u4f5c\u628a\u5904\u7406\u591a\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u4efb\u52a1\u9965\u997f"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"// \u521b\u5efa epoll \u63cf\u8ff0\u7b26\uff0c\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u53ea\u9700\u8981\u4e00\u4e2a\uff0c\u7528\u4e8e\u76d1\u63a7\u6240\u6709\u5957\u63a5\u5b57\nint pollingfd = epoll_create(0xCAFE);\nif ( pollingfd < 0 )// report error\n// \u521d\u59cb\u5316 epoll \u7ed3\u6784\nstruct epoll_event ev = { 0 };\n\n// \u5c06\u8fde\u63a5\u7c7b\u5b9e\u4f8b\u4e0e\u4e8b\u4ef6\u76f8\u5173\u8054\uff0c\u53ef\u4ee5\u5173\u8054\u4efb\u4f55\u60f3\u8981\u7684\u4e1c\u897f\nev.data.ptr = pConnection1;\n\n// \u76d1\u89c6\u8f93\u5165\uff0c\u5e76\u4e14\u5728\u4e8b\u4ef6\u53d1\u751f\u540e\u4e0d\u81ea\u52a8\u91cd\u65b0\u51c6\u5907\u63cf\u8ff0\u7b26\nev.events = EPOLLIN | EPOLLONESHOT;\n// \u5c06\u63cf\u8ff0\u7b26\u6dfb\u52a0\u5230\u76d1\u63a7\u5217\u8868\u4e2d\uff0c\u5373\u4f7f\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5728epoll_wait\u4e2d\u7b49\u5f85\uff0c\u63cf\u8ff0\u7b26\u5c06\u88ab\u6b63\u786e\u6dfb\u52a0\nif ( epoll_ctl( epollfd, EPOLL_CTL_ADD, pConnection1->getSocket(), &ev) != 0 )\n    // report error\n\n// \u6700\u591a\u7b49\u5f85 20 \u4e2a\u4e8b\u4ef6\nstruct epoll_event pevents[20];\n\n// \u7b49\u5f8510\u79d2\uff0c\u68c0\u7d2220\u4e2a\u5e76\u5b58\u5165epoll_event\u6570\u7ec4\nint ready = epoll_wait(pollingfd, pevents, 20, 10000);\n// \u68c0\u67e5epoll\u662f\u5426\u6210\u529f\nif ( ret == -1)// report error and abort\nelse if ( ret == 0)// timeout; no event detected\nelse\n{\n    for (int i = 0; i < ready; i+ )\n    {\n        if ( pevents[i].events & EPOLLIN )\n        {\n            // \u83b7\u53d6\u8fde\u63a5\u6307\u9488\n            Connection * c = (Connection*) pevents[i].data.ptr;\n            c->handleReadEvent();\n         }\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u6d41\u7a0b\u56fe\uff1a",(0,r.jsx)(e.a,{href:"https://gitee.com/seazean/images/blob/master/Java/IO-epoll%E5%8E%9F%E7%90%86%E5%9B%BE.jpg",children:"https://gitee.com/seazean/images/blob/master/Java/IO-epoll%E5%8E%9F%E7%90%86%E5%9B%BE.jpg"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://www.bilibili.com/video/BV19D4y1o797",children:"https://www.bilibili.com/video/BV19D4y1o797"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u7279\u70b9",children:"\u7279\u70b9"}),"\n",(0,r.jsx)(e.p,{children:"epoll \u7684\u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epoll \u4ec5\u9002\u7528\u4e8e Linux \u7cfb\u7edf"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["epoll \u4f7f\u7528",(0,r.jsx)(e.strong,{children:"\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u7ba1\u7406\u591a\u4e2a\u63cf\u8ff0\u7b26"}),"\uff0c\u5c06\u7528\u6237\u5173\u5fc3\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u4e8b\u4ef6\u5b58\u653e\u5230\u5185\u6838\u7684\u4e00\u4e2a\u4e8b\u4ef6\u8868\uff08\u4e2a\u4eba\u7406\u89e3\u6210\u54d1\u5143\u8282\u70b9\uff09"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6ca1\u6709\u6700\u5927\u63cf\u8ff0\u7b26\u6570\u91cf\uff08\u5e76\u53d1\u8fde\u63a5\uff09\u7684\u9650\u5236\uff0c\u6253\u5f00 fd \u7684\u4e0a\u9650\u8fdc\u5927\u4e8e1024\uff081G \u5185\u5b58\u80fd\u76d1\u542c\u7ea6 10 \u4e07\u4e2a\u7aef\u53e3\uff09"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["epoll \u7684\u65f6\u95f4\u590d\u6742\u5ea6 O(1)\uff0cepoll \u7406\u89e3\u4e3a event poll\uff0c\u4e0d\u540c\u4e8e\u5fd9\u8f6e\u8be2\u548c\u65e0\u5dee\u522b\u8f6e\u8be2\uff0c\u8c03\u7528 epoll_wait ",(0,r.jsx)(e.strong,{children:"\u53ea\u662f\u8f6e\u8be2\u5c31\u7eea\u94fe\u8868"}),"\u3002\u5f53\u76d1\u542c\u5217\u8868\u6709\u8bbe\u5907\u5c31\u7eea\u65f6\u8c03\u7528\u56de\u8c03\u51fd\u6570\uff0c\u628a\u5c31\u7eea fd \u653e\u5165\u5c31\u7eea\u94fe\u8868\u4e2d\uff0c\u5e76\u5524\u9192\u5728 epoll_wait \u4e2d\u963b\u585e\u7684\u8fdb\u7a0b\uff0c\u6240\u4ee5 epoll \u5b9e\u9645\u4e0a\u662f",(0,r.jsx)(e.strong,{children:"\u4e8b\u4ef6\u9a71\u52a8"}),"\uff08\u6bcf\u4e2a\u4e8b\u4ef6\u5173\u8054\u4e0afd\uff09\u7684\uff0c\u964d\u4f4e\u4e86 system call \u7684\u65f6\u95f4\u590d\u6742\u5ea6"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epoll \u5185\u6838\u4e2d\u6839\u636e\u6bcf\u4e2a fd \u4e0a\u7684 callback \u51fd\u6570\u6765\u5b9e\u73b0\uff0c\u53ea\u6709\u6d3b\u8dc3\u7684 socket \u624d\u4f1a\u4e3b\u52a8\u8c03\u7528 callback\uff0c\u6240\u4ee5\u4f7f\u7528 epoll \u6ca1\u6709\u524d\u9762\u4e24\u8005\u7684\u7ebf\u6027\u4e0b\u964d\u7684\u6027\u80fd\u95ee\u9898\uff0c\u6548\u7387\u63d0\u9ad8"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["epoll \u6ce8\u518c\u65b0\u7684\u4e8b\u4ef6\u662f\u6ce8\u518c\u5230\u5230\u5185\u6838\u4e2d epoll \u53e5\u67c4\u4e2d\uff0c\u4e0d\u9700\u8981\u6bcf\u6b21\u8c03\u7528 epoll_wait \u65f6\u91cd\u590d\u62f7\u8d1d\uff0c\u5bf9\u6bd4\u524d\u9762\u4e24\u79cd\u53ea\u9700\u8981\u5c06\u63cf\u8ff0\u7b26\u4ece\u8fdb\u7a0b\u7f13\u51b2\u533a\u5411\u5185\u6838\u7f13\u51b2\u533a",(0,r.jsx)(e.strong,{children:"\u62f7\u8d1d\u4e00\u6b21"}),"\uff0c\u4e5f\u53ef\u4ee5\u5229\u7528 ",(0,r.jsx)(e.strong,{children:"mmap() \u6587\u4ef6\u6620\u5c04\u5185\u5b58"}),"\u52a0\u901f\u4e0e\u5185\u6838\u7a7a\u95f4\u7684\u6d88\u606f\u4f20\u9012\uff08\u53ea\u662f\u53ef\u4ee5\u7528\uff0c\u5e76\u6ca1\u6709\u7528\uff09"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u524d\u9762\u4e24\u8005\u8981\u628a current \u5f80\u8bbe\u5907\u7b49\u5f85\u961f\u5217\u4e2d\u6302\u4e00\u6b21\uff0cepoll \u4e5f\u53ea\u628a current \u5f80\u7b49\u5f85\u961f\u5217\u4e0a\u6302\u4e00\u6b21\uff0c\u4f46\u662f\u8fd9\u91cc\u7684\u7b49\u5f85\u961f\u5217\u5e76\u4e0d\u662f\u8bbe\u5907\u7b49\u5f85\u961f\u5217\uff0c\u53ea\u662f\u4e00\u4e2a epoll \u5185\u90e8\u5b9a\u4e49\u7684\u7b49\u5f85\u961f\u5217\uff0c\u8fd9\u6837\u53ef\u4ee5\u8282\u7701\u5f00\u9500"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epoll \u5bf9\u591a\u7ebf\u7a0b\u7f16\u7a0b\u66f4\u6709\u53cb\u597d\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u8c03\u7528\u4e86 epoll_wait() \u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5173\u95ed\u4e86\u540c\u4e00\u4e2a\u63cf\u8ff0\u7b26\uff0c\u4e5f\u4e0d\u4f1a\u4ea7\u751f\u50cf select \u548c poll \u7684\u4e0d\u786e\u5b9a\u60c5\u51b5"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://www.jianshu.com/p/dfd940e7fca2",children:"https://www.jianshu.com/p/dfd940e7fca2"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://www.cnblogs.com/anker/p/3265058.html",children:"https://www.cnblogs.com/anker/p/3265058.html"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5e94\u7528",children:"\u5e94\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\u573a\u666f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"select \u5e94\u7528\u573a\u666f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["select \u7684 timeout \u53c2\u6570\u7cbe\u5ea6\u4e3a\u5fae\u79d2\uff0cpoll \u548c epoll \u4e3a\u6beb\u79d2\uff0c\u56e0\u6b64 select \u9002\u7528",(0,r.jsx)(e.strong,{children:"\u5b9e\u65f6\u6027\u8981\u6c42\u6bd4\u8f83\u9ad8"}),"\u7684\u573a\u666f\uff0c\u6bd4\u5982\u6838\u53cd\u5e94\u5806\u7684\u63a7\u5236"]}),"\n",(0,r.jsx)(e.li,{children:"select \u53ef\u79fb\u690d\u6027\u66f4\u597d\uff0c\u51e0\u4e4e\u88ab\u6240\u6709\u4e3b\u6d41\u5e73\u53f0\u6240\u652f\u6301"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"poll \u5e94\u7528\u573a\u666f\uff1apoll \u6ca1\u6709\u6700\u5927\u63cf\u8ff0\u7b26\u6570\u91cf\u7684\u9650\u5236\uff0c\u9002\u7528\u4e8e\u5e73\u53f0\u652f\u6301\u5e76\u4e14\u5bf9\u5b9e\u65f6\u6027\u8981\u6c42\u4e0d\u9ad8\u7684\u60c5\u51b5"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"epoll \u5e94\u7528\u573a\u666f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u8fd0\u884c\u5728 Linux \u5e73\u53f0\u4e0a\uff0c\u6709\u5927\u91cf\u7684\u63cf\u8ff0\u7b26\u9700\u8981\u540c\u65f6\u8f6e\u8be2\uff0c\u5e76\u4e14\u8fd9\u4e9b\u8fde\u63a5\u6700\u597d\u662f",(0,r.jsx)(e.strong,{children:"\u957f\u8fde\u63a5"})]}),"\n",(0,r.jsx)(e.li,{children:"\u9700\u8981\u540c\u65f6\u76d1\u63a7\u5c0f\u4e8e 1000 \u4e2a\u63cf\u8ff0\u7b26\uff0c\u6ca1\u5fc5\u8981\u4f7f\u7528 epoll\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u5e94\u7528\u573a\u666f\u4e0b\u5e76\u4e0d\u80fd\u4f53\u73b0 epoll \u7684\u4f18\u52bf"}),"\n",(0,r.jsx)(e.li,{children:"\u9700\u8981\u76d1\u63a7\u7684\u63cf\u8ff0\u7b26\u72b6\u6001\u53d8\u5316\u591a\uff0c\u800c\u4e14\u662f\u975e\u5e38\u77ed\u6682\u7684\uff0c\u5c31\u6ca1\u6709\u5fc5\u8981\u4f7f\u7528 epoll\u3002\u56e0\u4e3a epoll \u4e2d\u7684\u6240\u6709\u63cf\u8ff0\u7b26\u90fd\u5b58\u50a8\u5728\u5185\u6838\u4e2d\uff0c\u6bcf\u6b21\u5bf9\u63cf\u8ff0\u7b26\u7684\u72b6\u6001\u6539\u53d8\u90fd\u9700\u8981\u901a\u8fc7 epoll_ctl() \u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\uff0c\u9891\u7e41\u7cfb\u7edf\u8c03\u7528\u964d\u4f4e\u6548\u7387\uff0c\u5e76\u4e14 epoll \u7684\u63cf\u8ff0\u7b26\u5b58\u50a8\u5728\u5185\u6838\uff0c\u4e0d\u5bb9\u6613\u8c03\u8bd5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md",children:"https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u7cfb\u7edf\u8c03\u7528",children:"\u7cfb\u7edf\u8c03\u7528"}),"\n",(0,r.jsx)(e.h4,{id:"\u5185\u6838\u6001",children:"\u5185\u6838\u6001"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u6237\u7a7a\u95f4\uff1a\u7528\u6237\u4ee3\u7801\u3001\u7528\u6237\u5806\u6808"}),"\n",(0,r.jsx)(e.p,{children:"\u5185\u6838\u7a7a\u95f4\uff1a\u5185\u6838\u4ee3\u7801\u3001\u5185\u6838\u8c03\u5ea6\u7a0b\u5e8f\u3001\u8fdb\u7a0b\u63cf\u8ff0\u7b26\uff08\u5185\u6838\u5806\u6808\u3001thread_info \u8fdb\u7a0b\u63cf\u8ff0\u7b26\uff09"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8fdb\u7a0b\u63cf\u8ff0\u7b26\u548c\u7528\u6237\u7684\u8fdb\u7a0b\u662f\u4e00\u4e00\u5bf9\u5e94\u7684"}),"\n",(0,r.jsx)(e.li,{children:"SYS_API \u7cfb\u7edf\u8c03\u7528\uff1a\u5982 read\u3001write\uff0c\u7cfb\u7edf\u8c03\u7528\u5c31\u662f 0X80 \u4e2d\u65ad"}),"\n",(0,r.jsxs)(e.li,{children:["\u8fdb\u7a0b\u63cf\u8ff0\u7b26 pd\uff1a\u8fdb\u7a0b\u4ece\u7528\u6237\u6001\u5207\u6362\u5230\u5185\u6838\u6001\u65f6\uff0c\u9700\u8981",(0,r.jsx)(e.strong,{children:"\u4fdd\u5b58\u7528\u6237\u6001\u65f6\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\u5728 PCB \u4e2d"})]}),"\n",(0,r.jsx)(e.li,{children:"\u7ebf\u7a0b\u4e0a\u4e0b\u6587\uff1a\u7528\u6237\u7a0b\u5e8f\u57fa\u5730\u5740\uff0c\u7a0b\u5e8f\u8ba1\u6570\u5668\u3001cpu cache\u3001\u5bc4\u5b58\u5668\u7b49\uff0c\u65b9\u4fbf\u7a0b\u5e8f\u5207\u56de\u7528\u6237\u6001\u65f6\u6062\u590d\u73b0\u573a"}),"\n",(0,r.jsx)(e.li,{children:"\u5185\u6838\u5806\u6808\uff1a**\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u4e5f\u662f\u8981\u521b\u5efa\u53d8\u91cf\u7684\uff0c**\u8fd9\u4e9b\u53d8\u91cf\u5728\u5185\u6838\u5806\u6808\u4e0a\u5206\u914d"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(30859).A+"",width:"1332",height:"661"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"80\u4e2d\u65ad",children:"80\u4e2d\u65ad"}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u7528\u6237\u7a0b\u5e8f\u4e2d\u8c03\u7528\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u6838\u5fc3\u6001\u7ea7\u522b\u7684\u5b50\u529f\u80fd\uff0c\u4e3a\u4e86\u7cfb\u7edf\u5b89\u5168\u9700\u8981\u8fdb\u884c\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u8f6c\u6362\uff0c\u72b6\u6001\u7684\u8f6c\u6362\u9700\u8981\u8fdb\u884c CPU \u4e2d\u65ad\uff0c\u4e2d\u65ad\u5206\u4e3a\u786c\u4e2d\u65ad\u548c\u8f6f\u4e2d\u65ad\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u786c\u4e2d\u65ad\uff1a\u5982\u7f51\u7edc\u4f20\u8f93\u4e2d\uff0c\u6570\u636e\u5230\u8fbe\u7f51\u5361\u540e\uff0c\u7f51\u5361\u7ecf\u8fc7\u4e00\u7cfb\u5217\u64cd\u4f5c\u540e\u53d1\u8d77\u786c\u4ef6\u4e2d\u65ad"}),"\n",(0,r.jsxs)(e.li,{children:["\u8f6f\u4e2d\u65ad\uff1a\u5982\u7a0b\u5e8f\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u672c\u8eab\u4ea7\u751f\u7684\u4e00\u4e9b\u4e2d\u65ad\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u53d1\u8d77 ",(0,r.jsx)(e.code,{children:"0X80"})," \u4e2d\u65ad"]}),"\n",(0,r.jsx)(e.li,{children:"\u7a0b\u5e8f\u6267\u884c\u78b0\u5230\u9664 0 \u5f02\u5e38"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7cfb\u7edf\u8c03\u7528 system_call \u51fd\u6570\u6240\u5bf9\u5e94\u7684\u4e2d\u65ad\u6307\u4ee4\u7f16\u53f7\u662f 0X80\uff08\u5341\u8fdb\u5236\u662f 8\xd716=128\uff09\uff0c\u800c\u8be5\u6307\u4ee4\u7f16\u53f7\u5bf9\u5e94\u7684\u5c31\u662f\u7cfb\u7edf\u8c03\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\uff0c\u6240\u4ee5\u79f0\u7cfb\u7edf\u8c03\u7528\u4e3a 80 \u4e2d\u65ad"}),"\n",(0,r.jsx)(e.p,{children:"\u7cfb\u7edf\u8c03\u7528\u7684\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5728 CPU \u5bc4\u5b58\u5668\u91cc\u5b58\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528\u53f7\uff0c\u8868\u793a\u54ea\u4e2a\u7cfb\u7edf\u51fd\u6570\uff0c\u6bd4\u5982 read"}),"\n",(0,r.jsx)(e.li,{children:"\u5c06 CPU \u7684\u4e34\u65f6\u6570\u636e\u90fd\u4fdd\u5b58\u5230 thread_info \u4e2d"}),"\n",(0,r.jsx)(e.li,{children:"\u6267\u884c 80 \u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff0c\u627e\u5230\u521a\u521a\u5b58\u7684\u7cfb\u7edf\u8c03\u7528\u53f7\uff08read\uff09\uff0c\u5148\u68c0\u67e5\u7f13\u5b58\u4e2d\u6709\u6ca1\u6709\u5bf9\u5e94\u7684\u6570\u636e\uff0c\u6ca1\u6709\u5c31\u53bb\u78c1\u76d8\u4e2d\u52a0\u8f7d\u5230\u5185\u6838\u7f13\u51b2\u533a\uff0c\u7136\u540e\u4ece\u5185\u6838\u7f13\u51b2\u533a\u62f7\u8d1d\u5230\u7528\u6237\u7a7a\u95f4"}),"\n",(0,r.jsx)(e.li,{children:"\u6700\u540e\u6062\u590d\u5230\u7528\u6237\u6001\uff0c\u901a\u8fc7 thread_info \u6062\u590d\u73b0\u573a\uff0c\u7528\u6237\u6001\u7ee7\u7eed\u6267\u884c"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(55328).A+"",width:"3074",height:"1896"})}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u89c6\u9891\uff1a",(0,r.jsx)(e.a,{href:"https://www.bilibili.com/video/BV19D4y1o797",children:"https://www.bilibili.com/video/BV19D4y1o797"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u96f6\u62f7\u8d1d",children:"\u96f6\u62f7\u8d1d"}),"\n",(0,r.jsx)(e.h4,{id:"dma",children:"DMA"}),"\n",(0,r.jsx)(e.p,{children:"DMA (Direct Memory Access) \uff1a\u76f4\u63a5\u5b58\u50a8\u5668\u8bbf\u95ee\uff0c\u8ba9\u5916\u90e8\u8bbe\u5907\u4e0d\u901a\u8fc7 CPU \u76f4\u63a5\u4e0e\u7cfb\u7edf\u5185\u5b58\u4ea4\u6362\u6570\u636e\u7684\u63a5\u53e3\u6280\u672f"}),"\n",(0,r.jsx)(e.p,{children:"\u4f5c\u7528\uff1a\u53ef\u4ee5\u89e3\u51b3\u6279\u91cf\u6570\u636e\u7684\u8f93\u5165/\u8f93\u51fa\u95ee\u9898\uff0c\u4f7f\u6570\u636e\u7684\u4f20\u9001\u901f\u5ea6\u53d6\u51b3\u4e8e\u5b58\u50a8\u5668\u548c\u5916\u8bbe\u7684\u5de5\u4f5c\u901f\u5ea6"}),"\n",(0,r.jsx)(e.p,{children:"\u628a\u5185\u5b58\u6570\u636e\u4f20\u8f93\u5230\u7f51\u5361\u7136\u540e\u53d1\u9001\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6ca1\u6709 DMA\uff1aCPU \u8bfb\u5185\u5b58\u6570\u636e\u5230 CPU \u9ad8\u901f\u7f13\u5b58\uff0c\u518d\u5199\u5230\u7f51\u5361\uff0c\u8fd9\u6837\u5c31\u628a CPU \u7684\u901f\u5ea6\u62c9\u4f4e\u5230\u548c\u7f51\u5361\u4e00\u4e2a\u901f\u5ea6"}),"\n",(0,r.jsxs)(e.li,{children:["\u4f7f\u7528 DMA\uff1a\u628a\u6570\u636e\u8bfb\u5230 Socket \u5185\u6838\u7f13\u5b58\u533a\uff08CPU \u590d\u5236\uff09\uff0cCPU \u5206\u914d\u7ed9 DMA \u5f00\u59cb",(0,r.jsx)(e.strong,{children:"\u5f02\u6b65"}),"\u64cd\u4f5c\uff0cDMA \u8bfb\u53d6 Socket \u7f13\u51b2\u533a\u5230 DMA \u7f13\u51b2\u533a\uff0c\u7136\u540e\u5199\u5230\u7f51\u5361\u3002DMA \u6267\u884c\u5b8c\u540e",(0,r.jsx)(e.strong,{children:"\u4e2d\u65ad"}),"\uff08\u5c31\u662f\u901a\u77e5\uff09 CPU\uff0c\u8fd9\u65f6 Socket \u5185\u6838\u7f13\u51b2\u533a\u4e3a\u7a7a\uff0cCPU \u4ece\u7528\u6237\u6001\u5207\u6362\u5230\u5185\u6838\u6001\uff0c\u6267\u884c\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff0c\u5c06\u9700\u8981\u4f7f\u7528 Socket \u7f13\u51b2\u533a\u7684\u963b\u585e\u8fdb\u7a0b\u79fb\u5230\u5c31\u7eea\u961f\u5217"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e2a\u5b8c\u6574\u7684 DMA \u4f20\u8f93\u8fc7\u7a0b\u5fc5\u987b\u7ecf\u5386 DMA \u8bf7\u6c42\u3001DMA \u54cd\u5e94\u3001DMA \u4f20\u8f93\u3001DMA \u7ed3\u675f\u56db\u4e2a\u6b65\u9aa4\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(65813).A+"",width:"1455",height:"591"})}),"\n",(0,r.jsx)(e.p,{children:"DMA \u65b9\u5f0f\u662f\u4e00\u79cd\u5b8c\u5168\u7531\u786c\u4ef6\u8fdb\u884c\u4fe1\u606f\u4f20\u9001\u7684\u63a7\u5236\u65b9\u5f0f\uff0c\u901a\u5e38\u7cfb\u7edf\u603b\u7ebf\u7531 CPU \u7ba1\u7406\uff0c\u5728 DMA \u65b9\u5f0f\u4e2d\uff0cCPU \u7684\u4e3b\u5b58\u63a7\u5236\u4fe1\u53f7\u88ab\u7981\u6b62\u4f7f\u7528\uff0cCPU \u628a\u603b\u7ebf\uff08\u5730\u5740\u603b\u7ebf\u3001\u6570\u636e\u603b\u7ebf\u3001\u63a7\u5236\u603b\u7ebf\uff09\u8ba9\u51fa\u6765\u7531 DMA \u63a7\u5236\u5668\u63a5\u7ba1\uff0c\u7528\u6765\u63a7\u5236\u4f20\u9001\u7684\u5b57\u8282\u6570\u3001\u5224\u65ad DMA \u662f\u5426\u7ed3\u675f\u3001\u4ee5\u53ca\u53d1\u51fa DMA \u7ed3\u675f\u4fe1\u53f7\uff0c\u6240\u4ee5 DMA \u63a7\u5236\u5668\u5fc5\u987b\u6709\u4ee5\u4e0b\u529f\u80fd\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u63a5\u53d7\u5916\u8bbe\u53d1\u51fa\u7684 DMA \u8bf7\u6c42\uff0c\u5e76\u5411 CPU \u53d1\u51fa\u603b\u7ebf\u63a5\u7ba1\u8bf7\u6c42"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53 CPU \u53d1\u51fa\u5141\u8bb8\u63a5\u7ba1\u4fe1\u53f7\u540e\uff0c\u8fdb\u5165 DMA \u64cd\u4f5c\u5468\u671f"}),"\n",(0,r.jsx)(e.li,{children:"\u786e\u5b9a\u4f20\u9001\u6570\u636e\u7684\u4e3b\u5b58\u5355\u5143\u5730\u5740\u53ca\u957f\u5ea6\uff0c\u5e76\u81ea\u52a8\u4fee\u6539\u4e3b\u5b58\u5730\u5740\u8ba1\u6570\u548c\u4f20\u9001\u957f\u5ea6\u8ba1\u6570"}),"\n",(0,r.jsx)(e.li,{children:"\u89c4\u5b9a\u6570\u636e\u5728\u4e3b\u5b58\u548c\u5916\u8bbe\u95f4\u7684\u4f20\u9001\u65b9\u5411\uff0c\u53d1\u51fa\u8bfb\u5199\u7b49\u63a7\u5236\u4fe1\u53f7\uff0c\u6267\u884c\u6570\u636e\u4f20\u9001\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.li,{children:"\u5224\u65ad DMA \u4f20\u9001\u662f\u5426\u7ed3\u675f\uff0c\u53d1\u51fa DMA \u7ed3\u675f\u4fe1\u53f7\uff0c\u4f7f CPU \u6062\u590d\u6b63\u5e38\u5de5\u4f5c\u72b6\u6001\uff08\u4e2d\u65ad\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"bio",children:"BIO"}),"\n",(0,r.jsx)(e.p,{children:"\u4f20\u7edf\u7684 I/O \u64cd\u4f5c\u8fdb\u884c\u4e86 4 \u6b21\u7528\u6237\u7a7a\u95f4\u4e0e\u5185\u6838\u7a7a\u95f4\u7684\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u4ee5\u53ca 4 \u6b21\u6570\u636e\u62f7\u8d1d\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["JVM \u53d1\u51fa read \u7cfb\u7edf\u8c03\u7528\uff0cOS \u4e0a\u4e0b\u6587\u5207\u6362\u5230\u5185\u6838\u6a21\u5f0f\uff08\u5207\u6362 1\uff09\u5e76\u5c06\u6570\u636e\u4ece\u7f51\u5361\u6216\u786c\u76d8\u7b49\u8bbe\u5907\u901a\u8fc7 DMA \u8bfb\u53d6\u5230\u5185\u6838\u7a7a\u95f4\u7f13\u51b2\u533a\uff08\u62f7\u8d1d 1\uff09\uff0c\u5185\u6838\u7f13\u51b2\u533a\u5b9e\u9645\u4e0a\u662f",(0,r.jsx)(e.strong,{children:"\u78c1\u76d8\u9ad8\u901f\u7f13\u5b58\uff08PageCache\uff09"})]}),"\n",(0,r.jsx)(e.li,{children:"OS \u5185\u6838\u5c06\u6570\u636e\u590d\u5236\u5230\u7528\u6237\u7a7a\u95f4\u7f13\u51b2\u533a\uff08\u62f7\u8d1d 2\uff09\uff0c\u7136\u540e read \u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\uff0c\u53c8\u4f1a\u5bfc\u81f4\u4e00\u6b21\u5185\u6838\u7a7a\u95f4\u5230\u7528\u6237\u7a7a\u95f4\u7684\u4e0a\u4e0b\u6587\u5207\u6362\uff08\u5207\u6362 2\uff09"}),"\n",(0,r.jsx)(e.li,{children:"JVM \u5904\u7406\u4ee3\u7801\u903b\u8f91\u5e76\u53d1\u9001 write() \u7cfb\u7edf\u8c03\u7528\uff0cOS \u4e0a\u4e0b\u6587\u5207\u6362\u5230\u5185\u6838\u6a21\u5f0f\uff08\u5207\u63623\uff09\u5e76\u4ece\u7528\u6237\u7a7a\u95f4\u7f13\u51b2\u533a\u590d\u5236\u6570\u636e\u5230\u5185\u6838\u7a7a\u95f4\u7f13\u51b2\u533a\uff08\u62f7\u8d1d3\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u5c06\u5185\u6838\u7a7a\u95f4\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\u5199\u5230 hardware\uff08\u62f7\u8d1d4\uff09\uff0cwrite \u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\uff0c\u5bfc\u81f4\u5185\u6838\u7a7a\u95f4\u5230\u7528\u6237\u7a7a\u95f4\u7684\u518d\u6b21\u4e0a\u4e0b\u6587\u5207\u6362\uff08\u5207\u63624\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6d41\u7a0b\u56fe\u4e2d\u7684\u7bad\u5934\u53cd\u8fc7\u6765\u4e5f\u6210\u7acb\uff0c\u53ef\u4ee5\u4ece\u7f51\u5361\u83b7\u53d6\u6570\u636e"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(99486).A+"",width:"990",height:"594"})}),"\n",(0,r.jsx)(e.p,{children:"read \u8c03\u7528\u56fe\u793a\uff1aread\u3001write \u90fd\u662f\u7cfb\u7edf\u8c03\u7528\u6307\u4ee4"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(17608).A+"",width:"904",height:"731"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"mmap",children:"mmap"}),"\n",(0,r.jsxs)(e.p,{children:["mmap\uff08Memory Mapped Files\uff09\u5185\u5b58\u6620\u5c04\u52a0 write \u5b9e\u73b0\u96f6\u62f7\u8d1d\uff0c",(0,r.jsx)(e.strong,{children:"\u96f6\u62f7\u8d1d\u5c31\u662f\u6ca1\u6709\u6570\u636e\u4ece\u5185\u6838\u7a7a\u95f4\u590d\u5236\u5230\u7528\u6237\u7a7a\u95f4"})]}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u6237\u7a7a\u95f4\u548c\u5185\u6838\u7a7a\u95f4\u90fd\u4f7f\u7528\u5185\u5b58\uff0c\u6240\u4ee5\u53ef\u4ee5\u5171\u4eab\u540c\u4e00\u5757\u7269\u7406\u5185\u5b58\u5730\u5740\uff0c\u7701\u53bb\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u4e4b\u95f4\u7684\u62f7\u8d1d\u3002\u5199\u7f51\u5361\u65f6\uff0c\u5171\u4eab\u7a7a\u95f4\u7684\u5185\u5bb9\u62f7\u8d1d\u5230 Socket \u7f13\u51b2\u533a\uff0c\u7136\u540e\u4ea4\u7ed9 DMA \u53d1\u9001\u5230\u7f51\u5361\uff0c\u53ea\u9700\u8981 3 \u6b21\u590d\u5236"}),"\n",(0,r.jsx)(e.p,{children:"\u8fdb\u884c\u4e86 4 \u6b21\u7528\u6237\u7a7a\u95f4\u4e0e\u5185\u6838\u7a7a\u95f4\u7684\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u4ee5\u53ca 3 \u6b21\u6570\u636e\u62f7\u8d1d\uff082 \u6b21 DMA\uff0c\u4e00\u6b21 CPU \u590d\u5236\uff09\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53d1\u51fa mmap \u7cfb\u7edf\u8c03\u7528\uff0cDMA \u62f7\u8d1d\u5230\u5185\u6838\u7f13\u51b2\u533a\uff0c\u6620\u5c04\u5230\u5171\u4eab\u7f13\u51b2\u533a\uff1bmmap \u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\uff0c\u65e0\u9700\u62f7\u8d1d"}),"\n",(0,r.jsx)(e.li,{children:"\u53d1\u51fa write \u7cfb\u7edf\u8c03\u7528\uff0c\u5c06\u6570\u636e\u4ece\u5185\u6838\u7f13\u51b2\u533a\u62f7\u8d1d\u5230\u5185\u6838 Socket \u7f13\u51b2\u533a\uff1bwrite \u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\uff0cDMA \u5c06\u5185\u6838\u7a7a\u95f4 Socket \u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\u4f20\u9012\u5230\u534f\u8bae\u5f15\u64ce"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(48321).A+"",width:"1135",height:"613"})}),"\n",(0,r.jsxs)(e.p,{children:["\u539f\u7406\uff1a\u5229\u7528\u64cd\u4f5c\u7cfb\u7edf\u7684 Page \u6765\u5b9e\u73b0\u6587\u4ef6\u5230\u7269\u7406\u5185\u5b58\u7684\u76f4\u63a5\u6620\u5c04\uff0c\u5b8c\u6210\u6620\u5c04\u540e\u5bf9\u7269\u7406\u5185\u5b58\u7684\u64cd\u4f5c\u4f1a",(0,r.jsx)(e.strong,{children:"\u88ab\u540c\u6b65"}),"\u5230\u786c\u76d8\u4e0a"]}),"\n",(0,r.jsx)(e.p,{children:"\u7f3a\u70b9\uff1a\u4e0d\u53ef\u9760\uff0c\u5199\u5230 mmap \u4e2d\u7684\u6570\u636e\u5e76\u6ca1\u6709\u88ab\u771f\u6b63\u7684\u5199\u5230\u786c\u76d8\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5728\u7a0b\u5e8f\u4e3b\u52a8\u8c03\u7528 flush \u7684\u65f6\u5019\u624d\u628a\u6570\u636e\u771f\u6b63\u7684\u5199\u5230\u786c\u76d8"}),"\n",(0,r.jsxs)(e.p,{children:["Java NIO \u63d0\u4f9b\u4e86 ",(0,r.jsx)(e.strong,{children:"MappedByteBuffer"})," \u7c7b\u53ef\u4ee5\u7528\u6765\u5b9e\u73b0 mmap \u5185\u5b58\u6620\u5c04\uff0cMappedByteBuffer \u7c7b\u5bf9\u8c61",(0,r.jsxs)(e.strong,{children:["\u53ea\u80fd\u901a\u8fc7\u8c03\u7528 ",(0,r.jsx)(e.code,{children:"FileChannel.map()"})," \u83b7\u53d6"]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"sendfile",children:"sendfile"}),"\n",(0,r.jsx)(e.p,{children:"sendfile \u5b9e\u73b0\u96f6\u62f7\u8d1d\uff0c\u6253\u5f00\u6587\u4ef6\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26 fd \u548c socket \u7684 fd \u4f20\u9012\u7ed9 sendfile\uff0c\u7136\u540e\u7ecf\u8fc7 3 \u6b21\u590d\u5236\u548c 2 \u6b21\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u7684\u5207\u6362"}),"\n",(0,r.jsx)(e.p,{children:"\u539f\u7406\uff1a\u6570\u636e\u6839\u672c\u4e0d\u7ecf\u8fc7\u7528\u6237\u6001\uff0c\u76f4\u63a5\u4ece\u5185\u6838\u7f13\u51b2\u533a\u8fdb\u5165\u5230 Socket Buffer\uff0c\u7531\u4e8e\u548c\u7528\u6237\u6001\u5b8c\u5168\u65e0\u5173\uff0c\u5c31\u51cf\u5c11\u4e86\u4e24\u6b21\u4e0a\u4e0b\u6587\u5207\u6362"}),"\n",(0,r.jsx)(e.p,{children:"\u8bf4\u660e\uff1a\u96f6\u62f7\u8d1d\u6280\u672f\u662f\u4e0d\u5141\u8bb8\u8fdb\u7a0b\u5bf9\u6587\u4ef6\u5185\u5bb9\u4f5c\u8fdb\u4e00\u6b65\u7684\u52a0\u5de5\u7684\uff0c\u6bd4\u5982\u538b\u7f29\u6570\u636e\u518d\u53d1\u9001"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(6020).A+"",width:"830",height:"516"})}),"\n",(0,r.jsxs)(e.p,{children:["sendfile2.4 \u4e4b\u540e\uff0csendfile \u5b9e\u73b0\u4e86\u66f4\u7b80\u5355\u7684\u65b9\u5f0f\uff0c\u6587\u4ef6\u5230\u8fbe\u5185\u6838\u7f13\u51b2\u533a\u540e\uff0c\u4e0d\u5fc5\u518d\u5c06\u6570\u636e\u5168\u90e8\u590d\u5236\u5230 socket buffer \u7f13\u51b2\u533a\uff0c\u800c\u662f\u53ea",(0,r.jsx)(e.strong,{children:"\u5c06\u8bb0\u5f55\u6570\u636e\u4f4d\u7f6e\u548c\u957f\u5ea6\u76f8\u5173\u7b49\u63cf\u8ff0\u7b26\u4fe1\u606f"}),"\u4fdd\u5b58\u5230 socket buffer\uff0cDMA \u6839\u636e Socket \u7f13\u51b2\u533a\u4e2d\u63cf\u8ff0\u7b26\u63d0\u4f9b\u7684\u4f4d\u7f6e\u548c\u504f\u79fb\u91cf\u4fe1\u606f\u76f4\u63a5\u5c06\u5185\u6838\u7a7a\u95f4\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\u62f7\u8d1d\u5230\u534f\u8bae\u5f15\u64ce\u4e0a\uff082 \u6b21\u590d\u5236 2 \u6b21\u5207\u6362\uff09"]}),"\n",(0,r.jsxs)(e.p,{children:["Java NIO \u5bf9 sendfile \u7684\u652f\u6301\u662f ",(0,r.jsx)(e.code,{children:"FileChannel.transferTo()/transferFrom()"}),"\uff0c\u628a\u78c1\u76d8\u6587\u4ef6\u8bfb\u53d6 OS \u5185\u6838\u7f13\u51b2\u533a\u540e\u7684 fileChannel\uff0c\u76f4\u63a5\u8f6c\u7ed9 socketChannel \u53d1\u9001\uff0c\u5e95\u5c42\u5c31\u662f sendfile"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://blog.csdn.net/hancoder/article/details/112149121",children:"https://blog.csdn.net/hancoder/article/details/112149121"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"bio-1",children:"BIO"}),"\n",(0,r.jsx)(e.h3,{id:"inet",children:"Inet"}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e2a InetAddress \u7c7b\u7684\u5bf9\u8c61\u5c31\u4ee3\u8868\u4e00\u4e2a IP \u5730\u5740\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.p,{children:"\u6210\u5458\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"static InetAddress getLocalHost()"}),"\uff1a\u83b7\u5f97\u672c\u5730\u4e3b\u673a IP \u5730\u5740\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"static InetAddress getByName(String host)"}),"\uff1a\u6839\u636e IP \u5730\u5740\u5b57\u7b26\u4e32\u6216\u4e3b\u673a\u540d\u83b7\u5f97\u5bf9\u5e94\u7684 IP \u5730\u5740\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"String getHostName()"}),"\uff1a\u83b7\u53d6\u4e3b\u673a\u540d"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"String getHostAddress()"}),"\uff1a\u83b7\u5f97 IP \u5730\u5740\u5b57\u7b26\u4e32"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class InetAddressDemo {\n    public static void main(String[] args) throws Exception {\n        // 1.\u83b7\u53d6\u672c\u673a\u5730\u5740\u5bf9\u8c61\n        InetAddress ip = InetAddress.getLocalHost();\n        System.out.println(ip.getHostName());//DESKTOP-NNMBHQR\n        System.out.println(ip.getHostAddress());//192.168.11.1\n        // 2.\u83b7\u53d6\u57df\u540dip\u5bf9\u8c61\n        InetAddress ip2 = InetAddress.getByName("www.baidu.com");\n        System.out.println(ip2.getHostName());//www.baidu.com\n        System.out.println(ip2.getHostAddress());//14.215.177.38\n        // 3.\u83b7\u53d6\u516c\u7f51IP\u5bf9\u8c61\u3002\n        InetAddress ip3 = InetAddress.getByName("182.61.200.6");\n        System.out.println(ip3.getHostName());//182.61.200.6\n        System.out.println(ip3.getHostAddress());//182.61.200.6\n        \n        // 4.\u5224\u65ad\u662f\u5426\u80fd\u901a\uff1a ping  5s\u4e4b\u524d\u6d4b\u8bd5\u662f\u5426\u53ef\u901a\n        System.out.println(ip2.isReachable(5000)); // ping\u767e\u5ea6\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"udp",children:"UDP"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-2",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsx)(e.p,{children:"UDP\uff08User Datagram Protocol\uff09\u534f\u8bae\u7684\u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9762\u5411\u65e0\u8fde\u63a5\u7684\u534f\u8bae\uff0c\u53d1\u9001\u7aef\u53ea\u7ba1\u53d1\u9001\uff0c\u4e0d\u786e\u8ba4\u5bf9\u65b9\u662f\u5426\u80fd\u6536\u5230\uff0c\u901f\u5ea6\u5feb\uff0c\u4f46\u662f\u4e0d\u53ef\u9760\uff0c\u4f1a\u4e22\u5931\u6570\u636e"}),"\n",(0,r.jsx)(e.li,{children:"\u5c3d\u6700\u5927\u52aa\u529b\u4ea4\u4ed8\uff0c\u6ca1\u6709\u62e5\u585e\u63a7\u5236"}),"\n",(0,r.jsxs)(e.li,{children:["\u57fa\u4e8e\u6570\u636e\u5305\u8fdb\u884c\u6570\u636e\u4f20\u8f93\uff0c\u53d1\u9001\u6570\u636e\u7684\u5305\u7684\u5927\u5c0f\u9650\u5236 ",(0,r.jsx)(e.strong,{children:"64KB"})," \u4ee5\u5185"]}),"\n",(0,r.jsx)(e.li,{children:"\u652f\u6301\u4e00\u5bf9\u4e00\u3001\u4e00\u5bf9\u591a\u3001\u591a\u5bf9\u4e00\u3001\u591a\u5bf9\u591a\u7684\u4ea4\u4e92\u901a\u4fe1"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"UDP \u534f\u8bae\u7684\u4f7f\u7528\u573a\u666f\uff1a\u5728\u7ebf\u89c6\u9891\u3001\u7f51\u7edc\u8bed\u97f3\u3001\u7535\u8bdd"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b9e\u73b0udp",children:"\u5b9e\u73b0UDP"}),"\n",(0,r.jsx)(e.p,{children:"UDP \u534f\u8bae\u76f8\u5173\u7684\u4e24\u4e2a\u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"DatagramPacket\uff08\u6570\u636e\u5305\u5bf9\u8c61\uff09\uff1a\u7528\u6765\u5c01\u88c5\u8981\u53d1\u9001\u6216\u8981\u63a5\u6536\u7684\u6570\u636e\uff0c\u6bd4\u5982\uff1a\u96c6\u88c5\u7bb1"}),"\n",(0,r.jsx)(e.li,{children:"DatagramSocket\uff08\u53d1\u9001\u5bf9\u8c61\uff09\uff1a\u7528\u6765\u53d1\u9001\u6216\u63a5\u6536\u6570\u636e\u5305\uff0c\u6bd4\u5982\uff1a\u7801\u5934"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"DatagramPacket"}),"\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"DatagramPacket \u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public new DatagramPacket(byte[] buf, int length, InetAddress address, int port)"}),"\uff1a\u521b\u5efa\u53d1\u9001\u7aef\u6570\u636e\u5305\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"buf\uff1a\u8981\u53d1\u9001\u7684\u5185\u5bb9\uff0c\u5b57\u8282\u6570\u7ec4"}),"\n",(0,r.jsx)(e.li,{children:"length\uff1a\u8981\u53d1\u9001\u5185\u5bb9\u7684\u957f\u5ea6\uff0c\u5355\u4f4d\u662f\u5b57\u8282"}),"\n",(0,r.jsx)(e.li,{children:"address\uff1a\u63a5\u6536\u7aef\u7684IP\u5730\u5740\u5bf9\u8c61"}),"\n",(0,r.jsx)(e.li,{children:"port\uff1a\u63a5\u6536\u7aef\u7684\u7aef\u53e3\u53f7"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public new DatagramPacket(byte[] buf, int length)"}),"\uff1a\u521b\u5efa\u63a5\u6536\u7aef\u7684\u6570\u636e\u5305\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"buf\uff1a\u7528\u6765\u5b58\u50a8\u63a5\u6536\u5230\u5185\u5bb9"}),"\n",(0,r.jsx)(e.li,{children:"length\uff1a\u80fd\u591f\u63a5\u6536\u5185\u5bb9\u7684\u957f\u5ea6"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"DatagramPacket \u7c7b\u5e38\u7528\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public int getLength()"}),"\uff1a\u83b7\u5f97\u5b9e\u9645\u63a5\u6536\u5230\u7684\u5b57\u8282\u4e2a\u6570"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public byte[] getData()"}),"\uff1a\u8fd4\u56de\u6570\u636e\u7f13\u51b2\u533a"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"DatagramSocket"}),"\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["DatagramSocket \u7c7b\u6784\u9020\u65b9\u6cd5\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"protected DatagramSocket()"}),"\uff1a\u521b\u5efa\u53d1\u9001\u7aef\u7684 Socket \u5bf9\u8c61\uff0c\u7cfb\u7edf\u4f1a\u968f\u673a\u5206\u914d\u4e00\u4e2a\u7aef\u53e3\u53f7"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"protected DatagramSocket(int port)"}),"\uff1a\u521b\u5efa\u63a5\u6536\u7aef\u7684 Socket \u5bf9\u8c61\u5e76\u6307\u5b9a\u7aef\u53e3\u53f7"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["DatagramSocket \u7c7b\u6210\u5458\u65b9\u6cd5\uff1a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void send(DatagramPacket dp)"}),"\uff1a\u53d1\u9001\u6570\u636e\u5305"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void receive(DatagramPacket p)"}),"\uff1a\u63a5\u6536\u6570\u636e\u5305"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"public void close()"}),"\uff1a\u5173\u95ed\u6570\u636e\u62a5\u5957\u63a5\u5b57"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class UDPClientDemo {\n    public static void main(String[] args) throws Exception {\n        System.out.println("===\u542f\u52a8\u5ba2\u6237\u7aef===");\n        // 1.\u521b\u5efa\u4e00\u4e2a\u96c6\u88c5\u7bb1\u5bf9\u8c61\uff0c\u7528\u4e8e\u5c01\u88c5\u9700\u8981\u53d1\u9001\u7684\u6570\u636e\u5305!\n        byte[] buffer = "\u6211\u5b66Java".getBytes();\n        DatagramPacket packet = new DatagramPacket(buffer,bubffer.length,InetAddress.getLoclHost,8000);\n        // 2.\u521b\u5efa\u4e00\u4e2a\u7801\u5934\u5bf9\u8c61\n        DatagramSocket socket = new DatagramSocket();\n        // 3.\u5f00\u59cb\u53d1\u9001\u6570\u636e\u5305\u5bf9\u8c61\n        socket.send(packet);\n        socket.close();\n    }\n}\npublic class UDPServerDemo{\n    public static void main(String[] args) throws Exception {\n        System.out.println("==\u542f\u52a8\u670d\u52a1\u7aef\u7a0b\u5e8f==");\n        // 1.\u521b\u5efa\u4e00\u4e2a\u63a5\u6536\u5ba2\u6237\u90fd\u7aef\u7684\u6570\u636e\u5305\u5bf9\u8c61\uff08\u96c6\u88c5\u7bb1\uff09\n        byte[] buffer = new byte[1024*64];\n        DatagramPacket packet = new DatagramPacket(buffer, bubffer.length);\n        // 2.\u521b\u5efa\u4e00\u4e2a\u63a5\u6536\u7aef\u7684\u7801\u5934\u5bf9\u8c61\n        DatagramSocket socket = new DatagramSocket(8000);\n        // 3.\u5f00\u59cb\u63a5\u6536\n        socket.receive(packet);\n        // 4.\u4ece\u96c6\u88c5\u7bb1\u4e2d\u83b7\u53d6\u672c\u6b21\u8bfb\u53d6\u7684\u6570\u636e\u91cf\n        int len = packet.getLength();\n        // 5.\u8f93\u51fa\u6570\u636e\n        // String rs = new String(socket.getData(), 0, len)\n        String rs = new String(buffer , 0 , len);\n        System.out.println(rs);\n        // 6.\u670d\u52a1\u7aef\u8fd8\u53ef\u4ee5\u83b7\u53d6\u53d1\u6765\u4fe1\u606f\u7684\u5ba2\u6237\u7aef\u7684IP\u548c\u7aef\u53e3\u3002\n        String ip = packet.getAddress().getHostAdress();\n        int port = packet.getPort();\n        socket.close();\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u901a\u8baf\u65b9\u5f0f",children:"\u901a\u8baf\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"UDP \u901a\u4fe1\u65b9\u5f0f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5355\u64ad\uff1a\u7528\u4e8e\u4e24\u4e2a\u4e3b\u673a\u4e4b\u95f4\u7684\u7aef\u5bf9\u7aef\u901a\u4fe1"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ec4\u64ad\uff1a\u7528\u4e8e\u5bf9\u4e00\u7ec4\u7279\u5b9a\u7684\u4e3b\u673a\u8fdb\u884c\u901a\u4fe1"}),"\n",(0,r.jsx)(e.p,{children:"IP : 224.0.1.0"}),"\n",(0,r.jsx)(e.p,{children:"Socket \u5bf9\u8c61 : MulticastSocket"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5e7f\u64ad\uff1a\u7528\u4e8e\u4e00\u4e2a\u4e3b\u673a\u5bf9\u6574\u4e2a\u5c40\u57df\u7f51\u4e0a\u6240\u6709\u4e3b\u673a\u4e0a\u7684\u6570\u636e\u901a\u4fe1"}),"\n",(0,r.jsx)(e.p,{children:"IP : 255.255.255.255"}),"\n",(0,r.jsx)(e.p,{children:"Socket \u5bf9\u8c61 : DatagramSocket"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"tcp",children:"TCP"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-3",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsx)(e.p,{children:"TCP/IP (Transfer Control Protocol) \u534f\u8bae\uff0c\u4f20\u8f93\u63a7\u5236\u534f\u8bae"}),"\n",(0,r.jsx)(e.p,{children:"TCP/IP \u534f\u8bae\u7684\u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9762\u5411\u8fde\u63a5\u7684\u534f\u8bae\uff0c\u63d0\u4f9b\u53ef\u9760\u4ea4\u4e92\uff0c\u901f\u5ea6\u6162"}),"\n",(0,r.jsx)(e.li,{children:"\u70b9\u5bf9\u70b9\u7684\u5168\u53cc\u5de5\u901a\u4fe1"}),"\n",(0,r.jsxs)(e.li,{children:["\u901a\u8fc7",(0,r.jsx)(e.strong,{children:"\u4e09\u6b21\u63e1\u624b"}),"\u5efa\u7acb\u8fde\u63a5\uff0c\u8fde\u63a5\u6210\u529f\u5f62\u6210\u6570\u636e\u4f20\u8f93\u901a\u9053\uff1b\u901a\u8fc7",(0,r.jsx)(e.strong,{children:"\u56db\u6b21\u6325\u624b"}),"\u65ad\u5f00\u8fde\u63a5"]}),"\n",(0,r.jsx)(e.li,{children:"\u57fa\u4e8e\u5b57\u8282\u6d41\u8fdb\u884c\u6570\u636e\u4f20\u8f93\uff0c\u4f20\u8f93\u6570\u636e\u5927\u5c0f\u6ca1\u6709\u9650\u5236"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"TCP \u534f\u8bae\u7684\u4f7f\u7528\u573a\u666f\uff1a\u6587\u4ef6\u4e0a\u4f20\u548c\u4e0b\u8f7d\u3001\u90ae\u4ef6\u53d1\u9001\u548c\u63a5\u6536\u3001\u8fdc\u7a0b\u767b\u5f55"}),"\n",(0,r.jsxs)(e.p,{children:["\u6ce8\u610f\uff1a",(0,r.jsx)(e.strong,{children:"TCP \u4e0d\u4f1a\u4e3a\u6ca1\u6709\u6570\u636e\u7684 ACK \u8d85\u65f6\u91cd\u4f20"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(75122).A+"",width:"1266",height:"813"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(26596).A+"",width:"934",height:"646"})}),"\n",(0,r.jsxs)(e.p,{children:["\u63a8\u8350\u9605\u8bfb\uff1a",(0,r.jsx)(e.a,{href:"https://yuanrengu.com/2020/77eef79f.html",children:"https://yuanrengu.com/2020/77eef79f.html"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"socket",children:"Socket"}),"\n",(0,r.jsxs)(e.p,{children:["TCP \u901a\u4fe1\u4e5f\u53eb ",(0,r.jsx)(e.strong,{children:"Socket \u7f51\u7edc\u7f16\u7a0b"}),"\uff0c\u53ea\u8981\u4ee3\u7801\u57fa\u4e8e Socket \u5f00\u53d1\uff0c\u5e95\u5c42\u5c31\u662f\u57fa\u4e8e\u4e86\u53ef\u9760\u4f20\u8f93\u7684 TCP \u901a\u4fe1"]}),"\n",(0,r.jsxs)(e.p,{children:["\u53cc\u5411\u901a\u4fe1\uff1aJava Socket \u662f\u5168\u53cc\u5de5\u7684\uff0c\u5728\u4efb\u610f\u65f6\u523b\uff0c\u7ebf\u8def\u4e0a\u5b58\u5728 ",(0,r.jsx)(e.code,{children:"A -> B"})," \u548c ",(0,r.jsx)(e.code,{children:"B -> A"})," \u7684\u53cc\u5411\u4fe1\u53f7\u4f20\u8f93\uff0c\u5373\u4f7f\u662f\u963b\u585e IO\uff0c\u8bfb\u548c\u5199\u4e5f\u662f\u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\u7684\uff0c\u53ea\u8981\u5206\u522b\u91c7\u7528\u8bfb\u7ebf\u7a0b\u548c\u5199\u7ebf\u7a0b\u5373\u53ef\uff0c\u8bfb\u4e0d\u4f1a\u963b\u585e\u5199\u3001\u5199\u4e5f\u4e0d\u4f1a\u963b\u585e\u8bfb"]}),"\n",(0,r.jsx)(e.p,{children:"TCP \u534f\u8bae\u76f8\u5173\u7684\u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Socket\uff1a\u4e00\u4e2a\u8be5\u7c7b\u7684\u5bf9\u8c61\u5c31\u4ee3\u8868\u4e00\u4e2a\u5ba2\u6237\u7aef\u7a0b\u5e8f\u3002"}),"\n",(0,r.jsx)(e.li,{children:"ServerSocket\uff1a\u4e00\u4e2a\u8be5\u7c7b\u7684\u5bf9\u8c61\u5c31\u4ee3\u8868\u4e00\u4e2a\u670d\u52a1\u5668\u7aef\u7a0b\u5e8f\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Socket \u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"Socket(InetAddress address,int port)"}),"\uff1a\u521b\u5efa\u6d41\u5957\u63a5\u5b57\u5e76\u5c06\u5176\u8fde\u63a5\u5230\u6307\u5b9a IP \u6307\u5b9a\u7aef\u53e3\u53f7"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"Socket(String host, int port)"}),"\uff1a\u6839\u636e IP \u5730\u5740\u5b57\u7b26\u4e32\u548c\u7aef\u53e3\u53f7\u521b\u5efa\u5ba2\u6237\u7aef Socket \u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.p,{children:["\u6ce8\u610f\u4e8b\u9879\uff1a",(0,r.jsx)(e.strong,{children:"\u6267\u884c\u8be5\u65b9\u6cd5\uff0c\u5c31\u4f1a\u7acb\u5373\u8fde\u63a5\u6307\u5b9a\u7684\u670d\u52a1\u5668\uff0c\u8fde\u63a5\u6210\u529f\uff0c\u5219\u8868\u793a\u4e09\u6b21\u63e1\u624b\u901a\u8fc7"}),"\uff0c\u53cd\u4e4b\u629b\u51fa\u5f02\u5e38"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528 API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"OutputStream getOutputStream()"}),"\uff1a\u83b7\u5f97\u5b57\u8282\u8f93\u51fa\u6d41\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"InputStream getInputStream()"}),"\uff1a\u83b7\u5f97\u5b57\u8282\u8f93\u5165\u6d41\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"void shutdownInput()"}),"\uff1a\u505c\u6b62\u63a5\u53d7"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"void shutdownOutput()"}),"\uff1a\u505c\u6b62\u53d1\u9001\u6570\u636e\uff0c\u7ec8\u6b62\u901a\u4fe1"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"SocketAddress getRemoteSocketAddress() "}),"\uff1a\u8fd4\u56de\u5957\u63a5\u5b57\u8fde\u63a5\u5230\u7684\u7aef\u70b9\u7684\u5730\u5740\uff0c\u672a\u8fde\u63a5\u8fd4\u56de null"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"ServerSocket \u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6784\u9020\u65b9\u6cd5\uff1a",(0,r.jsx)(e.code,{children:"public ServerSocket(int port)"})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u5e38\u7528 API\uff1a",(0,r.jsx)(e.code,{children:"public Socket accept()"}),"\uff0c",(0,r.jsx)(e.strong,{children:"\u963b\u585e\u7b49\u5f85"}),"\u63a5\u6536\u4e00\u4e2a\u5ba2\u6237\u7aef\u7684 Socket \u7ba1\u9053\u8fde\u63a5\u8bf7\u6c42\uff0c\u8fde\u63a5\u6210\u529f\u8fd4\u56de\u4e00\u4e2a Socket \u5bf9\u8c61"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e09\u6b21\u63e1\u624b\u540e TCP \u8fde\u63a5\u5efa\u7acb\u6210\u529f\uff0c\u670d\u52a1\u5668\u5185\u6838\u4f1a\u628a\u8fde\u63a5\u4ece SYN \u534a\u8fde\u63a5\u961f\u5217\uff08\u4e00\u6b21\u63e1\u624b\u65f6\u5728\u670d\u52a1\u7aef\u5efa\u7acb\u7684\u961f\u5217\uff09\u4e2d\u79fb\u51fa\uff0c\u79fb\u5165 accept \u5168\u8fde\u63a5\u961f\u5217\uff0c\u7b49\u5f85\u8fdb\u7a0b\u8c03\u7528 accept \u51fd\u6570\u65f6\u628a\u8fde\u63a5\u53d6\u51fa\u3002\u5982\u679c\u8fdb\u7a0b\u4e0d\u80fd\u53ca\u65f6\u8c03\u7528 accept \u51fd\u6570\uff0c\u5c31\u4f1a\u9020\u6210 accept \u961f\u5217\u6ea2\u51fa\uff0c\u6700\u7ec8\u5bfc\u81f4\u5efa\u7acb\u597d\u7684 TCP \u8fde\u63a5\u88ab\u4e22\u5f03"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(47418).A+"",width:"837",height:"834"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u76f8\u5f53\u4e8e"}),"\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u5efa\u7acb\u4e00\u4e2a\u6570\u636e\u7ba1\u9053\uff08\u865a\u8fde\u63a5\uff0c\u4e0d\u662f\u771f\u6b63\u7684\u7269\u7406\u8fde\u63a5\uff09\uff0c\u7ba1\u9053\u4e00\u822c\u4e0d\u7528 close"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5b9e\u73b0tcp",children:"\u5b9e\u73b0TCP"}),"\n",(0,r.jsx)(e.h5,{id:"\u5f00\u53d1\u6d41\u7a0b",children:"\u5f00\u53d1\u6d41\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:"\u5ba2\u6237\u7aef\u7684\u5f00\u53d1\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u5ba2\u6237\u7aef\u8981\u8bf7\u6c42\u4e8e\u670d\u52a1\u7aef\u7684 Socket \u7ba1\u9053\u8fde\u63a5"}),"\n",(0,r.jsx)(e.li,{children:"\u4ece Socket \u901a\u4fe1\u7ba1\u9053\u4e2d\u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u8f93\u51fa\u6d41"}),"\n",(0,r.jsx)(e.li,{children:"\u901a\u8fc7\u5b57\u8282\u8f93\u51fa\u6d41\u7ed9\u670d\u52a1\u7aef\u5199\u51fa\u6570\u636e"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u670d\u52a1\u7aef\u7684\u5f00\u53d1\u6d41\u7a0b\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u7528 ServerSocket \u6ce8\u518c\u7aef\u53e3"}),"\n",(0,r.jsx)(e.li,{children:"\u63a5\u6536\u5ba2\u6237\u7aef\u7684 Socket \u7ba1\u9053\u8fde\u63a5"}),"\n",(0,r.jsx)(e.li,{children:"\u4ece Socket \u901a\u4fe1\u7ba1\u9053\u4e2d\u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u8f93\u5165\u6d41"}),"\n",(0,r.jsx)(e.li,{children:"\u4ece\u5b57\u8282\u8f93\u5165\u6d41\u4e2d\u8bfb\u53d6\u5ba2\u6237\u7aef\u53d1\u6765\u7684\u6570\u636e"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(43275).A+"",width:"1349",height:"566"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(24293).A+"",width:"1201",height:"303"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u8f93\u51fa\u7f13\u51b2\u533a\u7a7a\u95f4\u4e0d\u591f\u5b58\u653e\u4e3b\u673a\u53d1\u9001\u7684\u6570\u636e\uff0c\u5219\u4f1a\u88ab\u963b\u585e\uff0c\u8f93\u5165\u7f13\u51b2\u533a\u540c\u7406"}),"\n",(0,r.jsx)(e.li,{children:"\u7f13\u51b2\u533a\u4e0d\u5c5e\u4e8e\u5e94\u7528\u7a0b\u5e8f\uff0c\u5c5e\u4e8e\u5185\u6838"}),"\n",(0,r.jsx)(e.li,{children:"TCP \u4ece\u8f93\u51fa\u7f13\u51b2\u533a\u8bfb\u53d6\u6570\u636e\u4f1a\u52a0\u9501\u963b\u585e\u7ebf\u7a0b"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u5b9e\u73b0\u901a\u4fe1",children:"\u5b9e\u73b0\u901a\u4fe1"}),"\n",(0,r.jsx)(e.p,{children:"\u9700\u6c42\u4e00\uff1a\u5ba2\u6237\u7aef\u53d1\u9001\u4e00\u884c\u6570\u636e\uff0c\u670d\u52a1\u7aef\u63a5\u6536\u4e00\u884c\u6570\u636e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ClientDemo {\n    public static void main(String[] args) throws Exception {\n        // 1.\u5ba2\u6237\u7aef\u8981\u8bf7\u6c42\u4e8e\u670d\u52a1\u7aef\u7684socket\u7ba1\u9053\u8fde\u63a5\u3002\n        Socket socket = new Socket("127.0.0.1", 8080);\n        // 2.\u4ecesocket\u901a\u4fe1\u7ba1\u9053\u4e2d\u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u8f93\u51fa\u6d41\n        OutputStream os = socket.getOutputStream();\n        // 3.\u628a\u4f4e\u7ea7\u7684\u5b57\u8282\u8f93\u51fa\u6d41\u5305\u88c5\u6210\u9ad8\u7ea7\u7684\u6253\u5370\u6d41\u3002\n        PrintStream ps = new PrintStream(os);\n        // 4.\u5f00\u59cb\u53d1\u6d88\u606f\u51fa\u53bb\n        ps.println("\u6211\u662f\u5ba2\u6237\u7aef");\n        ps.flush();//\u4e00\u822c\u4e0d\u5173\u95edIO\u6d41\n        System.out.println("\u5ba2\u6237\u7aef\u53d1\u9001\u5b8c\u6bd5~~~~");\n    }\n}\npublic class ServerDemo{\n    public static void main(String[] args) throws Exception {\n        System.out.println("----\u670d\u52a1\u7aef\u542f\u52a8----");\n        // 1.\u6ce8\u518c\u7aef\u53e3: public ServerSocket(int port)\n        ServerSocket serverSocket = new ServerSocket(8080);\n        // 2.\u5f00\u59cb\u7b49\u5f85\u63a5\u6536\u5ba2\u6237\u7aef\u7684Socket\u7ba1\u9053\u8fde\u63a5\u3002\n        Socket socket = serverSocket.accept();\n        // 3.\u4ecesocket\u901a\u4fe1\u7ba1\u9053\u4e2d\u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u8f93\u5165\u6d41\u3002\n        InputStream is = socket.getInputStream();\n        // 4.\u628a\u5b57\u8282\u8f93\u5165\u6d41\u8f6c\u6362\u6210\u5b57\u7b26\u8f93\u5165\u6d41\n        BufferedReader br = new BufferedReader(new InputStreamReader(is));\n        // 6.\u6309\u7167\u884c\u8bfb\u53d6\u6d88\u606f \u3002\n        String line;\n        if((line = br.readLine()) != null){\n            System.out.println(line);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u9700\u6c42\u4e8c\uff1a\u5ba2\u6237\u7aef\u53ef\u4ee5\u53cd\u590d\u53d1\u9001\u6570\u636e\uff0c\u670d\u52a1\u7aef\u53ef\u4ee5\u53cd\u590d\u6570\u636e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ClientDemo {\n    public static void main(String[] args) throws Exception {\n        // 1.\u5ba2\u6237\u7aef\u8981\u8bf7\u6c42\u4e8e\u670d\u52a1\u7aef\u7684socket\u7ba1\u9053\u8fde\u63a5\u3002\n        Socket socket = new Socket("127.0.0.1",8080);\n        // 2.\u4ecesocket\u901a\u4fe1\u7ba1\u9053\u4e2d\u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u8f93\u51fa\u6d41\n        OutputStream os = socket.getOutputStream();\n        // 3.\u628a\u4f4e\u7ea7\u7684\u5b57\u8282\u8f93\u51fa\u6d41\u5305\u88c5\u6210\u9ad8\u7ea7\u7684\u6253\u5370\u6d41\u3002\n        PrintStream ps = new PrintStream(os);\n        // 4.\u5f00\u59cb\u53d1\u6d88\u606f\u51fa\u53bb\n         while(true){\n            Scanner sc = new Scanner(System.in);\n            System.out.print("\u8bf7\u8bf4\uff1a");\n            ps.println(sc.nextLine());\n            ps.flush();\n        }\n    }\n}\npublic class ServerDemo{\n    public static void main(String[] args) throws Exception {\n        System.out.println("----\u670d\u52a1\u7aef\u542f\u52a8----");\n        // 1.\u6ce8\u518c\u7aef\u53e3: public ServerSocket(int port)\n        ServerSocket serverSocket = new ServerSocket(8080);\n        // 2.\u5f00\u59cb\u7b49\u5f85\u63a5\u6536\u5ba2\u6237\u7aef\u7684Socket\u7ba1\u9053\u8fde\u63a5\u3002\n        Socket socket = serverSocket.accept();\n        // 3.\u4ecesocket\u901a\u4fe1\u7ba1\u9053\u4e2d\u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u8f93\u5165\u6d41\u3002\n        InputStream is = socket.getInputStream();\n        // 4.\u628a\u5b57\u8282\u8f93\u5165\u6d41\u8f6c\u6362\u6210\u5b57\u7b26\u8f93\u5165\u6d41\n        BufferedReader br = new BufferedReader(new InputStreamReader(is));\n        // 6.\u6309\u7167\u884c\u8bfb\u53d6\u6d88\u606f \u3002\n        String line;\n        while((line = br.readLine()) != null){\n            System.out.println(line);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u9700\u6c42\u4e09\uff1a\u5b9e\u73b0\u4e00\u4e2a\u670d\u52a1\u7aef\u53ef\u4ee5\u540c\u65f6\u63a5\u6536\u591a\u4e2a\u5ba2\u6237\u7aef\u7684\u6d88\u606f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ClientDemo {\n    public static void main(String[] args) throws Exception {\n        Socket socket = new Socket("127.0.0.1",8080);\n        OutputStream os = new socket.getOutputStream();\n        PrintStream ps = new PrintStream(os);\n\t\twhile(true){\n            Scanner sc = new Scanner(System.in);\n            System.out.print("\u8bf7\u8bf4\uff1a");\n            ps.println(sc.nextLine());\n            ps.flush();\n        }\n    }\n}\npublic class ServerDemo{\n    public static void main(String[] args) throws Exception {\n        System.out.println("----\u670d\u52a1\u7aef\u542f\u52a8----");\n        ServerSocket serverSocket = new ServerSocket(8080);\n        while(true){\n            // \u5f00\u59cb\u7b49\u5f85\u63a5\u6536\u5ba2\u6237\u7aef\u7684Socket\u7ba1\u9053\u8fde\u63a5\u3002\n             Socket socket = serverSocket.accept();\n            // \u6bcf\u63a5\u6536\u5230\u4e00\u4e2a\u5ba2\u6237\u7aef\u5fc5\u987b\u4e3a\u8fd9\u4e2a\u5ba2\u6237\u7aef\u7ba1\u9053\u5206\u914d\u4e00\u4e2a\u72ec\u7acb\u7684\u7ebf\u7a0b\u6765\u5904\u7406\u4e0e\u4e4b\u901a\u4fe1\u3002\n            new ServerReaderThread(socket).start();\n        }\n    }\n}\nclass ServerReaderThread extends Thread{\n    privat Socket socket;\n    public ServerReaderThread(Socket socket){this.socket = socket;}\n    @Override\n    public void run() {\n        try(InputStream is = socket.getInputStream();\n           \tBufferedReader br = new BufferedReader(new InputStreamReader(is))\n           ){\n            String line;\n            while((line = br.readLine()) != null){\n                sout(socket.getRemoteSocketAddress() + ":" + line);\n            }\n        }catch(Exception e){\n            sout(socket.getRemoteSocketAddress() + "\u4e0b\u7ebf\u4e86~~~~~~");\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u4f2a\u5f02\u6b65",children:"\u4f2a\u5f02\u6b65"}),"\n",(0,r.jsx)(e.p,{children:"\u4e00\u4e2a\u5ba2\u6237\u7aef\u8981\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5e76\u53d1\u8d8a\u9ad8\u7cfb\u7edf\u762b\u75ea\u7684\u8d8a\u5feb\uff0c\u53ef\u4ee5\u5728\u670d\u52a1\u7aef\u5f15\u5165\u7ebf\u7a0b\u6c60\uff0c\u4f7f\u7528\u7ebf\u7a0b\u6c60\u6765\u5904\u7406\u4e0e\u5ba2\u6237\u7aef\u7684\u6d88\u606f\u901a\u4fe1"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4f18\u52bf\uff1a\u4e0d\u4f1a\u5f15\u8d77\u7cfb\u7edf\u7684\u6b7b\u673a\uff0c\u53ef\u4ee5\u63a7\u5236\u5e76\u53d1\u7ebf\u7a0b\u7684\u6570\u91cf"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u52a3\u52bf\uff1a\u540c\u65f6\u53ef\u4ee5\u5e76\u53d1\u7684\u7ebf\u7a0b\u5c06\u53d7\u5230\u9650\u5236"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class BIOServer {\n    public static void main(String[] args) throws Exception {\n        //\u7ebf\u7a0b\u6c60\u673a\u5236\n        //\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u6c60\uff0c\u5982\u679c\u6709\u5ba2\u6237\u7aef\u8fde\u63a5\uff0c\u5c31\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e0e\u4e4b\u901a\u8baf(\u5355\u72ec\u5199\u4e00\u4e2a\u65b9\u6cd5)\n        ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();\n        //\u521b\u5efaServerSocket\n        ServerSocket serverSocket = new ServerSocket(6666);\n        System.out.println("\u670d\u52a1\u5668\u542f\u52a8\u4e86");\n        while (true) {\n            System.out.println("\u7ebf\u7a0b\u540d\u5b57 = " + Thread.currentThread().getName());\n            //\u76d1\u542c\uff0c\u7b49\u5f85\u5ba2\u6237\u7aef\u8fde\u63a5\n            System.out.println("\u7b49\u5f85\u8fde\u63a5....");\n            final Socket socket = serverSocket.accept();\n            System.out.println("\u8fde\u63a5\u5230\u4e00\u4e2a\u5ba2\u6237\u7aef");\n            //\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e0e\u4e4b\u901a\u8baf\n            newCachedThreadPool.execute(new Runnable() {\n                public void run() {\n                    //\u53ef\u4ee5\u548c\u5ba2\u6237\u7aef\u901a\u8baf\n                    handler(socket);\n                }\n            });\n        }\n    }\n\n    //\u7f16\u5199\u4e00\u4e2ahandler\u65b9\u6cd5\uff0c\u548c\u5ba2\u6237\u7aef\u901a\u8baf\n    public static void handler(Socket socket) {\n        try {\n            System.out.println("\u7ebf\u7a0b\u540d\u5b57 = " + Thread.currentThread().getName());\n            byte[] bytes = new byte[1024];\n            //\u901a\u8fc7socket\u83b7\u53d6\u8f93\u5165\u6d41\n            InputStream inputStream = socket.getInputStream();\n            int len;\n            //\u5faa\u73af\u7684\u8bfb\u53d6\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6570\u636e\n            while ((len = inputStream.read(bytes)) != -1) {\n                System.out.println("\u7ebf\u7a0b\u540d\u5b57 = " + Thread.currentThread().getName());\n                //\u8f93\u51fa\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6570\u636e\n                System.out.println(new String(bytes, 0, read));\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            System.out.println("\u5173\u95ed\u548cclient\u7684\u8fde\u63a5");\n            try {\n                socket.close();\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6587\u4ef6\u4f20\u8f93",children:"\u6587\u4ef6\u4f20\u8f93"}),"\n",(0,r.jsx)(e.h5,{id:"\u5b57\u8282\u6d41",children:"\u5b57\u8282\u6d41"}),"\n",(0,r.jsx)(e.p,{children:"\u5ba2\u6237\u7aef\uff1a\u672c\u5730\u56fe\u7247:  \u202aE:\\seazean\\\u56fe\u7247\u8d44\u6e90\\beautiful.jpg\n\u670d\u52a1\u7aef\uff1a\u670d\u52a1\u5668\u8def\u5f84\uff1aE:\\seazean\\\u56fe\u7247\u670d\u52a1\u5668"}),"\n",(0,r.jsx)(e.p,{children:"UUID. randomUUID() : \u65b9\u6cd5\u751f\u6210\u968f\u673a\u7684\u6587\u4ef6\u540d"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"socket.shutdownOutput()"}),"\uff1a\u8fd9\u4e2a\u5fc5\u987b\u6267\u884c\uff0c\u4e0d\u7136\u670d\u52a1\u5668\u4f1a\u4e00\u76f4\u5faa\u73af\u7b49\u5f85\u6570\u636e\uff0c\u6700\u540e\u6587\u4ef6\u635f\u574f\uff0c\u7a0b\u5e8f\u62a5\u9519"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'//\u5e38\u91cf\u5305\npublic class Constants {\n    public static final String SRC_IMAGE = "D:\\\\seazean\\\\\u56fe\u7247\u8d44\u6e90\\\\beautiful.jpg";\n    public static final String SERVER_DIR = "D:\\\\seazean\\\\\u56fe\u7247\u670d\u52a1\u5668\\\\";\n    public static final String SERVER_IP = "127.0.0.1";\n    public static final int SERVER_PORT = 8888;\n\n}\npublic class ClientDemo {\n    public static void main(String[] args) throws Exception {\n        Socket socket = new Socket(Constants.ERVER_IP,Constants.SERVER_PORT);\n        BufferedOutputStream bos=new BufferedOutputStream(socket.getOutputStream());\n        //\u63d0\u53d6\u672c\u673a\u7684\u56fe\u7247\u4e0a\u4f20\u7ed9\u670d\u52a1\u7aef\u3002Constants.SRC_IMAGE\n        BufferedInputStream bis = new BufferedInputStream(new FileInputStream());\n        byte[] buffer = new byte[1024];\n        int len ;\n        while((len = bis.read(buffer)) != -1) {\n            bos.write(buffer, 0 ,len);\n        }\n        bos.flush();// \u5237\u65b0\u56fe\u7247\u6570\u636e\u5230\u670d\u52a1\u7aef\uff01\uff01\n        socket.shutdownOutput();// \u544a\u8bc9\u670d\u52a1\u7aef\u6211\u7684\u6570\u636e\u5df2\u7ecf\u53d1\u9001\u5b8c\u6bd5\uff0c\u4e0d\u8981\u5728\u7b49\u6211\u4e86\uff01\n        bis.close();\n        \n        //\u7b49\u5f85\u7740\u670d\u52a1\u7aef\u7684\u54cd\u5e94\u6570\u636e\uff01\uff01\n        BufferedReader br = new BufferedReader(\n           \t\t\t\t new InputStreamReader(socket.getInputStream()));\n        System.out.println("\u6536\u5230\u670d\u52a1\u7aef\u54cd\u5e94\uff1a"+br.readLine());\n    }\n}\n'})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ServerDemo {\n    public static void main(String[] args) throws Exception {\n        System.out.println("----\u670d\u52a1\u7aef\u542f\u52a8----");\n        // 1.\u6ce8\u518c\u7aef\u53e3: \n        ServerSocket serverSocket = new ServerSocket(Constants.SERVER_PORT);\n        // 2.\u5b9a\u4e49\u4e00\u4e2a\u5faa\u73af\u4e0d\u65ad\u7684\u63a5\u6536\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u8bf7\u6c42\n        while(true){\n            // 3.\u5f00\u59cb\u7b49\u5f85\u63a5\u6536\u5ba2\u6237\u7aef\u7684Socket\u7ba1\u9053\u8fde\u63a5\u3002\n            Socket socket = serverSocket.accept();\n            // 4.\u6bcf\u63a5\u6536\u5230\u4e00\u4e2a\u5ba2\u6237\u7aef\u5fc5\u987b\u4e3a\u8fd9\u4e2a\u5ba2\u6237\u7aef\u7ba1\u9053\u5206\u914d\u4e00\u4e2a\u72ec\u7acb\u7684\u7ebf\u7a0b\u6765\u5904\u7406\u4e0e\u4e4b\u901a\u4fe1\u3002\n            new ServerReaderThread(socket).start();\n        }\n    }\n}\nclass ServerReaderThread extends Thread{\n    private Socket socket ;\n    public ServerReaderThread(Socket socket){this.socket = socket;}\n    @Override\n    public void run() {\n        try{\n            InputStream is = socket.getInputStream();\n           \tBufferedInputStream bis = new BufferedInputStream(is);\n            BufferedOutputStream bos = new BufferedOutputStream(\n                new FileOutputStream\n                (Constants.SERVER_DIR+UUID.randomUUID().toString()+".jpg"));\n            byte[] buffer = new byte[1024];\n            int len;\n            while((len = bis.read(buffer)) != -1){\n                bos.write(buffer,0,len);\n            }\n            bos.close();\n            System.out.println("\u670d\u52a1\u7aef\u63a5\u6536\u5b8c\u6bd5\u4e86\uff01");\n            \n            // 4.\u54cd\u5e94\u6570\u636e\u7ed9\u5ba2\u6237\u7aef\n            PrintStream ps = new PrintStream(socket.getOutputStream());\n            ps.println("\u60a8\u597d\uff0c\u5df2\u6210\u529f\u63a5\u6536\u60a8\u4e0a\u4f20\u7684\u56fe\u7247\uff01");\n            ps.flush();\n            Thread.sleep(10000);\n        }catch (Exception e){\n            sout(socket.getRemoteSocketAddress() + "\u4e0b\u7ebf\u4e86");\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h5,{id:"\u6570\u636e\u6d41",children:"\u6570\u636e\u6d41"}),"\n",(0,r.jsx)(e.p,{children:"\u6784\u9020\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"DataOutputStream(OutputStream out)"})," : \u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u8f93\u51fa\u6d41\uff0c\u4ee5\u5c06\u6570\u636e\u5199\u5165\u6307\u5b9a\u7684\u5e95\u5c42\u8f93\u51fa\u6d41"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"DataInputStream(InputStream in) "})," : \u521b\u5efa\u4f7f\u7528\u6307\u5b9a\u7684\u5e95\u5c42 InputStream \u7684 DataInputStream"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e38\u7528API\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"final void writeUTF(String str)"})," : \u4f7f\u7528\u673a\u5668\u65e0\u5173\u7684\u65b9\u5f0f\u4f7f\u7528 UTF-8 \u7f16\u7801\u5c06\u5b57\u7b26\u4e32\u5199\u5165\u5e95\u5c42\u8f93\u51fa\u6d41"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"final String readUTF()"})," : \u8bfb\u53d6\u4ee5 modified UTF-8 \u683c\u5f0f\u7f16\u7801\u7684 Unicode \u5b57\u7b26\u4e32\uff0c\u8fd4\u56de String \u7c7b\u578b"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class Client {\n    public static void main(String[] args) {\n\t\tInputStream is = new FileInputStream("path");\n            //  1\u3001\u8bf7\u6c42\u4e0e\u670d\u52a1\u7aef\u7684Socket\u94fe\u63a5\n            Socket socket = new Socket("127.0.0.1" , 8888);\n            //  2\u3001\u628a\u5b57\u8282\u8f93\u51fa\u6d41\u5305\u88c5\u6210\u4e00\u4e2a\u6570\u636e\u8f93\u51fa\u6d41\n            DataOutputStream dos = new DataOutputStream(socket.getOutputStream());\n            //  3\u3001\u5148\u53d1\u9001\u4e0a\u4f20\u6587\u4ef6\u7684\u540e\u7f00\u7ed9\u670d\u52a1\u7aef\n            dos.writeUTF(".png");\n            //  4\u3001\u628a\u6587\u4ef6\u6570\u636e\u53d1\u9001\u7ed9\u670d\u52a1\u7aef\u8fdb\u884c\u63a5\u6536\n            byte[] buffer = new byte[1024];\n            int len;\n            while((len = is.read(buffer)) > 0 ){\n                dos.write(buffer , 0 , len);\n            }\n            dos.flush();\n            Thread.sleep(10000);\n    }\n}\n\npublic class Server {\n    public static void main(String[] args) {\n        ServerSocket ss = new ServerSocket(8888);\n        Socket socket = ss.accept();\n \t\t// 1\u3001\u5f97\u5230\u4e00\u4e2a\u6570\u636e\u8f93\u5165\u6d41\u8bfb\u53d6\u5ba2\u6237\u7aef\u53d1\u9001\u8fc7\u6765\u7684\u6570\u636e\n\t\tDataInputStream dis = new DataInputStream(socket.getInputStream());\n\t\t// 2\u3001\u8bfb\u53d6\u5ba2\u6237\u7aef\u53d1\u9001\u8fc7\u6765\u7684\u6587\u4ef6\u7c7b\u578b\n\t\tString suffix = dis.readUTF();\n\t\t// 3\u3001\u5b9a\u4e49\u4e00\u4e2a\u5b57\u8282\u8f93\u51fa\u7ba1\u9053\u8d1f\u8d23\u628a\u5ba2\u6237\u7aef\u53d1\u6765\u7684\u6587\u4ef6\u6570\u636e\u5199\u51fa\u53bb\n\t\tOutputStream os = new FileOutputStream("path"+\n                    UUID.randomUUID().toString()+suffix);\n\t\t// 4\u3001\u4ece\u6570\u636e\u8f93\u5165\u6d41\u4e2d\u8bfb\u53d6\u6587\u4ef6\u6570\u636e\uff0c\u5199\u51fa\u5230\u5b57\u8282\u8f93\u51fa\u6d41\u4e2d\u53bb\n\t\tbyte[] buffer = new byte[1024];\n\t\tint len;\n\t\twhile((len = dis.read(buffer)) > 0){\n \t\t\tos.write(buffer,0, len);\n\t\t}\n\t\tos.close();\n\t\tSystem.out.println("\u670d\u52a1\u7aef\u63a5\u6536\u6587\u4ef6\u4fdd\u5b58\u6210\u529f\uff01");\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"nio",children:"NIO"}),"\n",(0,r.jsx)(e.h3,{id:"\u57fa\u672c\u4ecb\u7ecd-4",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"NIO\u7684\u4ecb\u7ecd"}),"\uff1a"]}),"\n",(0,r.jsx)(e.p,{children:"Java NIO\uff08New IO\u3001Java non-blocking IO\uff09\uff0c\u4ece Java 1.4 \u7248\u672c\u5f00\u59cb\u5f15\u5165\u7684\u4e00\u4e2a\u65b0\u7684 IO API\uff0c\u53ef\u4ee5\u66ff\u4ee3\u6807\u51c6\u7684 Java IO API\uff0cNIO \u652f\u6301\u9762\u5411\u7f13\u51b2\u533a\u7684\u3001\u57fa\u4e8e\u901a\u9053\u7684 IO \u64cd\u4f5c\uff0c\u4ee5\u66f4\u52a0\u9ad8\u6548\u7684\u65b9\u5f0f\u8fdb\u884c\u6587\u4ef6\u7684\u8bfb\u5199\u64cd\u4f5c"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["NIO \u6709\u4e09\u5927\u6838\u5fc3\u90e8\u5206\uff1a",(0,r.jsx)(e.strong,{children:"Channel\uff08\u901a\u9053\uff09\uff0cBuffer\uff08\u7f13\u51b2\u533a\uff09\uff0cSelector\uff08\u9009\u62e9\u5668\uff09"})]}),"\n",(0,r.jsx)(e.li,{children:"NIO \u662f\u975e\u963b\u585e IO\uff0c\u4f20\u7edf IO \u7684 read \u548c write \u53ea\u80fd\u963b\u585e\u6267\u884c\uff0c\u7ebf\u7a0b\u5728\u8bfb\u5199 IO \u671f\u95f4\u4e0d\u80fd\u5e72\u5176\u4ed6\u4e8b\u60c5\uff0c\u6bd4\u5982\u8c03\u7528 socket.accept()\uff0c\u5982\u679c\u670d\u52a1\u5668\u6ca1\u6709\u6570\u636e\u4f20\u8f93\u8fc7\u6765\uff0c\u7ebf\u7a0b\u5c31\u4e00\u76f4\u963b\u585e\uff0c\u800c NIO \u4e2d\u53ef\u4ee5\u914d\u7f6e Socket \u4e3a\u975e\u963b\u585e\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.li,{children:"NIO \u53ef\u4ee5\u505a\u5230\u7528\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5904\u7406\u591a\u4e2a\u64cd\u4f5c\u7684\u3002\u5047\u8bbe\u6709 1000 \u4e2a\u8bf7\u6c42\u8fc7\u6765\uff0c\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u53ef\u4ee5\u5206\u914d 20 \u6216\u8005 80 \u4e2a\u7ebf\u7a0b\u6765\u5904\u7406\uff0c\u4e0d\u50cf\u4e4b\u524d\u7684\u963b\u585e IO \u90a3\u6837\u5206\u914d 1000 \u4e2a"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"NIO \u548c BIO \u7684\u6bd4\u8f83\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"BIO \u4ee5\u6d41\u7684\u65b9\u5f0f\u5904\u7406\u6570\u636e\uff0c\u800c NIO \u4ee5\u5757\u7684\u65b9\u5f0f\u5904\u7406\u6570\u636e\uff0c\u5757 I/O \u7684\u6548\u7387\u6bd4\u6d41 I/O \u9ad8\u5f88\u591a"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"BIO \u662f\u963b\u585e\u7684\uff0cNIO \u5219\u662f\u975e\u963b\u585e\u7684"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"BIO \u57fa\u4e8e\u5b57\u8282\u6d41\u548c\u5b57\u7b26\u6d41\u8fdb\u884c\u64cd\u4f5c\uff0c\u800c NIO \u57fa\u4e8e Channel \u548c Buffer \u8fdb\u884c\u64cd\u4f5c\uff0c\u6570\u636e\u4ece\u901a\u9053\u8bfb\u53d6\u5230\u7f13\u51b2\u533a\u4e2d\uff0c\u6216\u8005\u4ece\u7f13\u51b2\u533a\u5199\u5165\u5230\u901a\u9053\u4e2d\u3002Selector \u7528\u4e8e\u76d1\u542c\u591a\u4e2a\u901a\u9053\u7684\u4e8b\u4ef6\uff08\u6bd4\u5982\uff1a\u8fde\u63a5\u8bf7\u6c42\uff0c\u6570\u636e\u5230\u8fbe\u7b49\uff09\uff0c\u56e0\u6b64\u4f7f\u7528\u5355\u4e2a\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u76d1\u542c\u591a\u4e2a\u5ba2\u6237\u7aef\u901a\u9053"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"NIO"}),(0,r.jsx)(e.th,{children:"BIO"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u9762\u5411\u7f13\u51b2\u533a\uff08Buffer\uff09"}),(0,r.jsx)(e.td,{children:"\u9762\u5411\u6d41\uff08Stream\uff09"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u975e\u963b\u585e\uff08Non Blocking IO\uff09"}),(0,r.jsx)(e.td,{children:"\u963b\u585eIO(Blocking IO)"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u9009\u62e9\u5668\uff08Selectors\uff09"}),(0,r.jsx)(e.td,{})]})]})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u5b9e\u73b0\u539f\u7406-9",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"NIO \u4e09\u5927\u6838\u5fc3\u90e8\u5206\uff1aChannel (\u901a\u9053)\u3001Buffer (\u7f13\u51b2\u533a)\u3001Selector (\u9009\u62e9\u5668)"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Buffer \u7f13\u51b2\u533a"}),"\n",(0,r.jsxs)(e.p,{children:["\u7f13\u51b2\u533a\u672c\u8d28\u662f\u4e00\u5757\u53ef\u4ee5\u5199\u5165\u6570\u636e\u3001\u8bfb\u53d6\u6570\u636e\u7684\u5185\u5b58\uff0c",(0,r.jsx)(e.strong,{children:"\u5e95\u5c42\u662f\u4e00\u4e2a\u6570\u7ec4"}),"\uff0c\u8fd9\u5757\u5185\u5b58\u88ab\u5305\u88c5\u6210 NIO Buffer \u5bf9\u8c61\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86\u65b9\u6cd5\u7528\u6765\u64cd\u4f5c\u8fd9\u5757\u5185\u5b58\uff0c\u76f8\u6bd4\u8f83\u76f4\u63a5\u5bf9\u6570\u7ec4\u7684\u64cd\u4f5c\uff0cBuffer \u7684 API \u66f4\u52a0\u5bb9\u6613\u64cd\u4f5c\u548c\u7ba1\u7406"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Channel \u901a\u9053"}),"\n",(0,r.jsx)(e.p,{children:"Java NIO \u7684\u901a\u9053\u7c7b\u4f3c\u6d41\uff0c\u4e0d\u540c\u7684\u662f\u65e2\u53ef\u4ee5\u4ece\u901a\u9053\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u53c8\u53ef\u4ee5\u5199\u6570\u636e\u5230\u901a\u9053\uff0c\u6d41\u7684\u8bfb\u5199\u901a\u5e38\u662f\u5355\u5411\u7684\uff0c\u901a\u9053\u53ef\u4ee5\u975e\u963b\u585e\u8bfb\u53d6\u548c\u5199\u5165\u901a\u9053\uff0c\u652f\u6301\u8bfb\u53d6\u6216\u5199\u5165\u7f13\u51b2\u533a\uff0c\u4e5f\u652f\u6301\u5f02\u6b65\u5730\u8bfb\u5199"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Selector \u9009\u62e9\u5668"}),"\n",(0,r.jsx)(e.p,{children:"Selector \u662f\u4e00\u4e2a Java NIO \u7ec4\u4ef6\uff0c\u80fd\u591f\u68c0\u67e5\u4e00\u4e2a\u6216\u591a\u4e2a NIO \u901a\u9053\uff0c\u5e76\u786e\u5b9a\u54ea\u4e9b\u901a\u9053\u5df2\u7ecf\u51c6\u5907\u597d\u8fdb\u884c\u8bfb\u53d6\u6216\u5199\u5165\uff0c\u8fd9\u6837\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u53ef\u4ee5\u7ba1\u7406\u591a\u4e2a channel\uff0c\u4ece\u800c\u7ba1\u7406\u591a\u4e2a\u7f51\u7edc\u8fde\u63a5\uff0c\u63d0\u9ad8\u6548\u7387"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"NIO \u7684\u5b9e\u73b0\u6846\u67b6\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(47468).A+"",width:"486",height:"471"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6bcf\u4e2a Channel \u5bf9\u5e94\u4e00\u4e2a Buffer"}),"\n",(0,r.jsx)(e.li,{children:"\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u5e94 Selector \uff0c \u4e00\u4e2a Selector \u5bf9\u5e94\u591a\u4e2a Channel\uff08\u8fde\u63a5\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u7a0b\u5e8f\u5207\u6362\u5230\u54ea\u4e2a Channel \u662f\u7531\u4e8b\u4ef6\u51b3\u5b9a\u7684\uff0cEvent \u662f\u4e00\u4e2a\u91cd\u8981\u7684\u6982\u5ff5"}),"\n",(0,r.jsx)(e.li,{children:"Selector \u4f1a\u6839\u636e\u4e0d\u540c\u7684\u4e8b\u4ef6\uff0c\u5728\u5404\u4e2a\u901a\u9053\u4e0a\u5207\u6362"}),"\n",(0,r.jsx)(e.li,{children:"Buffer \u662f\u4e00\u4e2a\u5185\u5b58\u5757 \uff0c \u5e95\u5c42\u662f\u4e00\u4e2a\u6570\u7ec4"}),"\n",(0,r.jsx)(e.li,{children:"\u6570\u636e\u7684\u8bfb\u53d6\u5199\u5165\u662f\u901a\u8fc7 Buffer \u5b8c\u6210\u7684 , BIO \u4e2d\u8981\u4e48\u662f\u8f93\u5165\u6d41\uff0c\u6216\u8005\u662f\u8f93\u51fa\u6d41\uff0c\u4e0d\u80fd\u53cc\u5411\uff0cNIO \u7684 Buffer \u662f\u53ef\u4ee5\u8bfb\u4e5f\u53ef\u4ee5\u5199\uff0c flip() \u5207\u6362 Buffer \u7684\u5de5\u4f5c\u6a21\u5f0f"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Java NIO \u7cfb\u7edf\u7684\u6838\u5fc3\u5728\u4e8e\uff1a\u901a\u9053\u548c\u7f13\u51b2\u533a\uff0c\u901a\u9053\u8868\u793a\u6253\u5f00\u7684 IO \u8bbe\u5907\uff08\u4f8b\u5982\uff1a\u6587\u4ef6\u3001 \u5957\u63a5\u5b57\uff09\u7684\u8fde\u63a5\u3002\u82e5\u8981\u4f7f\u7528 NIO \u7cfb\u7edf\uff0c\u83b7\u53d6\u7528\u4e8e\u8fde\u63a5 IO \u8bbe\u5907\u7684\u901a\u9053\u4ee5\u53ca\u7528\u4e8e\u5bb9\u7eb3\u6570\u636e\u7684\u7f13\u51b2\u533a\uff0c\u7136\u540e\u64cd\u4f5c\u7f13\u51b2\u533a\uff0c\u5bf9\u6570\u636e\u8fdb\u884c\u5904\u7406\u3002\u7b80\u800c\u8a00\u4e4b\uff0cChannel \u8d1f\u8d23\u4f20\u8f93\uff0c Buffer \u8d1f\u8d23\u5b58\u53d6\u6570\u636e"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u7f13\u51b2\u533a",children:"\u7f13\u51b2\u533a"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-5",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsxs)(e.p,{children:["\u7f13\u51b2\u533a\uff08Buffer\uff09\uff1a\u7f13\u51b2\u533a\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a",(0,r.jsx)(e.strong,{children:"\u53ef\u4ee5\u8bfb\u5199\u6570\u636e\u7684\u5185\u5b58\u5757"}),"\uff0c\u7528\u4e8e\u7279\u5b9a\u57fa\u672c\u6570\u636e\u7c7b\u578b\u7684\u5bb9\u5668\uff0c\u7528\u4e8e\u4e0e NIO \u901a\u9053\u8fdb\u884c\u4ea4\u4e92\uff0c\u6570\u636e\u662f\u4ece\u901a\u9053\u8bfb\u5165\u7f13\u51b2\u533a\uff0c\u4ece\u7f13\u51b2\u533a\u5199\u5165\u901a\u9053\u4e2d\u7684"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(77869).A+"",width:"693",height:"187"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Buffer \u5e95\u5c42\u662f\u4e00\u4e2a\u6570\u7ec4"}),"\uff0c\u53ef\u4ee5\u4fdd\u5b58\u591a\u4e2a\u76f8\u540c\u7c7b\u578b\u7684\u6570\u636e\uff0c\u6839\u636e\u6570\u636e\u7c7b\u578b\u4e0d\u540c \uff0c\u6709\u4ee5\u4e0b Buffer \u5e38\u7528\u5b50\u7c7b\uff1aByteBuffer\u3001CharBuffer\u3001ShortBuffer\u3001IntBuffer\u3001LongBuffer\u3001FloatBuffer\u3001DoubleBuffer"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u5c5e\u6027",children:"\u57fa\u672c\u5c5e\u6027"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5bb9\u91cf\uff08capacity\uff09\uff1a\u4f5c\u4e3a\u4e00\u4e2a\u5185\u5b58\u5757\uff0cBuffer \u5177\u6709\u56fa\u5b9a\u5927\u5c0f\uff0c\u7f13\u51b2\u533a\u5bb9\u91cf\u4e0d\u80fd\u4e3a\u8d1f\uff0c\u5e76\u4e14\u521b\u5efa\u540e\u4e0d\u80fd\u66f4\u6539"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u9650\u5236 \uff08limit\uff09\uff1a\u8868\u793a\u7f13\u51b2\u533a\u4e2d\u53ef\u4ee5\u64cd\u4f5c\u6570\u636e\u7684\u5927\u5c0f\uff08limit \u540e\u6570\u636e\u4e0d\u80fd\u8fdb\u884c\u8bfb\u5199\uff09\uff0c\u7f13\u51b2\u533a\u7684\u9650\u5236\u4e0d\u80fd\u4e3a\u8d1f\uff0c\u5e76\u4e14\u4e0d\u80fd\u5927\u4e8e\u5176\u5bb9\u91cf\u3002\u5199\u5165\u6a21\u5f0f\uff0climit \u7b49\u4e8e buffer \u7684\u5bb9\u91cf\uff1b\u8bfb\u53d6\u6a21\u5f0f\u4e0b\uff0climit \u7b49\u4e8e\u5199\u5165\u7684\u6570\u636e\u91cf"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4f4d\u7f6e\uff08position\uff09\uff1a",(0,r.jsx)(e.strong,{children:"\u4e0b\u4e00\u4e2a\u8981\u8bfb\u53d6\u6216\u5199\u5165\u7684\u6570\u636e\u7684\u7d22\u5f15"}),"\uff0c\u7f13\u51b2\u533a\u7684\u4f4d\u7f6e\u4e0d\u80fd\u4e3a\u8d1f\uff0c\u5e76\u4e14\u4e0d\u80fd\u5927\u4e8e\u5176\u9650\u5236"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u6807\u8bb0\uff08mark\uff09\u4e0e\u91cd\u7f6e\uff08reset\uff09\uff1a\u6807\u8bb0\u662f\u4e00\u4e2a\u7d22\u5f15\uff0c\u901a\u8fc7 Buffer \u4e2d\u7684 mark() \u65b9\u6cd5\u6307\u5b9a Buffer \u4e2d\u4e00\u4e2a\u7279\u5b9a\u7684\u4f4d\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528 reset() \u65b9\u6cd5\u6062\u590d\u5230\u8fd9\u4e2a position"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u4f4d\u7f6e\u3001\u9650\u5236\u3001\u5bb9\u91cf\u9075\u5b88\u4ee5\u4e0b\u4e0d\u53d8\u5f0f\uff1a ",(0,r.jsx)(e.strong,{children:"0 <= position <= limit <= capacity"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(12986).A+"",width:"929",height:"652"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5e38\u7528api-1",children:"\u5e38\u7528API"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"static XxxBuffer allocate(int capacity)"}),"\uff1a\u521b\u5efa\u4e00\u4e2a\u5bb9\u91cf\u4e3a capacity \u7684 XxxBuffer \u5bf9\u8c61"]}),"\n",(0,r.jsx)(e.p,{children:"Buffer \u57fa\u672c\u64cd\u4f5c\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public Buffer clear()"}),(0,r.jsx)(e.td,{children:"\u6e05\u7a7a\u7f13\u51b2\u533a\uff0c\u4e0d\u6e05\u7a7a\u5185\u5bb9\uff0c\u5c06\u4f4d\u7f6e\u8bbe\u7f6e\u4e3a\u96f6\uff0c\u9650\u5236\u8bbe\u7f6e\u4e3a\u5bb9\u91cf"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public Buffer flip()"}),(0,r.jsx)(e.td,{children:"\u7ffb\u8f6c\u7f13\u51b2\u533a\uff0c\u5c06\u7f13\u51b2\u533a\u7684\u754c\u9650\u8bbe\u7f6e\u4e3a\u5f53\u524d\u4f4d\u7f6e\uff0cposition \u7f6e 0"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public int capacity()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de Buffer\u7684 capacity \u5927\u5c0f"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int limit()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de Buffer \u7684\u754c\u9650 limit \u7684\u4f4d\u7f6e"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public Buffer limit(int n)"}),(0,r.jsx)(e.td,{children:"\u8bbe\u7f6e\u7f13\u51b2\u533a\u754c\u9650\u4e3a n"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public Buffer mark()"}),(0,r.jsx)(e.td,{children:"\u5728\u6b64\u4f4d\u7f6e\u5bf9\u7f13\u51b2\u533a\u8bbe\u7f6e\u6807\u8bb0"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int position()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u7f13\u51b2\u533a\u7684\u5f53\u524d\u4f4d\u7f6e position"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public Buffer position(int n)"}),(0,r.jsx)(e.td,{children:"\u8bbe\u7f6e\u7f13\u51b2\u533a\u7684\u5f53\u524d\u4f4d\u7f6e\u4e3an"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public Buffer reset()"}),(0,r.jsx)(e.td,{children:"\u5c06\u4f4d\u7f6e position \u91cd\u7f6e\u4e3a\u5148\u524d mark \u6807\u8bb0\u7684\u4f4d\u7f6e"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public Buffer rewind()"}),(0,r.jsx)(e.td,{children:"\u5c06\u4f4d\u7f6e\u8bbe\u4e3a\u4e3a 0\uff0c\u53d6\u6d88\u8bbe\u7f6e\u7684 mark"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final int remaining()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u5f53\u524d\u4f4d\u7f6e position \u548c limit \u4e4b\u95f4\u7684\u5143\u7d20\u4e2a\u6570"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final boolean hasRemaining()"}),(0,r.jsx)(e.td,{children:"\u5224\u65ad\u7f13\u51b2\u533a\u4e2d\u662f\u5426\u8fd8\u6709\u5143\u7d20"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public static ByteBuffer wrap(byte[] array)"}),(0,r.jsx)(e.td,{children:"\u5c06\u4e00\u4e2a\u5b57\u8282\u6570\u7ec4\u5305\u88c5\u5230\u7f13\u51b2\u533a\u4e2d"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"abstract ByteBuffer asReadOnlyBuffer()"}),(0,r.jsx)(e.td,{children:"\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u53ea\u8bfb\u5b57\u8282\u7f13\u51b2\u533a"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract ByteBuffer compact()"}),(0,r.jsx)(e.td,{children:"\u7f13\u51b2\u533a\u5f53\u524d\u4f4d\u7f6e\u4e0e\u5176\u9650\u5236\uff08\u5982\u679c\u6709\uff09\u4e4b\u95f4\u7684\u5b57\u8282\u88ab\u590d\u5236\u5230\u7f13\u51b2\u533a\u7684\u5f00\u5934"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:"Buffer \u6570\u636e\u64cd\u4f5c\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract byte get()"}),(0,r.jsx)(e.td,{children:"\u8bfb\u53d6\u8be5\u7f13\u51b2\u533a\u5f53\u524d\u4f4d\u7f6e\u7684\u5355\u4e2a\u5b57\u8282\uff0c\u7136\u540e\u4f4d\u7f6e + 1"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public ByteBuffer get(byte[] dst)"}),(0,r.jsx)(e.td,{children:"\u8bfb\u53d6\u591a\u4e2a\u5b57\u8282\u5230\u5b57\u8282\u6570\u7ec4 dst \u4e2d"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract byte get(int index)"}),(0,r.jsx)(e.td,{children:"\u8bfb\u53d6\u6307\u5b9a\u7d22\u5f15\u4f4d\u7f6e\u7684\u5b57\u8282\uff0c\u4e0d\u79fb\u52a8 position"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract ByteBuffer put(byte b)"}),(0,r.jsx)(e.td,{children:"\u5c06\u7ed9\u5b9a\u5355\u4e2a\u5b57\u8282\u5199\u5165\u7f13\u51b2\u533a\u7684\u5f53\u524d\u4f4d\u7f6e\uff0cposition+1"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final ByteBuffer put(byte[] src)"}),(0,r.jsx)(e.td,{children:"\u5c06 src \u5b57\u8282\u6570\u7ec4\u5199\u5165\u7f13\u51b2\u533a\u7684\u5f53\u524d\u4f4d\u7f6e"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract ByteBuffer put(int index, byte b)"}),(0,r.jsx)(e.td,{children:"\u5c06\u6307\u5b9a\u5b57\u8282\u5199\u5165\u7f13\u51b2\u533a\u7684\u7d22\u5f15\u4f4d\u7f6e\uff0c\u4e0d\u79fb\u52a8 position"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:'\u63d0\u793a\uff1a"\\n"\uff0c\u5360\u7528\u4e24\u4e2a\u5b57\u8282'}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u8bfb\u5199\u6570\u636e",children:"\u8bfb\u5199\u6570\u636e"}),"\n",(0,r.jsx)(e.p,{children:"\u4f7f\u7528 Buffer \u8bfb\u5199\u6570\u636e\u4e00\u822c\u9075\u5faa\u4ee5\u4e0b\u56db\u4e2a\u6b65\u9aa4\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5199\u5165\u6570\u636e\u5230 Buffer"}),"\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528 flip()\u65b9\u6cd5\uff0c\u8f6c\u6362\u4e3a\u8bfb\u53d6\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.li,{children:"\u4ece Buffer \u4e2d\u8bfb\u53d6\u6570\u636e"}),"\n",(0,r.jsx)(e.li,{children:"\u8c03\u7528 buffer.clear() \u65b9\u6cd5\u6e05\u9664\u7f13\u51b2\u533a\uff08\u4e0d\u662f\u6e05\u7a7a\u4e86\u6570\u636e\uff0c\u53ea\u662f\u91cd\u7f6e\u6307\u9488\uff09"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class TestBuffer {\n\t@Test\n    public void test(){\n\t\tString str = "seazean";\n\t\t//1. \u5206\u914d\u4e00\u4e2a\u6307\u5b9a\u5927\u5c0f\u7684\u7f13\u51b2\u533a\n\t\tByteBuffer buffer = ByteBuffer.allocate(1024);\n\t\tSystem.out.println("-----------------allocate()----------------");\n\t\tSystem.out.println(bufferf.position());//0\n\t\tSystem.out.println(buffer.limit());//1024\n\t\tSystem.out.println(buffer.capacity());//1024\n        \n        //2. \u5229\u7528 put() \u5b58\u5165\u6570\u636e\u5230\u7f13\u51b2\u533a\u4e2d\n      \tbuffer.put(str.getBytes());\n     \tSystem.out.println("-----------------put()----------------");\n\t\tSystem.out.println(bufferf.position());//7\n\t\tSystem.out.println(buffer.limit());//1024\n\t\tSystem.out.println(buffer.capacity());//1024\n        \n        //3. \u5207\u6362\u8bfb\u53d6\u6570\u636e\u6a21\u5f0f\n        buffer.flip();\n        System.out.println("-----------------flip()----------------");\n        System.out.println(buffer.position());//0\n        System.out.println(buffer.limit());//7\n        System.out.println(buffer.capacity());//1024\n        \n        //4. \u5229\u7528 get() \u8bfb\u53d6\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\n        byte[] dst = new byte[buffer.limit()];\n        buffer.get(dst);\n        System.out.println(dst.length);\n        System.out.println(new String(dst, 0, dst.length));\n        System.out.println(buffer.position());//7\n        System.out.println(buffer.limit());//7\n       \n        //5. clear() : \u6e05\u7a7a\u7f13\u51b2\u533a. \u4f46\u662f\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\u4f9d\u7136\u5b58\u5728\uff0c\u4f46\u662f\u5904\u4e8e\u201c\u88ab\u9057\u5fd8\u201d\u72b6\u6001\n        System.out.println(buffer.hasRemaining());//true\n        buffer.clear();\n        System.out.println(buffer.hasRemaining());//true\n      \tSystem.out.println("-----------------clear()----------------");\n      \tSystem.out.println(buffer.position());//0\n      \tSystem.out.println(buffer.limit());//1024\n      \tSystem.out.println(buffer.capacity());//1024\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u7c98\u5305\u62c6\u5305",children:"\u7c98\u5305\u62c6\u5305"}),"\n",(0,r.jsx)(e.p,{children:"\u7f51\u7edc\u4e0a\u6709\u591a\u6761\u6570\u636e\u53d1\u9001\u7ed9\u670d\u52a1\u7aef\uff0c\u6570\u636e\u4e4b\u95f4\u4f7f\u7528 \\n \u8fdb\u884c\u5206\u9694\uff0c\u4f46\u8fd9\u4e9b\u6570\u636e\u5728\u63a5\u6536\u65f6\uff0c\u88ab\u8fdb\u884c\u4e86\u91cd\u65b0\u7ec4\u5408"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// Hello,world\\n\n// I'm zhangsan\\n\n// How are you?\\n\n------ > \u9ecf\u5305\uff0c\u534a\u5305\n// Hello,world\\nI'm zhangsan\\nHo\n// w are you?\\n\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public static void main(String[] args) {\n    ByteBuffer source = ByteBuffer.allocate(32);\n    //                     11            24\n    source.put("Hello,world\\nI\'m zhangsan\\nHo".getBytes());\n    split(source);\n\n    source.put("w are you?\\nhaha!\\n".getBytes());\n    split(source);\n}\n\nprivate static void split(ByteBuffer source) {\n    source.flip();\n    int oldLimit = source.limit();\n    for (int i = 0; i < oldLimit; i++) {\n        if (source.get(i) == \'\\n\') {\n            // \u6839\u636e\u6570\u636e\u7684\u957f\u5ea6\u8bbe\u7f6e\u7f13\u51b2\u533a\n            ByteBuffer target = ByteBuffer.allocate(i + 1 - source.position());\n            // 0 ~ limit\n            source.limit(i + 1);\n            target.put(source); // \u4ecesource \u8bfb\uff0c\u5411 target \u5199\n            // debugAll(target); \u8bbf\u95ee buffer \u7684\u65b9\u6cd5\n            source.limit(oldLimit);\n        }\n    }\n    // \u8bbf\u95ee\u8fc7\u7684\u6570\u636e\u590d\u5236\u5230\u5f00\u5934\n    source.compact();\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u76f4\u63a5\u5185\u5b58",children:"\u76f4\u63a5\u5185\u5b58"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-6",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsx)(e.p,{children:"Byte Buffer \u6709\u4e24\u79cd\u7c7b\u578b\uff0c\u4e00\u79cd\u662f\u57fa\u4e8e\u76f4\u63a5\u5185\u5b58\uff08\u4e5f\u5c31\u662f\u975e\u5806\u5185\u5b58\uff09\uff0c\u53e6\u4e00\u79cd\u662f\u975e\u76f4\u63a5\u5185\u5b58\uff08\u4e5f\u5c31\u662f\u5806\u5185\u5b58\uff09"}),"\n",(0,r.jsx)(e.p,{children:"Direct Memory \u4f18\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Java \u7684 NIO \u5e93\u5141\u8bb8 Java \u7a0b\u5e8f\u4f7f\u7528\u76f4\u63a5\u5185\u5b58\uff0c\u4f7f\u7528 native \u51fd\u6570\u76f4\u63a5\u5206\u914d\u5806\u5916\u5185\u5b58"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u8bfb\u5199\u6027\u80fd\u9ad8"}),"\uff0c\u8bfb\u5199\u9891\u7e41\u7684\u573a\u5408\u53ef\u80fd\u4f1a\u8003\u8651\u4f7f\u7528\u76f4\u63a5\u5185\u5b58"]}),"\n",(0,r.jsx)(e.li,{children:"\u5927\u5927\u63d0\u9ad8 IO \u6027\u80fd\uff0c\u907f\u514d\u4e86\u5728 Java \u5806\u548c native \u5806\u6765\u56de\u590d\u5236\u6570\u636e"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u76f4\u63a5\u5185\u5b58\u7f3a\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e0d\u80fd\u4f7f\u7528\u5185\u6838\u7f13\u51b2\u533a Page Cache \u7684\u7f13\u5b58\u4f18\u52bf\uff0c\u65e0\u6cd5\u7f13\u5b58\u6700\u8fd1\u88ab\u8bbf\u95ee\u7684\u6570\u636e\u548c\u4f7f\u7528\u9884\u8bfb\u529f\u80fd"}),"\n",(0,r.jsx)(e.li,{children:"\u5206\u914d\u56de\u6536\u6210\u672c\u8f83\u9ad8\uff0c\u4e0d\u53d7 JVM \u5185\u5b58\u56de\u6536\u7ba1\u7406"}),"\n",(0,r.jsx)(e.li,{children:"\u53ef\u80fd\u5bfc\u81f4 OutOfMemoryError \u5f02\u5e38\uff1aOutOfMemoryError: Direct buffer memory"}),"\n",(0,r.jsx)(e.li,{children:"\u56de\u6536\u4f9d\u8d56 System.gc() \u7684\u8c03\u7528\uff0c\u4f46\u8fd9\u4e2a\u8c03\u7528 JVM \u4e0d\u4fdd\u8bc1\u6267\u884c\u3001\u4e5f\u4e0d\u4fdd\u8bc1\u4f55\u65f6\u6267\u884c\uff0c\u884c\u4e3a\u662f\u4e0d\u53ef\u63a7\u7684\u3002\u7a0b\u5e8f\u4e00\u822c\u9700\u8981\u81ea\u884c\u7ba1\u7406\uff0c\u6210\u5bf9\u53bb\u8c03\u7528 malloc\u3001free"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5e94\u7528\u573a\u666f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f20\u8f93\u5f88\u5927\u7684\u6570\u636e\u6587\u4ef6\uff0c\u6570\u636e\u7684\u751f\u547d\u5468\u671f\u5f88\u957f\uff0c\u5bfc\u81f4 Page Cache \u6ca1\u6709\u8d77\u5230\u7f13\u5b58\u7684\u4f5c\u7528\uff0c\u4e00\u822c\u91c7\u7528\u76f4\u63a5 IO \u7684\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.li,{children:"\u9002\u5408\u9891\u7e41\u7684 IO \u64cd\u4f5c\uff0c\u6bd4\u5982\u7f51\u7edc\u5e76\u53d1\u573a\u666f"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6570\u636e\u6d41\u7684\u89d2\u5ea6\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u975e\u76f4\u63a5\u5185\u5b58\u7684\u4f5c\u7528\u94fe\uff1a\u672c\u5730 IO \u2192 \u5185\u6838\u7f13\u51b2\u533a\u2192 \u7528\u6237\uff08JVM\uff09\u7f13\u51b2\u533a \u2192\u5185\u6838\u7f13\u51b2\u533a \u2192 \u672c\u5730 IO"}),"\n",(0,r.jsx)(e.li,{children:"\u76f4\u63a5\u5185\u5b58\u662f\uff1a\u672c\u5730 IO \u2192 \u76f4\u63a5\u5185\u5b58 \u2192 \u672c\u5730 IO"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"JVM \u76f4\u63a5\u5185\u5b58\u56fe\u89e3\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(16042).A+"",width:"1280",height:"662"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(92462).A+"",width:"1280",height:"580"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u901a\u4fe1\u539f\u7406",children:"\u901a\u4fe1\u539f\u7406"}),"\n",(0,r.jsx)(e.p,{children:"\u5806\u5916\u5185\u5b58\u4e0d\u53d7 JVM GC \u63a7\u5236\uff0c\u53ef\u4ee5\u4f7f\u7528\u5806\u5916\u5185\u5b58\u8fdb\u884c\u901a\u4fe1\uff0c\u9632\u6b62 GC \u540e\u7f13\u51b2\u533a\u4f4d\u7f6e\u53d1\u751f\u53d8\u5316\u7684\u60c5\u51b5"}),"\n",(0,r.jsx)(e.p,{children:"NIO \u4f7f\u7528\u7684 SocketChannel \u4e5f\u662f\u4f7f\u7528\u7684\u5806\u5916\u5185\u5b58\uff0c\u6e90\u7801\u89e3\u6790\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"SocketChannel#write(java.nio.ByteBuffer) \u2192 SocketChannelImpl#write(java.nio.ByteBuffer)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public int write(ByteBuffer var1) throws IOException {\n     do {\n         var3 = IOUtil.write(this.fd, var1, -1L, nd);\n     } while(var3 == -3 && this.isOpen());\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"IOUtil#write(java.io.FileDescriptor, java.nio.ByteBuffer, long, sun.nio.ch.NativeDispatcher)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"static int write(FileDescriptor var0, ByteBuffer var1, long var2, NativeDispatcher var4) {\n    // \u3010\u5224\u65ad\u662f\u5426\u662f\u76f4\u63a5\u5185\u5b58\uff0c\u662f\u5219\u76f4\u63a5\u5199\u51fa\uff0c\u4e0d\u662f\u5219\u5c01\u88c5\u5230\u76f4\u63a5\u5185\u5b58\u3011\n    if (var1 instanceof DirectBuffer) {\n        return writeFromNativeBuffer(var0, var1, var2, var4);\n    } else {\n        //....\n        // \u4ece\u5806\u5185buffer\u62f7\u8d1d\u5230\u5806\u5916buffer\n        ByteBuffer var8 = Util.getTemporaryDirectBuffer(var7);\n        var8.put(var1);\n        //...\n        // \u4ece\u5806\u5916\u5199\u5230\u5185\u6838\u7f13\u51b2\u533a\n\t\tint var9 = writeFromNativeBuffer(var0, var8, var2, var4);\n\t}\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u8bfb\u64cd\u4f5c\u76f8\u540c"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5206\u914d\u56de\u6536",children:"\u5206\u914d\u56de\u6536"}),"\n",(0,r.jsxs)(e.p,{children:["\u76f4\u63a5\u5185\u5b58\u521b\u5efa Buffer \u5bf9\u8c61\uff1a",(0,r.jsx)(e.code,{children:"static XxxBuffer allocateDirect(int capacity)"})]}),"\n",(0,r.jsx)(e.p,{children:"DirectByteBuffer \u6e90\u7801\u5206\u6790\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"DirectByteBuffer(int cap) { \n    //....\n    long base = 0;\n    try {\n        // \u5206\u914d\u76f4\u63a5\u5185\u5b58\n        base = unsafe.allocateMemory(size);\n    }\n    // \u5185\u5b58\u8d4b\u503c\n    unsafe.setMemory(base, size, (byte) 0);\n    if (pa && (base % ps != 0)) {\n        address = base + ps - (base & (ps - 1));\n    } else {\n        address = base;\n    }\n    // \u521b\u5efa\u56de\u6536\u51fd\u6570\n    cleaner = Cleaner.create(this, new Deallocator(base, size, cap));\n}\nprivate static class Deallocator implements Runnable {\n    public void run() {\n        unsafe.freeMemory(address);\n\t\t//...\n    }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u5206\u914d\u548c\u56de\u6536\u539f\u7406"}),"\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u4e86 Unsafe \u5bf9\u8c61\u7684 allocateMemory \u65b9\u6cd5\u5b8c\u6210\u76f4\u63a5\u5185\u5b58\u7684\u5206\u914d\uff0csetMemory \u65b9\u6cd5\u5b8c\u6210\u8d4b\u503c"}),"\n",(0,r.jsx)(e.li,{children:"ByteBuffer \u7684\u5b9e\u73b0\u7c7b\u5185\u90e8\uff0c\u4f7f\u7528\u4e86 Cleaner\uff08\u865a\u5f15\u7528\uff09\u6765\u76d1\u6d4b ByteBuffer \u5bf9\u8c61\uff0c\u4e00\u65e6 ByteBuffer \u5bf9\u8c61\u88ab\u5783\u573e\u56de\u6536\uff0c\u90a3\u4e48 ReferenceHandler \u7ebf\u7a0b\u901a\u8fc7 Cleaner \u7684 clean \u65b9\u6cd5\u8c03\u7528 Deallocator \u7684 run\u65b9\u6cd5\uff0c\u6700\u540e\u901a\u8fc7 freeMemory \u6765\u91ca\u653e\u76f4\u63a5\u5185\u5b58"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'/**\n * \u76f4\u63a5\u5185\u5b58\u5206\u914d\u7684\u5e95\u5c42\u539f\u7406\uff1aUnsafe\n */\npublic class Demo1_27 {\n    static int _1Gb = 1024 * 1024 * 1024;\n\n    public static void main(String[] args) throws IOException {\n        Unsafe unsafe = getUnsafe();\n        // \u5206\u914d\u5185\u5b58\n        long base = unsafe.allocateMemory(_1Gb);\n        unsafe.setMemory(base, _1Gb, (byte) 0);\n        System.in.read();\n        // \u91ca\u653e\u5185\u5b58\n        unsafe.freeMemory(base);\n        System.in.read();\n    }\n\n    public static Unsafe getUnsafe() {\n        try {\n            Field f = Unsafe.class.getDeclaredField("theUnsafe");\n            f.setAccessible(true);\n            Unsafe unsafe = (Unsafe) f.get(null);\n            return unsafe;\n        } catch (NoSuchFieldException | IllegalAccessException e) {\n            throw new RuntimeException(e);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5171\u4eab\u5185\u5b58",children:"\u5171\u4eab\u5185\u5b58"}),"\n",(0,r.jsxs)(e.p,{children:["FileChannel \u63d0\u4f9b map \u65b9\u6cd5\u8fd4\u56de MappedByteBuffer \u5bf9\u8c61\uff0c\u628a\u6587\u4ef6\u6620\u5c04\u5230\u5185\u5b58\uff0c\u901a\u5e38\u60c5\u51b5\u53ef\u4ee5\u6620\u5c04\u6574\u4e2a\u6587\u4ef6\uff0c\u5982\u679c\u6587\u4ef6\u6bd4\u8f83\u5927\uff0c\u53ef\u4ee5\u8fdb\u884c\u5206\u6bb5\u6620\u5c04\uff0c\u5b8c\u6210\u6620\u5c04\u540e\u5bf9\u7269\u7406\u5185\u5b58\u7684\u64cd\u4f5c\u4f1a\u88ab",(0,r.jsx)(e.strong,{children:"\u540c\u6b65"}),"\u5230\u786c\u76d8\u4e0a"]}),"\n",(0,r.jsx)(e.p,{children:"FileChannel \u4e2d\u7684\u6210\u5458\u5c5e\u6027\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"MapMode.mode\uff1a\u5185\u5b58\u6620\u50cf\u6587\u4ef6\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u5171\u4e09\u79cd\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"MapMode.READ_ONLY"}),"\uff1a\u53ea\u8bfb\uff0c\u4fee\u6539\u5f97\u5230\u7684\u7f13\u51b2\u533a\u5c06\u5bfc\u81f4\u629b\u51fa\u5f02\u5e38"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"MapMode.READ_WRITE"}),"\uff1a\u8bfb/\u5199\uff0c\u5bf9\u7f13\u51b2\u533a\u7684\u66f4\u6539\u6700\u7ec8\u5c06\u5199\u5165\u6587\u4ef6\uff0c\u4f46\u6b64\u6b21\u4fee\u6539\u5bf9\u6620\u5c04\u5230\u540c\u4e00\u6587\u4ef6\u7684\u5176\u4ed6\u7a0b\u5e8f\u4e0d\u4e00\u5b9a\u662f\u53ef\u89c1"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"MapMode.PRIVATE"}),"\uff1a\u79c1\u7528\uff0c\u53ef\u8bfb\u53ef\u5199\uff0c\u4f46\u662f\u4fee\u6539\u7684\u5185\u5bb9\u4e0d\u4f1a\u5199\u5165\u6587\u4ef6\uff0c\u53ea\u662f buffer \u81ea\u8eab\u7684\u6539\u53d8"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"public final FileLock lock()"}),"\uff1a\u83b7\u53d6\u6b64\u6587\u4ef6\u901a\u9053\u7684\u6392\u4ed6\u9501"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["MappedByteBuffer\uff0c\u53ef\u4ee5\u8ba9\u6587\u4ef6\u5728\u76f4\u63a5\u5185\u5b58\uff08\u5806\u5916\u5185\u5b58\uff09\u4e2d\u8fdb\u884c\u4fee\u6539\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53eb\u505a",(0,r.jsx)(e.strong,{children:"\u5185\u5b58\u6620\u5c04"}),"\uff0c\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u7cfb\u7edf\u5e95\u5c42\u7684\u7f13\u5b58\uff0c\u6ca1\u6709 JVM \u548c OS \u4e4b\u95f4\u7684\u590d\u5236\u64cd\u4f5c\uff0c\u63d0\u9ad8\u4e86\u4f20\u8f93\u6548\u7387\uff0c\u4f5c\u7528\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u53ef\u4ee5\u7528\u4e8e\u8fdb\u7a0b\u95f4\u7684\u901a\u4fe1\uff0c\u80fd\u8fbe\u5230\u5171\u4eab\u5185\u5b58\u9875\u7684\u4f5c\u7528"}),"\uff0c\u4f46\u5728\u9ad8\u5e76\u53d1\u4e0b\u8981\u5bf9\u6587\u4ef6\u5185\u5b58\u8fdb\u884c\u52a0\u9501\uff0c\u9632\u6b62\u51fa\u73b0\u8bfb\u5199\u5185\u5bb9\u6df7\u4e71\u548c\u4e0d\u4e00\u81f4\u6027\uff0cJava \u63d0\u4f9b\u4e86\u6587\u4ef6\u9501 FileLock\uff0c\u4f46\u5728\u7236/\u5b50\u8fdb\u7a0b\u4e2d\u9501\u5b9a\u540e\u53e6\u4e00\u8fdb\u7a0b\u4f1a\u4e00\u76f4\u7b49\u5f85\uff0c\u6548\u7387\u4e0d\u9ad8"]}),"\n",(0,r.jsxs)(e.li,{children:["\u8bfb\u5199\u90a3\u4e9b\u592a\u5927\u800c\u4e0d\u80fd\u653e\u8fdb\u5185\u5b58\u4e2d\u7684\u6587\u4ef6\uff0c",(0,r.jsx)(e.strong,{children:"\u5206\u6bb5\u6620\u5c04"})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"MappedByteBuffer \u8f83\u4e4b ByteBuffer \u65b0\u589e\u7684\u4e09\u4e2a\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"final MappedByteBuffer force()"}),"\uff1a\u7f13\u51b2\u533a\u662f READ_WRITE \u6a21\u5f0f\u4e0b\uff0c\u5bf9\u7f13\u51b2\u533a\u5185\u5bb9\u7684\u4fee\u6539",(0,r.jsx)(e.strong,{children:"\u5f3a\u5236\u5199\u5165\u6587\u4ef6"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"final MappedByteBuffer load()"}),"\uff1a\u5c06\u7f13\u51b2\u533a\u7684\u5185\u5bb9\u8f7d\u5165\u7269\u7406\u5185\u5b58\uff0c\u5e76\u8fd4\u56de\u8be5\u7f13\u51b2\u533a\u7684\u5f15\u7528"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"final boolean isLoaded()"}),"\uff1a\u5982\u679c\u7f13\u51b2\u533a\u7684\u5185\u5bb9\u5728\u7269\u7406\u5185\u5b58\u4e2d\uff0c\u5219\u8fd4\u56de\u771f\uff0c\u5426\u5219\u8fd4\u56de\u5047"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class MappedByteBufferTest {\n    public static void main(String[] args) throws Exception {\n        // \u8bfb\u5199\u6a21\u5f0f\n        RandomAccessFile ra = new RandomAccessFile(\"1.txt\", \"rw\");\n        // \u83b7\u53d6\u5bf9\u5e94\u7684\u901a\u9053\n        FileChannel channel = ra.getChannel();\n\n        /**\n         * \u53c2\u65701\tFileChannel.MapMode.READ_WRITE \u4f7f\u7528\u7684\u8bfb\u5199\u6a21\u5f0f\n         * \u53c2\u65702\t0: \u6587\u4ef6\u6620\u5c04\u65f6\u7684\u8d77\u59cb\u4f4d\u7f6e\n         * \u53c2\u65703\t5: \u662f\u6620\u5c04\u5230\u5185\u5b58\u7684\u5927\u5c0f\uff08\u4e0d\u662f\u7d22\u5f15\u4f4d\u7f6e\uff09\uff0c\u5373\u5c06 1.txt \u7684\u591a\u5c11\u4e2a\u5b57\u8282\u6620\u5c04\u5230\u5185\u5b58\n         * \u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u7684\u8303\u56f4\u5c31\u662f 0-5\n         * \u5b9e\u9645\u7c7b\u578b DirectByteBuffer\n         */\n        MappedByteBuffer buffer = channel.map(FileChannel.MapMode.READ_WRITE, 0, 5);\n\n        buffer.put(0, (byte) 'H');\n        buffer.put(3, (byte) '9');\n        buffer.put(5, (byte) 'Y');\t//IndexOutOfBoundsException\n\n        ra.close();\n        System.out.println(\"\u4fee\u6539\u6210\u529f~~\");\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u4ece\u786c\u76d8\u4e0a\u5c06\u6587\u4ef6\u8bfb\u5165\u5185\u5b58\uff0c\u8981\u7ecf\u8fc7\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u6570\u636e\u62f7\u8d1d\uff0c\u62f7\u8d1d\u64cd\u4f5c\u662f\u7531\u6587\u4ef6\u7cfb\u7edf\u548c\u786c\u4ef6\u9a71\u52a8\u5b9e\u73b0\u3002\u901a\u8fc7\u5185\u5b58\u6620\u5c04\u7684\u65b9\u6cd5\u8bbf\u95ee\u786c\u76d8\u4e0a\u7684\u6587\u4ef6\uff0c\u62f7\u8d1d\u6570\u636e\u7684\u6548\u7387\u8981\u6bd4 read \u548c write \u7cfb\u7edf\u8c03\u7528\u9ad8\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"read() \u662f\u7cfb\u7edf\u8c03\u7528\uff0c\u9996\u5148\u5c06\u6587\u4ef6\u4ece\u786c\u76d8\u62f7\u8d1d\u5230\u5185\u6838\u7a7a\u95f4\u7684\u4e00\u4e2a\u7f13\u51b2\u533a\uff0c\u518d\u5c06\u8fd9\u4e9b\u6570\u636e\u62f7\u8d1d\u5230\u7528\u6237\u7a7a\u95f4\uff0c\u5b9e\u9645\u4e0a\u8fdb\u884c\u4e86\u4e24\u6b21\u6570\u636e\u62f7\u8d1d"}),"\n",(0,r.jsx)(e.li,{children:"mmap() \u4e5f\u662f\u7cfb\u7edf\u8c03\u7528\uff0c\u4f46\u6ca1\u6709\u8fdb\u884c\u6570\u636e\u62f7\u8d1d\uff0c\u5f53\u7f3a\u9875\u4e2d\u65ad\u53d1\u751f\u65f6\uff0c\u76f4\u63a5\u5c06\u6587\u4ef6\u4ece\u786c\u76d8\u62f7\u8d1d\u5230\u5171\u4eab\u5185\u5b58\uff0c\u53ea\u8fdb\u884c\u4e86\u4e00\u6b21\u6570\u636e\u62f7\u8d1d"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1ammap \u7684\u6587\u4ef6\u6620\u5c04\uff0c\u5728 Full GC \u65f6\u624d\u4f1a\u8fdb\u884c\u91ca\u653e\uff0c\u5982\u679c\u9700\u8981\u624b\u52a8\u6e05\u9664\u5185\u5b58\u6620\u5c04\u6587\u4ef6\uff0c\u53ef\u4ee5\u53cd\u5c04\u8c03\u7528 sun.misc.Cleaner \u65b9\u6cd5"}),"\n",(0,r.jsxs)(e.p,{children:["\u53c2\u8003\u6587\u7ae0\uff1a",(0,r.jsx)(e.a,{href:"https://www.jianshu.com/p/f90866dcbffc",children:"https://www.jianshu.com/p/f90866dcbffc"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u901a\u9053",children:"\u901a\u9053"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-7",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsxs)(e.p,{children:["\u901a\u9053\uff08Channel\uff09\uff1a\u8868\u793a IO \u6e90\u4e0e\u76ee\u6807\u6253\u5f00\u7684\u8fde\u63a5\uff0cChannel \u7c7b\u4f3c\u4e8e\u4f20\u7edf\u7684\u6d41\uff0c\u53ea\u4e0d\u8fc7 Channel \u672c\u8eab\u4e0d\u80fd\u76f4\u63a5\u8bbf\u95ee\u6570\u636e\uff0cChannel \u53ea\u80fd\u4e0e Buffer ",(0,r.jsx)(e.strong,{children:"\u8fdb\u884c\u4ea4\u4e92"})]}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"NIO \u7684\u901a\u9053\u7c7b\u4f3c\u4e8e\u6d41\uff0c\u4f46\u6709\u4e9b\u533a\u522b\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u901a\u9053\u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\u8bfb\u5199\uff0c\u800c\u6d41\u53ea\u80fd\u8bfb\u6216\u8005\u53ea\u80fd\u5199"}),"\n",(0,r.jsx)(e.li,{children:"\u901a\u9053\u53ef\u4ee5\u5b9e\u73b0\u5f02\u6b65\u8bfb\u5199\u6570\u636e"}),"\n",(0,r.jsx)(e.li,{children:"\u901a\u9053\u53ef\u4ee5\u4ece\u7f13\u51b2\u8bfb\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u5199\u6570\u636e\u5230\u7f13\u51b2"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"BIO \u4e2d\u7684 Stream \u662f\u5355\u5411\u7684\uff0cNIO \u4e2d\u7684 Channel \u662f\u53cc\u5411\u7684\uff0c\u53ef\u4ee5\u8bfb\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u5199\u64cd\u4f5c"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Channel \u5728 NIO \u4e2d\u662f\u4e00\u4e2a\u63a5\u53e3\uff1a",(0,r.jsx)(e.code,{children:"public interface Channel extends Closeable{}"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Channel \u5b9e\u73b0\u7c7b\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["FileChannel\uff1a\u7528\u4e8e\u8bfb\u53d6\u3001\u5199\u5165\u3001\u6620\u5c04\u548c\u64cd\u4f5c\u6587\u4ef6\u7684\u901a\u9053\uff0c",(0,r.jsx)(e.strong,{children:"\u53ea\u80fd\u5de5\u4f5c\u5728\u963b\u585e\u6a21\u5f0f\u4e0b"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u901a\u8fc7 FileInputStream \u83b7\u53d6\u7684 Channel \u53ea\u80fd\u8bfb"}),"\n",(0,r.jsx)(e.li,{children:"\u901a\u8fc7 FileOutputStream \u83b7\u53d6\u7684 Channel \u53ea\u80fd\u5199"}),"\n",(0,r.jsx)(e.li,{children:"\u901a\u8fc7 RandomAccessFile \u662f\u5426\u80fd\u8bfb\u5199\u6839\u636e\u6784\u9020 RandomAccessFile \u65f6\u7684\u8bfb\u5199\u6a21\u5f0f\u51b3\u5b9a"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"DatagramChannel\uff1a\u901a\u8fc7 UDP \u8bfb\u5199\u7f51\u7edc\u4e2d\u7684\u6570\u636e\u901a\u9053"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"SocketChannel\uff1a\u901a\u8fc7 TCP \u8bfb\u5199\u7f51\u7edc\u4e2d\u7684\u6570\u636e"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["ServerSocketChannel\uff1a\u53ef\u4ee5",(0,r.jsx)(e.strong,{children:"\u76d1\u542c"}),"\u65b0\u8fdb\u6765\u7684 TCP \u8fde\u63a5\uff0c\u5bf9\u6bcf\u4e00\u4e2a\u65b0\u8fdb\u6765\u7684\u8fde\u63a5\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a SocketChannel"]}),"\n",(0,r.jsx)(e.p,{children:"\u63d0\u793a\uff1aServerSocketChanne \u7c7b\u4f3c ServerSocket\u3001SocketChannel \u7c7b\u4f3c Socket"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5e38\u7528api-2",children:"\u5e38\u7528API"}),"\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6 Channel \u65b9\u5f0f\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u5bf9\u652f\u6301\u901a\u9053\u7684\u5bf9\u8c61\u8c03\u7528 ",(0,r.jsx)(e.code,{children:"getChannel()"})," \u65b9\u6cd5"]}),"\n",(0,r.jsxs)(e.li,{children:["\u901a\u8fc7\u901a\u9053\u7684\u9759\u6001\u65b9\u6cd5 ",(0,r.jsx)(e.code,{children:"open()"})," \u6253\u5f00\u5e76\u8fd4\u56de\u6307\u5b9a\u901a\u9053"]}),"\n",(0,r.jsxs)(e.li,{children:["\u4f7f\u7528 Files \u7c7b\u7684\u9759\u6001\u65b9\u6cd5 ",(0,r.jsx)(e.code,{children:"newByteChannel()"})," \u83b7\u53d6\u5b57\u8282\u901a\u9053"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["Channel \u57fa\u672c\u64cd\u4f5c\uff1a",(0,r.jsx)(e.strong,{children:"\u8bfb\u5199\u90fd\u662f\u76f8\u5bf9\u4e8e\u5185\u5b58\u6765\u770b\uff0c\u4e5f\u5c31\u662f\u7f13\u51b2\u533a"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract int read(ByteBuffer dst)"}),(0,r.jsx)(e.td,{children:"\u4ece Channel \u4e2d\u8bfb\u53d6\u6570\u636e\u5230 ByteBuffer\uff0c\u4ece position \u5f00\u59cb\u50a8\u5b58"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final long read(ByteBuffer[] dsts)"}),(0,r.jsx)(e.td,{children:"\u5c06 Channel \u4e2d\u7684\u6570\u636e\u5206\u6563\u5230 ByteBuffer[]"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract int write(ByteBuffer src)"}),(0,r.jsx)(e.td,{children:"\u5c06 ByteBuffer \u4e2d\u7684\u6570\u636e\u5199\u5165 Channel\uff0c\u4ece position \u5f00\u59cb\u5199\u51fa"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final long write(ByteBuffer[] srcs)"}),(0,r.jsx)(e.td,{children:"\u5c06 ByteBuffer[] \u5230\u4e2d\u7684\u6570\u636e\u805a\u96c6\u5230 Channel"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract long position()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u6b64\u901a\u9053\u7684\u6587\u4ef6\u4f4d\u7f6e"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"FileChannel position(long newPosition)"}),(0,r.jsx)(e.td,{children:"\u8bbe\u7f6e\u6b64\u901a\u9053\u7684\u6587\u4ef6\u4f4d\u7f6e"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract long size()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u6b64\u901a\u9053\u7684\u6587\u4ef6\u7684\u5f53\u524d\u5927\u5c0f"})]})]})]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"SelectableChannel \u7684\u64cd\u4f5c API"}),"\uff1a"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"SocketChannel accept()"}),(0,r.jsxs)(e.td,{children:["\u5982\u679c\u901a\u9053\u5904\u4e8e\u975e\u963b\u585e\u6a21\u5f0f\uff0c\u6ca1\u6709\u8bf7\u6c42\u8fde\u63a5\u65f6\u6b64\u65b9\u6cd5\u5c06\u7acb\u5373\u8fd4\u56de NULL\uff0c\u5426\u5219\u5c06\u963b\u585e\u76f4\u5230\u6709\u65b0\u7684\u8fde\u63a5\u6216\u53d1\u751f I/O \u9519\u8bef\uff0c",(0,r.jsx)(e.strong,{children:"\u901a\u8fc7\u8be5\u65b9\u6cd5\u8fd4\u56de\u7684\u5957\u63a5\u5b57\u901a\u9053\u5c06\u5904\u4e8e\u963b\u585e\u6a21\u5f0f"})]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"SelectionKey register(Selector sel, int ops)"}),(0,r.jsx)(e.td,{children:"\u5c06\u901a\u9053\u6ce8\u518c\u5230\u9009\u62e9\u5668\u4e0a\uff0c\u5e76\u6307\u5b9a\u76d1\u542c\u4e8b\u4ef6"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"SelectionKey register(Selector sel, int ops, Object att)"}),(0,r.jsxs)(e.td,{children:["\u5c06\u901a\u9053\u6ce8\u518c\u5230\u9009\u62e9\u5668\u4e0a\uff0c\u5e76\u5728\u5f53\u524d\u901a\u9053",(0,r.jsx)(e.strong,{children:"\u7ed1\u5b9a\u4e00\u4e2a\u9644\u4ef6\u5bf9\u8c61"}),"\uff0cObject \u4ee3\u8868\u53ef\u4ee5\u662f\u4efb\u4f55\u7c7b\u578b"]})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6587\u4ef6\u8bfb\u5199",children:"\u6587\u4ef6\u8bfb\u5199"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ChannelTest {\n    @Test\n\tpublic void write() throws Exception{\n \t\t// 1\u3001\u5b57\u8282\u8f93\u51fa\u6d41\u901a\u5411\u76ee\u6807\u6587\u4ef6\n        FileOutputStream fos = new FileOutputStream("data01.txt");\n        // 2\u3001\u5f97\u5230\u5b57\u8282\u8f93\u51fa\u6d41\u5bf9\u5e94\u7684\u901a\u9053  \u3010FileChannel\u3011\n        FileChannel channel = fos.getChannel();\n        // 3\u3001\u5206\u914d\u7f13\u51b2\u533a\n        ByteBuffer buffer = ByteBuffer.allocate(1024);\n        buffer.put("hello,\u9ed1\u9a6cJava\u7a0b\u5e8f\u5458\uff01".getBytes());\n        // 4\u3001\u628a\u7f13\u51b2\u533a\u5207\u6362\u6210\u5199\u51fa\u6a21\u5f0f\n        buffer.flip();\n        channel.write(buffer);\n        channel.close();\n        System.out.println("\u5199\u6570\u636e\u5230\u6587\u4ef6\u4e2d\uff01");\n    }\n    @Test\n    public void read() throws Exception {\n        // 1\u3001\u5b9a\u4e49\u4e00\u4e2a\u6587\u4ef6\u5b57\u8282\u8f93\u5165\u6d41\u4e0e\u6e90\u6587\u4ef6\u63a5\u901a\n        FileInputStream fis = new FileInputStream("data01.txt");\n        // 2\u3001\u9700\u8981\u5f97\u5230\u6587\u4ef6\u5b57\u8282\u8f93\u5165\u6d41\u7684\u6587\u4ef6\u901a\u9053\n        FileChannel channel = fis.getChannel();\n        // 3\u3001\u5b9a\u4e49\u4e00\u4e2a\u7f13\u51b2\u533a\n        ByteBuffer buffer = ByteBuffer.allocate(1024);\n        // 4\u3001\u8bfb\u53d6\u6570\u636e\u5230\u7f13\u51b2\u533a\n        channel.read(buffer);\n        buffer.flip();\n        // 5\u3001\u8bfb\u53d6\u51fa\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\u5e76\u8f93\u51fa\u5373\u53ef\n        String rs = new String(buffer.array(),0,buffer.remaining());\n        System.out.println(rs);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u6587\u4ef6\u590d\u5236",children:"\u6587\u4ef6\u590d\u5236"}),"\n",(0,r.jsxs)(e.p,{children:["Channel \u7684\u65b9\u6cd5\uff1a",(0,r.jsx)(e.strong,{children:"sendfile \u5b9e\u73b0\u96f6\u62f7\u8d1d"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"abstract long transferFrom(ReadableByteChannel src, long position, long count)"}),"\uff1a\u4ece\u7ed9\u5b9a\u7684\u53ef\u8bfb\u5b57\u8282\u901a\u9053\u5c06\u5b57\u8282\u4f20\u8f93\u5230\u8be5\u901a\u9053\u7684\u6587\u4ef6\u4e2d"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"src\uff1a\u6e90\u901a\u9053"}),"\n",(0,r.jsx)(e.li,{children:"position\uff1a\u6587\u4ef6\u4e2d\u8981\u8fdb\u884c\u4f20\u8f93\u7684\u4f4d\u7f6e\uff0c\u5fc5\u987b\u662f\u975e\u8d1f\u7684"}),"\n",(0,r.jsx)(e.li,{children:"count\uff1a\u8981\u4f20\u8f93\u7684\u6700\u5927\u5b57\u8282\u6570\uff0c\u5fc5\u987b\u662f\u975e\u8d1f\u7684"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"abstract long transferTo(long position, long count, WritableByteChannel target)"}),"\uff1a\u5c06\u8be5\u901a\u9053\u6587\u4ef6\u7684\u5b57\u8282\u4f20\u8f93\u5230\u7ed9\u5b9a\u7684\u53ef\u5199\u5b57\u8282\u901a\u9053\u3002"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"position\uff1a\u4f20\u8f93\u5f00\u59cb\u7684\u6587\u4ef6\u4e2d\u7684\u4f4d\u7f6e; \u5fc5\u987b\u662f\u975e\u8d1f\u7684"}),"\n",(0,r.jsx)(e.li,{children:"count\uff1a\u8981\u4f20\u8f93\u7684\u6700\u5927\u5b57\u8282\u6570; \u5fc5\u987b\u662f\u975e\u8d1f\u7684"}),"\n",(0,r.jsx)(e.li,{children:"target\uff1a\u76ee\u6807\u901a\u9053"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u6587\u4ef6\u590d\u5236\u7684\u4e24\u79cd\u65b9\u5f0f\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Buffer"}),"\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528\u4e0a\u8ff0\u4e24\u79cd\u65b9\u6cd5"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(79937).A+"",width:"1930",height:"277"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ChannelTest {\n    @Test\n    public void copy1() throws Exception {\n        File srcFile = new File("C:\\\\\u58c1\u7eb8.jpg");\n        File destFile = new File("C:\\\\Users\\\\\u58c1\u7eb8new.jpg");\n        // \u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u5b57\u8282\u8f93\u5165\u6d41\n        FileInputStream fis = new FileInputStream(srcFile);\n        // \u5f97\u5230\u4e00\u4e2a\u5b57\u8282\u8f93\u51fa\u6d41\n        FileOutputStream fos = new FileOutputStream(destFile);\n        // \u5f97\u5230\u7684\u662f\u6587\u4ef6\u901a\u9053\n        FileChannel isChannel = fis.getChannel();\n        FileChannel osChannel = fos.getChannel();\n        // \u5206\u914d\u7f13\u51b2\u533a\n        ByteBuffer buffer = ByteBuffer.allocate(1024);\n        while(true){\n            // \u5fc5\u987b\u5148\u6e05\u7a7a\u7f13\u51b2\u7136\u540e\u518d\u5199\u5165\u6570\u636e\u5230\u7f13\u51b2\u533a\n            buffer.clear();\n            // \u5f00\u59cb\u8bfb\u53d6\u4e00\u6b21\u6570\u636e\n            int flag = isChannel.read(buffer);\n            if(flag == -1){\n                break;\n            }\n            // \u5df2\u7ecf\u8bfb\u53d6\u4e86\u6570\u636e \uff0c\u628a\u7f13\u51b2\u533a\u7684\u6a21\u5f0f\u5207\u6362\u6210\u53ef\u8bfb\u6a21\u5f0f\n            buffer.flip();\n            // \u628a\u6570\u636e\u5199\u51fa\u5230\n            osChannel.write(buffer);\n        }\n        isChannel.close();\n        osChannel.close();\n        System.out.println("\u590d\u5236\u5b8c\u6210\uff01");\n    }\n    \n\t@Test\n\tpublic void copy02() throws Exception {\n    \t// 1\u3001\u5b57\u8282\u8f93\u5165\u7ba1\u9053\n   \t \tFileInputStream fis = new FileInputStream("data01.txt");\n   \t \tFileChannel isChannel = fis.getChannel();\n    \t// 2\u3001\u5b57\u8282\u8f93\u51fa\u6d41\u7ba1\u9053\n    \tFileOutputStream fos = new FileOutputStream("data03.txt");\n    \tFileChannel osChannel = fos.getChannel();\n    \t// 3\u3001\u590d\u5236\n    \tosChannel.transferFrom(isChannel,isChannel.position(),isChannel.size());\n    \tisChannel.close();\n    \tosChannel.close();\n\t}\n    \n\t@Test\n\tpublic void copy03() throws Exception {\n    \t// 1\u3001\u5b57\u8282\u8f93\u5165\u7ba1\u9053\n    \tFileInputStream fis = new FileInputStream("data01.txt");\n    \tFileChannel isChannel = fis.getChannel();\n    \t// 2\u3001\u5b57\u8282\u8f93\u51fa\u6d41\u7ba1\u9053\n    \tFileOutputStream fos = new FileOutputStream("data04.txt");\n    \tFileChannel osChannel = fos.getChannel();\n    \t// 3\u3001\u590d\u5236\n    \tisChannel.transferTo(isChannel.position() , isChannel.size() , osChannel);\n    \tisChannel.close();\n    \tosChannel.close();\n\t}\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5206\u6563\u805a\u96c6",children:"\u5206\u6563\u805a\u96c6"}),"\n",(0,r.jsx)(e.p,{children:"\u5206\u6563\u8bfb\u53d6\uff08Scatter \uff09\uff1a\u662f\u6307\u628a Channel \u901a\u9053\u7684\u6570\u636e\u8bfb\u5165\u5230\u591a\u4e2a\u7f13\u51b2\u533a\u4e2d\u53bb"}),"\n",(0,r.jsx)(e.p,{children:"\u805a\u96c6\u5199\u5165\uff08Gathering \uff09\uff1a\u662f\u6307\u5c06\u591a\u4e2a Buffer \u4e2d\u7684\u6570\u636e\u805a\u96c6\u5230 Channel"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class ChannelTest {\n    @Test\n    public void test() throws IOException{\n    \t// 1\u3001\u5b57\u8282\u8f93\u5165\u7ba1\u9053\n        FileInputStream is = new FileInputStream("data01.txt");\n        FileChannel isChannel = is.getChannel();\n        // 2\u3001\u5b57\u8282\u8f93\u51fa\u6d41\u7ba1\u9053\n        FileOutputStream fos = new FileOutputStream("data02.txt");\n        FileChannel osChannel = fos.getChannel();\n        // 3\u3001\u5b9a\u4e49\u591a\u4e2a\u7f13\u51b2\u533a\u505a\u6570\u636e\u5206\u6563\n        ByteBuffer buffer1 = ByteBuffer.allocate(4);\n        ByteBuffer buffer2 = ByteBuffer.allocate(1024);\n        ByteBuffer[] buffers = {buffer1 , buffer2};\n        // 4\u3001\u4ece\u901a\u9053\u4e2d\u8bfb\u53d6\u6570\u636e\u5206\u6563\u5230\u5404\u4e2a\u7f13\u51b2\u533a\n        isChannel.read(buffers);\n        // 5\u3001\u4ece\u6bcf\u4e2a\u7f13\u51b2\u533a\u4e2d\u67e5\u8be2\u662f\u5426\u6709\u6570\u636e\u8bfb\u53d6\u5230\u4e86\n        for(ByteBuffer buffer : buffers){\n            buffer.flip();// \u5207\u6362\u5230\u8bfb\u6570\u636e\u6a21\u5f0f\n            System.out.println(new String(buffer.array() , 0 , buffer.remaining()));\n        }\n        // 6\u3001\u805a\u96c6\u5199\u5165\u5230\u901a\u9053\n        osChannel.write(buffers);\n        isChannel.close();\n        osChannel.close();\n        System.out.println("\u6587\u4ef6\u590d\u5236~~");\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"\u9009\u62e9\u5668",children:"\u9009\u62e9\u5668"}),"\n",(0,r.jsx)(e.h4,{id:"\u57fa\u672c\u4ecb\u7ecd-8",children:"\u57fa\u672c\u4ecb\u7ecd"}),"\n",(0,r.jsxs)(e.p,{children:["\u9009\u62e9\u5668\uff08Selector\uff09 \u662f SelectableChannle \u5bf9\u8c61\u7684",(0,r.jsx)(e.strong,{children:"\u591a\u8def\u590d\u7528\u5668"}),"\uff0cSelector \u53ef\u4ee5\u540c\u65f6\u76d1\u63a7\u591a\u4e2a\u901a\u9053\u7684\u72b6\u51b5\uff0c\u5229\u7528 Selector \u53ef\u4f7f\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u7ba1\u7406\u591a\u4e2a Channel\uff0c",(0,r.jsx)(e.strong,{children:"Selector \u662f\u975e\u963b\u585e IO \u7684\u6838\u5fc3"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:l(14612).A+"",width:"722",height:"293"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Selector \u80fd\u591f\u68c0\u6d4b\u591a\u4e2a\u6ce8\u518c\u7684\u901a\u9053\u4e0a\u662f\u5426\u6709\u4e8b\u4ef6\u53d1\u751f\uff08\u591a\u4e2a Channel \u4ee5\u4e8b\u4ef6\u7684\u65b9\u5f0f\u53ef\u4ee5\u6ce8\u518c\u5230\u540c\u4e00\u4e2a Selector)\uff0c\u5982\u679c\u6709\u4e8b\u4ef6\u53d1\u751f\uff0c\u5c31\u83b7\u53d6\u4e8b\u4ef6\u7136\u540e\u9488\u5bf9\u6bcf\u4e2a\u4e8b\u4ef6\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406\uff0c\u5c31\u53ef\u4ee5\u53ea\u7528\u4e00\u4e2a\u5355\u7ebf\u7a0b\u53bb\u7ba1\u7406\u591a\u4e2a\u901a\u9053\uff0c\u4e5f\u5c31\u662f\u7ba1\u7406\u591a\u4e2a\u8fde\u63a5\u548c\u8bf7\u6c42"}),"\n",(0,r.jsx)(e.li,{children:"\u53ea\u6709\u5728\u8fde\u63a5/\u901a\u9053\u771f\u6b63\u6709\u8bfb\u5199\u4e8b\u4ef6\u53d1\u751f\u65f6\uff0c\u624d\u4f1a\u8fdb\u884c\u8bfb\u5199\uff0c\u5c31\u5927\u5927\u5730\u51cf\u5c11\u4e86\u7cfb\u7edf\u5f00\u9500\uff0c\u5e76\u4e14\u4e0d\u5fc5\u4e3a\u6bcf\u4e2a\u8fde\u63a5\u90fd\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e0d\u7528\u53bb\u7ef4\u62a4\u591a\u4e2a\u7ebf\u7a0b"}),"\n",(0,r.jsx)(e.li,{children:"\u907f\u514d\u4e86\u591a\u7ebf\u7a0b\u4e4b\u95f4\u7684\u4e0a\u4e0b\u6587\u5207\u6362\u5bfc\u81f4\u7684\u5f00\u9500"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u5e38\u7528api-3",children:"\u5e38\u7528API"}),"\n",(0,r.jsxs)(e.p,{children:["\u521b\u5efa Selector\uff1a",(0,r.jsx)(e.code,{children:"Selector selector = Selector.open();"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u5411\u9009\u62e9\u5668\u6ce8\u518c\u901a\u9053\uff1a",(0,r.jsx)(e.code,{children:"SelectableChannel.register(Selector sel, int ops, Object att)"})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53c2\u6570\u4e00\uff1a\u9009\u62e9\u5668\uff0c\u6307\u5b9a\u5f53\u524d Channel \u6ce8\u518c\u5230\u7684\u9009\u62e9\u5668"}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u6570\u4e8c\uff1a\u9009\u62e9\u5668\u5bf9\u901a\u9053\u7684\u76d1\u542c\u4e8b\u4ef6\uff0c\u76d1\u542c\u7684\u4e8b\u4ef6\u7c7b\u578b\u7528\u56db\u4e2a\u5e38\u91cf\u8868\u793a\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8bfb : SelectionKey.OP_READ \uff081\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u5199 : SelectionKey.OP_WRITE \uff084\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u8fde\u63a5 : SelectionKey.OP_CONNECT \uff088\uff09"}),"\n",(0,r.jsx)(e.li,{children:"\u63a5\u6536 : SelectionKey.OP_ACCEPT \uff0816\uff09"}),"\n",(0,r.jsxs)(e.li,{children:["\u82e5\u4e0d\u6b62\u76d1\u542c\u4e00\u4e2a\u4e8b\u4ef6\uff0c\u4f7f\u7528\u4f4d\u6216\u64cd\u4f5c\u7b26\u8fde\u63a5\uff1a",(0,r.jsx)(e.code,{children:"int interest = SelectionKey.OP_READ | SelectionKey.OP_WRITE"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u53c2\u6570\u4e09\uff1a\u53ef\u4ee5\u5173\u8054\u4e00\u4e2a\u9644\u4ef6\uff0c\u53ef\u4ee5\u662f\u4efb\u4f55\u5bf9\u8c61"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Selector API"}),"\uff1a"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public static Selector open()"}),(0,r.jsx)(e.td,{children:"\u6253\u5f00\u9009\u62e9\u5668"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract void close()"}),(0,r.jsx)(e.td,{children:"\u5173\u95ed\u6b64\u9009\u62e9\u5668"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract int select()"}),(0,r.jsxs)(e.td,{children:[(0,r.jsx)(e.strong,{children:"\u963b\u585e"}),"\u9009\u62e9\u4e00\u7ec4\u901a\u9053\u51c6\u5907\u597d\u8fdb\u884c I/O \u64cd\u4f5c\u7684\u952e"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract int select(long timeout)"}),(0,r.jsxs)(e.td,{children:[(0,r.jsx)(e.strong,{children:"\u963b\u585e"}),"\u7b49\u5f85 timeout \u6beb\u79d2"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract int selectNow()"}),(0,r.jsxs)(e.td,{children:["\u83b7\u53d6\u4e00\u4e0b\uff0c",(0,r.jsx)(e.strong,{children:"\u4e0d\u963b\u585e"}),"\uff0c\u7acb\u523b\u8fd4\u56de"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract Selector wakeup()"}),(0,r.jsx)(e.td,{children:"\u5524\u9192\u6b63\u5728\u963b\u585e\u7684 selector"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsxs)(e.td,{children:["public abstract Set",(0,r.jsx)(e.selectionkey,{children:" selectedKeys()"})]}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u6b64\u9009\u62e9\u5668\u7684\u9009\u62e9\u952e\u96c6"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:"SelectionKey API:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract void cancel()"}),(0,r.jsx)(e.td,{children:"\u53d6\u6d88\u8be5\u952e\u7684\u901a\u9053\u4e0e\u5176\u9009\u62e9\u5668\u7684\u6ce8\u518c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract SelectableChannel channel()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u521b\u5efa\u6b64\u952e\u7684\u901a\u9053\uff0c\u8be5\u65b9\u6cd5\u5728\u53d6\u6d88\u952e\u4e4b\u540e\u4ecd\u5c06\u8fd4\u56de\u901a\u9053"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final Object attachment()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u5f53\u524d key \u5173\u8054\u7684\u9644\u4ef6"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final boolean isAcceptable()"}),(0,r.jsx)(e.td,{children:"\u68c0\u6d4b\u6b64\u5bc6\u94a5\u7684\u901a\u9053\u662f\u5426\u5df2\u51c6\u5907\u597d\u63a5\u53d7\u65b0\u7684\u5957\u63a5\u5b57\u8fde\u63a5"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final boolean isConnectable()"}),(0,r.jsx)(e.td,{children:"\u68c0\u6d4b\u6b64\u5bc6\u94a5\u7684\u901a\u9053\u662f\u5426\u5df2\u5b8c\u6210\u6216\u672a\u5b8c\u6210\u5176\u5957\u63a5\u5b57\u8fde\u63a5\u64cd\u4f5c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final boolean isReadable()"}),(0,r.jsx)(e.td,{children:"\u68c0\u6d4b\u6b64\u5bc6\u94a5\u7684\u9891\u9053\u662f\u5426\u53ef\u4ee5\u9605\u8bfb"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final boolean isWritable()"}),(0,r.jsx)(e.td,{children:"\u68c0\u6d4b\u6b64\u5bc6\u94a5\u7684\u901a\u9053\u662f\u5426\u51c6\u5907\u597d\u8fdb\u884c\u5199\u5165"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:"\u57fa\u672c\u6b65\u9aa4\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"//1.\u83b7\u53d6\u901a\u9053\nServerSocketChannel ssChannel = ServerSocketChannel.open();\n//2.\u5207\u6362\u975e\u963b\u585e\u6a21\u5f0f\nssChannel.configureBlocking(false);\n//3.\u7ed1\u5b9a\u8fde\u63a5\nssChannel.bin(new InetSocketAddress(9999));\n//4.\u83b7\u53d6\u9009\u62e9\u5668\nSelector selector = Selector.open();\n//5.\u5c06\u901a\u9053\u6ce8\u518c\u5230\u9009\u62e9\u5668\u4e0a\uff0c\u5e76\u4e14\u6307\u5b9a\u201c\u76d1\u542c\u63a5\u6536\u4e8b\u4ef6\u201d\nssChannel.register(selector, SelectionKey.OP_ACCEPT);\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h3,{id:"nio\u5b9e\u73b0",children:"NIO\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.h4,{id:"\u5e38\u7528api-4",children:"\u5e38\u7528API"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"SelectableChannel_API"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final SelectableChannel configureBlocking(boolean block)"}),(0,r.jsx)(e.td,{children:"\u8bbe\u7f6e\u6b64\u901a\u9053\u7684\u963b\u585e\u6a21\u5f0f"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final SelectionKey register(Selector sel, int ops)"}),(0,r.jsx)(e.td,{children:"\u5411\u7ed9\u5b9a\u7684\u9009\u62e9\u5668\u6ce8\u518c\u6b64\u901a\u9053\uff0c\u5e76\u9009\u62e9\u5173\u6ce8\u7684\u7684\u4e8b\u4ef6"})]})]})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"SocketChannel_API\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{style:{textAlign:"left"},children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{style:{textAlign:"left"},children:"public static SocketChannel open()"}),(0,r.jsx)(e.td,{children:"\u6253\u5f00\u5957\u63a5\u5b57\u901a\u9053"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{style:{textAlign:"left"},children:"public static SocketChannel open(SocketAddress remote)"}),(0,r.jsx)(e.td,{children:"\u6253\u5f00\u5957\u63a5\u5b57\u901a\u9053\u5e76\u8fde\u63a5\u5230\u8fdc\u7a0b\u5730\u5740"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{style:{textAlign:"left"},children:"public abstract boolean connect(SocketAddress remote)"}),(0,r.jsx)(e.td,{children:"\u8fde\u63a5\u6b64\u901a\u9053\u7684\u5230\u8fdc\u7a0b\u5730\u5740"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{style:{textAlign:"left"},children:"public abstract SocketChannel bind(SocketAddress local)"}),(0,r.jsx)(e.td,{children:"\u5c06\u901a\u9053\u7684\u5957\u63a5\u5b57\u7ed1\u5b9a\u5230\u672c\u5730\u5730\u5740"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{style:{textAlign:"left"},children:"public abstract SocketAddress getLocalAddress()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u5957\u63a5\u5b57\u7ed1\u5b9a\u7684\u672c\u5730\u5957\u63a5\u5b57\u5730\u5740"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{style:{textAlign:"left"},children:"public abstract SocketAddress getRemoteAddress()"}),(0,r.jsx)(e.td,{children:"\u8fd4\u56de\u5957\u63a5\u5b57\u8fde\u63a5\u7684\u8fdc\u7a0b\u5957\u63a5\u5b57\u5730\u5740"})]})]})]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"ServerSocketChannel_API\uff1a"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public static ServerSocketChannel open()"}),(0,r.jsx)(e.td,{children:"\u6253\u5f00\u670d\u52a1\u5668\u5957\u63a5\u5b57\u901a\u9053"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public final ServerSocketChannel bind(SocketAddress local)"}),(0,r.jsx)(e.td,{children:"\u5c06\u901a\u9053\u7684\u5957\u63a5\u5b57\u7ed1\u5b9a\u5230\u672c\u5730\u5730\u5740\uff0c\u5e76\u914d\u7f6e\u5957\u63a5\u5b57\u4ee5\u76d1\u542c\u8fde\u63a5"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"public abstract SocketChannel accept()"}),(0,r.jsx)(e.td,{children:"\u63a5\u53d7\u4e0e\u6b64\u901a\u9053\u5957\u63a5\u5b57\u7684\u8fde\u63a5\uff0c\u901a\u8fc7\u6b64\u65b9\u6cd5\u8fd4\u56de\u7684\u5957\u63a5\u5b57\u901a\u9053\u5c06\u5904\u4e8e\u963b\u585e\u6a21\u5f0f"})]})]})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c ServerSocketChannel \u5904\u4e8e\u975e\u963b\u585e\u6a21\u5f0f\uff0c\u5982\u679c\u6ca1\u6709\u6302\u8d77\u8fde\u63a5\uff0c\u5219\u6b64\u65b9\u6cd5\u5c06\u7acb\u5373\u8fd4\u56de null"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u901a\u9053\u5904\u4e8e\u963b\u585e\u6a21\u5f0f\uff0c\u5982\u679c\u6ca1\u6709\u6302\u8d77\u8fde\u63a5\u5c06\u65e0\u9650\u671f\u5730\u963b\u585e\uff0c\u76f4\u5230\u6709\u65b0\u7684\u8fde\u63a5\u6216\u53d1\u751f I/O \u9519\u8bef"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h4,{id:"\u4ee3\u7801\u5b9e\u73b0",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.p,{children:"\u670d\u52a1\u7aef \uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["\u83b7\u53d6\u901a\u9053\uff0c\u5f53\u5ba2\u6237\u7aef\u8fde\u63a5\u670d\u52a1\u7aef\u65f6\uff0c\u670d\u52a1\u7aef\u4f1a\u901a\u8fc7 ",(0,r.jsx)(e.code,{children:"ServerSocketChannel.accept"})," \u5f97\u5230 SocketChannel"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5207\u6362\u975e\u963b\u585e\u6a21\u5f0f"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u7ed1\u5b9a\u8fde\u63a5"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u9009\u62e9\u5668"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5c06\u901a\u9053\u6ce8\u518c\u5230\u9009\u62e9\u5668\u4e0a\uff0c\u5e76\u4e14\u6307\u5b9a\u76d1\u542c\u63a5\u6536\u4e8b\u4ef6"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u8f6e\u8be2\u5f0f"}),"\u7684\u83b7\u53d6\u9009\u62e9\u5668\u4e0a\u5df2\u7ecf\u51c6\u5907\u5c31\u7eea\u7684\u4e8b\u4ef6"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5ba2\u6237\u7aef\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\u83b7\u53d6\u901a\u9053\uff1a",(0,r.jsx)(e.code,{children:"SocketChannel sc = SocketChannel.open(new InetSocketAddress(HOST, PORT))"})]}),"\n",(0,r.jsx)(e.li,{children:"\u5207\u6362\u975e\u963b\u585e\u6a21\u5f0f"}),"\n",(0,r.jsxs)(e.li,{children:["\u5206\u914d\u6307\u5b9a\u5927\u5c0f\u7684\u7f13\u51b2\u533a\uff1a",(0,r.jsx)(e.code,{children:"ByteBuffer buffer = ByteBuffer.allocate(1024)"})]}),"\n",(0,r.jsx)(e.li,{children:"\u53d1\u9001\u6570\u636e\u7ed9\u670d\u52a1\u7aef"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"37 \u884c\u4ee3\u7801\uff0c\u5982\u679c\u5224\u65ad\u6761\u4ef6\u6539\u4e3a !=-1\uff0c\u9700\u8981\u5ba2\u6237\u7aef close \u4e00\u4e0b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class Server {\n    public static void main(String[] args){\n        // 1\u3001\u83b7\u53d6\u901a\u9053\n        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n        // 2\u3001\u5207\u6362\u4e3a\u975e\u963b\u585e\u6a21\u5f0f\n        serverSocketChannel.configureBlocking(false);\n        // 3\u3001\u7ed1\u5b9a\u8fde\u63a5\u7684\u7aef\u53e3\n        serverSocketChannel.bind(new InetSocketAddress(9999));\n        // 4\u3001\u83b7\u53d6\u9009\u62e9\u5668Selector\n        Selector selector = Selector.open();\n        // 5\u3001\u5c06\u901a\u9053\u90fd\u6ce8\u518c\u5230\u9009\u62e9\u5668\u4e0a\u53bb\uff0c\u5e76\u4e14\u5f00\u59cb\u6307\u5b9a\u76d1\u542c\u63a5\u6536\u4e8b\u4ef6\n        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);\n\t\t// 6\u3001\u4f7f\u7528Selector\u9009\u62e9\u5668\u963b\u585e\u7b49\u5f85\u8f6e\u5df2\u7ecf\u5c31\u7eea\u597d\u7684\u4e8b\u4ef6\n        while (selector.select() > 0) {\n            System.out.println("----\u5f00\u59cb\u65b0\u4e00\u8f6e\u7684\u65f6\u95f4\u5904\u7406----");\n            // 7\u3001\u83b7\u53d6\u9009\u62e9\u5668\u4e2d\u7684\u6240\u6709\u6ce8\u518c\u7684\u901a\u9053\u4e2d\u5df2\u7ecf\u5c31\u7eea\u597d\u7684\u4e8b\u4ef6\n            Set<SelectionKey> selectionKeys = selector.selectedKeys();\n            Iterator<SelectionKey> it = selectionKeys.iterator();\n            // 8\u3001\u5f00\u59cb\u904d\u5386\u8fd9\u4e9b\u51c6\u5907\u597d\u7684\u4e8b\u4ef6\n            while (it.hasNext()) {\n                SelectionKey key = it.next();// \u63d0\u53d6\u5f53\u524d\u8fd9\u4e2a\u4e8b\u4ef6\n                // 9\u3001\u5224\u65ad\u8fd9\u4e2a\u4e8b\u4ef6\u5177\u4f53\u662f\u4ec0\u4e48\n                if (key.isAcceptable()) {\n                    // 10\u3001\u76f4\u63a5\u83b7\u53d6\u5f53\u524d\u63a5\u5165\u7684\u5ba2\u6237\u7aef\u901a\u9053\n                    SocketChannel socketChannel = serverSocketChannel.accept();\n                    // 11 \u3001\u5207\u6362\u6210\u975e\u963b\u585e\u6a21\u5f0f\n                    socketChannel.configureBlocking(false);\n                    /*\n                     ByteBuffer buffer = ByteBuffer.allocate(16);\n                \t // \u5c06\u4e00\u4e2a byteBuffer \u4f5c\u4e3a\u9644\u4ef6\u3010\u5173\u8054\u3011\u5230 selectionKey \u4e0a\n                \t SelectionKey scKey = sc.register(selector, 0, buffer);\n                    */\n                    // 12\u3001\u5c06\u672c\u5ba2\u6237\u7aef\u901a\u9053\u6ce8\u518c\u5230\u9009\u62e9\u5668\n                    socketChannel.register(selector, SelectionKey.OP_READ);\n                } else if (key.isReadable()) {\n                    // 13\u3001\u83b7\u53d6\u5f53\u524d\u9009\u62e9\u5668\u4e0a\u7684\u8bfb\u5c31\u7eea\u4e8b\u4ef6\n                    SelectableChannel channel = key.channel();\n                    SocketChannel socketChannel = (SocketChannel) channel;\n                    // 14\u3001\u8bfb\u53d6\u6570\u636e\n                    ByteBuffer buffer = ByteBuffer.allocate(1024);\n                    // \u83b7\u53d6\u5173\u8054\u7684\u9644\u4ef6\n                    // ByteBuffer buffer = (ByteBuffer) key.attachment();\n                    int len;\n                    while ((len = socketChannel.read(buffer)) > 0) {\n                        buffer.flip();\n                        System.out.println(socketChannel.getRemoteAddress() + ":" + new String(buffer.array(), 0, len));\n                        buffer.clear();// \u6e05\u9664\u4e4b\u524d\u7684\u6570\u636e\n                    }\n                }\n                // \u5220\u9664\u5f53\u524d\u7684 selectionKey\uff0c\u9632\u6b62\u91cd\u590d\u64cd\u4f5c\n                it.remove();\n            }\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class Client {\n    public static void main(String[] args) throws Exception {\n        // 1\u3001\u83b7\u53d6\u901a\u9053\n        SocketChannel socketChannel = SocketChannel.open(new InetSocketAddress("127.0.0.1", 9999));\n        // 2\u3001\u5207\u6362\u6210\u975e\u963b\u585e\u6a21\u5f0f\n        socketChannel.configureBlocking(false);\n        // 3\u3001\u5206\u914d\u6307\u5b9a\u7f13\u51b2\u533a\u5927\u5c0f\n        ByteBuffer buffer = ByteBuffer.allocate(1024);\n        // 4\u3001\u53d1\u9001\u6570\u636e\u7ed9\u670d\u52a1\u7aef\n        Scanner sc = new Scanner(System.in);\n        while (true){\n            System.out.print("\u8bf7\u8bf4\uff1a");\n            String msg = sc.nextLine();\n            buffer.put(("Client\uff1a" + msg).getBytes());\n            buffer.flip();\n            socketChannel.write(buffer);\n            buffer.clear();\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"aio",children:"AIO"}),"\n",(0,r.jsx)(e.p,{children:"Java AIO(NIO.2) \uff1a AsynchronousI/O\uff0c\u5f02\u6b65\u975e\u963b\u585e\uff0c\u91c7\u7528\u4e86 Proactor \u6a21\u5f0f\u3002\u670d\u52a1\u5668\u5b9e\u73b0\u6a21\u5f0f\u4e3a\u4e00\u4e2a\u6709\u6548\u8bf7\u6c42\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5ba2\u6237\u7aef\u7684 I/O \u8bf7\u6c42\u90fd\u662f\u7531 OS \u5148\u5b8c\u6210\u4e86\u518d\u901a\u77e5\u670d\u52a1\u5668\u5e94\u7528\u53bb\u542f\u52a8\u7ebf\u7a0b\u8fdb\u884c\u5904\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"AIO\u5f02\u6b65\u975e\u963b\u585e\uff0c\u57fa\u4e8eNIO\u7684\uff0c\u53ef\u4ee5\u79f0\u4e4b\u4e3aNIO2.0\n  BIO                     NIO                                AIO        \nSocket                SocketChannel                    AsynchronousSocketChannel\nServerSocket          ServerSocketChannel\t       AsynchronousServerSocketChannel\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5f53\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\u65f6\uff0c\u8c03\u7528 API \u7684 read \u6216 write \u65b9\u6cd5\uff0c\u8fd9\u4e24\u79cd\u65b9\u6cd5\u5747\u4e3a\u5f02\u6b65\u7684\uff0c\u5b8c\u6210\u540e\u4f1a\u4e3b\u52a8\u8c03\u7528\u56de\u8c03\u51fd\u6570\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5bf9\u4e8e\u8bfb\u64cd\u4f5c\uff0c\u5f53\u6709\u6d41\u53ef\u8bfb\u53d6\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5c06\u53ef\u8bfb\u7684\u6d41\u4f20\u5165 read \u65b9\u6cd5\u7684\u7f13\u51b2\u533a"}),"\n",(0,r.jsx)(e.li,{children:"\u5bf9\u4e8e\u5199\u64cd\u4f5c\uff0c\u5f53\u64cd\u4f5c\u7cfb\u7edf\u5c06 write \u65b9\u6cd5\u4f20\u9012\u7684\u6d41\u5199\u5165\u5b8c\u6bd5\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e3b\u52a8\u901a\u77e5\u5e94\u7528\u7a0b\u5e8f"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u5728 JDK1.7 \u4e2d\uff0c\u8fd9\u90e8\u5206\u5185\u5bb9\u88ab\u79f0\u4f5c NIO.2\uff0c\u4e3b\u8981\u5728 Java.nio.channels \u5305\u4e0b\u589e\u52a0\u4e86\u4e0b\u9762\u56db\u4e2a\u5f02\u6b65\u901a\u9053\uff1a\nAsynchronousSocketChannel\u3001AsynchronousServerSocketChannel\u3001AsynchronousFileChannel\u3001AsynchronousDatagramChannel"}),"\n",(0,r.jsx)(e.hr,{})]})}function o(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(h,{...n})}):h(n)}},43275:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/BIO\u5de5\u4f5c\u673a\u5236-604d6dac8e98e3b6c3ae5cecc280b158.png"},23190:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/ConcurrentHashMap\u6570\u636e\u7ed3\u6784-06454d9fbb9fe72a8affd432167471cc.png"},99486:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-BIO\u5de5\u4f5c\u6d41\u7a0b-2032d70055162d37b6ee357ca247edee.png"},65813:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-DMA-9acd07ac56f211194b032f3335bf96dc.png"},48321:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-mmap\u5de5\u4f5c\u6d41\u7a0b-3c2f711495c176e5e4b668d32174e550.png"},97440:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-select\u8c03\u7528\u8fc7\u7a0b-6ed8102b014eaeee88cd49edc91721d9.png"},6020:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-sendfile\u5de5\u4f5c\u6d41\u7a0b-0cc809350564fba79e85e44b086898d9.png"},30859:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-\u7528\u6237\u6001\u548c\u5185\u6838\u6001-c5ba17c0ce76f617ea967a5738dd3e31.png"},55328:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-\u7cfb\u7edf\u8c03\u7528\u7684\u8fc7\u7a0b-65215453000404a165f93cdef362e01b.jpg"},17608:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO-\u7f13\u51b2\u533a\u8bfb\u5199-2f28c028a27fca954806a39690e396c7.png"},41652:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO\u6a21\u578b-IO\u590d\u7528\u6a21\u578b-f5c1696797031bd049042159558124bb.png"},18588:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO\u6a21\u578b-\u4fe1\u53f7\u9a71\u52a8IO-6e1d6e35178fb217e868db5af8eea900.png"},15344:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO\u6a21\u578b-\u5f02\u6b65IO\u6a21\u578b-278235e8258c014fa48b6ca170296cc7.png"},34101:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO\u6a21\u578b-\u963b\u585e\u5f0fIO-c4f13e1c1ab38efb1e6474e627005410.png"},7819:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/IO\u6a21\u578b-\u975e\u963b\u585e\u5f0fIO-e9c399c96baff389439471154cfedecb.png"},2055:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JMM-CPU\u7f13\u5b58\u7ed3\u6784-0b300a9dd514f8478ac1861340211f64.png"},42018:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JMM-DCL\u51fa\u73b0\u7684\u95ee\u9898-c2606cf83d59d2ee1d259f8ce412d551.png"},37609:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JMM-volatile\u4e0d\u80fd\u4fdd\u8bc1\u539f\u5b50\u6027-1103a31a5ad291012667c0da71873b23.png"},2316:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JMM-volatile\u4fdd\u8bc1\u53ef\u89c1\u6027-5f3821e4d6852a52deeeaa584b57f7cc.png"},27500:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JMM-\u5185\u5b58\u4ea4\u4e92-990dadf9834807f87d574743f93ff9dc.png"},26595:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JMM-\u53ef\u89c1\u6027\u4f8b\u5b50-9f2bfcfffbb7a16da4f06e558525c037.png"},65265:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JMM\u5185\u5b58\u6a21\u578b-2083baa9fc97d568c3bf2b85d6b8c816.png"},70819:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-AQS\u539f\u7406\u56fe-efc34c20e60e66d8dcbac46b6b69265d.png"},25999:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-AQS\u961f\u5217\u8bbe\u8ba1-d0b92b4c73e6ff49e393dc2c29e46363.png"},56200:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentHashMap-LastRun\u673a\u5236-737e3df2da07d234137713a95cd1e924.png"},82688:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentLinkedQueue\u5165\u961f\u64cd\u4f5c1-1a037a3bd8a65d2929fb41da3af97da9.png"},61019:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentLinkedQueue\u5165\u961f\u64cd\u4f5c2-573b9654cbf5fc01dd8da8dd74966283.png"},29842:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentLinkedQueue\u5165\u961f\u64cd\u4f5c3-149610c7022bca4421ea2c3784a12f75.png"},99011:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentLinkedQueue\u51fa\u961f\u64cd\u4f5c1-863b471299877a69d1a574b175225841.png"},62152:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentLinkedQueue\u51fa\u961f\u64cd\u4f5c2-bfcd17649fae0ad7ab9e8b49da1d2916.png"},2097:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentLinkedQueue\u51fa\u961f\u64cd\u4f5c3-84598fdac50c808176583e2997c1f788.png"},60735:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentSkipListMap-Put\u6d41\u7a0b-a8e30a7848c12a6d6031e7a75d3a3eaf.png"},94862:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentSkipListMap-remove\u6d41\u7a0b-50ed1ca66e7a828d1400d272875d93c2.png"},6700:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ConcurrentSkipListMap\u6570\u636e\u7ed3\u6784-242d3d7bbeb7e1661666146a17b70dad.png"},8443:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-CopyOnWriteArrayList\u5f31\u4e00\u81f4\u6027-e855dded0f54e5201290e1644c0db99e.png"},90757:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-CyclicBarrier\u5de5\u4f5c\u539f\u7406-431f6f14eb341c3a230a4ed25c90405a.png"},55072:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-LinkedBlockingQueue\u5165\u961f\u6d41\u7a0b-65c34daee1cc668aebaa04bb4e374efa.png"},38180:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-LinkedBlockingQueue\u51fa\u961f\u6d41\u7a0b1-717ea3538a2991f769f62154486f5ddf.png"},92831:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-LinkedBlockingQueue\u51fa\u961f\u6d41\u7a0b2-5797787147f950bfaaa67a689b4b6ff4.png"},96740:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-Monitor-MarkWord\u7ed3\u678432\u4f4d-f1ce5afbf6ddde0e4e6466d5e970423a.png"},83835:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-Monitor-MarkWord\u7ed3\u678464\u4f4d-81cf712aa6f14db5355b96449340b392.png"},17156:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-Monitor\u5de5\u4f5c\u539f\u74061-04d97f1397db109212a756199373996e.png"},2431:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-Monitor\u5de5\u4f5c\u539f\u74062-67f5f9f4c081d0642793177d0400240b.png"},71009:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u6761\u4ef6\u53d8\u91cf1-1db9e31c778fce1871c3abf1ed3ae1a1.png"},29930:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u6761\u4ef6\u53d8\u91cf2-f72500e4c300b0179e99f3c8bb801ff4.png"},45491:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u6761\u4ef6\u53d8\u91cf3-ce468d92e1fb0531f1c17f3dcf4a937a.png"},12225:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u975e\u516c\u5e73\u95011-35c3ee58ed9bf873a52264915c990e62.png"},63242:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u975e\u516c\u5e73\u95012-09f2bd94ae1e9dadbc22290331a1c903.png"},2099:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u975e\u516c\u5e73\u95013-88434d5755670c1ed0758e2c55a14146.png"},18492:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u975e\u516c\u5e73\u95014-5eba076df3aa4e9108bfcc83faec8d0a.png"},47909:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantLock-\u975e\u516c\u5e73\u95015-c6644e4a686cf01e535ed6b971e2a20f.png"},83006:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantReadWriteLock\u52a0\u95011-b4d222351baa74aa2161e8a91f97d993.png"},50357:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantReadWriteLock\u52a0\u95012-6d1031a8546f9caf88c47deb5a7a8da7.png"},20452:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantReadWriteLock\u7f13\u5b58-a2c45842d19d5b4fae71d0c35bac023f.png"},93053:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantReadWriteLock\u89e3\u95011-1eed9a9aef099957f2e8a2722e2de17a.png"},95494:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ReentrantReadWriteLock\u89e3\u95012-93e9b4b287c989a9321fcf2f82c2b878.png"},78745:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-Semaphore\u5de5\u4f5c\u6d41\u7a0b1-58700c7b2a4aace84e058aa8f8aade1a.png"},30562:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-Semaphore\u5de5\u4f5c\u6d41\u7a0b2-f5277f671709e720427b803ae39a616d.png"},89086:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ThreadLocal\u5185\u5b58\u6cc4\u6f0f\u5f31\u5f15\u7528-8f4acb712ce6ce325bdf8b9384a0f664.png"},9525:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ThreadLocal\u5185\u5b58\u6cc4\u6f0f\u5f3a\u5f15\u7528-6e8b78b158a71b91f2bb6c7d39d9ac59.png"},5676:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ThreadLocal\u63a2\u6d4b\u5f0f\u6e05\u74061-36b8bc4df0bbe2c80553422ae020a6c4.png"},42087:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ThreadLocal\u63a2\u6d4b\u5f0f\u6e05\u74062-f969e7a065ec0d911452b41571e73be0.png"},34053:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ThreadLocal\u6570\u636e\u7ed3\u6784JDK8\u524d-54cdede3f8dbbbc835d89c6111d34b07.png"},85678:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-ThreadLocal\u6570\u636e\u7ed3\u6784JDK8\u540e-2a884ca053576188ab7732799ad25317.png"},3686:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-newSingleThreadExecutor-125d1ce6b1fa0cbe450934693f83045f.png"},65463:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-park\u539f\u74061-5a27d77ab348b3a3fcaca223c527272c.png"},64828:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-park\u539f\u74062-14d0068e6a1ed94de9d9ef506979cff1.png"},46202:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-replaceStaleEntry\u6d41\u7a0b-ca4bef06b8ad693656bfb689649091ea.png"},16086:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u4e24\u9636\u6bb5\u7ec8\u6b62\u6a21\u5f0f-b0b24e6c2fe419d2d014d19229482f0e.png"},21668:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u4f2a\u5171\u4eab1-e301dcaedca1272bd6dcb5bc04c139da.png"},58527:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u4f2a\u5171\u4eab2-f4fba7c705ef1479bf440fb784878e29.png"},74427:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u4fdd\u62a4\u6027\u6682\u505c-7e5880eb269c172737d331eda10a218b.png"},66633:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u4fdd\u62a4\u6027\u6682\u505c\u591a\u4efb\u52a1\u7248-844846efccbc16bc700e67e7a4f514ae.png"},15736:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u5185\u5b58\u4f2a\u5171\u4eab-68934e85c269c6b52f6b86f1a1db0268.png"},42624:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u751f\u4ea7\u8005\u6d88\u8d39\u8005\u6a21\u5f0f-dff44d57007dd69bc143adaf5ddaa0af.png"},5649:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u7ebf\u7a0b6\u79cd\u72b6\u6001-cbb75f9b6d3075812e6a19e0dd8e146f.png"},62889:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u7ebf\u7a0b\u6c60\u5de5\u4f5c\u539f\u7406-6b579a3fa7febfb27385e99eb0cf05b7.png"},12180:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u7ebf\u7a0b\u6c60\u72b6\u6001\u8f6c\u6362\u56fe-04abefee0d0f1f6678f310718c0e7e19.png"},77183:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u7f13\u5b58\u4e00\u81f4\u6027-a1caebec1a2ca0dc18cac9235ce7acaa.png"},7912:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u81ea\u65cb\u5931\u8d25-1f3f74029d911047563c6c4af04bb3f4.png"},32973:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u81ea\u65cb\u6210\u529f-6e35cd75db2746be66617a2610f4a2f0.png"},21309:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u8f7b\u91cf\u7ea7\u9501\u539f\u74061-765001b637c1c2ddad259870698c4f71.png"},40102:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u8f7b\u91cf\u7ea7\u9501\u539f\u74062-851f33f86138d0e79ce15ca9b8052027.png"},5295:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u8f7b\u91cf\u7ea7\u9501\u539f\u74063-a94f7c4c61eb4257c0074aa39586ef68.png"},15115:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u91cd\u91cf\u7ea7\u9501\u539f\u74061-84e4aea4182d3ddffa53933abe9cced2.png"},27472:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u91cd\u91cf\u7ea7\u9501\u539f\u74062-625a1f72f90be75b1d970ae015d59aa9.png"},11326:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JUC-\u9501\u5347\u7ea7\u8fc7\u7a0b-acf53e78143814978ec7c69fe97c6154.png"},16042:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JVM-\u76f4\u63a5\u5185\u5b58\u76f4\u63a5\u7f13\u51b2\u533a-ca8160016d9952ab14697d65dd78f435.png"},92462:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/JVM-\u76f4\u63a5\u5185\u5b58\u975e\u76f4\u63a5\u7f13\u51b2\u533a-b0446a802cf02a24306c22db6f6eea44.png"},77869:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/NIO-Buffer-4f36b3dedb015749f88b01777ca8805d.png"},12986:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/NIO-Buffer\u64cd\u4f5c-f7834835f6c0433157c3f269a873021f.png"},14612:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/NIO-Selector-1a2da8357d18b5aed4c7a25a55c5f0a1.png"},79937:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/NIO-\u590d\u5236\u6587\u4ef6-ca88c043d65f92d254304f420d77c519.png"},47468:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/NIO\u6846\u67b6-3343f22284712ca5c1942b19fdf4b21d.png"},47418:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/Netty-TCP\u4e09\u6b21\u63e1\u624b-9d0e284225e9ea947b65598f4de86714.png"},24293:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/TCP-\u5de5\u4f5c\u6a21\u578b-9e748e2e1d7d55b319d9b68564662ee7.png"},75122:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/\u4e09\u6b21\u63e1\u624b-c8e03dd69de4b848d2a47734c0f91b22.png"},26596:(n,e,l)=>{l.d(e,{A:()=>i});const i=l.p+"assets/images/\u56db\u6b21\u6325\u624b-46472cb64a8690bb2de8b1df9d327416.png"},28453:(n,e,l)=>{l.d(e,{R:()=>t,x:()=>a});var i=l(96540);const r={},s=i.createContext(r);function t(n){const e=i.useContext(s);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:t(n.components),i.createElement(s.Provider,{value:e},n.children)}}}]);